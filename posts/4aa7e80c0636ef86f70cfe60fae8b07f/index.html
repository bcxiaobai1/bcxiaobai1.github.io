<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>深入解析Android SharedPreferences源码 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深入解析Android SharedPreferences源码</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <h1>
<a id="_0"></a>概述</h1> 
<p>SharedPreferences(简称SP)是Android中常用的数据存储方式，SP采用key-value(键值对)形式，主要用于轻量级的数据存储，尤其适合保存应用的配置参数，但不建议使用SP来存储大规模的数据，可能会降低性能。</p> 
<p>SP采用XML文件格式来保存数据，该文件位于 <code>/data/data/&lt;packageName&gt;/shared_prefs/</code>。</p> 
<h1>
<a id="_6"></a>使用示例</h1> 
<pre><code class="prism language-java"><span class="token comment">// 加载SP文件数据,“my_prefs”为文件名</span>
<span class="token class-name">SharedPreferences</span> sp <span class="token operator">=</span> <span class="token function">getSharedPreferences</span><span class="token punctuation">(</span><span class="token string">"my_prefs"</span><span class="token punctuation">,</span> <span class="token class-name">Context</span><span class="token punctuation">.</span>MODE_PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 保存数据</span>
<span class="token class-name">Editor</span> editor <span class="token operator">=</span> sp<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
editor<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string">"blog"</span><span class="token punctuation">,</span> <span class="token string">"www.xiaox.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 提交数据：同步方式，有返回值表示数据保存是否成功</span>
<span class="token keyword">boolean</span> result <span class="token operator">=</span> editor<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 提交数据：异步方式，没有返回值// </span>
editor<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 读取数据</span>
<span class="token class-name">String</span> blog <span class="token operator">=</span> sp<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"blog"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>my_prefs.xml文件内容：</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">'1.0'</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span> standalone<span class="token operator">=</span><span class="token string">'yes'</span> <span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>map<span class="token punctuation">&gt;</span></span>    
    <span class="token operator">&lt;</span>string name<span class="token operator">=</span><span class="token string">"blog"</span><span class="token operator">&gt;</span>www<span class="token punctuation">.</span>xiaox<span class="token punctuation">.</span>com<span class="token operator">&lt;</span><span class="token operator">/</span>string<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>map<span class="token operator">&gt;</span>
</code></pre> 
<h1>
<a id="_31"></a>架构</h1> 
<h2>
<a id="_33"></a>类图</h2> 
<p><img src="https://images2.imgbox.com/cc/aa/45FUfy5h_o.png" alt="img"></p> 
<p><strong>说明</strong>：SharedPreferences与Editor只是两个接口，SharedPreferencesImpl和EditorImp分别实现了对应的接口。另外，ContextImpl记录着SharedPreferences的重要数据，如下：</p> 
<ul>
<li>sSharedPrefsCache：以包名为key，二级key是SP文件，以SharedPreferencesImp为value的嵌套map结构，sSharedPrefsCache是静态成员变量，每个进程只有唯一的一份，且由ContextImpl.class锁保护。</li>
<li>mSharedPrefsPaths：记录所有的SP文件，以文件名为key，具体文件为value的map结构。</li>
<li>mPreferencesDir：是值SP所在目录，即 <code>/data/data/&lt;packageName&gt;/shared_prefs/</code>
</li>
</ul> 
<h2>
<a id="_43"></a>工作流程</h2> 
<p><img src="https://images2.imgbox.com/f3/5e/hDueO0x9_o.png" alt="img"></p> 
<p><strong>说明</strong>：</p> 
<ol>
<li>putXxx()操作：把数据写入到EditorImpl.mModified；</li>
<li>apply()或者commit()操作： a. 先调用 <code>commitToMemory()</code>，将数据同步到SharedPreferencesImpl的mMap，并保存到MemoryCommitResult的 <code>mapToWriteToDisk</code>； b. 再调用 <code>enqueueDiskWrite()</code>，写入到磁盘文件；在这之前把原有数据保存到 <code>.bak</code>后缀的文件，用于在写磁盘的过程出现任何异常可恢复数据。</li>
<li>getXxx()操作：从SharedPreferencesImpl.mMap读取数据。</li>
</ol> 
<h1>
<a id="API_28_53"></a>源码分析(API 28)</h1> 
<h2>
<a id="SharedPreferences_55"></a>获取SharedPreferences</h2> 
<p>可以通过 <code>Activity.getPreferences(mode)</code>、 <code>PreferenceManager.getDefaultSharedPreferences(context)</code>或者 <code>Context.getSharedPreferences(name,mode)</code>来获取SharedPreferences实例， 最终调用的是ContextImpl的getSharedPreferences(name, mode)。</p> 
<p><strong>ContextImpl#getSharedPreferences(name, mode)</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ContextImpl</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"ContextImpl.class"</span><span class="token punctuation">)</span>    
		     <span class="token keyword">private</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> mSharedPrefsPaths<span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
	<span class="token annotation punctuation">@Override</span>    
		    <span class="token keyword">public</span> <span class="token class-name">SharedPreferences</span> <span class="token function">getSharedPreferences</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// ...</span>
		<span class="token class-name">File</span> file<span class="token punctuation">;</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mSharedPrefsPaths <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mSharedPrefsPaths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 先从mSharedPrefsPaths查询是否存在相应文件            </span>
			file <span class="token operator">=</span> mSharedPrefsPaths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 如果文件不存在，则创建新的文件                </span>
				file <span class="token operator">=</span> <span class="token function">getSharedPreferencesPath</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 将新创建的文件保存到mSharedPrefsPaths，以文件名为key                </span>
				mSharedPrefsPaths<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">getSharedPreferences</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token annotation punctuation">@Override</span>    
	    <span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">getSharedPreferencesPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">makeFilename</span><span class="token punctuation">(</span><span class="token function">getPreferencesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">+</span> <span class="token string">".xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">private</span> <span class="token class-name">File</span> <span class="token function">getPreferencesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSync<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mPreferencesDir <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 创建目录/data/data/&lt;packageName&gt;/shared_prefs/                </span>
				mPreferencesDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token function">getDataDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"shared_prefs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token function">ensurePrivateDirExists</span><span class="token punctuation">(</span>mPreferencesDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>ContextImpl#getSharedPreferences(file, mode)</strong>：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SharedPreferences</span> <span class="token function">getSharedPreferences</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">SharedPreferencesImpl</span> sp<span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">final</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">,</span> <span class="token class-name">SharedPreferencesImpl</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token function">getSharedPreferencesCacheLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sp <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">checkMode</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&gt;=</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>O</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCredentialProtectedStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    
				                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">UserManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                    
				                    <span class="token punctuation">.</span><span class="token function">isUserUnlockingOrUnlocked</span><span class="token punctuation">(</span><span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"SharedPreferences in credential encrypted "</span>                                                    <span class="token operator">+</span> <span class="token string">"storage are not available until after user is unlocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 创建SharedPreferencesImpl            </span>
			sp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedPreferencesImpl</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
			cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> sp<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> sp<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 指定多进程模式，则当文件被其他进程改变是，则会重新加载    </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token class-name">Context</span><span class="token punctuation">.</span>MODE_MULTI_PROCESS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span>        
		      <span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&lt;</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Build</span><span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>HONEYCOMB<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// If somebody else (some other process) changed the prefs        </span>
		<span class="token comment">// file behind our back, we reload it.  This has been the        </span>
		<span class="token comment">// historical (if undocumented) behavior.        </span>
		sp<span class="token punctuation">.</span><span class="token function">startReloadIfChangedUnexpectedly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> sp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"ContextImpl.class"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">,</span> <span class="token class-name">SharedPreferencesImpl</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSharedPreferencesCacheLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sSharedPrefsCache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		sSharedPrefsCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">final</span> <span class="token class-name">String</span> packageName <span class="token operator">=</span> <span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">,</span> <span class="token class-name">SharedPreferencesImpl</span><span class="token punctuation">&gt;</span></span> packagePrefs <span class="token operator">=</span> sSharedPrefsCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>packagePrefs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		packagePrefs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sSharedPrefsCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> packagePrefs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> packagePrefs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>SharedPreferencesImpl初始化</strong>：</p> 
<p><strong>SharedPreferencesImpl.java</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">SharedPreferencesImpl</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	mFile <span class="token operator">=</span> file<span class="token punctuation">;</span>
	<span class="token comment">// 创建.bak后缀的备份文件，用于在发生异常时，可以通过备份文件来恢复数据    </span>
	mBackupFile <span class="token operator">=</span> <span class="token function">makeBackupFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mMode <span class="token operator">=</span> mode<span class="token punctuation">;</span>
	mLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	mMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	mThrowable <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token function">startLoadFromDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>SharedPreferencesImpl#startLoadFromDisk()</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startLoadFromDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		mLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 通过工作线程读取文件数据到mMap    </span>
	<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">"SharedPreferencesImpl-load"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">loadFromDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadFromDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mLoaded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBackupFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			mBackupFile<span class="token punctuation">.</span><span class="token function">renameTo</span><span class="token punctuation">(</span>mFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Debugging    </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mFile<span class="token punctuation">.</span><span class="token function">canRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Attempt to read preferences file "</span> <span class="token operator">+</span> mFile <span class="token operator">+</span> <span class="token string">" without permission"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token class-name">StructStat</span> stat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token class-name">Throwable</span> thrown <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		stat <span class="token operator">=</span> <span class="token class-name">Os</span><span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>mFile<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mFile<span class="token punctuation">.</span><span class="token function">canRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">BufferedInputStream</span> str <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>                    
				                  <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>mFile<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				map <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">XmlUtils</span><span class="token punctuation">.</span><span class="token function">readMapXml</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Cannot read "</span> <span class="token operator">+</span> mFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">IoUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// An errno exception means the stat failed. Treat as empty/non-existing by        </span>
		<span class="token comment">// ignoring.</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		thrown <span class="token operator">=</span> t<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		mLoaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		mThrowable <span class="token operator">=</span> thrown<span class="token punctuation">;</span>
		<span class="token comment">// It's important that we always signal waiters, even if we'll make        </span>
		<span class="token comment">// them fail with an exception. The try-finally is pretty wide, but        </span>
		<span class="token comment">// better safe than sorry.        </span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>thrown <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					mMap <span class="token operator">=</span> map<span class="token punctuation">;</span>
					mStatTimestamp <span class="token operator">=</span> stat<span class="token punctuation">.</span>st_mtim<span class="token punctuation">;</span>
					mStatSize <span class="token operator">=</span> stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					mMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// In case of a thrown exception, we retain the old map. That allows            </span>
			<span class="token comment">// any open editors to commit and store updates.</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mThrowable <span class="token operator">=</span> t<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
			mLock<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><strong>获取SharedPreferences总结</strong>：</p> 
</blockquote> 
<ol>
<li>首次使用则创建相应xml文件；</li>
<li>异步加载文件内容到内存，此时执行getXxx()和edit()方法都是阻塞等待的，直到文件数据全部加载到内存；</li>
<li>一旦数据完全加载到内存，后续的getXxx()则是直接访问内存。</li>
</ol> 
<h2>
<a id="_258"></a>获取数据</h2> 
<p><strong>SharedPreferencesImpl#getString(key, defValue)</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> defValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 检查数据是否加载完成        </span>
		<span class="token function">awaitLoadedLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>mMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> v <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> v <span class="token operator">:</span> defValue<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">awaitLoadedLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mLoaded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">BlockGuard</span><span class="token punctuation">.</span><span class="token function">getThreadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onReadFromDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>mLoaded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 当没有加载完成，则进入等待状态            </span>
			mLock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mThrowable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>mThrowable<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="_289"></a>编辑数据</h2> 
<p>获取Editor编辑器实例：<code>SharedPreferencesImpl#edit()</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Editor</span> <span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 等待数据加载完成        </span>
		<span class="token function">awaitLoadedLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 创建EditorImpl实例    </span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EditorImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>EditorImpl#putString(key, value)</strong>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">EditorImpl</span> <span class="token keyword">implements</span> <span class="token class-name">Editor</span> <span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"mEditorLock"</span><span class="token punctuation">)</span>    
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> mModified <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"mEditorLock"</span><span class="token punctuation">)</span>    
	<span class="token keyword">private</span> <span class="token class-name">Boolean</span> mClear <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
	<span class="token comment">// 插入数据    </span>
	<span class="token keyword">public</span> <span class="token class-name">Editor</span> <span class="token function">putString</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mEditorLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 插入数据，暂存到mModified            </span>
			mModified<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 移除数据    </span>
	<span class="token keyword">public</span> <span class="token class-name">Editor</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mEditorLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mModified<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 清空全部数据    </span>
	<span class="token keyword">public</span> <span class="token class-name">Editor</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mEditorLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mClear <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="_338"></a>保存数据</h2> 
<blockquote> 
 <p>保存数据，主要是调用 <code>commit()</code>和 <code>apply()</code>方法来完成的。</p> 
</blockquote> 
<p><strong>EditorImpl#commit()</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
	<span class="token comment">// 将数据更新到内存    </span>
	<span class="token class-name">MemoryCommitResult</span> mcr <span class="token operator">=</span> <span class="token function">commitToMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 将内存数据同步到文件    </span>
	<span class="token class-name">SharedPreferencesImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">enqueueDiskWrite</span><span class="token punctuation">(</span>        
      mcr<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* sync write on this thread okay */</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 进入等待状态，直到写入文件的操作完成        </span>
		mcr<span class="token punctuation">.</span>writtenToDiskLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 通知监听器，并在主线程回调onSharedPreferenceChanged()方法    </span>
	<span class="token function">notifyListeners</span><span class="token punctuation">(</span>mcr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 返回文件操作的结果    </span>
	<span class="token keyword">return</span> mcr<span class="token punctuation">.</span>writeToDiskResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>EditorImpl#commitToMemory()</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">MemoryCommitResult</span> <span class="token function">commitToMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">long</span> memoryStateGeneration<span class="token punctuation">;</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keysModified <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OnSharedPreferenceChangeListener</span><span class="token punctuation">&gt;</span></span> listeners <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> mapToWriteToDisk<span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">SharedPreferencesImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mDiskWritesInFlight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>mMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mapToWriteToDisk <span class="token operator">=</span> mMap<span class="token punctuation">;</span>
		mDiskWritesInFlight<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token class-name">Boolean</span> hasListeners <span class="token operator">=</span> mListeners<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>hasListeners<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			keysModified <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OnSharedPreferenceChangeListener</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>mListeners<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mEditorLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Boolean</span> changesMade <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token comment">// 当mClear为true，则直接清空mMap            </span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mClear<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mapToWriteToDisk<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					changesMade <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
					mapToWriteToDisk<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				mClear <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">:</span> mModified<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">String</span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">Object</span> v <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// this是一个特殊值，当v为空，相当于remove该条数据                </span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token keyword">this</span> <span class="token operator">||</span> v <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mapToWriteToDisk<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">continue</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					mapToWriteToDisk<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>mapToWriteToDisk<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token class-name">Object</span> existingValue <span class="token operator">=</span> mapToWriteToDisk<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>existingValue <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> existingValue<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							<span class="token keyword">continue</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					mapToWriteToDisk<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 表示数据有改变                </span>
				changesMade <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>hasListeners<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					keysModified<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 清空mModified的数据            </span>
			mModified<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>changesMade<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mCurrentMemoryStateGeneration<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			memoryStateGeneration <span class="token operator">=</span> mCurrentMemoryStateGeneration<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MemoryCommitResult</span><span class="token punctuation">(</span>memoryStateGeneration<span class="token punctuation">,</span> keysModified<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span>                                  
	                                  mapToWriteToDisk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>EditorImpl#enqueueDiskWrite()</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">enqueueDiskWrite</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MemoryCommitResult</span> mcr<span class="token punctuation">,</span>                              
                              <span class="token keyword">final</span> <span class="token class-name">Runnable</span> postWriteRunnable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">final</span> <span class="token class-name">Boolean</span> isFromSyncCommit <span class="token operator">=</span> <span class="token punctuation">(</span>postWriteRunnable <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Runnable</span> writeToDiskRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token annotation punctuation">@Override</span>        
		        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mWritingToDiskLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 执行文件写入操作                </span>
				<span class="token function">writeToFile</span><span class="token punctuation">(</span>mcr<span class="token punctuation">,</span> isFromSyncCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mDiskWritesInFlight<span class="token operator">--</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>postWriteRunnable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				postWriteRunnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">// 使用commit方法，会进入这个分支，在当前线程执行    </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>isFromSyncCommit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Boolean</span> wasEmpty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			wasEmpty <span class="token operator">=</span> mDiskWritesInFlight <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>wasEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			writeToDiskRunnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 使用apply方法，会执行该句，将任务放入单线程的线程池中执行    </span>
	<span class="token class-name">QueuedWork</span><span class="token punctuation">.</span><span class="token function">queue</span><span class="token punctuation">(</span>writeToDiskRunnable<span class="token punctuation">,</span> <span class="token operator">!</span>isFromSyncCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>EditorImpl#writeToFile()</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeToFile</span><span class="token punctuation">(</span><span class="token class-name">MemoryCommitResult</span> mcr<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isFromSyncCommit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
	<span class="token class-name">Boolean</span> fileExists <span class="token operator">=</span> mFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fileExists<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Boolean</span> needsWrite <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">// Only need to write if the disk state is older than this commit        </span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mDiskStateGeneration <span class="token operator">&lt;</span> mcr<span class="token punctuation">.</span>memoryStateGeneration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>isFromSyncCommit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				needsWrite <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// No need to persist intermediate states. Just wait for the latest state to                    </span>
					<span class="token comment">// be persisted.                    </span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentMemoryStateGeneration <span class="token operator">==</span> mcr<span class="token punctuation">.</span>memoryStateGeneration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						needsWrite <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 没有改变，直接返回        </span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needsWrite<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mcr<span class="token punctuation">.</span><span class="token function">setDiskWriteResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">Boolean</span> backupFileExists <span class="token operator">=</span> mBackupFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>backupFileExists<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 当备份文件不存在，则把mFile重命名为备份文件            </span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mFile<span class="token punctuation">.</span><span class="token function">renameTo</span><span class="token punctuation">(</span>mBackupFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Couldn't rename file "</span> <span class="token operator">+</span> mFile                      
                      <span class="token operator">+</span> <span class="token string">" to backup file "</span> <span class="token operator">+</span> mBackupFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
				mcr<span class="token punctuation">.</span><span class="token function">setDiskWriteResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 否则，直接删除mFile            </span>
			mFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">FileOutputStream</span> str <span class="token operator">=</span> <span class="token function">createFileOutputStream</span><span class="token punctuation">(</span>mFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			mcr<span class="token punctuation">.</span><span class="token function">setDiskWriteResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 将mMap全部信息写入文件        </span>
		<span class="token class-name">XmlUtils</span><span class="token punctuation">.</span><span class="token function">writeMapXml</span><span class="token punctuation">(</span>mcr<span class="token punctuation">.</span>mapToWriteToDisk<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
		writeTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
		fsyncTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		str<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">setFilePermissionsFromMode</span><span class="token punctuation">(</span>mFile<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mMode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">final</span> <span class="token class-name">StructStat</span> stat <span class="token operator">=</span> <span class="token class-name">Os</span><span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>mFile<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mStatTimestamp <span class="token operator">=</span> stat<span class="token punctuation">.</span>st_mtim<span class="token punctuation">;</span>
				mStatSize <span class="token operator">=</span> stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Do nothing</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			fstatTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 写入成功，删除备份文件        </span>
		mBackupFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mDiskStateGeneration <span class="token operator">=</span> mcr<span class="token punctuation">.</span>memoryStateGeneration<span class="token punctuation">;</span>
		<span class="token comment">// 返回写入成功，唤醒等待线程        </span>
		mcr<span class="token punctuation">.</span><span class="token function">setDiskWriteResult</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XmlPullParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"writeToFile: Got exception:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"writeToFile: Got exception:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 如果文件写入操作失败，则删除未成功写入的文件    </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Couldn't clean up partially-written file "</span> <span class="token operator">+</span> mFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 返回写入失败，唤醒等待线程    </span>
	mcr<span class="token punctuation">.</span><span class="token function">setDiskWriteResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>EditorImpl#apply()</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">final</span> <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 把数据更新到内存    </span>
	<span class="token keyword">final</span> <span class="token class-name">MemoryCommitResult</span> mcr <span class="token operator">=</span> <span class="token function">commitToMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Runnable</span> awaitCommit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token annotation punctuation">@Override</span>        
				<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 进入等待状态                </span>
				mcr<span class="token punctuation">.</span>writtenToDiskLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token class-name">QueuedWork</span><span class="token punctuation">.</span><span class="token function">addFinisher</span><span class="token punctuation">(</span>awaitCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Runnable</span> postWriteRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token annotation punctuation">@Override</span>        
		        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			awaitCommit<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">QueuedWork</span><span class="token punctuation">.</span><span class="token function">removeFinisher</span><span class="token punctuation">(</span>awaitCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">// 将数据以异步的方式写入文件    </span>
	<span class="token class-name">SharedPreferencesImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">enqueueDiskWrite</span><span class="token punctuation">(</span>mcr<span class="token punctuation">,</span> postWriteRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">notifyListeners</span><span class="token punctuation">(</span>mcr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h1>
<a id="_593"></a>性能优化</h1> 
<h2>
<a id="IO_595"></a>IO瓶颈</h2> 
<blockquote> 
 <p>IO瓶颈是造成SP性能差的最大原因，解决IO瓶颈，80%的性能问题就解决了。</p> 
</blockquote> 
<p>SP的IO瓶颈包括 <code>读取数据到内存</code>与 <code>数据写入磁盘</code>两部分。</p> 
<p><strong>1.读取数据到内存有两个场景会触发：</strong></p> 
<ul>
<li> <p>SP文件没有被加载到内存时，调用getSharedPreferences方法会初始化文件并读入内存。</p> </li>
<li> <p>版本低于Android-H或使用了MULTI_PROCESS标记时，每次调用getSharedPreference方法时都会读入。</p> </li>
</ul> 
<p><strong>优化</strong>：</p> 
<blockquote> 
 <p>我们可以优化的便是b了，每次加载数据到内存太过影响效率，但H以下版本已经很低了，基本可以忽略。 对于MULTI_PROCESS，可以采用ContentProvider等其他方式，效率更好，而且可避免SP数据丢失的情况。</p> 
</blockquote> 
<p><strong>2.数据写入到磁盘也有两个场景会触发：</strong></p> 
<ul>
<li> <p>Editor的commit方法，每次执行时同步写入磁盘。</p> </li>
<li> <p>Editor的apply方法，每次执行时在单线程池中写入磁盘，异步写入。</p> </li>
</ul> 
<p><strong>优化</strong>：</p> 
<blockquote> 
 <p>commit和apply的方法区别在于同步写入和异步写入，以及是否需要返回值。 在不需要返回值的情况下，使用apply方法可以极大的提高性能。 同时，多个写入操作可以合并为一个commit/apply，将多个写入操作合并后也能提高IO性能。</p> 
</blockquote> 
<h2>
<a id="_623"></a>锁性能差</h2> 
<ol>
<li> <p>SP的get操作，会锁定SharedPreferences对象，互斥其他操作。</p> </li>
<li> <p>SP的put操作，edit()及commitToMemory会锁定SharedPreferences对象，put操作会锁定Editor对象，写入磁盘更会锁定一个写入锁。</p> </li>
</ol> 
<p><strong>优化</strong>：</p> 
<blockquote> 
 <p>由于锁的缘故，SP操作并发时，耗时会增加。减少锁耗时，是一个优化点。 由于读写操作的锁均是SP实例对象的，将数据分拆到不同的sp文件中，便是减少锁耗时的直接方案。 降低单文件访问频率，多文件均摊访问，以减少锁耗时。</p> 
</blockquote> 
<h2>
<a id="_633"></a>优化总结</h2> 
<ul>
<li>强烈建议不要在sp里面存储特别大的key/value, 有助于减少卡顿/anr；</li>
<li>请不要高频地使用apply, 尽可能地批量提交;commit直接在主线程操作, 更要注意了；</li>
<li>不要使用MODEMULTIPROCESS；</li>
<li>高频写操作的key与高频读操作的key可以适当地拆分文件, 由于减少同步锁竞争；</li>
<li>不要一上来就执行getSharedPreferences().edit(), 应该分成两大步骤来做, 中间可以执行其他代码；</li>
<li>不要连续多次edit(), 应该获取一次获取edit(),然后多次执行putxxx(), 减少内存波动; 经常看到大家喜欢封装方法, 结果就导致这种情况的出现；</li>
<li>每次commit时会把全部的数据更新的文件, 所以整个文件是不应该过大的, 影响整体性能。</li>
</ul>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>