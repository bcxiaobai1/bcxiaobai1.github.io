<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>自制编程语言基于c语言实验记录之二：总结三四五六七章之编译类定义 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">自制编程语言基于c语言实验记录之二：总结三四五六七章之编译类定义</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <h1>
<a id="_0"></a>博客前言</h1> 
<p>由于本书第六七章是编译脚本语言sparrow生成指令、虚拟机运行指令的核心章节，需要连在一起理解，同时三四五章都是六七章的铺垫，所以专门写多篇博客来记录六七章。<br> 同时本书相比《操作系统真相还原》缺少具体例子很难梳理项目整体代码，因此博客主要记录方式是按具体编译sparrow代码的例子，以编译器执行顺序罗列出所有相关代码。</p> 
<p>本章博客主要解决sparrow的类的编译，以一个具体例子梳理编译类定义的相关全部代码，列举了编译类定义实例变量、静态变量、实例方法、静态方法、new（实例+静态方法）</p> 
<h1>
<a id="1sparrow_6"></a>1.sparrow语言的简单类</h1> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">{<!-- --></span> 
	var instantField 		<span class="token operator">//</span>实例变量
	static var staticField 	<span class="token operator">//</span>静态变量
	instantField<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>		<span class="token operator">//</span>实例方法
	static staticMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>	<span class="token operator">//</span>静态方法
	new<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>					<span class="token operator">//</span>构造方法
<span class="token punctuation">}</span>
</code></pre> 
<p>以上述简单类为例，一个类里面只会定义以上五种类型。</p> 
<h1>
<a id="2compileClassDefinitionCompileUnit_cu_18"></a>2.类定义：compileClassDefinition(CompileUnit* cu)</h1> 
<pre><code class="prism language-c"><span class="token comment">//编译类定义</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">compileClassDefinition</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   Variable classVar<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>scopeDepth <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//目前只支持在模块作用域定义类 </span>
      <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> 
	    <span class="token string">"class definition must be in the module scope!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   classVar<span class="token punctuation">.</span>scopeType <span class="token operator">=</span> VAR_SCOPE_MODULE<span class="token punctuation">;</span>
   <span class="token function">consumeCurToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_ID<span class="token punctuation">,</span> 
	 <span class="token string">"keyword class should follow by class name!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//读入类名</span>
   classVar<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token function">declareVariable</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> 
	 cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>preToken<span class="token punctuation">.</span>start<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>preToken<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//生成类名,用于创建类</span>
   ObjString<span class="token operator">*</span> className <span class="token operator">=</span> <span class="token function">newObjString</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span> 
	 cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>preToken<span class="token punctuation">.</span>start<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>preToken<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//生成加载类名的指令</span>
   <span class="token function">emitLoadConstant</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> <span class="token function">OBJ_TO_VALUE</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_LESS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//类继承</span>
      <span class="token function">expression</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> BP_CALL<span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">//把父类名加载到栈顶</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//默认加载object类为基类</span>
      <span class="token function">emitLoadModuleVar</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> <span class="token string">"object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span>

   <span class="token comment">//创建类需要知道域的个数,目前类未定义完,因此域的个数未知,</span>
   <span class="token comment">//因此先临时写为255,待类编译完成后再回填属性数</span>
   <span class="token keyword">int</span> fieldNumIndex <span class="token operator">=</span> <span class="token function">writeOpCodeByteOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_CREATE_CLASS<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
   <span class="token comment">//虚拟机执行完OPCODE_CREATE_CLASS后,栈顶留下了创建好的类,</span>
   <span class="token comment">//因此现在可以用该类为之前声明的类名className赋值</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>scopeDepth <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">emitStoreModuleVar</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> classVar<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   ClassBookKeep classBK<span class="token punctuation">;</span>
   classBK<span class="token punctuation">.</span>name <span class="token operator">=</span> className<span class="token punctuation">;</span>
   classBK<span class="token punctuation">.</span>inStatic <span class="token operator">=</span> false<span class="token punctuation">;</span>   <span class="token comment">//默认为false</span>
   <span class="token function">StringBufferInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>classBK<span class="token punctuation">.</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">IntBufferInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>classBK<span class="token punctuation">.</span>instantMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">IntBufferInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>classBK<span class="token punctuation">.</span>staticMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//此时cu是模块的编译单元,跟踪当前编译的类</span>
   cu<span class="token operator">-&gt;</span>enclosingClassBK <span class="token operator">=</span> <span class="token operator">&amp;</span>classBK<span class="token punctuation">;</span>
   
   <span class="token comment">//读入类名后的'{'</span>
   <span class="token function">consumeCurToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_LEFT_BRACE<span class="token punctuation">,</span> 
	 <span class="token string">"expect '{' after class name in the class declaration!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//进入类体</span>
   <span class="token function">enterScope</span><span class="token punctuation">(</span>cu<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//直到类定义结束'}'为止</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_RIGHT_BRACE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token function">compileClassBody</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> classVar<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PEEK_TOKEN</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_EOF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"expect '}' at the end of class declaration!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//上面临时写了255个字段,现在类编译完成,回填正确的字段数.</span>
   <span class="token comment">//classBK.fields的是由compileVarDefinition函数统计的</span>
   cu<span class="token operator">-&gt;</span>fn<span class="token operator">-&gt;</span>instrStream<span class="token punctuation">.</span>datas<span class="token punctuation">[</span>fieldNumIndex<span class="token punctuation">]</span> <span class="token operator">=</span> classBK<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>count<span class="token punctuation">;</span>

   <span class="token function">symbolTableClear</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span> <span class="token operator">&amp;</span>classBK<span class="token punctuation">.</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">IntBufferClear</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span> <span class="token operator">&amp;</span>classBK<span class="token punctuation">.</span>instantMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">IntBufferClear</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span> <span class="token operator">&amp;</span>classBK<span class="token punctuation">.</span>staticMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//enclosingClassBK用来表示是否在编译类,</span>
   <span class="token comment">//编译完类后要置空,编译下一个类时再重新赋值</span>
   cu<span class="token operator">-&gt;</span>enclosingClassBK <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

   <span class="token comment">//出作用域,丢弃相关局部变量</span>
   <span class="token function">leaveScope</span><span class="token punctuation">(</span>cu<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>本函数在词法分析器读到"class"后开始执行，主要可以总结以下几步：</p> 
<ol>
<li>读class后面的类名字符串后，调用declareVariable将类名声明为模块变量,即在ObjModule的objModule-&gt;moduleVarName存储名字，objModule-&gt;moduleVarValue存储值（目前存储的是NULL作为初始值），索引值存储到classVar.index。</li>
<li>调用emitLoadConstant存储类名于常量表cu-&gt;fn-&gt;constants，再生成加载类名指令于栈顶curThread-&gt;esp，若有父类再加载父类名于栈顶，无则加载object于栈顶</li>
<li>生成OPCODE_CREATE_CLASS指令创建类，于栈顶留下创建好的类</li>
<li>调用emitStoreModuleVar将栈顶的类加载回classVar.index指向的objModule-&gt;moduleVarValue中，也就是把刚刚创建好的类（类即是模块变量）覆盖了之前的NULL作为模块变量的值</li>
<li>while循环调用compileClassBody编译类的大括号里面的代码，生成对应的指令。</li>
</ol> 
<h2>
<a id="21_declareVariableCompileUnit_cu_const_char_name_uint32_t_length_104"></a>2.1 declareVariable(CompileUnit* cu, const char* name, uint32_t length)</h2> 
<h3>
<a id="211_defineModuleVar_105"></a>2.1.1 defineModuleVar</h3> 
<pre><code class="prism language-c"><span class="token comment">//在模块objModule中定义名为name,值为value的模块变量</span>
<span class="token keyword">int</span> <span class="token function">defineModuleVar</span><span class="token punctuation">(</span>VM<span class="token operator">*</span> vm<span class="token punctuation">,</span> ObjModule<span class="token operator">*</span> objModule<span class="token punctuation">,</span>
      <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length<span class="token punctuation">,</span> Value value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> MAX_ID_LEN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//也许name指向的变量名并不以''结束,将其从源码串中拷贝出来</span>
      <span class="token keyword">char</span> id<span class="token punctuation">[</span>MAX_ID_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token char">''</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//本函数可能是在编译源码文件之前调用的,</span>
      <span class="token comment">//那时还没有创建parser, 因此报错要分情况:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token operator">-&gt;</span>curParser <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//编译源码文件</span>
	 <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>vm<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> 
	       <span class="token string">"length of identifier "%s" should be no more than %d"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> MAX_ID_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">// 编译源码前调用,比如加载核心模块时会调用本函数</span>
	 <span class="token function">MEM_ERROR</span><span class="token punctuation">(</span><span class="token string">"length of identifier "%s" should be no more than %d"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> MAX_ID_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//从模块变量名中查找变量,若不存在就添加</span>
   <span class="token keyword">int</span> symbolIndex <span class="token operator">=</span> <span class="token function">getIndexFromSymbolTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>objModule<span class="token operator">-&gt;</span>moduleVarName<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>symbolIndex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
      <span class="token comment">//添加变量名</span>
      symbolIndex <span class="token operator">=</span> <span class="token function">addSymbol</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token operator">&amp;</span>objModule<span class="token operator">-&gt;</span>moduleVarName<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//添加变量值</span>
      <span class="token function">ValueBufferAdd</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token operator">&amp;</span>objModule<span class="token operator">-&gt;</span>moduleVarValue<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">VALUE_IS_NUM</span><span class="token punctuation">(</span>objModule<span class="token operator">-&gt;</span>moduleVarValue<span class="token punctuation">.</span>datas<span class="token punctuation">[</span>symbolIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//若遇到之前预先声明的模块变量的定义,在此为其赋予正确的值</span>
      objModule<span class="token operator">-&gt;</span>moduleVarValue<span class="token punctuation">.</span>datas<span class="token punctuation">[</span>symbolIndex<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span> 

   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      symbolIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//已定义则返回-1,用于判断重定义</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> symbolIndex<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>模块变量包括类名，定义模块变量，即ObjModule的objModule-&gt;moduleVarName存储名字，objModule-&gt;moduleVarValue存储值</p> 
<h3>
<a id="212_declareLocalVardeclareVariable_145"></a>2.1.2 declareLocalVar、declareVariable</h3> 
<pre><code class="prism language-c"><span class="token comment">//添加局部变量到cu</span>
<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> <span class="token function">addLocalVar</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   LocalVar<span class="token operator">*</span> var <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span>cu<span class="token operator">-&gt;</span>localVarNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   var<span class="token operator">-&gt;</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
   var<span class="token operator">-&gt;</span>length <span class="token operator">=</span> length<span class="token punctuation">;</span>
   var<span class="token operator">-&gt;</span>scopeDepth <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>scopeDepth<span class="token punctuation">;</span>
   var<span class="token operator">-&gt;</span>isUpvalue <span class="token operator">=</span> false<span class="token punctuation">;</span>
   <span class="token keyword">return</span> cu<span class="token operator">-&gt;</span>localVarNum<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//声明局部变量</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">declareLocalVar</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>localVarNum <span class="token operator">&gt;=</span> MAX_LOCAL_VAR_NUM<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"the max length of local variable of one scope is %d"</span><span class="token punctuation">,</span> MAX_LOCAL_VAR_NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token punctuation">}</span>

   <span class="token comment">//判断当前作用域中该变量是否已存在</span>
   <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>cu<span class="token operator">-&gt;</span>localVarNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      LocalVar<span class="token operator">*</span> var <span class="token operator">=</span> <span class="token operator">&amp;</span>cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//只在当前作用域中查找同名变量,</span>
      <span class="token comment">//如果到了父作用域就退出,减少没必要的遍历</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>var<span class="token operator">-&gt;</span>scopeDepth <span class="token operator">&lt;</span> cu<span class="token operator">-&gt;</span>scopeDepth<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 	<span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>var<span class="token operator">-&gt;</span>length <span class="token operator">==</span> length <span class="token operator">&amp;&amp;</span> <span class="token function">memcmp</span><span class="token punctuation">(</span>var<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		 <span class="token keyword">char</span> id<span class="token punctuation">[</span>MAX_ID_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token char">''</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		 <span class="token function">memcpy</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"identifier "%s" redefinition!"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      idx<span class="token operator">--</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//检查过后声明该局部变量</span>
   <span class="token keyword">return</span> <span class="token function">addLocalVar</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//根据作用域声明变量</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">declareVariable</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">//若当前是模块作用域就声明为模块变量</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>scopeDepth <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">defineModuleVar</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span>
	    cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curModule<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token function">VT_TO_VALUE</span><span class="token punctuation">(</span>VT_NULL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//重复定义则报错</span>
		 <span class="token keyword">char</span> id<span class="token punctuation">[</span>MAX_ID_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token char">''</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		 <span class="token function">memcpy</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"identifier "%s" redefinition!"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> index<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//否则是局部作用域,声明局部变量</span>
   <span class="token keyword">return</span> <span class="token function">declareLocalVar</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>声明局部变量即把局部变量存储在<br> CompileUnit cu的cu-&gt;localVars[MAX_LOCAL_VAR_NUM]中<br> cu-&gt;localVarNum为最后一个已声明局部变量</p> 
<h2>
<a id="22_emitLoadConstant_206"></a>2.2 emitLoadConstant</h2> 
<pre><code class="prism language-c"><span class="token comment">//添加常量并返回其索引</span>
<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> <span class="token function">addConstant</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> Value constant<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token function">ValueBufferAdd</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cu<span class="token operator">-&gt;</span>fn<span class="token operator">-&gt;</span>constants<span class="token punctuation">,</span> constant<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> cu<span class="token operator">-&gt;</span>fn<span class="token operator">-&gt;</span>constants<span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//生成加载常量的指令</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">emitLoadConstant</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> Value value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">addConstant</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">writeOpCodeShortOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_LOAD_CONSTANT<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PUSH</span><span class="token expression"><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token operator">*</span>curThread<span class="token operator">-&gt;</span>esp<span class="token operator">++</span> <span class="token operator">=</span> value<span class="token punctuation">)</span>   </span><span class="token comment">//压栈</span></span>
<span class="token comment">//读取指令流中的2字节</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">READ_SHORT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ip <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ip<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> ip<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token function">CASE</span><span class="token punctuation">(</span>LOAD_CONSTANT<span class="token punctuation">)</span><span class="token operator">:</span>
	 <span class="token comment">//指令流: 2字节的常量索引</span>
 	<span class="token comment">//加载常量就是把常量表中的数据入栈</span>
	 <span class="token function">PUSH</span><span class="token punctuation">(</span>fn<span class="token operator">-&gt;</span>constants<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token function">READ_SHORT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>cu-&gt;fn-&gt;constants中添加Value类型常量，OPCODE_LOAD_CONSTANT用于将cu-&gt;fn-&gt;constants中的该变量加载到curThread-&gt;esp</p> 
<h2>
<a id="23_emitLoadModuleVar_233"></a>2.3 emitLoadModuleVar</h2> 
<pre><code class="prism language-c"><span class="token comment">//生成加载类的指令</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">emitLoadModuleVar</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">getIndexFromSymbolTable</span><span class="token punctuation">(</span>
	 <span class="token operator">&amp;</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curModule<span class="token operator">-&gt;</span>moduleVarName<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">ASSERT</span><span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"symbol should have been defined"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">writeOpCodeShortOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_LOAD_MODULE_VAR<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">CASE</span><span class="token punctuation">(</span>LOAD_MODULE_VAR<span class="token punctuation">)</span><span class="token operator">:</span>
	 <span class="token comment">//指令流: 2字节的模块变量索引</span>
	 <span class="token function">PUSH</span><span class="token punctuation">(</span>fn<span class="token operator">-&gt;</span>module<span class="token operator">-&gt;</span>moduleVarValue<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token function">READ_SHORT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2>
<a id="24_CREATE_CLASS_248"></a>2.4 CREATE_CLASS</h2> 
<pre><code class="prism language-c">
  <span class="token function">CASE</span><span class="token punctuation">(</span>CREATE_CLASS<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token comment">//指令流: 1字节的field数量</span>
	 <span class="token comment">//栈顶: 基类  次栈顶: 子类名</span>

	 <span class="token class-name">uint32_t</span> fieldNum <span class="token operator">=</span> <span class="token function">READ_BYTE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 Value superClass <span class="token operator">=</span> curThread<span class="token operator">-&gt;</span>esp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//基类名</span>
	 Value className <span class="token operator">=</span> curThread<span class="token operator">-&gt;</span>esp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//子类名</span>

	 <span class="token comment">//回收基类所占的栈空间,</span>
	 <span class="token comment">//次栈顶的空间暂时保留,创建的类会直接用该空间.</span>
	 <span class="token function">DROP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token comment">//校验基类合法性,若不合法则停止运行</span>
	 <span class="token function">validateSuperClass</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> className<span class="token punctuation">,</span> fieldNum<span class="token punctuation">,</span> superClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 Class<span class="token operator">*</span> class <span class="token operator">=</span> <span class="token function">newClass</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token function">VALUE_TO_OBJSTR</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">,</span>
	       fieldNum<span class="token punctuation">,</span> <span class="token function">VALUE_TO_CLASS</span><span class="token punctuation">(</span>superClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token comment">//类存储于栈底</span>
	 stackStart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">OBJ_TO_VALUE</span><span class="token punctuation">(</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>栈顶是基类（父类）名，次栈顶是子类名。<br> 将newclass出的类转化成Value后存储于运行时栈栈底stackStart[0]</p> 
<h2>
<a id="25_emitStoreModuleVar_277"></a>2.5 emitStoreModuleVar</h2> 
<pre><code class="prism language-c"><span class="token comment">//生成存储模块变量的指令</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">emitStoreModuleVar</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">//把栈顶数据存储到moduleVarValue[index]</span>
   <span class="token function">writeOpCodeShortOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_STORE_MODULE_VAR<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">writeOpCode</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_POP<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//弹出栈顶数据</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PEEK</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>curThread<span class="token operator">-&gt;</span>esp <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">// 获得栈顶的数据</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">POP</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">--</span>curThread<span class="token operator">-&gt;</span>esp<span class="token punctuation">)</span><span class="token punctuation">)</span>  </span><span class="token comment">//出栈</span></span>
<span class="token function">CASE</span><span class="token punctuation">(</span>STORE_MODULE_VAR<span class="token punctuation">)</span><span class="token operator">:</span>
	 <span class="token comment">//栈顶: 模块变量值</span>
	 fn<span class="token operator">-&gt;</span>module<span class="token operator">-&gt;</span>moduleVarValue<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token function">READ_SHORT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">PEEK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>CREATE_CLASS将创建的类存储于运行时栈栈底stackStart[0]，也就是curThread-&gt;esp - 1即栈顶，<br> 栈顶的值即新创建的类存储到fn-&gt;module-&gt;moduleVarValue.datas[index]中，再弹出无用的栈顶数据</p> 
<h2>
<a id="26_compileClassBody_296"></a>2.6 compileClassBody</h2> 
<pre><code class="prism language-c"><span class="token comment">//编译类体</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">compileClassBody</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> Variable classVar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_STATIC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_VAR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//处理静态域 "static var id"</span>
	 <span class="token function">compileVarDefinition</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//处理静态方法,"static methodName"</span>
	 <span class="token function">compileMethod</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> classVar<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_VAR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//实例域</span>
      <span class="token function">compileVarDefinition</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//类的方法</span>
      <span class="token function">compileMethod</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> classVar<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>类中编译语句一共四种，实例变量、静态变量，实例方法、静态方法。<br> new这样的构造方法既属于实例方法又属于静态方法。<br> 词法分析器读到new的时候，由于未读到static，所以走的是实例方法，但是后面方法签名函数idMethodSignature会检测到new这个字符串，所以生成的sign的type为构造函数以此区分。</p> 
<h2>
<a id="27_compileVarDefinitionCompileUnit_cu_bool_isStatic_318"></a>2.7 compileVarDefinition(CompileUnit* cu, bool isStatic)</h2> 
<pre><code class="prism language-c"><span class="token comment">//编译变量定义</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">compileVarDefinition</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> bool isStatic<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token function">consumeCurToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_ID<span class="token punctuation">,</span> <span class="token string">"missing variable name!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   Token name <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>preToken<span class="token punctuation">;</span>
   <span class="token comment">//只支持定义单个变量</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curToken<span class="token punctuation">.</span>type <span class="token operator">==</span> TOKEN_COMMA<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"'var' only support declaring a variable."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//一 先判断是否是类中的域定义   确保cu是模块cu</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>enclosingUnit <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> cu<span class="token operator">-&gt;</span>enclosingClassBK <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isStatic<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//静态域</span>
		 <span class="token keyword">char</span><span class="token operator">*</span> staticFieldId <span class="token operator">=</span> <span class="token function">ALLOCATE_ARRAY</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">,</span> MAX_ID_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token function">memset</span><span class="token punctuation">(</span>staticFieldId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAX_ID_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token class-name">uint32_t</span> staticFieldIdLen<span class="token punctuation">;</span>
		 <span class="token keyword">char</span><span class="token operator">*</span> clsName <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>enclosingClassBK<span class="token operator">-&gt;</span>name<span class="token operator">-&gt;</span>value<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
		 <span class="token class-name">uint32_t</span> clsLen <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>enclosingClassBK<span class="token operator">-&gt;</span>name<span class="token operator">-&gt;</span>value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
	
		 <span class="token comment">//用前缀"'Cls '+类名+变量名"做为静态域在模块编译单元中的局部变量</span>
		 <span class="token function">memmove</span><span class="token punctuation">(</span>staticFieldId<span class="token punctuation">,</span> <span class="token string">"Cls"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token function">memmove</span><span class="token punctuation">(</span>staticFieldId <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> clsName<span class="token punctuation">,</span> clsLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token function">memmove</span><span class="token punctuation">(</span>staticFieldId <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">+</span> clsLen<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> tkName <span class="token operator">=</span> name<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
		 <span class="token class-name">uint32_t</span> tkLen <span class="token operator">=</span> name<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
		 <span class="token function">memmove</span><span class="token punctuation">(</span>staticFieldId <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> clsLen<span class="token punctuation">,</span> tkName<span class="token punctuation">,</span> tkLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 staticFieldIdLen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>staticFieldId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
		 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">findLocal</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> staticFieldId<span class="token punctuation">,</span> staticFieldIdLen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">declareLocalVar</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> staticFieldId<span class="token punctuation">,</span> staticFieldIdLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token function">writeOpCode</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_PUSH_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token function">ASSERT</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>scopeDepth <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"should in class scope!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token function">defineVariable</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
		    <span class="token comment">//静态域可初始化</span>
		    Variable var <span class="token operator">=</span> <span class="token function">findVariable</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> staticFieldId<span class="token punctuation">,</span> staticFieldIdLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_ASSIGN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		       <span class="token function">expression</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> BP_LOWEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
		       <span class="token function">emitStoreVariable</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> var<span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			    <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span>
				<span class="token string">"static field '%s' redefinition!"</span><span class="token punctuation">,</span> <span class="token function">strchr</span><span class="token punctuation">(</span>staticFieldId<span class="token punctuation">,</span> <span class="token char">' '</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//定义实例域</span>
		 ClassBookKeep<span class="token operator">*</span> classBK <span class="token operator">=</span> <span class="token function">getEnclosingClassBK</span><span class="token punctuation">(</span>cu<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token keyword">int</span> fieldIndex <span class="token operator">=</span> <span class="token function">getIndexFromSymbolTable</span><span class="token punctuation">(</span>
		       <span class="token operator">&amp;</span>classBK<span class="token operator">-&gt;</span>fields<span class="token punctuation">,</span> name<span class="token punctuation">.</span>start<span class="token punctuation">,</span> name<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldIndex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		    fieldIndex <span class="token operator">=</span> <span class="token function">addSymbol</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span>
			 <span class="token operator">&amp;</span>classBK<span class="token operator">-&gt;</span>fields<span class="token punctuation">,</span> name<span class="token punctuation">.</span>start<span class="token punctuation">,</span> name<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		    <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldIndex <span class="token operator">&gt;</span> MAX_FIELD_NUM<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		       <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span>
			    <span class="token string">"the max number of instance field is %d!"</span><span class="token punctuation">,</span> MAX_FIELD_NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		       <span class="token keyword">char</span> id<span class="token punctuation">[</span>MAX_ID_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token char">''</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		       <span class="token function">memcpy</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">.</span>start<span class="token punctuation">,</span> name<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		       <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> 
			     <span class="token string">"instance field '%s' redefinition!"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token punctuation">}</span>
		    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_ASSIGN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		       <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> 
			     <span class="token string">"instance field isn`t allowed initialization!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token punctuation">}</span>
	 	<span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//二 若不是类中的域定义,就按照一般的变量定义</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_ASSIGN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//若在定义时赋值就解析表达式,结果会留到栈顶</span>
      <span class="token function">expression</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> BP_LOWEST<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//否则就初始化为NULL,即在栈顶压入NULL,</span>
      <span class="token comment">//也是为了与上面显式初始化保持相同栈结构</span>
      <span class="token function">writeOpCode</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_PUSH_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token class-name">uint32_t</span> index <span class="token operator">=</span> <span class="token function">declareVariable</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> name<span class="token punctuation">.</span>start<span class="token punctuation">,</span> name<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">defineVariable</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>词法分析器读到var后会执行此函数，用于编译变量定义语句。另外变量的使用语句的编译属于标识符的编译。此函数共处理定义类的实例变量、静态变量、以及一般的模块变量。</p> 
<h3>
<a id="271_static_var____404"></a>2.7.1 编译定义类静态变量语句：“static var 变量名 = 变量值”</h3> 
<p>若编译的是静态变量语句"static var 变量名 = 变量值"，步骤总结如下：</p> 
<ol>
<li>拼静态变量名：静态变量名为cls +类名+变量名</li>
<li>在模块cu-&gt;LocalVar寻找该静态变量</li>
<li>找到报未找到则declareLocalVar把静态变量存入模块cu-&gt;LocalVar（仅声明，不包含存储值）、局部变量的值存在运行时栈， OPCODE_PUSH_NULL已经把NULL放在了栈顶作为该局部变量初始值defineVariable啥也不做。</li>
<li>若有等于号赋值，则expression解析生成等于号右边的表达式的指令，再emitStoreVariable生成存储指令STORE_LOCAL_VAR再次将expression计算出的已经放入栈顶的值存入运行时栈相应位置，cu-&gt;LocalVar的索引和运行时栈索引一致。<br> cu-&gt;enclosingUnit == NULL &amp;&amp; cu-&gt;enclosingClassBK != NULL表示正在编译类中的"static var 变量名 = 变量值" 语句。</li>
</ol> 
<p>cu-&gt;enclosingUnit指向的是父编译单元。如果编译的是方法中的"static var 类名"语句，那么当前cu是方法cu，父cu是模块cu，所以cu-&gt;enclosingUnit会指向模块cu而不是NULL。如果是NULL表示当前cu是模块cu。cu-&gt;enclosingClassBK指向编译的类，如果不等于NULL说明正在编译类中语句。<br> 静态变量被所有实例共享，因此被当作模块的局部局部变量。由于不同类中可以定义同名静态变量，为了防止同名，静态变量名为cls +类名+变量名。</p> 
<h4>
<a id="2711_findLocaldefineVariable_414"></a>2.7.1.1 findLocal、defineVariable</h4> 
<pre><code class="prism language-c"><span class="token comment">//查找局部变量</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">findLocal</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">//内部作用域变量会覆外层,故从后往前,由最内层逐渐往外层找</span>
   <span class="token keyword">int</span> index <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>localVarNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">==</span> length <span class="token operator">&amp;&amp;</span>
		 <span class="token function">memcmp</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		 <span class="token keyword">return</span> index<span class="token punctuation">;</span> 
      <span class="token punctuation">}</span>
      index<span class="token operator">--</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//定义变量为其赋值</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">defineVariable</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">//局部变量已存储到栈中,无须处理.</span>
   <span class="token comment">//模块变量并不存储到栈中,因此将其写回相应位置</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>scopeDepth <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//把栈顶数据存入参数index指定的全局模块变量</span>
      <span class="token function">writeOpCodeShortOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_STORE_MODULE_VAR<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">writeOpCode</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_POP<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//弹出栈顶数据,因为上面OPCODE_STORE_MODULE_VAR已经将其存储了</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">CASE</span><span class="token punctuation">(</span>STORE_MODULE_VAR<span class="token punctuation">)</span><span class="token operator">:</span>
	 <span class="token comment">//栈顶: 模块变量值</span>
	fn<span class="token operator">-&gt;</span>module<span class="token operator">-&gt;</span>moduleVarValue<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token function">READ_SHORT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">PEEK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注意：编译static var 变量名 = 变量值时，由于是类静态变量，所以cu-&gt;scopeDepth等于0，<strong>所以defineVariable啥也不执行</strong>。类静态变量是模块局部变量，存储在运行时栈中，无需任何处理。也就是类静态变量初始值NULL已经push到了栈中，无需再任何处理。</p> 
<h4>
<a id="2712_findVariable_449"></a>2.7.1.2 findVariable</h4> 
<pre><code class="prism language-c"><span class="token comment">//从局部变量,upvalue和模块中查找变量name</span>
<span class="token keyword">static</span> Variable <span class="token function">findVariable</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

   <span class="token comment">//先从局部变量和upvalue中查找</span>
   Variable var <span class="token operator">=</span> <span class="token function">getVarFromLocalOrUpvalue</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>var<span class="token punctuation">.</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> var<span class="token punctuation">;</span>
  
   <span class="token comment">//若未找到再从模块变量中查找</span>
   var<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token function">getIndexFromSymbolTable</span><span class="token punctuation">(</span>
	 <span class="token operator">&amp;</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curModule<span class="token operator">-&gt;</span>moduleVarName<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>var<span class="token punctuation">.</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      var<span class="token punctuation">.</span>scopeType <span class="token operator">=</span> VAR_SCOPE_MODULE<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> var<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//从局部变量和upvalue中查找符号name</span>
<span class="token keyword">static</span> Variable <span class="token function">getVarFromLocalOrUpvalue</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   Variable var<span class="token punctuation">;</span>  
   <span class="token comment">//默认为无效作用域类型,查找到后会被更正</span>
   var<span class="token punctuation">.</span>scopeType <span class="token operator">=</span> VAR_SCOPE_INVALID<span class="token punctuation">;</span>

   var<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token function">findLocal</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>var<span class="token punctuation">.</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      var<span class="token punctuation">.</span>scopeType <span class="token operator">=</span> VAR_SCOPE_LOCAL<span class="token punctuation">;</span>
      <span class="token keyword">return</span> var<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   var<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token function">findUpvalue</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span>  name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>var<span class="token punctuation">.</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      var<span class="token punctuation">.</span>scopeType <span class="token operator">=</span> VAR_SCOPE_UPVALUE<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> var<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token comment">//查找局部变量</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">findLocal</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">//内部作用域变量会覆外层,故从后往前,由最内层逐渐往外层找</span>
   <span class="token keyword">int</span> index <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>localVarNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">==</span> length <span class="token operator">&amp;&amp;</span>
	 <span class="token function">memcmp</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token keyword">return</span> index<span class="token punctuation">;</span> 
      <span class="token punctuation">}</span>
      index<span class="token operator">--</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//添加upvalue到cu-&gt;upvalues,返回其索引.若已存在则只返回索引</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">addUpvalue</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> bool isEnclosingLocalVar<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token class-name">uint32_t</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> cu<span class="token operator">-&gt;</span>fn<span class="token operator">-&gt;</span>upvalueNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//如果该upvalue已经添加过了就返回其索引</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>upvalues<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>index <span class="token operator">==</span> index <span class="token operator">&amp;&amp;</span>
	    cu<span class="token operator">-&gt;</span>upvalues<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>isEnclosingLocalVar <span class="token operator">==</span> isEnclosingLocalVar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token keyword">return</span> idx<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      idx<span class="token operator">++</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">//若没找到则将其添加</span>
   cu<span class="token operator">-&gt;</span>upvalues<span class="token punctuation">[</span>cu<span class="token operator">-&gt;</span>fn<span class="token operator">-&gt;</span>upvalueNum<span class="token punctuation">]</span><span class="token punctuation">.</span>isEnclosingLocalVar <span class="token operator">=</span> isEnclosingLocalVar<span class="token punctuation">;</span>
   cu<span class="token operator">-&gt;</span>upvalues<span class="token punctuation">[</span>cu<span class="token operator">-&gt;</span>fn<span class="token operator">-&gt;</span>upvalueNum<span class="token punctuation">]</span><span class="token punctuation">.</span>index <span class="token operator">=</span> index<span class="token punctuation">;</span> 
   <span class="token keyword">return</span> cu<span class="token operator">-&gt;</span>fn<span class="token operator">-&gt;</span>upvalueNum<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//查找name指代的upvalue后添加到cu-&gt;upvalues,返回其索引,否则返回-1</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">findUpvalue</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>enclosingUnit <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//如果已经到了最外层仍未找到,返回-1.</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">//进入了方法的cu并且查找的不是静态域,即不是方法的Upvalue,那就没必要再往上找了</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strchr</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token char">' '</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> cu<span class="token operator">-&gt;</span>enclosingUnit<span class="token operator">-&gt;</span>enclosingClassBK <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//查看name是否为直接外层的局部变量</span>
   <span class="token keyword">int</span> directOuterLocalIndex <span class="token operator">=</span> <span class="token function">findLocal</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>enclosingUnit<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//若是,将该外层局部变量置为upvalue,</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>directOuterLocalIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      cu<span class="token operator">-&gt;</span>enclosingUnit<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span>directOuterLocalIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>isUpvalue <span class="token operator">=</span> true<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">addUpvalue</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> true<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>directOuterLocalIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//向外层递归查找</span>
   <span class="token keyword">int</span> directOuterUpvalueIndex <span class="token operator">=</span> <span class="token function">findUpvalue</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>enclosingUnit<span class="token punctuation">,</span> name<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>directOuterUpvalueIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token function">addUpvalue</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> false<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>directOuterUpvalueIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//执行到此说明没有该upvalue对应的局部变量,返回-1</span>
   <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>upvalue相关暂时用不上，</p> 
<h4>
<a id="2713_emitStoreVariable_548"></a>2.7.1.3 emitStoreVariable</h4> 
<pre><code class="prism language-c"><span class="token comment">//为变量var生成存储的指令</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">emitStoreVariable</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> Variable var<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">switch</span> <span class="token punctuation">(</span>var<span class="token punctuation">.</span>scopeType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> VAR_SCOPE_LOCAL<span class="token operator">:</span> 
	 <span class="token comment">//生成存储局部变量的指令</span>
	 <span class="token function">writeOpCodeByteOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_STORE_LOCAL_VAR<span class="token punctuation">,</span> var<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> VAR_SCOPE_UPVALUE<span class="token operator">:</span> 
	 <span class="token comment">//生成存储upvalue的指令</span>
	 <span class="token function">writeOpCodeByteOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_STORE_UPVALUE<span class="token punctuation">,</span> var<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> VAR_SCOPE_MODULE<span class="token operator">:</span> 
	 <span class="token comment">//生成存储模块变量的指令</span>
	 <span class="token function">writeOpCodeShortOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_STORE_MODULE_VAR<span class="token punctuation">,</span> var<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
	 <span class="token function">NOT_REACHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

stackStart <span class="token operator">=</span> curFrame<span class="token operator">-&gt;</span>stackStart<span class="token punctuation">;</span>
<span class="token function">CASE</span><span class="token punctuation">(</span>STORE_LOCAL_VAR<span class="token punctuation">)</span><span class="token operator">:</span>
	 <span class="token comment">//栈顶: 局部变量值</span>
	 <span class="token comment">//指令流: 1字节的局部变量索引</span>
	 <span class="token comment">//将PEEK()得到的栈顶数据写入指令参数(即READ_BYTE()得到的值)为索引的栈的slot中</span>
	 stackStart<span class="token punctuation">[</span><span class="token function">READ_BYTE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">PEEK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>将expression计算出的已经放入栈顶的值放入index指定的运行时栈的slot中。</p> 
<h3>
<a id="272__581"></a>2.7.2 定义类实例变量</h3> 
<p>步骤很简单，如下：</p> 
<ol>
<li>调用getEnclosingClassBK，查看当前模块cu指向的ClassBookKeep，</li>
<li>再调用getIndexFromSymbolTable在classBK的fields查找，存在则报错重定义，不存在则调用addSymbol向classBK-&gt;fileds添加</li>
<li>实例变量不允许定义的时候赋值，检测到等号则报错。</li>
</ol> 
<p>类实例变量的赋值会在编译标识符语句完成。</p> 
<h2>
<a id="28_compileMethod_590"></a>2.8 compileMethod</h2> 
<pre><code class="prism language-c"><span class="token comment">//编译方法定义,isStatic表示是否在编译静态方法</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">compileMethod</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> Variable classVar<span class="token punctuation">,</span> bool isStatic<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">//inStatic表示是否为静态方法的编译单元</span>
   cu<span class="token operator">-&gt;</span>enclosingClassBK<span class="token operator">-&gt;</span>inStatic <span class="token operator">=</span> isStatic<span class="token punctuation">;</span>
   methodSignatureFn methodSign <span class="token operator">=</span> 
      Rules<span class="token punctuation">[</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curToken<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span>methodSign<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>methodSign <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"method need signature fucntion!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token punctuation">}</span>

   Signature sign<span class="token punctuation">;</span>
   <span class="token comment">// curToken是方法名</span>
   sign<span class="token punctuation">.</span>name <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curToken<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
   sign<span class="token punctuation">.</span>length <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curToken<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
   sign<span class="token punctuation">.</span>argNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

   cu<span class="token operator">-&gt;</span>enclosingClassBK<span class="token operator">-&gt;</span>signature <span class="token operator">=</span> <span class="token operator">&amp;</span>sign<span class="token punctuation">;</span>
   <span class="token function">getNextToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//为了将函数或方法自己的指令流和局部变量单独存储,</span>
   <span class="token comment">//每个函数或方法都有自己的CompileUnit.</span>
   CompileUnit methodCU<span class="token punctuation">;</span>
   <span class="token comment">//编译一个方法啦,因此形参isMethod为true</span>
   <span class="token function">initCompileUnit</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token operator">&amp;</span>methodCU<span class="token punctuation">,</span> cu<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//构造签名 </span>
   <span class="token function">methodSign</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>methodCU<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">consumeCurToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_LEFT_BRACE<span class="token punctuation">,</span>
	 <span class="token string">"expect '{' at the beginning of method body."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>enclosingClassBK<span class="token operator">-&gt;</span>inStatic <span class="token operator">&amp;&amp;</span> sign<span class="token punctuation">.</span>type <span class="token operator">==</span> SIGN_CONSTRUCT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"constuctor is not allowed to be static!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">char</span> signatureString<span class="token punctuation">[</span>MAX_SIGN_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token char">''</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token class-name">uint32_t</span> signLen <span class="token operator">=</span> <span class="token function">sign2String</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sign<span class="token punctuation">,</span> signatureString<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//将方法声明</span>
   <span class="token class-name">uint32_t</span> methodIndex <span class="token operator">=</span> <span class="token function">declareMethod</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> signatureString<span class="token punctuation">,</span> signLen<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//编译方法体指令流到方法自己的编译单元methodCU</span>
   <span class="token function">compileBody</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>methodCU<span class="token punctuation">,</span> sign<span class="token punctuation">.</span>type <span class="token operator">==</span> SIGN_CONSTRUCT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEBUG</span></span>
   <span class="token comment">//结束编译并创建方法闭包</span>
   <span class="token function">endCompileUnit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>methodCU<span class="token punctuation">,</span> signatureString<span class="token punctuation">,</span> signLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
   <span class="token comment">//结束编译并创建方法闭包</span>
   <span class="token function">endCompileUnit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>methodCU<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

   <span class="token comment">//定义方法:将上面创建的方法闭包绑定到类</span>
   <span class="token function">defineMethod</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> classVar<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>enclosingClassBK<span class="token operator">-&gt;</span>inStatic<span class="token punctuation">,</span> methodIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>sign<span class="token punctuation">.</span>type <span class="token operator">==</span> SIGN_CONSTRUCT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      sign<span class="token punctuation">.</span>type <span class="token operator">=</span> SIGN_METHOD<span class="token punctuation">;</span>
      <span class="token keyword">char</span> signatureString<span class="token punctuation">[</span>MAX_SIGN_LEN<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token char">''</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token class-name">uint32_t</span> signLen <span class="token operator">=</span> <span class="token function">sign2String</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sign<span class="token punctuation">,</span> signatureString<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">uint32_t</span> constructorIndex <span class="token operator">=</span> <span class="token function">ensureSymbolExist</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span>
	   <span class="token operator">&amp;</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token operator">-&gt;</span>allMethodNames<span class="token punctuation">,</span> signatureString<span class="token punctuation">,</span> signLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token function">emitCreateInstance</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sign<span class="token punctuation">,</span> methodIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//构造函数是静态方法,即类方法</span>
      <span class="token function">defineMethod</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> classVar<span class="token punctuation">,</span> true<span class="token punctuation">,</span> constructorIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>类方法包括一般实例方法，静态方法，getter方法获取对象属性、setter方法设置对象属性，构造方法（既是实例方法也是静态方法）<br> 编译方法步骤如下：</p> 
<ol>
<li>调用initCompileUnit初始化一个新的编译单元methodCU用于编译方法。但methodCU-&gt;scopeDepth依然为0</li>
<li>获取methodSignatureFn methodSign（即id的签名函数idMethodSignature），调用methodSign(&amp;methodCU, &amp;sign)构造签名函数。token为id即标识符的签名函数主要设置了sign的type，然后词法分析器分析了方法的括号后面的形参，对形参依次进行了declareLocalVar（因为是类的方法，已经在类里面了，所以这些形参不会是模块变量而是methodCU-&gt;LocalVar里声明好的局部变量。）。</li>
<li>sign2String、declareMethod生成方法名并声明于vm-&gt;allMethodNames，并排查重定义</li>
<li>调用compileBody(&amp;methodCU, sign.type == SIGN_CONSTRUCT)开始编译方法体语句生成相应指令。</li>
<li>调用endCompileUnit(&amp;methodCU)创建闭包压入栈顶</li>
<li>defineMethod，把方法闭包赋值到类的methods</li>
<li>若编译的方法是构造函数new，则执行emitCreateInstance返回实例对象，再defineMethod将方法复制到元类的method中</li>
</ol> 
<h3>
<a id="281_initCompileUnit_671"></a>2.8.1 initCompileUnit</h3> 
<pre><code class="prism language-c"><span class="token comment">//初始化CompileUnit</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initCompileUnit</span><span class="token punctuation">(</span>Parser<span class="token operator">*</span> parser<span class="token punctuation">,</span> CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span>
      CompileUnit<span class="token operator">*</span> enclosingUnit<span class="token punctuation">,</span> bool isMethod<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   parser<span class="token operator">-&gt;</span>curCompileUnit <span class="token operator">=</span> cu<span class="token punctuation">;</span>
   cu<span class="token operator">-&gt;</span>curParser <span class="token operator">=</span> parser<span class="token punctuation">;</span>
   cu<span class="token operator">-&gt;</span>enclosingUnit <span class="token operator">=</span> enclosingUnit<span class="token punctuation">;</span>
   cu<span class="token operator">-&gt;</span>curLoop <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
   cu<span class="token operator">-&gt;</span>enclosingClassBK <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

   <span class="token comment">//若没有外层,说明当前属于模块作用域</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>enclosingUnit <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//编译代码时是从上到下从最外层的模块作用域开始,模块作用域设为-1</span>
      cu<span class="token operator">-&gt;</span>scopeDepth <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token comment">//模块级作用域中没有局部变量</span>
      cu<span class="token operator">-&gt;</span>localVarNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//若是内层单元,属局部作用域</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isMethod<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//若是类中的方法</span>
		 <span class="token comment">//如果是类的方法就设定隐式"this"为第0个局部变量,即实例对象,</span>
		 <span class="token comment">//它是方法(消息)的接收者.this这种特殊对象被处理为局部变量</span>
		 cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"this"</span><span class="token punctuation">;</span> 
		 cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>	  <span class="token comment">//若为普通函数</span>
		 <span class="token comment">//空出第0个局部变量,保持统一</span>
		 cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> 
		 cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span>

      <span class="token comment">//第0个局部变量的特殊性使其作用域为模块级别</span>
      cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>scopeDepth <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
      cu<span class="token operator">-&gt;</span>localVars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isUpvalue <span class="token operator">=</span> false<span class="token punctuation">;</span> 
      cu<span class="token operator">-&gt;</span>localVarNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//localVars[0]被分配</span>
      <span class="token comment">// 对于函数和方法来说,初始作用域是局部作用域</span>
      <span class="token comment">// 0表示局部作用域的最外层</span>
      cu<span class="token operator">-&gt;</span>scopeDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span>

   <span class="token comment">//局部变量保存在栈中,初始时栈中已使用的slot数量等于局部变量的数量</span>
   cu<span class="token operator">-&gt;</span>stackSlotNum <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>localVarNum<span class="token punctuation">;</span>

   cu<span class="token operator">-&gt;</span>fn <span class="token operator">=</span> <span class="token function">newObjFn</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curModule<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>localVarNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="282_idMethodSignature_716"></a>2.8.2 idMethodSignature</h3> 
<pre><code class="prism language-c"><span class="token comment">//标识符的签名函数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">idMethodSignature</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> Signature<span class="token operator">*</span> sign<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

   sign<span class="token operator">-&gt;</span>type <span class="token operator">=</span> SIGN_GETTER<span class="token punctuation">;</span>  <span class="token comment">//刚识别到id,默认为getter</span>

   <span class="token comment">//new方法为构造函数</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>sign<span class="token operator">-&gt;</span>length <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> <span class="token function">memcmp</span><span class="token punctuation">(</span>sign<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"new"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//构造函数后面不能接'=',即不能成为setter</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_ASSIGN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"constructor shouldn`t be setter!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//构造函数必须是标准的method,即new(_,...),new后面必须接'('</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_LEFT_PAREN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"constructor must be method!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      sign<span class="token operator">-&gt;</span>type <span class="token operator">=</span> SIGN_CONSTRUCT<span class="token punctuation">;</span>

      <span class="token comment">//无参数就直接返回</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_RIGHT_PAREN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//若不是构造函数</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">trySetter</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token comment">//若是setter,此时已经将type改为了setter,直接返回</span>
	 <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_LEFT_PAREN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token comment">//若后面没有'('说明是getter,type已在开头置为getter,直接返回</span>
	 <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//至此type应该为一般形式的SIGN_METHOD,形式为name(paralist)</span>
      sign<span class="token operator">-&gt;</span>type <span class="token operator">=</span> SIGN_METHOD<span class="token punctuation">;</span>
      <span class="token comment">//直接匹配到')'，说明形参为空</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_RIGHT_PAREN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//下面处理形参</span>
   <span class="token function">processParaList</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">consumeCurToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_RIGHT_PAREN<span class="token punctuation">,</span> <span class="token string">"expect ')' after parameter list!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="2821_trySetter_processParaList_769"></a>2.8.2.1 trySetter processParaList</h3> 
<pre><code class="prism language-c"><span class="token comment">//尝试编译setter</span>
<span class="token keyword">static</span> bool <span class="token function">trySetter</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> Signature<span class="token operator">*</span> sign<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_ASSIGN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> false<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>sign<span class="token operator">-&gt;</span>type <span class="token operator">==</span> SIGN_SUBSCRIPT<span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span>
      sign<span class="token operator">-&gt;</span>type <span class="token operator">=</span> SIGN_SUBSCRIPT_SETTER<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      sign<span class="token operator">-&gt;</span>type <span class="token operator">=</span> SIGN_SETTER<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//读取等号右边的形参左边的'('</span>
   <span class="token function">consumeCurToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_LEFT_PAREN<span class="token punctuation">,</span> <span class="token string">"expect '(' after '='!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//读取形参</span>
   <span class="token function">consumeCurToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_ID<span class="token punctuation">,</span> <span class="token string">"expect ID!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//声明形参</span>
   <span class="token function">declareVariable</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>preToken<span class="token punctuation">.</span>start<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>preToken<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//读取等号右边的形参右边的'('</span>
   <span class="token function">consumeCurToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_RIGHT_PAREN<span class="token punctuation">,</span> <span class="token string">"expect ')' after argument list!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   sign<span class="token operator">-&gt;</span>argNum<span class="token operator">++</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//声明形参列表中的各个形参</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">processParaList</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> Signature<span class="token operator">*</span> sign<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token function">ASSERT</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curToken<span class="token punctuation">.</span>type <span class="token operator">!=</span> TOKEN_RIGHT_PAREN <span class="token operator">&amp;&amp;</span>
	 cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curToken<span class="token punctuation">.</span>type <span class="token operator">!=</span> TOKEN_RIGHT_BRACKET<span class="token punctuation">,</span> <span class="token string">"empty argument list!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>sign<span class="token operator">-&gt;</span>argNum <span class="token operator">&gt;</span> MAX_ARG_NUM<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"the max number of argument is %d!"</span><span class="token punctuation">,</span> MAX_ARG_NUM<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span>
      <span class="token function">consumeCurToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_ID<span class="token punctuation">,</span> <span class="token string">"expect variable name!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">declareVariable</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>preToken<span class="token punctuation">.</span>start<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>preToken<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_COMMA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="283_sign2String_811"></a>2.8.3 sign2String</h3> 
<pre><code class="prism language-c">
<span class="token comment">//把Signature转换为字符串,返回字符串长度</span>
<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> <span class="token function">sign2String</span><span class="token punctuation">(</span>Signature<span class="token operator">*</span> sign<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token class-name">uint32_t</span> pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

   <span class="token comment">//复制方法名xxx</span>
   <span class="token function">memcpy</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> pos<span class="token punctuation">,</span> sign<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> sign<span class="token operator">-&gt;</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
   pos <span class="token operator">+=</span> sign<span class="token operator">-&gt;</span>length<span class="token punctuation">;</span>

   <span class="token comment">//下面单独处理方法名之后的部分</span>
   <span class="token keyword">switch</span> <span class="token punctuation">(</span>sign<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//SIGN_GETTER形式:xxx,无参数,上面memcpy已完成</span>
      <span class="token keyword">case</span> SIGN_GETTER<span class="token operator">:</span>
	 <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token comment">//SIGN_SETTER形式: xxx=(_),之前已完成xxx</span>
      <span class="token keyword">case</span> SIGN_SETTER<span class="token operator">:</span> 
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'='</span><span class="token punctuation">;</span>
	 <span class="token comment">//下面添加=右边的赋值,只支持一个赋值</span>
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'('</span><span class="token punctuation">;</span>
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'_'</span><span class="token punctuation">;</span>
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">')'</span><span class="token punctuation">;</span>
	 <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token comment">//SIGN_METHOD和SIGN_CONSTRUCT形式:xxx(_,...)</span>
      <span class="token keyword">case</span> SIGN_CONSTRUCT<span class="token operator">:</span>
      <span class="token keyword">case</span> SIGN_METHOD<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'('</span><span class="token punctuation">;</span>
	 <span class="token class-name">uint32_t</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	 <span class="token keyword">while</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> sign<span class="token operator">-&gt;</span>argNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'_'</span><span class="token punctuation">;</span>  
	    buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">','</span><span class="token punctuation">;</span>  
	    idx<span class="token operator">++</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>

	 <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//说明没有参数</span>
	    buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">')'</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//用rightBracket覆盖最后的','</span>
	    buf<span class="token punctuation">[</span>pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">')'</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>
	 <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//SIGN_SUBSCRIPT形式:xxx[_,...]</span>
      <span class="token keyword">case</span> SIGN_SUBSCRIPT<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'['</span><span class="token punctuation">;</span>
	 <span class="token class-name">uint32_t</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	 <span class="token keyword">while</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> sign<span class="token operator">-&gt;</span>argNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'_'</span><span class="token punctuation">;</span>  
	    buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">','</span><span class="token punctuation">;</span>  
	    idx<span class="token operator">++</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>
	 <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//说明没有参数</span>
	    buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">']'</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//用rightBracket覆盖最后的','</span>
	    buf<span class="token punctuation">[</span>pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">']'</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>
	 <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//SIGN_SUBSCRIPT_SETTER形式:xxx[_,...]=(_)</span>
      <span class="token keyword">case</span> SIGN_SUBSCRIPT_SETTER<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'['</span><span class="token punctuation">;</span>
	 <span class="token class-name">uint32_t</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	 <span class="token comment">//argNum包括了等号右边的1个赋值参数,</span>
	 <span class="token comment">//这里是在处理等号左边subscript中的参数列表,因此减1.</span>
	 <span class="token comment">//后面专门添加该参数</span>
	 <span class="token keyword">while</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> sign<span class="token operator">-&gt;</span>argNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'_'</span><span class="token punctuation">;</span>  
	    buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">','</span><span class="token punctuation">;</span>  
	    idx<span class="token operator">++</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>
	 <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//说明没有参数</span>
	    buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">']'</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//用rightBracket覆盖最后的','</span>
	    buf<span class="token punctuation">[</span>pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">']'</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>

	 <span class="token comment">//下面为等号右边的参数构造签名部分</span>
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'='</span><span class="token punctuation">;</span>  
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'('</span><span class="token punctuation">;</span>
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'_'</span><span class="token punctuation">;</span>
	 buf<span class="token punctuation">[</span>pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">')'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   buf<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">''</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> pos<span class="token punctuation">;</span>   <span class="token comment">//返回签名串的长度</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="284_declareMethod_904"></a>2.8.4 declareMethod</h3> 
<pre><code class="prism language-c"><span class="token comment">//声明方法</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">declareMethod</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> signStr<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">//确保方法被录入到vm-&gt;allMethodNames</span>
   <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">ensureSymbolExist</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span>
	 <span class="token operator">&amp;</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token operator">-&gt;</span>allMethodNames<span class="token punctuation">,</span> signStr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//下面判断方法是否已定义 即排除重定义</span>
   IntBuffer<span class="token operator">*</span> methods <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>enclosingClassBK<span class="token operator">-&gt;</span>inStatic <span class="token operator">?</span>
	  <span class="token operator">&amp;</span>cu<span class="token operator">-&gt;</span>enclosingClassBK<span class="token operator">-&gt;</span>staticMethods <span class="token operator">:</span> 
	  <span class="token operator">&amp;</span>cu<span class="token operator">-&gt;</span>enclosingClassBK<span class="token operator">-&gt;</span>instantMethods<span class="token punctuation">;</span> 
   <span class="token class-name">uint32_t</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> methods<span class="token operator">-&gt;</span>count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>methods<span class="token operator">-&gt;</span>datas<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"repeat define method %s in class %s!"</span><span class="token punctuation">,</span>
	    signStr<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>enclosingClassBK<span class="token operator">-&gt;</span>name<span class="token operator">-&gt;</span>value<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      idx<span class="token operator">++</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//若是新定义就加入,这里并不是注册新方法,</span>
   <span class="token comment">//而是用索引来记录已经定义过的方法,用于以后排重</span>
   <span class="token function">IntBufferAdd</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="285_compileBody_932"></a>2.8.5 compileBody</h3> 
<pre><code class="prism language-c"><span class="token comment">//编译函数或方法体</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">compileBody</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> bool isConstruct<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">//进入本函数前已经读入了'{'</span>
   <span class="token function">compileBlock</span><span class="token punctuation">(</span>cu<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span> <span class="token punctuation">(</span>isConstruct<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//若是构造函数就加载"this对象"做为下面OPCODE_RETURN的返回值</span>
      <span class="token function">writeOpCodeByteOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_LOAD_LOCAL_VAR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//否则加载null占位</span>
      <span class="token function">writeOpCode</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_PUSH_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span>

   <span class="token comment">//返回编译结果,若是构造函数就返回this,否则返回null</span>
   <span class="token function">writeOpCode</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//编译代码块</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">compileBlock</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">//进入本函数前已经读入了'{'</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_RIGHT_BRACE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PEEK_TOKEN</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_EOF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token function">COMPILE_ERROR</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token string">"expect '}' at the end of block!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token punctuation">}</span>
      <span class="token function">compileProgram</span><span class="token punctuation">(</span>cu<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">//编译程序</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">compileProgram</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_CLASS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">compileClassDefinition</span><span class="token punctuation">(</span>cu<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_FUN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">compileFunctionDefinition</span><span class="token punctuation">(</span>cu<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_VAR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">compileVarDefinition</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>preToken<span class="token punctuation">.</span>type <span class="token operator">==</span> TOKEN_STATIC<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchToken</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> TOKEN_IMPORT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">compileImport</span><span class="token punctuation">(</span>cu<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">compileStatment</span><span class="token punctuation">(</span>cu<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="286_endCompileUnit_979"></a>2.8.6 endCompileUnit</h3> 
<pre><code class="prism language-c"><span class="token comment">//结束cu的编译工作,在其外层编译单元中为其创建闭包</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEBUG</span></span>
<span class="token keyword">static</span> ObjFn<span class="token operator">*</span> <span class="token function">endCompileUnit</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span>
      <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> debugName<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> debugNameLen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token function">bindDebugFnName</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>vm<span class="token punctuation">,</span> cu<span class="token operator">-&gt;</span>fn<span class="token operator">-&gt;</span>debug<span class="token punctuation">,</span> debugName<span class="token punctuation">,</span> debugNameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token keyword">static</span> ObjFn<span class="token operator">*</span> <span class="token function">endCompileUnit</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
   <span class="token comment">//标识单元编译结束</span>
   <span class="token function">writeOpCode</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_END<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>enclosingUnit <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//把当前编译的objFn做为常量添加到父编译单元的常量表</span>
      <span class="token class-name">uint32_t</span> index <span class="token operator">=</span> <span class="token function">addConstant</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>enclosingUnit<span class="token punctuation">,</span> <span class="token function">OBJ_TO_VALUE</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//内层函数以闭包形式在外层函数中存在,</span>
      <span class="token comment">//在外层函数的指令流中添加"为当前内层函数创建闭包的指令"</span>
      <span class="token function">writeOpCodeShortOperand</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>enclosingUnit<span class="token punctuation">,</span> OPCODE_CREATE_CLOSURE<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">//为vm在创建闭包时判断引用的是局部变量还是upvalue,</span>
      <span class="token comment">//下面为每个upvalue生成参数.</span>
      index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> cu<span class="token operator">-&gt;</span>fn<span class="token operator">-&gt;</span>upvalueNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		 <span class="token function">writeByte</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>enclosingUnit<span class="token punctuation">,</span>
		       cu<span class="token operator">-&gt;</span>upvalues<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>isEnclosingLocalVar <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token function">writeByte</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>enclosingUnit<span class="token punctuation">,</span>
		       cu<span class="token operator">-&gt;</span>upvalues<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 index<span class="token operator">++</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">///下掉本编译单元,使当前编译单元指向外层编译单元</span>
   cu<span class="token operator">-&gt;</span>curParser<span class="token operator">-&gt;</span>curCompileUnit <span class="token operator">=</span> cu<span class="token operator">-&gt;</span>enclosingUnit<span class="token punctuation">;</span>
   <span class="token keyword">return</span> cu<span class="token operator">-&gt;</span>fn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token function">CASE</span><span class="token punctuation">(</span>CREATE_CLOSURE<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token comment">//指令流: 2字节待创建闭包的函数在常量表中的索引+函数所用的upvalue数 * 2 </span>

	 <span class="token comment">//endCompileUnit已经将闭包函数添加进了常量表</span>
	 ObjFn<span class="token operator">*</span> objFn <span class="token operator">=</span>	<span class="token function">VALUE_TO_OBJFN</span><span class="token punctuation">(</span>fn<span class="token operator">-&gt;</span>constants<span class="token punctuation">.</span>datas<span class="token punctuation">[</span><span class="token function">READ_SHORT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 ObjClosure<span class="token operator">*</span> objClosure <span class="token operator">=</span> <span class="token function">newObjClosure</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> objFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token comment">//将创建好的闭包的value结构压到栈顶,</span>
	 <span class="token comment">//后续会有函数如defineMethod从栈底取出</span>
	 <span class="token comment">//先将其压到栈中,后面再创建upvalue,这样可避免在创建upvalue过程中被GC</span>
	 <span class="token function">PUSH</span><span class="token punctuation">(</span><span class="token function">OBJ_TO_VALUE</span><span class="token punctuation">(</span>objClosure<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	 <span class="token class-name">uint32_t</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	 <span class="token keyword">while</span> <span class="token punctuation">(</span>idx <span class="token operator">&lt;</span> objFn<span class="token operator">-&gt;</span>upvalueNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token comment">//读入endCompilerUnit函数最后为每个upvale写入的数据对儿</span>
	    <span class="token class-name">uint8_t</span> isEnclosingLocalVar <span class="token operator">=</span> <span class="token function">READ_BYTE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token class-name">uint8_t</span> index <span class="token operator">=</span> <span class="token function">READ_BYTE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEnclosingLocalVar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//是直接外层的局部变量</span>
	       <span class="token comment">//创建upvalue</span>
	       objClosure<span class="token operator">-&gt;</span>upvalues<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> 
		  <span class="token function">createOpenUpvalue</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> curThread<span class="token punctuation">,</span> curFrame<span class="token operator">-&gt;</span>stackStart <span class="token operator">+</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	       <span class="token comment">//直接从父编译单元中继承</span>
	       objClosure<span class="token operator">-&gt;</span>upvalues<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> curFrame<span class="token operator">-&gt;</span>closure<span class="token operator">-&gt;</span>upvalues<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    idx<span class="token operator">++</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>

	 <span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol>
<li>将需要结束编译的cu-&gt;fn添加进父编译单元的常量表，并返回索引</li>
<li>在父编译单元的指令流fn里生成OPCODE_CREATE_CLOSURE指令,此指令会创建新的ObjClosure收集upvalue并压入栈顶。</li>
<li>再写入多个upvalue对操作数{是否为直接外层的局部变量，在直接外层的索引}</li>
<li>词法分析器的当前编译单元赋值为父编译单元，返回需要结束编译单元cu的fn</li>
</ol> 
<h3>
<a id="287_defineMethodemitLoadVariable_1053"></a>2.8.7 defineMethod、emitLoadVariable</h3> 
<pre><code class="prism language-c"><span class="token comment">//将方法methodIndex指代的方法塞入classVar指代的class.methods中</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">defineMethod</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span>
      Variable classVar<span class="token punctuation">,</span> bool isStatic<span class="token punctuation">,</span> <span class="token keyword">int</span> methodIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//1 待绑定的方法在调用本函数之前已经放到栈顶了</span>

<span class="token comment">//2 将方法所属的类加载到栈顶 </span>
   <span class="token function">emitLoadVariable</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> classVar<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//3 生成OPCODE_STATIC_METHOD或OPCODE_INSTANCE_METHOD</span>
   <span class="token comment">//在运行时绑定</span>
   OpCode opCode <span class="token operator">=</span> isStatic <span class="token operator">?</span> 
      OPCODE_STATIC_METHOD <span class="token operator">:</span> OPCODE_INSTANCE_METHOD<span class="token punctuation">;</span>
   <span class="token function">writeOpCodeShortOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> opCode<span class="token punctuation">,</span> methodIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token comment">//生成把变量var加载到栈的指令</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">emitLoadVariable</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span> Variable var<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">switch</span> <span class="token punctuation">(</span>var<span class="token punctuation">.</span>scopeType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> VAR_SCOPE_LOCAL<span class="token operator">:</span> 
	 <span class="token comment">//生成加载局部变量入栈的指令</span>
	 <span class="token function">writeOpCodeByteOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_LOAD_LOCAL_VAR<span class="token punctuation">,</span> var<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> VAR_SCOPE_UPVALUE<span class="token operator">:</span> 
	 <span class="token comment">//生成加载upvalue到栈的指令</span>
	 <span class="token function">writeOpCodeByteOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_LOAD_UPVALUE<span class="token punctuation">,</span> var<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> VAR_SCOPE_MODULE<span class="token operator">:</span> 
	 <span class="token comment">//生成加载模块变量到栈的指令</span>
	 <span class="token function">writeOpCodeShortOperand</span><span class="token punctuation">(</span>cu<span class="token punctuation">,</span> OPCODE_LOAD_MODULE_VAR<span class="token punctuation">,</span> var<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
	 <span class="token function">NOT_REACHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

	 
</code></pre> 
<pre><code class="prism language-c"> 	  <span class="token function">CASE</span><span class="token punctuation">(</span>INSTANCE_METHOD<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>STATIC_METHOD<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token comment">//指令流: 待绑定的方法"名字"在vm-&gt;allMethodNames中的2字节的索引</span>
	 <span class="token comment">//栈顶: 待绑定的类  次栈顶: 待绑定的方法</span>

	 <span class="token comment">//获得方法名的索引</span>
	 <span class="token class-name">uint32_t</span> methodNameIndex <span class="token operator">=</span> <span class="token function">READ_SHORT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token comment">//从栈顶中获得待绑定的类</span>
	 Class<span class="token operator">*</span> class <span class="token operator">=</span> <span class="token function">VALUE_TO_CLASS</span><span class="token punctuation">(</span><span class="token function">PEEK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token comment">//从次栈顶中获得待绑定的方法,</span>
	 <span class="token comment">//这是由OPCODE_CREATE_CLOSURE操作码生成后压到栈中的</span>
	 Value method <span class="token operator">=</span> <span class="token function">PEEK2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token function">bindMethodAndPatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opCode<span class="token punctuation">,</span> methodNameIndex<span class="token punctuation">,</span> class<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 
	 <span class="token function">DROP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">DROP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">//绑定方法和修正操作数</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bindMethodAndPatch</span><span class="token punctuation">(</span>VM<span class="token operator">*</span> vm<span class="token punctuation">,</span> OpCode opCode<span class="token punctuation">,</span> 
      <span class="token class-name">uint32_t</span> methodIndex<span class="token punctuation">,</span> Class<span class="token operator">*</span> class<span class="token punctuation">,</span> Value methodValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

   <span class="token comment">//如果是静态方法,就将类指向meta类(使接收者为meta类)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>opCode <span class="token operator">==</span> OPCODE_STATIC_METHOD<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      class <span class="token operator">=</span> class<span class="token operator">-&gt;</span>objHeader<span class="token punctuation">.</span>class<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   Method method<span class="token punctuation">;</span>
   method<span class="token punctuation">.</span>type <span class="token operator">=</span> MT_SCRIPT<span class="token punctuation">;</span>
   method<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token function">VALUE_TO_OBJCLOSURE</span><span class="token punctuation">(</span>methodValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token comment">//修正操作数</span>
   <span class="token function">patchOperand</span><span class="token punctuation">(</span>class<span class="token punctuation">,</span> method<span class="token punctuation">.</span>obj<span class="token operator">-&gt;</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//修正过后,绑定method到class</span>
   <span class="token function">bindMethod</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> class<span class="token punctuation">,</span> methodIndex<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行上述两个函数后，栈顶是类即模块变量，次栈顶是编译的方法闭包，然后调用OPCODE_STATIC_METHOD或OPCODE_INSTANCE_METHOD将方法绑定到类，也就是把方法赋值到类的methods。<br> <img src="https://images2.imgbox.com/5c/6b/Ry5Q5xyn_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="29___emitCreateInstance_1138"></a>2.9 若编译的是构造方法 emitCreateInstance</h2> 
<pre><code class="prism language-c"><span class="token comment">//分两步创建实例,constructorIndex是构造函数的索引</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">emitCreateInstance</span><span class="token punctuation">(</span>CompileUnit<span class="token operator">*</span> cu<span class="token punctuation">,</span>
      Signature<span class="token operator">*</span> sign<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> constructorIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   CompileUnit methodCU<span class="token punctuation">;</span>
   <span class="token function">initCompileUnit</span><span class="token punctuation">(</span>cu<span class="token operator">-&gt;</span>curParser<span class="token punctuation">,</span> <span class="token operator">&amp;</span>methodCU<span class="token punctuation">,</span> cu<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//1 生成OPCODE_CONSTRUCT指令,该指令生成新实例存储到stack[0].</span>
   <span class="token function">writeOpCode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>methodCU<span class="token punctuation">,</span> OPCODE_CONSTRUCT<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//2 生成OPCODE_CALLx指令,该指令调用新实例的构造函数.</span>
   <span class="token function">writeOpCodeShortOperand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>methodCU<span class="token punctuation">,</span>
	 <span class="token punctuation">(</span>OpCode<span class="token punctuation">)</span><span class="token punctuation">(</span>OPCODE_CALL0 <span class="token operator">+</span> sign<span class="token operator">-&gt;</span>argNum<span class="token punctuation">)</span><span class="token punctuation">,</span> constructorIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">//生成return指令,将栈顶中的实例返回</span>
   <span class="token function">writeOpCode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>methodCU<span class="token punctuation">,</span> OPCODE_RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEBUG</span></span>
   <span class="token function">endCompileUnit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>methodCU<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
   <span class="token function">endCompileUnit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>methodCU<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/30/b1/QaFScMLl_o.png" alt="在这里插入图片描述"><br> 需要注意的是，emitCreateInstance里创建了一个新编译单元，专门写入这三条指令，然后封装成闭包，最后下面的defineMethod将闭包写入元类的method。<br> 整个指令流步骤如下：</p> 
<ol>
<li>OPCODE_CONSTRUCT创建新实例对象</li>
<li>OPCODE_CALLX执行实例对象的实例方法指令流（调用emitCreateInstance前已经将实例方法闭包defineMethod到类的method中）</li>
<li>OPCODE_RETURN返回实例对象。</li>
</ol> 
<h3>
<a id="291_OPCODE_CONSTRUCT_1169"></a>2.9.1 OPCODE_CONSTRUCT</h3> 
<pre><code class="prism language-c"><span class="token function">CASE</span><span class="token punctuation">(</span>CONSTRUCT<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token comment">//栈底: startStart[0]是class</span>

	 <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token function">VALUE_IS_CLASS</span><span class="token punctuation">(</span>stackStart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
	       <span class="token string">"stackStart[0] should be a class for OPCODE_CONSTRUCT!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token comment">//将创建的类实例存储到stackStart[0],即this</span>
	 ObjInstance<span class="token operator">*</span> objInstance <span class="token operator">=</span> <span class="token function">newObjInstance</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token function">VALUE_TO_CLASS</span><span class="token punctuation">(</span>stackStart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token comment">//此时stackStart[0]是类,其类名便是方法所定义的类</span>
	 <span class="token comment">//把对象写入stackStart[0]</span>
	 stackStart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">OBJ_TO_VALUE</span><span class="token punctuation">(</span>objInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>stackStart[0]是类，根据类调用newObjInstance创建了实例对象，放入stackStart[0]</p> 
<h3>
<a id="292_CALLx_1187"></a>2.9.2 CALLx</h3> 
<pre><code class="prism language-c"><span class="token function">CASE</span><span class="token punctuation">(</span>CALL0<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL1<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL2<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL3<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL4<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL5<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL6<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL7<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL8<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL9<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL10<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL11<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL12<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL13<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL14<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL15<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">CASE</span><span class="token punctuation">(</span>CALL16<span class="token punctuation">)</span><span class="token operator">:</span>
	 <span class="token comment">//指令流1: 2字节的method索引</span>
	 <span class="token comment">//因为还有个隐式的receiver(就是下面的args[0]), 所以参数个数+1.</span>
	 argNum <span class="token operator">=</span> opCode <span class="token operator">-</span> OPCODE_CALL0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

	 <span class="token comment">//读取2字节的数据(CALL指令的操作数),index是方法名的索引</span>
	 index <span class="token operator">=</span> <span class="token function">READ_SHORT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
	 <span class="token comment">//为参数指针数组args赋值</span>
	 args <span class="token operator">=</span> curThread<span class="token operator">-&gt;</span>esp <span class="token operator">-</span> argNum<span class="token punctuation">;</span>

	 <span class="token comment">//获得方法所在的类</span>
	 class <span class="token operator">=</span> <span class="token function">getClassOfObj</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">goto</span> invokeMethod<span class="token punctuation">;</span>
</code></pre> 
<p>如果当前 CALLx 调用的是类方法即static方法，那么args[0]是类，因此变量 class 便指向静态方法所属类的 Meta 类。<br> 如果当前调用的是实例方法，那么 args[0]是实例对象 this 变量， class 便是对象实例所属的类。<br> 所以这里会是第二种情况，由OPCODE_CONSTRUCT将对象放入args[0]，invokeMethod调用的是该类的methds的方法，也就是对象的实例方法。</p> 
<pre><code class="prism language-c">invokeMethod<span class="token operator">:</span>
	 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>index <span class="token operator">&gt;</span> class<span class="token operator">-&gt;</span>methods<span class="token punctuation">.</span>count <span class="token operator">||</span> 
	       <span class="token punctuation">(</span>method <span class="token operator">=</span> <span class="token operator">&amp;</span>class<span class="token operator">-&gt;</span>methods<span class="token punctuation">.</span>datas<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>type <span class="token operator">==</span> MT_NONE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token function">RUN_ERROR</span><span class="token punctuation">(</span><span class="token string">"method "%s" not found!"</span><span class="token punctuation">,</span> vm<span class="token operator">-&gt;</span>allMethodNames<span class="token punctuation">.</span>datas<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>

	 <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token keyword">case</span> MT_PRIMITIVE<span class="token operator">:</span>

	       <span class="token comment">//如果返回值为true,则vm进行空间回收的工作</span>
	       <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token operator">-&gt;</span><span class="token function">primFn</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		  <span class="token comment">//args[0]是返回值, argNum-1是保留args[0],</span>
		  <span class="token comment">//args[0]的空间最终由返回值的接收者即函数的主调方回收</span>
		  curThread<span class="token operator">-&gt;</span>esp <span class="token operator">-=</span> argNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> 
	       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> 
		  <span class="token comment">//如果返回false则说明有两种情况:</span>
		  <span class="token comment">//   1 出错(比如原生函数primThreadAbort使线程报错或无错退出),</span>
		  <span class="token comment">//   2 或者切换了线程,此时vm-&gt;curThread已经被切换为新的线程</span>
		  <span class="token comment">//保存线程的上下文环境,运行新线程之后还能回到当前老线程指令流的正确位置</span>
		  <span class="token function">STORE_CUR_FRAME</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">VALUE_IS_NULL</span><span class="token punctuation">(</span>curThread<span class="token operator">-&gt;</span>errorObj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">VALUE_IS_OBJSTR</span><span class="token punctuation">(</span>curThread<span class="token operator">-&gt;</span>errorObj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			ObjString<span class="token operator">*</span> err <span class="token operator">=</span> <span class="token function">VALUE_TO_OBJSTR</span><span class="token punctuation">(</span>curThread<span class="token operator">-&gt;</span>errorObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> err<span class="token operator">-&gt;</span>value<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
		     <span class="token punctuation">}</span>
		     <span class="token comment">//出错后将返回值置为null,避免主调方获取到错误的结果</span>
		     <span class="token function">PEEK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">VT_TO_VALUE</span><span class="token punctuation">(</span>VT_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
		  <span class="token punctuation">}</span>

		  <span class="token comment">//如果没有待执行的线程,说明执行完毕</span>
		  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token operator">-&gt;</span>curThread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		     <span class="token keyword">return</span> VM_RESULT_SUCCESS<span class="token punctuation">;</span>
		  <span class="token punctuation">}</span>

		  <span class="token comment">//vm-&gt;curThread已经由返回false的函数置为下一个线程</span>
		  <span class="token comment">//切换到下一个线程的上下文</span>
		  curThread <span class="token operator">=</span> vm<span class="token operator">-&gt;</span>curThread<span class="token punctuation">;</span>
		  <span class="token function">LOAD_CUR_FRAME</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>
	       <span class="token keyword">break</span><span class="token punctuation">;</span>

	    <span class="token keyword">case</span> MT_SCRIPT<span class="token operator">:</span>
	       <span class="token function">STORE_CUR_FRAME</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token function">createFrame</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> curThread<span class="token punctuation">,</span> <span class="token punctuation">(</span>ObjClosure<span class="token operator">*</span><span class="token punctuation">)</span>method<span class="token operator">-&gt;</span>obj<span class="token punctuation">,</span> argNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token function">LOAD_CUR_FRAME</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//加载最新的frame</span>
	       <span class="token keyword">break</span><span class="token punctuation">;</span>

	    <span class="token keyword">case</span> MT_FN_CALL<span class="token operator">:</span>
	       <span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token function">VALUE_IS_OBJCLOSURE</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"instance must be a closure!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       ObjFn<span class="token operator">*</span> objFn <span class="token operator">=</span> <span class="token function">VALUE_TO_OBJCLOSURE</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>fn<span class="token punctuation">;</span>
	       <span class="token comment">//-1是去掉实例this</span>
	       <span class="token keyword">if</span> <span class="token punctuation">(</span>argNum <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&lt;</span> objFn<span class="token operator">-&gt;</span>argNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		  <span class="token function">RUN_ERROR</span><span class="token punctuation">(</span><span class="token string">"arguments less"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>

	       <span class="token function">STORE_CUR_FRAME</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token function">createFrame</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> curThread<span class="token punctuation">,</span> <span class="token function">VALUE_TO_OBJCLOSURE</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> argNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token function">LOAD_CUR_FRAME</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//加载最新的frame</span>
	       <span class="token keyword">break</span><span class="token punctuation">;</span>

	    <span class="token keyword">default</span><span class="token operator">:</span>
	       <span class="token function">NOT_REACHED</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>

	 <span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3>
<a id="293__OPCODE_RETURN_1292"></a>2.9.3 OPCODE_RETURN</h3> 
<pre><code class="prism language-c"><span class="token function">CASE</span><span class="token punctuation">(</span>RETURN<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token comment">//栈顶: 返回值</span>

	 <span class="token comment">//获取返回值</span>
	 Value retVal <span class="token operator">=</span> <span class="token function">POP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    

	 <span class="token comment">//return是从函数返回 故该堆栈框架使用完毕,增加可用堆栈框架数量</span>
	 curThread<span class="token operator">-&gt;</span>usedFrameNum<span class="token operator">--</span><span class="token punctuation">;</span>
	 
	 <span class="token comment">//关闭堆栈框架即此作用域内所有upvalue</span>
	 <span class="token function">closeUpvalue</span><span class="token punctuation">(</span>curThread<span class="token punctuation">,</span> stackStart<span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token comment">//如果一个堆栈框架都没用,</span>
	 <span class="token comment">//说明它没有调用函数或者所有的函数调用都返回了,可以结束它</span>
	 <span class="token keyword">if</span> <span class="token punctuation">(</span>curThread<span class="token operator">-&gt;</span>usedFrameNum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token comment">//如果并不是被另一线程调用的,就直接结束</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>curThread<span class="token operator">-&gt;</span>caller <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	       curThread<span class="token operator">-&gt;</span>stack<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> retVal<span class="token punctuation">;</span>

	       <span class="token comment">//保留stack[0]中的结果,其它都丢弃</span>
	       curThread<span class="token operator">-&gt;</span>esp <span class="token operator">=</span> curThread<span class="token operator">-&gt;</span>stack <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	       <span class="token keyword">return</span> VM_RESULT_SUCCESS<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>

	    <span class="token comment">//恢复主调方线程的调度</span>
	    ObjThread<span class="token operator">*</span> callerThread <span class="token operator">=</span> curThread<span class="token operator">-&gt;</span>caller<span class="token punctuation">;</span>
	    curThread<span class="token operator">-&gt;</span>caller <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	    curThread <span class="token operator">=</span> callerThread<span class="token punctuation">;</span>
	    vm<span class="token operator">-&gt;</span>curThread <span class="token operator">=</span> callerThread<span class="token punctuation">;</span>

	    <span class="token comment">//在主调线程的栈顶存储被调线程的执行结果</span>
	    curThread<span class="token operator">-&gt;</span>esp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> retVal<span class="token punctuation">;</span>
	 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>   
	    <span class="token comment">//将返回值置于运行时栈栈顶</span>
	    stackStart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> retVal<span class="token punctuation">;</span>
	    <span class="token comment">//回收堆栈:保留除结果所在的slot即stackStart[0] 其它全丢弃</span>
	    curThread<span class="token operator">-&gt;</span>esp <span class="token operator">=</span> stackStart <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	 <span class="token punctuation">}</span>

	 <span class="token function">LOAD_CUR_FRAME</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">LOOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre> 
<h1>
<a id="3__1338"></a>3. 核心总结</h1> 
<p><strong>静态变量</strong>：被当作模块局部变量，<strong>声明</strong>于模块cu-&gt;LocalVar，<strong>定义即赋值</strong>于运行时栈（因为是局部变量）<br> <strong>实例变量</strong>：<strong>声明</strong>于模块cu指向的ClassBookKeep的fields里，声明实例对象时<strong>不能赋值</strong>。实例对象的值只属于实例对象，静态变量的值被所有对象共享。<br> <strong>静态方法</strong>：sign2String后<strong>声明</strong>于vm-&gt;allMethodNames，endCompileUnit(&amp;methodCU)创建闭包后<strong>赋值</strong>于类的元类的methods。<br> <strong>实例方法</strong>：sign2String后<strong>声明</strong>于vm-&gt;allMethodNames，endCompileUnit(&amp;methodCU)创建闭包后<strong>赋值</strong>于类的methods。<br> <strong>new方法</strong>：sign2String后<strong>声明</strong>于vm-&gt;allMethodNames，endCompileUnit(&amp;methodCU)创建闭包后<strong>赋值</strong>于类的methods。emitCreateInstance的三条指令单独创建编译单元并生成闭包赋值于元类的methods</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>