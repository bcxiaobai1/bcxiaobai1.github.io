<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Haproxy负载均衡群集 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Haproxy负载均衡群集</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    
                        
                    
                    <p></p> 
<div class="toc"> 
 <h4> </h4> 
 <ul>
<li><a href="#HAproxyWeb_1">HAproxy搭建Web群集</a></li>
<li>
<ul>
<li><a href="#Web_3">一、Web集群调度器</a></li>
<li>
<ul>
<li><a href="#1Web_5">1、常见的Web集群调度器</a></li>
<li><a href="#2LVS_NginxHaproxy_17">2、常用集群调度器的优缺点（LVS ,Nginx,Haproxy)</a></li>
<li>
<ul>
<li><a href="#21_Nginx_19">2.1 Nginx</a></li>
<li><a href="#22_LVS_53">2.2 LVS</a></li>
<li><a href="#23_Haproxy_75">2.3 Haproxy</a></li>
</ul> 
    </li>
<li><a href="#3font_colorredLVSNginxHAproxyfont_91">3、<font color="red">LVS、Nginx、HAproxy的区别</font></a></li>
</ul> 
   </li>
<li><a href="#Haproxy_103">二、Haproxy</a></li>
<li>
<ul>
<li><a href="#1_105">1、简介</a></li>
<li><a href="#2Haproxy_111">2、Haproxy应用分析</a></li>
<li><a href="#3HAProxy_123">3、HAProxy的主要特性</a></li>
<li><a href="#4Haproxy_140">4、Haproxy调度算法（负载均衡策略）</a></li>
<li><a href="#5Haproxy__153">5、Haproxy 的会话保持</a></li>
<li><a href="#6_159">6、支持的节点健康检查方式</a></li>
<li><a href="#7_167">7、支持的代理类型</a></li>
</ul> 
   </li>
<li><a href="#font_colorredHAproxy_font_176">三、<font color="red">HAproxy 服务器部署</font></a></li>
<li>
<ul>
<li><a href="#font_colorredHaproxyfont_178"><font color="red">Haproxy实现负载均衡、动静分离</font></a></li>
<li><a href="#1Haproxy_188">1、编译安装Haproxy</a></li>
<li><a href="#2Haproxy_215">2、修改Haproxy配置文件，配置前后端，分别处理动态资源和静态资源</a></li>
<li><a href="#3haproxy__376">3、添加haproxy 系统服务</a></li>
<li><a href="#4Tomcat_457">4、部署Tomcat并配置动态页面</a></li>
<li><a href="#5_511">5、部署节点服务器并配置静态页面</a></li>
<li><a href="#6_558">6、测试动态和静态页面</a></li>
<li><a href="#font_colorred_Keepalived__HAProxy_font_579"><font color="red">使用 Keepalived 实现 HAProxy 高可用</font></a></li>
<li><a href="#7keepalived_587">7、安装keepalived并编写配置文件</a></li>
<li><a href="#8_665">8、效果测试</a></li>
<li>
<ul>
<li><a href="#1_667">1）动静分离+负载均衡测试</a></li>
<li><a href="#2_687">2）高可用测试</a></li>
</ul> 
   </li>
</ul> 
   </li>
<li><a href="#_707">四、日志定义优化</a></li>
<li>
<ul>
<li><a href="#1haproxycfg_709">1、修改haproxy.cfg文件</a></li>
<li><a href="#2rsyslog_728">2、rsyslog配置</a></li>
<li><a href="#3_760">3、访问测试</a></li>
</ul> 
  </li>
</ul> 
 </li>
</ul> 
</div> 
<p></p> 
<h2>
<a id="HAproxyWeb_1"></a>HAproxy搭建Web群集</h2> 
<h3>
<a id="Web_3"></a>一、Web集群调度器</h3> 
<h4>
<a id="1Web_5"></a>1、常见的Web集群调度器</h4> 
<ul>
<li> <p>目前常见的Web集群调度器分为<font color="orange">软件和硬件</font></p> </li>
<li> <p>软件通常使用开源的LVS、Haproxy、Nginx</p> <pre><code class="prism language-bash">LVS 性能最好，但是搭建相对复杂<span class="token punctuation">;</span>Nginx的upstream模块支持群集功能，但是对群集节点健康检查功能不强，高并发性能没有 Haproxy好。
</code></pre> </li>
<li> <p>硬件一般使用比较多的是F5、Array，也有很多人使用国内的一些产品，如梭子鱼、绿盟等</p> </li>
</ul> 
<h4>
<a id="2LVS_NginxHaproxy_17"></a>2、常用集群调度器的优缺点（LVS ,Nginx,Haproxy)</h4> 
<h5>
<a id="21_Nginx_19"></a>2.1 Nginx</h5> 
<pre><code>优点
</code></pre> 
<p>1）工作在网络的7层之上，可以针对http应用做一些分流的策略，比如针对域名、目录结构。Nginx正则规则比HAProxy更为强大和灵活；</p> 
<p>2）Nginx对网络稳定性的依赖非常小，理论上能ping通就就能进行负载功能，LVS对网络稳定性依赖比较大，稳定要求相对更高；</p> 
<p>3）Nginx安装和配置、测试比较简单、方便，有清晰的日志用于排查和管理，LVS的配置、测试就要花比较长的时间了；</p> 
<p>4）可以承担高负载压力且稳定，一般能支撑几万次的并发量，负载度比LVS相对小些；</p> 
<p>5）Nginx可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等；</p> 
<p>6）Nginx不仅仅是一款优秀的负载均衡器/反向代理软件，它同时也是功能强大的Web应用服务器；</p> 
<p>7）Nginx作为Web正向加速缓存越来越成熟了，速度比传统的Squid服务器更快，很多场景下都将其作反</p> 
<p>向代理加速器；</p> 
<p>8）Nginx作为静态网页和图片服务器，这方面的性能非常优秀，同时第三方模块也很多。</p> 
<pre><code>缺点
</code></pre> 
<p>1）Nginx仅能支持http、https和Email协议，这样就在适用范围上面小些；</p> 
<p>2）对后端服务器的健康检查，只支持通过端口来检测，不支持通过url来检测；</p> 
<p>3）不支持Session的直接保持，需要通过ip_hash和cookie的引导来解决。</p> 
<h5>
<a id="22_LVS_53"></a>2.2 LVS</h5> 
<pre><code>优点
</code></pre> 
<p>1）抗负载能力强、是工作在网络4层之上仅作分发之用，没有流量的产生。因此负载均衡软件里的性能最强的，对内存和cpu资源消耗比较低；</p> 
<p>2）LVS工作稳定，因为其本身抗负载能力很强，自身有完整的双机热备方案；</p> 
<p>3）无流量，LVS只分发请求，而流量并不从它本身出去，这点保证了均衡器IO的性能不会收到大流量的影响；</p> 
<p>4）应用范围较广，因为LVS工作在4层，所以它几乎可对所有应用做负载均衡，包括http、数据库等。</p> 
<pre><code>缺点
</code></pre> 
<p>1）软件本身不支持正则表达式处理，不能做动静分离。相对来说，Nginx/HAProxy+Keepalived则具有明显的优势；</p> 
<p>2）如果是网站应用比较庞大的话，LVS/DR+Keepalived实施起来就比较复杂了。相对来说，Nginx/HAProxy+Keepalived就简单多了。</p> 
<h5>
<a id="23_Haproxy_75"></a>2.3 Haproxy</h5> 
<pre><code>优点
</code></pre> 
<p>1）Haproxy也是支持虚拟主机的；</p> 
<p>2）Haproxy支持8种负载均衡策略；</p> 
<p>3）Haproxy的优点能够补充Nginx的一些缺点，比如支持Session的保持，Cookie的引导，同时支持通过获取指定的url来检测后端服务器的状态；</p> 
<p>4）Haproxy跟LVS类似，本身就只是一款负载均衡软件，单纯从效率上来讲HAProxy会比Nginx有更出色的负载均衡速度，在并发处理上也是优于Nginx的；</p> 
<p>5）Haproxy支持TCP协议的负载均衡转发。</p> 
<h4>
<a id="3font_colorredLVSNginxHAproxyfont_91"></a>3、<font color="red">LVS、Nginx、HAproxy的区别</font>
</h4> 
<p>1）LVS基于Linux操作系统内核实现软负载均衡，而HAProxy和Nginx是基于第三方应用实现的软负载均衡；</p> 
<p>2）LVS是可实现4层的IP负载均衡技术，无法实现基于目录、URL的转发。而HAProxy和Nginx都可以实现4层和7层技术，HAProxy可提供TCP和HTTP应用的负载均衡综合解决方案；</p> 
<p>3）LVS因为工作在ISO模型的第四层，其状态监测功能单一，而HAProxy在状态监测方面功能更丰富、强大，可支持端口、URL、脚本等多种状态检测方式；</p> 
<p>4）HAProxy功能强大，单纯从效率上来讲HAProxy会比Nginx有更出色的负载均衡速度，在并发处理上也是优于Nginx的。但整体性能低于4层模式的LVS负载均衡；</p> 
<p>5）Nginx主要用于Web服务器或缓存服务器。Nginx的upstream模块虽然也支持群集功能，但是性能没有LVS和Haproxy好，对群集节点健康检查功能不强，只支持通过端口来检测，不支持通过URL来检测。</p> 
<h3>
<a id="Haproxy_103"></a>二、Haproxy</h3> 
<h4>
<a id="1_105"></a>1、简介</h4> 
<p><font color="orange">HAProxy是可提供高可用性、负载均衡以及基于TCP和HTTP应用的代理</font>，是免费、快速并且可靠的一种解决方案。</p> 
<p><font color="orange">HAProxy非常适用于并发大（并发达1w以上）web站点</font>，这些站点通常又需要会话保持或七层处理。HAProxy的运行模式使得它可以很简单安全的整合至当前的架构中，同时可以保护web服务器不被暴露到网络上。</p> 
<h4>
<a id="2Haproxy_111"></a>2、Haproxy应用分析</h4> 
<p>（1）LVS在企业应用中抗负载能力很强，但存在不足</p> 
<ul>
<li><font color="red">LVS不支持正则处理，不能实现动静分离</font></li>
<li>对于大型网站，LVS的实施配置复杂，维护成本相对较高</li>
</ul> 
<p>（2）Haproxy是一款可提供高可用性、负载均衡、及基于TCP和HTTP应用的代理的 软件</p> 
<ul>
<li>适用于负载大的Web站点</li>
<li>运行在硬件上可支持数以万计的并发连接的连接请求</li>
</ul> 
<h4>
<a id="3HAProxy_123"></a>3、HAProxy的主要特性</h4> 
<pre><code class="prism language-bash">●可靠性和稳定性非常好，可以与硬件级的F5负载均衡设备相媲美；
●最高可以同时维护40000-50000个并发连接，单位时间内处理的最大请求数为20000个，最大处理能力可达10Git/s；
●支持多达8种负载均衡算法
●支持Session会话保持，Cookie的引导；
●支持通过获取指定的url来检测后端服务器的状态；
●支持虚机主机功能，从而实现web负载均衡更加灵活；
●支持连接拒绝、全透明代理等独特的功能；
●拥有强大的ACL支持，用于访问控制；
●支持TCP和HTTP协议的负载均衡转发；
●支持客户端的keepalive功能，减少客户端与haproxy的多次三次握手导致资源浪费，让多个请求在一个tcp连接中完成
</code></pre> 
<h4>
<a id="4Haproxy_140"></a>4、Haproxy调度算法（负载均衡策略）</h4> 
<table>
<thead><tr>
<th>Haproxy常用的调度算法</th>
<th>调度依据</th>
</tr></thead>
<tbody>
<tr>
<td>roundrobin</td>
<td>
<font color="cornflowerblue">轮询</font>，表示简单的轮询</td>
</tr>
<tr>
<td>static-rr</td>
<td>
<font color="cornflowerblue">加权轮询</font>，表示根据权重轮询</td>
</tr>
<tr>
<td>leastconn</td>
<td>
<font color="cornflowerblue">最小连接</font>，表示最少连接者先处理</td>
</tr>
<tr>
<td>source</td>
<td>
<font color="cornflowerblue">源地址哈希</font>，表示根据请求源ip</td>
</tr>
<tr>
<td>uri</td>
<td>
<font color="cornflowerblue">URI哈希</font>，表示根据请求的URI，做cdn需使用</td>
</tr>
<tr>
<td>url_param</td>
<td>
<font color="cornflowerblue">URL参数哈希</font>，表示根据请求的URL参数’balance url_param’ requires an URL parameter name</td>
</tr>
<tr>
<td>hdr(name)</td>
<td><font color="cornflowerblue">请求头哈希</font></td>
</tr>
<tr>
<td>rdp-cookie(name)</td>
<td>
<font color="cornflowerblue">cookie的key哈希</font>，表示根据cookie(name)来锁定并哈希每一次TCP请求</td>
</tr>
</tbody>
</table> 
<h4>
<a id="5Haproxy__153"></a>5、Haproxy 的会话保持</h4> 
<p>1）源地址hash<br> 2）设置cookie<br> 3）会话粘性表stick-table</p> 
<h4>
<a id="6_159"></a>6、支持的节点健康检查方式</h4> 
<pre><code class="prism language-bash">LVS可以配合keepalived实现支持对TCP端口和URL路径方式的健康检查
Nginx默认情况下只支持被动健康检查，主动健康检查模块需要依赖第三方模块
Haproxy支持TCP端口、URL路径、脚本等方式的健康检查
</code></pre> 
<h4>
<a id="7_167"></a>7、支持的代理类型</h4> 
<pre><code class="prism language-bash">LVS基于Linux系统内核实现的软负载均衡，只支持4层代理的IP转发，不支持正则匹配
Haproxy和Nginx基于应用程序实现的软负载均衡，都能支持4层和7层代理转发，支持正则匹配
</code></pre> 
<h3>
<a id="font_colorredHAproxy_font_176"></a>三、<font color="red">HAproxy 服务器部署</font>
</h3> 
<h4>
<a id="font_colorredHaproxyfont_178"></a><font color="red">Haproxy实现负载均衡、动静分离</font>
</h4> 
<pre><code class="prism language-bash">HAproxy <span class="token number">7</span>-1<span class="token punctuation">(</span><span class="token number">192.168</span>.210.101<span class="token punctuation">)</span>
Web1 <span class="token number">7</span>-2<span class="token punctuation">(</span><span class="token number">192.168</span>.210.102<span class="token punctuation">)</span>
Web2 <span class="token number">7</span>-4<span class="token punctuation">(</span><span class="token number">192.168</span>.210.104<span class="token punctuation">)</span>
Tomcat1 <span class="token number">7</span>-5<span class="token punctuation">(</span><span class="token number">192.168</span>.210.105<span class="token punctuation">)</span>
Tomcat2 <span class="token number">7</span>-6<span class="token punctuation">(</span><span class="token number">192.168</span>.210.106<span class="token punctuation">)</span>
</code></pre> 
<h4>
<a id="1Haproxy_188"></a>1、编译安装Haproxy</h4> 
<pre><code class="prism language-bash"><span class="token number">7</span>-1
systemctl stop firewalld
setenforce <span class="token number">0</span>
<span class="token comment">#关闭防火墙</span>
<span class="token builtin class-name">cd</span> /opt
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> pcre-devel zlip-devel openssl-devel systemd-devel
<span class="token comment">#安装依赖包</span>
<span class="token function">tar</span> zxvf haproxy-2.8.3.tar.gz
<span class="token comment">#解压</span>
<span class="token builtin class-name">cd</span> haproxy-2.8.3/
<span class="token comment">#切换到haproxy-2.8.3目录</span>
<span class="token function">make</span> <span class="token assign-left variable">TARGET</span><span class="token operator">=</span>linux31 <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/haproxy 
<span class="token function">make</span> <span class="token function">install</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/haproxy
<span class="token comment">#编译</span>

<span class="token function">useradd</span> <span class="token parameter variable">-M</span> <span class="token parameter variable">-s</span> /sbin/nologin haproxy
<span class="token comment">#新建管理用户</span>

<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /usr/local/haproxy/conf
<span class="token comment">#创建conf目录</span>
<span class="token builtin class-name">cd</span> /usr/local/haproxy/conf
<span class="token comment">#在conf目录下配置haproxy.cfg文件</span>
</code></pre> 
<h4>
<a id="2Haproxy_215"></a>2、修改Haproxy配置文件，配置前后端，分别处理动态资源和静态资源</h4> 
<pre><code>释义版
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">vim</span> haproxy.cfg
global		<span class="token comment">#全局配置，主要用于定义全局参数，属于进程级的配置，通常和操作系统配置有关</span>
    <span class="token comment">#将info（及以上）的日志发送到rsyslog的local0接口，将warning（及以上）的日志发送到rsyslog的local1接口</span>
    log <span class="token number">127.0</span>.0.1 local0 info
    log <span class="token number">127.0</span>.0.1 local1 warning	
	
    maxconn <span class="token number">30000</span>			            <span class="token comment">#最大连接数，HAProxy 要求系统的 ulimit -n 参数大于 maxconn*2+18</span>

    <span class="token comment">#chroot /var/lib/haproxy            #修改haproxy工作目录至指定目录，一般需将此行注释掉</span>
    pidfile     /var/run/haproxy.pid    <span class="token comment">#指定保存HAProxy进程号的文件</span>
    user haproxy            <span class="token comment">#以指定的用户名身份运行haproxy进程</span>
    group haproxy           <span class="token comment">#以指定的组名运行haproxy，以免因权限问题带来风险</span>
    daemon					<span class="token comment">#让haproxy以守护进程的方式工作于后台</span>
    <span class="token comment">#nbproc 1				#指定启动的haproxy进程个数，只能用于守护进程模式的haproxy，默认只启动一个进程。haproxy是单进程、事件驱动模型的软件，单进程下工作效率已经非常好，不建议开启多进程</span>
    spread-checks <span class="token number">2</span>         <span class="token comment">#在haproxy后端有着众多服务器的场景中，在精确的时间间隔后统一对众服务器进行健康状况检查可能会带来意外问题；此选项用于将其检查的时间间隔长度上增加或减小一定的随机时长；默认为0，官方建议设置为2到5之间。</span>

defaults   	<span class="token comment">#配置默认参数，这些参数可以被用到listen，frontend，backend组件     </span>
    log     global			<span class="token comment">#所有前端都默认使用global中的日志配置</span>
    mode    http			<span class="token comment">#模式为http（7层代理http，4层代理tcp）</span>
    option  http-keep-alive <span class="token comment">#使用keepAlive连接，后端为静态建议使用http-keep-alive，后端为动态应用程序建议使用http-server-close</span>
    option  forwardfor      <span class="token comment">#记录客户端IP在X-Forwarded-For头域中，haproxy将在发往后端的请求中加上"X-Forwarded-For"首部字段</span>
    option  httplog			<span class="token comment">#开启httplog，在日志中记录http请求、session信息等。http模式时开启httplog，tcp模式时开启tcplog</span>
    option  dontlognull		<span class="token comment">#不在日志中记录空连接</span>
    option  redispatch		<span class="token comment">#当某后端down掉使得haproxy无法转发携带cookie的请求到该后端时，将其转发到别的后端上</span>
    option  abortonclose    <span class="token comment">#当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接</span>
    maxconn <span class="token number">20000</span>			<span class="token comment">#最大连接数，“defaults”中的值不能超过“global”段中的定义</span>
    retries <span class="token number">3</span>               <span class="token comment">#定义连接后端服务器的失败重连次数，连接失败次数超过此值后会将对应后端服务器标记为不可用</span>
    <span class="token comment">#contimeout 5000        #设置连接超时时间，默认单位是毫秒</span>
    <span class="token comment">#clitimeout 50000       #设置客户端超时时间，默认单位是毫秒</span>
    <span class="token comment">#srvtimeout 50000       #设置服务器超时时间，默认单位是毫秒</span>
    <span class="token function">timeout</span> http-request 2s 	<span class="token comment">#默认http请求超时时间，此为等待客户端发送完整请求的最大时长，用于避免类DoS攻击。haproxy总是要求一次请求或响应全部发送完成后才会处理、转发</span>
    <span class="token function">timeout</span> queue 3s   	    <span class="token comment">#默认客户端请求在队列中的最大时长</span>
    <span class="token function">timeout</span> connect 1s		<span class="token comment">#默认haproxy和服务端建立连接的最大时长，新版本中替代contimeout，该参数向后兼容</span>
    <span class="token function">timeout</span> client 10s		<span class="token comment">#默认和客户端保持空闲连接的超时时长，在高并发下可稍微短一点，可设置为10秒以尽快释放连接，新版本中替代clitimeout</span>
    <span class="token function">timeout</span> server 2s		<span class="token comment">#默认和服务端保持空闲连接的超时时长，局域网内建立连接很快，所以尽量设置短一些，特别是高并发时，新版本中替代srvtimeout</span>
    <span class="token function">timeout</span> http-keep-alive 10s		<span class="token comment">#默认和客户端保持长连接的最大时长。优先级高于timeout http-request 也高于timeout client</span>
    <span class="token function">timeout</span> check 2s		<span class="token comment">#和后端服务器成功建立连接后到最终完成检查的最大时长(不包括建立连接的时间，只是读取到检查结果的时长)</span>

frontend http-in    <span class="token comment">#定义前端域</span>
    <span class="token builtin class-name">bind</span> *:80                        <span class="token comment">#设置监听地址和端口，指定为*或0.0.0.0时，将监听当前系统的所有IPv4地址</span>
    maxconn <span class="token number">18000</span>                    <span class="token comment">#定义此端口上的maxconn</span>
	
    acl url_static1   path_beg  <span class="token parameter variable">-i</span> /static /images                          <span class="token comment">#定义ACL，当uri以定义的路径开头时，ACL[url_static1]为true</span>
    acl url_static2   path_end  <span class="token parameter variable">-i</span> .jpg .jpeg .gif .png .html .htm .txt     <span class="token comment">#定义ACL，当uri以定义的路径结尾时，ACL[url_static2]为true</span>

    use_backend ms1 <span class="token keyword">if</span> url_static1       <span class="token comment">#当[url_static1]为true时，定向到后端域ms1中</span>
    use_backend ms2 <span class="token keyword">if</span> url_static2       <span class="token comment">#当[url_static2]为true时，定向到后端域ms2中</span>
    default_backend dynamic_group        <span class="token comment">#其他情况时，定向到后端域dynamic_group中</span>

backend ms1    <span class="token comment">#定义后端域ms1</span>
    balance            roundrobin        <span class="token comment">#使用轮询算法</span>
    option httpchk     GET /test.html   <span class="token comment">#表示基于http协议来做健康状况检查，只有返回状态码为2xx或3xx的才认为是健康的，其余所有状态码都认为不健康。不设置该选项时，默认采用tcp做健康检查，只要能建立tcp就表示健康。</span>
    server ms1.inst1 <span class="token number">192.168</span>.80.100:80 maxconn <span class="token number">5000</span> check inter <span class="token number">2000</span> rise <span class="token number">2</span> fall <span class="token number">3</span>
    server ms1.inst2 <span class="token number">192.168</span>.80.100:81 maxconn <span class="token number">5000</span> check        <span class="token comment">#同上，inter 2000 rise 2 fall 3是默认值，可以省略</span>

backend ms2    <span class="token comment">#定义后端域ms2</span>
    balance roundrobin
    option httpchk     GET /test.html
    server ms2.inst1 <span class="token number">192.168</span>.80.101:80 maxconn <span class="token number">5000</span> check
    server ms2.inst2 <span class="token number">192.168</span>.80.101:81 maxconn <span class="token number">5000</span> check

backend dynamic_group    <span class="token comment">#定义后端域dynamic_group</span>
    balance roundrobin
    option http-server-close
    cookie HA_STICKY_dy insert indirect nocache    
    server appsrv1 <span class="token number">192.168</span>.80.100:8080 cookie appsrv1 maxconn <span class="token number">5000</span> check
    server appsrv2 <span class="token number">192.168</span>.80.101:8080 cookie appsrv2 maxconn <span class="token number">5000</span> check

listen stats    <span class="token comment">#定义监控页面</span>
    <span class="token builtin class-name">bind</span> *:1080                   <span class="token comment">#绑定端口1080</span>
    stats <span class="token builtin class-name">enable</span>                  <span class="token comment">#启用统计报告监控</span>
    stats refresh 30s             <span class="token comment">#每30秒更新监控数据</span>
    stats uri /stats              <span class="token comment">#访问监控页面的uri</span>
    stats realm HAProxy<span class="token punctuation"></span> Stats    <span class="token comment">#监控页面的认证提示</span>
    stats auth admin:admin        <span class="token comment">#监控页面的用户名和密码</span>
</code></pre> 
<pre><code>无释义版
</code></pre> 
<pre><code class="prism language-bash"><span class="token comment">#配置文件</span>
<span class="token function">vim</span> haproxy.cfg

global		
    log <span class="token number">127.0</span>.0.1 local0 info
    log <span class="token number">127.0</span>.0.1 local1 warning	
	
    maxconn <span class="token number">30000</span>


    pidfile     /var/run/haproxy.pid
    user haproxy
    group haproxy
    daemon
    spread-checks <span class="token number">2</span>
    
defaults   
    log     global
    mode    http <span class="token comment">#七层代理</span>
    option  http-keep-alive
    option  forwardfor
    option  httplog
    option  dontlognull
    option  redispatch
    option  abortonclose
    maxconn <span class="token number">20000</span>
    retries <span class="token number">3</span>
    <span class="token function">timeout</span> http-request 2s
    <span class="token function">timeout</span> queue 3s
    <span class="token function">timeout</span> connect 1s
    <span class="token function">timeout</span> client 10s
    <span class="token function">timeout</span> server 2s
    <span class="token function">timeout</span> http-keep-alive 10s
    <span class="token function">timeout</span> check 2s

<span class="token comment">#前端配置，根据用户的访问请求，跳转到对应的后端？</span>
frontend http-in 
    <span class="token comment">#监听地址 </span>
    <span class="token builtin class-name">bind</span> *:80
    acl dynamic   path_end  <span class="token parameter variable">-i</span> .jsp
    use_backend tomcat_server <span class="token keyword">if</span> dynamic

    <span class="token comment">#都没匹配到，跳转到默认</span>
    default_backend nginx_servers

backend tomcat_server
    balance roundrobin
    option http-server-close
    cookie HA_STICKY_dy insert indirect nocache
    server tomcat1 <span class="token number">192.168</span>.210.105:8080 cookie tomcat1 inter <span class="token number">2000</span> rise <span class="token number">2</span> fall <span class="token number">3</span>
    server tomcat2 <span class="token number">192.168</span>.210.106:8080 cookie tomcat2 check
    

backend nginx_servers
    balance roundrobin
    <span class="token comment">#节点服务器根目录下要有此文件</span>
    option httpchk     GET /test.html     
    server nginx1 <span class="token number">192.168</span>.210.102:80 check inter <span class="token number">2000</span> rise <span class="token number">2</span> fall <span class="token number">3</span>
    server nginx2 <span class="token number">192.168</span>.210.104:80 check inter <span class="token number">2000</span> rise <span class="token number">2</span> fall <span class="token number">3</span>

listen stats
    <span class="token builtin class-name">bind</span> *:1080
    stats <span class="token builtin class-name">enable</span>
    stats refresh 30s
    stats uri /stats
    stats realm HAProxy<span class="token punctuation"></span> Stats
    stats auth admin:admin

</code></pre> 
<h4>
<a id="3haproxy__376"></a>3、添加haproxy 系统服务</h4> 
<pre><code class="prism language-bash"><span class="token function">vim</span> /etc/init.d/haproxy
<span class="token comment">#!/bin/bash</span>
<span class="token comment">#chkconfig: 2345 90 30</span>
<span class="token comment">#description: Haproxy Service Control Script</span>

<span class="token assign-left variable">PROGDIR</span><span class="token operator">=</span>/usr/local/haproxy
<span class="token assign-left variable">PROGNAME</span><span class="token operator">=</span>haproxy
<span class="token assign-left variable">DAEMON</span><span class="token operator">=</span><span class="token variable">$PROGDIR</span>/sbin/<span class="token variable">$PROGNAME</span>
<span class="token assign-left variable">CONFIG</span><span class="token operator">=</span><span class="token variable">$PROGDIR</span>/conf/<span class="token variable">$PROGNAME</span>.cfg
<span class="token assign-left variable">PIDFILE</span><span class="token operator">=</span>/var/run/<span class="token variable">$PROGNAME</span>.pid
<span class="token assign-left variable">DESC</span><span class="token operator">=</span><span class="token string">"HAProxy daemon"</span>
<span class="token assign-left variable">SCRIPTNAME</span><span class="token operator">=</span>/etc/init.d/<span class="token variable">$PROGNAME</span>

<span class="token comment"># Gracefully exit if the package has been removed.</span>
<span class="token builtin class-name">test</span> <span class="token parameter variable">-x</span> <span class="token variable">$DAEMON</span> <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span>

<span class="token function-name function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"Starting <span class="token variable">$DESC</span>: <span class="token variable">$PROGNAME</span><span class="token entity" title="n">n</span>"</span>
    <span class="token variable">$DAEMON</span> <span class="token parameter variable">-f</span> <span class="token variable">$CONFIG</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"......"</span>
<span class="token punctuation">}</span>

<span class="token function-name function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"Stopping <span class="token variable">$DESC</span>: <span class="token variable">$PROGNAME</span><span class="token entity" title="n">n</span>"</span>
    <span class="token assign-left variable">haproxy_pid</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $PIDFILE<span class="token variable">)</span></span>"</span>
    <span class="token function">kill</span> <span class="token variable">$haproxy_pid</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"......"</span>
<span class="token punctuation">}</span>

<span class="token function-name function">restart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"Restarting <span class="token variable">$DESC</span>: <span class="token variable">$PROGNAME</span><span class="token entity" title="n">n</span>"</span>
    <span class="token variable">$DAEMON</span> <span class="token parameter variable">-f</span> <span class="token variable">$CONFIG</span> <span class="token parameter variable">-p</span> <span class="token variable">$PIDFILE</span> <span class="token parameter variable">-sf</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $PIDFILE<span class="token variable">)</span></span>
    <span class="token builtin class-name">echo</span> <span class="token string">"......"</span>
<span class="token punctuation">}</span>

<span class="token keyword">case</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token keyword">in</span>
start<span class="token punctuation">)</span>
   start
   <span class="token punctuation">;</span><span class="token punctuation">;</span>
   
stop<span class="token punctuation">)</span>
   stop
   <span class="token punctuation">;</span><span class="token punctuation">;</span>
   
restart<span class="token punctuation">)</span>
    restart
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
	
*<span class="token punctuation">)</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Usage: <span class="token variable">$SCRIPTNAME</span> {start|stop|restart}"</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span>

<span class="token builtin class-name">exit</span> <span class="token number">0</span>


<span class="token builtin class-name">cd</span> /etc/init.d/
<span class="token function">chmod</span> +x haproxy
<span class="token function">chkconfig</span> <span class="token parameter variable">--add</span> /etc/init.d/haproxy
<span class="token comment">#加入系统服务管理</span>

<span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/haproxy/sbin/haproxy /usr/sbin/haproxy
<span class="token function">service</span> haproxy start	或	/etc/init.d/haproxy start
<span class="token comment">#启动</span>

<span class="token comment">#补充知识</span>
<span class="token function">chkconfig</span> <span class="token parameter variable">--list</span> haproxy 
<span class="token function">chkconfig</span> <span class="token parameter variable">--level</span> <span class="token number">35</span> haproxy on 
<span class="token comment">#设置35级别</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0b/e1/GSVonOeD_o.png" alt="在这里插入图片描述"></p> 
<h4>
<a id="4Tomcat_457"></a>4、部署Tomcat并配置动态页面</h4> 
<pre><code class="prism language-bash"><span class="token number">7</span>-5 （tomcat1）
<span class="token builtin class-name">cd</span> /opt
<span class="token function">tar</span> xf apache-tomcat-9.0.16.tar.gz
<span class="token function">mv</span> apache-tomcat-9.0.16 /usr/local/tomcat
<span class="token function">mkdir</span> /usr/local/tomcat/webapps/test
<span class="token function">vim</span> /usr/local/tomcat/webapps/test/index.jsp
<span class="token operator">&lt;</span>%@ page <span class="token assign-left variable">language</span><span class="token operator">=</span><span class="token string">"java"</span> <span class="token assign-left variable">import</span><span class="token operator">=</span><span class="token string">"java.util.*"</span> <span class="token assign-left variable">pageEncoding</span><span class="token operator">=</span><span class="token string">"UTF-8"</span>%<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>JSP test1 page<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>   
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>% out.println<span class="token punctuation">(</span><span class="token string">"动态页面 1,古娜拉黑暗之神，呜呼拉呼，黑魔变身"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>%<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
/usr/local/tomcat/bin/startup.sh
<span class="token comment">#启动</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c7/1c/hr1jIah7_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash"><span class="token number">7</span>-6 （tomcat2）
<span class="token function">mkdir</span> /usr/local/tomcat/webapps/test
<span class="token function">vim</span> /usr/local/tomcat/webapps/test/index.jsp
<span class="token operator">&lt;</span>%@ page <span class="token assign-left variable">language</span><span class="token operator">=</span><span class="token string">"java"</span> <span class="token assign-left variable">import</span><span class="token operator">=</span><span class="token string">"java.util.*"</span> <span class="token assign-left variable">pageEncoding</span><span class="token operator">=</span><span class="token string">"UTF-8"</span>%<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>JSP test2 page<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>   
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>% out.println<span class="token punctuation">(</span><span class="token string">"动态页面2,巴啦啦能量，呼尼拉，魔仙变身"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>%<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
/usr/local/tomcat/bin/startup.sh
<span class="token comment">#启动</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d2/d4/240e61Jl_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash">测试动态页面
<span class="token number">192.168</span>.210.105:8080/test/index.jsp
<span class="token number">192.168</span>.210.106:8080/test/index.jsp
</code></pre> 
<p><img src="https://images2.imgbox.com/08/f6/MDk0t7Ji_o.png" alt="在这里插入图片描述"></p> 
<h4>
<a id="5_511"></a>5、部署节点服务器并配置静态页面</h4> 
<pre><code class="prism language-bash"><span class="token number">7</span>-2，7-4
<span class="token builtin class-name">cd</span> /etc/yum.repos.d/
<span class="token function">mkdir</span> bak
<span class="token function">mv</span> *.repo bak
<span class="token function">vim</span> nginx.repo

<span class="token punctuation">[</span>nginx<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>nginx repo
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://nginx.org/packages/centos/<span class="token variable">$releasever</span>/<span class="token variable">$basearch</span>/
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://nginx.org/keys/nginx_signing.key
<span class="token assign-left variable">module_hotfixes</span><span class="token operator">=</span>true

yum <span class="token function">install</span> nginx <span class="token parameter variable">-y</span>
<span class="token comment">#yum安装nginx</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token number">7</span>-2
<span class="token builtin class-name">cd</span> /usr/share/nginx/html
<span class="token function">vim</span> test.html
this is test1 web page<span class="token operator">!</span>

<span class="token number">7</span>-4
<span class="token builtin class-name">cd</span> /usr/share/nginx/html
<span class="token function">vim</span> test.html
this is test2 web page<span class="token operator">!</span>

sysetmctl start nginx
<span class="token comment">#启动服务</span>
</code></pre> 
<pre><code class="prism language-bash">测试效果
<span class="token number">192.168</span>.210.102/test.html
<span class="token number">192.168</span>.210.104/test.html
</code></pre> 
<p><img src="https://images2.imgbox.com/b6/f8/rk4rQKcS_o.png" alt="在这里插入图片描述"></p> 
<h4>
<a id="6_558"></a>6、测试动态和静态页面</h4> 
<pre><code class="prism language-bash"><span class="token number">192.168</span>.210.101/test.html
<span class="token comment">#访问静态页面</span>
</code></pre> 
<p></p> 
<div class="csdn-video-box"> 
  
 <p>20230921_151201</p> 
</div> 
<p></p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token number">192.168</span>.210.101/test/index.jsp
<span class="token comment">#访问动态页面，多次访问</span>
<span class="token comment">#实现负载均衡和动静分离</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3a/7d/0vfgehZ7_o.png" alt="在这里插入图片描述"></p> 
<h4>
<a id="font_colorred_Keepalived__HAProxy_font_579"></a><font color="red">使用 Keepalived 实现 HAProxy 高可用</font>
</h4> 
<pre><code class="prism language-bash">在Haproxy搭建web群集的基础上加一台Haproxy服务器
HAproxy-Master <span class="token number">7</span>-1<span class="token punctuation">(</span><span class="token number">192.168</span>.210.101<span class="token punctuation">)</span>
HAproxy-BACKUP <span class="token number">7</span>-3<span class="token punctuation">(</span><span class="token number">192.168</span>.210.103<span class="token punctuation">)</span>
</code></pre> 
<h4>
<a id="7keepalived_587"></a>7、安装keepalived并编写配置文件</h4> 
<pre><code class="prism language-bash"><span class="token comment">#7-1和7-3都要安装keepalived</span>
yum <span class="token function">install</span> keepalived <span class="token parameter variable">-y</span>
<span class="token number">7</span>-3要编译安装haproxy，可参考7-1安装的步骤，这里不再演示
</code></pre> 
<pre><code class="prism language-bash"><span class="token number">7</span>-1，7-3
<span class="token function">vim</span> /etc/keepalived/check_haproxy.sh
<span class="token comment">#!/bin/bash</span>
<span class="token comment">#使用killall -0检查haproxy实例是否存在，性能高于ps命令</span>
<span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">killall</span> <span class="token parameter variable">-0</span> haproxy<span class="token punctuation">;</span> <span class="token keyword">then</span>
  systemctl stop keepalived
<span class="token keyword">fi</span>

<span class="token function">chmod</span> +x /etc/keepalived/check_haproxy.sh
</code></pre> 
<p><img src="https://images2.imgbox.com/12/3e/r1dq5hhg_o.png" alt="在这里插入图片描述"></p> 
<pre><code>主服务器
</code></pre> 
<pre><code class="prism language-bash"><span class="token number">7</span>-1
<span class="token function">vim</span> /etc/keepalived/keepalived.conf
<span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived
global_defs <span class="token punctuation">{<!-- --></span>
    router_id LVS_HA1    <span class="token comment">#虚拟路由名称</span>
<span class="token punctuation">}</span>

<span class="token comment">#HAProxy健康检查配置</span>
vrrp_script chk_haproxy <span class="token punctuation">{<!-- --></span>
    script <span class="token string">"/etc/keepalived/check_haproxy.sh"</span>    <span class="token comment">#指定健康检查脚本</span>
    interval <span class="token number">2</span>                                   <span class="token comment">#脚本运行周期</span>
    weight <span class="token number">2</span>                                     <span class="token comment">#每次检查的加权权重值</span>
<span class="token punctuation">}</span>

<span class="token comment">#虚拟路由配置</span>
vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span>
    state MASTER              <span class="token comment">#本机实例状态，MASTER/BACKUP，备机配置文件中设置BACKUP</span>
    interface ens33           <span class="token comment">#本机网卡名称，使用ifconfig命令查看</span>
    virtual_router_id <span class="token number">51</span>      <span class="token comment">#虚拟路由编号，主备机保持一致</span>
    priority <span class="token number">100</span>              <span class="token comment">#本机初始权重，备机设置小于主机的值</span>
    advert_int <span class="token number">1</span>              <span class="token comment">#争抢虚地址的周期，秒</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>
        <span class="token number">192.168</span>.210.200        <span class="token comment">#虚地址IP，主备机保持一致</span>
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{<!-- --></span>
        chk_haproxy           <span class="token comment">#对应的健康检查配置</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

systemctl start keepalived

<span class="token function">ip</span> addr
</code></pre> 
<p><img src="https://images2.imgbox.com/2d/3d/kWXKyc1P_o.png" alt="在这里插入图片描述"></p> 
<pre><code>备服务器
</code></pre> 
<pre><code class="prism language-bash"><span class="token number">7</span>-3
<span class="token function">vim</span> /etc/keepalived/keepalived.conf
 <span class="token comment">#只需要修改下面三项</span>
 router_id LVS_HA2    <span class="token comment">#虚拟路由名称</span>
  state BACKUP <span class="token comment">#本机实例状态，MASTER/BACKUP，备机配置文件中设置BACKUP</span>
   priority <span class="token number">90</span>   <span class="token comment">#本机初始权重，备机设置小于主机的值</span>
</code></pre> 
<h4>
<a id="8_665"></a>8、效果测试</h4> 
<h5>
<a id="1_667"></a>1）动静分离+负载均衡测试</h5> 
<pre><code class="prism language-bash">访问静态资源
<span class="token number">192.168</span>.210.200/test.html
<span class="token comment">#VIP地址访问</span>
</code></pre> 
<p></p> 
<div class="csdn-video-box"> 
  
 <p>20230921_163418</p> 
</div> 
<p></p> 
<pre><code class="prism language-bash">访问动态资源
<span class="token function">curl</span> <span class="token number">192.168</span>.210.200/test/index.jsp
<span class="token comment">#多次访问</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5b/84/RqvVYHD8_o.png" alt="在这里插入图片描述"></p> 
<h5>
<a id="2_687"></a>2）高可用测试</h5> 
<pre><code class="prism language-bash"><span class="token comment">#停掉当前MASTER主机的HAProxy实例，进行故障切换测试</span>
<span class="token function">service</span> haproxy stop
<span class="token comment">#观察keepalived的状态</span>
systemctl status keepalived
</code></pre> 
<pre><code class="prism language-bash">再次访问静态资源和动态资源，观察功能实现情况
</code></pre> 
<p></p> 
<div class="csdn-video-box"> 
  
 <p>20230921_163418</p> 
</div> 
<p></p> 
<p><img src="https://images2.imgbox.com/fb/fd/kHG7wptW_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="_707"></a>四、日志定义优化</h3> 
<h4>
<a id="1haproxycfg_709"></a>1、修改haproxy.cfg文件</h4> 
<p>修改haproxy.cfg，将info及以上级别的日志发送到rsyslog的local0接口，将warning及以上级别的日志发送到rsyslog的local1接口</p> 
<pre><code class="prism language-bash"><span class="token function">vim</span> /usr/local/haproxy/haproxy.cfg
global
    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
    log <span class="token number">127.0</span>.0.1 local0 info
    log <span class="token number">127.0</span>.0.1 local1 warning
    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

defaults
    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
    log global
    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token comment">#注：信息级日志会打印HAProxy 的每一条请求处理，会占用大量的磁盘空间，在生产环境中，将日志级别调整为notice</span>
</code></pre> 
<h4>
<a id="2rsyslog_728"></a>2、rsyslog配置</h4> 
<p>#为 rsyslog 添加 haproxy 日志的配置</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> /var/log/haproxy

<span class="token function">vim</span> /etc/rsyslog.d/haproxy.conf
<span class="token variable">$ModLoad</span> imudp
<span class="token variable">$UDPServerRun</span> <span class="token number">514</span>
<span class="token variable">$FileCreateMode</span> 0644                               <span class="token comment">#日志文件的权限</span>
<span class="token variable">$FileOwner</span> haproxy                                 <span class="token comment">#日志文件的owner</span>
local0.*     /var/log/haproxy/haproxy.log          <span class="token comment">#local0接口对应的日志输出文件</span>
local1.*     /var/log/haproxy/haproxy_warn.log     <span class="token comment">#local1接口对应的日志输出文件</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5f/fb/fKALFrOn_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash"><span class="token comment">#修改 rsyslog 的启动参数</span>
<span class="token function">vim</span> /etc/sysconfig/rsyslog
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token assign-left variable">SYSLOGD_OPTIONS</span><span class="token operator">=</span><span class="token string">"-c 2 -r -m 0"</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token comment">#重启 rsyslog 和 HAProxy</span>
systemctl restart rsyslog
<span class="token function">service</span> haproxy restart
</code></pre> 
<h4>
<a id="3_760"></a>3、访问测试</h4> 
<pre><code class="prism language-bash">客户端浏览器访问http://192.168.210.101
<span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/log/haproxy/haproxy-info.log
</code></pre> 
<p><img src="https://images2.imgbox.com/33/35/1QPCzzKs_o.png" alt="在这里插入图片描述"></p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>