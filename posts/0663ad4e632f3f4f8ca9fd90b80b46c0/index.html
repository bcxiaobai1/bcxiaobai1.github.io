<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>JPA 之 QueryDSL-JPA 使用指南 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">JPA 之 QueryDSL-JPA 使用指南</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <h1>
<a id="QuerydslJPA__0"></a>Querydsl-JPA 框架（推荐）</h1> 
<p>官网：<a href="http://www.querydsl.com/static/querydsl/4.1.3/reference/html_single/">传送门</a></p> 
<p>参考：</p> 
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/99055340?utm_source=wechat_session">JPA整合Querydsl入门篇</a></li>
<li><a href="https://www.jianshu.com/p/69dcb1b85bbb">SpringBoot环境下QueryDSL-JPA的入门及进阶</a></li>
</ul> 
<h2>
<a id="_9"></a>概述及依赖、插件、生成查询实体</h2> 
<p>1.Querydsl支持代码自动完成，因为是纯Java API编写查询，因此主流Java IDE对起的代码自动完成功能支持几乎可以发挥到极致（因为是纯Java代码，所以支持很好）</p> 
<p>2.Querydsl几乎可以避免所有的SQL语法错误（当然用错了Querydsl API除外，因为不写SQL了，因此想用错也难）</p> 
<p>3.Querydsl采用Domain类型的对象和属性来构建查询，因此查询绝对是类型安全的，不会因为条件类型而出现问题</p> 
<p>4.Querydsl采用纯Java API的作为SQL构建的实现可以让代码重构发挥到另一个高度</p> 
<p>5.Querydsl的领一个优势就是可以更轻松的进行增量查询的定义</p> 
<br> 
<p><strong>使用</strong></p> 
<p>在Spring环境下，可以通过两种风格来使用QueryDSL。</p> 
<p>一种是使用<code>JPAQueryFactory</code>的原生QueryDSL风格， 另一种是基于Spring Data提供的<code>QueryDslPredicateExecutor&lt;T&gt;</code>的Spring-data风格。</p> 
<p>使用<code>QueryDslPredicateExecutor&lt;T&gt;</code>可以简化一些代码，使得查询更加优雅。 而<code>JPAQueryFactory</code>的优势则体现在其功能的强大，支持更复杂的查询业务。甚至可以用来进行更新和删除操作。</p> 
<br> 
<p><strong>依赖</strong></p> 
<pre><code class="prism language-xml"> 	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- QueryDSL框架依赖 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.querydsl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>querydsl-apt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.querydsl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>querydsl-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<br> 
<p><strong>添加maven插件（pom.xml）</strong></p> 
<p>添加这个插件是为了让程序自动生成query type(查询实体，命名方式为：“Q”+对应实体名)。</p> 
<p>上文引入的依赖中<code>querydsl-apt</code>即是为此插件服务的。</p> 
<p>注：在使用过程中，如果遇到query type无法自动生成的情况，用maven更新一下项目即可解决(右键项目-&gt;Maven-&gt;Update Project)。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span> 
                <span class="token comment">&lt;!--因为QueryDsl是类型安全的，所以还需要加上Maven APT plugin，使用 APT 自动生成Q类:--&gt;</span>
            	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.mysema.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>apt-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>generate-sources<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>process<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>outputDirectory</span><span class="token punctuation">&gt;</span></span>target/generated-sources/java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>outputDirectory</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>processor</span><span class="token punctuation">&gt;</span></span>com.querydsl.apt.jpa.JPAAnnotationProcessor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>processor</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
        	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>补充：</p> 
<p>QueryDSL默认使用HQL发出查询语句。但也支持原生SQL查询。</p> 
<p>若要使用原生SQL查询，你需要使用下面这个maven插件生成相应的query type。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.querydsl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>querydsl-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${querydsl.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>export<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jdbcDriver</span><span class="token punctuation">&gt;</span></span>org.apache.derby.jdbc.EmbeddedDriver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jdbcDriver</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jdbcUrl</span><span class="token punctuation">&gt;</span></span>jdbc:derby:target/demoDB;create=true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jdbcUrl</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packageName</span><span class="token punctuation">&gt;</span></span>com.mycompany.mydomain<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packageName</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>targetFolder</span><span class="token punctuation">&gt;</span></span>${project.basedir}/target/generated-sources/java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>targetFolder</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.derby<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>derby<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${derby.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<br> 
<p><strong>生成查询实体</strong></p> 
<p>idea 工具 为maven project 自动添加了对应的功能。添加好依赖和 plugin 插件后，就可以生成查询实体了。</p> 
<p>打开右侧的 Maven Projects，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/e1/a9/8pIgcNhN_o.jpg" alt="在这里插入图片描述"></p> 
<p>双击 clean 清除已编译的 target</p> 
<p>双击 compile 命令执行，执行完成后会在 pom.xml 配置文件内配置生成目录内生成对应实体的 QueryDSL 查询实体。</p> 
<p>生成的查询实体如下图所示：</p> 
<p><img src="https://images2.imgbox.com/e5/5f/2bWiGnpG_o.jpg" alt="在这里插入图片描述"></p> 
<br> 
<h2>
<a id="JPAQueryFactory__148"></a>JPAQueryFactory 风格</h2> 
<p>QueryDSL 在支持JPA的同时，也提供了对 Hibernate 的支持。可以通过 <code>HibernateQueryFactory</code> 来使用。</p> 
<h3>
<a id="___152"></a>装配 与 注入</h3> 
<p><strong>SpringBoot注解方式装配</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 方式一。使用Spring的@Configuration注解注册实例进行容器托管
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryDslConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JPAQueryFactory</span> <span class="token function">jpaQueryFactory</span><span class="token punctuation">(</span><span class="token class-name">EntityManager</span> em<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JPAQueryFactory</span><span class="token punctuation">(</span>em<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * 方式二。在Dao类中初始化
 */</span>
	<span class="token comment">// 实体管理</span>
	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">EntityManager</span> entityManager<span class="token punctuation">;</span>
	<span class="token comment">// 查询工厂</span>
	<span class="token keyword">private</span> <span class="token class-name">JPAQueryFactory</span> queryFactory<span class="token punctuation">;</span>

	<span class="token comment">// 初始化JPA查询工厂</span>
	<span class="token annotation punctuation">@PostConstruct</span>		<span class="token comment">// Constructor(构造方法) -&gt; @Autowired(依赖注入) -&gt; @PostConstruct(注释的方法)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        queryFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JPAQueryFactory</span><span class="token punctuation">(</span>entityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>注入</strong></p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JPAQueryFactory</span> queryFactory<span class="token punctuation">;</span>
</code></pre> 
<br> 
<h3>
<a id="_194"></a>更新、删除</h3> 
<p><strong>JPAQueryFactory 更新</strong></p> 
<p>在Querydsl JPA中，更新语句是简单的 <code>update-set/where-execute</code> 形式。</p> 
<p>execute()执行后返回的是被更新的实体的数量。</p> 
<p><strong>注意：使用QueryDsl更新实体时需要添加事务</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">QStudent</span> qStudent <span class="token operator">=</span> <span class="token class-name">QStudent</span><span class="token punctuation">.</span>student<span class="token punctuation">;</span>
    <span class="token class-name">Long</span> result <span class="token operator">=</span> queryFactory<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>qStudent<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>qStudent<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"haha"</span><span class="token punctuation">)</span>		<span class="token comment">// 可以用if条件判断更新值来确定字段是否.set()</span>
      		<span class="token punctuation">.</span><span class="token function">setnull</span><span class="token punctuation">(</span>qStudent<span class="token punctuation">.</span>age<span class="token punctuation">)</span>			<span class="token comment">// 设置null值</span>
            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>qStudent<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">111L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<br> 
<p><strong>JPAQueryFactory 删除</strong></p> 
<p>删除语句是简单的 <code>delete-where-execute</code> 形式。</p> 
<p><strong>注意：使用QueryDsl删除实体时需要添加事务</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">QStudent</span> qStudent <span class="token operator">=</span> <span class="token class-name">QStudent</span><span class="token punctuation">.</span>student<span class="token punctuation">;</span>
    <span class="token comment">//删除指定条件的记录</span>
    <span class="token class-name">Long</span> result <span class="token operator">=</span> queryFactory<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>qStudent<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>qStudent<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">111L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//删除所有记录。即不加where条件</span>
    <span class="token class-name">Long</span> totalResult <span class="token operator">=</span> queryFactory<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>qStudent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>totalResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<br> 
<h3>
<a id="_244"></a>查询</h3> 
<h4>
<a id="_246"></a>表达式工具类</h4> 
<p><strong>Expressions 表达式工具类</strong></p> 
<pre><code class="prism language-java"><span class="token comment">// when-then 条件表达式函数。when传参必须为名为eqTrue或eqFalse的Predicate</span>
<span class="token class-name">T</span> <span class="token function">cases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">T</span> a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">otherwise</span><span class="token punctuation">(</span><span class="token class-name">T</span> b<span class="token punctuation">)</span>
    
<span class="token class-name">DateExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> <span class="token function">currentDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回当前日历（年-月-日）的 DateExpression</span>
<span class="token class-name">TimeExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Time</span><span class="token punctuation">&gt;</span></span> <span class="token function">currentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回当前时刻（时:分:秒）的 TimeExpression</span>
<span class="token class-name">DateTimeExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> <span class="token function">currentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">// 返回当前时间（年-月-日 时:分:秒）的 DateTimeExpression</span>
    
<span class="token comment">// exprs 均为名为eqTrue的Predicate ，则返回名为eqTrue的Predicate，否则返回eqFalse的Predicate</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">allOf</span><span class="token punctuation">(</span><span class="token class-name">BooleanExpression</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> exprs<span class="token punctuation">)</span>
<span class="token comment">// exprs 至少存在一个名为eqTrue的Predicate，则返回名为eqTrue的Predicate，否则返回eqFalse的Predicate</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">anyOf</span><span class="token punctuation">(</span><span class="token class-name">BooleanExpression</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> exprs<span class="token punctuation">)</span>

<span class="token comment">// 转类型为 BooleanExpression。特别注意：asBoolean(Boolean).isTrue() 才是可用Predicate</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">asBoolean</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span>			<span class="token comment">// asBoolean(true)  &lt;==等价==&gt;  booleanPath("true")</span>
<span class="token class-name">NumberExpression</span> <span class="token function">asNumber</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>
<span class="token class-name">StringrExpression</span> <span class="token function">asString</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>
<span class="token class-name">DateExpression</span> <span class="token function">asDate</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>
<span class="token class-name">TimeExpression</span> <span class="token function">asTime</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>
<span class="token class-name">DateTimeExpression</span> <span class="token function">asDateTime</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>

<span class="token comment">// 自定义语法</span>
<span class="token class-name">StringTemplate</span> <span class="token function">stringTemplate</span><span class="token punctuation">(</span><span class="token class-name">String</span> template<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
<span class="token class-name">NumberTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">numberTemplate</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> cl<span class="token punctuation">,</span> <span class="token class-name">String</span> template<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
<span class="token class-name">BooleanTemplate</span> <span class="token function">booleanTemplate</span><span class="token punctuation">(</span><span class="token class-name">String</span> template<span class="token punctuation">,</span> <span class="token class-name">ImmutableList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">)</span>
</code></pre> 
<p><strong>MathExpressions 数学表达式工具类</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> num<span class="token punctuation">)</span>			<span class="token comment">// 四舍五入取整</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> num<span class="token punctuation">,</span> <span class="token keyword">int</span> s<span class="token punctuation">)</span>		<span class="token comment">// 四舍五入保留 s 位小数</span>

<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> <span class="token function">asin</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> num<span class="token punctuation">)</span>		<span class="token comment">// 返回num的反正弦值。-1 &lt;= num &lt;= 1，否则返回null</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> <span class="token function">acos</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> num<span class="token punctuation">)</span>		<span class="token comment">// 返回num的反余弦值。-1 &lt;= num &lt;= 1，否则返回null</span>

<span class="token comment">// 慎用！qdsl-jpa底层是调用random()函数，MySQL没有该函数，只有rand()函数，会报错，解决方案为使用QDSL-SQL查询</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回０到１内的随机值</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token keyword">int</span> seed<span class="token punctuation">)</span>	<span class="token comment">// 返回一个指定的０到１内的随机值</span>
</code></pre> 
<br> 
<h4>
<a id="_293"></a>表达式方法</h4> 
<p><strong>注意：在select()中查询出的结果使用表达式方法处理过后，若要封装到实体类中，则都需要使用 .as(alias) 起别名指定封装到实体类中的哪个字段。</strong></p> 
<p><strong>SimpleExpression 简单表达式</strong> extends DslExpression extends Expression</p> 
<pre><code class="prism language-java"><span class="token comment">// 给查询字段取别名</span>
<span class="token class-name">T</span> <span class="token function">as</span><span class="token punctuation">(</span>alias<span class="token punctuation">)</span>

<span class="token class-name">BooleanExpression</span> <span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">T</span> right<span class="token punctuation">)</span>	<span class="token comment">// 等于 equal</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">eqAll</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">eqAny</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">ne</span><span class="token punctuation">(</span><span class="token class-name">T</span> right<span class="token punctuation">)</span>	<span class="token comment">// 不等于	not equal </span>
<span class="token class-name">BooleanExpression</span> <span class="token function">neAll</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">neAny</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>

<span class="token class-name">BooleanExpression</span> <span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">notIn</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
    
<span class="token class-name">BooleanExpression</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">isNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token comment">// 相当于java中的switch语句。两种写法</span>
<span class="token class-name">T</span> <span class="token function">when</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">otherwise</span><span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span>

<span class="token comment">// 该字段的查询结果等于参数则返回null，不等于则返回查询结果。Field == A ? null : Field</span>
<span class="token class-name">SimpleExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">nullif</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span>

<span class="token comment">// 符合过滤条件的的总条数。		select count(table.id) from table</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>ComparableExpressionBase</strong> extends SimpleExpression</p> 
<pre><code class="prism language-java"><span class="token comment">// 设置默认值。返回 Field, A, B ... 顺序中第一个非null的值，若都为null则返回null</span>
<span class="token comment">// 注意：使用该方法兜底Oracle数据库的null为空字符串时会失效，因为Oracle会把空字符串当作null</span>
<span class="token class-name">T</span> <span class="token function">coalesce</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">B</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>NumberExpression 数值表达式</strong> extends ComparableExpressionBase</p> 
<pre><code class="prism language-java"><span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span>			<span class="token comment">// 加    </span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">subtract</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span>		<span class="token comment">// 减  </span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span>		<span class="token comment">// 乘  </span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span>		<span class="token comment">// 除  </span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">mod</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span>			<span class="token comment">// 返回余数</span>
 
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 向下取整</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 向上取整</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 四舍五入取整</span>

<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回指定数值列的最大值</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回指定数值列的最小值</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回指定数值列的平方根</span>

<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回指定数值列（或分组相同数值列）的总数</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回指定数值列（或分组相同数值列）的平均数</span>

<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回指定数值列的绝对值</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">negate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 返回指定数值列的相反数</span>

<span class="token class-name">StringExpression</span> <span class="token function">stringValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">// 返回字符串表达式</span>
    
<span class="token comment">// 数据类型转换为数字类型。type为数字基本类型的包装类.class。实体类接收字段需与type的类型一致。</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">castToNum</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span>
</code></pre> 
<p><strong>ComparableExpression</strong> extends ComparableExpressionBase</p> 
<pre><code class="prism language-java"><span class="token class-name">BooleanExpression</span> <span class="token function">lt</span><span class="token punctuation">(</span><span class="token class-name">T</span> right<span class="token punctuation">)</span>	<span class="token comment">// 小于 less than</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">ltAll</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">ltAny</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">gt</span><span class="token punctuation">(</span><span class="token class-name">T</span> right<span class="token punctuation">)</span> 	<span class="token comment">// 大于 greater than</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">gtAll</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">gtAny</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>

<span class="token class-name">BooleanExpression</span> <span class="token function">loe</span><span class="token punctuation">(</span><span class="token class-name">T</span> right<span class="token punctuation">)</span>	<span class="token comment">// 小于等于 less than or equal</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">loeAll</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">loeAny</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">goe</span><span class="token punctuation">(</span><span class="token class-name">T</span> right<span class="token punctuation">)</span>	<span class="token comment">// 大于等于 greater than or equal</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">goeAll</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">goeAny</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> right<span class="token punctuation">)</span>

<span class="token class-name">BooleanExpression</span> <span class="token function">between</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">)</span>		<span class="token comment">// from和to之间  [from, to]</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">notBetween</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>BooleanExpression 布尔表达式</strong> extends LiteralExpression (extends ComparableExpression) implements Predicate</p> 
<pre><code class="prism language-java"><span class="token class-name">BooleanExpression</span> <span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 计算结果若为true，则返回名为eqTrue的Predicate，否则返回名为eqFalse的Predicate</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">isFalse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 计算结果若为false，则返回名为eqTrue的Predicate，否则返回名为eqFalse的Predicate</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">not</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回相反的结果</span>

<span class="token class-name">BooleanExpression</span> <span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> right<span class="token punctuation">)</span>

<span class="token class-name">BooleanExpression</span> <span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">andAnyOf</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> predicates<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">or</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span> right<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">orAllOf</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> predicates<span class="token punctuation">)</span>
</code></pre> 
<p><strong>StringExpressions 字符串表达式</strong> extends LiteralExpression extends ComparableExpression</p> 
<pre><code class="prism language-java"><span class="token class-name">StringExpression</span> <span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span>	<span class="token comment">// 包含参数字符串</span>
    
<span class="token class-name">BooleanExpression</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 判断是否为空</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	
    
<span class="token comment">// 正则匹配查询</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> regex<span class="token punctuation">)</span>
<span class="token comment">// 模糊查询。% 为通配符，_ 表一个字符，可以传参escape指定转义字符</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">like</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">like</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">,</span> <span class="token keyword">char</span> escape<span class="token punctuation">)</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">endsWith</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>		<span class="token comment">// 判断字符串的后缀是否为str。注意：必须使用boolean数据类型的字段接收</span>
<span class="token class-name">BooleanExpression</span> <span class="token function">startsWith</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>	<span class="token comment">// 判断字符串的前缀是否为str。注意：必须使用boolean数据类型的字段接收</span>
      
<span class="token comment">// 将字母转换大小写</span>
<span class="token class-name">StringExpression</span> <span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">StringExpression</span> <span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">StringExpression</span> <span class="token function">lower</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">StringExpression</span> <span class="token function">upper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token class-name">StringExpression</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 去掉字符串两端的空格</span>
<span class="token class-name">StringExpression</span> <span class="token function">substring</span><span class="token punctuation">(</span><span class="token keyword">int</span> beginIndex<span class="token punctuation">)</span>		<span class="token comment">// 截取子字符串从索引位置至末尾</span>
<span class="token class-name">StringExpression</span> <span class="token function">concat</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>	<span class="token comment">// 拼接 str</span>
<span class="token class-name">StringExpression</span> <span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>	<span class="token comment">// 在末尾添加 str</span>
<span class="token class-name">StringExpression</span> <span class="token function">prepend</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>	<span class="token comment">// 在前面添加 str</span>

<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 返回字符串长度</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">locate</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>		<span class="token comment">// 返回 str 的位置（从1开始），没有返回0</span>
<span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">indexOf</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>		<span class="token comment">// 返回 str 索引（从0开始），没有返回-1</span>
<span class="token class-name">SimpleExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> <span class="token function">charAt</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>	<span class="token comment">// 返回参数索引位置的字符。实体类接收字段需为char或CharacterSS</span>
</code></pre> 
<br> 
<h4>
<a id="select__fetch__435"></a>select() 和 fetch() 的常用写法</h4> 
<p><strong>注意：使用fetch()查询时，数据库没有符合该条件的数据时，返回的是空集合，而不是null。</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">QMemberDomain</span> qm <span class="token operator">=</span> <span class="token class-name">QMemberDomain</span><span class="token punctuation">.</span>memberDomain<span class="token punctuation">;</span>
<span class="token comment">//查询字段-select()</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nameList <span class="token operator">=</span> queryFactory
                            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//查询实体-selectFrom()</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> memberList <span class="token operator">=</span> queryFactory
                                    <span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//查询并将结果封装至dto中</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberFavoriteDto</span><span class="token punctuation">&gt;</span></span> dtoList <span class="token operator">=</span> queryFactory
                                        <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
                                            <span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">bean</span><span class="token punctuation">(</span><span class="token class-name">MemberFavoriteDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> 
                                            	qm<span class="token punctuation">.</span>name<span class="token punctuation">,</span> 
                                            	qf<span class="token punctuation">.</span>favoriteStoreCode<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">leftJoin</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>favoriteInfoDomains<span class="token punctuation">,</span> qf<span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//去重查询-selectDistinct()</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> distinctNameList <span class="token operator">=</span> queryFactory
                                    <span class="token punctuation">.</span><span class="token function">selectDistinct</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//获取首个查询结果-fetchFirst()</span>
<span class="token class-name">MemberDomain</span> firstMember <span class="token operator">=</span> queryFactory
                                <span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">fetchFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//获取唯一查询结果-fetchOne()</span>
<span class="token comment">//当fetchOne()根据查询条件从数据库中查询到多条匹配数据时，会抛`NonUniqueResultException`。</span>
<span class="token class-name">MemberDomain</span> anotherFirstMember <span class="token operator">=</span> queryFactory
                                        <span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">fetchOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<br> 
<h4>
<a id="where__482"></a>where 子句查询条件的常用写法</h4> 
<pre><code class="prism language-java"><span class="token comment">//查询条件示例</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> memberConditionList <span class="token operator">=</span> queryFactory<span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
    <span class="token comment">//like示例</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token char">'%'</span><span class="token operator">+</span><span class="token string">"Jack"</span><span class="token operator">+</span><span class="token char">'%'</span><span class="token punctuation">)</span>
           <span class="token comment">//contain示例</span>
           <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>address<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"厦门"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token comment">//equal示例</span>
           <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>status<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"0013"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token comment">//between</span>
           <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>age<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>               
    <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>使用QueryDSL提供的<code>BooleanBuilder</code>来进行查询条件管理。</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">BooleanBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooleanBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// like</span>
builder<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token char">'%'</span><span class="token operator">+</span><span class="token string">"Jack"</span><span class="token operator">+</span><span class="token char">'%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// contain</span>
builder<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>address<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"厦门"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// equal示例</span>
builder<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>status<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"0013"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// between</span>
builder<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>age<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> memberConditionList <span class="token operator">=</span> queryFactory<span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 复杂的查询关系</span>
<span class="token class-name">BooleanBuilder</span> builder2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooleanBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder2<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>status<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"0013"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder2<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>status<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"0014"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>builder2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> memberConditionList <span class="token operator">=</span> queryFactory<span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>builder2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<br> 
<h4>
<a id="_523"></a>自定义封装查询的结果集</h4> 
<p>方法一：<strong>使用Projections的Bean方法</strong></p> 
<p>JPAQueryFactory查询工厂的select方法可以将Projections方法返回的QBean作为参数，通过Projections的bean方法来构建返回的结果集映射到实体内，有点像Mybatis内的ResultMap的形式，不过内部处理机制肯定是有着巨大差别的！</p> 
<p>bean方法第一个参数需要传递一个实体的泛型类型作为返回集合内的单个对象类型，如果QueryDSL查询实体内的字段与DTO实体的字段名字不一样时，可以采用as方法来处理，为查询的结果集指定的字段添加别名，这样就会自动映射到DTO实体内。</p> 
<pre><code class="prism language-java"><span class="token keyword">return</span> queryFactory
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
    			<span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">bean</span><span class="token punctuation">(</span><span class="token class-name">PersonIDCardDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> 
                    <span class="token class-name">QIDCard</span><span class="token punctuation">.</span>iDCard<span class="token punctuation">.</span>idNo<span class="token punctuation">,</span> 
                    <span class="token class-name">QPerson</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>address<span class="token punctuation">,</span> 
                    <span class="token class-name">QPerson</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"userName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">// 使用别名对应dto内的userName</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">QIDCard</span><span class="token punctuation">.</span>iDCard<span class="token punctuation">,</span> <span class="token class-name">QPerson</span><span class="token punctuation">.</span>person<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>predicate<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>底层原理：</strong></p> 
<ol>
<li>使用数据封装类的无参构造方法创建对象（如果类上有使用@Builder注解导致@Data无参构造方法被覆盖，则会报错，可以再加上 @AllArgsConstructor，@NoArgsConstructor 注解）</li>
<li>使用setter方法封装数据给字段（会校验数据封装字段和Entity对应字段的数据类型是否一致，不一致则会报错）</li>
</ol> 
<p><strong>常见问题：</strong></p> 
<ul><li>Entity中时间字段的数据类型为 java.util.Date，数据封装类中时间字段的数据类型为 java.sql.Date 或具有指定时间格式的String类型，数据类型不一致，导致数据无法封装成功 
  <ul>
<li>方案1：修改数据封装类或Entity中时间的数据类型，使其类型一致</li>
<li>方案2：数据封装类中新增util.Date类型字段，手动重写其setter方法，处理数据后赋值到原sql.Date类型字段上。注意：查询封装数据到字段时 as(“新增的util.Date字段”)</li>
<li>方案3：数据封装类中新增util.Date类型字段，先将数据封装到该字段，再通过getter、setter方法处理数据后赋值到原sql.Date类型字段上。</li>
</ul> </li></ul> 
<br> 
<p>方法二：使用Projections的fields方法</p> 
<pre><code class="prism language-java"><span class="token keyword">return</span> queryFactory
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
                <span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token class-name">PersonIDCardDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> 
                    <span class="token class-name">QIDCard</span><span class="token punctuation">.</span>iDCard<span class="token punctuation">.</span>idNo<span class="token punctuation">,</span> 
                    <span class="token class-name">QPerson</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>address<span class="token punctuation">,</span> 
                    <span class="token class-name">QPerson</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">QIDCard</span><span class="token punctuation">.</span>iDCard<span class="token punctuation">,</span> <span class="token class-name">QPerson</span><span class="token punctuation">.</span>person<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>predicate<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<br> 
<p>方法三：使用Projections的constructor方法，注意构造方法中参数的顺序</p> 
<pre><code class="prism language-java"><span class="token keyword">return</span> queryFactory
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
                <span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token class-name">PersonIDCardDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> 
                    <span class="token class-name">QPerson</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>name<span class="token punctuation">,</span> 
                    <span class="token class-name">QPerson</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>address<span class="token punctuation">,</span> 
                    <span class="token class-name">QIDCard</span><span class="token punctuation">.</span>iDCard<span class="token punctuation">.</span>idNo<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">QIDCard</span><span class="token punctuation">.</span>iDCard<span class="token punctuation">,</span> <span class="token class-name">QPerson</span><span class="token punctuation">.</span>person<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>predicate<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<br> 
<p>方式四：使用集合的stream转换</p> 
<p>从方法开始到fetch()结束完全跟QueryDSL没有任何区别，采用了最原始的方式进行返回结果集，但是从fetch()获取到结果集后处理的方式就有所改变了。</p> 
<p>fetch()方法返回的类型是泛型List（List），List继承了Collection，完全存在使用Collection内非私有方法的权限，通过调用stream方法可以将集合转换成Stream泛型对象，该对象的map方法可以操作集合内单个对象的转换，具体的转换代码可以根据业务逻辑进行编写。</p> 
<p>在map方法内有个lambda表达式参数tuple，通过tuple对象get方法就可以获取对应select方法内的查询字段。</p> 
<p><strong>注意：tuple只能获取select内存在的字段，如果select内为一个实体对象，tuple无法获取指定字段的值。</strong></p> 
<pre><code class="prism language-java"> 	<span class="token comment">/**
     * 使用java8新特性Collection内stream方法转换dto
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GoodDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectWithStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//商品基本信息</span>
        <span class="token class-name">QGoodInfoBean</span> goodBean <span class="token operator">=</span> <span class="token class-name">QGoodInfoBean</span><span class="token punctuation">.</span>goodInfoBean<span class="token punctuation">;</span>
        <span class="token comment">//商品类型</span>
        <span class="token class-name">QGoodTypeBean</span> goodTypeBean <span class="token operator">=</span> <span class="token class-name">QGoodTypeBean</span><span class="token punctuation">.</span>goodTypeBean<span class="token punctuation">;</span>
        <span class="token keyword">return</span> queryFactory
                    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
                        goodBean<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                        goodBean<span class="token punctuation">.</span>price<span class="token punctuation">,</span>
                        goodTypeBean<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                        goodTypeBean<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>goodBean<span class="token punctuation">,</span>goodTypeBean<span class="token punctuation">)</span>	<span class="token comment">//构建两表笛卡尔集</span>
                    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>goodBean<span class="token punctuation">.</span>typeId<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>goodTypeBean<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//关联两表</span>
                    <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>goodBean<span class="token punctuation">.</span>order<span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//倒序</span>
                    <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment">//转换集合内的数据</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>tuple <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//创建商品dto</span>
                        <span class="token class-name">GoodDTO</span> dto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GoodDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//设置商品编号</span>
                        dto<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodBean<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//设置商品价格</span>
                        dto<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodBean<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//设置类型编号</span>
                        dto<span class="token punctuation">.</span><span class="token function">setTypeId</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodTypeBean<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//设置类型名称</span>
                        dto<span class="token punctuation">.</span><span class="token function">setTypeName</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodTypeBean<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//返回本次构建的dto</span>
                        <span class="token keyword">return</span> dto<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token comment">//返回集合并且转换为List&lt;GoodDTO&gt;</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<br> 
<h4>
<a id="_641"></a>排序、分页</h4> 
<p><strong>排序</strong></p> 
<pre><code class="prism language-java"><span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 升序</span>
<span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 降序</span>
<span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nullsFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 升序，空值放前面</span>
<span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nullsLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 降序，空值放前面</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">//排序</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> orderList <span class="token operator">=</span> queryFactory<span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
    									<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    									<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<br> 
<p><strong>分页</strong></p> 
<pre><code class="prism language-java"><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token keyword">long</span> limit<span class="token punctuation">)</span>		<span class="token comment">// 限制查询结果返回的数量。即一页多少条记录（pageSize）</span>
<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token keyword">long</span> offset<span class="token punctuation">)</span>	<span class="token comment">// 跳过多少行。offset = ( pageNum - 1 ) * pageSize		// pageNum：第几页</span>
</code></pre> 
<pre><code class="prism language-java">    <span class="token class-name">QMemberDomain</span> qm <span class="token operator">=</span> <span class="token class-name">QMemberDomain</span><span class="token punctuation">.</span>memberDomain<span class="token punctuation">;</span>
    <span class="token comment">//写法一</span>
    <span class="token class-name">JPAQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span> queryFactory
                                        <span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>age<span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 查询总条数。fetchCount时，orderBy不会被执行</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">fetchCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token comment">// 获取过滤后的查询结果集</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> list0<span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//写法二。fetchResults()自动实现count查询和结果查询，并封装到QueryResults&lt;T&gt;中</span>
    <span class="token class-name">QueryResults</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> queryFactory
                                                <span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>age<span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">fetchResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">getResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 过滤后的查询结果集</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"total:"</span><span class="token operator">+</span>results<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 符合过滤条件的的总条数</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"offset:"</span><span class="token operator">+</span>results<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 跳过多少条符合过滤条件的查询结果</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"limit:"</span><span class="token operator">+</span>results<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 限制查询结果返回的条数</span>
</code></pre> 
<p>写法一和二都会发出两条sql进行查询，一条查询count，一条查询具体数据。</p> 
<p>写法二的<code>getTotal()</code>等价于写法一的<code>fetchCount</code>。</p> 
<p>无论是哪种写法，在查询count的时候，<strong>orderBy、limit、offset这三个都不会被执行</strong>。可以大胆使用。</p> 
<br> 
<h4>
<a id="_700"></a>子查询</h4> 
<pre><code class="prism language-java">	<span class="token comment">// 子查询作为where条件内容</span>
	<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selectJPAExpressions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> subList <span class="token operator">=</span> queryFactory
                                            <span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                                            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>status<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>
                                                <span class="token class-name">JPAExpressions</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                            <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


	<span class="token comment">// 子查询作为select查询字段</span>
	<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selectJPAExpressions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">QUserAddress</span> ua <span class="token operator">=</span> <span class="token class-name">QUserAddress</span><span class="token punctuation">.</span>userAddress<span class="token punctuation">;</span>
        <span class="token class-name">QUser</span> u <span class="token operator">=</span> <span class="token class-name">QUser</span><span class="token punctuation">.</span>user<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAddressDTO</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> queryFactory
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
            	<span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">bean</span><span class="token punctuation">(</span><span class="token class-name">UserAddressDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span>
                    <span class="token punctuation">,</span> ua<span class="token punctuation">.</span>addressee
                    <span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">asNumber</span><span class="token punctuation">(</span>
                        <span class="token class-name">JPAExpressions</span>
                            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">ne</span><span class="token punctuation">(</span>ua<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">// asNumber接收子查询结果后需要指定数值的数据类型</span>
                        <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"lon"</span><span class="token punctuation">)</span>
<span class="token comment">//                	, Expressions.asString(	// asString接收子查询结果后不用指定数据类型</span>
<span class="token comment">//                	    JPAExpressions.</span>
<span class="token comment">//                	        select(u.username)</span>
<span class="token comment">//                	        .from(u)</span>
<span class="token comment">//                	        .where(u.id.eq(ua.userId))</span>
<span class="token comment">//                	)</span>
<span class="token comment">//                	    .as("password")</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>ua<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>ua<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">38</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<br> 
<h4>
<a id="_748"></a>联表动态查询</h4> 
<pre><code class="prism language-java">    <span class="token comment">// JPA查询工厂</span>
	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">JPAQueryFactory</span> queryFactory<span class="token punctuation">;</span> 

	<span class="token comment">/**
     * 关联查询示例，查询出城市和对应的旅店
     */</span>
	<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findCityAndHotel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">QTCity</span> qtCity <span class="token operator">=</span> <span class="token class-name">QTCity</span><span class="token punctuation">.</span>tCity<span class="token punctuation">;</span>
        <span class="token class-name">QTHotel</span> qtHotel <span class="token operator">=</span> <span class="token class-name">QTHotel</span><span class="token punctuation">.</span>tHotel<span class="token punctuation">;</span>
        
        <span class="token class-name">JPAQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> jpaQuery <span class="token operator">=</span> queryFactory
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>qtCity<span class="token punctuation">,</span> qtHotel<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>qtCity<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">leftJoin</span><span class="token punctuation">(</span>qtHotel<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>qtHotel<span class="token punctuation">.</span>city<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>qtCity<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 分离式 添加查询条件</span>
        jpaQuery<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name">QTCity</span><span class="token punctuation">.</span>tCity<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token string">"shanghai"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 获取查询结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> jpaQuery<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 对多元组取出数据，这个和select时的数据相匹配</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Tuple</span> row <span class="token operator">:</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"qtCity:"</span> <span class="token operator">+</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>qtCity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"qtHotel:"</span> <span class="token operator">+</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>qtHotel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<br> 
<h4>
<a id="_786"></a>联表一对多查询封装</h4> 
<p>方式一：查询结果返回类型为List</p> 
<pre><code class="prism language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAddressDTO</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> queryFactory
                <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>ua<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>ua<span class="token punctuation">.</span>userId<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">GroupBy</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
                	<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>
                        <span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">bean</span><span class="token punctuation">(</span><span class="token class-name">UserAddressDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                            u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> 
                            u<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
                            <span class="token class-name">GroupBy</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>
                                <span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">bean</span><span class="token punctuation">(</span><span class="token class-name">UserAddress</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                                	ua<span class="token punctuation">.</span>address<span class="token punctuation">,</span> 
                                	ua<span class="token punctuation">.</span>city<span class="token punctuation">,</span> 
                                	ua<span class="token punctuation">.</span>district
                            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"userAddresses"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<br> 
<p>方式二：查询结果返回类型为Map</p> 
<p>map的key为分组字段，一般为主键ID</p> 
<pre><code class="prism language-java"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">UserAddressDTO</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> queryFactory
                <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>ua<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>ua<span class="token punctuation">.</span>userId<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">GroupBy</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
                	<span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span>
                        <span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">bean</span><span class="token punctuation">(</span><span class="token class-name">UserAddressDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                            u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> 
                            u<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
                            <span class="token class-name">GroupBy</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">bean</span><span class="token punctuation">(</span><span class="token class-name">UserAddress</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                                ua<span class="token punctuation">.</span>address<span class="token punctuation">,</span> 
                                ua<span class="token punctuation">.</span>city<span class="token punctuation">,</span> 
                                ua<span class="token punctuation">.</span>district
                            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"userAddresses"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<br> 
<p>实体类：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserAddressDTO</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAddress</span><span class="token punctuation">&gt;</span></span> userAddresses<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<br> 
<h4>
<a id="_857"></a>使用聚合函数</h4> 
<pre><code class="prism language-java"><span class="token comment">//聚合函数-avg()</span>
<span class="token class-name">Double</span> averageAge <span class="token operator">=</span> queryFactory
                        <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>age<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">fetchOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//聚合函数-concat()</span>
<span class="token class-name">String</span> concat <span class="token operator">=</span> queryFactory
                    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">fetchOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//聚合函数-date_format()</span>
<span class="token class-name">String</span> date <span class="token operator">=</span> queryFactory
                    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
                        <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">stringTemplate</span><span class="token punctuation">(</span><span class="token string">"DATE_FORMAT({0},'%Y-%m-%d')"</span><span class="token punctuation">,</span> 
                        qm<span class="token punctuation">.</span>registerDate<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">fetchOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>当用到DATE_FORMAT这类QueryDSL似乎没有提供支持的Mysql函数时，可以手动拼一个String表达式。这样就可以无缝使用Mysql中的函数了。</p> 
<br> 
<h4>
<a id="_Template__885"></a>使用 Template 实现自定义语法</h4> 
<p>QueryDSL并没有对数据库的所有函数提供支持，好在它提供了Template特性。</p> 
<p>可以使用Template来实现各种QueryDSL未直接支持的语法。</p> 
<p>Template的局限性：</p> 
<p>  由于Template中使用了<code>{}</code>来作为占位符（内部序号从0开始），而正则表达式中也可能使用了<code>{}</code>，因而会产生冲突。</p> 
<pre><code class="prism language-java"><span class="token class-name">QMemberDomain</span> qm <span class="token operator">=</span> <span class="token class-name">QMemberDomain</span><span class="token punctuation">.</span>memberDomain<span class="token punctuation">;</span>

<span class="token comment">//使用booleanTemplate充当where子句或where子句的一部分</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> queryFactory
                                <span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">booleanTemplate</span><span class="token punctuation">(</span><span class="token string">"{0} = "tofu""</span><span class="token punctuation">,</span> qm<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//上面的写法，当booleanTemplate中需要用到多个占位时</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> list1 <span class="token operator">=</span> queryFactory
                                <span class="token punctuation">.</span><span class="token function">selectFrom</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>
                                    <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">booleanTemplate</span><span class="token punctuation">(</span><span class="token string">"{0} = "tofu" and {1} = "Amoy""</span><span class="token punctuation">,</span> 
                                    qm<span class="token punctuation">.</span>name<span class="token punctuation">,</span> 
                                    qm<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//使用stringTemplate充当查询语句的某一部分</span>
<span class="token class-name">String</span> date <span class="token operator">=</span> queryFactory
                    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
                        <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">stringTemplate</span><span class="token punctuation">(</span><span class="token string">"DATE_FORMAT({0},'%Y-%m-%d')"</span><span class="token punctuation">,</span> 
                        qm<span class="token punctuation">.</span>registerDate<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">fetchFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//在where子句中使用stringTemplate</span>
<span class="token class-name">String</span> id <span class="token operator">=</span> queryFactory
                <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>qm<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>
                    <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">stringTemplate</span><span class="token punctuation">(</span><span class="token string">"DATE_FORMAT({0},'%Y-%m-%d')"</span><span class="token punctuation">,</span> 
                    qm<span class="token punctuation">.</span>registerDate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"2018-03-19"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">fetchFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<br> 
<h2>
<a id="QueryDslPredicateExecutor__933"></a>QueryDslPredicateExecutor 风格</h2> 
<p>通常使用Repository来继承<code>QueryDslPredicateExecutor&lt;T&gt;</code>接口。通过注入Repository来使用。</p> 
<p><strong>Repository 接口</strong></p> 
<p>Spring Data JPA中提供了QueryDslPredicateExecutor接口，用于支持QueryDSL的查询操作。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> tityRepository <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">City</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">QuerydslPredicateExecutor</span><span class="token generics"><span class="token punctuation">&lt;</span>city<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<br> 
<p><code>QueryDslPredicateExecutor&lt;T&gt;</code>接口提供了<code>findOne()</code>，<code>findAll()</code>，<code>count()</code>，<code>exists()</code>四个方法来支持查询。并可以使用更优雅的<code>BooleanBuilder</code> 来进行条件分支管理。</p> 
<ul>
<li>
<code>count()</code>会返回满足查询条件的数据行的数量</li>
<li>
<code>exists()</code>会根据所要查询的数据是否存在返回一个boolean值</li>
</ul> 
<br> 
<h4>
<a id="findOnefindAll_954"></a>findOne()、findAll()</h4> 
<p><strong>findOne</strong></p> 
<p>从数据库中查出一条数据。没有重载方法。</p> 
<pre><code class="prism language-java"><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>和<code>JPAQuery</code>的<code>fetchOne()</code>一样，当根据查询条件从数据库中查询到多条匹配数据时，会抛<code>NonUniqueResultException</code>。使用的时候需要慎重。</p> 
<br> 
<p><strong>findAll()</strong></p> 
<p>findAll是从数据库中查出匹配的所有数据。提供了以下几个重载方法。</p> 
<pre><code class="prism language-java"><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span> var1<span class="token punctuation">,</span> <span class="token class-name">Sort</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span> var1<span class="token punctuation">,</span> <span class="token class-name">OrderSpecifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">OrderSpecifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span> var1<span class="token punctuation">,</span> <span class="token class-name">Pageable</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>使用示例：</p> 
<pre><code class="prism language-java"><span class="token class-name">QMemberDomain</span> qm <span class="token operator">=</span> <span class="token class-name">QMemberDomain</span><span class="token punctuation">.</span>memberDomain<span class="token punctuation">;</span>
<span class="token comment">// QueryDSL 提供的排序实现</span>
<span class="token class-name">OrderSpecifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderSpecifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">,</span> qm<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> iterable <span class="token operator">=</span> memberRepo<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>status<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"0013"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">QMemberDomain</span> qm <span class="token operator">=</span> <span class="token class-name">QMemberDomain</span><span class="token punctuation">.</span>memberDomain<span class="token punctuation">;</span>
<span class="token comment">// Spring Data 提供的排序实现</span>
<span class="token class-name">Sort</span> sort <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sort</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Sort<span class="token punctuation">.</span>Order</span><span class="token punctuation">(</span><span class="token class-name">Sort<span class="token punctuation">.</span>Direction</span><span class="token punctuation">.</span><span class="token constant">ASC</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberDomain</span><span class="token punctuation">&gt;</span></span> iterable <span class="token operator">=</span> memberRepo<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>qm<span class="token punctuation">.</span>status<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"0013"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sort<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<br> 
<h4>
<a id="_1000"></a>单表动态分页查询</h4> 
<p>单表动态查询示例：</p> 
<pre><code class="prism language-java"><span class="token comment">//动态条件</span>
<span class="token class-name">QTCity</span> qtCity <span class="token operator">=</span> <span class="token class-name">QTCity</span><span class="token punctuation">.</span>tCity<span class="token punctuation">;</span> <span class="token comment">//SDL实体类</span>
<span class="token comment">//该Predicate为querydsl下的类,支持嵌套组装复杂查询条件</span>
<span class="token class-name">Predicate</span> predicate <span class="token operator">=</span> qtCity<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>qtCity<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token string">"shanghai"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//分页排序</span>
<span class="token class-name">Sort</span> sort <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sort</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Sort<span class="token punctuation">.</span>Order</span><span class="token punctuation">(</span><span class="token class-name">Sort<span class="token punctuation">.</span>Direction</span><span class="token punctuation">.</span><span class="token constant">ASC</span><span class="token punctuation">,</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">PageRequest</span> pageRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageRequest</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span>sort<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//查找结果</span>
<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TCity</span><span class="token punctuation">&gt;</span></span> tCityPage <span class="token operator">=</span> tCityRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>predicate<span class="token punctuation">,</span> pageRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<br> 
<h2>
<a id="Querydsl_SQL__1018"></a>Querydsl SQL 查询</h2> 
<p>Querydsl SQL 模块提供与 JDBC API 的集成。可以使用更多的 JDBC SQL方法。比如可以实现 <strong>from 的查询主体为子查询出来的临时表</strong>、<strong>union</strong>、<strong>union All</strong> 等Querydsl-JPA限制的相关操作。还可以根据 JDBC API 获取数据库的类型使用不同的数据库语法模板。</p> 
<h3>
<a id="_1022"></a>依赖及配置</h3> 
<p><strong>依赖：</strong></p> 
<pre><code class="prism language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.querydsl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>querydsl-sql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${querydsl.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- joda-time为querydsl-sql中必需的新版本的时间日期处理库 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>joda-time<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>joda-time<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.10.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>yaml配置：</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">com.querydsl.sql</span><span class="token punctuation">:</span> debug		<span class="token comment"># 打印日志</span>
</code></pre> 
<br> 
<h3>
<a id="SQLQuery__Q__1050"></a>SQLQuery 的 Q 类</h3> 
<p>需要自己创建编写（可以基于apt 插件生成的 JPA 的Q类改造），并放到主目录（src）启动类下的包里。</p> 
<ul>
<li> <p>使用 <code>extends RelationalPathBase&lt;Entity&gt;</code> 的Q类。<strong>推荐</strong></p> <p>需要将<strong>数据库表名</strong>传入构造方法的<code>table</code>参数里，<code>path</code> 可以传别名，所有的<code>property</code>参数为实体类的属性名（驼峰命名），<code>addMetadata()</code> 中<code>ColumnMetadata.named("FeildNmae")</code> 的 <code>FeildNmae</code> 为数据库字段名。</p> <p>使用该Q类查询所有字段数据时（即select(Q类)）可以自动映射封装结果集。</p> </li>
<li> <p>使用<code>extends EntityPathBase&lt;Entity&gt;</code>的Q类。</p> <p>需要将传入构造方法的<code>variable</code>参数改成<strong>数据库表名</strong>，并且将所有的<code>property</code>参数改成相对应的<strong>数据库字段名</strong>。</p> <p>**注意：**使用 <code>extends EntityPathBase&lt;Entity&gt;</code> 的实体Q类，直接 <code>select(Q类)</code> 会报错，无法自动映射封装结果集，需要使用<code>Projections.bean(Entity.class，Expression&lt;?&gt;... exprs)</code> 手动封装结果集。</p> </li>
</ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * extends RelationalPathBase&lt;Entity&gt; 的Q类示例
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QEmployee</span> <span class="token keyword">extends</span> <span class="token class-name">RelationalPathBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Employee</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1394463749655231079L</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">QEmployee</span> employee <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QEmployee</span><span class="token punctuation">(</span><span class="token string">"EMPLOYEE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">NumberPath</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> id <span class="token operator">=</span> <span class="token function">createNumber</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">StringPath</span> firstname <span class="token operator">=</span> <span class="token function">createString</span><span class="token punctuation">(</span><span class="token string">"firstname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">DatePath</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</span><span class="token punctuation">&gt;</span></span> datefield <span class="token operator">=</span> <span class="token function">createDate</span><span class="token punctuation">(</span><span class="token string">"datefield"</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">PrimaryKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Employee</span><span class="token punctuation">&gt;</span></span> idKey <span class="token operator">=</span> <span class="token function">createPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">QEmployee</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">PathMetadataFactory</span><span class="token punctuation">.</span><span class="token function">forVariable</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"PUBLIC"</span><span class="token punctuation">,</span> <span class="token string">"EMPLOYEE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">QEmployee</span><span class="token punctuation">(</span><span class="token class-name">PathMetadata</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> <span class="token string">"PUBLIC"</span><span class="token punctuation">,</span> <span class="token string">"EMPLOYEE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">addMetadata</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token class-name">ColumnMetadata</span><span class="token punctuation">.</span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">"ID"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ofType</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addMetadata</span><span class="token punctuation">(</span>firstname<span class="token punctuation">,</span> <span class="token class-name">ColumnMetadata</span><span class="token punctuation">.</span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">"FIRSTNAME"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ofType</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token constant">VARCHAR</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addMetadata</span><span class="token punctuation">(</span>datefield<span class="token punctuation">,</span> <span class="token class-name">ColumnMetadata</span><span class="token punctuation">.</span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">"DATEFIELD"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ofType</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">/**
 * extends EntityPathBase&lt;Entity&gt; 的Q类示例
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QUserAddressS</span> <span class="token keyword">extends</span> <span class="token class-name">EntityPathBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAddress</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1295712525L</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">QUserAddressS</span> userAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QUserAddressS</span><span class="token punctuation">(</span><span class="token string">"tb_user_address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">NumberPath</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> id <span class="token operator">=</span> <span class="token function">createNumber</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">StringPath</span> address <span class="token operator">=</span> <span class="token function">createString</span><span class="token punctuation">(</span><span class="token string">"address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">DateTimePath</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</span><span class="token punctuation">&gt;</span></span> createTime <span class="token operator">=</span> <span class="token function">createDateTime</span><span class="token punctuation">(</span><span class="token string">"create_time"</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">QUserAddressS</span><span class="token punctuation">(</span><span class="token class-name">String</span> variable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">UserAddress</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token function">forVariable</span><span class="token punctuation">(</span>variable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">QUserAddressS</span><span class="token punctuation">(</span><span class="token class-name">Path</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">UserAddress</span><span class="token punctuation">&gt;</span></span> path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">QUserAddressS</span><span class="token punctuation">(</span><span class="token class-name">PathMetadata</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">UserAddress</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<br> 
<h3>
<a id="SQLQueryFactory__1134"></a>SQLQueryFactory 方式</h3> 
<h4>
<a id="_1136"></a>装配及基本使用</h4> 
<p><strong>装配</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryDslConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SQLQueryFactory</span> <span class="token function">sqlQueryFactory</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> druidDataSource<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SQLTemplates</span> t<span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> druidDataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLTemplatesRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTemplates</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t <span class="token operator">=</span> <span class="token class-name">SQLTemplates</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>querydsl<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>querydsl<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>Configuration</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        configuration<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SQLBaseListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token class-name">SQLListenerContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token function">isConnectionTransactional</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> druidDataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 若非事务连接</span>
                    <span class="token class-name">SQLCloseListener</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configuration<span class="token punctuation">.</span><span class="token function">setExceptionTranslator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpringExceptionTranslator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建SQLQueryFactory，且数据库连接由spring管理</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SQLQueryFactory</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>druidDataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>注入</strong></p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SQLQueryFactory</span> sqlQueryFactory<span class="token punctuation">;</span>
</code></pre> 
<p><strong>SQLQueryFactory 基本使用</strong></p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * 子查询作为临时表传入from()中
     */</span>
	<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selectBySqlQueryFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用 extends RelationalPathBase&lt;Entity&gt; 的QEntity，自动映射封装</span>
        <span class="token class-name">QUserAddressSql</span> uaSql <span class="token operator">=</span> <span class="token class-name">QUserAddressSql</span><span class="token punctuation">.</span>userAddress<span class="token punctuation">;</span>

        <span class="token comment">// 子查询</span>
        <span class="token class-name">SQLQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> <span class="token class-name">SQLExpressions</span>
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
                <span class="token comment">// 查询字段须是数据库表中的字段名（不是实体属性名），且类型一致</span>
                uaSql<span class="token punctuation">.</span>addressee
                <span class="token punctuation">,</span> uaSql<span class="token punctuation">.</span>userId
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>uaSql<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> fetch <span class="token operator">=</span> sqlQueryFactory
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
                <span class="token comment">// 查询字段须是临时表中的字段别名，且类型一致</span>
                <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"q.addressee"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"addressee"</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">numberTemplate</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"q.user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">stringPath</span><span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// 子查询作为临时表</span>
            <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fetch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 子查询结果集 union
     */</span>
	<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selectBySqlQueryFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用 extends EntityPathBase&lt;Entity&gt; 的改造版QEntity，结果集如需封装到实体类，必须手动指定实体类来接收</span>
        <span class="token class-name">QUserAddressSql</span> uaSql <span class="token operator">=</span> <span class="token class-name">QUserAddressSql</span><span class="token punctuation">.</span>userAddress<span class="token punctuation">;</span>
        <span class="token class-name">QUserSql</span> uSql <span class="token operator">=</span> <span class="token class-name">QUserSql</span><span class="token punctuation">.</span>user<span class="token punctuation">;</span>
        
        <span class="token class-name">SQLQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> a <span class="token operator">=</span> <span class="token class-name">SQLExpressions</span>
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>uaSql<span class="token punctuation">.</span>userId<span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> uaSql<span class="token punctuation">.</span>phone<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>uaSql<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>uaSql<span class="token punctuation">.</span>userId<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SQLQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> b <span class="token operator">=</span> <span class="token class-name">SQLExpressions</span>
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>uSql<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> uSql<span class="token punctuation">.</span>phone<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>uSql<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>uSql<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>uSql<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Union</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> union <span class="token operator">=</span> sqlQueryFactory<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">long</span> count <span class="token operator">=</span> sqlQueryFactory
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>union<span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">stringPath</span><span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fetchCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAddressDTO</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> sqlQueryFactory
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>union<span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">stringPath</span><span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">numberPath</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">stringTemplate</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>
                <span class="token class-name">GroupBy</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"q.user_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>
                    <span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">bean</span><span class="token punctuation">(</span><span class="token class-name">UserAddressDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span>
                        <span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"q.user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">,</span> <span class="token class-name">GroupBy</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">Projections</span><span class="token punctuation">.</span><span class="token function">bean</span><span class="token punctuation">(</span><span class="token class-name">UserAddress</span><span class="token punctuation">.</span><span class="token keyword">class</span>
                            <span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">stringTemplate</span><span class="token punctuation">(</span><span class="token string">"q.phone"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"userAddresses"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<br> 
<h4>
<a id="SQLExpression__1256"></a>SQLExpression 表达式工具类</h4> 
<pre><code class="prism language-java"><span class="token comment">// 合并多张表记录。union为去重合并，unionAll为不去重合并</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Union</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">union</span><span class="token punctuation">(</span><span class="token class-name">SubQueryExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> sq<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Union</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">union</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SubQueryExpression</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sq<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Union</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">unionAll</span><span class="token punctuation">(</span><span class="token class-name">SubQueryExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> sq<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Union</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">unionAll</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SubQueryExpression</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sq<span class="token punctuation">)</span>


<span class="token comment">// 调用函数查询序列</span>
<span class="token keyword">static</span> <span class="token class-name">SimpleExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">nextval</span><span class="token punctuation">(</span><span class="token class-name">String</span> sequence<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Number</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SimpleExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">nextval</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">String</span> sequence<span class="token punctuation">)</span>
<span class="token comment">// 使用示例：SQL写法：select seq_process_no.nextval from dual;</span>
<span class="token class-name">Long</span> nextvalReturn <span class="token operator">=</span> sqlQueryFactory<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">SQLExpressions</span><span class="token punctuation">.</span><span class="token function">nextval</span><span class="token punctuation">(</span><span class="token string">"序列名"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fetchOne<span class="token punctuation">;</span>


<span class="token comment">// 将多列记录聚合为一列记录。delimiter为分隔符。Oracle数据库专属，其他数据库报错</span>
<span class="token keyword">static</span> <span class="token class-name">WithinGroup</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">listagg</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> expr<span class="token punctuation">,</span> <span class="token class-name">String</span> delimiter<span class="token punctuation">)</span>
<span class="token comment">// 使用示例：</span>
<span class="token class-name">SQLExpression</span><span class="token punctuation">.</span><span class="token function">listagg</span><span class="token punctuation">(</span>qEntity<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">.</span>withinGroup<span class="token punctuation">.</span><span class="token function">OrderBy</span><span class="token punctuation">(</span>qEntity<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getValue<span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"Name"</span><span class="token punctuation">)</span>

<span class="token comment">// 将多列记录聚合为一列记录。separator为分隔符。MySQL、PostgreSQL都可用，PostgreSQL会根据模板翻译成String_agg函数</span>
<span class="token keyword">static</span> <span class="token class-name">StringExpression</span> <span class="token function">groupConcat</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> expr<span class="token punctuation">,</span> <span class="token class-name">String</span> separator<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token class-name">StringExpression</span> <span class="token function">groupConcat</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> expr<span class="token punctuation">)</span>
    

<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RelationalFunctionCall</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">relationalFunctionCall</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">String</span> function<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>


<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">DateExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token class-name">DateTimeExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> dateTime<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">DateExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">DateTimeExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dateTime<span class="token punctuation">)</span>
    
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">DateTimeExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token function">dateadd</span><span class="token punctuation">(</span><span class="token class-name">DatePart</span> unit<span class="token punctuation">,</span> <span class="token class-name">DateTimeExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> date<span class="token punctuation">,</span> <span class="token keyword">int</span> amount<span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">DateExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token function">dateadd</span><span class="token punctuation">(</span><span class="token class-name">DatePart</span> unit<span class="token punctuation">,</span> <span class="token class-name">DateExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> date<span class="token punctuation">,</span> <span class="token keyword">int</span> amount<span class="token punctuation">)</span>

<span class="token comment">// 获取两个日期的时间间隔(end-start)</span>
<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">NumberExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">datediff</span><span class="token punctuation">(</span><span class="token class-name">DatePart</span> unit<span class="token punctuation">,</span> <span class="token class-name">DateTimeExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> start<span class="token punctuation">,</span> <span class="token class-name">DateTimeExpression</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> end<span class="token punctuation">)</span>
</code></pre> 
<br> 
<h3>
<a id="JPASQLQuery__1298"></a>JPASQLQuery 方式</h3> 
<p>使用 JPASQLQuery 作为查询引擎时，使用的<code>QEntity（extends EntityPathBase&lt;Entity&gt;）</code>，传入构造方法的 <code>variable</code> 参数可以不为数据库表名（因为 JPASQLQuery 可以找到映射的真实表名，仅把此参数作为表别名），但所有的 <code>property</code> 参数仍必需为相对应的<strong>数据库字段名</strong>。</p> 
<p>故并不能直接使用 apt 插件生成 的 jpa 使用的 <code>Q类</code>，仍需要使用改造版的 <code>Q类（extends EntityPathBase&lt;Entity&gt;）</code>。</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selectBySqlQueryFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用 extends EntityPathBase&lt;Entity&gt; 的改造版QEntity，结果集如需封装到实体类，必须手动指定实体类来接收</span>
        <span class="token class-name">QUserAddress</span> ua <span class="token operator">=</span> <span class="token class-name">QUserAddress</span><span class="token punctuation">.</span>userAddress<span class="token punctuation">;</span>
        <span class="token comment">// jpa+sql的查询工具，本例使用的oracle的sql模板</span>
        <span class="token class-name">JPASQLQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> jpasqlQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JPASQLQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>em<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OracleTemplates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 子查询</span>
        <span class="token class-name">SQLQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> <span class="token class-name">SQLExpressions</span>
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
                <span class="token comment">// 查询字段须是数据库表中的字段名（不是实体属性名），且类型一致。如直接不使用QEntity的属性，则需手动指定</span>
                <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">stringPath</span><span class="token punctuation">(</span><span class="token string">"addressee"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"addressee"</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">numberPath</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>ua<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> fetch <span class="token operator">=</span> jpasqlQuery
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
                <span class="token comment">// 查询字段须是临时表中的字段名或别名，且类型一致。结果集字段需添加别名手动映射封装</span>
                <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"q.addressee"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"addressee"</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">numberTemplate</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"q.user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token class-name">Expressions</span><span class="token punctuation">.</span><span class="token function">stringPath</span><span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// 子查询作为临时表</span>
            <span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fetch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>