<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>【SEED Labs 2.0】Transport Layer Security (TLS) Lab - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【SEED Labs 2.0】Transport Layer Security (TLS) Lab</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <p>本文为 <a href="https://seedsecuritylabs.org/Labs_20.04/Crypto/Crypto_TLS/">SEED Labs 2.0 - Transport Layer Security (TLS) Lab</a> 的实验记录。</p> 
<p></p> 
<div class="toc"> 
 <h3>文章目录</h3> 
 <ul>
<li><a href="#_3">实验原理</a></li>
<li><a href="#Task_1_TLS_Client_14">Task 1: TLS Client</a></li>
<li>
<ul>
<li><a href="#Task_1a_TLS_handshake_16">Task 1.a: TLS handshake</a></li>
<li><a href="#Task_1b_CAs_Certificate_161">Task 1.b: CA’s Certificate</a></li>
<li><a href="#Task_1c_Experiment_with_the_hostname_check_272">Task 1.c: Experiment with the hostname check</a></li>
<li><a href="#Task_1d_Sending_and_getting_Data_368">Task 1.d: Sending and getting Data</a></li>
</ul> 
  </li>
<li><a href="#Task_2_TLS_Server_449">Task 2: TLS Server</a></li>
<li>
<ul>
<li><a href="#Task_2a_Implement_a_simple_TLS_server_461">Task 2.a. Implement a simple TLS server</a></li>
<li><a href="#Task_2b_Testing_the_server_program_using_browsers_627">Task 2.b. Testing the server program using browsers</a></li>
<li><a href="#Task_2c_Certificate_with_multiple_names_636">Task 2.c. Certificate with multiple names</a></li>
</ul> 
  </li>
<li><a href="#Task_3_A_Simple_HTTPS_Proxy_736">Task 3: A Simple HTTPS Proxy</a></li>
<li><a href="#_885">实验总结</a></li>
</ul> 
</div> 
<p></p> 
<h1>
<a id="_3"></a>实验原理</h1> 
<p>现在越来越多的数据传输是通过互联网完成的。然而，当数据通过这种不受保护的公共网络传输时，它们可以被其他人读取甚至篡改。密码算法有很多种，即使是同一种算法，也有很多参数可以使用。为了实现互操作性，即允许不同的应用程序相互通信，这些应用程序需要遵循一个共同的标准。 TLS，Transport Layer Security，就是这样一个标准。如今，大多数 Web 服务器都使用 HTTPS，它建立在 TLS 之上。<br> 本实验的目的是了解 TLS 的工作原理以及如何在编程中使用 TLS。我们实现一对TLS客户端和服务器程序，并在此基础上进行一系列实验，从而了解TLS协议底层的安全原理。我们还将实施一个简单的 HTTPS 代理程序，以了解如果某些受信任的 CA 遭到破坏时的安全影响。实验室涵盖以下主题：<br> • 公钥基础设施 (PKI)<br> • 传输层安全 (TLS)<br> • TLS 编程<br> • HTTPS 代理<br> • 扩展的 X.509 证书<br> • 中间人攻击</p> 
<h1>
<a id="Task_1_TLS_Client_14"></a>Task 1: TLS Client</h1> 
<h2>
<a id="Task_1a_TLS_handshake_16"></a>Task 1.a: TLS handshake</h2> 
<p>编写代码 <code>handshake.py</code>：</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> ssl
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> pprint

hostname <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
port <span class="token operator">=</span> <span class="token number">443</span>
cadir <span class="token operator">=</span> <span class="token string">'/etc/ssl/certs'</span>
<span class="token comment">#cadir = './client-certs'</span>

<span class="token comment"># Set up the TLS context</span>
context <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_TLS_CLIENT<span class="token punctuation">)</span>  <span class="token comment"># For Ubuntu 20.04 VM</span>
<span class="token comment"># context = ssl.SSLContext(ssl.PROTOCOL_TLSv1_2)      # For Ubuntu 16.04 VM</span>

context<span class="token punctuation">.</span>load_verify_locations<span class="token punctuation">(</span>capath<span class="token operator">=</span>cadir<span class="token punctuation">)</span>
context<span class="token punctuation">.</span>verify_mode <span class="token operator">=</span> ssl<span class="token punctuation">.</span>CERT_REQUIRED
context<span class="token punctuation">.</span>check_hostname <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># Create TCP connection</span>
sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"After making TCP connection. Press any key to continue ..."</span><span class="token punctuation">)</span>

<span class="token comment"># Add the TLS</span>
ssock <span class="token operator">=</span> context<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>sock<span class="token punctuation">,</span> server_hostname<span class="token operator">=</span>hostname<span class="token punctuation">,</span>
                            do_handshake_on_connect<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
ssock<span class="token punctuation">.</span>do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># Start the handshake</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== Cipher used: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ssock<span class="token punctuation">.</span>cipher<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== Server hostname: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ssock<span class="token punctuation">.</span>server_hostname<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== Server certificate:"</span><span class="token punctuation">)</span>
pprint<span class="token punctuation">.</span>pprint<span class="token punctuation">(</span>ssock<span class="token punctuation">.</span>getpeercert<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
pprint<span class="token punctuation">.</span>pprint<span class="token punctuation">(</span>context<span class="token punctuation">.</span>get_ca_certs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"After TLS handshake. Press any key to continue ..."</span><span class="token punctuation">)</span>

<span class="token comment"># Close the TLS Connection</span>
ssock<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SHUT_RDWR<span class="token punctuation">)</span>
ssock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>这段代码的主要作用是先进行 TCP 握手，然后进行 TLS 连接，并输出相关信息。</p> 
<p>我们使用它访问一下东南大学主页：</p> 
<pre><code class="prism language-shell">$ handshake.py www.seu.edu.cn
After making TCP connection. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">=</span> Cipher used: <span class="token punctuation">(</span><span class="token string">'AES256-SHA'</span>, <span class="token string">'SSLv3'</span>, <span class="token number">256</span><span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> Server hostname: www.seu.edu.cn
<span class="token operator">==</span><span class="token operator">=</span> Server certificate:
<span class="token punctuation">{<!-- --></span><span class="token string">'OCSP'</span><span class="token builtin class-name">:</span> <span class="token punctuation">(</span><span class="token string">'http://ocsp.digicert.cn'</span>,<span class="token punctuation">)</span>,
 <span class="token string">'caIssuers'</span><span class="token builtin class-name">:</span> <span class="token punctuation">(</span><span class="token string">'http://cacerts.digicert.cn/GeoTrustRSACNCAG2.crt'</span>,<span class="token punctuation">)</span>,
 <span class="token string">'crlDistributionPoints'</span><span class="token builtin class-name">:</span> <span class="token punctuation">(</span><span class="token string">'http://crl.digicert.cn/GeoTrustRSACNCAG2.crl'</span>,<span class="token punctuation">)</span>,
 <span class="token string">'issuer'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'DigiCert Inc'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'GeoTrust RSA CN CA G2'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
 <span class="token string">'notAfter'</span><span class="token builtin class-name">:</span> <span class="token string">'Jul 10 23:59:59 2023 GMT'</span>,
 <span class="token string">'notBefore'</span><span class="token builtin class-name">:</span> <span class="token string">'Jun  9 00:00:00 2022 GMT'</span>,
 <span class="token string">'serialNumber'</span><span class="token builtin class-name">:</span> <span class="token string">'08102829656C723ABA92C1FA58F0E960'</span>,
 <span class="token string">'subject'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'CN'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'stateOrProvinceName'<span class="token punctuation">,</span> '江苏省'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'localityName'<span class="token punctuation">,</span> '南京市'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> '东南大学'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> '<span class="token operator">*</span>.seu.edu.cn'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
 <span class="token string">'subjectAltName'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span>'DNS'<span class="token punctuation">,</span> '<span class="token operator">*</span>.seu.edu.cn'<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>'DNS'<span class="token punctuation">,</span> 'seu.edu.cn'<span class="token punctuation">))</span></span>,
 <span class="token string">'version'</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'issuer'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'DigiCert Inc'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationalUnitName'<span class="token punctuation">,</span> 'www.digicert.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'DigiCert Global Root CA'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
  <span class="token string">'notAfter'</span><span class="token builtin class-name">:</span> <span class="token string">'Nov 10 00:00:00 2031 GMT'</span>,
  <span class="token string">'notBefore'</span><span class="token builtin class-name">:</span> <span class="token string">'Nov 10 00:00:00 2006 GMT'</span>,
  <span class="token string">'serialNumber'</span><span class="token builtin class-name">:</span> <span class="token string">'083BE056904246B1A1756AC95991C74A'</span>,
  <span class="token string">'subject'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'DigiCert Inc'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'organizationalUnitName'<span class="token punctuation">,</span> 'www.digicert.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'DigiCert Global Root CA'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
  <span class="token string">'version'</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
After TLS handshake. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
</code></pre> 
<blockquote> 
 <p>What is the cipher used between the client and the server?</p> 
</blockquote> 
<pre><code>=== Cipher used: ('AES256-SHA', 'SSLv3', 256)
</code></pre> 
<blockquote> 
 <p>Please print out the server certificate in the program.</p> 
</blockquote> 
<pre><code>{'OCSP': ('http://ocsp.digicert.cn',),
 'caIssuers': ('http://cacerts.digicert.cn/GeoTrustRSACNCAG2.crt',),
 'crlDistributionPoints': ('http://crl.digicert.cn/GeoTrustRSACNCAG2.crl',),
 'issuer': ((('countryName', 'US'),),
            (('organizationName', 'DigiCert Inc'),),
            (('commonName', 'GeoTrust RSA CN CA G2'),)),
 'notAfter': 'Jul 10 23:59:59 2023 GMT',
 'notBefore': 'Jun  9 00:00:00 2022 GMT',
 'serialNumber': '08102829656C723ABA92C1FA58F0E960',
 'subject': ((('countryName', 'CN'),),
             (('stateOrProvinceName', '江苏省'),),
             (('localityName', '南京市'),),
             (('organizationName', '东南大学'),),
             (('commonName', '*.seu.edu.cn'),)),
 'subjectAltName': (('DNS', '*.seu.edu.cn'), ('DNS', 'seu.edu.cn')),
 'version': 3}
</code></pre> 
<blockquote> 
 <p>Explain the purpose of /etc/ssl/certs.</p> 
</blockquote> 
<pre><code class="prism language-shell">$ <span class="token function">ls</span> /etc/ssl/certs
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
 ACCVRAIZ1.pem
 AC_RAIZ_FNMT-RCM.pem
 Actalis_Authentication_Root_CA.pem
 AffirmTrust_Commercial.pem
 AffirmTrust_Networking.pem
 AffirmTrust_Premium.pem
 AffirmTrust_Premium_ECC.pem
 Amazon_Root_CA_1.pem
 Amazon_Root_CA_2.pem
 Amazon_Root_CA_3.pem
 Amazon_Root_CA_4.pem
 Atos_TrustedRoot_2011.pem
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<p>该文件夹中存储了验证证书所需的根 CA。</p> 
<blockquote> 
 <p>Use Wireshark to capture the network traffics during the execution of the program, and explain your observation. In particular, explain which step triggers the TCP handshake, and which step triggers the TLS handshake. Explain the relationship between the TLS handshake and the TCP handshake.</p> 
</blockquote> 
<p>Wireshark 截图如下：</p> 
<p><img src="https://images2.imgbox.com/97/04/sJI6YOUA_o.png" alt="在这里插入图片描述"></p> 
<p>编号 3-5 的部分为 TCP 的三次握手。编号 6-13 的部分为 TLS 握手。客户端首先发送 Client Hello 信息，服务器回复 Server Hello。客户端验证后，发送密钥交换及更改密码规范消息，服务器回复更改密码规范消息。至此，TLS 握手完成，进行后续结束工作。</p> 
<h2>
<a id="Task_1b_CAs_Certificate_161"></a>Task 1.b: CA’s Certificate</h2> 
<p>修改原程序中的：</p> 
<pre><code class="prism language-python">cadir <span class="token operator">=</span> <span class="token string">'./client-certs'</span>
</code></pre> 
<p>然后再次运行：</p> 
<pre><code class="prism language-shell">$ handshake.py www.seu.edu.cn
After making TCP connection. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:
  File <span class="token string">"./handshake.py"</span>, line <span class="token number">29</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
    ssock.do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># Start the handshake</span>
  File <span class="token string">"/usr/lib/python3.8/ssl.py"</span>, line <span class="token number">1309</span>, <span class="token keyword">in</span> do_handshake
    self._sslobj.do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>
ssl.SSLCertVerificationError: <span class="token punctuation">[</span>SSL: CERTIFICATE_VERIFY_FAILED<span class="token punctuation">]</span> certificate verify failed: unable to get <span class="token builtin class-name">local</span> issuer certificate <span class="token punctuation">(</span>_ssl.c:1123<span class="token punctuation">)</span>
</code></pre> 
<p>可以看到，证书验证失败。这是因为没有找到对应的 CA 证书。</p> 
<p>我们在之前有看到：</p> 
<pre><code>[{'issuer': ((('countryName', 'US'),),
             (('organizationName', 'DigiCert Inc'),),
             (('organizationalUnitName', 'www.digicert.com'),),
             (('commonName', 'DigiCert Global Root CA'),)),
</code></pre> 
<p>这里，表明了安全访问东南大学主页所需要的 CA 证书。所以我们需要找到这个证书并放进 <code>client-certs</code> 文件夹中：</p> 
<pre><code class="prism language-shell">$ ll /etc/ssl/certs <span class="token operator">|</span> <span class="token function">grep</span> DigiCert_Global_Root_CA
lrwxrwxrwx <span class="token number">1</span> root root     <span class="token number">27</span> Nov <span class="token number">26</span>  <span class="token number">2020</span> 3513523f.0 -<span class="token operator">&gt;</span> DigiCert_Global_Root_CA.pem
lrwxrwxrwx <span class="token number">1</span> root root     <span class="token number">62</span> Nov <span class="token number">26</span>  <span class="token number">2020</span> DigiCert_Global_Root_CA.pem -<span class="token operator">&gt;</span> /usr/share/ca-certificates/mozilla/DigiCert_Global_Root_CA.crt
$ <span class="token function">cp</span> /usr/share/ca-certificates/mozilla/DigiCert_Global_Root_CA.crt client-certs/DigiCert_Global_Root_CA.crt
</code></pre> 
<p>我们同时需要修正证书的哈希并建立软链接：</p> 
<pre><code class="prism language-shell">$ <span class="token builtin class-name">cd</span> client-certs
$ openssl x509 -in DigiCert_Global_Root_CA.crt -noout -subject_hash
3513523f
$ <span class="token function">ln</span> -s DigiCert_Global_Root_CA.crt 3513523f.0
$ ll
total <span class="token number">8</span>
lrwxrwxrwx <span class="token number">1</span> root root   <span class="token number">27</span> Aug <span class="token number">11</span> 07:50 3513523f.0 -<span class="token operator">&gt;</span> DigiCert_Global_Root_CA.crt
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1338</span> Aug <span class="token number">11</span> 07:44 DigiCert_Global_Root_CA.crt
</code></pre> 
<p>然后我们连接上了 <a href="www.seu.edu.cn">www.seu.edu.cn</a>：</p> 
<pre><code class="prism language-shell">$ handshake.py www.seu.edu.cn
</code></pre> 
<p>得到的结果与前文相同，此处不再重复粘贴。</p> 
<p>我们尝试另一个使用不同证书的网站 <a href="codeforces.com">codeforces.com</a>：</p> 
<pre><code class="prism language-shell">$ handshake.py codeforces.com
After making TCP connection. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">=</span> Cipher used: <span class="token punctuation">(</span><span class="token string">'TLS_AES_256_GCM_SHA384'</span>, <span class="token string">'TLSv1.3'</span>, <span class="token number">256</span><span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> Server hostname: codeforces.com
<span class="token operator">==</span><span class="token operator">=</span> Server certificate:
<span class="token punctuation">{<!-- --></span><span class="token string">'OCSP'</span><span class="token builtin class-name">:</span> <span class="token punctuation">(</span><span class="token string">'http://r3.o.lencr.org'</span>,<span class="token punctuation">)</span>,
 <span class="token string">'caIssuers'</span><span class="token builtin class-name">:</span> <span class="token punctuation">(</span><span class="token string">'http://r3.i.lencr.org/'</span>,<span class="token punctuation">)</span>,
 <span class="token string">'issuer'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> "Let's Encrypt"<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'R3'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
 <span class="token string">'notAfter'</span><span class="token builtin class-name">:</span> <span class="token string">'Oct  5 08:10:08 2022 GMT'</span>,
 <span class="token string">'notBefore'</span><span class="token builtin class-name">:</span> <span class="token string">'Jul  7 08:10:09 2022 GMT'</span>,
 <span class="token string">'serialNumber'</span><span class="token builtin class-name">:</span> <span class="token string">'04EE0F98910E33F9564658EF79DA9C2BA703'</span>,
 <span class="token string">'subject'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'commonName'<span class="token punctuation">,</span> 'codeforces.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 'subjectAltName'<span class="token operator">:</span> <span class="token punctuation">((</span>'DNS'<span class="token punctuation">,</span> '<span class="token operator">*</span>.codeforces.com'<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>'DNS'<span class="token punctuation">,</span> 'codeforces.com'<span class="token punctuation">))</span></span>,
 <span class="token string">'version'</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'issuer'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'Internet Security Research Group'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'ISRG Root X1'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
  <span class="token string">'notAfter'</span><span class="token builtin class-name">:</span> <span class="token string">'Jun  4 11:04:38 2035 GMT'</span>,
  <span class="token string">'notBefore'</span><span class="token builtin class-name">:</span> <span class="token string">'Jun  4 11:04:38 2015 GMT'</span>,
  <span class="token string">'serialNumber'</span><span class="token builtin class-name">:</span> <span class="token string">'8210CFB0D240E3594463E0BB63828B00'</span>,
  <span class="token string">'subject'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'Internet Security Research Group'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'ISRG Root X1'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
  <span class="token string">'version'</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
After TLS handshake. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
</code></pre> 
<p>同样的，我们找到它的 CA 证书并做处理：</p> 
<pre><code class="prism language-shell">$ ll /etc/ssl/certs <span class="token operator">|</span> <span class="token function">grep</span> ISRG_Root_X1           
lrwxrwxrwx <span class="token number">1</span> root root     <span class="token number">16</span> Nov <span class="token number">26</span>  <span class="token number">2020</span> 4042bcee.0 -<span class="token operator">&gt;</span> ISRG_Root_X1.pem
lrwxrwxrwx <span class="token number">1</span> root root     <span class="token number">51</span> Nov <span class="token number">26</span>  <span class="token number">2020</span> ISRG_Root_X1.pem -<span class="token operator">&gt;</span> /usr/share/ca-certificates/mozilla/ISRG_Root_X1.crt
$ <span class="token function">cp</span> /usr/share/ca-certificates/mozilla/ISRG_Root_X1.crt client-certs/ISRG_Root_X1.crt
$ <span class="token builtin class-name">cd</span> client-certs
$ openssl x509 -in ISRG_Root_X1.crt -noout -subject_hash
4042bcee
$ <span class="token function">ln</span> -s ISRG_Root_X1.crt 4042bcee.0
$ <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
$ handshake.py codeforces.com
</code></pre> 
<p>得到的结果与前文相同，此处不再重复粘贴。</p> 
<h2>
<a id="Task_1c_Experiment_with_the_hostname_check_272"></a>Task 1.c: Experiment with the hostname check</h2> 
<p>查看东南大学主页 ip：</p> 
<pre><code class="prism language-shell">$ <span class="token function">dig</span> www.seu.edu.cn

<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">&gt;&gt;</span> DiG <span class="token number">9.16</span>.1-Ubuntu <span class="token operator">&lt;&lt;</span><span class="token operator">&gt;&gt;</span> www.seu.edu.cn
<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd
<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:
<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">&gt;&gt;</span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">56811</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr rd ra<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">2</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span>

<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:
<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags:<span class="token punctuation">;</span> udp: <span class="token number">65494</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:
<span class="token punctuation">;</span>www.seu.edu.cn.			IN	A

<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:
www.seu.edu.cn.		<span class="token number">3600</span>	IN	CNAME	widc142.seu.edu.cn.
widc142.seu.edu.cn.	<span class="token number">3599</span>	IN	A	<span class="token number">58.192</span>.118.142

<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">4</span> msec
<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">127.0</span>.0.53<span class="token comment">#53(127.0.0.53)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Thu Aug <span class="token number">11</span> <span class="token number">16</span>:07:38 CST <span class="token number">2022</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">81</span>
</code></pre> 
<p>修改 hosts：</p> 
<pre><code class="prism language-shell">$ <span class="token function">sudo</span> <span class="token function">vi</span> /etc/hosts
</code></pre> 
<p>依据之前看到的 ip，在 hosts 中添加：</p> 
<pre><code>58.192.118.142 www.nju.edu.cn
</code></pre> 
<p>修改程序，选择是否进行主机名称验证。当 <code>context.check_hostname = True</code> 时，有：</p> 
<pre><code class="prism language-shell">$ handshake.py www.nju.edu.cn
After making TCP connection. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:
  File <span class="token string">"./handshake.py"</span>, line <span class="token number">29</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
    ssock.do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># Start the handshake</span>
  File <span class="token string">"/usr/lib/python3.8/ssl.py"</span>, line <span class="token number">1309</span>, <span class="token keyword">in</span> do_handshake
    self._sslobj.do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>
ssl.SSLCertVerificationError: <span class="token punctuation">[</span>SSL: CERTIFICATE_VERIFY_FAILED<span class="token punctuation">]</span> certificate verify failed: Hostname mismatch, certificate is not valid <span class="token keyword">for</span> <span class="token string">'www.nju.edu.cn'</span><span class="token builtin class-name">.</span> <span class="token punctuation">(</span>_ssl.c:1123<span class="token punctuation">)</span>
</code></pre> 
<p>此时，证书验证失败，因为域名不一致。</p> 
<p>而当 <code>context.check_hostname = False</code> 时，有：</p> 
<pre><code class="prism language-shell">$ handshake.py www.nju.edu.cn
After making TCP connection. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">=</span> Cipher used: <span class="token punctuation">(</span><span class="token string">'AES256-SHA'</span>, <span class="token string">'SSLv3'</span>, <span class="token number">256</span><span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> Server hostname: www.nju.edu.cn
<span class="token operator">==</span><span class="token operator">=</span> Server certificate:
<span class="token punctuation">{<!-- --></span><span class="token string">'OCSP'</span><span class="token builtin class-name">:</span> <span class="token punctuation">(</span><span class="token string">'http://ocsp.digicert.cn'</span>,<span class="token punctuation">)</span>,
 <span class="token string">'caIssuers'</span><span class="token builtin class-name">:</span> <span class="token punctuation">(</span><span class="token string">'http://cacerts.digicert.cn/GeoTrustRSACNCAG2.crt'</span>,<span class="token punctuation">)</span>,
 <span class="token string">'crlDistributionPoints'</span><span class="token builtin class-name">:</span> <span class="token punctuation">(</span><span class="token string">'http://crl.digicert.cn/GeoTrustRSACNCAG2.crl'</span>,<span class="token punctuation">)</span>,
 <span class="token string">'issuer'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'DigiCert Inc'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'GeoTrust RSA CN CA G2'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
 <span class="token string">'notAfter'</span><span class="token builtin class-name">:</span> <span class="token string">'Jul 10 23:59:59 2023 GMT'</span>,
 <span class="token string">'notBefore'</span><span class="token builtin class-name">:</span> <span class="token string">'Jun  9 00:00:00 2022 GMT'</span>,
 <span class="token string">'serialNumber'</span><span class="token builtin class-name">:</span> <span class="token string">'08102829656C723ABA92C1FA58F0E960'</span>,
 <span class="token string">'subject'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'CN'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'stateOrProvinceName'<span class="token punctuation">,</span> '江苏省'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'localityName'<span class="token punctuation">,</span> '南京市'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> '东南大学'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> '<span class="token operator">*</span>.seu.edu.cn'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
 <span class="token string">'subjectAltName'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span>'DNS'<span class="token punctuation">,</span> '<span class="token operator">*</span>.seu.edu.cn'<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>'DNS'<span class="token punctuation">,</span> 'seu.edu.cn'<span class="token punctuation">))</span></span>,
 <span class="token string">'version'</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'issuer'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'DigiCert Inc'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationalUnitName'<span class="token punctuation">,</span> 'www.digicert.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'DigiCert Global Root CA'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
  <span class="token string">'notAfter'</span><span class="token builtin class-name">:</span> <span class="token string">'Nov 10 00:00:00 2031 GMT'</span>,
  <span class="token string">'notBefore'</span><span class="token builtin class-name">:</span> <span class="token string">'Nov 10 00:00:00 2006 GMT'</span>,
  <span class="token string">'serialNumber'</span><span class="token builtin class-name">:</span> <span class="token string">'083BE056904246B1A1756AC95991C74A'</span>,
  <span class="token string">'subject'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'DigiCert Inc'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'organizationalUnitName'<span class="token punctuation">,</span> 'www.digicert.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'DigiCert Global Root CA'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
  <span class="token string">'version'</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
After TLS handshake. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
</code></pre> 
<p>这里就直接验证通过了。由此可见域名检查的重要性。</p> 
<h2>
<a id="Task_1d_Sending_and_getting_Data_368"></a>Task 1.d: Sending and getting Data</h2> 
<p>向上面的程序添加如下代码：</p> 
<pre><code class="prism language-python"><span class="token comment"># Send HTTP Request to Server</span>
request <span class="token operator">=</span> <span class="token string">b"GET / HTTP/1.0rnHost: "</span> <span class="token operator">+</span> 
          hostname<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"rnrn"</span>
ssock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>request<span class="token punctuation">)</span>

<span class="token comment"># Read HTTP Response from Server</span>
response <span class="token operator">=</span> ssock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> response<span class="token punctuation">:</span>
    pprint<span class="token punctuation">.</span>pprint<span class="token punctuation">(</span>response<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b"rn"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> ssock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>Please add the data sending/receiving code to your client program, and report your observation.</p> 
</blockquote> 
<p>执行：</p> 
<pre><code class="prism language-shell">$ handshake.py www.seu.edu.cn
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
After TLS handshake. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>b<span class="token string">'HTTP/1.1 200 OK'</span>,
 b<span class="token string">'Server: nginx/1.16.0'</span>,
 b<span class="token string">'Date: Thu, 11 Aug 2022 08:41:06 GMT'</span>,
 b<span class="token string">'Content-Type: text/html; charset=utf-8'</span>,
 b<span class="token string">'Connection: close'</span>,
 b<span class="token string">'X-Frame-Options: SAMEORIGIN'</span>,
 b<span class="token string">'Frame-Options: SAMEORIGIN'</span>,
 b<span class="token string">'Accept-Ranges: bytes'</span>,
 b<span class="token string">'Vary: Accept-Encoding'</span>,
 b<span class="token string">'Set-Cookie: NSC_xfcqmvt-02-iuuqt=ffffffff0948650745525d5f4f58455e445a4a42366'</span>
 b<span class="token string">'0;expires=Thu, 11-Aug-2022 09:01:08 GMT;path=/;secure;httponly'</span>,
 b<span class="token string">''</span>,
 b<span class="token string">'&lt;!DOCTYPE html&gt;'</span>,
 b<span class="token string">'&lt;html&gt;'</span>,
 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<p>可以看到，成功获取了东南大学主页的页面源码。</p> 
<blockquote> 
 <p>Please modify the HTTP request, so you can fetch an image file of your choice from an HTTPS server</p> 
</blockquote> 
<p>我们尝试获取东南大学主页的校徽图片 <a href="https://www.seu.edu.cn/_upload/tpl/09/bc/2492/template2492/images/logo.png">https://www.seu.edu.cn/_upload/tpl/09/bc/2492/template2492/images/logo.png</a>。</p> 
<p>将 request 语句改为</p> 
<pre><code class="prism language-python">request <span class="token operator">=</span> <span class="token string">b"GET /_upload/tpl/09/bc/2492/template2492/images/logo.png HTTP/1.0rnHost: "</span> <span class="token operator">+</span> hostname<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"rnrn"</span>
</code></pre> 
<p>运行效果如下</p> 
<pre><code class="prism language-shell">$ handshake.py www.seu.edu.cn
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
b<span class="token string">'x89PNG'</span>,
b<span class="token string">'x1anx00x00x00rIHDRx00x00x01x11x00x00x00Xx08x06'</span>
b<span class="token string">'x00x00x00xd2xb4xc3x9ex00x00x00x19tEXtSoftwarex00Adobe ImageReady'</span>
b<span class="token string">'qxc9e&lt;x00x00x03!iTXtXML:com.adobe.xmpx00x00x00x00x00&lt;?xpacket begi'</span>
b<span class="token string">'n="xefxbbxbf" id="W5M0MpCehiHzreSzNTczkc9d"?&gt; &lt;x:xmpmeta xmlns:x="adob'</span>
b<span class="token string">'e:ns:meta/" x:xmptk="Adobe XMP Core 5.5-c014 79.151481, 2013/03/13-12:09:15 '</span>
b<span class="token string">'       "&gt; &lt;rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"&gt; '</span>
b<span class="token string">'&lt;rdf:Description rdf:about="" xmlns:xmp="http://ns.adobe.com/xap/1.0/" xmlns'</span>
b<span class="token string">':xmpMM="http://ns.adobe.com/xap/1.0/mm/" xmlns:stRef="http://ns.adobe.com/xa'</span>
b<span class="token string">'p/1.0/sType/ResourceRef#" xmp:CreatorTool="Adobe Photoshop CC (Windows)" xmp'</span>
b<span class="token string">'MM:InstanceID="xmp.iid:67B7F0CEECC111EA929DA69D6D87DD17" xmpMM:DocumentID="x'</span>
b<span class="token string">'mp.did:67B7F0CFECC111EA929DA69D6D87DD17"&gt; &lt;xmpMM:DerivedFrom stRef:instanceI'</span>
b<span class="token string">'D="xmp.iid:67B7F0CCECC111EA929DA69D6D87DD17" stRef:documentID="xmp.did:67B7F'</span>
b<span class="token string">'0CDECC111EA929DA69D6D87DD17"/&gt; &lt;/rdf:Description&gt; &lt;/rdf:RDF&gt; &lt;/x:xmpmeta&gt; &lt;?'</span>
b<span class="token string">'xpacket end="r"?&gt;x9dxc3x8e'</span><span class="token punctuation"></span>x00<span class="token punctuation"></span>x00/@IDATx<span class="token punctuation"></span>xda<span class="token punctuation"></span>xec<span class="token punctuation"></span>x9d<span class="token punctuation"></span>x07<span class="token punctuation"></span>xb4<span class="token punctuation"></span>x14<span class="token string">'
b'</span><span class="token punctuation"></span>xc5<span class="token punctuation"></span>xd2<span class="token punctuation"></span>xc7<span class="token punctuation"></span>x9bx<span class="token punctuation"></span>xb9H<span class="token punctuation"></span>x14P<span class="token punctuation"></span>xb2<span class="token punctuation"></span>x80D%<span class="token punctuation"></span>x07<span class="token punctuation"></span>x05<span class="token punctuation"></span>x14PQ<span class="token punctuation"></span>x9f<span class="token punctuation"></span>x19<span class="token punctuation"></span>x10<span class="token punctuation"></span>xb3<span class="token punctuation"></span>x82<span class="token punctuation"></span>x8a<span class="token string">'
b'</span><span class="token punctuation"></span>x19<span class="token punctuation"></span>x0c<span class="token punctuation"></span>x18<span class="token punctuation"></span>x9e<span class="token punctuation"></span>x8a<span class="token punctuation"></span>xa0<span class="token punctuation">(</span><span class="token operator">&gt;</span><span class="token punctuation"></span>x10<span class="token comment">#n&amp;Tx0c(xfaxccx01xb3"(xa8x88x08'</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<p>可以看出，我们成功爬取到了图片。</p> 
<h1>
<a id="Task_2_TLS_Server_449"></a>Task 2: TLS Server</h1> 
<p>准备好 PKI 实验中得到的 <code>server.crt</code> 和 <code>server.key</code>，放入 server-certs 文件夹中。</p> 
<p>将 <code>ca.crt</code> 放入 <code>client-certs</code> 文件夹中，并建立软链接：</p> 
<pre><code class="prism language-shell">$ openssl x509 -in ca.crt -noout -subject_hash
dbb9c584
$ <span class="token function">ln</span> -s ca.crt dbb9c584.0
</code></pre> 
<h2>
<a id="Task_2a_Implement_a_simple_TLS_server_461"></a>Task 2.a. Implement a simple TLS server</h2> 
<p>修改 <code>handshake.py</code>；</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> ssl
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> pprint

hostname <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
port <span class="token operator">=</span> <span class="token number">4433</span>
<span class="token comment">#cadir = '/etc/ssl/certs'</span>
cadir <span class="token operator">=</span> <span class="token string">'./client-certs'</span>

<span class="token comment"># Set up the TLS context</span>
context <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_TLS_CLIENT<span class="token punctuation">)</span>  <span class="token comment"># For Ubuntu 20.04 VM</span>
<span class="token comment"># context = ssl.SSLContext(ssl.PROTOCOL_TLSv1_2)      # For Ubuntu 16.04 VM</span>

context<span class="token punctuation">.</span>load_verify_locations<span class="token punctuation">(</span>capath<span class="token operator">=</span>cadir<span class="token punctuation">)</span>
context<span class="token punctuation">.</span>verify_mode <span class="token operator">=</span> ssl<span class="token punctuation">.</span>CERT_REQUIRED
context<span class="token punctuation">.</span>check_hostname <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># Create TCP connection</span>
sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"After making TCP connection. Press any key to continue ..."</span><span class="token punctuation">)</span>

<span class="token comment"># Add the TLS</span>
ssock <span class="token operator">=</span> context<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>sock<span class="token punctuation">,</span> server_hostname<span class="token operator">=</span>hostname<span class="token punctuation">,</span>
                            do_handshake_on_connect<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
ssock<span class="token punctuation">.</span>do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># Start the handshake</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== Cipher used: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ssock<span class="token punctuation">.</span>cipher<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== Server hostname: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ssock<span class="token punctuation">.</span>server_hostname<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== Server certificate:"</span><span class="token punctuation">)</span>
pprint<span class="token punctuation">.</span>pprint<span class="token punctuation">(</span>ssock<span class="token punctuation">.</span>getpeercert<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
pprint<span class="token punctuation">.</span>pprint<span class="token punctuation">(</span>context<span class="token punctuation">.</span>get_ca_certs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"After TLS handshake. Press any key to continue ..."</span><span class="token punctuation">)</span>

<span class="token comment"># Close the TLS Connection</span>
ssock<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SHUT_RDWR<span class="token punctuation">)</span>
ssock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>编写 <code>server.py</code>：</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> ssl
<span class="token keyword">import</span> pprint

html <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
HTTP/1.1 200 OKrnContent-Type: text/htmlrnrn
&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;This is Bank32.com!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
"""</span>

SERVER_CERT <span class="token operator">=</span> <span class="token string">'./server-certs/server.crt'</span>
SERVER_PRIVATE <span class="token operator">=</span> <span class="token string">'./server-certs/server.key'</span>


context <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_TLS_SERVER<span class="token punctuation">)</span>  <span class="token comment"># For Ubuntu 20.04 VM</span>
<span class="token comment"># context = ssl.SSLContext(ssl.PROTOCOL_TLSv1_2)      # For Ubuntu 16.04 VM</span>
context<span class="token punctuation">.</span>load_cert_chain<span class="token punctuation">(</span>SERVER_CERT<span class="token punctuation">,</span> SERVER_PRIVATE<span class="token punctuation">)</span>

sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">4433</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    newsock<span class="token punctuation">,</span> fromaddr <span class="token operator">=</span> sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        ssock <span class="token operator">=</span> context<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>newsock<span class="token punctuation">,</span> server_side<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"TLS connection established"</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> ssock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>              <span class="token comment"># Read data over TLS</span>
        pprint<span class="token punctuation">.</span>pprint<span class="token punctuation">(</span><span class="token string">"Request: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ssock<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>html<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Send data over TLS</span>

        ssock<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SHUT_RDWR<span class="token punctuation">)</span>     <span class="token comment"># Close the TLS connection</span>
        ssock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"TLS connection fails"</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
</code></pre> 
<p>将 <code>www.chenyang2022.com</code> 加入到 client 容器的 hosts 中：</p> 
<pre><code class="prism language-shell">$ <span class="token builtin class-name">echo</span> <span class="token string">"10.9.0.43 www.chenyang2022.com"</span> <span class="token operator">&gt;&gt;</span> /etc/hosts
</code></pre> 
<p>在 server 上运行：</p> 
<pre><code class="prism language-shell">$ server.py
</code></pre> 
<p>在 client 上运行：</p> 
<pre><code class="prism language-shell">$ handshake.py www.chenyang2022.com
</code></pre> 
<p>server 上得到：</p> 
<pre><code class="prism language-shell">Enter PEM pass phrase:
TLS connection established
<span class="token string">"Request: b''"</span>
TLS connection fails
</code></pre> 
<p>client 上得到：</p> 
<pre><code class="prism language-shell">After making TCP connection. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">=</span> Cipher used: <span class="token punctuation">(</span><span class="token string">'TLS_AES_256_GCM_SHA384'</span>, <span class="token string">'TLSv1.3'</span>, <span class="token number">256</span><span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> Server hostname: www.chenyang2022.com
<span class="token operator">==</span><span class="token operator">=</span> Server certificate:
<span class="token punctuation">{<!-- --></span><span class="token string">'issuer'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'commonName'<span class="token punctuation">,</span> 'www.modelCA.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'Model CA LTD.'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
 <span class="token string">'notAfter'</span><span class="token builtin class-name">:</span> <span class="token string">'Aug  6 02:42:42 2032 GMT'</span>,
 <span class="token string">'notBefore'</span><span class="token builtin class-name">:</span> <span class="token string">'Aug  9 02:42:42 2022 GMT'</span>,
 <span class="token string">'serialNumber'</span><span class="token builtin class-name">:</span> <span class="token string">'1001'</span>,
 <span class="token string">'subject'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'Chenyang2022 Inc.'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'www.chenyang2022.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
 <span class="token string">'subjectAltName'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span>'DNS'<span class="token punctuation">,</span> 'www.chenyang2022.com'<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>'DNS'<span class="token punctuation">,</span> 'www.chenyang2022A.com'<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>'DNS'<span class="token punctuation">,</span> 'www.chenyang2022B.com'<span class="token punctuation">))</span></span>,
 <span class="token string">'version'</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'issuer'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'commonName'<span class="token punctuation">,</span> 'www.modelCA.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'Model CA LTD.'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
  <span class="token string">'notAfter'</span><span class="token builtin class-name">:</span> <span class="token string">'Aug  6 02:40:07 2032 GMT'</span>,
  <span class="token string">'notBefore'</span><span class="token builtin class-name">:</span> <span class="token string">'Aug  9 02:40:07 2022 GMT'</span>,
  <span class="token string">'serialNumber'</span><span class="token builtin class-name">:</span> <span class="token string">'2D814C6206ECC85CA0824B1FB708705CB060E83E'</span>,
  <span class="token string">'subject'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'commonName'<span class="token punctuation">,</span> 'www.modelCA.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'Model CA LTD.'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
  <span class="token string">'version'</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
After TLS handshake. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
</code></pre> 
<p>可以看到，这里正常建立了连接。</p> 
<p>而当 <code>handshake.py</code> 中改为 <code>cadir = '/etc/ssl/certs'</code> 后，结果为：</p> 
<pre><code class="prism language-shell">$ handshake.py www.chenyang2022.com
After making TCP connection. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:
  File <span class="token string">"./handshake.py"</span>, line <span class="token number">29</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
    ssock.do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># Start the handshake</span>
  File <span class="token string">"/usr/lib/python3.8/ssl.py"</span>, line <span class="token number">1309</span>, <span class="token keyword">in</span> do_handshake
    self._sslobj.do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>
ssl.SSLCertVerificationError: <span class="token punctuation">[</span>SSL: CERTIFICATE_VERIFY_FAILED<span class="token punctuation">]</span> certificate verify failed: unable to get <span class="token builtin class-name">local</span> issuer certificate <span class="token punctuation">(</span>_ssl.c:1123<span class="token punctuation">)</span>
</code></pre> 
<p>可以看到，正常建立了 TCP 连接，但无法建立 LTS。</p> 
<h2>
<a id="Task_2b_Testing_the_server_program_using_browsers_627"></a>Task 2.b. Testing the server program using browsers</h2> 
<p>由于我们在 PKI 实验中，已经在浏览器里添加了证书信任，故本次无需重复添加。</p> 
<p>我们直接访问 <a href="https://www.chenyang2022.com:4433/">https://www.chenyang2022.com:4433/</a>，可以看到这是受信任的页面：</p> 
<p><img src="https://images2.imgbox.com/fe/22/PVaPkvCN_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="Task_2c_Certificate_with_multiple_names_636"></a>Task 2.c. Certificate with multiple names</h2> 
<p>编写 <code>server_openssl.cnf</code></p> 
<pre><code class="prism language-cnf">[ req ]
prompt = no
distinguished_name = req_distinguished_name
req_extensions = req_ext

[ req_distinguished_name ]
C = US
ST = New York
L = Syracuse
O = Model CA LTD.
CN = www.chenyang2022.com

[ req_ext ]
subjectAltName = @alt_names

[alt_names]
DNS.1 = www.chenyang2022.com
DNS.2 = www.chenyang2020.com
DNS.3 = *.chenyang2022.com
</code></pre> 
<p>这里，由于一些玄学的原因，我们不得不重新生成了 CA 并进行了相关操作，使得其 C、ST、L、O 均与上面的配置文件相同且不得为空。</p> 
<pre><code class="prism language-shell">$ openssl req -newkey rsa:2048 -config ./server_openssl.cnf -batch -sha256 -keyout server.key -out server.csr
</code></pre> 
<p>使用 CA 认证：</p> 
<pre><code class="prism language-shell">$ openssl ca -md sha256 -days <span class="token number">3650</span> -config ./myopenssl.cnf -batch -in server.csr -out server.crt -cert ca.crt -keyfile ca.key
</code></pre> 
<p>我们尝试定义的几个域名，得到：</p> 
<pre><code class="prism language-shell">$ server.py
Enter PEM pass phrase:
TLS connection established
<span class="token string">"Request: b'GET / HTTP/1.0<span class="token entity" title="">\</span>r<span class="token entity" title="">\</span>nHost: www.chenyang2022.com<span class="token entity" title="">\</span>r<span class="token entity" title="">\</span>n<span class="token entity" title="">\</span>r<span class="token entity" title="">\</span>n'"</span>
TLS connection established
<span class="token string">"Request: b'GET / HTTP/1.0<span class="token entity" title="">\</span>r<span class="token entity" title="">\</span>nHost: www.chenyang2020.com<span class="token entity" title="">\</span>r<span class="token entity" title="">\</span>n<span class="token entity" title="">\</span>r<span class="token entity" title="">\</span>n'"</span>
TLS connection established
<span class="token string">"Request: b'GET / HTTP/1.0<span class="token entity" title="">\</span>r<span class="token entity" title="">\</span>nHost: love.chenyang2022.com<span class="token entity" title="">\</span>r<span class="token entity" title="">\</span>n<span class="token entity" title="">\</span>r<span class="token entity" title="">\</span>n'"</span>
</code></pre> 
<pre><code class="prism language-shell">$ handshake.py www.chenyang2022.com
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
$ handshake.py www.chenyang2020.com
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
$ handshake.py love.chenyang2022.com
After making TCP connection. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">=</span> Cipher used: <span class="token punctuation">(</span><span class="token string">'TLS_AES_256_GCM_SHA384'</span>, <span class="token string">'TLSv1.3'</span>, <span class="token number">256</span><span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> Server hostname: love.chenyang2022.com
<span class="token operator">==</span><span class="token operator">=</span> Server certificate:
<span class="token punctuation">{<!-- --></span><span class="token string">'issuer'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'commonName'<span class="token punctuation">,</span> 'www.modelCA.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'Model CA LTD.'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'stateOrProvinceName'<span class="token punctuation">,</span> 'New York'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">((</span>'localityName'<span class="token punctuation">,</span> 'Syracuse'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
 <span class="token string">'notAfter'</span><span class="token builtin class-name">:</span> <span class="token string">'Aug  8 16:59:10 2032 GMT'</span>,
 <span class="token string">'notBefore'</span><span class="token builtin class-name">:</span> <span class="token string">'Aug 11 16:59:10 2022 GMT'</span>,
 <span class="token string">'serialNumber'</span><span class="token builtin class-name">:</span> <span class="token string">'2000'</span>,
 <span class="token string">'subject'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'stateOrProvinceName'<span class="token punctuation">,</span> 'New York'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'Model CA LTD.'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'commonName'<span class="token punctuation">,</span> 'www.chenyang2022.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
 <span class="token string">'subjectAltName'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span>'DNS'<span class="token punctuation">,</span> 'www.chenyang2022.com'<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>'DNS'<span class="token punctuation">,</span> 'www.chenyang2020.com'<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>'DNS'<span class="token punctuation">,</span> '<span class="token operator">*</span>.chenyang2022.com'<span class="token punctuation">))</span></span>,
 <span class="token string">'version'</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'issuer'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'commonName'<span class="token punctuation">,</span> 'www.modelCA.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'Model CA LTD.'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'stateOrProvinceName'<span class="token punctuation">,</span> 'New York'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">((</span>'localityName'<span class="token punctuation">,</span> 'Syracuse'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
  <span class="token string">'notAfter'</span><span class="token builtin class-name">:</span> <span class="token string">'Aug  8 16:58:30 2032 GMT'</span>,
  <span class="token string">'notBefore'</span><span class="token builtin class-name">:</span> <span class="token string">'Aug 11 16:58:30 2022 GMT'</span>,
  <span class="token string">'serialNumber'</span><span class="token builtin class-name">:</span> <span class="token string">'21678FD8BB56C6287E92E511DB8AC615C25B11E0'</span>,
  <span class="token string">'subject'</span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">(</span>'commonName'<span class="token punctuation">,</span> 'www.modelCA.com'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'organizationName'<span class="token punctuation">,</span> 'Model CA LTD.'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'countryName'<span class="token punctuation">,</span> 'US'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'stateOrProvinceName'<span class="token punctuation">,</span> 'New York'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">((</span>'localityName'<span class="token punctuation">,</span> 'Syracuse'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">))</span></span>,
  <span class="token string">'version'</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
After TLS handshake. Press any key to <span class="token builtin class-name">continue</span> <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>b<span class="token string">'nHTTP/1.1 200 OK'</span>,
 b<span class="token string">'Content-Type: text/html'</span>,
 b<span class="token string">''</span>,
 b<span class="token string">'n&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body&gt;&lt;h1&gt;This is Bank32.com!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;n'</span><span class="token punctuation">]</span>
</code></pre> 
<p>可以看出，所有域名都成功了。</p> 
<h1>
<a id="Task_3_A_Simple_HTTPS_Proxy_736"></a>Task 3: A Simple HTTPS Proxy</h1> 
<p>编写 <code>proxy.py</code>：</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/env python3  </span>
<span class="token keyword">import</span> threading  
<span class="token keyword">import</span> ssl  
<span class="token keyword">import</span> socket  
  
cadir <span class="token operator">=</span> <span class="token string">"/etc/ssl/certs"</span>  
  
<span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>ssock_for_browser<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    hostname <span class="token operator">=</span> <span class="token string">"codeforces.com"</span>  
    <span class="token comment"># Make a connection to the real server  </span>
    sock_for_server <span class="token operator">=</span> socket<span class="token punctuation">.</span>create_connection<span class="token punctuation">(</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token comment"># Set up the TLS context  </span>
    context <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_TLS_CLIENT<span class="token punctuation">)</span>  
    context<span class="token punctuation">.</span>load_verify_locations<span class="token punctuation">(</span>capath<span class="token operator">=</span>cadir<span class="token punctuation">)</span>  
    context<span class="token punctuation">.</span>verify_mode <span class="token operator">=</span> ssl<span class="token punctuation">.</span>CERT_REQUIRED  
    context<span class="token punctuation">.</span>check_hostname <span class="token operator">=</span> <span class="token boolean">True</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"sock_for_server"</span><span class="token punctuation">)</span>  
    ssock_for_server <span class="token operator">=</span> context<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>sock_for_server<span class="token punctuation">,</span> server_hostname<span class="token operator">=</span>hostname<span class="token punctuation">,</span> do_handshake_on_connect<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  
    ssock_for_server<span class="token punctuation">.</span>do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>  
      
    request <span class="token operator">=</span> ssock_for_browser<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>  
    <span class="token keyword">if</span> request<span class="token punctuation">:</span>  
        <span class="token comment"># Forward request to server  </span>
        ssock_for_server<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>request<span class="token punctuation">)</span>  
  
    <span class="token comment"># Get response from server, and forward it to browser  </span>
    response <span class="token operator">=</span> ssock_for_server<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>  
    <span class="token keyword">while</span> response<span class="token punctuation">:</span>  
        ssock_for_browser<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token comment"># Forward to browser  </span>
        response <span class="token operator">=</span> ssock_for_server<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>  
      
    ssock_for_browser<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SHUT_RDWR<span class="token punctuation">)</span>  
    ssock_for_browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
     
SERVER_CERT <span class="token operator">=</span> <span class="token string">"./cf.crt"</span>  
SERVER_PRIVATE <span class="token operator">=</span> <span class="token string">"./cf.key"</span>  
context_srv <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_TLS_SERVER<span class="token punctuation">)</span>  
context_srv<span class="token punctuation">.</span>load_cert_chain<span class="token punctuation">(</span>SERVER_CERT<span class="token punctuation">,</span> SERVER_PRIVATE<span class="token punctuation">)</span>  
sock_listen <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  
sock_listen<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
sock_listen<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  
  
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>  
    sock_for_browser<span class="token punctuation">,</span> fromaddr <span class="token operator">=</span> sock_listen<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span>fromaddr<span class="token punctuation">)</span>  
    ssock_for_browser <span class="token operator">=</span> context_srv<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>sock_for_browser<span class="token punctuation">,</span> server_side<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    x <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>process_request<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>ssock_for_browser<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    x<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre> 
<p>然后和上一节生成 <code>server.crt</code> 和 <code>server.key</code> 一样，生成 <code>cf.crt</code> 和 <code>cf.key</code>：</p> 
<pre><code class="prism language-shell">$ openssl req -newkey rsa:2048 -config ./cf_openssl.cnf -batch -sha256 -keyout cf.key -out cf.csr
Generating a RSA private key
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++
writing new private key to <span class="token string">'cf.key'</span>
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
$ openssl ca -md sha256 -days <span class="token number">3650</span> -config ./myopenssl.cnf -batch -in cf.csr -out cf.crt -cert ca.crt -keyfile ca.key
Using configuration from ./myopenssl.cnf
Enter pass phrase <span class="token keyword">for</span> ca.key:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: <span class="token number">8193</span> <span class="token punctuation">(</span>0x2001<span class="token punctuation">)</span>
        Validity
            Not Before: Aug <span class="token number">11</span> <span class="token number">17</span>:19:52 <span class="token number">2022</span> GMT
            Not After <span class="token builtin class-name">:</span> Aug  <span class="token number">8</span> <span class="token number">17</span>:19:52 <span class="token number">2032</span> GMT
        Subject:
            countryName               <span class="token operator">=</span> US
            stateOrProvinceName       <span class="token operator">=</span> New York
            organizationName          <span class="token operator">=</span> Model CA LTD.
            commonName                <span class="token operator">=</span> codeforces.com
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                <span class="token number">27</span>:DA:67:05:10:E9:FC:1A:46:C6:68:B4:D3:F3:AE:4E:1E:BE:EC:65
            X509v3 Authority Key Identifier: 
                keyid:28:63:81:40:6C:07:25:0D:B7:CC:16:F4:57:FF:94:08:1B:D0:C1:19

            X509v3 Subject Alternative Name: 
                DNS:codeforces.com, DNS:codeforces.com/*
Certificate is to be certified <span class="token keyword">until</span> Aug  <span class="token number">8</span> <span class="token number">17</span>:19:52 <span class="token number">2032</span> GMT <span class="token punctuation">(</span><span class="token number">3650</span> days<span class="token punctuation">)</span>

Write out database with <span class="token number">1</span> new entries
Data Base Updated
</code></pre> 
<p>在 <code>/etc/hosts</code> 中添加：</p> 
<pre><code>10.9.0.143 codeforces.com
</code></pre> 
<p>修改 <code>/etc/resolv.cnf</code> 的 <code>nameserver</code> 为 <code>8.8.8.8</code>。</p> 
<p>然后启动：</p> 
<pre><code class="prism language-shell">$ proxy.py
</code></pre> 
<p>访问 <a href="codeforces.com">codeforces.com</a> 可以看到：</p> 
<p><img src="https://images2.imgbox.com/2e/71/984PMbQB_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-shell">$ proxy.py
Enter PEM pass phrase:
<span class="token punctuation">(</span><span class="token string">'10.9.0.1'</span>, <span class="token number">52072</span><span class="token punctuation">)</span>
sock_for_server
<span class="token punctuation">(</span><span class="token string">'10.9.0.1'</span>, <span class="token number">52080</span><span class="token punctuation">)</span>
sock_for_server
<span class="token punctuation">(</span><span class="token string">'10.9.0.1'</span>, <span class="token number">52084</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'10.9.0.1'</span>, <span class="token number">52086</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'10.9.0.1'</span>, <span class="token number">52092</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'10.9.0.1'</span>, <span class="token number">52094</span><span class="token punctuation">)</span>
sock_for_server
sock_for_server
sock_for_server
sock_for_server
</code></pre> 
<p>表明成功添加了 proxy。</p> 
<p>接下来我们进行登录操作并抓包：</p> 
<p><img src="https://images2.imgbox.com/18/1f/swXChq6G_o.png" alt="在这里插入图片描述"></p> 
<p>我们使用 wireshark 连接 proxy，并抓取到相关报文：</p> 
<p><img src="https://images2.imgbox.com/2e/b0/dCZVwDbF_o.png" alt="在这里插入图片描述"></p> 
<p>报文具体的内容涉及个人隐私不放图了。经过简单过滤查找，我们发现 codeforces 的用户名和密码都是明文传输给服务器的，连哈希都没有做。</p> 
<h1>
<a id="_885"></a>实验总结</h1> 
<p>本实验的遇到困难的地方在 task 2.c，要求证书与 CA 的 C、ST 等完全相同才能正常工作，否则会报错。经过查阅发现，这是签发策略导致的。策略通常有三种</p> 
<ul>
<li>匹配：要求申请填写的信息跟CA设置信息必须一致</li>
<li>支持：必须填写这项申请信息</li>
<li>可选：可有可无</li>
</ul> 
<p>而在本实验中使用的是匹配，所以必须和 CA 一模一样。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>