<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>睿智的目标检测60——Pytorch搭建YoloV7目标检测平台 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">睿智的目标检测60——Pytorch搭建YoloV7目标检测平台</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    
                        
                    
                    <p></p>
<div class="toc">
 <h3>睿智的目标检测60——Pytorch搭建YoloV7目标检测平台</h3>
 <ul>
<li><a href="#_2">学习前言</a></li>
<li><a href="#_5">源码下载</a></li>
<li><a href="#YoloV7_8">YoloV7改进的部分（不完全）</a></li>
<li><a href="#YoloV7_22">YoloV7实现思路</a></li>
<li>
<ul>
<li><a href="#_23">一、整体结构解析</a></li>
<li><a href="#_36">二、网络结构解析</a></li>
<li>
<ul>
<li><a href="#1Backbone_37">1、主干网络Backbone介绍</a></li>
<li><a href="#2FPN_245">2、构建FPN特征金字塔进行加强特征提取</a></li>
<li><a href="#3Yolo_Head_369">3、利用Yolo Head获得预测结果</a></li>
</ul>
   </li>
<li><a href="#_671">三、预测结果的解码</a></li>
<li>
<ul>
<li><a href="#1_672">1、获得预测框与得分</a></li>
<li><a href="#2_786">2、得分筛选与非极大抑制</a></li>
</ul>
   </li>
<li><a href="#_895">四、训练部分</a></li>
<li>
<ul>
<li><a href="#1loss_896">1、计算loss所需内容</a></li>
<li><a href="#2_899">2、正样本的匹配过程</a></li>
<li>
<ul>
<li><a href="#a_905">a、匹配先验框与特征点</a></li>
<li><a href="#bSimOTA_1057">b、SimOTA自适应匹配</a></li>
</ul>
    </li>
<li><a href="#3Loss_1279">3、计算Loss</a></li>
</ul>
  </li>
</ul>
  </li>
<li><a href="#YoloV7_1791">训练自己的YoloV7模型</a></li>
<li>
<ul>
<li><a href="#_1796">一、数据集的准备</a></li>
<li><a href="#_1803">二、数据集的处理</a></li>
<li><a href="#_1840">三、开始网络训练</a></li>
<li><a href="#_2057">四、训练结果预测</a></li>
</ul>
 </li>
</ul>
</div>
<p></p> 
<h1>
<a id="_2"></a>学习前言</h1> 
<p>AB哥弄了个YoloV7，我觉得有必要跟进看看，它的concat结构还是第一次见，感觉有点意思。<br> <img src="https://images2.imgbox.com/9c/15/vR5O34lu_o.jpg" alt="在这里插入图片描述"></p> 
<h1>
<a id="_5"></a>源码下载</h1> 
<p>https://github.com/bubbliiiing/yolov7-pytorch<br> 喜欢的可以点个star噢。</p> 
<h1>
<a id="YoloV7_8"></a>YoloV7改进的部分（不完全）</h1> 
<p><strong>1、主干部分：使用了创新的多分支堆叠结构进行特征提取，相比以前的Yolo，模型的跳连接结构更加的密集。使用了创新的下采样结构，使用Maxpooling和步长为2x2的特征并行进行提取与压缩。</strong></p> 
<p><strong>2、加强特征提取部分：同主干部分，加强特征提取部分也使用了多输入堆叠结构进行特征提取，使用Maxpooling和步长为2x2的特征并行进行下采样。</strong></p> 
<p><strong>3、特殊的SPP结构：使用了具有CSP机构的SPP扩大感受野，在SPP结构中引入了CSP结构，该模块具有一个大的残差边辅助优化与特征提取。</strong></p> 
<p><strong>4、自适应多正样本匹配：在YoloV5之前的Yolo系列里面，在训练时每一个真实框对应一个正样本，即在训练时，每一个真实框仅由一个先验框负责预测。YoloV7中为了加快模型的训练效率，增加了正样本的数量，在训练时，每一个真实框可以由多个先验框负责预测。除此之外，对于每个真实框，还会根据先验框调整后的预测框进行iou与种类的计算，获得cost，进而找到最适合该真实框的先验框。</strong></p> 
<p><strong>5、借鉴了RepVGG的结构，在网络的特定部分引入RepConv，fuse后在保证网络x减少网络的参数量</strong></p> 
<p><strong>6、使用了辅助分支辅助收敛，但是在模型较小的YoloV7和YoloV7-X中并没有使用。</strong></p> 
<p><strong>以上并非全部的改进部分，还存在一些其它的改进，这里只列出来了一些我比较感兴趣，而且非常有效的改进。</strong></p> 
<h1>
<a id="YoloV7_22"></a>YoloV7实现思路</h1> 
<h2>
<a id="_23"></a>一、整体结构解析</h2> 
<p><img src="https://images2.imgbox.com/31/f7/8MQJMIoS_o.png" alt="在这里插入图片描述"><br> 在学习YoloV7之前，我们需要对YoloV7所作的工作有一定的了解，这有助于我们后面去了解网络的细节，YoloV7在预测方式上与之前的Yolo并没有多大的差别，依然分为三个部分。</p> 
<p><strong>分别是Backbone，FPN以及Yolo Head</strong>。</p> 
<p><strong>Backbone是YoloV7的主干特征提取网络</strong>，输入的图片首先会在主干网络里面进行<strong>特征提取</strong>，提取到的特征可以被称作特征层，<strong>是输入图片的特征集合</strong>。在主干部分，我们<strong>获取了三个特征层</strong>进行下一步网络的构建，这三个特征层我称它为<strong>有效特征层</strong>。</p> 
<p><strong>FPN是YoloV7的加强特征提取网络</strong>，在主干部分获得的三个<strong>有效特征层</strong>会在这一部分进行特征融合，特征融合的目的是结合不同尺度的特征信息。在FPN部分，已经获得的<strong>有效特征层</strong>被用于继续提取特征。<strong>在YoloV7里依然使用到了Panet的结构，我们不仅会对特征进行上采样实现特征融合，还会对特征再次进行下采样实现特征融合。</strong></p> 
<p><strong>Yolo Head是YoloV7的分类器与回归器</strong>，通过Backbone和FPN，我们已经可以获得三个加强过的有效特征层。每一个特征层都有宽、高和通道数，此时我们可以将<strong>特征图看作一个又一个特征点的集合</strong>，每个特征点上有三个先验框，<strong>每一个先验框都有通道数个特征</strong>。Yolo Head实际上所做的工作就是<strong>对特征点进行判断</strong>，判断<strong>特征点上的先验框是否有物体与其对应</strong>。与以前版本的Yolo一样，YoloV7所用的解耦头是一起的，也就是分类和回归在一个1X1卷积里实现。</p> 
<p>因此，整个YoloV7网络所作的工作就是 <strong>特征提取-特征加强-预测先验框对应的物体情况</strong>。</p> 
<h2>
<a id="_36"></a>二、网络结构解析</h2> 
<h3>
<a id="1Backbone_37"></a>1、主干网络Backbone介绍</h3> 
<p><img src="https://images2.imgbox.com/31/f7/8MQJMIoS_o.png" alt="在这里插入图片描述"></p> 
<p>YoloV7所使用的主干特征提取网络具有两个重要特点：<br> 1、使用了<strong>多分支堆叠模块</strong>，这个模块其实论文里没有命名，但是我在分析源码后认为这个名字非常合适，在本博文中，多分支堆叠模块如图所示。<br> 看了这幅图大家应该明白为什么我把这个模块称为多分支堆叠模块，因为在该模块中，最终堆叠模块的输入包含多个分支，<strong>左一为一个卷积标准化激活函数，左二为一个卷积标准化激活函数，右二为三个卷积标准化激活函数，右一为五个卷积标准化激活函数。</strong><br> 四个特征层在堆叠后会再次进行一个卷积标准化激活函数来特征整合。<br> <img src="https://images2.imgbox.com/80/a2/sRjbLU2j_o.png" alt="在这里插入图片描述" width="800"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Multi_Concat_Block</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Multi_Concat_Block<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        c_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>c2 <span class="token operator">*</span> e<span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>ids <span class="token operator">=</span> ids
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>Conv<span class="token punctuation">(</span>c_ <span class="token keyword">if</span> i <span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">else</span> c2<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv4 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_ <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> c2 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
        x_all <span class="token operator">=</span> <span class="token punctuation">[</span>x_1<span class="token punctuation">,</span> x_2<span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            x_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv3<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x_2<span class="token punctuation">)</span>
            x_all<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x_2<span class="token punctuation">)</span>
            
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>cv4<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x_all<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token keyword">for</span> <span class="token builtin">id</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>ids<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
</code></pre> 
<p>如此多的堆叠其实也对应了更密集的残差结构，残差网络的特点是<strong>容易优化</strong>，并且能够通过增加相当的<strong>深度来提高准确率</strong>。其内部的<strong>残差块使用了跳跃连接，缓解了在深度神经网络中增加深度带来的梯度消失问题。</strong></p> 
<p>2、使用创新的过渡模块Transition_Block来进行下采样，在卷积神经网络中，常见的用于下采样的过渡模块是<strong>一个卷积核大小为3x3、步长为2x2的卷积</strong>或者<strong>一个步长为2x2的最大池化</strong>。在YoloV7中，作者将两种过渡模块进行了集合，一个过渡模块存在两个分支，如图所示。左分支是一个步长为2x2的最大池化+一个1x1卷积，右分支是一个1x1卷积+一个卷积核大小为3x3、步长为2x2的卷积，两个分支的结果在输出时会进行堆叠。<br> <img src="https://images2.imgbox.com/39/95/6a0o9dEf_o.png" alt="在这里插入图片描述" width="500"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span>k<span class="token punctuation">,</span> stride<span class="token operator">=</span>k<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>m<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    
<span class="token keyword">class</span> <span class="token class-name">Transition_Block</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Transition_Block<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv3 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c2<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>mp  <span class="token operator">=</span> MP<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>mp<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x_1<span class="token punctuation">)</span>
        
        x_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv3<span class="token punctuation">(</span>x_2<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x_2<span class="token punctuation">,</span> x_1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>整个主干实现代码为：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn


<span class="token keyword">def</span> <span class="token function">autopad</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> p <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> k <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">[</span>x <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> k<span class="token punctuation">]</span> 
    <span class="token keyword">return</span> p

<span class="token keyword">class</span> <span class="token class-name">SiLU</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    
<span class="token keyword">class</span> <span class="token class-name">Conv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span>SiLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ch_in, ch_out, kernel, stride, padding, groups</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Conv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv   <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token punctuation">,</span> s<span class="token punctuation">,</span> autopad<span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>g<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn     <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>c2<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.03</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act    <span class="token operator">=</span> nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">if</span> act <span class="token keyword">is</span> <span class="token boolean">True</span> <span class="token keyword">else</span> <span class="token punctuation">(</span>act <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>act<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span> <span class="token keyword">else</span> nn<span class="token punctuation">.</span>Identity<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">fuseforward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token keyword">class</span> <span class="token class-name">Multi_Concat_Block</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Multi_Concat_Block<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        c_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>c2 <span class="token operator">*</span> e<span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>ids <span class="token operator">=</span> ids
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>Conv<span class="token punctuation">(</span>c_ <span class="token keyword">if</span> i <span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">else</span> c2<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv4 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_ <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> c2 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
        x_all <span class="token operator">=</span> <span class="token punctuation">[</span>x_1<span class="token punctuation">,</span> x_2<span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            x_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv3<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x_2<span class="token punctuation">)</span>
            x_all<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x_2<span class="token punctuation">)</span>
            
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>cv4<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x_all<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token keyword">for</span> <span class="token builtin">id</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>ids<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out

<span class="token keyword">class</span> <span class="token class-name">MP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span>k<span class="token punctuation">,</span> stride<span class="token operator">=</span>k<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>m<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    
<span class="token keyword">class</span> <span class="token class-name">Transition_Block</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Transition_Block<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv3 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c2<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>mp  <span class="token operator">=</span> MP<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>mp<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x_1<span class="token punctuation">)</span>
        
        x_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>cv3<span class="token punctuation">(</span>x_2<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x_2<span class="token punctuation">,</span> x_1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
<span class="token keyword">class</span> <span class="token class-name">Backbone</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> transition_channels<span class="token punctuation">,</span> block_channels<span class="token punctuation">,</span> n<span class="token punctuation">,</span> phi<span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入图片是640, 640, 3</span>
        <span class="token comment">#-----------------------------------------------#</span>
        ids <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        <span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>stem <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Conv<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> transition_channels<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Conv<span class="token punctuation">(</span>transition_channels<span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dark2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> block_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dark3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Transition_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> block_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dark4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Transition_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> block_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dark5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Transition_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> block_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> pretrained<span class="token punctuation">:</span>
            url <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"l"</span> <span class="token punctuation">:</span> <span class="token string">'https://github.com/bubbliiiing/yolov7-pytorch/releases/download/v1.0/yolov7_backbone_weights.pth'</span><span class="token punctuation">,</span>
                <span class="token string">"x"</span> <span class="token punctuation">:</span> <span class="token string">'https://github.com/bubbliiiing/yolov7-pytorch/releases/download/v1.0/yolov7_x_backbone_weights.pth'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
            checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>hub<span class="token punctuation">.</span>load_state_dict_from_url<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">"cpu"</span><span class="token punctuation">,</span> model_dir<span class="token operator">=</span><span class="token string">"./model_data"</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">,</span> strict<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Load weights from "</span> <span class="token operator">+</span> url<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>stem<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dark2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   dark3的输出为80, 80, 256，是一个有效特征层</span>
        <span class="token comment">#-----------------------------------------------#</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dark3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        feat1 <span class="token operator">=</span> x
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   dark4的输出为40, 40, 512，是一个有效特征层</span>
        <span class="token comment">#-----------------------------------------------#</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dark4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        feat2 <span class="token operator">=</span> x
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   dark5的输出为20, 20, 1024，是一个有效特征层</span>
        <span class="token comment">#-----------------------------------------------#</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dark5<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        feat3 <span class="token operator">=</span> x
        <span class="token keyword">return</span> feat1<span class="token punctuation">,</span> feat2<span class="token punctuation">,</span> feat3

</code></pre> 
<h3>
<a id="2FPN_245"></a>2、构建FPN特征金字塔进行加强特征提取</h3> 
<p><img src="https://images2.imgbox.com/31/f7/8MQJMIoS_o.png" alt="在这里插入图片描述"><br> 在特征利用部分，YoloV7提取<strong>多特征层进行目标检测</strong>，一共<strong>提取三个特征层</strong>。<br> 三个特征层位于主干部分的不同位置，分别位于<strong>中间层，中下层，底层</strong>，当输入为(640,640,3)的时候，三个特征层的<strong>shape分别为feat1=(80,80,256)、feat2=(40,40,512)、feat3=(20,20,1024)。</strong></p> 
<p>在获得三个有效特征层后，我们利用这三个有效特征层进行FPN层的构建，构建方式为（在本博文中，将SPPCSPC结构归于FPN中）：</p> 
<ol>
<li>feat3=(20,20,1024)的特征层首先利用SPPCSPC进行特征提取，该结构可以提高YoloV7的感受野，获得P5。</li>
<li>对P5先进行1次1X1卷积调整通道，<strong>然后进行上采样UmSampling2d后与feat2=(40,40,512)进行一次卷积后的特征层进行结合</strong>，然后使用Multi_Concat_Block进行特征提取获得P4，此时获得的特征层为(40,40,512)。</li>
<li>对P4先进行1次1X1卷积调整通道，<strong>然后进行上采样UmSampling2d后与feat1=(80,80,256)进行一次卷积后的特征层进行结合</strong>，然后使用Multi_Concat_Block进行特征提取获得P3_out，此时获得的特征层为(80,80,256)。</li>
<li>P3_out=(80,80,256)的特征层进行一次Transition_Block卷积进行下采样，<strong>下采样后与P4堆叠</strong>，然后使用Multi_Concat_Block进行特征提取P4_out，此时获得的特征层为(40,40,512)。</li>
<li>P4_out=(40,40,512)的特征层进行一次Transition_Block卷积进行下采样，<strong>下采样后与P5堆叠</strong>，然后使用Multi_Concat_Block进行特征提取P5_out，此时获得的特征层为(20,20,1024)。</li>
</ol> 
<p>特征金字塔可以将<strong>不同shape的特征层进行特征融合</strong>，有利于<strong>提取出更好的特征</strong>。</p> 
<pre><code class="prism language-python"><span class="token comment">#---------------------------------------------------#</span>
<span class="token comment">#   yolo_body</span>
<span class="token comment">#---------------------------------------------------#</span>
<span class="token keyword">class</span> <span class="token class-name">YoloBody</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors_mask<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> phi<span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>YoloBody<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   定义了不同yolov7版本的参数</span>
        <span class="token comment">#-----------------------------------------------#</span>
        transition_channels <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        block_channels      <span class="token operator">=</span> <span class="token number">32</span>
        panet_channels      <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        e       <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        n       <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        ids     <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        conv    <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> RepConv<span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> Conv<span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入图片是640, 640, 3</span>
        <span class="token comment">#-----------------------------------------------#</span>

        <span class="token comment">#---------------------------------------------------#   </span>
        <span class="token comment">#   生成主干模型</span>
        <span class="token comment">#   获得三个有效特征层，他们的shape分别是：</span>
        <span class="token comment">#   80, 80, 512</span>
        <span class="token comment">#   40, 40, 1024</span>
        <span class="token comment">#   20, 20, 1024</span>
        <span class="token comment">#---------------------------------------------------#</span>
        self<span class="token punctuation">.</span>backbone   <span class="token operator">=</span> Backbone<span class="token punctuation">(</span>transition_channels<span class="token punctuation">,</span> block_channels<span class="token punctuation">,</span> n<span class="token punctuation">,</span> phi<span class="token punctuation">,</span> pretrained<span class="token operator">=</span>pretrained<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>upsample   <span class="token operator">=</span> nn<span class="token punctuation">.</span>Upsample<span class="token punctuation">(</span>scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"nearest"</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>sppcspc                <span class="token operator">=</span> SPPCSPC<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv_for_P5            <span class="token operator">=</span> Conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv_for_feat2         <span class="token operator">=</span> Conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_upsample1    <span class="token operator">=</span> Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> panet_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> e<span class="token operator">=</span>e<span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv_for_P4            <span class="token operator">=</span> Conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv_for_feat1         <span class="token operator">=</span> Conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_upsample2    <span class="token operator">=</span> Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> panet_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> e<span class="token operator">=</span>e<span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>down_sample1           <span class="token operator">=</span> Transition_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_downsample1  <span class="token operator">=</span> Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> panet_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> e<span class="token operator">=</span>e<span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>down_sample2           <span class="token operator">=</span> Transition_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_downsample2  <span class="token operator">=</span> Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> panet_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> e<span class="token operator">=</span>e<span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rep_conv_1 <span class="token operator">=</span> conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rep_conv_2 <span class="token operator">=</span> conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rep_conv_3 <span class="token operator">=</span> conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>yolo_head_P3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>yolo_head_P4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>yolo_head_P5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">fuse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Fusing layers... '</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> RepConv<span class="token punctuation">)</span><span class="token punctuation">:</span>
                m<span class="token punctuation">.</span>fuse_repvgg_block<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> <span class="token builtin">type</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token keyword">is</span> Conv <span class="token keyword">and</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">'bn'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                m<span class="token punctuation">.</span>conv <span class="token operator">=</span> fuse_conv_and_bn<span class="token punctuation">(</span>m<span class="token punctuation">.</span>conv<span class="token punctuation">,</span> m<span class="token punctuation">.</span>bn<span class="token punctuation">)</span>
                <span class="token builtin">delattr</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">'bn'</span><span class="token punctuation">)</span>
                m<span class="token punctuation">.</span>forward <span class="token operator">=</span> m<span class="token punctuation">.</span>fuseforward
        <span class="token keyword">return</span> self
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#  backbone</span>
        feat1<span class="token punctuation">,</span> feat2<span class="token punctuation">,</span> feat3 <span class="token operator">=</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
        P5          <span class="token operator">=</span> self<span class="token punctuation">.</span>sppcspc<span class="token punctuation">(</span>feat3<span class="token punctuation">)</span>
        P5_conv     <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_for_P5<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        P5_upsample <span class="token operator">=</span> self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P5_conv<span class="token punctuation">)</span>
        P4          <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>conv_for_feat2<span class="token punctuation">(</span>feat2<span class="token punctuation">)</span><span class="token punctuation">,</span> P5_upsample<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P4          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_upsample1<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>

        P4_conv     <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_for_P4<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P4_upsample <span class="token operator">=</span> self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P4_conv<span class="token punctuation">)</span>
        P3          <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>conv_for_feat1<span class="token punctuation">(</span>feat1<span class="token punctuation">)</span><span class="token punctuation">,</span> P4_upsample<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P3          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_upsample2<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>

        P3_downsample <span class="token operator">=</span> self<span class="token punctuation">.</span>down_sample1<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P3_downsample<span class="token punctuation">,</span> P4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_downsample1<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>

        P4_downsample <span class="token operator">=</span> self<span class="token punctuation">.</span>down_sample2<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P4_downsample<span class="token punctuation">,</span> P5<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_downsample2<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        
        P3 <span class="token operator">=</span> self<span class="token punctuation">.</span>rep_conv_1<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> self<span class="token punctuation">.</span>rep_conv_2<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> self<span class="token punctuation">.</span>rep_conv_3<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第三个特征层</span>
        <span class="token comment">#   y3=(batch_size, 75, 80, 80)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out2 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P3<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第二个特征层</span>
        <span class="token comment">#   y2=(batch_size, 75, 40, 40)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out1 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P4<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第一个特征层</span>
        <span class="token comment">#   y1=(batch_size, 75, 20, 20)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out0 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P5<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span>out0<span class="token punctuation">,</span> out1<span class="token punctuation">,</span> out2<span class="token punctuation">]</span>
</code></pre> 
<h3>
<a id="3Yolo_Head_369"></a>3、利用Yolo Head获得预测结果</h3> 
<p><img src="https://images2.imgbox.com/31/f7/8MQJMIoS_o.png" alt="在这里插入图片描述"><br> 利用FPN特征金字塔，<strong>我们可以获得三个加强特征，这三个加强特征的shape分别为(20,20,1024)、(40,40,512)、(80,80,256)，然后我们利用这三个shape的特征层传入Yolo Head获得预测结果。</strong></p> 
<p>与之前Yolo系列不同的是，YoloV7在Yolo Head前使用了一个RepConv的结构，这个RepConv的思想取自于RepVGG，基本思想就是在训练的时候引入特殊的残差结构辅助训练，这个残差结构是经过独特设计的，在实际预测的时候，可以将复杂的残差结构等效于一个普通的3x3卷积，这个时候网络的复杂度就下降了，但网络的预测性能却没有下降。</p> 
<p>而对于每一个特征层，我们可以获得利用一个卷积调整通道数，最终的通道数和需要区分的种类个数相关，在YoloV5里，每一个特征层上每一个特征点存在3个先验框。</p> 
<p><strong>如果使用的是voc训练集，类则为20种，最后的维度应该为75 = 3x25</strong>，三个特征层的shape为(<strong>20,20,75</strong>)，(<strong>40,40,75</strong>)，(<strong>80,80,75</strong>)。<br> 最后的75可以拆分成3个25，对应3个先验框的25个参数，25可以拆分成4+1+20。<br> 前4个参数用于判断每一个特征点的回归参数，回归参数调整后可以获得预测框；<br> 第5个参数用于判断每一个特征点是否包含物体；<br> 最后20个参数用于判断每一个特征点所包含的物体种类。</p> 
<p><strong>如果使用的是coco训练集，类则为80种，最后的维度应该为255 = 3x85</strong>，三个特征层的shape为(<strong>20,20,255</strong>)，(<strong>40,40,255</strong>)，(<strong>80,80,255</strong>)<br> 最后的255可以拆分成3个85，对应3个先验框的85个参数，85可以拆分成4+1+80。<br> 前4个参数用于判断每一个特征点的回归参数，回归参数调整后可以获得预测框；<br> 第5个参数用于判断每一个特征点是否包含物体；<br> 最后80个参数用于判断每一个特征点所包含的物体种类。</p> 
<p>实现代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">from</span> nets<span class="token punctuation">.</span>backbone <span class="token keyword">import</span> Backbone<span class="token punctuation">,</span> Multi_Concat_Block<span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> SiLU<span class="token punctuation">,</span> Transition_Block<span class="token punctuation">,</span> autopad


<span class="token keyword">class</span> <span class="token class-name">RepConv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Represented convolution</span>
    <span class="token comment"># https://arxiv.org/abs/2101.03697</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span>SiLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> deploy<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RepConv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>deploy         <span class="token operator">=</span> deploy
        self<span class="token punctuation">.</span>groups         <span class="token operator">=</span> g
        self<span class="token punctuation">.</span>in_channels    <span class="token operator">=</span> c1
        self<span class="token punctuation">.</span>out_channels   <span class="token operator">=</span> c2
        
        <span class="token keyword">assert</span> k <span class="token operator">==</span> <span class="token number">3</span>
        <span class="token keyword">assert</span> autopad<span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>

        padding_11  <span class="token operator">=</span> autopad<span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span> k <span class="token operator">//</span> <span class="token number">2</span>
        self<span class="token punctuation">.</span>act    <span class="token operator">=</span> nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">if</span> act <span class="token keyword">is</span> <span class="token boolean">True</span> <span class="token keyword">else</span> <span class="token punctuation">(</span>act <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>act<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span> <span class="token keyword">else</span> nn<span class="token punctuation">.</span>Identity<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> deploy<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>rbr_reparam    <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token punctuation">,</span> s<span class="token punctuation">,</span> autopad<span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>g<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>rbr_identity   <span class="token operator">=</span> <span class="token punctuation">(</span>nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>num_features<span class="token operator">=</span>c1<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.03</span><span class="token punctuation">)</span> <span class="token keyword">if</span> c2 <span class="token operator">==</span> c1 <span class="token keyword">and</span> s <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>rbr_dense      <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token punctuation">,</span> s<span class="token punctuation">,</span> autopad<span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>g<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>num_features<span class="token operator">=</span>c2<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.03</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>rbr_1x1        <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> padding_11<span class="token punctuation">,</span> groups<span class="token operator">=</span>g<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>num_features<span class="token operator">=</span>c2<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.03</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"rbr_reparam"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_reparam<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>rbr_identity <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            id_out <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            id_out <span class="token operator">=</span> self<span class="token punctuation">.</span>rbr_identity<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_dense<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>rbr_1x1<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span> <span class="token operator">+</span> id_out<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">get_equivalent_kernel_bias</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kernel3x3<span class="token punctuation">,</span> bias3x3  <span class="token operator">=</span> self<span class="token punctuation">.</span>_fuse_bn_tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_dense<span class="token punctuation">)</span>
        kernel1x1<span class="token punctuation">,</span> bias1x1  <span class="token operator">=</span> self<span class="token punctuation">.</span>_fuse_bn_tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_1x1<span class="token punctuation">)</span>
        kernelid<span class="token punctuation">,</span> biasid    <span class="token operator">=</span> self<span class="token punctuation">.</span>_fuse_bn_tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_identity<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            kernel3x3 <span class="token operator">+</span> self<span class="token punctuation">.</span>_pad_1x1_to_3x3_tensor<span class="token punctuation">(</span>kernel1x1<span class="token punctuation">)</span> <span class="token operator">+</span> kernelid<span class="token punctuation">,</span>
            bias3x3 <span class="token operator">+</span> bias1x1 <span class="token operator">+</span> biasid<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_pad_1x1_to_3x3_tensor</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> kernel1x1<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> kernel1x1 <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>kernel1x1<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_fuse_bn_tensor</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> branch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> branch <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">)</span><span class="token punctuation">:</span>
            kernel      <span class="token operator">=</span> branch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight
            running_mean <span class="token operator">=</span> branch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>running_mean
            running_var <span class="token operator">=</span> branch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>running_var
            gamma       <span class="token operator">=</span> branch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight
            beta        <span class="token operator">=</span> branch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bias
            eps         <span class="token operator">=</span> branch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>eps
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>branch<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"id_tensor"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                input_dim <span class="token operator">=</span> self<span class="token punctuation">.</span>in_channels <span class="token operator">//</span> self<span class="token punctuation">.</span>groups
                kernel_value <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>
                    <span class="token punctuation">(</span>self<span class="token punctuation">.</span>in_channels<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32
                <span class="token punctuation">)</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    kernel_value<span class="token punctuation">[</span>i<span class="token punctuation">,</span> i <span class="token operator">%</span> input_dim<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
                self<span class="token punctuation">.</span>id_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>kernel_value<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>branch<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
            kernel      <span class="token operator">=</span> self<span class="token punctuation">.</span>id_tensor
            running_mean <span class="token operator">=</span> branch<span class="token punctuation">.</span>running_mean
            running_var <span class="token operator">=</span> branch<span class="token punctuation">.</span>running_var
            gamma       <span class="token operator">=</span> branch<span class="token punctuation">.</span>weight
            beta        <span class="token operator">=</span> branch<span class="token punctuation">.</span>bias
            eps         <span class="token operator">=</span> branch<span class="token punctuation">.</span>eps
        std <span class="token operator">=</span> <span class="token punctuation">(</span>running_var <span class="token operator">+</span> eps<span class="token punctuation">)</span><span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span>
        t   <span class="token operator">=</span> <span class="token punctuation">(</span>gamma <span class="token operator">/</span> std<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> kernel <span class="token operator">*</span> t<span class="token punctuation">,</span> beta <span class="token operator">-</span> running_mean <span class="token operator">*</span> gamma <span class="token operator">/</span> std

    <span class="token keyword">def</span> <span class="token function">repvgg_convert</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        kernel<span class="token punctuation">,</span> bias <span class="token operator">=</span> self<span class="token punctuation">.</span>get_equivalent_kernel_bias<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            kernel<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bias<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">fuse_conv_bn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> conv<span class="token punctuation">,</span> bn<span class="token punctuation">)</span><span class="token punctuation">:</span>
        std     <span class="token operator">=</span> <span class="token punctuation">(</span>bn<span class="token punctuation">.</span>running_var <span class="token operator">+</span> bn<span class="token punctuation">.</span>eps<span class="token punctuation">)</span><span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">)</span>
        bias    <span class="token operator">=</span> bn<span class="token punctuation">.</span>bias <span class="token operator">-</span> bn<span class="token punctuation">.</span>running_mean <span class="token operator">*</span> bn<span class="token punctuation">.</span>weight <span class="token operator">/</span> std

        t       <span class="token operator">=</span> <span class="token punctuation">(</span>bn<span class="token punctuation">.</span>weight <span class="token operator">/</span> std<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        weights <span class="token operator">=</span> conv<span class="token punctuation">.</span>weight <span class="token operator">*</span> t

        bn      <span class="token operator">=</span> nn<span class="token punctuation">.</span>Identity<span class="token punctuation">(</span><span class="token punctuation">)</span>
        conv    <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels <span class="token operator">=</span> conv<span class="token punctuation">.</span>in_channels<span class="token punctuation">,</span>
                              out_channels <span class="token operator">=</span> conv<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span>
                              kernel_size <span class="token operator">=</span> conv<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span>
                              stride<span class="token operator">=</span>conv<span class="token punctuation">.</span>stride<span class="token punctuation">,</span>
                              padding <span class="token operator">=</span> conv<span class="token punctuation">.</span>padding<span class="token punctuation">,</span>
                              dilation <span class="token operator">=</span> conv<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span>
                              groups <span class="token operator">=</span> conv<span class="token punctuation">.</span>groups<span class="token punctuation">,</span>
                              bias <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                              padding_mode <span class="token operator">=</span> conv<span class="token punctuation">.</span>padding_mode<span class="token punctuation">)</span>

        conv<span class="token punctuation">.</span>weight <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>weights<span class="token punctuation">)</span>
        conv<span class="token punctuation">.</span>bias   <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>bias<span class="token punctuation">)</span>
        <span class="token keyword">return</span> conv

    <span class="token keyword">def</span> <span class="token function">fuse_repvgg_block</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>deploy<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"RepConv.fuse_repvgg_block"</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rbr_dense  <span class="token operator">=</span> self<span class="token punctuation">.</span>fuse_conv_bn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_dense<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>rbr_dense<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>rbr_1x1    <span class="token operator">=</span> self<span class="token punctuation">.</span>fuse_conv_bn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_1x1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>rbr_1x1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        rbr_1x1_bias    <span class="token operator">=</span> self<span class="token punctuation">.</span>rbr_1x1<span class="token punctuation">.</span>bias
        weight_1x1_expanded <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        <span class="token comment"># Fuse self.rbr_identity</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_identity<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_identity<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>batchnorm<span class="token punctuation">.</span>SyncBatchNorm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            identity_conv_1x1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
                    in_channels<span class="token operator">=</span>self<span class="token punctuation">.</span>in_channels<span class="token punctuation">,</span>
                    out_channels<span class="token operator">=</span>self<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span>
                    kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                    stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                    padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
                    groups<span class="token operator">=</span>self<span class="token punctuation">.</span>groups<span class="token punctuation">,</span> 
                    bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            identity_conv_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">=</span> identity_conv_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
            identity_conv_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">=</span> identity_conv_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
            identity_conv_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fill_<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span>
            identity_conv_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fill_diagonal_<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span>
            identity_conv_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">=</span> identity_conv_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

            identity_conv_1x1           <span class="token operator">=</span> self<span class="token punctuation">.</span>fuse_conv_bn<span class="token punctuation">(</span>identity_conv_1x1<span class="token punctuation">,</span> self<span class="token punctuation">.</span>rbr_identity<span class="token punctuation">)</span>
            bias_identity_expanded      <span class="token operator">=</span> identity_conv_1x1<span class="token punctuation">.</span>bias
            weight_identity_expanded    <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>identity_conv_1x1<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            bias_identity_expanded      <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>rbr_1x1_bias<span class="token punctuation">)</span> <span class="token punctuation">)</span>
            weight_identity_expanded    <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>weight_1x1_expanded<span class="token punctuation">)</span> <span class="token punctuation">)</span>            
        
        self<span class="token punctuation">.</span>rbr_dense<span class="token punctuation">.</span>weight   <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_dense<span class="token punctuation">.</span>weight <span class="token operator">+</span> weight_1x1_expanded <span class="token operator">+</span> weight_identity_expanded<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rbr_dense<span class="token punctuation">.</span>bias     <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rbr_dense<span class="token punctuation">.</span>bias <span class="token operator">+</span> rbr_1x1_bias <span class="token operator">+</span> bias_identity_expanded<span class="token punctuation">)</span>
                
        self<span class="token punctuation">.</span>rbr_reparam    <span class="token operator">=</span> self<span class="token punctuation">.</span>rbr_dense
        self<span class="token punctuation">.</span>deploy         <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>rbr_identity <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>rbr_identity
            self<span class="token punctuation">.</span>rbr_identity <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>rbr_1x1 <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>rbr_1x1
            self<span class="token punctuation">.</span>rbr_1x1 <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>rbr_dense <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>rbr_dense
            self<span class="token punctuation">.</span>rbr_dense <span class="token operator">=</span> <span class="token boolean">None</span>
        
<span class="token comment">#---------------------------------------------------#</span>
<span class="token comment">#   yolo_body</span>
<span class="token comment">#---------------------------------------------------#</span>
<span class="token keyword">class</span> <span class="token class-name">YoloBody</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors_mask<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> phi<span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>YoloBody<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   定义了不同yolov7版本的参数</span>
        <span class="token comment">#-----------------------------------------------#</span>
        transition_channels <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        block_channels      <span class="token operator">=</span> <span class="token number">32</span>
        panet_channels      <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        e       <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        n       <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        ids     <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        conv    <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'l'</span> <span class="token punctuation">:</span> RepConv<span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> Conv<span class="token punctuation">}</span><span class="token punctuation">[</span>phi<span class="token punctuation">]</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入图片是640, 640, 3</span>
        <span class="token comment">#-----------------------------------------------#</span>

        <span class="token comment">#---------------------------------------------------#   </span>
        <span class="token comment">#   生成主干模型</span>
        <span class="token comment">#   获得三个有效特征层，他们的shape分别是：</span>
        <span class="token comment">#   80, 80, 512</span>
        <span class="token comment">#   40, 40, 1024</span>
        <span class="token comment">#   20, 20, 1024</span>
        <span class="token comment">#---------------------------------------------------#</span>
        self<span class="token punctuation">.</span>backbone   <span class="token operator">=</span> Backbone<span class="token punctuation">(</span>transition_channels<span class="token punctuation">,</span> block_channels<span class="token punctuation">,</span> n<span class="token punctuation">,</span> phi<span class="token punctuation">,</span> pretrained<span class="token operator">=</span>pretrained<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>upsample   <span class="token operator">=</span> nn<span class="token punctuation">.</span>Upsample<span class="token punctuation">(</span>scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"nearest"</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>sppcspc                <span class="token operator">=</span> SPPCSPC<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv_for_P5            <span class="token operator">=</span> Conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv_for_feat2         <span class="token operator">=</span> Conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_upsample1    <span class="token operator">=</span> Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> panet_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> e<span class="token operator">=</span>e<span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv_for_P4            <span class="token operator">=</span> Conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv_for_feat1         <span class="token operator">=</span> Conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_upsample2    <span class="token operator">=</span> Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> panet_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> e<span class="token operator">=</span>e<span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>down_sample1           <span class="token operator">=</span> Transition_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_downsample1  <span class="token operator">=</span> Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> panet_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> e<span class="token operator">=</span>e<span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>down_sample2           <span class="token operator">=</span> Transition_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_downsample2  <span class="token operator">=</span> Multi_Concat_Block<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> panet_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> e<span class="token operator">=</span>e<span class="token punctuation">,</span> n<span class="token operator">=</span>n<span class="token punctuation">,</span> ids<span class="token operator">=</span>ids<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rep_conv_1 <span class="token operator">=</span> conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rep_conv_2 <span class="token operator">=</span> conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rep_conv_3 <span class="token operator">=</span> conv<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>yolo_head_P3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>yolo_head_P4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>yolo_head_P5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>transition_channels <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">fuse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Fusing layers... '</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> RepConv<span class="token punctuation">)</span><span class="token punctuation">:</span>
                m<span class="token punctuation">.</span>fuse_repvgg_block<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> <span class="token builtin">type</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token keyword">is</span> Conv <span class="token keyword">and</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">'bn'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                m<span class="token punctuation">.</span>conv <span class="token operator">=</span> fuse_conv_and_bn<span class="token punctuation">(</span>m<span class="token punctuation">.</span>conv<span class="token punctuation">,</span> m<span class="token punctuation">.</span>bn<span class="token punctuation">)</span>
                <span class="token builtin">delattr</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">'bn'</span><span class="token punctuation">)</span>
                m<span class="token punctuation">.</span>forward <span class="token operator">=</span> m<span class="token punctuation">.</span>fuseforward
        <span class="token keyword">return</span> self
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#  backbone</span>
        feat1<span class="token punctuation">,</span> feat2<span class="token punctuation">,</span> feat3 <span class="token operator">=</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
        P5          <span class="token operator">=</span> self<span class="token punctuation">.</span>sppcspc<span class="token punctuation">(</span>feat3<span class="token punctuation">)</span>
        P5_conv     <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_for_P5<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        P5_upsample <span class="token operator">=</span> self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P5_conv<span class="token punctuation">)</span>
        P4          <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>conv_for_feat2<span class="token punctuation">(</span>feat2<span class="token punctuation">)</span><span class="token punctuation">,</span> P5_upsample<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P4          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_upsample1<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>

        P4_conv     <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_for_P4<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P4_upsample <span class="token operator">=</span> self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P4_conv<span class="token punctuation">)</span>
        P3          <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>conv_for_feat1<span class="token punctuation">(</span>feat1<span class="token punctuation">)</span><span class="token punctuation">,</span> P4_upsample<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P3          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_upsample2<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>

        P3_downsample <span class="token operator">=</span> self<span class="token punctuation">.</span>down_sample1<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P3_downsample<span class="token punctuation">,</span> P4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_downsample1<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>

        P4_downsample <span class="token operator">=</span> self<span class="token punctuation">.</span>down_sample2<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P4_downsample<span class="token punctuation">,</span> P5<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_downsample2<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        
        P3 <span class="token operator">=</span> self<span class="token punctuation">.</span>rep_conv_1<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> self<span class="token punctuation">.</span>rep_conv_2<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> self<span class="token punctuation">.</span>rep_conv_3<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第三个特征层</span>
        <span class="token comment">#   y3=(batch_size, 75, 80, 80)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out2 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P3<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第二个特征层</span>
        <span class="token comment">#   y2=(batch_size, 75, 40, 40)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out1 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P4<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第一个特征层</span>
        <span class="token comment">#   y1=(batch_size, 75, 20, 20)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out0 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P5<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span>out0<span class="token punctuation">,</span> out1<span class="token punctuation">,</span> out2<span class="token punctuation">]</span>
</code></pre> 
<h2>
<a id="_671"></a>三、预测结果的解码</h2> 
<h3>
<a id="1_672"></a>1、获得预测框与得分</h3> 
<p>由第二步我们可以获得三个特征层的预测结果，shape分别为(<strong>N,20,20,255</strong>)，(<strong>N,40,40,255</strong>)，(<strong>N,80,80,255</strong>)的数据。</p> 
<p>但是这个预测结果并不对应着最终的预测框在图片上的位置，还需要解码才可以完成。在YoloV5里，每一个特征层上每一个特征点存在3个先验框。</p> 
<p><strong>每个特征层最后的255可以拆分成3个85，对应3个先验框的85个参数</strong>，我们先将其reshape一下，其结果为(<strong>N,20,20,3,85</strong>)，(<strong>N,40.40,3,85</strong>)，(<strong>N,80,80,3,85</strong>)。</p> 
<p><strong>其中的85可以拆分成4+1+80。</strong><br> <strong>前4个参数用于判断每一个特征点的回归参数，回归参数调整后可以获得预测框；<br> 第5个参数用于判断每一个特征点是否包含物体；<br> 最后80个参数用于判断每一个特征点所包含的物体种类。</strong></p> 
<p>以(<strong>N,20,20,3,85</strong>)这个特征层为例，<strong>该特征层相当于将图像划分成20x20个特征点，如果某个特征点落在物体的对应框内，就用于预测该物体。</strong></p> 
<p>如图所示，蓝色的点为20x20的特征点，此时我们对左图黑色点的三个先验框进行解码操作演示：<br> 1、进行中心预测点的计算，<strong>利用Regression预测结果前两个序号的内容对特征点的三个先验框中心坐标进行偏移，偏移后是右图红色的三个点；</strong><br> 2、进行预测框宽高的计算，<strong>利用Regression预测结果后两个序号的内容求指数后获得预测框的宽高；</strong><br> 3、此时获得的预测框就可以绘制在图片上了。<br> <img src="https://images2.imgbox.com/13/3d/zUBcgqSs_o.png" alt="在这里插入图片描述"><br> 除去这样的解码操作，还有非极大抑制的操作需要进行，防止同一种类的框的堆积。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">decode_box</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token builtin">input</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入的input一共有三个，他们的shape分别是</span>
        <span class="token comment">#   batch_size, 255, 20, 20</span>
        <span class="token comment">#   batch_size, 255, 40, 40</span>
        <span class="token comment">#   batch_size, 255, 80, 80</span>
        <span class="token comment">#-----------------------------------------------#</span>
        batch_size      <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        input_height    <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        input_width     <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入为416x416时</span>
        <span class="token comment">#   stride_h = stride_w = 32、16、8</span>
        <span class="token comment">#-----------------------------------------------#</span>
        stride_h <span class="token operator">=</span> self<span class="token punctuation">.</span>input_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> input_height
        stride_w <span class="token operator">=</span> self<span class="token punctuation">.</span>input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> input_width
        <span class="token comment">#-------------------------------------------------#</span>
        <span class="token comment">#   此时获得的scaled_anchors大小是相对于特征层的</span>
        <span class="token comment">#-------------------------------------------------#</span>
        scaled_anchors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>anchor_width <span class="token operator">/</span> stride_w<span class="token punctuation">,</span> anchor_height <span class="token operator">/</span> stride_h<span class="token punctuation">)</span> <span class="token keyword">for</span> anchor_width<span class="token punctuation">,</span> anchor_height <span class="token keyword">in</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入的input一共有三个，他们的shape分别是</span>
        <span class="token comment">#   batch_size, 3, 20, 20, 85</span>
        <span class="token comment">#   batch_size, 3, 40, 40, 85</span>
        <span class="token comment">#   batch_size, 3, 80, 80, 85</span>
        <span class="token comment">#-----------------------------------------------#</span>
        prediction <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                self<span class="token punctuation">.</span>bbox_attrs<span class="token punctuation">,</span> input_height<span class="token punctuation">,</span> input_width<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   先验框的中心位置的调整参数</span>
        <span class="token comment">#-----------------------------------------------#</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
        y <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   先验框的宽高调整参数</span>
        <span class="token comment">#-----------------------------------------------#</span>
        w <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
        h <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   获得置信度，是否有物体</span>
        <span class="token comment">#-----------------------------------------------#</span>
        conf        <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   种类置信度</span>
        <span class="token comment">#-----------------------------------------------#</span>
        pred_cls    <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        FloatTensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>FloatTensor <span class="token keyword">if</span> x<span class="token punctuation">.</span>is_cuda <span class="token keyword">else</span> torch<span class="token punctuation">.</span>FloatTensor
        LongTensor  <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>LongTensor <span class="token keyword">if</span> x<span class="token punctuation">.</span>is_cuda <span class="token keyword">else</span> torch<span class="token punctuation">.</span>LongTensor

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   生成网格，先验框中心，网格左上角 </span>
        <span class="token comment">#   batch_size,3,20,20</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        grid_x <span class="token operator">=</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> input_width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> input_width<span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>input_height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>
            batch_size <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>FloatTensor<span class="token punctuation">)</span>
        grid_y <span class="token operator">=</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> input_height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> input_height<span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>input_width<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>
            batch_size <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>y<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>FloatTensor<span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   按照网格格式生成先验框的宽高</span>
        <span class="token comment">#   batch_size,3,20,20</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        anchor_w <span class="token operator">=</span> FloatTensor<span class="token punctuation">(</span>scaled_anchors<span class="token punctuation">)</span><span class="token punctuation">.</span>index_select<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> LongTensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        anchor_h <span class="token operator">=</span> FloatTensor<span class="token punctuation">(</span>scaled_anchors<span class="token punctuation">)</span><span class="token punctuation">.</span>index_select<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> LongTensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        anchor_w <span class="token operator">=</span> anchor_w<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> input_height <span class="token operator">*</span> input_width<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>w<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        anchor_h <span class="token operator">=</span> anchor_h<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> input_height <span class="token operator">*</span> input_width<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>h<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   利用预测结果对先验框进行调整</span>
        <span class="token comment">#   首先调整先验框的中心，从先验框中心向右下角偏移</span>
        <span class="token comment">#   再调整先验框的宽高。</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        pred_boxes          <span class="token operator">=</span> FloatTensor<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        pred_boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>  <span class="token operator">=</span> x<span class="token punctuation">.</span>data <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid_x
        pred_boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>  <span class="token operator">=</span> y<span class="token punctuation">.</span>data <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid_y
        pred_boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>data <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchor_w
        pred_boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span>h<span class="token punctuation">.</span>data <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchor_h

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   将输出结果归一化成小数的形式</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        _scale <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>input_width<span class="token punctuation">,</span> input_height<span class="token punctuation">,</span> input_width<span class="token punctuation">,</span> input_height<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>FloatTensor<span class="token punctuation">)</span>
        output <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>pred_boxes<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">/</span> _scale<span class="token punctuation">,</span>
                            conf<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pred_cls<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> outputs
</code></pre> 
<h3>
<a id="2_786"></a>2、得分筛选与非极大抑制</h3> 
<p>得到最终的预测结果后还要进行<strong>得分排序与非极大抑制筛选</strong>。</p> 
<p><strong>得分筛选</strong>就是<strong>筛选出得分满足confidence置信度的预测框。</strong><br> <strong>非极大抑制</strong>就是<strong>筛选出一定区域内属于同一种类得分最大的框。</strong></p> 
<p>得分筛选与非极大抑制的过程可以概括如下：<br> 1、找出该图片中<strong>得分大于门限函数的框</strong>。在进行<strong>重合框筛选前就进行得分的筛选可以大幅度减少框的数量。</strong><br> 2、对<strong>种类进行循环</strong>，非极大抑制的作用是<strong>筛选出一定区域内属于同一种类得分最大的框</strong>，对种类进行循环可以<strong>帮助我们对每一个类分别进行非极大抑制。</strong><br> 3、根据得分对该种类进行从大到小排序。<br> 4、每次取出得分最大的框，计算<strong>其与其它所有预测框的重合程度，重合程度过大的则剔除。</strong></p> 
<p>得分筛选与非极大抑制后的结果就可以用于绘制预测框了。</p> 
<p>下图是经过非极大抑制的。<br> <img src="https://images2.imgbox.com/93/c4/8f95h6WV_o.png" alt="在这里插入图片描述" width="400"><br> 下图是未经过非极大抑制的。<br> <img src="https://images2.imgbox.com/47/87/siqiPZdL_o.png" alt="在这里插入图片描述" width="400"><br> 实现代码为：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">non_max_suppression</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> prediction<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span> image_shape<span class="token punctuation">,</span> letterbox_image<span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> nms_thres<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    <span class="token comment">#   将预测结果的格式转换成左上角右下角的格式。</span>
    <span class="token comment">#   prediction  [batch_size, num_anchors, 85]</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    box_corner          <span class="token operator">=</span> prediction<span class="token punctuation">.</span>new<span class="token punctuation">(</span>prediction<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    box_corner<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
    box_corner<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
    box_corner<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
    box_corner<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
    prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> box_corner<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>

    output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>prediction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> image_pred <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>prediction<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   对种类预测部分取max。</span>
        <span class="token comment">#   class_conf  [num_anchors, 1]    种类置信度</span>
        <span class="token comment">#   class_pred  [num_anchors, 1]    种类</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        class_conf<span class="token punctuation">,</span> class_pred <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>image_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   利用置信度进行第一轮筛选</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        conf_mask <span class="token operator">=</span> <span class="token punctuation">(</span>image_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> class_conf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> conf_thres<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   根据置信度进行预测结果的筛选</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        image_pred <span class="token operator">=</span> image_pred<span class="token punctuation">[</span>conf_mask<span class="token punctuation">]</span>
        class_conf <span class="token operator">=</span> class_conf<span class="token punctuation">[</span>conf_mask<span class="token punctuation">]</span>
        class_pred <span class="token operator">=</span> class_pred<span class="token punctuation">[</span>conf_mask<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> image_pred<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token comment">#-------------------------------------------------------------------------#</span>
        <span class="token comment">#   detections  [num_anchors, 7]</span>
        <span class="token comment">#   7的内容为：x1, y1, x2, y2, obj_conf, class_conf, class_pred</span>
        <span class="token comment">#-------------------------------------------------------------------------#</span>
        detections <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>image_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> class_conf<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> class_pred<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment">#------------------------------------------#</span>
        <span class="token comment">#   获得预测结果中包含的所有种类</span>
        <span class="token comment">#------------------------------------------#</span>
        unique_labels <span class="token operator">=</span> detections<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> prediction<span class="token punctuation">.</span>is_cuda<span class="token punctuation">:</span>
            unique_labels <span class="token operator">=</span> unique_labels<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            detections <span class="token operator">=</span> detections<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> c <span class="token keyword">in</span> unique_labels<span class="token punctuation">:</span>
            <span class="token comment">#------------------------------------------#</span>
            <span class="token comment">#   获得某一类得分筛选后全部的预测结果</span>
            <span class="token comment">#------------------------------------------#</span>
            detections_class <span class="token operator">=</span> detections<span class="token punctuation">[</span>detections<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> c<span class="token punctuation">]</span>

            <span class="token comment">#------------------------------------------#</span>
            <span class="token comment">#   使用官方自带的非极大抑制会速度更快一些！</span>
            <span class="token comment">#------------------------------------------#</span>
            keep <span class="token operator">=</span> nms<span class="token punctuation">(</span>
                detections_class<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                detections_class<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> detections_class<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                nms_thres
            <span class="token punctuation">)</span>
            max_detections <span class="token operator">=</span> detections_class<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>
            
            <span class="token comment"># # 按照存在物体的置信度排序</span>
            <span class="token comment"># _, conf_sort_index = torch.sort(detections_class[:, 4]*detections_class[:, 5], descending=True)</span>
            <span class="token comment"># detections_class = detections_class[conf_sort_index]</span>
            <span class="token comment"># # 进行非极大抑制</span>
            <span class="token comment"># max_detections = []</span>
            <span class="token comment"># while detections_class.size(0):</span>
            <span class="token comment">#     # 取出这一类置信度最高的，一步一步往下判断，判断重合程度是否大于nms_thres，如果是则去除掉</span>
            <span class="token comment">#     max_detections.append(detections_class[0].unsqueeze(0))</span>
            <span class="token comment">#     if len(detections_class) == 1:</span>
            <span class="token comment">#         break</span>
            <span class="token comment">#     ious = bbox_iou(max_detections[-1], detections_class[1:])</span>
            <span class="token comment">#     detections_class = detections_class[1:][ious &lt; nms_thres]</span>
            <span class="token comment"># # 堆叠</span>
            <span class="token comment"># max_detections = torch.cat(max_detections).data</span>
            
            <span class="token comment"># Add max detections to outputs</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> max_detections <span class="token keyword">if</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> max_detections<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span>           <span class="token operator">=</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            box_xy<span class="token punctuation">,</span> box_wh      <span class="token operator">=</span> <span class="token punctuation">(</span>output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">-</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>    <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_correct_boxes<span class="token punctuation">(</span>box_xy<span class="token punctuation">,</span> box_wh<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span> image_shape<span class="token punctuation">,</span> letterbox_image<span class="token punctuation">)</span>
    <span class="token keyword">return</span> output
</code></pre> 
<h2>
<a id="_895"></a>四、训练部分</h2> 
<h3>
<a id="1loss_896"></a>1、计算loss所需内容</h3> 
<p>计算loss实际上是网络的预测结果和网络的真实结果的对比。<br> 和网络的预测结果一样，网络的损失也由三个部分组成，分别是Reg部分、Obj部分、Cls部分。Reg部分是特征点的回归参数判断、Obj部分是特征点是否包含物体判断、Cls部分是特征点包含的物体的种类。</p> 
<h3>
<a id="2_899"></a>2、正样本的匹配过程</h3> 
<p>在YoloV7中，训练时正样本的匹配过程可以分为两部分。<br> a、对每个真实框通过坐标与宽高粗略匹配先验框与特征点。<br> b、使用SimOTA自适应精确选取每个真实框对应多少个先验框。</p> 
<p>所谓<strong>正样本匹配</strong>，就是<strong>寻找哪些先验框被认为有对应的真实框，并且负责这个真实框的预测</strong>。</p> 
<h4>
<a id="a_905"></a>a、匹配先验框与特征点</h4> 
<p>在该部分中，YoloV7会对每个真实框进行粗匹配。找到哪些特征点上的哪些先验框可以负责该真实框的预测。</p> 
<p>首先进行先验框的匹配，在YoloV7网络中，一共设计了9个不同大小的先验框。每个输出的特征层对应3个先验框。</p> 
<p><strong>对于任何一个真实框gt，YoloV7不再使用iou进行正样本的匹配，而是直接采用高宽比进行匹配，即使用真实框和9个不同大小的先验框计算宽高比。</strong></p> 
<p><strong>如果真实框与某个先验框的宽高比例大于设定阈值，则说明该真实框和该先验框匹配度不够，将该先验框认为是负样本。</strong></p> 
<p>比如<strong>此时有一个真实框，它的宽高为[200, 200]，是一个正方形</strong>。YoloV7默认设置的<strong>9个先验框为[12, 16], [19, 36], [40, 28], [36, 75], [76, 55], [72, 146], [142, 110], [192, 243], [459, 401]</strong>。设定<strong>阈值门限为4</strong>。</p> 
<p><strong>此时我们需要计算该真实框和9个先验框的宽高比例</strong>。比较宽高时存在两个情况，<strong>一个是真实框的宽高比先验框大，一个是先验框的宽高比真实框大</strong>。因此我们需要同时计算：真实框的宽高/先验框的宽高；先验框的宽高/真实框的宽高。然后在这其中选取最大值。</p> 
<p>下个列表就是比较结果，这是一个shape为[9, 4]的矩阵，9代表9个先验框，4代表真实框的宽高/先验框的宽高；先验框的宽高/真实框的宽高。</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">16.66666667</span> <span class="token number">12.5</span>         <span class="token number">0.06</span>        <span class="token number">0.08</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">10.52631579</span>  <span class="token number">5.55555556</span>  <span class="token number">0.095</span>       <span class="token number">0.18</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">5.</span>          <span class="token number">7.14285714</span>  <span class="token number">0.2</span>         <span class="token number">0.14</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">5.55555556</span>  <span class="token number">2.66666667</span>  <span class="token number">0.18</span>        <span class="token number">0.375</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">2.63157895</span>  <span class="token number">3.63636364</span>  <span class="token number">0.38</span>        <span class="token number">0.275</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">2.77777778</span>  <span class="token number">1.36986301</span>  <span class="token number">0.36</span>        <span class="token number">0.73</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">1.4084507</span>   <span class="token number">1.81818182</span>  <span class="token number">0.71</span>        <span class="token number">0.55</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">1.04166667</span>  <span class="token number">0.82304527</span>  <span class="token number">0.96</span>        <span class="token number">1.215</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">0.43572985</span>  <span class="token number">0.49875312</span>  <span class="token number">2.295</span>       <span class="token number">2.005</span>     <span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>然后对每个先验框的比较结果取最大值。获得下述矩阵：</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token number">16.66666667</span> <span class="token number">10.52631579</span>  <span class="token number">7.14285714</span>  <span class="token number">5.55555556</span>  <span class="token number">3.63636364</span>  <span class="token number">2.77777778</span>
  <span class="token number">1.81818182</span>  <span class="token number">1.215</span>       <span class="token number">2.295</span>     <span class="token punctuation">]</span>
</code></pre> 
<p><strong>之后我们判断，哪些先验框的比较结果的值小于门限</strong>。可以知道[76, 55], [72, 146], [142, 110], [192, 243], [459, 401]五个先验框均满足需求。</p> 
<p><strong>[142, 110], [192, 243], [459, 401]属于20,20的特征层。</strong><br> <strong>[76, 55], [72, 146]属于40,40的特征层。</strong></p> 
<p><strong>此时我们已经可以判断哪些大小的先验框可用于该真实框的预测。</strong></p> 
<p>在YoloV5过去的Yolo中，每个真实框由其中心点所在的网格内的左上角特征点来负责预测。</p> 
<p>在YoloV7中，同YoloV5，对于被选中的特征层，首先计算真实框落在哪个网格内，此时<strong>该网格左上角特征点便是一个负责预测的特征点。</strong></p> 
<p><strong>同时利用四舍五入规则，找出最近的两个网格，将这三个网格</strong>都认为是负责预测该真实框的。<br> <img src="https://images2.imgbox.com/c2/ca/NHzHsunY_o.png" alt="在这里插入图片描述"><br> <strong>红色点表示该真实框的中心</strong>，除了当前所处的网格外，其2个最近的邻域网格也被选中。从这里就可以发现预测框的XY轴偏移部分的取值范围不再是0-1，而是0.5-1.5。</p> 
<p><strong>找到对应特征点后，对应特征点在满足宽高比的先验框负责该真实框的预测。</strong></p> 
<p>但这一步仅仅是粗略的筛选，后面我们会通过simOTA来精确筛选。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">find_3_positive</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> predictions<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#------------------------------------#</span>
    <span class="token comment">#   获得每个特征层先验框的数量</span>
    <span class="token comment">#   与真实框的数量</span>
    <span class="token comment">#------------------------------------#</span>
    num_anchor<span class="token punctuation">,</span> num_gt  <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targets<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> 
    <span class="token comment">#------------------------------------#</span>
    <span class="token comment">#   创建空列表存放indices和anchors</span>
    <span class="token comment">#------------------------------------#</span>
    indices<span class="token punctuation">,</span> anchors    <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">#------------------------------------#</span>
    <span class="token comment">#   创建7个1</span>
    <span class="token comment">#   序号0,1为1</span>
    <span class="token comment">#   序号2:6为特征层的高宽</span>
    <span class="token comment">#   序号6为1</span>
    <span class="token comment">#------------------------------------#</span>
    gain    <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
    <span class="token comment">#------------------------------------#</span>
    <span class="token comment">#   ai      [num_anchor, num_gt]</span>
    <span class="token comment">#   targets [num_gt, 6] =&gt; [num_anchor, num_gt, 7]</span>
    <span class="token comment">#------------------------------------#</span>
    ai      <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>num_anchor<span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>num_anchor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_gt<span class="token punctuation">)</span>
    targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>targets<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_anchor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ai<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># append anchor indices</span>

    g   <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token comment"># offsets</span>
    off <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># j,k,l,m</span>
        <span class="token comment"># [1, 1], [1, -1], [-1, 1], [-1, -1],  # jk,jm,lk,lm</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> g 

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#----------------------------------------------------#</span>
        <span class="token comment">#   将先验框除以stride，获得相对于特征层的先验框。</span>
        <span class="token comment">#   anchors_i [num_anchor, 2]</span>
        <span class="token comment">#----------------------------------------------------#</span>
        anchors_i <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>predictions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   计算获得对应特征层的高宽</span>
        <span class="token comment">#-------------------------------------------#</span>
        gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>predictions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   将真实框乘上gain，</span>
        <span class="token comment">#   其实就是将真实框映射到特征层上</span>
        <span class="token comment">#-------------------------------------------#</span>
        t <span class="token operator">=</span> targets <span class="token operator">*</span> gain
        <span class="token keyword">if</span> num_gt<span class="token punctuation">:</span>
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   计算真实框与先验框高宽的比值</span>
            <span class="token comment">#   然后根据比值大小进行判断，</span>
            <span class="token comment">#   判断结果用于取出，获得所有先验框对应的真实框</span>
            <span class="token comment">#   r   [num_anchor, num_gt, 2]</span>
            <span class="token comment">#   t   [num_anchor, num_gt, 7] =&gt; [num_matched_anchor, 7]</span>
            <span class="token comment">#-------------------------------------------#</span>
            r <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">/</span> anchors_i<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
            j <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1.</span> <span class="token operator">/</span> r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>threshold
            t <span class="token operator">=</span> t<span class="token punctuation">[</span>j<span class="token punctuation">]</span>  <span class="token comment"># filter</span>
            
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   gxy 获得所有先验框对应的真实框的x轴y轴坐标</span>
            <span class="token comment">#   gxi 取相对于该特征层的右小角的坐标</span>
            <span class="token comment">#-------------------------------------------#</span>
            gxy     <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token comment"># grid xy</span>
            gxi     <span class="token operator">=</span> gain<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">-</span> gxy <span class="token comment"># inverse</span>
            j<span class="token punctuation">,</span> k    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxy <span class="token operator">%</span> <span class="token number">1.</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxy <span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
            l<span class="token punctuation">,</span> m    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxi <span class="token operator">%</span> <span class="token number">1.</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxi <span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
            j       <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   t   重复5次，使用满足条件的j进行框的提取</span>
            <span class="token comment">#   j   一共五行，代表当前特征点在五个</span>
            <span class="token comment">#       [0, 0], [1, 0], [0, 1], [-1, 0], [0, -1]</span>
            <span class="token comment">#       方向是否存在</span>
            <span class="token comment">#-------------------------------------------#</span>
            t       <span class="token operator">=</span> t<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            offsets <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>gxy<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> off<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            t <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            offsets <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   b   代表属于第几个图片</span>
        <span class="token comment">#   gxy 代表该真实框所处的x、y中心坐标</span>
        <span class="token comment">#   gwh 代表该真实框的wh坐标</span>
        <span class="token comment">#   gij 代表真实框所属的特征点坐标</span>
        <span class="token comment">#-------------------------------------------#</span>
        b<span class="token punctuation">,</span> c    <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T  <span class="token comment"># image, class</span>
        gxy     <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># grid xy</span>
        gwh     <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>  <span class="token comment"># grid wh</span>
        gij     <span class="token operator">=</span> <span class="token punctuation">(</span>gxy <span class="token operator">-</span> offsets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        gi<span class="token punctuation">,</span> gj  <span class="token operator">=</span> gij<span class="token punctuation">.</span>T  <span class="token comment"># grid xy indices</span>

        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   gj、gi不能超出特征层范围</span>
        <span class="token comment">#   a代表属于该特征点的第几个先验框</span>
        <span class="token comment">#-------------------------------------------#</span>
        a <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># anchor indices</span>
        indices<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gain<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gi<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># image, anchor, grid indices</span>
        anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anchors_i<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># anchors</span>

    <span class="token keyword">return</span> indices<span class="token punctuation">,</span> anchors
</code></pre> 
<h4>
<a id="bSimOTA_1057"></a>b、SimOTA自适应匹配</h4> 
<p><strong>在YoloV7中，我们会计算一个Cost代价矩阵，代表每个真实框和每个特征点之间的代价关系，Cost代价矩阵由三个部分组成：<br> 1、每个真实框和当前特征点预测框的重合程度；<br> 2、每个真实框和当前特征点预测框的种类预测准确度；</strong></p> 
<p><strong>每个真实框和当前特征点预测框的重合程度越高，代表这个特征点已经尝试去拟合该真实框了，因此它的Cost代价就会越小。</strong></p> 
<p><strong>每个真实框和当前特征点预测框的种类预测准确度越高，也代表这个特征点已经尝试去拟合该真实框了，因此它的Cost代价就会越小。</strong></p> 
<p><strong>Cost代价矩阵的目的是自适应的找到当前特征点应该去拟合的真实框，重合度越高越需要拟合，分类越准越需要拟合，在一定半径内越需要拟合。</strong></p> 
<p><strong>在SimOTA中，不同目标设定不同的正样本数量(dynamick)，以旷视科技​官方回答中的蚂蚁和西瓜为例子，传统的正样本分配方案常常为同一场景下的西瓜和蚂蚁分配同样的正样本数，那要么蚂蚁有很多低质量的正样本，要么西瓜仅仅只有一两个正样本。对于哪个分配方式都是不合适的。<br> 动态的正样本设置的关键在于如何确定k，SimOTA具体的做法是首先计算每个目标Cost最低的10特征点，然后把这十个特征点对应的预测框与真实框的IOU加起来求得最终的k。</strong></p> 
<p><strong>因此，SimOTA的过程总结如下：<br> 1、计算每个真实框和当前特征点预测框的重合程度。<br> 2、计算将重合度最高的二十个预测框与真实框的IOU加起来求得每个真实框的k，也就代表每个真实框有k个特征点与之对应。<br> 3、计算每个真实框和当前特征点预测框的种类预测准确度。<br> 4、计算Cost代价矩阵。<br> 5、将Cost最低的k个点作为该真实框的正样本。</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">build_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> predictions<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#-------------------------------------------#</span>
    <span class="token comment">#   匹配正样本</span>
    <span class="token comment">#-------------------------------------------#</span>
    indices<span class="token punctuation">,</span> anch       <span class="token operator">=</span> self<span class="token punctuation">.</span>find_3_positive<span class="token punctuation">(</span>predictions<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

    matching_bs         <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
    matching_as         <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
    matching_gjs        <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
    matching_gis        <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
    matching_targets    <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
    matching_anchs      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
    
    <span class="token comment">#-------------------------------------------#</span>
    <span class="token comment">#   一共三层</span>
    <span class="token comment">#-------------------------------------------#</span>
    num_layer <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span>
    <span class="token comment">#-------------------------------------------#</span>
    <span class="token comment">#   对batch_size进行循环，进行OTA匹配</span>
    <span class="token comment">#   在batch_size循环中对layer进行循环</span>
    <span class="token comment">#-------------------------------------------#</span>
    <span class="token keyword">for</span> batch_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>predictions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   先判断匹配上的真实框哪些属于该图片</span>
        <span class="token comment">#-------------------------------------------#</span>
        b_idx       <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>batch_idx
        this_target <span class="token operator">=</span> targets<span class="token punctuation">[</span>b_idx<span class="token punctuation">]</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   如果没有真实框属于该图片则continue</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token keyword">if</span> this_target<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   真实框的坐标进行缩放</span>
        <span class="token comment">#-------------------------------------------#</span>
        txywh <span class="token operator">=</span> this_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> imgs<span class="token punctuation">[</span>batch_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   从中心宽高到左上角右下角</span>
        <span class="token comment">#-------------------------------------------#</span>
        txyxy <span class="token operator">=</span> self<span class="token punctuation">.</span>xywh2xyxy<span class="token punctuation">(</span>txywh<span class="token punctuation">)</span>

        pxyxys      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        p_cls       <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        p_obj       <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        from_which_layer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        all_b       <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        all_a       <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        all_gj      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        all_gi      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        all_anch    <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   对三个layer进行循环</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> prediction <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   b代表第几张图片 a代表第几个先验框</span>
            <span class="token comment">#   gj代表y轴，gi代表x轴</span>
            <span class="token comment">#-------------------------------------------#</span>
            b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi    <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            idx             <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> batch_idx<span class="token punctuation">)</span>
            b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi    <span class="token operator">=</span> b<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> gj<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> gi<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>       
                    
            all_b<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
            all_a<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
            all_gj<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gj<span class="token punctuation">)</span>
            all_gi<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gi<span class="token punctuation">)</span>
            all_anch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
            from_which_layer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">)</span>
            
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   取出这个真实框对应的预测结果</span>
            <span class="token comment">#-------------------------------------------#</span>
            fg_pred <span class="token operator">=</span> prediction<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span>                
            p_obj<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            p_cls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   获得网格后，进行解码</span>
            <span class="token comment">#-------------------------------------------#</span>
            grid    <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>gi<span class="token punctuation">,</span> gj<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>fg_pred<span class="token punctuation">)</span>
            pxy     <span class="token operator">=</span> <span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            pwh     <span class="token operator">=</span> <span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            pxywh   <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            pxyxy   <span class="token operator">=</span> self<span class="token punctuation">.</span>xywh2xyxy<span class="token punctuation">(</span>pxywh<span class="token punctuation">)</span>
            pxyxys<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pxyxy<span class="token punctuation">)</span>
        
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   判断是否存在对应的预测框，不存在则跳过</span>
        <span class="token comment">#-------------------------------------------#</span>
        pxyxys <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>pxyxys<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> pxyxys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   进行堆叠</span>
        <span class="token comment">#-------------------------------------------#</span>
        p_obj       <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>p_obj<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        p_cls       <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>p_cls<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        from_which_layer <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>from_which_layer<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        all_b       <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_b<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        all_a       <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_a<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        all_gj      <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_gj<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        all_gi      <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_gi<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        all_anch    <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_anch<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    
        <span class="token comment">#-------------------------------------------------------------#</span>
        <span class="token comment">#   计算当前图片中，真实框与预测框的重合程度</span>
        <span class="token comment">#   iou的范围为0-1，取-log后为0~inf</span>
        <span class="token comment">#   重合程度越大，取-log后越小</span>
        <span class="token comment">#   因此，真实框与预测框重合度越大，pair_wise_iou_loss越小</span>
        <span class="token comment">#-------------------------------------------------------------#</span>
        pair_wise_iou       <span class="token operator">=</span> self<span class="token punctuation">.</span>box_iou<span class="token punctuation">(</span>txyxy<span class="token punctuation">,</span> pxyxys<span class="token punctuation">)</span>
        pair_wise_iou_loss  <span class="token operator">=</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>pair_wise_iou <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>

        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   最多二十个预测框与真实框的重合程度</span>
        <span class="token comment">#   然后求和，找到每个真实框对应几个预测框</span>
        <span class="token comment">#-------------------------------------------#</span>
        top_k<span class="token punctuation">,</span> _    <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>pair_wise_iou<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> pair_wise_iou<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        dynamic_ks  <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>top_k<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   gt_cls_per_image    种类的真实信息</span>
        <span class="token comment">#-------------------------------------------#</span>
        gt_cls_per_image <span class="token operator">=</span> F<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>this_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> pxyxys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   cls_preds_  种类置信度的预测信息</span>
        <span class="token comment">#               cls_preds_越接近于1，y越接近于1</span>
        <span class="token comment">#               y / (1 - y)越接近于无穷大</span>
        <span class="token comment">#               也就是种类置信度预测的越准</span>
        <span class="token comment">#               pair_wise_cls_loss越小</span>
        <span class="token comment">#-------------------------------------------#</span>
        num_gt              <span class="token operator">=</span> this_target<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        cls_preds_          <span class="token operator">=</span> p_cls<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_gt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid_<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> p_obj<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_gt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid_<span class="token punctuation">(</span><span class="token punctuation">)</span>
        y                   <span class="token operator">=</span> cls_preds_<span class="token punctuation">.</span>sqrt_<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pair_wise_cls_loss  <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>y <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gt_cls_per_image<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">del</span> cls_preds_
    
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   求cost的总和</span>
        <span class="token comment">#-------------------------------------------#</span>
        cost <span class="token operator">=</span> <span class="token punctuation">(</span>
            pair_wise_cls_loss
            <span class="token operator">+</span> <span class="token number">3.0</span> <span class="token operator">*</span> pair_wise_iou_loss
        <span class="token punctuation">)</span>

        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   求cost最小的k个预测框</span>
        <span class="token comment">#-------------------------------------------#</span>
        matching_matrix <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>
        <span class="token keyword">for</span> gt_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_gt<span class="token punctuation">)</span><span class="token punctuation">:</span>
            _<span class="token punctuation">,</span> pos_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>cost<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> k<span class="token operator">=</span>dynamic_ks<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> largest<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            matching_matrix<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">[</span>pos_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>

        <span class="token keyword">del</span> top_k<span class="token punctuation">,</span> dynamic_ks

        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   如果一个预测框对应多个真实框</span>
        <span class="token comment">#   只使用这个预测框最对应的真实框</span>
        <span class="token comment">#-------------------------------------------#</span>
        anchor_matching_gt <span class="token operator">=</span> matching_matrix<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            _<span class="token punctuation">,</span> cost_argmin <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>cost<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            matching_matrix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span>          <span class="token operator">*=</span> <span class="token number">0.0</span>
            matching_matrix<span class="token punctuation">[</span>cost_argmin<span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>
        fg_mask_inboxes <span class="token operator">=</span> matching_matrix<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span>
        matched_gt_inds <span class="token operator">=</span> matching_matrix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> fg_mask_inboxes<span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   取出符合条件的框</span>
        <span class="token comment">#-------------------------------------------#</span>
        from_which_layer    <span class="token operator">=</span> from_which_layer<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
        all_b               <span class="token operator">=</span> all_b<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
        all_a               <span class="token operator">=</span> all_a<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
        all_gj              <span class="token operator">=</span> all_gj<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
        all_gi              <span class="token operator">=</span> all_gi<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
        all_anch            <span class="token operator">=</span> all_anch<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
        this_target         <span class="token operator">=</span> this_target<span class="token punctuation">[</span>matched_gt_inds<span class="token punctuation">]</span>
    
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
            layer_idx <span class="token operator">=</span> from_which_layer <span class="token operator">==</span> i
            matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_b<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
            matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_a<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
            matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_gj<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
            matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_gi<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
            matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>this_target<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
            matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_anch<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
        matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>      <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span>      <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>     <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span>     <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>   <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> matching_bs<span class="token punctuation">,</span> matching_as<span class="token punctuation">,</span> matching_gjs<span class="token punctuation">,</span> matching_gis<span class="token punctuation">,</span> matching_targets<span class="token punctuation">,</span> matching_anchs
</code></pre> 
<h3>
<a id="3Loss_1279"></a>3、计算Loss</h3> 
<p>由第一部分可知，YoloV7的损失由三个部分组成：<br> <strong>1、Reg部分，由第2部分可知道每个真实框对应的先验框，获取到每个框对应的先验框后，取出该先验框对应的预测框，利用真实框和预测框计算CIOU损失，作为Reg部分的Loss组成。<br> 2、Obj部分，由第2部分可知道每个真实框对应的先验框，所有真实框对应的先验框都是正样本，剩余的先验框均为负样本，根据正负样本和特征点的是否包含物体的预测结果计算交叉熵损失，作为Obj部分的Loss组成。<br> 3、Cls部分，由第三部分可知道每个真实框对应的先验框，获取到每个框对应的先验框后，取出该先验框的种类预测结果，根据真实框的种类和先验框的种类预测结果计算交叉熵损失，作为Cls部分的Loss组成。</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">smooth_BCE</span><span class="token punctuation">(</span>eps<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># https://github.com/ultralytics/yolov3/issues/238#issuecomment-598028441</span>
    <span class="token comment"># return positive, negative label smoothing BCE targets</span>
    <span class="token keyword">return</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> eps<span class="token punctuation">,</span> <span class="token number">0.5</span> <span class="token operator">*</span> eps

<span class="token keyword">class</span> <span class="token class-name">YOLOLoss</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span> anchors_mask <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label_smoothing <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>YOLOLoss<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   13x13的特征层对应的anchor是[142, 110],[192, 243],[459, 401]</span>
        <span class="token comment">#   26x26的特征层对应的anchor是[36, 75],[76, 55],[72, 146]</span>
        <span class="token comment">#   52x52的特征层对应的anchor是[12, 16],[19, 36],[40, 28]</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        self<span class="token punctuation">.</span>anchors        <span class="token operator">=</span> <span class="token punctuation">[</span>anchors<span class="token punctuation">[</span>mask<span class="token punctuation">]</span> <span class="token keyword">for</span> mask <span class="token keyword">in</span> anchors_mask<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>num_classes    <span class="token operator">=</span> num_classes
        self<span class="token punctuation">.</span>input_shape    <span class="token operator">=</span> input_shape
        self<span class="token punctuation">.</span>anchors_mask   <span class="token operator">=</span> anchors_mask

        self<span class="token punctuation">.</span>balance        <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>stride         <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span>
        
        self<span class="token punctuation">.</span>box_ratio      <span class="token operator">=</span> <span class="token number">0.05</span>
        self<span class="token punctuation">.</span>obj_ratio      <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token punctuation">(</span>input_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">640</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cls_ratio      <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>num_classes <span class="token operator">/</span> <span class="token number">80</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>threshold      <span class="token operator">=</span> <span class="token number">4</span>

        self<span class="token punctuation">.</span>cp<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn                    <span class="token operator">=</span> smooth_BCE<span class="token punctuation">(</span>eps<span class="token operator">=</span>label_smoothing<span class="token punctuation">)</span>  
        self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">,</span> self<span class="token punctuation">.</span>BCEobj<span class="token punctuation">,</span> self<span class="token punctuation">.</span>gr   <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCEWithLogitsLoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BCEWithLogitsLoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">bbox_iou</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> box1<span class="token punctuation">,</span> box2<span class="token punctuation">,</span> x1y1x2y2<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> GIoU<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> DIoU<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> CIoU<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e-7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        box2 <span class="token operator">=</span> box2<span class="token punctuation">.</span>T

        <span class="token keyword">if</span> x1y1x2y2<span class="token punctuation">:</span>
            b1_x1<span class="token punctuation">,</span> b1_y1<span class="token punctuation">,</span> b1_x2<span class="token punctuation">,</span> b1_y2 <span class="token operator">=</span> box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
            b2_x1<span class="token punctuation">,</span> b2_y1<span class="token punctuation">,</span> b2_x2<span class="token punctuation">,</span> b2_y2 <span class="token operator">=</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            b1_x1<span class="token punctuation">,</span> b1_x2 <span class="token operator">=</span> box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> box1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> box1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
            b1_y1<span class="token punctuation">,</span> b1_y2 <span class="token operator">=</span> box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> box1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> box1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
            b2_x1<span class="token punctuation">,</span> b2_x2 <span class="token operator">=</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> box2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
            b2_y1<span class="token punctuation">,</span> b2_y2 <span class="token operator">=</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> box2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>

        inter <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>b1_x2<span class="token punctuation">,</span> b2_x2<span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>b1_x1<span class="token punctuation">,</span> b2_x1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> 
                <span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>b1_y2<span class="token punctuation">,</span> b2_y2<span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>b1_y1<span class="token punctuation">,</span> b2_y1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        w1<span class="token punctuation">,</span> h1  <span class="token operator">=</span> b1_x2 <span class="token operator">-</span> b1_x1<span class="token punctuation">,</span> b1_y2 <span class="token operator">-</span> b1_y1 <span class="token operator">+</span> eps
        w2<span class="token punctuation">,</span> h2  <span class="token operator">=</span> b2_x2 <span class="token operator">-</span> b2_x1<span class="token punctuation">,</span> b2_y2 <span class="token operator">-</span> b2_y1 <span class="token operator">+</span> eps
        union   <span class="token operator">=</span> w1 <span class="token operator">*</span> h1 <span class="token operator">+</span> w2 <span class="token operator">*</span> h2 <span class="token operator">-</span> inter <span class="token operator">+</span> eps

        iou <span class="token operator">=</span> inter <span class="token operator">/</span> union

        <span class="token keyword">if</span> GIoU <span class="token keyword">or</span> DIoU <span class="token keyword">or</span> CIoU<span class="token punctuation">:</span>
            cw <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>b1_x2<span class="token punctuation">,</span> b2_x2<span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>b1_x1<span class="token punctuation">,</span> b2_x1<span class="token punctuation">)</span>  <span class="token comment"># convex (smallest enclosing box) width</span>
            ch <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>b1_y2<span class="token punctuation">,</span> b2_y2<span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>b1_y1<span class="token punctuation">,</span> b2_y1<span class="token punctuation">)</span>  <span class="token comment"># convex height</span>
            <span class="token keyword">if</span> CIoU <span class="token keyword">or</span> DIoU<span class="token punctuation">:</span>  <span class="token comment"># Distance or Complete IoU https://arxiv.org/abs/1911.08287v1</span>
                c2 <span class="token operator">=</span> cw <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> ch <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> eps  <span class="token comment"># convex diagonal squared</span>
                rho2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b2_x1 <span class="token operator">+</span> b2_x2 <span class="token operator">-</span> b1_x1 <span class="token operator">-</span> b1_x2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span>
                        <span class="token punctuation">(</span>b2_y1 <span class="token operator">+</span> b2_y2 <span class="token operator">-</span> b1_y1 <span class="token operator">-</span> b1_y2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span>  <span class="token comment"># center distance squared</span>
                <span class="token keyword">if</span> DIoU<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> iou <span class="token operator">-</span> rho2 <span class="token operator">/</span> c2  <span class="token comment"># DIoU</span>
                <span class="token keyword">elif</span> CIoU<span class="token punctuation">:</span>  <span class="token comment"># https://github.com/Zzh-tju/DIoU-SSD-pytorch/blob/master/utils/box/box_utils.py#L47</span>
                    v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">/</span> math<span class="token punctuation">.</span>pi <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>atan<span class="token punctuation">(</span>w2 <span class="token operator">/</span> h2<span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>atan<span class="token punctuation">(</span>w1 <span class="token operator">/</span> h1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        alpha <span class="token operator">=</span> v <span class="token operator">/</span> <span class="token punctuation">(</span>v <span class="token operator">-</span> iou <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> iou <span class="token operator">-</span> <span class="token punctuation">(</span>rho2 <span class="token operator">/</span> c2 <span class="token operator">+</span> v <span class="token operator">*</span> alpha<span class="token punctuation">)</span>  <span class="token comment"># CIoU</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># GIoU https://arxiv.org/pdf/1902.09630.pdf</span>
                c_area <span class="token operator">=</span> cw <span class="token operator">*</span> ch <span class="token operator">+</span> eps  <span class="token comment"># convex area</span>
                <span class="token keyword">return</span> iou <span class="token operator">-</span> <span class="token punctuation">(</span>c_area <span class="token operator">-</span> union<span class="token punctuation">)</span> <span class="token operator">/</span> c_area  <span class="token comment"># GIoU</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> iou  <span class="token comment"># IoU</span>
    
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> predictions<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span><span class="token punctuation">:</span> 
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   对输入进来的预测结果进行reshape</span>
        <span class="token comment">#   bs, 255, 20, 20 =&gt; bs, 3, 20, 20, 85</span>
        <span class="token comment">#   bs, 255, 40, 40 =&gt; bs, 3, 40, 40, 85</span>
        <span class="token comment">#   bs, 255, 80, 80 =&gt; bs, 3, 80, 80, 85</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            bs<span class="token punctuation">,</span> _<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> predictions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
            predictions<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> predictions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   获得工作的设备</span>
        <span class="token comment">#-------------------------------------------#</span>
        device              <span class="token operator">=</span> targets<span class="token punctuation">.</span>device
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   初始化三个部分的损失</span>
        <span class="token comment">#-------------------------------------------#</span>
        cls_loss<span class="token punctuation">,</span> box_loss<span class="token punctuation">,</span> obj_loss    <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device <span class="token operator">=</span> device<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device <span class="token operator">=</span> device<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device <span class="token operator">=</span> device<span class="token punctuation">)</span>
        
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   进行正样本的匹配</span>
        <span class="token comment">#-------------------------------------------#</span>
        bs<span class="token punctuation">,</span> as_<span class="token punctuation">,</span> gjs<span class="token punctuation">,</span> gis<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>build_targets<span class="token punctuation">(</span>predictions<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   计算获得对应特征层的高宽</span>
        <span class="token comment">#-------------------------------------------#</span>
        feature_map_sizes <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>prediction<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>prediction<span class="token punctuation">)</span> <span class="token keyword">for</span> prediction <span class="token keyword">in</span> predictions<span class="token punctuation">]</span> 
    
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   计算损失，对三个特征层各自进行处理</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> prediction <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span><span class="token punctuation">:</span> 
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   image, anchor, gridy, gridx</span>
            <span class="token comment">#-------------------------------------------#</span>
            b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi    <span class="token operator">=</span> bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> as_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            tobj            <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># target obj</span>

            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   获得目标数量，如果目标大于0</span>
            <span class="token comment">#   则开始计算种类损失和回归损失</span>
            <span class="token comment">#-------------------------------------------#</span>
            n <span class="token operator">=</span> b<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> n<span class="token punctuation">:</span>
                prediction_pos <span class="token operator">=</span> prediction<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span>  <span class="token comment"># prediction subset corresponding to targets</span>

                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   计算匹配上的正样本的回归损失</span>
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   grid 获得正样本的x、y轴坐标</span>
                <span class="token comment">#-------------------------------------------#</span>
                grid    <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>gi<span class="token punctuation">,</span> gj<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   进行解码，获得预测结果</span>
                <span class="token comment">#-------------------------------------------#</span>
                xy      <span class="token operator">=</span> prediction_pos<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span>
                wh      <span class="token operator">=</span> <span class="token punctuation">(</span>prediction_pos<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                box     <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> wh<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   对真实框进行处理，映射到特征层上</span>
                <span class="token comment">#-------------------------------------------#</span>
                selected_tbox           <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> feature_map_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                selected_tbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>    <span class="token operator">-=</span> grid<span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>prediction<span class="token punctuation">)</span>
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   计算预测框和真实框的回归损失</span>
                <span class="token comment">#-------------------------------------------#</span>
                iou                     <span class="token operator">=</span> self<span class="token punctuation">.</span>bbox_iou<span class="token punctuation">(</span>box<span class="token punctuation">.</span>T<span class="token punctuation">,</span> selected_tbox<span class="token punctuation">,</span> x1y1x2y2<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> CIoU<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
                box_loss                <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> iou<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   根据预测结果的iou获得置信度损失的gt</span>
                <span class="token comment">#-------------------------------------------#</span>
                tobj<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>gr<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>gr <span class="token operator">*</span> iou<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>tobj<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>  <span class="token comment"># iou ratio</span>

                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   计算匹配上的正样本的分类损失</span>
                <span class="token comment">#-------------------------------------------#</span>
                selected_tcls               <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                t                           <span class="token operator">=</span> torch<span class="token punctuation">.</span>full_like<span class="token punctuation">(</span>prediction_pos<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># targets</span>
                t<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> selected_tcls<span class="token punctuation">]</span>  <span class="token operator">=</span> self<span class="token punctuation">.</span>cp
                cls_loss                    <span class="token operator">+=</span> self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">(</span>prediction_pos<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>  <span class="token comment"># BCE</span>

            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   计算目标是否存在的置信度损失</span>
            <span class="token comment">#   并且乘上每个特征层的比例</span>
            <span class="token comment">#-------------------------------------------#</span>
            obj_loss <span class="token operator">+=</span> self<span class="token punctuation">.</span>BCEobj<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tobj<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># obj loss</span>
            
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   将各个部分的损失乘上比例</span>
        <span class="token comment">#   全加起来后，乘上batch_size</span>
        <span class="token comment">#-------------------------------------------#</span>
        box_loss    <span class="token operator">*=</span> self<span class="token punctuation">.</span>box_ratio
        obj_loss    <span class="token operator">*=</span> self<span class="token punctuation">.</span>obj_ratio
        cls_loss    <span class="token operator">*=</span> self<span class="token punctuation">.</span>cls_ratio
        bs          <span class="token operator">=</span> tobj<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        
        loss    <span class="token operator">=</span> box_loss <span class="token operator">+</span> obj_loss <span class="token operator">+</span> cls_loss
        <span class="token keyword">return</span> loss
        
    <span class="token keyword">def</span> <span class="token function">xywh2xyxy</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Convert nx4 boxes from [x, y, w, h] to [x1, y1, x2, y2]</span>
        y <span class="token operator">=</span> x<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span> <span class="token keyword">else</span> np<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>  <span class="token comment"># top left x</span>
        y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>  <span class="token comment"># top left y</span>
        y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>  <span class="token comment"># bottom right x</span>
        y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>  <span class="token comment"># bottom right y</span>
        <span class="token keyword">return</span> y
    
    <span class="token keyword">def</span> <span class="token function">box_iou</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># https://github.com/pytorch/vision/blob/master/torchvision/ops/boxes.py</span>
        <span class="token triple-quoted-string string">"""
        Return intersection-over-union (Jaccard index) of boxes.
        Both sets of boxes are expected to be in (x1, y1, x2, y2) format.
        Arguments:
            box1 (Tensor[N, 4])
            box2 (Tensor[M, 4])
        Returns:
            iou (Tensor[N, M]): the NxM matrix containing the pairwise
                IoU values for every element in boxes1 and boxes2
        """</span>
        <span class="token keyword">def</span> <span class="token function">box_area</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># box = 4xn</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        area1 <span class="token operator">=</span> box_area<span class="token punctuation">(</span>box1<span class="token punctuation">.</span>T<span class="token punctuation">)</span>
        area2 <span class="token operator">=</span> box_area<span class="token punctuation">(</span>box2<span class="token punctuation">.</span>T<span class="token punctuation">)</span>

        <span class="token comment"># inter(N,M) = (rb(N,M,2) - lt(N,M,2)).clamp(0).prod(2)</span>
        inter <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prod<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> inter <span class="token operator">/</span> <span class="token punctuation">(</span>area1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> area2 <span class="token operator">-</span> inter<span class="token punctuation">)</span>  <span class="token comment"># iou = inter / (area1 + area2 - inter)</span>

    <span class="token keyword">def</span> <span class="token function">build_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> predictions<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   匹配正样本</span>
        <span class="token comment">#-------------------------------------------#</span>
        indices<span class="token punctuation">,</span> anch       <span class="token operator">=</span> self<span class="token punctuation">.</span>find_3_positive<span class="token punctuation">(</span>predictions<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>

        matching_bs         <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
        matching_as         <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
        matching_gjs        <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
        matching_gis        <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
        matching_targets    <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
        matching_anchs      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> predictions<span class="token punctuation">]</span>
        
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   一共三层</span>
        <span class="token comment">#-------------------------------------------#</span>
        num_layer <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token comment">#   对batch_size进行循环，进行OTA匹配</span>
        <span class="token comment">#   在batch_size循环中对layer进行循环</span>
        <span class="token comment">#-------------------------------------------#</span>
        <span class="token keyword">for</span> batch_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>predictions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   先判断匹配上的真实框哪些属于该图片</span>
            <span class="token comment">#-------------------------------------------#</span>
            b_idx       <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>batch_idx
            this_target <span class="token operator">=</span> targets<span class="token punctuation">[</span>b_idx<span class="token punctuation">]</span>
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   如果没有真实框属于该图片则continue</span>
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token keyword">if</span> this_target<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   真实框的坐标进行缩放</span>
            <span class="token comment">#-------------------------------------------#</span>
            txywh <span class="token operator">=</span> this_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> imgs<span class="token punctuation">[</span>batch_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   从中心宽高到左上角右下角</span>
            <span class="token comment">#-------------------------------------------#</span>
            txyxy <span class="token operator">=</span> self<span class="token punctuation">.</span>xywh2xyxy<span class="token punctuation">(</span>txywh<span class="token punctuation">)</span>

            pxyxys      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            p_cls       <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            p_obj       <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            from_which_layer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_b       <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_a       <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_gj      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_gi      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_anch    <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   对三个layer进行循环</span>
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> prediction <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   b代表第几张图片 a代表第几个先验框</span>
                <span class="token comment">#   gj代表y轴，gi代表x轴</span>
                <span class="token comment">#-------------------------------------------#</span>
                b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi    <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                idx             <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> batch_idx<span class="token punctuation">)</span>
                b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi    <span class="token operator">=</span> b<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> gj<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> gi<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>       
                       
                all_b<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
                all_a<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
                all_gj<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gj<span class="token punctuation">)</span>
                all_gi<span class="token punctuation">.</span>append<span class="token punctuation">(</span>gi<span class="token punctuation">)</span>
                all_anch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                from_which_layer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">)</span>
                
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   取出这个真实框对应的预测结果</span>
                <span class="token comment">#-------------------------------------------#</span>
                fg_pred <span class="token operator">=</span> prediction<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span>                
                p_obj<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                p_cls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   获得网格后，进行解码</span>
                <span class="token comment">#-------------------------------------------#</span>
                grid    <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>gi<span class="token punctuation">,</span> gj<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>fg_pred<span class="token punctuation">)</span>
                pxy     <span class="token operator">=</span> <span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                pwh     <span class="token operator">=</span> <span class="token punctuation">(</span>fg_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                pxywh   <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                pxyxy   <span class="token operator">=</span> self<span class="token punctuation">.</span>xywh2xyxy<span class="token punctuation">(</span>pxywh<span class="token punctuation">)</span>
                pxyxys<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pxyxy<span class="token punctuation">)</span>
            
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   判断是否存在对应的预测框，不存在则跳过</span>
            <span class="token comment">#-------------------------------------------#</span>
            pxyxys <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>pxyxys<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> pxyxys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   进行堆叠</span>
            <span class="token comment">#-------------------------------------------#</span>
            p_obj       <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>p_obj<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            p_cls       <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>p_cls<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            from_which_layer <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>from_which_layer<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_b       <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_b<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_a       <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_a<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_gj      <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_gj<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_gi      <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_gi<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            all_anch    <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_anch<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        
            <span class="token comment">#-------------------------------------------------------------#</span>
            <span class="token comment">#   计算当前图片中，真实框与预测框的重合程度</span>
            <span class="token comment">#   iou的范围为0-1，取-log后为0~inf</span>
            <span class="token comment">#   重合程度越大，取-log后越小</span>
            <span class="token comment">#   因此，真实框与预测框重合度越大，pair_wise_iou_loss越小</span>
            <span class="token comment">#-------------------------------------------------------------#</span>
            pair_wise_iou       <span class="token operator">=</span> self<span class="token punctuation">.</span>box_iou<span class="token punctuation">(</span>txyxy<span class="token punctuation">,</span> pxyxys<span class="token punctuation">)</span>
            pair_wise_iou_loss  <span class="token operator">=</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>pair_wise_iou <span class="token operator">+</span> <span class="token number">1e-8</span><span class="token punctuation">)</span>

            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   最多二十个预测框与真实框的重合程度</span>
            <span class="token comment">#   然后求和，找到每个真实框对应几个预测框</span>
            <span class="token comment">#-------------------------------------------#</span>
            top_k<span class="token punctuation">,</span> _    <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>pair_wise_iou<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> pair_wise_iou<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            dynamic_ks  <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>top_k<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   gt_cls_per_image    种类的真实信息</span>
            <span class="token comment">#-------------------------------------------#</span>
            gt_cls_per_image <span class="token operator">=</span> F<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>this_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> pxyxys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   cls_preds_  种类置信度的预测信息</span>
            <span class="token comment">#               cls_preds_越接近于1，y越接近于1</span>
            <span class="token comment">#               y / (1 - y)越接近于无穷大</span>
            <span class="token comment">#               也就是种类置信度预测的越准</span>
            <span class="token comment">#               pair_wise_cls_loss越小</span>
            <span class="token comment">#-------------------------------------------#</span>
            num_gt              <span class="token operator">=</span> this_target<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            cls_preds_          <span class="token operator">=</span> p_cls<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_gt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid_<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> p_obj<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_gt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid_<span class="token punctuation">(</span><span class="token punctuation">)</span>
            y                   <span class="token operator">=</span> cls_preds_<span class="token punctuation">.</span>sqrt_<span class="token punctuation">(</span><span class="token punctuation">)</span>
            pair_wise_cls_loss  <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>y <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gt_cls_per_image<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">del</span> cls_preds_
        
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   求cost的总和</span>
            <span class="token comment">#-------------------------------------------#</span>
            cost <span class="token operator">=</span> <span class="token punctuation">(</span>
                pair_wise_cls_loss
                <span class="token operator">+</span> <span class="token number">3.0</span> <span class="token operator">*</span> pair_wise_iou_loss
            <span class="token punctuation">)</span>

            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   求cost最小的k个预测框</span>
            <span class="token comment">#-------------------------------------------#</span>
            matching_matrix <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>
            <span class="token keyword">for</span> gt_idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_gt<span class="token punctuation">)</span><span class="token punctuation">:</span>
                _<span class="token punctuation">,</span> pos_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>cost<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> k<span class="token operator">=</span>dynamic_ks<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> largest<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
                matching_matrix<span class="token punctuation">[</span>gt_idx<span class="token punctuation">]</span><span class="token punctuation">[</span>pos_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>

            <span class="token keyword">del</span> top_k<span class="token punctuation">,</span> dynamic_ks

            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   如果一个预测框对应多个真实框</span>
            <span class="token comment">#   只使用这个预测框最对应的真实框</span>
            <span class="token comment">#-------------------------------------------#</span>
            anchor_matching_gt <span class="token operator">=</span> matching_matrix<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                _<span class="token punctuation">,</span> cost_argmin <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>cost<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                matching_matrix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span>          <span class="token operator">*=</span> <span class="token number">0.0</span>
                matching_matrix<span class="token punctuation">[</span>cost_argmin<span class="token punctuation">,</span> anchor_matching_gt <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>
            fg_mask_inboxes <span class="token operator">=</span> matching_matrix<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span>
            matched_gt_inds <span class="token operator">=</span> matching_matrix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> fg_mask_inboxes<span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   取出符合条件的框</span>
            <span class="token comment">#-------------------------------------------#</span>
            from_which_layer    <span class="token operator">=</span> from_which_layer<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_b               <span class="token operator">=</span> all_b<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_a               <span class="token operator">=</span> all_a<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_gj              <span class="token operator">=</span> all_gj<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_gi              <span class="token operator">=</span> all_gi<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            all_anch            <span class="token operator">=</span> all_anch<span class="token punctuation">[</span>fg_mask_inboxes<span class="token punctuation">]</span>
            this_target         <span class="token operator">=</span> this_target<span class="token punctuation">[</span>matched_gt_inds<span class="token punctuation">]</span>
        
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
                layer_idx <span class="token operator">=</span> from_which_layer <span class="token operator">==</span> i
                matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_b<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_a<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_gj<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_gi<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>this_target<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
                matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>all_anch<span class="token punctuation">[</span>layer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
            matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>      <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span>      <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>     <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_gjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span>     <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_gis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>   <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>matching_anchs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> matching_bs<span class="token punctuation">,</span> matching_as<span class="token punctuation">,</span> matching_gjs<span class="token punctuation">,</span> matching_gis<span class="token punctuation">,</span> matching_targets<span class="token punctuation">,</span> matching_anchs

    <span class="token keyword">def</span> <span class="token function">find_3_positive</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> predictions<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#------------------------------------#</span>
        <span class="token comment">#   获得每个特征层先验框的数量</span>
        <span class="token comment">#   与真实框的数量</span>
        <span class="token comment">#------------------------------------#</span>
        num_anchor<span class="token punctuation">,</span> num_gt  <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targets<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> 
        <span class="token comment">#------------------------------------#</span>
        <span class="token comment">#   创建空列表存放indices和anchors</span>
        <span class="token comment">#------------------------------------#</span>
        indices<span class="token punctuation">,</span> anchors    <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">#------------------------------------#</span>
        <span class="token comment">#   创建7个1</span>
        <span class="token comment">#   序号0,1为1</span>
        <span class="token comment">#   序号2:6为特征层的高宽</span>
        <span class="token comment">#   序号6为1</span>
        <span class="token comment">#------------------------------------#</span>
        gain    <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        <span class="token comment">#------------------------------------#</span>
        <span class="token comment">#   ai      [num_anchor, num_gt]</span>
        <span class="token comment">#   targets [num_gt, 6] =&gt; [num_anchor, num_gt, 7]</span>
        <span class="token comment">#------------------------------------#</span>
        ai      <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>num_anchor<span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>num_anchor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_gt<span class="token punctuation">)</span>
        targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>targets<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>num_anchor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ai<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># append anchor indices</span>

        g   <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token comment"># offsets</span>
        off <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># j,k,l,m</span>
            <span class="token comment"># [1, 1], [1, -1], [-1, 1], [-1, -1],  # jk,jm,lk,lm</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>targets<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> g 

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#----------------------------------------------------#</span>
            <span class="token comment">#   将先验框除以stride，获得相对于特征层的先验框。</span>
            <span class="token comment">#   anchors_i [num_anchor, 2]</span>
            <span class="token comment">#----------------------------------------------------#</span>
            anchors_i <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>predictions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   计算获得对应特征层的高宽</span>
            <span class="token comment">#-------------------------------------------#</span>
            gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>predictions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            
            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   将真实框乘上gain，</span>
            <span class="token comment">#   其实就是将真实框映射到特征层上</span>
            <span class="token comment">#-------------------------------------------#</span>
            t <span class="token operator">=</span> targets <span class="token operator">*</span> gain
            <span class="token keyword">if</span> num_gt<span class="token punctuation">:</span>
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   计算真实框与先验框高宽的比值</span>
                <span class="token comment">#   然后根据比值大小进行判断，</span>
                <span class="token comment">#   判断结果用于取出，获得所有先验框对应的真实框</span>
                <span class="token comment">#   r   [num_anchor, num_gt, 2]</span>
                <span class="token comment">#   t   [num_anchor, num_gt, 7] =&gt; [num_matched_anchor, 7]</span>
                <span class="token comment">#-------------------------------------------#</span>
                r <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">/</span> anchors_i<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
                j <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1.</span> <span class="token operator">/</span> r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>threshold
                t <span class="token operator">=</span> t<span class="token punctuation">[</span>j<span class="token punctuation">]</span>  <span class="token comment"># filter</span>
                
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   gxy 获得所有先验框对应的真实框的x轴y轴坐标</span>
                <span class="token comment">#   gxi 取相对于该特征层的右小角的坐标</span>
                <span class="token comment">#-------------------------------------------#</span>
                gxy     <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token comment"># grid xy</span>
                gxi     <span class="token operator">=</span> gain<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">-</span> gxy <span class="token comment"># inverse</span>
                j<span class="token punctuation">,</span> k    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxy <span class="token operator">%</span> <span class="token number">1.</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxy <span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
                l<span class="token punctuation">,</span> m    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxi <span class="token operator">%</span> <span class="token number">1.</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxi <span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
                j       <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span>
                
                <span class="token comment">#-------------------------------------------#</span>
                <span class="token comment">#   t   重复5次，使用满足条件的j进行框的提取</span>
                <span class="token comment">#   j   一共五行，代表当前特征点在五个</span>
                <span class="token comment">#       [0, 0], [1, 0], [0, 1], [-1, 0], [0, -1]</span>
                <span class="token comment">#       方向是否存在</span>
                <span class="token comment">#-------------------------------------------#</span>
                t       <span class="token operator">=</span> t<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                offsets <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>gxy<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> off<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                t <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                offsets <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   b   代表属于第几个图片</span>
            <span class="token comment">#   gxy 代表该真实框所处的x、y中心坐标</span>
            <span class="token comment">#   gwh 代表该真实框的wh坐标</span>
            <span class="token comment">#   gij 代表真实框所属的特征点坐标</span>
            <span class="token comment">#-------------------------------------------#</span>
            b<span class="token punctuation">,</span> c    <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T  <span class="token comment"># image, class</span>
            gxy     <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># grid xy</span>
            gwh     <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>  <span class="token comment"># grid wh</span>
            gij     <span class="token operator">=</span> <span class="token punctuation">(</span>gxy <span class="token operator">-</span> offsets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            gi<span class="token punctuation">,</span> gj  <span class="token operator">=</span> gij<span class="token punctuation">.</span>T  <span class="token comment"># grid xy indices</span>

            <span class="token comment">#-------------------------------------------#</span>
            <span class="token comment">#   gj、gi不能超出特征层范围</span>
            <span class="token comment">#   a代表属于该特征点的第几个先验框</span>
            <span class="token comment">#-------------------------------------------#</span>
            a <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># anchor indices</span>
            indices<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gain<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gi<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># image, anchor, grid indices</span>
            anchors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anchors_i<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># anchors</span>

        <span class="token keyword">return</span> indices<span class="token punctuation">,</span> anchors
</code></pre> 
<h1>
<a id="YoloV7_1791"></a>训练自己的YoloV7模型</h1> 
<p><strong>首先前往Github下载对应的仓库，下载完后利用解压软件解压，之后用编程软件打开文件夹。<br> 注意打开的根目录必须正确，否则相对目录不正确的情况下，代码将无法运行。</strong><br> 一定要注意打开后的根目录是文件存放的目录。<br> <img src="https://images2.imgbox.com/1a/aa/EEHLGFcE_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="_1796"></a>一、数据集的准备</h2> 
<p><strong>本文使用VOC格式进行训练，训练前需要自己制作好数据集，如果没有自己的数据集，可以通过Github连接下载VOC12+07的数据集尝试下。</strong><br> 训练前将标签文件放在VOCdevkit文件夹下的VOC2007文件夹下的Annotation中。<br> <img src="https://images2.imgbox.com/c9/42/Z4DSOYEA_o.png" alt="在这里插入图片描述"><br> 训练前将图片文件放在VOCdevkit文件夹下的VOC2007文件夹下的JPEGImages中。<br> <img src="https://images2.imgbox.com/3a/d1/warSXt6R_o.png" alt="在这里插入图片描述"><br> 此时数据集的摆放已经结束。</p> 
<h2>
<a id="_1803"></a>二、数据集的处理</h2> 
<p>在完成数据集的摆放之后，我们需要对数据集进行下一步的处理，目的是获得训练用的2007_train.txt以及2007_val.txt，需要用到根目录下的voc_annotation.py。</p> 
<p>voc_annotation.py里面有一些参数需要设置。<br> 分别是annotation_mode、classes_path、trainval_percent、train_percent、VOCdevkit_path，第一次训练可以仅修改classes_path</p> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''
annotation_mode用于指定该文件运行时计算的内容
annotation_mode为0代表整个标签处理过程，包括获得VOCdevkit/VOC2007/ImageSets里面的txt以及训练用的2007_train.txt、2007_val.txt
annotation_mode为1代表获得VOCdevkit/VOC2007/ImageSets里面的txt
annotation_mode为2代表获得训练用的2007_train.txt、2007_val.txt
'''</span>
annotation_mode     <span class="token operator">=</span> <span class="token number">0</span>
<span class="token triple-quoted-string string">'''
必须要修改，用于生成2007_train.txt、2007_val.txt的目标信息
与训练和预测所用的classes_path一致即可
如果生成的2007_train.txt里面没有目标信息
那么就是因为classes没有设定正确
仅在annotation_mode为0和2的时候有效
'''</span>
classes_path        <span class="token operator">=</span> <span class="token string">'model_data/voc_classes.txt'</span>
<span class="token triple-quoted-string string">'''
trainval_percent用于指定(训练集+验证集)与测试集的比例，默认情况下 (训练集+验证集):测试集 = 9:1
train_percent用于指定(训练集+验证集)中训练集与验证集的比例，默认情况下 训练集:验证集 = 9:1
仅在annotation_mode为0和1的时候有效
'''</span>
trainval_percent    <span class="token operator">=</span> <span class="token number">0.9</span>
train_percent       <span class="token operator">=</span> <span class="token number">0.9</span>
<span class="token triple-quoted-string string">'''
指向VOC数据集所在的文件夹
默认指向根目录下的VOC数据集
'''</span>
VOCdevkit_path  <span class="token operator">=</span> <span class="token string">'VOCdevkit'</span>
</code></pre> 
<p>classes_path用于指向检测类别所对应的txt，以voc数据集为例，我们用的txt为：<br> <img src="https://images2.imgbox.com/c3/2b/XYgDTbs5_o.png" alt="在这里插入图片描述"><br> 训练自己的数据集时，可以自己建立一个cls_classes.txt，里面写自己所需要区分的类别。</p> 
<h2>
<a id="_1840"></a>三、开始网络训练</h2> 
<p><strong>通过voc_annotation.py我们已经生成了2007_train.txt以及2007_val.txt，此时我们可以开始训练了。<br> 训练的参数较多，大家可以在下载库后仔细看注释，其中最重要的部分依然是train.py里的classes_path。</strong></p> 
<p><strong>classes_path用于指向检测类别所对应的txt，这个txt和voc_annotation.py里面的txt一样！训练自己的数据集必须要修改！</strong><br> <img src="https://images2.imgbox.com/09/06/keKjREJI_o.png" alt="在这里插入图片描述"><br> 修改完classes_path后就可以运行train.py开始训练了，在训练多个epoch后，权值会生成在logs文件夹中。<br> 其它参数的作用如下：</p> 
<pre><code class="prism language-python"><span class="token comment">#---------------------------------#</span>
<span class="token comment">#   Cuda    是否使用Cuda</span>
<span class="token comment">#           没有GPU可以设置成False</span>
<span class="token comment">#---------------------------------#</span>
Cuda            <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
<span class="token comment">#   distributed     用于指定是否使用单机多卡分布式运行</span>
<span class="token comment">#                   终端指令仅支持Ubuntu。CUDA_VISIBLE_DEVICES用于在Ubuntu下指定显卡。</span>
<span class="token comment">#                   Windows系统下默认使用DP模式调用所有显卡，不支持DDP。</span>
<span class="token comment">#   DP模式：</span>
<span class="token comment">#       设置            distributed = False</span>
<span class="token comment">#       在终端中输入    CUDA_VISIBLE_DEVICES=0,1 python train.py</span>
<span class="token comment">#   DDP模式：</span>
<span class="token comment">#       设置            distributed = True</span>
<span class="token comment">#       在终端中输入    CUDA_VISIBLE_DEVICES=0,1 python -m torch.distributed.launch --nproc_per_node=2 train.py</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
distributed     <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
<span class="token comment">#   sync_bn     是否使用sync_bn，DDP模式多卡可用</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
sync_bn         <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
<span class="token comment">#   fp16        是否使用混合精度训练</span>
<span class="token comment">#               可减少约一半的显存、需要pytorch1.7.1以上</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
fp16            <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
<span class="token comment">#   classes_path    指向model_data下的txt，与自己训练的数据集相关 </span>
<span class="token comment">#                   训练前一定要修改classes_path，使其对应自己的数据集</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
classes_path    <span class="token operator">=</span> <span class="token string">'model_data/voc_classes.txt'</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
<span class="token comment">#   anchors_path    代表先验框对应的txt文件，一般不修改。</span>
<span class="token comment">#   anchors_mask    用于帮助代码找到对应的先验框，一般不修改。</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
anchors_path    <span class="token operator">=</span> <span class="token string">'model_data/yolo_anchors.txt'</span>
anchors_mask    <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
<span class="token comment">#   权值文件的下载请看README，可以通过网盘下载。模型的 预训练权重 对不同数据集是通用的，因为特征是通用的。</span>
<span class="token comment">#   模型的 预训练权重 比较重要的部分是 主干特征提取网络的权值部分，用于进行特征提取。</span>
<span class="token comment">#   预训练权重对于99%的情况都必须要用，不用的话主干部分的权值太过随机，特征提取效果不明显，网络训练的结果也不会好</span>
<span class="token comment">#</span>
<span class="token comment">#   如果训练过程中存在中断训练的操作，可以将model_path设置成logs文件夹下的权值文件，将已经训练了一部分的权值再次载入。</span>
<span class="token comment">#   同时修改下方的 冻结阶段 或者 解冻阶段 的参数，来保证模型epoch的连续性。</span>
<span class="token comment">#   </span>
<span class="token comment">#   当model_path = ''的时候不加载整个模型的权值。</span>
<span class="token comment">#</span>
<span class="token comment">#   此处使用的是整个模型的权重，因此是在train.py进行加载的。</span>
<span class="token comment">#   如果想要让模型从0开始训练，则设置model_path = ''，下面的Freeze_Train = Fasle，此时从0开始训练，且没有冻结主干的过程。</span>
<span class="token comment">#   </span>
<span class="token comment">#   一般来讲，网络从0开始的训练效果会很差，因为权值太过随机，特征提取效果不明显，因此非常、非常、非常不建议大家从0开始训练！</span>
<span class="token comment">#   从0开始训练有两个方案：</span>
<span class="token comment">#   1、得益于Mosaic数据增强方法强大的数据增强能力，将UnFreeze_Epoch设置的较大（300及以上）、batch较大（16及以上）、数据较多（万以上）的情况下，</span>
<span class="token comment">#      可以设置mosaic=True，直接随机初始化参数开始训练，但得到的效果仍然不如有预训练的情况。（像COCO这样的大数据集可以这样做）</span>
<span class="token comment">#   2、了解imagenet数据集，首先训练分类模型，获得网络的主干部分权值，分类模型的 主干部分 和该模型通用，基于此进行训练。</span>
<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
model_path      <span class="token operator">=</span> <span class="token string">'model_data/yolov7_weights.pth'</span>
<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   input_shape     输入的shape大小，一定要是32的倍数</span>
<span class="token comment">#------------------------------------------------------#</span>
input_shape     <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">]</span>
<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   phi             所使用到的yolov7的版本，本仓库一共提供两个：</span>
<span class="token comment">#                   l : 对应yolov7</span>
<span class="token comment">#                   x : 对应yolov7_x</span>
<span class="token comment">#------------------------------------------------------#</span>
phi             <span class="token operator">=</span> <span class="token string">'l'</span>
<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
<span class="token comment">#   pretrained      是否使用主干网络的预训练权重，此处使用的是主干的权重，因此是在模型构建的时候进行加载的。</span>
<span class="token comment">#                   如果设置了model_path，则主干的权值无需加载，pretrained的值无意义。</span>
<span class="token comment">#                   如果不设置model_path，pretrained = True，此时仅加载主干开始训练。</span>
<span class="token comment">#                   如果不设置model_path，pretrained = False，Freeze_Train = Fasle，此时从0开始训练，且没有冻结主干的过程。</span>
<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
pretrained      <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   mosaic              马赛克数据增强。</span>
<span class="token comment">#   mosaic_prob         每个step有多少概率使用mosaic数据增强，默认50%。</span>
<span class="token comment">#</span>
<span class="token comment">#   mixup               是否使用mixup数据增强，仅在mosaic=True时有效。</span>
<span class="token comment">#                       只会对mosaic增强后的图片进行mixup的处理。</span>
<span class="token comment">#   mixup_prob          有多少概率在mosaic后使用mixup数据增强，默认50%。</span>
<span class="token comment">#                       总的mixup概率为mosaic_prob * mixup_prob。</span>
<span class="token comment">#</span>
<span class="token comment">#   special_aug_ratio   参考YoloX，由于Mosaic生成的训练图片，远远脱离自然图片的真实分布。</span>
<span class="token comment">#                       当mosaic=True时，本代码会在special_aug_ratio范围内开启mosaic。</span>
<span class="token comment">#                       默认为前70%个epoch，100个世代会开启70个世代。</span>
<span class="token comment">#------------------------------------------------------------------#</span>
mosaic              <span class="token operator">=</span> <span class="token boolean">True</span>
mosaic_prob         <span class="token operator">=</span> <span class="token number">0.5</span>
mixup               <span class="token operator">=</span> <span class="token boolean">True</span>
mixup_prob          <span class="token operator">=</span> <span class="token number">0.5</span>
special_aug_ratio   <span class="token operator">=</span> <span class="token number">0.7</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   label_smoothing     标签平滑。一般0.01以下。如0.01、0.005。</span>
<span class="token comment">#------------------------------------------------------------------#</span>
label_smoothing     <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
<span class="token comment">#   训练分为两个阶段，分别是冻结阶段和解冻阶段。设置冻结阶段是为了满足机器性能不足的同学的训练需求。</span>
<span class="token comment">#   冻结训练需要的显存较小，显卡非常差的情况下，可设置Freeze_Epoch等于UnFreeze_Epoch，Freeze_Train = True，此时仅仅进行冻结训练。</span>
<span class="token comment">#      </span>
<span class="token comment">#   在此提供若干参数设置建议，各位训练者根据自己的需求进行灵活调整：</span>
<span class="token comment">#   （一）从整个模型的预训练权重开始训练： </span>
<span class="token comment">#       Adam：</span>
<span class="token comment">#           Init_Epoch = 0，Freeze_Epoch = 50，UnFreeze_Epoch = 100，Freeze_Train = True，optimizer_type = 'adam'，Init_lr = 1e-3，weight_decay = 0。（冻结）</span>
<span class="token comment">#           Init_Epoch = 0，UnFreeze_Epoch = 100，Freeze_Train = False，optimizer_type = 'adam'，Init_lr = 1e-3，weight_decay = 0。（不冻结）</span>
<span class="token comment">#       SGD：</span>
<span class="token comment">#           Init_Epoch = 0，Freeze_Epoch = 50，UnFreeze_Epoch = 300，Freeze_Train = True，optimizer_type = 'sgd'，Init_lr = 1e-2，weight_decay = 5e-4。（冻结）</span>
<span class="token comment">#           Init_Epoch = 0，UnFreeze_Epoch = 300，Freeze_Train = False，optimizer_type = 'sgd'，Init_lr = 1e-2，weight_decay = 5e-4。（不冻结）</span>
<span class="token comment">#       其中：UnFreeze_Epoch可以在100-300之间调整。</span>
<span class="token comment">#   （二）从0开始训练：</span>
<span class="token comment">#       Init_Epoch = 0，UnFreeze_Epoch &gt;= 300，Unfreeze_batch_size &gt;= 16，Freeze_Train = False（不冻结训练）</span>
<span class="token comment">#       其中：UnFreeze_Epoch尽量不小于300。optimizer_type = 'sgd'，Init_lr = 1e-2，mosaic = True。</span>
<span class="token comment">#   （三）batch_size的设置：</span>
<span class="token comment">#       在显卡能够接受的范围内，以大为好。显存不足与数据集大小无关，提示显存不足（OOM或者CUDA out of memory）请调小batch_size。</span>
<span class="token comment">#       受到BatchNorm层影响，batch_size最小为2，不能为1。</span>
<span class="token comment">#       正常情况下Freeze_batch_size建议为Unfreeze_batch_size的1-2倍。不建议设置的差距过大，因为关系到学习率的自动调整。</span>
<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   冻结阶段训练参数</span>
<span class="token comment">#   此时模型的主干被冻结了，特征提取网络不发生改变</span>
<span class="token comment">#   占用的显存较小，仅对网络进行微调</span>
<span class="token comment">#   Init_Epoch          模型当前开始的训练世代，其值可以大于Freeze_Epoch，如设置：</span>
<span class="token comment">#                       Init_Epoch = 60、Freeze_Epoch = 50、UnFreeze_Epoch = 100</span>
<span class="token comment">#                       会跳过冻结阶段，直接从60代开始，并调整对应的学习率。</span>
<span class="token comment">#                       （断点续练时使用）</span>
<span class="token comment">#   Freeze_Epoch        模型冻结训练的Freeze_Epoch</span>
<span class="token comment">#                       (当Freeze_Train=False时失效)</span>
<span class="token comment">#   Freeze_batch_size   模型冻结训练的batch_size</span>
<span class="token comment">#                       (当Freeze_Train=False时失效)</span>
<span class="token comment">#------------------------------------------------------------------#</span>
Init_Epoch          <span class="token operator">=</span> <span class="token number">0</span>
Freeze_Epoch        <span class="token operator">=</span> <span class="token number">50</span>
Freeze_batch_size   <span class="token operator">=</span> <span class="token number">8</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   解冻阶段训练参数</span>
<span class="token comment">#   此时模型的主干不被冻结了，特征提取网络会发生改变</span>
<span class="token comment">#   占用的显存较大，网络所有的参数都会发生改变</span>
<span class="token comment">#   UnFreeze_Epoch          模型总共训练的epoch</span>
<span class="token comment">#                           SGD需要更长的时间收敛，因此设置较大的UnFreeze_Epoch</span>
<span class="token comment">#                           Adam可以使用相对较小的UnFreeze_Epoch</span>
<span class="token comment">#   Unfreeze_batch_size     模型在解冻后的batch_size</span>
<span class="token comment">#------------------------------------------------------------------#</span>
UnFreeze_Epoch      <span class="token operator">=</span> <span class="token number">300</span>
Unfreeze_batch_size <span class="token operator">=</span> <span class="token number">4</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   Freeze_Train    是否进行冻结训练</span>
<span class="token comment">#                   默认先冻结主干训练后解冻训练。</span>
<span class="token comment">#------------------------------------------------------------------#</span>
Freeze_Train        <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   其它训练参数：学习率、优化器、学习率下降有关</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   Init_lr         模型的最大学习率</span>
<span class="token comment">#   Min_lr          模型的最小学习率，默认为最大学习率的0.01</span>
<span class="token comment">#------------------------------------------------------------------#</span>
Init_lr             <span class="token operator">=</span> <span class="token number">1e-2</span>
Min_lr              <span class="token operator">=</span> Init_lr <span class="token operator">*</span> <span class="token number">0.01</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   optimizer_type  使用到的优化器种类，可选的有adam、sgd</span>
<span class="token comment">#                   当使用Adam优化器时建议设置  Init_lr=1e-3</span>
<span class="token comment">#                   当使用SGD优化器时建议设置   Init_lr=1e-2</span>
<span class="token comment">#   momentum        优化器内部使用到的momentum参数</span>
<span class="token comment">#   weight_decay    权值衰减，可防止过拟合</span>
<span class="token comment">#                   adam会导致weight_decay错误，使用adam时建议设置为0。</span>
<span class="token comment">#------------------------------------------------------------------#</span>
optimizer_type      <span class="token operator">=</span> <span class="token string">"sgd"</span>
momentum            <span class="token operator">=</span> <span class="token number">0.937</span>
weight_decay        <span class="token operator">=</span> <span class="token number">5e-4</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   lr_decay_type   使用到的学习率下降方式，可选的有step、cos</span>
<span class="token comment">#------------------------------------------------------------------#</span>
lr_decay_type       <span class="token operator">=</span> <span class="token string">"cos"</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   save_period     多少个epoch保存一次权值</span>
<span class="token comment">#------------------------------------------------------------------#</span>
save_period         <span class="token operator">=</span> <span class="token number">10</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   save_dir        权值与日志文件保存的文件夹</span>
<span class="token comment">#------------------------------------------------------------------#</span>
save_dir            <span class="token operator">=</span> <span class="token string">'logs'</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   eval_flag       是否在训练时进行评估，评估对象为验证集</span>
<span class="token comment">#                   安装pycocotools库后，评估体验更佳。</span>
<span class="token comment">#   eval_period     代表多少个epoch评估一次，不建议频繁的评估</span>
<span class="token comment">#                   评估需要消耗较多的时间，频繁评估会导致训练非常慢</span>
<span class="token comment">#   此处获得的mAP会与get_map.py获得的会有所不同，原因有二：</span>
<span class="token comment">#   （一）此处获得的mAP为验证集的mAP。</span>
<span class="token comment">#   （二）此处设置评估参数较为保守，目的是加快评估速度。</span>
<span class="token comment">#------------------------------------------------------------------#</span>
eval_flag           <span class="token operator">=</span> <span class="token boolean">True</span>
eval_period         <span class="token operator">=</span> <span class="token number">10</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   num_workers     用于设置是否使用多线程读取数据</span>
<span class="token comment">#                   开启后会加快数据读取速度，但是会占用更多内存</span>
<span class="token comment">#                   内存较小的电脑可以设置为2或者0  </span>
<span class="token comment">#------------------------------------------------------------------#</span>
num_workers         <span class="token operator">=</span> <span class="token number">4</span>

<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   train_annotation_path   训练图片路径和标签</span>
<span class="token comment">#   val_annotation_path     验证图片路径和标签</span>
<span class="token comment">#------------------------------------------------------#</span>
train_annotation_path   <span class="token operator">=</span> <span class="token string">'2007_train.txt'</span>
val_annotation_path     <span class="token operator">=</span> <span class="token string">'2007_val.txt'</span>
</code></pre> 
<h2>
<a id="_2057"></a>四、训练结果预测</h2> 
<p>训练结果预测需要用到两个文件，分别是yolo.py和predict.py。<br> 我们首先需要去yolo.py里面修改model_path以及classes_path，这两个参数必须要修改。</p> 
<p><strong>model_path指向训练好的权值文件，在logs文件夹里。<br> classes_path指向检测类别所对应的txt。</strong><br> <img src="https://images2.imgbox.com/3a/b3/zt1SAMV5_o.png" alt="在这里插入图片描述"><br> 完成修改后就可以运行predict.py进行检测了。运行后输入图片路径即可检测。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>