<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>ElasticSearch搜索技术深入与聚合查询实战 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ElasticSearch搜索技术深入与聚合查询实战</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <h2>
<a id="ES_0"></a>ES分词器详解</h2> 
<h3>
<a id="_1"></a>基本概念</h3> 
<p>分词器官方称之为文本分析器，顾名思义，是对文本进行分析处理的一种手段，基本处理逻辑为按照预先制定的分词规则，把原始文档分割成若干更小粒度的词项，粒度大小取决于分词器规则。</p> 
<h3>
<a id="_3"></a>分词发生时期</h3> 
<p>分词器的处理过程发生在 Index Time 和 Search Time 两个时期。</p> 
<ul>
<li>Index Time：文档写入并创建倒排索引时期，其分词逻辑取决于映射参数analyzer。</li>
<li>Search Time：搜索发生时期，其分词仅对搜索词产生作用。</li>
</ul> 
<h3>
<a id="_8"></a>分词器的组成</h3> 
<ul>
<li>切词器（Tokenizer）：用于定义切词（分词）逻辑</li>
<li>词项过滤器（Token Filter）：用于对分词之后的单个词项的处理逻辑</li>
<li>字符过滤器（Character Filter）：用于处理单个字符</li>
</ul> 
<p>注意：</p> 
<ul><li>分词器不会对源数据造成任何影响，分词仅仅是对倒排索引或者搜索词的行为。</li></ul> 
<h4>
<a id="Tokenizer_17"></a>切词器Tokenizer</h4> 
<p>tokenizer 是分词器的核心组成部分之一，其主要作用是分词，或称之为切词。主要用来对原始文本进行细粒度拆分。拆分之后的每一个部分称之为一个 Term，或称之为一个词项。可以把切词器理解为预定义的切词规则。官方内置了很多种切词器，默认的切词器位 standard。</p> 
<h4>
<a id="Token_Filter_19"></a>词项过滤器Token Filter</h4> 
<p>词项过滤器用来处理切词完成之后的词项，例如把大小写转换，删除停用词或同义词处理等。官方同样预置了很多词项过滤器，基本可以满足日常开发的需要。当然也是支持第三方也自行开发的。</p> 
<pre><code class="prism language-bash">GET _analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"filter"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"lowercase"</span><span class="token punctuation">]</span>,
  <span class="token string">"text"</span> <span class="token builtin class-name">:</span> <span class="token string">"WWW ELASTIC ORG CN"</span>
<span class="token punctuation">}</span>

GET _analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"tokenizer"</span> <span class="token builtin class-name">:</span> <span class="token string">"standard"</span>,
  <span class="token string">"filter"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"uppercase"</span><span class="token punctuation">]</span>,
  <span class="token string">"text"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"www.elastic.org.cn"</span>,<span class="token string">"www elastic org cn"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>停用词：<br>在切词完成之后，会被干掉词项，即停用词。停用词可以自定义。<br>英文停用词（english）：<code>a, an, and, are, as, at, be, but, by, for, if, in, into, is, it, no, not, of, on, or, such, that, the, their, then, there, these, they, this, to, was, will, with。</code><br>中日韩停用词（cjk）：<code>a, and, are, as, at, be, but, by, for, if, in, into, is, it, no, not, of, on, or, s, such, t, that, the, their, then, there, these, they, this, to, was, will, with, www。</code></p> 
<pre><code class="prism language-bash">GET _analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"tokenizer"</span><span class="token builtin class-name">:</span> <span class="token string">"standard"</span>, 
  <span class="token string">"filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"stop"</span><span class="token punctuation">]</span>,
  <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"What are you doing"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment"># 自定义 filter</span>
DELETE test_token_filter_stop
PUT test_token_filter_stop
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"analysis"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"my_filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"stop"</span>,
          <span class="token string">"stopwords"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"www"</span>
          <span class="token punctuation">]</span>,
          <span class="token string">"ignore_case"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET test_token_filter_stop/_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"tokenizer"</span><span class="token builtin class-name">:</span> <span class="token string">"standard"</span>, 
  <span class="token string">"filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"my_filter"</span><span class="token punctuation">]</span>, 
  <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"What www WWW are you doing"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/29/bc/DNc4GbWL_o.png" alt="image.png"><br>上图可看出，结果缺少了“are”停用词；</p> 
<p>同义词：<br>同义词定义规则</p> 
<ul>
<li>a, b, c =&gt; d：这种方式，a、b、c 会被 d 代替。</li>
<li>a, b, c, d：这种方式下，a、b、c、d 是等价的。</li>
</ul> 
<pre><code class="prism language-bash">PUT test_token_filter_synonym
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"analysis"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"my_synonym"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"synonym"</span>,
          <span class="token string">"synonyms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token string">"good, nice =&gt; excellent"</span> <span class="token punctuation">]</span> //good, nice, excellent
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
GET test_token_filter_synonym/_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"tokenizer"</span><span class="token builtin class-name">:</span> <span class="token string">"standard"</span>, 
  <span class="token string">"filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"my_synonym"</span><span class="token punctuation">]</span>, 
  <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"good"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/74/95/ZsldDBaU_o.png" alt="image.png"><br>上图可以产出，搜索“good”时可以找出“excellent”；</p> 
<h4>
<a id="Character_Filter_99"></a>字符过滤器Character Filter</h4> 
<p>分词之前的预处理，过滤无用字符。</p> 
<pre><code class="prism language-java"><span class="token constant">PUT</span> <span class="token generics"><span class="token punctuation">&lt;</span>index_name<span class="token punctuation">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"char_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"my_char_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"&lt;char_filter_type&gt;"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>type：使用的字符过滤器类型名称，可配置以下值：</p> 
<ul>
<li>html_strip</li>
<li>mapping</li>
<li>pattern_replace</li>
</ul> 
<p>HTML 标签过滤器（HTML Strip Character Filter）：<br>字符过滤器会去除 HTML 标签和转义 HTML 元素，如 <code>、&amp;</code></p> 
<pre><code class="prism language-java"><span class="token constant">PUT</span> test_html_strip_filter
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"char_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"my_char_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"html_strip"</span><span class="token punctuation">,</span>  <span class="token comment">// html_strip 代表使用 HTML 标签过滤器</span>
          <span class="token string">"escaped_tags"</span><span class="token operator">:</span> <span class="token punctuation">[</span>     <span class="token comment">// 当前仅保留 a 标签        </span>
            <span class="token string">"a"</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">GET</span> test_html_strip_filter<span class="token operator">/</span>_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span> 
  <span class="token string">"char_filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"my_char_filter"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"text"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;p&gt;I&amp;apos;m so &lt;a&gt;happy&lt;/a&gt;!&lt;/p&gt;"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>参数：escaped_tags：需要保留的 html 标签。</p> 
<p>字符映射过滤器（Mapping Character Filter）：<br>通过定义映替换为规则，把特定字符替换为指定字符</p> 
<pre><code class="prism language-java"><span class="token constant">PUT</span> test_html_strip_filter
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"char_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"my_char_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"mapping"</span><span class="token punctuation">,</span> <span class="token comment">// mapping 代表使用字符映射过滤器</span>
          <span class="token string">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 数组中规定的字符会被等价替换为 =&gt; 指定的字符</span>
            <span class="token string">"滚 =&gt; *"</span><span class="token punctuation">,</span>
            <span class="token string">"垃 =&gt; *"</span><span class="token punctuation">,</span>
            <span class="token string">"圾 =&gt; *"</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token constant">GET</span> test_html_strip_filter<span class="token operator">/</span>_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">// "tokenizer": "standard", </span>
  <span class="token string">"char_filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"my_char_filter"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"text"</span><span class="token operator">:</span> <span class="token string">"你就是个垃圾！滚"</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="Pattern_Replace_Character_Filter_174"></a>正则替换过滤器Pattern Replace Character Filter</h4> 
<pre><code class="prism language-java"><span class="token constant">PUT</span> text_pattern_replace_filter
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"char_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"my_char_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"pattern_replace"</span><span class="token punctuation">,</span> <span class="token comment">// pattern_replace 代表使用正则替换过滤器       </span>
          <span class="token string">"pattern"</span><span class="token operator">:</span> <span class="token string">""</span>"<span class="token punctuation">(</span>d<span class="token punctuation">{<!-- --></span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>d<span class="token punctuation">{<!-- --></span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">(</span>d<span class="token punctuation">{<!-- --></span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token string">""</span>"<span class="token punctuation">,</span> <span class="token comment">// 正则表达式</span>
          <span class="token string">"replacement"</span><span class="token operator">:</span> <span class="token string">"$1****$2"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">GET</span> text_pattern_replace_filter<span class="token operator">/</span>_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"char_filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"my_char_filter"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"text"</span><span class="token operator">:</span> <span class="token string">"您的手机号是18868686688"</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="_197"></a>倒排索引的数据结构</h3> 
<p>当数据写入 ES 时，数据将会通过分词被切分为不同的 term，ES 将 term 与其对应的文档列表建立一种映射关系，这种结构就是倒排索引。如下图所示：<br><img src="https://images2.imgbox.com/d4/42/eP4JmeHl_o.png" alt="image.png"><br>为了进一步提升索引的效率，ES 在 term 的基础上利用 term 的前缀或者后缀构建了 term index，用于对 term 本身进行索引，ES 实际的索引结构如下图所示：<br><img src="https://images2.imgbox.com/26/af/JbUdf6A6_o.png" alt="image.png"></p> 
<p>这样当我们去搜索某个关键词时，ES 首先根据它的前缀或者后缀迅速缩小关键词的在 term dictionary 中的范围，大大减少了磁盘IO的次数。</p> 
<ul><li>单词词典（Term Dictionary)</li></ul> 
<p>记录所有文档的单词，记录单词到倒排列表的关联关系；<br></p> 
<blockquote> 
 <p>常用字典数据结构：<a href="https://www.cnblogs.com/LBSer/p/4119841.html">https://www.cnblogs.com/LBSer/p/4119841.html</a>；</p> 
</blockquote> 
<ul><li>倒排列表(Posting List)</li></ul> 
<p>记录了单词对应的文档结合，由倒排索引项组成；</p> 
<ul><li>倒排索引项(Posting)</li></ul> 
<p>文档ID；<br>词频TF：该单词在文档中出现的次数，用于相关性评分；<br>位置(Position)：单词在文档中分词的位置。用于短语搜索（match phrase query)；<br>偏移(Offset)：记录单词的开始结束位置，实现高亮显示；</p> 
<p>Elasticsearch 的JSON文档中的每个字段，都有自己的倒排索引。<br>可以指定对某些字段不做索引：</p> 
<ul>
<li>优点︰节省存储空间</li>
<li>缺点: 字段无法被搜索</li>
</ul> 
<h2>
<a id="_219"></a>相关性详解</h2> 
<p>搜索是用户和搜索引擎的对话，用户关心的是搜索结果的相关性</p> 
<ul>
<li>是否可以找到所有相关的内容</li>
<li>有多少不相关的内容被返回了</li>
<li>文档的打分是否合理</li>
<li>结合业务需求，平衡结果排名</li>
</ul> 
<h3>
<a id="Relevance_226"></a>什么是相关性（Relevance）</h3> 
<p>搜索的相关性算分，描述了一个文档和查询语句匹配的程度。ES 会对每个匹配查询条件的结果进行算分_score。打分的本质是排序，需要把最符合用户需求的文档排在前面。</p> 
<p>如下例子：<br>显而易见，查询“JAVA多线程设计模式”，文档id为2,3的文档的算分更高。</p> 
<table>
<thead><tr>
<th><strong>关键词</strong></th>
<th><strong>文档ID</strong></th>
</tr></thead>
<tbody>
<tr>
<td>JAVA</td>
<td>1,2,3</td>
</tr>
<tr>
<td>设计模式</td>
<td>1,2,3,4,5,6</td>
</tr>
<tr>
<td>多线程</td>
<td>2,3,7,9</td>
</tr>
</tbody>
</table> 
<p>如何衡量相关性：</p> 
<ul><li>Precision（查准率）</li></ul> 
<p>尽可能返回较少的无关文档；</p> 
<ul><li>Recall（查全率）</li></ul> 
<p>尽量返回较多的相关文档；</p> 
<ul><li>Ranking（排序）</li></ul> 
<p>是否能够按照相关度进行排序；</p> 
<h3>
<a id="_251"></a>相关性算法</h3> 
<p>ES 5之前，默认的相关性算分采用TF-IDF，现在采用BM 25。</p> 
<h4>
<a id="TFIDF_253"></a>TF-IDF</h4> 
<p>TF-IDF（term frequency–inverse document frequency）是一种用于信息检索与数据挖掘的常用加权技术。</p> 
<ul>
<li>TF-IDF被公认为是信息检索领域最重要的发明，除了在信息检索，在文献分类和其他相关领域有着非常广泛的应用；</li>
<li>IDF的概念，最早是剑桥大学的“斯巴克.琼斯”提出；</li>
</ul> 
<p>1972年——“关键词特殊性的统计解释和它在文献检索中的应用”，但是没有从理论上解释IDF应该是用log(全部文档数/检索词出现过的文档总数)，而不是其他函数，也没有做进一步的研究；<br>1970，1980年代萨尔顿和罗宾逊，进行了进一步的证明和研究，并用香农信息论做了证明</p> 
<blockquote> 
 <p><a href="http://www.staff.city.ac.uk/~sb317/papers/foundations_bm25_review.pdf">http://www.staff.city.ac.uk/~sb317/papers/foundations_bm25_review.pdf</a></p> 
</blockquote> 
<ul><li>现代搜索引擎，对TF-IDF进行了大量细微的优化；</li></ul> 
<p>Lucene中的TF-IDF评分公式：<br><img src="https://images2.imgbox.com/da/43/isoKF9Fa_o.png" alt="image.png"></p> 
<p>TF是词频（Term Frequency）：<br>检索词在文档中出现的频率越高，相关性也越高；</p> 
<pre><code class="prism language-bash">词频（TF） <span class="token operator">=</span>  某个词在文档中出现的次数 /  文档的总词数；
</code></pre> 
<p>IDF是逆向文本频率（Inverse Document Frequency）：<br>每个检索词在索引中出现的频率，频率越高，相关性越低。总文档中有些词比如“是”、“的” 、“在” 在所有文档中出现频率都很高，并不重要，可以减少多个文档中都频繁出现的词的权重。</p> 
<pre><code class="prism language-bash">逆向文本频率（IDF）<span class="token operator">=</span> log <span class="token punctuation">(</span>语料库的文档总数 / <span class="token punctuation">(</span>包含该词的文档数+1<span class="token punctuation">))</span>
</code></pre> 
<p>字段长度归一值（ field-length norm）：<br>检索词出现在一个内容短的 title 要比同样的词出现在一个内容长的 content 字段权重更大。<br>以上三个因素——词频（term frequency）、逆向文本频率（inverse document frequency）和字段长度归一值（field-length norm）——是在索引时计算并存储的，最后将它们结合在一起计算单个词在特定文档中的权重。</p> 
<h4>
<a id="BM25_277"></a>BM25</h4> 
<p>BM25 就是对 TF-IDF 算法的改进，对于 TF-IDF 算法，TF(t) 部分的值越大，整个公式返回的值就会越大。BM25 就针对这点进行来优化，随着TF(t) 的逐步加大，该算法的返回值会趋于一个数值。</p> 
<ul>
<li>从ES 5开始，默认算法改为BM 25；</li>
<li>和经典的TF-IDF相比，当TF无限增加时，BM 25算分会趋于一个数值；</li>
</ul> 
<p><img src="https://images2.imgbox.com/84/37/k5vQ0V9l_o.png" alt="image.png"></p> 
<ul><li>BM 25的公式</li></ul> 
<p><img src="https://images2.imgbox.com/a1/7f/FVK7Orkf_o.png" alt="image.png"></p> 
<h3>
<a id="Explain_APITFIDF_288"></a>通过Explain API查看TF-IDF</h3> 
<p>示例：</p> 
<pre><code class="prism language-bash">PUT /test_score/_bulk
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:1<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"we use Elasticsearch to power the search"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:2<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"we like elasticsearch"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:3<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"Thre scoring of documents is caculated by the scoring formula"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:4<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"you know,for search"</span><span class="token punctuation">}</span>

GET /test_score/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"explain"</span><span class="token builtin class-name">:</span> true, 
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"content"</span><span class="token builtin class-name">:</span> <span class="token string">"elasticsearch"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET /test_score/_explain/2
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"content"</span><span class="token builtin class-name">:</span> <span class="token string">"elasticsearch"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="Boosting_Query_320"></a>Boosting Query</h3> 
<p>Boosting是控制相关度的一种手段。可以通过指定字段的boost值影响查询结果。<br>参数boost的含义：</p> 
<ul>
<li>当boost &gt; 1时，打分的权重相对性提升；</li>
<li>当0 &lt; boost &lt;1时，打分的权重相对性降低；</li>
<li>当boost &lt;0时，贡献负分；</li>
</ul> 
<p>应用场景：希望包含了某项内容的结果不是不出现，而是排序靠后。</p> 
<pre><code class="prism language-bash">
POST /blogs/_bulk
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:1<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"title"</span><span class="token builtin class-name">:</span><span class="token string">"Apple iPad"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"Apple iPad,Apple iPad"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:2<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"title"</span><span class="token builtin class-name">:</span><span class="token string">"Apple iPad,Apple iPad"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"Apple iPad"</span><span class="token punctuation">}</span>

GET /blogs/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"should"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"apple,ipad"</span>,
              <span class="token string">"boost"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{<!-- --></span>
          <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"content"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"apple,ipad"</span>,
              <span class="token string">"boost"</span><span class="token builtin class-name">:</span> <span class="token number">4</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>案例：要求苹果公司的产品信息优先展示</p> 
<pre><code class="prism language-bash">POST /news/_bulk
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:1<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"Apple Mac"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:2<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"Apple iPad"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:3<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"Apple employee like Apple Pie and Apple Juice"</span><span class="token punctuation">}</span>


GET /news/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"must"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"content"</span><span class="token builtin class-name">:</span> <span class="token string">"apple"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>利用must not排除不是苹果公司产品的文档：</p> 
<pre><code class="prism language-bash">GET /news/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"must"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"content"</span><span class="token builtin class-name">:</span> <span class="token string">"apple"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"must_not"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span>
          <span class="token string">"content"</span><span class="token builtin class-name">:</span> <span class="token string">"pie"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>利用negative_boost降低相关性：<br>对某些返回结果不满意，但又不想排除掉（ must_not)，可以考虑 boosting query 的 negative_boost。</p> 
<ul>
<li>negative_boost 对 negative 部分 query 生效</li>
<li>计算评分时，boosting 部分评分不修改，negative 部分 query 乘以 negative_boost 值</li>
<li>negative_boost 取值<code>0-1.0</code>，举例：0.3</li>
</ul> 
<pre><code class="prism language-bash">GET /news/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"boosting"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"positive"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"content"</span><span class="token builtin class-name">:</span> <span class="token string">"apple"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"negative"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"content"</span><span class="token builtin class-name">:</span> <span class="token string">"pie"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"negative_boost"</span><span class="token builtin class-name">:</span> <span class="token number">0.2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="_433"></a>单字符串多字段查询</h2> 
<p>三种场景：</p> 
<ul><li>最佳字段(Best Fields)</li></ul> 
<p>当字段之间相互竞争，又相互关联。例如，对于博客的 title 和 body 这样的字段，评分来自最匹配字段；</p> 
<ul><li>多数字段(Most Fields)</li></ul> 
<p>处理英文内容时的一种常见的手段是，在主字段(English Analyzer)，抽取词干，加入同义词，以匹配更多的文档。相同的文本，加入子字段（Standard Analyzer），以提供更加精确的匹配。其他字段作为匹配文档提高相关度的信号，匹配字段越多则越好。</p> 
<ul><li>混合字段(Cross Fields)</li></ul> 
<p>对于某些实体，例如人名、地址、图书信息。需要在多个字段中确定信息，单个字段只能作为整体的一部分。希望在任何这些列出的字段中找到尽可能多的词。</p> 
<h3>
<a id="Dis_Max_Query_447"></a>最佳字段查询Dis Max Query</h3> 
<p>将任何与任一查询匹配的文档作为结果返回，采用字段上最匹配的评分最终评分返回，max(a,b)。</p> 
<blockquote> 
 <p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl-dis-max-query.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl-dis-max-query.html</a></p> 
</blockquote> 
<p>测试：</p> 
<pre><code class="prism language-bash">DELETE /blogs
PUT /blogs/_doc/1
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"Quick brown rabbits"</span>,
    <span class="token string">"body"</span><span class="token builtin class-name">:</span>  <span class="token string">"Brown rabbits are commonly seen."</span>
<span class="token punctuation">}</span>

PUT /blogs/_doc/2
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"Keeping pets healthy"</span>,
    <span class="token string">"body"</span><span class="token builtin class-name">:</span>  <span class="token string">"My quick brown fox eats rabbits on a regular basis."</span>
<span class="token punctuation">}</span>

POST /blogs/_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"should"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span> <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"Brown fox"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span> <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"body"</span><span class="token builtin class-name">:</span>  <span class="token string">"Brown fox"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>bool should的算法过程：</p> 
<ul>
<li>查询should语句中的两个查询</li>
<li>加和两个查询的评分</li>
<li>乘以匹配语句的总数</li>
<li>除以所有语句的总数</li>
</ul> 
<p>上述例子中，title和body属于竞争关系，不应该将分数简单叠加，而是应该找到单个最佳匹配的字段的评分。</p> 
<p>使用最佳字段查询dis max query：</p> 
<pre><code class="prism language-bash">POST /blogs/_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"dis_max"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"queries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span> <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"Brown fox"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span> <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"body"</span><span class="token builtin class-name">:</span>  <span class="token string">"Brown fox"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以通过tie_breaker参数调整：<br>Tier Breaker是一个介于0-1之间的浮点数。0代表使用最佳匹配；1代表所有语句同等重要。</p> 
<ol>
<li>获得最佳匹配语句的评分_score</li>
<li>将其他匹配语句的评分与tie_breaker相乘</li>
<li>对以上评分求和并规范化</li>
</ol> 
<p><code>最终得分=最佳匹配字段+其他匹配字段*tie_breaker</code></p> 
<pre><code class="prism language-bash">POST /blogs/_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"dis_max"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"queries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span> <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"Quick pets"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span> <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"body"</span><span class="token builtin class-name">:</span>  <span class="token string">"Quick pets"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


POST /blogs/_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"dis_max"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"queries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span> <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"Quick pets"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span> <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"body"</span><span class="token builtin class-name">:</span>  <span class="token string">"Quick pets"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"tie_breaker"</span><span class="token builtin class-name">:</span> <span class="token number">0.1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="Multi_Match_Query_537"></a>Multi Match Query</h3> 
<h4>
<a id="est_Fields_538"></a>最佳字段（est Fields）搜索</h4> 
<p>best_fields策略获取最佳匹配字段的得分, final_score = max(其他匹配字段得分，最佳匹配字段得分)；<br>采用 best_fields 查询，并添加参数 tie_breaker=0.1，final_score = 其他匹配字段得分 * 0.1 + 最佳匹配字段得分；<br>Best Fields是默认类型，可以不用指定，等价于dis_max查询方式；</p> 
<pre><code class="prism language-bash">POST /blogs/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"multi_match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"best_fields"</span>,
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"Brown fox"</span>,
      <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"title"</span>,<span class="token string">"body"</span><span class="token punctuation">]</span>,
      <span class="token string">"tie_breaker"</span><span class="token builtin class-name">:</span> <span class="token number">0.2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>案例：</p> 
<pre><code class="prism language-bash">PUT /employee
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"settings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"analysis.analyzer.default.type"</span><span class="token builtin class-name">:</span> <span class="token string">"ik_max_word"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

POST /employee/_bulk
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:1<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"1"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"员工001"</span>,<span class="token string">"age"</span>:20,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"男"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000001111"</span>,<span class="token string">"salary"</span>:23343,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"技术部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"湖北省武汉市洪山区光谷大厦"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i like to write best elasticsearch article"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:2<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"2"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"员工002"</span>,<span class="token string">"age"</span>:25,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"男"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000002222"</span>,<span class="token string">"salary"</span>:15963,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"销售部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"湖北省武汉市江汉路"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i think java is the best programming language"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:3<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"3"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"员工003"</span>,<span class="token string">"age"</span>:30,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"男"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000003333"</span>,<span class="token string">"salary"</span>:20000,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"技术部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"湖北省武汉市经济开发区"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i am only an elasticsearch beginner"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:4<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"4"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"员工004"</span>,<span class="token string">"age"</span>:20,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"女"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000004444"</span>,<span class="token string">"salary"</span>:15600,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"销售部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"湖北省武汉市沌口开发区"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"elasticsearch and hadoop are all very good solution, i am a beginner"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:5<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"5"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"员工005"</span>,<span class="token string">"age"</span>:20,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"男"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000005555"</span>,<span class="token string">"salary"</span>:19665,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"测试部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"湖北省武汉市东湖隧道"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"spark is best big data solution based on scala, an programming language similar to java"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:6<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"6"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"员工006"</span>,<span class="token string">"age"</span>:30,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"女"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000006666"</span>,<span class="token string">"salary"</span>:30000,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"技术部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"湖北省武汉市江汉路"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i like java developer"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:7<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"7"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"员工007"</span>,<span class="token string">"age"</span>:60,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"女"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000007777"</span>,<span class="token string">"salary"</span>:52130,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"测试部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"湖北省黄冈市边城区"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i like elasticsearch developer"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:8<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"8"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"员工008"</span>,<span class="token string">"age"</span>:19,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"女"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000008888"</span>,<span class="token string">"salary"</span>:60000,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"技术部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"湖北省武汉市江汉大学"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i like spark language"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:9<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"9"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"员工009"</span>,<span class="token string">"age"</span>:40,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"男"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000009999"</span>,<span class="token string">"salary"</span>:23000,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"销售部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"河南省郑州市郑州大学"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i like java developer"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:10<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"10"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"张湖北"</span>,<span class="token string">"age"</span>:35,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"男"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000001010"</span>,<span class="token string">"salary"</span>:18000,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"测试部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"湖北省武汉市东湖高新"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i like java developer, i also like elasticsearch"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:11<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"11"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"王河南"</span>,<span class="token string">"age"</span>:61,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"男"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000001011"</span>,<span class="token string">"salary"</span>:10000,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"销售部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"河南省开封市河南大学"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i am not like java"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:12<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"12"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"张大学"</span>,<span class="token string">"age"</span>:26,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"女"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000001012"</span>,<span class="token string">"salary"</span>:11321,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"测试部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"河南省开封市河南大学"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i am java developer, java is good"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:13<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"13"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"李江汉"</span>,<span class="token string">"age"</span>:36,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"男"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000001013"</span>,<span class="token string">"salary"</span>:11215,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"销售部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"河南省郑州市二七区"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i like java and java is very best, i like it, do you like java"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:14<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"14"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"王技术"</span>,<span class="token string">"age"</span>:45,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"女"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000001014"</span>,<span class="token string">"salary"</span>:16222,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"测试部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"河南省郑州市金水区"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i like c++"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span>:15<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"empId"</span><span class="token builtin class-name">:</span><span class="token string">"15"</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"张测试"</span>,<span class="token string">"age"</span>:18,<span class="token string">"sex"</span><span class="token builtin class-name">:</span><span class="token string">"男"</span>,<span class="token string">"mobile"</span><span class="token builtin class-name">:</span><span class="token string">"19000001015"</span>,<span class="token string">"salary"</span>:20000,<span class="token string">"deptName"</span><span class="token builtin class-name">:</span><span class="token string">"技术部"</span>,<span class="token string">"address"</span><span class="token builtin class-name">:</span><span class="token string">"河南省郑州市高新开发区"</span>,<span class="token string">"content"</span><span class="token builtin class-name">:</span><span class="token string">"i think spark is good"</span><span class="token punctuation">}</span>


GET /employee/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"multi_match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"elasticsearch beginner 湖北省 开封市"</span>,
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"best_fields"</span>,
      <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"content"</span>,
        <span class="token string">"address"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">15</span>
<span class="token punctuation">}</span>
 
 
<span class="token comment"># 查看执行计划</span>
GET /employee/_explain/3
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"multi_match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"elasticsearch beginner 湖北省 开封市"</span>,
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"best_fields"</span>,
      <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"content"</span>,
        <span class="token string">"address"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET /employee/_explain/3
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"multi_match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"elasticsearch beginner 湖北省 开封市"</span>,
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"best_fields"</span>,
      <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"content"</span>,
        <span class="token string">"address"</span>
      <span class="token punctuation">]</span>,
      <span class="token string">"tie_breaker"</span><span class="token builtin class-name">:</span> <span class="token number">0.1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="Most_Fields_643"></a>使用多数字段（Most Fields）搜索</h4> 
<p>most_fields策略获取全部匹配字段的累计得分（综合全部匹配字段的得分），等价于bool should查询方式</p> 
<pre><code class="prism language-bash">GET /employee/_explain/3
<span class="token punctuation">{<!-- --></span>
  
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"multi_match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"elasticsearch beginner 湖北省 开封市"</span>,
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"most_fields"</span>,
      <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"content"</span>,
        <span class="token string">"address"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>案例：</p> 
<pre><code class="prism language-bash">DELETE /titles
PUT /titles
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>,
        <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"english"</span>,
        <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"std"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>,
            <span class="token string">"analyzer"</span><span class="token builtin class-name">:</span> <span class="token string">"standard"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

POST titles/_bulk
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"My dog barks"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"I see a lot of barking dogs on the road "</span> <span class="token punctuation">}</span>

<span class="token comment"># 结果与预期不匹配</span>
GET /titles/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"barking dogs"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>用广度匹配字段title包括尽可能多的文档——以提升召回率——同时又使用字段 title.std 作为信号将相关度更高的文档置于结果顶部。</p> 
<pre><code class="prism language-bash">GET /titles/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"multi_match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"barking dogs"</span>,
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"most_fields"</span>,
      <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"title"</span>,
        <span class="token string">"title.std"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>每个字段对于最终评分的贡献可以通过自定义值boost 来控制。比如，使title 字段更为重要,这样同时也降低了其他信号字段的作用：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 增加title的权重</span>
GET /titles/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"multi_match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"barking dogs"</span>,
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"most_fields"</span>,
      <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"title^10"</span>,
        <span class="token string">"title.std"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="Cross_Field_731"></a>跨字段（Cross Field）搜索</h3> 
<p>搜索内容在多个字段中都显示，类似bool+dis_max组合</p> 
<pre><code class="prism language-bash">DELETE /address
PUT /address
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"settings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"analysis.analyzer.default.type"</span><span class="token builtin class-name">:</span> <span class="token string">"ik_max_word"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /address/_bulk
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"湖南"</span>,<span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"长沙"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"2"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"湖南"</span>,<span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"常德"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"3"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"广东"</span>,<span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"广州"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"4"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"湖南"</span>,<span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"邵阳"</span><span class="token punctuation">}</span>

<span class="token comment"># 使用most_fields的方式结果不符合预期，不支持operator</span>
GET /address/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"multi_match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"湖南常德"</span>,
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"most_fields"</span>,
      <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"province"</span>,<span class="token string">"city"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 可以使用cross_fields，支持operator</span>
<span class="token comment"># 与copy_to相比，其中一个优势就是它可以在搜索时为单个字段提升权重。</span>
GET /address/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"multi_match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"湖南常德"</span>,
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"cross_fields"</span>,
      <span class="token string">"operator"</span><span class="token builtin class-name">:</span> <span class="token string">"and"</span>, 
      <span class="token string">"fields"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"province"</span>,<span class="token string">"city"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以用<code>copy...to</code>解决，但是需要额外的存储空间</p> 
<pre><code class="prism language-bash">DELETE /address
<span class="token comment"># copy_to参数允许将多个字段的值复制到组字段中，然后可以将其作为单个字段进行查询</span>
PUT /address
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"mappings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"properties"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"province"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>,
          <span class="token string">"copy_to"</span><span class="token builtin class-name">:</span> <span class="token string">"full_address"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"city"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"text"</span>,
          <span class="token string">"copy_to"</span><span class="token builtin class-name">:</span> <span class="token string">"full_address"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"settings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"analysis.analyzer.default.type"</span><span class="token builtin class-name">:</span> <span class="token string">"ik_max_word"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /address/_bulk
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"湖南"</span>,<span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"长沙"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"2"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"湖南"</span>,<span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"常德"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"3"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"广东"</span>,<span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"广州"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"4"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"湖南"</span>,<span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"邵阳"</span><span class="token punctuation">}</span>

GET /address/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"full_address"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"湖南常德"</span>,
        <span class="token string">"operator"</span><span class="token builtin class-name">:</span> <span class="token string">"and"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="ElasticSearch_827"></a>ElasticSearch聚合操作</h2> 
<p>Elasticsearch除搜索以外，提供了针对 ES 数据进行统计分析的功能。聚合(aggregations)可以让我们极其方便的实现对数据的统计、分析、运算。例如：</p> 
<ul>
<li>什么品牌的手机最受欢迎？</li>
<li>这些手机的平均价格、最高价格、最低价格？</li>
<li>这些手机每月的销售情况如何？</li>
</ul> 
<p>使用场景：<br>聚合查询可以用于各种场景，比如商业智能、数据挖掘、日志分析等等。</p> 
<ul>
<li>电商平台的销售分析：统计每个地区的销售额、每个用户的消费总额、每个产品的销售量等，以便更好地了解销售情况和趋势。</li>
<li>社交媒体的用户行为分析：统计每个用户的发布次数、转发次数、评论次数等，以便更好地了解用户行为和趋势，同时可以将数据按照地区、时间、话题等维度进行分析。</li>
<li>物流企业的运输分析：统计每个区域的运输量、每个车辆的运输次数、每个司机的行驶里程等，以便更好地了解运输情况和优化运输效率。</li>
<li>金融企业的交易分析：统计每个客户的交易总额、每个产品的销售量、每个交易员的业绩等，以便更好地了解交易情况和优化业务流程。</li>
<li>智能家居的设备监控分析：统计每个设备的使用次数、每个家庭的能源消耗量、每个时间段的设备使用率等，以便更好地了解用户需求和优化设备效能。</li>
</ul> 
<p>基本语法：<br>聚合查询的语法结构与其他查询相似，通常包含以下部分：</p> 
<ul>
<li>查询条件：指定需要聚合的文档，可以使用标准的 Elasticsearch 查询语法，如 term、match、range 等等。</li>
<li>聚合函数：指定要执行的聚合操作，如 sum、avg、min、max、terms、date_histogram 等等。每个聚合命令都会生成一个聚合结果。</li>
<li>聚合嵌套：聚合命令可以嵌套，以便更细粒度地分析数据。</li>
</ul> 
<pre><code class="prism language-bash">GET <span class="token operator">&lt;</span>index_name<span class="token operator">&gt;</span>/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"&lt;aggs_name&gt;"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> // 聚合名称需要自己定义
      <span class="token string">"&lt;agg_type&gt;"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"&lt;field_name&gt;"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul>
<li>aggs_name：聚合函数的名称</li>
<li>agg_type：聚合种类，比如是桶聚合（terms）或者是指标聚合（avg、sum、min、max等）</li>
<li>field_name：字段名称或者叫域名。</li>
</ul> 
<h3>
<a id="_863"></a>聚合的分类</h3> 
<ul><li>Metric Aggregation：—些数学运算，可以对文档字段进行统计分析，类比Mysql中的 min(), max(), sum() 操作。</li></ul> 
<pre><code class="prism language-bash"><span class="token comment"># SELECT MIN(price), MAX(price) FROM products</span>
<span class="token comment"># Metric聚合的DSL类比实现：</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"aggs"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"avg_price"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"avg"</span>:<span class="token punctuation">{<!-- --></span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"price"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>Bucket Aggregation： 一些满足特定条件的文档的集合放置到一个桶里，每一个桶关联一个key，类比Mysql中的group by操作。</li></ul> 
<pre><code class="prism language-bash"><span class="token comment"># ELECT size COUNT(*) FROM products GROUP BY size</span>
<span class="token comment"># bucket聚合的DSL类比实现：</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"by_size"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"size"</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>Pipeline Aggregation：对其他的聚合结果进行二次聚合</li></ul> 
<p>示例数据：</p> 
<pre><code class="prism language-bash">DELETE /employees
<span class="token comment"># 创建索引库</span>
PUT /employees
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"age"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"gender"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"job"</span>:<span class="token punctuation">{<!-- --></span>
         <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"text"</span>,
          <span class="token string">"fields"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"keyword"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>,
              <span class="token string">"ignore_above"</span> <span class="token builtin class-name">:</span> <span class="token number">50</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"name"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"salary"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT /employees/_bulk
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"1"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Emma"</span>,<span class="token string">"age"</span>:32,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Product Manager"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"female"</span>,<span class="token string">"salary"</span>:35000 <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"2"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Underwood"</span>,<span class="token string">"age"</span>:41,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Dev Manager"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">50000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"3"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Tran"</span>,<span class="token string">"age"</span>:25,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Web Designer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span>:18000 <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"4"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Rivera"</span>,<span class="token string">"age"</span>:26,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Web Designer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"female"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">22000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"5"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Rose"</span>,<span class="token string">"age"</span>:25,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"QA"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"female"</span>,<span class="token string">"salary"</span>:18000 <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"6"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Lucy"</span>,<span class="token string">"age"</span>:31,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"QA"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"female"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">25000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"7"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Byrd"</span>,<span class="token string">"age"</span>:27,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"QA"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span>:20000 <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"8"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Foster"</span>,<span class="token string">"age"</span>:27,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Java Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">20000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"9"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Gregory"</span>,<span class="token string">"age"</span>:32,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Java Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span>:22000 <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"10"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Bryant"</span>,<span class="token string">"age"</span>:20,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Java Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">9000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"11"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Jenny"</span>,<span class="token string">"age"</span>:36,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Java Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"female"</span>,<span class="token string">"salary"</span>:38000 <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"12"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Mcdonald"</span>,<span class="token string">"age"</span>:31,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Java Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">32000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"13"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Jonthna"</span>,<span class="token string">"age"</span>:30,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Java Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"female"</span>,<span class="token string">"salary"</span>:30000 <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"14"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Marshall"</span>,<span class="token string">"age"</span>:32,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Javascript Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">25000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"15"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"King"</span>,<span class="token string">"age"</span>:33,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Java Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span>:28000 <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"16"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Mccarthy"</span>,<span class="token string">"age"</span>:21,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Javascript Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">16000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"17"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Goodwin"</span>,<span class="token string">"age"</span>:25,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Javascript Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">16000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"18"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Catherine"</span>,<span class="token string">"age"</span>:29,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"Javascript Programmer"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"female"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">20000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"19"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Boone"</span>,<span class="token string">"age"</span>:30,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"DBA"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"male"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">30000</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"index"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"20"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Kathy"</span>,<span class="token string">"age"</span>:29,<span class="token string">"job"</span><span class="token builtin class-name">:</span><span class="token string">"DBA"</span>,<span class="token string">"gender"</span><span class="token builtin class-name">:</span><span class="token string">"female"</span>,<span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token number">20000</span><span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="Metric_Aggregation_972"></a>Metric Aggregation</h3> 
<ul><li>单值分析︰只输出一个分析结果</li></ul> 
<p>min, max, avg, sum<br>Cardinality（类似distinct Count)</p> 
<ul><li>多值分析：输出多个分析结果</li></ul> 
<p>stats（统计）, extended stats<br>percentile（百分位）, percentile rank<br>top hits（排在前面的示例）</p> 
<p>查询员工的最低最高和平均工资：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 多个 Metric 聚合，找到最低最高和平均工资</span>
POST /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,  
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"max_salary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"max"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"min_salary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"min"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"avg_salary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"avg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>对salary进行统计：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 一个聚合，输出多值</span>
POST /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"stats_salary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"stats"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"salary"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>cardinate对搜索结果去重：</p> 
<pre><code class="prism language-bash">POST /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"cardinate"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"cardinality"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"job.keyword"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="Bucket_Aggregation_1036"></a>Bucket Aggregation</h3> 
<p>按照一定的规则，将文档分配到不同的桶中，从而达到分类的目的。ES提供的一些常见的 Bucket Aggregation。</p> 
<ul><li>Terms，需要字段支持filedata</li></ul> 
<p>keyword 默认支持fielddata<br>text需要在Mapping中开启fielddata，会按照分词后的结果进行分桶</p> 
<ul><li>数字类型</li></ul> 
<p>Range / Data Range<br>Histogram（直方图） / Date Histogram</p> 
<ul><li>支持嵌套: 也就在桶里再做分桶</li></ul> 
<p>桶聚合可以用于各种场景，例如：</p> 
<ul>
<li>对数据进行分组统计，比如按照地区、年龄段、性别等字段进行分组统计。</li>
<li>对时间序列数据进行时间段分析，比如按照每小时、每天、每月、每季度、每年等时间段进行分析。</li>
<li>对各种标签信息分类，并统计其数量。</li>
</ul> 
<p><img src="https://images2.imgbox.com/f3/07/SMtWmT4r_o.png" alt="image.png"></p> 
<h4>
<a id="job_1056"></a>获取job的分类信息</h4> 
<pre><code class="prism language-bash"><span class="token comment"># 对keword 进行聚合</span>
GET /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"job.keyword"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>聚合可配置属性有：</p> 
<ul>
<li>field：指定聚合字段</li>
<li>size：指定聚合结果数量</li>
<li>order：指定聚合结果排序方式</li>
</ul> 
<p>默认情况下，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序。我们可以指定order属性，自定义聚合的排序方式：</p> 
<pre><code class="prism language-bash">GET /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"job.keyword"</span>,
         <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">10</span>,
        <span class="token string">"order"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"_count"</span><span class="token builtin class-name">:</span> <span class="token string">"desc"</span> 
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="_1095"></a>限定聚合范围</h4> 
<pre><code class="prism language-bash"><span class="token comment"># 只对salary在10000元以上的文档聚合</span>
GET /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"range"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"gte"</span><span class="token builtin class-name">:</span> <span class="token number">10000</span> 
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>, 
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"job.keyword"</span>,
         <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">10</span>,
        <span class="token string">"order"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"_count"</span><span class="token builtin class-name">:</span> <span class="token string">"desc"</span> 
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意：对 Text 字段进行 terms 聚合查询，会失败抛出异常</p> 
<pre><code class="prism language-bash">POST /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"job"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a8/40/wQGoDqWC_o.png" alt="image.png"><br>解决办法：对 Text 字段打开 fielddata，支持terms aggregation</p> 
<pre><code class="prism language-bash">PUT /employees/_mapping
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"properties"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"job"</span>:<span class="token punctuation">{<!-- --></span>
       <span class="token string">"type"</span><span class="token builtin class-name">:</span>  <span class="token string">"text"</span>,
       <span class="token string">"fielddata"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 对 Text 字段进行分词，分词后的terms</span>
POST /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"job"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样</p> 
<pre><code class="prism language-bash">POST /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"cardinate"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"cardinality"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"job"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="Range__Histogram_1174"></a>Range &amp; Histogram聚合</h4> 
<ul>
<li>按照数字的范围，进行分桶</li>
<li>在Range Aggregation中，可以自定义Key</li>
</ul> 
<p>Range 示例：按照工资的 Range 分桶</p> 
<pre><code class="prism language-bash"><span class="token comment"># Salary Range分桶，可以自己定义 key</span>

POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"salary_range"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"range"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"salary"</span>,
        <span class="token string">"ranges"</span>:<span class="token punctuation">[</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"to"</span>:10000
          <span class="token punctuation">}</span>,
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"from"</span>:10000,
            <span class="token string">"to"</span>:20000
          <span class="token punctuation">}</span>,
          <span class="token punctuation">{<!-- --></span>
            <span class="token string">"key"</span><span class="token builtin class-name">:</span><span class="token string">"&gt;20000"</span>,
            <span class="token string">"from"</span>:20000
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Histogram示例：按照工资的间隔分桶</p> 
<pre><code class="prism language-bash"><span class="token comment"># 工资0到10万，以 5000一个区间进行分桶</span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"salary_histrogram"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"histogram"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"salary"</span>,
        <span class="token string">"interval"</span>:5000,
        <span class="token string">"extended_bounds"</span>:<span class="token punctuation">{<!-- --></span>
          <span class="token string">"min"</span>:0,
          <span class="token string">"max"</span>:100000
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>top_hits应用场景：当获取分桶后，桶内最匹配的顶部文档列表</p> 
<pre><code class="prism language-bash"><span class="token comment"># 指定size，不同工种中，年纪最大的3个员工的具体信息</span>
POST /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"job.keyword"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"old_employee"</span>:<span class="token punctuation">{<!-- --></span>
          <span class="token string">"top_hits"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"size"</span>:3,
            <span class="token string">"sort"</span>:<span class="token punctuation">[</span>
              <span class="token punctuation">{<!-- --></span>
                <span class="token string">"age"</span>:<span class="token punctuation">{<!-- --></span>
                  <span class="token string">"order"</span><span class="token builtin class-name">:</span><span class="token string">"desc"</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>嵌套聚合示例：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 嵌套聚合1，按照工作类型分桶，并统计工资信息</span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Job_salary_stats"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"job.keyword"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"salary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"stats"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息</span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Job_gender_stats"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"job.keyword"</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"gender_stats"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"gender"</span>
          <span class="token punctuation">}</span>,
          <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"salary_stats"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">"stats"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="Pipeline_Aggregation_1306"></a>Pipeline Aggregation</h3> 
<p>支持对聚合分析的结果，再次进行聚合分析。<br>Pipeline 的分析结果会输出到原结果中，根据位置的不同，分为两类：</p> 
<ul><li>Sibling - 结果和现有分析结果同级</li></ul> 
<p>Max，min，Avg &amp; Sum Bucket<br>Stats，Extended Status Bucket<br>Percentiles Bucket</p> 
<ul><li>Parent - 结果内嵌到现有的聚合分析结果之中</li></ul> 
<p>Derivative(求导)<br>Cumultive Sum(累计求和)<br>Moving Function(移动平均值)</p> 
<p>min_bucket示例：</p> 
<p>在员工数最多的工种里，找出平均工资最低的工种</p> 
<pre><code class="prism language-bash"><span class="token comment"># 平均工资最低的工种</span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"job.keyword"</span>,
        <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"avg_salary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"avg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"min_salary_by_job"</span>:<span class="token punctuation">{<!-- --></span>   
      <span class="token string">"min_bucket"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>    
        <span class="token string">"buckets_path"</span><span class="token builtin class-name">:</span> <span class="token string">"jobs&gt;avg_salary"</span>  
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul>
<li>min_salary_by_job结果和jobs的聚合同级</li>
<li>min_bucket求之前结果的最小值</li>
<li>通过bucket_path关键字指定路径</li>
</ul> 
<p>Stats示例：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 平均工资的统计分析</span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"job.keyword"</span>,
        <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"avg_salary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"avg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"stats_salary_by_job"</span>:<span class="token punctuation">{<!-- --></span>
      <span class="token string">"stats_bucket"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"buckets_path"</span><span class="token builtin class-name">:</span> <span class="token string">"jobs&gt;avg_salary"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>percentiles示例：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 平均工资的百分位数</span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"job.keyword"</span>,
        <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"avg_salary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"avg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"percentiles_salary_by_job"</span>:<span class="token punctuation">{<!-- --></span>
      <span class="token string">"percentiles_bucket"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"buckets_path"</span><span class="token builtin class-name">:</span> <span class="token string">"jobs&gt;avg_salary"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Cumulative_sum示例：</p> 
<pre><code class="prism language-bash"><span class="token comment"># Cumulative_sum 累计求和</span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"histogram"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"age"</span>,
        <span class="token string">"min_doc_count"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
        <span class="token string">"interval"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"avg_salary"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"avg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"cumulative_salary"</span>:<span class="token punctuation">{<!-- --></span>
          <span class="token string">"cumulative_sum"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"buckets_path"</span><span class="token builtin class-name">:</span> <span class="token string">"avg_salary"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="_1437"></a>聚合的作用范围</h3> 
<p>ES聚合分析的默认作用范围是query的查询结果集，同时ES还支持以下方式改变聚合的作用范围：</p> 
<ul>
<li>Filter</li>
<li>Post Filter</li>
<li>Global</li>
</ul> 
<pre><code class="prism language-bash"><span class="token comment"># Query</span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"range"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"gte"</span><span class="token builtin class-name">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"job.keyword"</span>
        
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># Filter</span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"older_person"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"filter"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"range"</span>:<span class="token punctuation">{<!-- --></span>
          <span class="token string">"age"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"from"</span>:35
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span>:<span class="token punctuation">{<!-- --></span>
         <span class="token string">"jobs"</span>:<span class="token punctuation">{<!-- --></span>
           <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"job.keyword"</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span>,
    <span class="token string">"all_jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"job.keyword"</span>
        
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果</span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"job.keyword"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"post_filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"job.keyword"</span><span class="token builtin class-name">:</span> <span class="token string">"Dev Manager"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment"># global </span>
POST employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"range"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"gte"</span><span class="token builtin class-name">:</span> <span class="token number">40</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"jobs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"job.keyword"</span>
        
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    
    <span class="token string">"all"</span>:<span class="token punctuation">{<!-- --></span>
      <span class="token string">"global"</span>:<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,
      <span class="token string">"aggs"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"salary_avg"</span>:<span class="token punctuation">{<!-- --></span>
          <span class="token string">"avg"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"salary"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="ES_1544"></a>ES聚合分析不精准原因分析</h3> 
<p>ElasticSearch在对海量数据进行聚合分析的时候会损失搜索的精准度来满足实时性的需求。<br><img src="https://images2.imgbox.com/62/bc/3g6rVzx1_o.png" alt="image.png"><br>Terms聚合分析的执行流程：<br><img src="https://images2.imgbox.com/fc/cf/W2xwkPYG_o.png" alt="image.png"><br>不精准的原因：数据分散到多个分片，聚合是每个分片的取 Top X，导致结果不精准。ES 可以不每个分片Top X，而是全量聚合，但势必这会有很大的性能问题。<br><img src="https://images2.imgbox.com/c3/ce/YO7x0hS5_o.png" alt="image.png"></p> 
<p>如何提高聚合精确度？</p> 
<p><strong>方案1：设置主分片为1</strong><br>注意7.x版本已经默认为1。<br>适用场景：数据量小的小集群规模业务场景。</p> 
<p><strong>方案2：调大 shard_size 值</strong><br>设置 shard_size 为比较大的值，官方推荐：<code>size*1.5+10</code>。shard_size 值越大，结果越趋近于精准聚合结果值。此外，还可以通过show_term_doc_count_error参数显示最差情况下的错误值，用于辅助确定 shard_size 大小。</p> 
<ul>
<li>size：是聚合结果的返回值，客户期望返回聚合排名前三，size值就是 3；</li>
<li>shard_size: 每个分片上聚合的数据条数。shard_size 原则上要大于等于 size；</li>
</ul> 
<p>适用场景：数据量大、分片数多的集群业务场景。</p> 
<p>测试，使用kibana的测试数据<br><img src="https://images2.imgbox.com/4d/7c/EtGoMgH1_o.png" alt="image.png"></p> 
<pre><code class="prism language-bash">DELETE my_flights
PUT my_flights
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"number_of_shards"</span><span class="token builtin class-name">:</span> <span class="token number">20</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"mappings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"properties"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"AvgTicketPrice"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"float"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"Cancelled"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"boolean"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"Carrier"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"Dest"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"DestAirportID"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"DestCityName"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"DestCountry"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"DestLocation"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"geo_point"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"DestRegion"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"DestWeather"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"DistanceKilometers"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"float"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"DistanceMiles"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"float"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"FlightDelay"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"boolean"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"FlightDelayMin"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"integer"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"FlightDelayType"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"FlightNum"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"FlightTimeHour"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"FlightTimeMin"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"float"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"Origin"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"OriginAirportID"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"OriginCityName"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"OriginCountry"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"OriginLocation"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"geo_point"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"OriginRegion"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"OriginWeather"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"dayOfWeek"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"integer"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"timestamp"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"date"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

POST _reindex
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"kibana_sample_data_flights"</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"dest"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"my_flights"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET my_flights/_count
GET kibana_sample_data_flights/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"weather"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"OriginWeather"</span>,
        <span class="token string">"size"</span>:5,
        <span class="token string">"show_term_doc_count_error"</span>:true
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET my_flights/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"weather"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"OriginWeather"</span>,
        <span class="token string">"size"</span>:5,
        <span class="token string">"shard_size"</span>:10,
        <span class="token string">"show_term_doc_count_error"</span>:true
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5d/ba/64pXNppl_o.png" alt="image.png"><br>在Terms Aggregation的返回中有两个特殊的数值：</p> 
<ul>
<li>doc_count_error_upper_bound：被遗漏的 term 分桶，包含的文档，有可能的最大值；</li>
<li>sum_other_doc_count：除了返回结果 bucket 的 terms 以外，其他 terms 的文档总数（总数-返回的总数)；</li>
</ul> 
<p><strong>方案3：将size设置为全量值，来解决精度问题</strong><br>将size设置为2的32次方减去1也就是分片支持的最大值，来解决精度问题。<br>原因：1.x版本，size等于 0 代表全部，高版本取消 0 值，所以设置了最大值（大于业务的全量值）。<br>全量带来的弊端就是：如果分片数据量极大，这样做会耗费巨大的CPU 资源来排序，而且可能会阻塞网络。<br>适用场景：对聚合精准度要求极高的业务场景，由于性能问题，不推荐使用。</p> 
<p><strong>方案4：使用Clickhouse/ Spark 进行精准聚合</strong><br>适用场景：数据量非常大、聚合精度要求高、响应速度快的业务场景。</p> 
<h3>
<a id="Elasticsearch__1702"></a>Elasticsearch 聚合性能优化</h3> 
<h4>
<a id="_eager_global_ordinals__1703"></a>启用 eager global ordinals 提升高基数聚合性能</h4> 
<p>适用场景：高基数聚合。高基数聚合场景中的高基数含义：一个字段包含很大比例的唯一值。<br>global ordinals 中文翻译成全局序号，是一种数据结构，应用场景如下：</p> 
<ul>
<li>基于 keyword、ip 等字段的分桶聚合，包含：terms聚合、composite 聚合等。</li>
<li>基于 text 字段的分桶聚合（前提条件是：fielddata 开启）。</li>
<li>基于父子文档 Join 类型的 has_child 查询和父聚合。</li>
</ul> 
<p>global ordinals 使用一个数值代表字段中的字符串值，然后为每一个数值分配一个 bucket（分桶）。<br>global ordinals 的本质是：启用 eager_global_ordinals 时，会在刷新（refresh）分片时构建全局序号。这将构建全局序号的成本从搜索阶段转移到了数据索引化（写入）阶段。<br>创建索引的同时开启：eager_global_ordinals。</p> 
<pre><code class="prism language-bash">PUT /my-index
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>,
        <span class="token string">"eager_global_ordinals"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意：开启 eager_global_ordinals 会影响写入性能，因为每次刷新时都会创建新的全局序号。为了最大程度地减少由于频繁刷新建立全局序号而导致的额外开销，请调大刷新间隔 refresh_interval。<br>动态调整刷新频率的方法如下：</p> 
<pre><code class="prism language-bash">PUT my-index/_settings
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"refresh_interval"</span><span class="token builtin class-name">:</span> <span class="token string">"30s"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该招数的本质是：以空间换时间。</p> 
<h4>
<a id="_1732"></a>插入数据时对索引进行预排序</h4> 
<ul>
<li>Index sorting （索引排序）可用于在插入时对索引进行预排序，而不是在查询时再对索引进行排序，这将提高范围查询（range query）和排序操作的性能。</li>
<li>在 Elasticsearch 中创建新索引时，可以配置如何对每个分片内的段进行排序。</li>
<li>这是 Elasticsearch 6.X 之后版本才有的特性。</li>
</ul> 
<pre><code class="prism language-bash">PUT /my_index
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"settings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"index"</span>:<span class="token punctuation">{<!-- --></span>
      <span class="token string">"sort.field"</span><span class="token builtin class-name">:</span> <span class="token string">"create_time"</span>,
      <span class="token string">"sort.order"</span><span class="token builtin class-name">:</span> <span class="token string">"desc"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"create_time"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"date"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意：预排序将增加 Elasticsearch 写入的成本。在某些用户特定场景下，开启索引预排序会导致大约 40%-50% 的写性能下降。也就是说，如果用户场景更关注写性能的业务，开启索引预排序不是一个很好的选择。</p> 
<h4>
<a id="_1756"></a>使用节点查询缓存</h4> 
<p>节点查询缓存（Node query cache）可用于有效缓存过滤器（filter）操作的结果。如果多次执行同一 filter 操作，这将很有效，但是即便更改过滤器中的某一个值，也将意味着需要计算新的过滤器结果。<br>例如，由于 “now” 值一直在变化，因此无法缓存在过滤器上下文中使用 “now” 的查询。<br>那怎么使用缓存呢？通过在 now 字段上应用 datemath 格式将其四舍五入到最接近的分钟/小时等，可以使此类请求更具可缓存性，以便可以对筛选结果进行缓存。</p> 
<pre><code class="prism language-bash">PUT /my_index/_doc/1
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"create_time"</span><span class="token builtin class-name">:</span><span class="token string">"2022-05-11T16:30:55.328Z"</span>
<span class="token punctuation">}</span>

<span class="token comment"># 下面的示例无法使用缓存</span>
GET /my_index/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
    <span class="token string">"constant_score"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"range"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"create_time"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"gte"</span><span class="token builtin class-name">:</span> <span class="token string">"now-1h"</span>,
            <span class="token string">"lte"</span><span class="token builtin class-name">:</span> <span class="token string">"now"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 下面的示例就可以使用节点查询缓存。</span>
GET /my_index/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
    <span class="token string">"constant_score"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"range"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"create_time"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"gte"</span><span class="token builtin class-name">:</span> <span class="token string">"now-1h/m"</span>,
            <span class="token string">"lte"</span><span class="token builtin class-name">:</span> <span class="token string">"now/m"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述示例中的“now-1h/m” 就是 datemath 的格式。<br>如果当前时间 now 是：16:31:29，那么 range query 将匹配 my_date 介于：15:31:00 和 15:31:59 之间的时间数据。同理，聚合的前半部分 query 中如果有基于时间查询，或者后半部分 aggs 部分中有基于时间聚合的，建议都使用 datemath 方式做缓存处理以优化性能。</p> 
<h4>
<a id="_1799"></a>使用分片请求缓存</h4> 
<p>聚合语句中，设置：<code>size:0</code>，就会使用分片请求缓存缓存结果。size = 0 的含义是：只返回聚合结果，不返回查询结果。</p> 
<pre><code class="prism language-bash">GET /es_db/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"remark_agg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"remark.keyword"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="_1814"></a>拆分聚合，使聚合并行化</h4> 
<p>Elasticsearch 查询条件中同时有多个条件聚合，默认情况下聚合不是并行运行的。当为每个聚合提供自己的查询并执行 msearch 时，性能会有显著提升。因此，在 CPU 资源不是瓶颈的前提下，如果想缩短响应时间，可以将多个聚合拆分为多个查询，借助：msearch 实现并行聚合。</p> 
<pre><code class="prism language-bash"><span class="token comment"># 常规的多条件聚合实现</span>
GET /employees/_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
  <span class="token string">"aggs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"job_agg"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"job.keyword"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"max_salary"</span>:<span class="token punctuation">{<!-- --></span>
      <span class="token string">"max"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># msearch 拆分多个语句的聚合实现</span>
GET _msearch
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span><span class="token builtin class-name">:</span><span class="token string">"employees"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"size"</span>:0,<span class="token string">"aggs"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"job_agg"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"terms"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"job.keyword"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"index"</span><span class="token builtin class-name">:</span><span class="token string">"employees"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"size"</span>:0,<span class="token string">"aggs"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"max_salary"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"max"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"salary"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>