<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Flutter 手势GestureDetector解析 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flutter 手势GestureDetector解析</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <p>对于移动端的开发者来说，手势是一个非常重要的模块，基本上做任何App都会遇到各种各样的手势问题，而手势也是移动的一个不算小的模块吧，要彻底搞得还是得费一些时间的，如果之前对Android或者IOS的手势或者说点击事件的原理有所了解的，那么了解其它语言的手势原理相对来说帮助还是挺大的。</p> 
<p>好了，切入正题。在Flutter中，对于Flutter有一定了解的人都知道，可以通过GestureDetector来给不具有点击事件或者手势回调的Widget添加手势回调。然后为了点击水波纹的点击效果，大多数开发者可能会使用InkWell widget来包装一个需要添加点击事件的控件。</p> 
<h4>
<a id="_InkWell__GestureDetector_4"></a>前戏部分： InkWell 和 GestureDetector的区别</h4> 
<p>对Flutter有一一些深入了解的人可能知道，InkWell就是对GestureDetector的一个封装。看图：<br> <img src="https://images2.imgbox.com/ab/17/32CIKpSV_o.png" alt="在这里插入图片描述"></p> 
<ol>
<li>InkWell是继承于InkResponse，</li>
<li>InkResponse是集成于StatelessWidget类，</li>
<li>在onBuild中返回了_InkResponseStateWidget</li>
</ol> 
<p><font color="red"> 由于以上这部分代码没有什么逻辑，为了减少篇幅我就不贴源码了。</font><br> _InkResponseStateWidget中的核心代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">return</span> <span class="token function">_ParentInkResponseProvider</span><span class="token punctuation">(</span>
      state<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
      child<span class="token operator">:</span> <span class="token class-name">Actions</span><span class="token punctuation">(</span>
        actions<span class="token operator">:</span> _actionMap<span class="token punctuation">,</span>
        child<span class="token operator">:</span> <span class="token class-name">Focus</span><span class="token punctuation">(</span>
          focusNode<span class="token operator">:</span> widget<span class="token punctuation">.</span>focusNode<span class="token punctuation">,</span>
          canRequestFocus<span class="token operator">:</span> _canRequestFocus<span class="token punctuation">,</span>
          onFocusChange<span class="token operator">:</span> _handleFocusUpdate<span class="token punctuation">,</span>
          autofocus<span class="token operator">:</span> widget<span class="token punctuation">.</span>autofocus<span class="token punctuation">,</span>
          child<span class="token operator">:</span> <span class="token class-name">MouseRegion</span><span class="token punctuation">(</span>
            cursor<span class="token operator">:</span> effectiveMouseCursor<span class="token punctuation">,</span>
            onEnter<span class="token operator">:</span> _handleMouseEnter<span class="token punctuation">,</span>
            onExit<span class="token operator">:</span> _handleMouseExit<span class="token punctuation">,</span>
            child<span class="token operator">:</span> <span class="token class-name">Semantics</span><span class="token punctuation">(</span>
              onTap<span class="token operator">:</span> widget<span class="token punctuation">.</span>excludeFromSemantics <span class="token operator">||</span> widget<span class="token punctuation">.</span>onTap <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> _simulateTap<span class="token punctuation">,</span>
              onLongPress<span class="token operator">:</span> widget<span class="token punctuation">.</span>excludeFromSemantics <span class="token operator">||</span> widget<span class="token punctuation">.</span>onLongPress <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> _simulateLongPress<span class="token punctuation">,</span>
              child<span class="token operator">:</span> <span class="token class-name">GestureDetector</span><span class="token punctuation">(</span><span class="token comment">//InkWell手势的来源</span>
                onTapDown<span class="token operator">:</span> enabled <span class="token operator">?</span> _handleTapDown <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                onTap<span class="token operator">:</span> enabled <span class="token operator">?</span> _handleTap <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                onTapCancel<span class="token operator">:</span> enabled <span class="token operator">?</span> _handleTapCancel <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                onDoubleTap<span class="token operator">:</span> widget<span class="token punctuation">.</span>onDoubleTap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> _handleDoubleTap <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                onLongPress<span class="token operator">:</span> widget<span class="token punctuation">.</span>onLongPress <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> _handleLongPress <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                behavior<span class="token operator">:</span> <span class="token class-name">HitTestBehavior</span><span class="token punctuation">.</span>opaque<span class="token punctuation">,</span>
                excludeFromSemantics<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                child<span class="token operator">:</span> widget<span class="token punctuation">.</span>child<span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>通过上述代码可以看出，GestureDetector是Flutter中手势的一个最基本类，我们可以直接用，也可以给予GestureDetector来做一些列的自定义封装</strong></p> 
<h4>
<a id="_48"></a>切入正题</h4> 
<h4>
<a id="_GestureDetector_49"></a>一、 GestureDetector简介</h4> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">GestureDetector</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// 省略代码</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font color="red">/// A widget that detects gestures.<br> ///<br> /// Attempts to recognize gestures that correspond to its non-null callbacks.<br> ///<br> /// If this widget has a child, it defers to that child for its sizing behavior.<br> /// If it does not have a child, it grows to fit the parent instead.<br> ///<br> /// By default a GestureDetector with an invisible child ignores touches;<br> /// this behavior can be controlled with [behavior].</font><br> 这个是官方简介，我理解的大概意思就是说GestureDetector是一个小控件，事件的点击区域会以子控件为准，如果子控件为不可见或者没有子控件，则会去适应父控件，而这个行为可以通过behavior属性来控制。这块内容不是今天的重点，我们先看重点吧。</p> 
<h4>
<a id="GestureDetector_67"></a>二、GestureDetector功能解析</h4> 
<p>既然是Widiget，那么核心代码肯定在onBuild中，我们直接先看看一下源码。</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">GestureRecognizerFactory</span><span class="token punctuation">&gt;</span></span> gestures <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">GestureRecognizerFactory</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>onTapDown <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onTapUp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onTap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onTapCancel <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onSecondaryTap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onSecondaryTapDown <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onSecondaryTapUp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onSecondaryTapCancel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token operator">||</span>
        onTertiaryTapDown <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onTertiaryTapUp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onTertiaryTapCancel <span class="token operator">!=</span> <span class="token keyword">null</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gestures<span class="token punctuation">[</span><span class="token class-name">TapGestureRecognizer</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">GestureRecognizerFactoryWithHandlers</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TapGestureRecognizer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">TapGestureRecognizer</span><span class="token punctuation">(</span>debugOwner<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token class-name">TapGestureRecognizer</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          instance
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onTapDown <span class="token operator">=</span> onTapDown
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onTapUp <span class="token operator">=</span> onTapUp
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onTap <span class="token operator">=</span> onTap
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onTapCancel <span class="token operator">=</span> onTapCancel
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onSecondaryTap <span class="token operator">=</span> onSecondaryTap
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onSecondaryTapDown <span class="token operator">=</span> onSecondaryTapDown
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onSecondaryTapUp <span class="token operator">=</span> onSecondaryTapUp
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onSecondaryTapCancel <span class="token operator">=</span> onSecondaryTapCancel
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onTertiaryTapDown <span class="token operator">=</span> onTertiaryTapDown
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onTertiaryTapUp <span class="token operator">=</span> onTertiaryTapUp
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onTertiaryTapCancel <span class="token operator">=</span> onTertiaryTapCancel<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>onDoubleTap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gestures<span class="token punctuation">[</span><span class="token class-name">DoubleTapGestureRecognizer</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">GestureRecognizerFactoryWithHandlers</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DoubleTapGestureRecognizer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">DoubleTapGestureRecognizer</span><span class="token punctuation">(</span>debugOwner<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token class-name">DoubleTapGestureRecognizer</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          instance
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onDoubleTapDown <span class="token operator">=</span> onDoubleTapDown
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onDoubleTap <span class="token operator">=</span> onDoubleTap
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onDoubleTapCancel <span class="token operator">=</span> onDoubleTapCancel<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>onLongPress <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onLongPressUp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onLongPressStart <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onLongPressMoveUpdate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onLongPressEnd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onSecondaryLongPress <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onSecondaryLongPressUp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onSecondaryLongPressStart <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onSecondaryLongPressMoveUpdate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onSecondaryLongPressEnd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gestures<span class="token punctuation">[</span><span class="token class-name">LongPressGestureRecognizer</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">GestureRecognizerFactoryWithHandlers</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LongPressGestureRecognizer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">LongPressGestureRecognizer</span><span class="token punctuation">(</span>debugOwner<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token class-name">LongPressGestureRecognizer</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          instance
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onLongPress <span class="token operator">=</span> onLongPress
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onLongPressStart <span class="token operator">=</span> onLongPressStart
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onLongPressMoveUpdate <span class="token operator">=</span> onLongPressMoveUpdate
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onLongPressEnd <span class="token operator">=</span> onLongPressEnd
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onLongPressUp <span class="token operator">=</span> onLongPressUp
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onSecondaryLongPress <span class="token operator">=</span> onSecondaryLongPress
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onSecondaryLongPressStart <span class="token operator">=</span> onSecondaryLongPressStart
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onSecondaryLongPressMoveUpdate <span class="token operator">=</span> onSecondaryLongPressMoveUpdate
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onSecondaryLongPressEnd <span class="token operator">=</span> onSecondaryLongPressEnd
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onSecondaryLongPressUp <span class="token operator">=</span> onSecondaryLongPressUp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>onVerticalDragDown <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onVerticalDragStart <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onVerticalDragUpdate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onVerticalDragEnd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onVerticalDragCancel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gestures<span class="token punctuation">[</span><span class="token class-name">VerticalDragGestureRecognizer</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">GestureRecognizerFactoryWithHandlers</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VerticalDragGestureRecognizer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">VerticalDragGestureRecognizer</span><span class="token punctuation">(</span>debugOwner<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token class-name">VerticalDragGestureRecognizer</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          instance
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onDown <span class="token operator">=</span> onVerticalDragDown
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onStart <span class="token operator">=</span> onVerticalDragStart
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onUpdate <span class="token operator">=</span> onVerticalDragUpdate
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onEnd <span class="token operator">=</span> onVerticalDragEnd
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onCancel <span class="token operator">=</span> onVerticalDragCancel
            <span class="token punctuation">.</span><span class="token punctuation">.</span>dragStartBehavior <span class="token operator">=</span> dragStartBehavior<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>onHorizontalDragDown <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onHorizontalDragStart <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onHorizontalDragUpdate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onHorizontalDragEnd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onHorizontalDragCancel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gestures<span class="token punctuation">[</span><span class="token class-name">HorizontalDragGestureRecognizer</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">GestureRecognizerFactoryWithHandlers</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HorizontalDragGestureRecognizer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">HorizontalDragGestureRecognizer</span><span class="token punctuation">(</span>debugOwner<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token class-name">HorizontalDragGestureRecognizer</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          instance
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onDown <span class="token operator">=</span> onHorizontalDragDown
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onStart <span class="token operator">=</span> onHorizontalDragStart
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onUpdate <span class="token operator">=</span> onHorizontalDragUpdate
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onEnd <span class="token operator">=</span> onHorizontalDragEnd
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onCancel <span class="token operator">=</span> onHorizontalDragCancel
            <span class="token punctuation">.</span><span class="token punctuation">.</span>dragStartBehavior <span class="token operator">=</span> dragStartBehavior<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>onPanDown <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onPanStart <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onPanUpdate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onPanEnd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onPanCancel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gestures<span class="token punctuation">[</span><span class="token class-name">PanGestureRecognizer</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">GestureRecognizerFactoryWithHandlers</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PanGestureRecognizer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">PanGestureRecognizer</span><span class="token punctuation">(</span>debugOwner<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token class-name">PanGestureRecognizer</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          instance
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onDown <span class="token operator">=</span> onPanDown
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onStart <span class="token operator">=</span> onPanStart
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onUpdate <span class="token operator">=</span> onPanUpdate
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onEnd <span class="token operator">=</span> onPanEnd
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onCancel <span class="token operator">=</span> onPanCancel
            <span class="token punctuation">.</span><span class="token punctuation">.</span>dragStartBehavior <span class="token operator">=</span> dragStartBehavior<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>onScaleStart <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> onScaleUpdate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> onScaleEnd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gestures<span class="token punctuation">[</span><span class="token class-name">ScaleGestureRecognizer</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">GestureRecognizerFactoryWithHandlers</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScaleGestureRecognizer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">ScaleGestureRecognizer</span><span class="token punctuation">(</span>debugOwner<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token class-name">ScaleGestureRecognizer</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          instance
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onStart <span class="token operator">=</span> onScaleStart
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onUpdate <span class="token operator">=</span> onScaleUpdate
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onEnd <span class="token operator">=</span> onScaleEnd
            <span class="token punctuation">.</span><span class="token punctuation">.</span>dragStartBehavior <span class="token operator">=</span> dragStartBehavior<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>onForcePressStart <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onForcePressPeak <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onForcePressUpdate <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        onForcePressEnd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gestures<span class="token punctuation">[</span><span class="token class-name">ForcePressGestureRecognizer</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">GestureRecognizerFactoryWithHandlers</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ForcePressGestureRecognizer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">ForcePressGestureRecognizer</span><span class="token punctuation">(</span>debugOwner<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token class-name">ForcePressGestureRecognizer</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          instance
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onStart <span class="token operator">=</span> onForcePressStart
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onPeak <span class="token operator">=</span> onForcePressPeak
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onUpdate <span class="token operator">=</span> onForcePressUpdate
            <span class="token punctuation">.</span><span class="token punctuation">.</span>onEnd <span class="token operator">=</span> onForcePressEnd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token class-name">RawGestureDetector</span><span class="token punctuation">(</span>
      gestures<span class="token operator">:</span> gestures<span class="token punctuation">,</span>
      behavior<span class="token operator">:</span> behavior<span class="token punctuation">,</span>
      excludeFromSemantics<span class="token operator">:</span> excludeFromSemantics<span class="token punctuation">,</span>
      child<span class="token operator">:</span> child<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>代码相当的长，看着很复杂，其实逻辑非常的简单。就是注册手势的识别器。</p> 
<pre><code class="prism language-java">   <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">GestureRecognizerFactory</span><span class="token punctuation">&gt;</span></span> gestures <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">GestureRecognizerFactory</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h5>
<a id="_244"></a>将逻辑细分一下：</h5> 
<ol>
<li>创建一个Map容器gestures</li>
<li>添加单击识别器</li>
<li>添加双击识别器</li>
<li>添加纵向(y轴方向)滑动识别器</li>
<li>添加横向(x轴方向)滑动识别器</li>
<li>添加双向(y轴和x轴)同时滑动识别器</li>
<li>添加缩放手势识别器</li>
<li>添加带有力传感器的识别器</li>
<li>最后根据这些参数创建一个RawGestureDetector控件。</li>
</ol> 
<p>当然，添加这些手势识别器的前提条件就是有回调需求，也就是if中的那些判断。因此通过上述代码可以总结出我们通过使用GestureDetector的功能可以理解为再有需要的情况下注册手势识别器的监听，那么既然有监听，肯定就有地方将事件发送出来。</p> 
<h4>
<a id="_257"></a>三、手势事件分发跟踪</h4> 
<p>因为flutter中的很多方法都是回调的方式，而且很多源码都是接口的形式去调用的，直接扒源码比较难，因此我们通过打断点观察方法调用栈的形式来追踪手势的传递过程。<br> <img src="https://images2.imgbox.com/2c/30/5mIhc6rJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/59/ce/mhAM4X0z_o.png" alt="在这里插入图片描述"><br> 上面两个截图，一个是通过InkWell来注册一个手势回调，第二个截图则是方法调用栈。从这个断点可以看到，点击手势的最终来源于Honks.dart文件中的_dispatchPointerDataPacket方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@pragma</span><span class="token punctuation">(</span><span class="token string">'vm:entry-point'</span><span class="token punctuation">)</span>
<span class="token comment">// ignore: unused_element</span>
<span class="token keyword">void</span> <span class="token function">_dispatchPointerDataPacket</span><span class="token punctuation">(</span><span class="token class-name">ByteData</span> packet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">PlatformDispatcher</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">_dispatchPointerDataPacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>源码比较简单，就是从引擎VM中获取到点击屏幕的一个ByteData数据包，拿到之后就丢给PlatformDispatcher中的方法去处理。<br> 再看PlatformDispathcer._dispatchPointerDataPacket方法</p> 
<pre><code class="prism language-java">  <span class="token comment">// Called from the engine, via hooks.dart</span>
  <span class="token keyword">void</span> <span class="token function">_dispatchPointerDataPacket</span><span class="token punctuation">(</span><span class="token class-name">ByteData</span> packet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onPointerDataPacket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      _invoke1<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointerDataPacket</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        onPointerDataPacket<span class="token punctuation">,</span>
        _onPointerDataPacketZone<span class="token punctuation">,</span>
        <span class="token function">_unpackPointerDataPacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>上面这部分不是核心代码，只是一个方法的调用，核心代码_unpackPointerDataPacket方法中的逻辑，如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token class-name">PointerDataPacket</span> <span class="token function">_unpackPointerDataPacket</span><span class="token punctuation">(</span><span class="token class-name">ByteData</span> packet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> kStride <span class="token operator">=</span> <span class="token class-name">Int64List</span><span class="token punctuation">.</span>bytesPerElement<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> kBytesPerPointerData <span class="token operator">=</span> _kPointerDataFieldCount <span class="token operator">*</span> kStride<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> length <span class="token operator">=</span> packet<span class="token punctuation">.</span>lengthInBytes <span class="token operator">~</span><span class="token operator">/</span> kBytesPerPointerData<span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>length <span class="token operator">*</span> kBytesPerPointerData <span class="token operator">==</span> packet<span class="token punctuation">.</span>lengthInBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointerData</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointerData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">int</span> offset <span class="token operator">=</span> i <span class="token operator">*</span> _kPointerDataFieldCount<span class="token punctuation">;</span>
      data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">PointerData</span><span class="token punctuation">(</span>
        embedderId<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        timeStamp<span class="token operator">:</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>microseconds<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        change<span class="token operator">:</span> <span class="token class-name">PointerChange</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span>packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        kind<span class="token operator">:</span> <span class="token class-name">PointerDeviceKind</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span>packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        signalKind<span class="token operator">:</span> <span class="token class-name">PointerSignalKind</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span>packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        device<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        pointerIdentifier<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        physicalX<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        physicalY<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        physicalDeltaX<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        physicalDeltaY<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        buttons<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        obscured<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        synthesized<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        pressure<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        pressureMin<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        pressureMax<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        distance<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        distanceMax<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        size<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        radiusMajor<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        radiusMinor<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        radiusMin<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        radiusMax<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        orientation<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        tilt<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        platformData<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getInt64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        scrollDeltaX<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
        scrollDeltaY<span class="token operator">:</span> packet<span class="token punctuation">.</span><span class="token function">getFloat64</span><span class="token punctuation">(</span>kStride <span class="token operator">*</span> offset<span class="token operator">++</span><span class="token punctuation">,</span> _kFakeHostEndian<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span>offset <span class="token operator">==</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> _kPointerDataFieldCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">PointerDataPacket</span><span class="token punctuation">(</span>data<span class="token operator">:</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这块代码的计算逻辑比较复杂，如果不细看，只是了解大概逻辑的话，还是比较好理解的。就是从引擎获取到的Bytedata中解析出PointerData。这个PointerData中包含了<font color="red">屏幕的物理触摸位置相关的数据</font>。</p> 
<p>根据最开始的那张方法调用栈可以看到，接下来调用的是</p> 
<pre><code class="prism language-java"><span class="token class-name">GestureBinding</span><span class="token punctuation">.</span>_handlePointerDataPacket <span class="token punctuation">(</span>binding<span class="token punctuation">.</span>dart<span class="token operator">:</span><span class="token number">279</span><span class="token punctuation">)</span>
_rootRunUnary <span class="token punctuation">(</span>zone<span class="token punctuation">.</span>dart<span class="token operator">:</span><span class="token number">1370</span><span class="token punctuation">)</span>
_CustomZone<span class="token punctuation">.</span>runUnary <span class="token punctuation">(</span>zone<span class="token punctuation">.</span>dart<span class="token operator">:</span><span class="token number">1265</span><span class="token punctuation">)</span>
_CustomZone<span class="token punctuation">.</span>runUnaryGuarded <span class="token punctuation">(</span>zone<span class="token punctuation">.</span>dart<span class="token operator">:</span><span class="token number">1170</span><span class="token punctuation">)</span>
_invoke1 <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span>dart<span class="token operator">:</span><span class="token number">182</span><span class="token punctuation">)</span>
</code></pre> 
<p>这5个方法，由于前4个方法（从下往上）基本上没啥业务逻辑，都是callback回调，这就不细讲了，重点关注一下GestureBinding._handlePointerDataPacket 这个方法，从方法名可以猜到，就是处理PointerData的方法。</p> 
<pre><code class="prism language-java">  <span class="token keyword">void</span> <span class="token function">_handlePointerDataPacket</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerDataPacket</span> packet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// We convert pointer data to logical pixels so that e.g. the touch slop can be</span>
    <span class="token comment">// defined in a device-independent manner.</span>
    _pendingPointerEvents<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">PointerEventConverter</span><span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>data<span class="token punctuation">,</span> window<span class="token punctuation">.</span>devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>locked<span class="token punctuation">)</span>
      <span class="token function">_flushPointerEventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>从这个方法的内容可以看出，这个方法主要做的事情</p> 
<ol>
<li>PointerData数据解析成PointerEvent</li>
<li>将PointerEvent添加到_pendingPointerEvents队列中</li>
<li>处理完之后再从队列里取出这些数据。</li>
</ol> 
<p>看一下转化过程的源代码，大概了解一下逻辑就好了。</p> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointerEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">expand</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerData</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">,</span> <span class="token keyword">double</span> devicePixelRatio<span class="token punctuation">)</span> sync<span class="token operator">*</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerData</span> datum in data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//根据分辨率计算逻辑位置</span>
      <span class="token keyword">final</span> <span class="token class-name">Offset</span> position <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>physicalX<span class="token punctuation">,</span> datum<span class="token punctuation">.</span>physicalY<span class="token punctuation">)</span> <span class="token operator">/</span> devicePixelRatio<span class="token punctuation">;</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span>position <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token class-name">Offset</span> delta <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>physicalDeltaX<span class="token punctuation">,</span> datum<span class="token punctuation">.</span>physicalDeltaY<span class="token punctuation">)</span> <span class="token operator">/</span> devicePixelRatio<span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">double</span> radiusMinor <span class="token operator">=</span> <span class="token function">_toLogicalPixels</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>radiusMinor<span class="token punctuation">,</span> devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">double</span> radiusMajor <span class="token operator">=</span> <span class="token function">_toLogicalPixels</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>radiusMajor<span class="token punctuation">,</span> devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">double</span> radiusMin <span class="token operator">=</span> <span class="token function">_toLogicalPixels</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>radiusMin<span class="token punctuation">,</span> devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token keyword">double</span> radiusMax <span class="token operator">=</span> <span class="token function">_toLogicalPixels</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>radiusMax<span class="token punctuation">,</span> devicePixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token class-name">Duration</span> timeStamp <span class="token operator">=</span> datum<span class="token punctuation">.</span>timeStamp<span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token class-name">PointerDeviceKind</span> kind <span class="token operator">=</span> datum<span class="token punctuation">.</span>kind<span class="token punctuation">;</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>change <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>datum<span class="token punctuation">.</span>signalKind <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> datum<span class="token punctuation">.</span>signalKind <span class="token operator">==</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerSignalKind</span><span class="token punctuation">.</span>none<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>datum<span class="token punctuation">.</span>change<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerChange</span><span class="token punctuation">.</span>add<span class="token operator">:</span>
            <span class="token keyword">yield</span> <span class="token class-name">PointerAddedEvent</span><span class="token punctuation">(</span>
              <span class="token comment">//省略参数</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerChange</span><span class="token punctuation">.</span>hover<span class="token operator">:</span>
            <span class="token keyword">yield</span> <span class="token class-name">PointerHoverEvent</span><span class="token punctuation">(</span>
               <span class="token comment">//省略参数</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerChange</span><span class="token punctuation">.</span>down<span class="token operator">:</span>
            <span class="token keyword">yield</span> <span class="token class-name">PointerDownEvent</span><span class="token punctuation">(</span>
              <span class="token comment">//省略参数</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerChange</span><span class="token punctuation">.</span>move<span class="token operator">:</span>
            <span class="token keyword">yield</span> <span class="token class-name">PointerMoveEvent</span><span class="token punctuation">(</span>
               <span class="token comment">//省略参数</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerChange</span><span class="token punctuation">.</span>up<span class="token operator">:</span>
            <span class="token keyword">yield</span> <span class="token class-name">PointerUpEvent</span><span class="token punctuation">(</span>
               <span class="token comment">//省略参数</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerChange</span><span class="token punctuation">.</span>cancel<span class="token operator">:</span>
            <span class="token keyword">yield</span> <span class="token class-name">PointerCancelEvent</span><span class="token punctuation">(</span>
               <span class="token comment">//省略参数</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerChange</span><span class="token punctuation">.</span>remove<span class="token operator">:</span>
            <span class="token keyword">yield</span> <span class="token class-name">PointerRemovedEvent</span><span class="token punctuation">(</span>
              <span class="token comment">//省略参数</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>datum<span class="token punctuation">.</span>signalKind<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerSignalKind</span><span class="token punctuation">.</span>scroll<span class="token operator">:</span>
            <span class="token keyword">final</span> <span class="token class-name">Offset</span> scrollDelta <span class="token operator">=</span>
                <span class="token class-name">Offset</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>scrollDeltaX<span class="token punctuation">,</span> datum<span class="token punctuation">.</span>scrollDeltaY<span class="token punctuation">)</span> <span class="token operator">/</span> devicePixelRatio<span class="token punctuation">;</span>
            <span class="token keyword">yield</span> <span class="token class-name">PointerScrollEvent</span><span class="token punctuation">(</span>
               <span class="token comment">//省略参数</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerSignalKind</span><span class="token punctuation">.</span>none<span class="token operator">:</span>
            <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This branch should already have 'none' filtered out.</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>PointerSignalKind</span><span class="token punctuation">.</span>unknown<span class="token operator">:</span>
            <span class="token comment">// Ignore unknown signals.</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这段代码比较长，但是逻辑其实也不复杂</p> 
<ol>
<li>将PointerData中的数据根据手机显示器的分辨率去计算出相对应的逻辑位置</li>
<li>根据PointerChange的不同类型，把相关数据封成相对应的Event。</li>
</ol> 
<p>这里可能有两个关键点不太好理解，一个是逻辑位置，一个是yield关键字<br> <strong>关于物理指针</strong><br> 所为的物理指针信息就是我们手机的触摸屏相关的数据，可以理解为从触摸屏硬件获取到的数据，然后这个数据其实是和手机的屏幕有关系的。<br> <strong>关于逻辑位置</strong><br> 那就是和操作系统有关系了，操作系统会根据手机的分辨率生成一个包含非常多像素的一个矩阵，矩阵中的每个点通过某种映射逻辑可以对应到屏幕物理的某个位置点。<br> 物理是客观存在的，逻辑是主观定义的。</p> 
<p>这里有个关键字yield。不理解的可以看去查一下。和return有点类似，但是不会中断代码的执行。</p> 
<pre><code class="prism language-java"> <span class="token keyword">void</span> <span class="token function">_flushPointerEventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>locked<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>_pendingPointerEvents<span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">)</span>
      <span class="token function">handlePointerEvent</span><span class="token punctuation">(</span>_pendingPointerEvents<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这个代码应该都可以看懂，就是队列的出队操作。取出数据之后将数据移除，先进先出的原则（removeFirst）。</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">_handlePointerEventImmediately</span><span class="token punctuation">(</span><span class="token class-name">PointerEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">HitTestResult</span><span class="token operator">?</span> hitTestResult<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event is <span class="token class-name">PointerDownEvent</span> <span class="token operator">||</span> event is <span class="token class-name">PointerSignalEvent</span> <span class="token operator">||</span> event is <span class="token class-name">PointerHoverEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>_hitTests<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hitTestResult <span class="token operator">=</span> <span class="token class-name">HitTestResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">hitTest</span><span class="token punctuation">(</span>hitTestResult<span class="token punctuation">,</span> event<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event is <span class="token class-name">PointerDownEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _hitTests<span class="token punctuation">[</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">]</span> <span class="token operator">=</span> hitTestResult<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>debugPrintHitTestResults<span class="token punctuation">)</span>
          <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'$event: $hitTestResult'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event is <span class="token class-name">PointerUpEvent</span> <span class="token operator">||</span> event is <span class="token class-name">PointerCancelEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      hitTestResult <span class="token operator">=</span> _hitTests<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>down<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Because events that occur with the pointer down (like</span>
      <span class="token comment">// [PointerMoveEvent]s) should be dispatched to the same place that their</span>
      <span class="token comment">// initial PointerDownEvent was, we want to re-use the path we found when</span>
      <span class="token comment">// the pointer went down, rather than do hit detection each time we get</span>
      <span class="token comment">// such an event.</span>
      hitTestResult <span class="token operator">=</span> _hitTests<span class="token punctuation">[</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>debugPrintMouseHoverEvents <span class="token operator">&amp;&amp;</span> event is <span class="token class-name">PointerHoverEvent</span><span class="token punctuation">)</span>
        <span class="token function">debugPrint</span><span class="token punctuation">(</span><span class="token string">'$event'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hitTestResult <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        event is <span class="token class-name">PointerAddedEvent</span> <span class="token operator">||</span>
        event is <span class="token class-name">PointerRemovedEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>position <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> hitTestResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这个方法逻辑看着很复杂，耐心看，我们来过滤</p> 
<ol>
<li>创建一个hitTestResult对象</li>
<li>根据PointerEvent的不同分为三种情况 
  <ol>
<li>down，signal，hover，这三种情况，因为这三种情况都是点击事件的开始，所以他们需要进行命中测试。</li>
<li>up和cancel，如果这两种情况，表示事件结束或者是取消了。</li>
<li>最后这种情况，其实注释也写的挺清楚地，就是说对于中情况，这种情况就是出去最开始和结束之间的情况，只需要重用之前已经找到的路径，不需要再次进行命中测试了。</li>
</ol> </li>
<li>将命中的点添加到HitTestResult</li>
<li>最后就是大家熟悉的事件分发</li>
</ol> 
<p>命中测试这个地方，需要重点看一下这个逻辑。</p> 
<pre><code class="prism language-java">  bool <span class="token function">hitTest</span><span class="token punctuation">(</span><span class="token class-name">BoxHitTestResult</span> result<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> required <span class="token class-name">Offset</span> position <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 省略assert</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_size<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hitTestChildren</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> position<span class="token operator">:</span> position<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hitTestSelf</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BoxHitTestEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>从代码可以看出，命中测试的时候，子控件是优先的。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@protected</span>
  bool <span class="token function">hitTestChildren</span><span class="token punctuation">(</span><span class="token class-name">BoxHitTestResult</span> result<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> required <span class="token class-name">Offset</span> position <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre> 
<p>这个是默认方法返回false，也就是说默认不命中，<br> 再看看本身命中测试的方法</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@override</span>
  bool <span class="token function">hitTestSelf</span><span class="token punctuation">(</span><span class="token class-name">Offset</span> position<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> behavior <span class="token operator">==</span> <span class="token class-name">HitTestBehavior</span><span class="token punctuation">.</span>opaque<span class="token punctuation">;</span>
</code></pre> 
<p>返回值是根据这个behavior的值来确定的。<br> <font color="red">点击事件的拦截是不是就可以通过这个方法来处理了？</font></p> 
<p><strong>好了，事件的命中测试就大概过了一遍，接下来我们看事件的分发了。</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@override</span> <span class="token comment">// from HitTestDispatcher</span>
  <span class="token keyword">void</span> <span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token class-name">PointerEvent</span> event<span class="token punctuation">,</span> <span class="token class-name">HitTestResult</span><span class="token operator">?</span> hitTestResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>locked<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// No hit test information implies that this is a [PointerHoverEvent],</span>
    <span class="token comment">// [PointerAddedEvent], or [PointerRemovedEvent]. These events are specially</span>
    <span class="token comment">// routed here; other events will be routed through the `handleEvent` below.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hitTestResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span>event is <span class="token class-name">PointerAddedEvent</span> <span class="token operator">||</span> event is <span class="token class-name">PointerRemovedEvent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        pointerRouter<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>exception<span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">FlutterError</span><span class="token punctuation">.</span><span class="token function">reportError</span><span class="token punctuation">(</span><span class="token class-name">FlutterErrorDetailsForPointerEventDispatcher</span><span class="token punctuation">(</span>
          exception<span class="token operator">:</span> exception<span class="token punctuation">,</span>
          stack<span class="token operator">:</span> stack<span class="token punctuation">,</span>
          library<span class="token operator">:</span> <span class="token string">'gesture library'</span><span class="token punctuation">,</span>
          context<span class="token operator">:</span> <span class="token class-name">ErrorDescription</span><span class="token punctuation">(</span><span class="token string">'while dispatching a non-hit-tested pointer event'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          event<span class="token operator">:</span> event<span class="token punctuation">,</span>
          hitTestEntry<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          informationCollector<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> sync<span class="token operator">*</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">yield</span> <span class="token class-name">DiagnosticsProperty</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointerEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'Event'</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> style<span class="token operator">:</span> <span class="token class-name">DiagnosticsTreeStyle</span><span class="token punctuation">.</span>errorProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HitTestEntry</span> entry in hitTestResult<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        entry<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">transformed</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>transform<span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>exception<span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">FlutterError</span><span class="token punctuation">.</span><span class="token function">reportError</span><span class="token punctuation">(</span><span class="token class-name">FlutterErrorDetailsForPointerEventDispatcher</span><span class="token punctuation">(</span>
          exception<span class="token operator">:</span> exception<span class="token punctuation">,</span>
          stack<span class="token operator">:</span> stack<span class="token punctuation">,</span>
          library<span class="token operator">:</span> <span class="token string">'gesture library'</span><span class="token punctuation">,</span>
          context<span class="token operator">:</span> <span class="token class-name">ErrorDescription</span><span class="token punctuation">(</span><span class="token string">'while dispatching a pointer event'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          event<span class="token operator">:</span> event<span class="token punctuation">,</span>
          hitTestEntry<span class="token operator">:</span> entry<span class="token punctuation">,</span>
          informationCollector<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> sync<span class="token operator">*</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">yield</span> <span class="token class-name">DiagnosticsProperty</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointerEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'Event'</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> style<span class="token operator">:</span> <span class="token class-name">DiagnosticsTreeStyle</span><span class="token punctuation">.</span>errorProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">yield</span> <span class="token class-name">DiagnosticsProperty</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HitTestTarget</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'Target'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>target<span class="token punctuation">,</span> style<span class="token operator">:</span> <span class="token class-name">DiagnosticsTreeStyle</span><span class="token punctuation">.</span>errorProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这块逻辑代码分两部分，两种情况的路由是不一样的，当没有</p> 
<ol>
<li>没有命中的时候，直接将原Event发送出去</li>
<li>有命中的时候，会将坐标转换之后，把命中之后事件发送出去。</li>
</ol> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@override</span> <span class="token comment">// from HitTestTarget</span>
  <span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token class-name">PointerEvent</span> event<span class="token punctuation">,</span> <span class="token class-name">HitTestEntry</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    pointerRouter<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event is <span class="token class-name">PointerDownEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gestureArena<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event is <span class="token class-name">PointerUpEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      gestureArena<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event is <span class="token class-name">PointerSignalEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      pointerSignalResolver<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>不得不说这个注释写的非常好，源代码里的。<br> 前面entry.target.handleEvent这个方法把事件发送出来之后，就被这个方法接到了。梳理一下这个方法做的事情</p> 
<ol>
<li>把event存储在pointerRouter这个路由里。</li>
<li>关闭竞技场</li>
<li>消除竞技场，把胜利者给到第一个。</li>
<li>如果是信号事件，则处理信号事件</li>
</ol> 
<p>这里有一点要特别说明一下，if中的这几个方法，都是在我们处理完所有事件之后才会调用。<br> <strong>这里还会涉及到一个竞技场的问题，由于篇幅问题，这个竞技场就不详细讲了，他主要逻辑就是解决手势抢夺问题，最终有一个widget获得这个手势。</strong></p> 
<p>接下来到了BaseTapGestureRecognizer.handlePrimaryPointer方法了，到这个地方基本上就是处理最后的事件分发的逻辑了。</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@override</span>
  <span class="token keyword">void</span> <span class="token function">acceptGesture</span><span class="token punctuation">(</span><span class="token keyword">int</span> pointer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">acceptGesture</span><span class="token punctuation">(</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pointer <span class="token operator">==</span> primaryPointer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">_checkDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _wonArenaForPrimaryPointer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">_checkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@override</span>
  <span class="token keyword">void</span> <span class="token function">handlePrimaryPointer</span><span class="token punctuation">(</span><span class="token class-name">PointerEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event is <span class="token class-name">PointerUpEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      _up <span class="token operator">=</span> event<span class="token punctuation">;</span>
      <span class="token function">_checkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event is <span class="token class-name">PointerCancelEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">GestureDisposition</span><span class="token punctuation">.</span>rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_sentTapDown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">_checkCancel</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>buttons <span class="token operator">!=</span> _down<span class="token operator">!</span><span class="token punctuation">.</span>buttons<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">GestureDisposition</span><span class="token punctuation">.</span>rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">stopTrackingPointer</span><span class="token punctuation">(</span>primaryPointer<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里解释一下，acceptGesture这个方法是在close关闭竞技场中调用的，handlePrimaryPointer这个方法是在route中调用的。</p> 
<pre><code class="prism language-java">  <span class="token keyword">void</span> <span class="token function">_checkDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_sentTapDown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">handleTapDown</span><span class="token punctuation">(</span>down<span class="token operator">:</span> _down<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _sentTapDown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">_checkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_wonArenaForPrimaryPointer <span class="token operator">||</span> _up <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_up<span class="token operator">!</span><span class="token punctuation">.</span>pointer <span class="token operator">==</span> _down<span class="token operator">!</span><span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleTapUp</span><span class="token punctuation">(</span>down<span class="token operator">:</span> _down<span class="token operator">!</span><span class="token punctuation">,</span> up<span class="token operator">:</span> _up<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">_checkCancel</span><span class="token punctuation">(</span><span class="token class-name">PointerCancelEvent</span><span class="token operator">?</span> event<span class="token punctuation">,</span> <span class="token class-name">String</span> note<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">handleTapCancel</span><span class="token punctuation">(</span>down<span class="token operator">:</span> _down<span class="token operator">!</span><span class="token punctuation">,</span> cancel<span class="token operator">:</span> event<span class="token punctuation">,</span> reason<span class="token operator">:</span> note<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _sentTapDown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    _wonArenaForPrimaryPointer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    _up <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    _down <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>结合这两部分代码可以知道，调用onTab之前，肯定是得先在竞技场中竞技成功，然后然后通过调用acceptGesture这个方法就可以获取到点击事件的down方法了，于此同时，在接收到分发的PointerUpEvent事件的时候，才会把up的回调赋值过去、<br> 总结下来点击事件onTab的调用有2个前提条件：</p> 
<ol>
<li>必须竞技成功</li>
<li>接收到PointerUpEvent事件。</li>
</ol> 
<p>最后执行到TapGestureRecognizer.中的handleTapDown和handleTapUp方法了</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@protected</span>
  <span class="token annotation punctuation">@override</span>
  <span class="token keyword">void</span> <span class="token function">handleTapDown</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>required <span class="token class-name">PointerDownEvent</span> down<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">TapDownDetails</span> details <span class="token operator">=</span> <span class="token class-name">TapDownDetails</span><span class="token punctuation">(</span>
      globalPosition<span class="token operator">:</span> down<span class="token punctuation">.</span>position<span class="token punctuation">,</span>
      localPosition<span class="token operator">:</span> down<span class="token punctuation">.</span>localPosition<span class="token punctuation">,</span>
      kind<span class="token operator">:</span> <span class="token function">getKindForPointer</span><span class="token punctuation">(</span>down<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>down<span class="token punctuation">.</span>buttons<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> kPrimaryButton<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onTapDown <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          invokeCallback<span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'onTapDown'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> onTapDown<span class="token operator">!</span><span class="token punctuation">(</span>details<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> kSecondaryButton<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onSecondaryTapDown <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          invokeCallback<span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'onSecondaryTapDown'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> onSecondaryTapDown<span class="token operator">!</span><span class="token punctuation">(</span>details<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> kTertiaryButton<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onTertiaryTapDown <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          invokeCallback<span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'onTertiaryTapDown'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> onTertiaryTapDown<span class="token operator">!</span><span class="token punctuation">(</span>details<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@protected</span>
  <span class="token annotation punctuation">@override</span>
  <span class="token keyword">void</span> <span class="token function">handleTapUp</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> required <span class="token class-name">PointerDownEvent</span> down<span class="token punctuation">,</span> required <span class="token class-name">PointerUpEvent</span> up<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">TapUpDetails</span> details <span class="token operator">=</span> <span class="token class-name">TapUpDetails</span><span class="token punctuation">(</span>
      kind<span class="token operator">:</span> up<span class="token punctuation">.</span>kind<span class="token punctuation">,</span>
      globalPosition<span class="token operator">:</span> up<span class="token punctuation">.</span>position<span class="token punctuation">,</span>
      localPosition<span class="token operator">:</span> up<span class="token punctuation">.</span>localPosition<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>down<span class="token punctuation">.</span>buttons<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> kPrimaryButton<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onTapUp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          invokeCallback<span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'onTapUp'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> onTapUp<span class="token operator">!</span><span class="token punctuation">(</span>details<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onTap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          invokeCallback<span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'onTap'</span><span class="token punctuation">,</span> onTap<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> kSecondaryButton<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onSecondaryTapUp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          invokeCallback<span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'onSecondaryTapUp'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> onSecondaryTapUp<span class="token operator">!</span><span class="token punctuation">(</span>details<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onSecondaryTap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          invokeCallback<span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'onSecondaryTap'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> onSecondaryTap<span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> kTertiaryButton<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onTertiaryTapUp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          invokeCallback<span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">'onTertiaryTapUp'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> onTertiaryTapUp<span class="token operator">!</span><span class="token punctuation">(</span>details<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>TapGestureRecognizer这个类不知道是否还记得，这个是在最开始介绍代码的时候介绍的，在GestureDetector中注册的手势识别器。<br> 看到这个方法的代码，也就算是结束了，同样，这里可以看到onTapUp和onTap 两个方法的执行顺序，微观的角度上讲，onTapUp方法执行的顺序还是稍微靠前一点的，从宏观的角度上来讲，这2个方法几乎是同时调用的。</p> 
<h4>
<a id="flutter_719"></a>最后总结一下flutter中手势的分发过程。</h4> 
<ol>
<li>当手或者触摸笔或者是鼠标按下的时候，引擎会手机这些手势的数据包ByteData</li>
<li>PlatformDispatcher_dispatchPointerDataPacket()方法去做数据的解析，最后得到一个PointerDataPacket数据包</li>
<li>GestureBinding.handlePointerDataPacket 把PointerDataPacket数据包中的PointerData数据转化成对应的PointerEvent手势事件， 并且将它们加入到_pendingPointerEvents待分发的手势事队列中。而PointerEvent只是一个基类，它有很多实现类。如： 
  <ol>
<li>PointerAddedEvent</li>
<li>PointerHoverEvent</li>
<li>PointerDownEvent，</li>
<li>PointerMoveEvent</li>
<li>PointerUpEvent</li>
<li>PointerCancelEvent</li>
<li>PointerRemovedEvent</li>
</ol> </li>
<li>手势数据全部添加到待分发的事件队列之后，从队列中逐个取出分发下去，先进先出的原则。</li>
<li>在事件分发过程中，有两个逻辑 
  <ol>
<li>根据命中测试确定这个逻辑是否在点击区域</li>
<li>根据竞技结果确认把事件分发给哪个对象</li>
</ol> </li>
<li>最后只想相关回调方法（onTapDown，onTapUp，onTap等等）。</li>
</ol>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>