<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>KVM虚拟化基本操作 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">KVM虚拟化基本操作</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    
                        
                    
                    <h1>
<a id="1_0"></a>1，虚拟化的一些介绍</h1> 
<p>虚拟化软件是可以让一台物理主机建立与执行一至多个虚拟化环境的软件，虚拟化将硬件、操作系统和应用程序一同封装一个可迁移的虚拟机档案文件中。</p> 
<ul><li>安装位置分类</li></ul> 
<p>目前从Hypervisor(虚拟机管理程序)安装位置分类，虚拟化层面包括安装在硬件层上、安装在宿主操作系统层上、安装在内核层上，具体如下：<br> 安装在硬件层上：由Hypervisor直接管理硬件，如VMWare ESXi、微软、思杰KVM、XEN等<br> 安装在内核层上：Hypervisor安装在宿主操作系统内核上，客户操作系统调用宿主操作系统内核，如OpenVZ等<br> 安装在宿主操作系统上：Hypervisor:安装在宿主操作系统上，通过宿主操作系统使用硬件，如VirtualBox、VMWare Workstation等</p> 
<ul><li>从虚拟化程度分类，虚拟化技术包括完全虚拟化、半虚拟化、操作系统级虚拟化等，具体如下：</li></ul> 
<p>全虚拟化：通过Hypervisor(虚拟机管理程序)来分享底层硬件，客户操作系统无需意识到在虚拟环境运行，受保护的指令由Hypervisor来捕获和处理<br> 特点：全虚拟化最大的优点是操作系统无需任何修改。它的限制则是操作系统必须能够支持底层硬件</p> 
<p>半虚拟化：使用Hypervisor(虚拟机管理程序)分享底层的硬件，但客户操作系统集成了虚拟化方面的代码。由于操作系统自身能够与虚拟进程进行很好的协作，无需Hypervisor捕获和处理特殊指令<br> 特点：半虚拟化需要客户操作系统配合Hypervisor做一些修改，性能与原始系统相近。</p> 
<p>操作系统级虚拟化：内核与Hypervisor(虚拟机管理程序)集成，操作系统上层与内核共同组成完整操作系统<br> 特点：性能较高，但操作系统只能是Linux(可以是不同版本)</p> 
<ul><li>libvirt为了更方便地管理平台虚拟化技术而设计的开放源代码的应用程序接口、守护进程和管理工具，提供了对虚拟化客户机的管理、对虚拟化网络和存储的管理</li></ul> 
<p>libvirt是目前使用最为广泛的对KVM的虚拟机进行管理的工具盒应用程序接口，而且一些常用的虚拟机管理工具(virsh/virt-install/virt-manager等)和云计算框架平台<br> (OpenStack,/OpenNebula等)都是在底层使用libvirt的应用程序接口。</p> 
<h1>
<a id="2KVM_27"></a>2，KVM软件安装</h1> 
<h2>
<a id="21_QEMU_29"></a>2.1 QEMU软件安装</h2> 
<p>centos7默认采用 QEMU/KVM的虚拟化方案，所以应该安装 QEMU相关的软件包。可以使用以下命令来检查 QEMU相关的软件包是否安装</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>training@centos-template ~<span class="token punctuation">]</span>$ <span class="token function">rpm</span> <span class="token parameter variable">-qa</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'^qemu'</span>
</code></pre> 
<p>若没有安装，可以使用以下命令完成安装：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>training@centos-template ~<span class="token punctuation">]</span>$ yum <span class="token function">install</span> qemu-kvm
</code></pre> 
<h2>
<a id="22_KVM_43"></a>2.2 KVM软件安装及管理工具安装</h2> 
<p>libvirt主要由三个部分组成： API库，一个守护进程 libvirtd 和一个默认命令行管理工具 virsh</p> 
<p>检查cpu是否支持虚拟化</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>training@centos-template ~<span class="token punctuation">]</span>$ <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'vmx|svm'</span> /proc/cpuinfo
</code></pre> 
<p>• vmx是 Intel的 CPU svm是 AMD的 CPU<br> • 如果有 vmx信息输出，就说明支持 VT;如果没有任何的输出，说明你的 cpu不支持，将无法使用 KVM虚拟机。<br> 检查系统是否加载了 KVM模块</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>training@centos-template ~<span class="token punctuation">]</span>$ lsmod <span class="token operator">|</span> <span class="token function">grep</span> kvm
kvm_intel             <span class="token number">188740</span>  <span class="token number">0</span> 
kvm                   <span class="token number">637289</span>  <span class="token number">1</span> kvm_intel
irqbypass              <span class="token number">13503</span>  <span class="token number">1</span> kvm
</code></pre> 
<p>没有任何输出，说明没有加载此模块，使用以下命令手动加载</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>training@centos-template ~<span class="token punctuation">]</span>$ modprobe kvm
</code></pre> 
<p>libvirt是 应用程序接口、守护进程和管理工具，它不仅提供了对虚拟化客户机的管理，也提供了对虚拟化网络和存储的管 理。 libvirt主要由 3个部分组成，分别是：应用程 序编程接口库、一个守护进程（ libvirtd 和一个默认命令行管理工具（ virsh）</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>training@centos-template ~<span class="token punctuation">]</span>$ yum <span class="token function">install</span> libvirt virt-manager virt-viewer virt-install
</code></pre> 
<p>virt-manager是虚拟机管理器（ Virtual Machine Manager）这个应用程序的缩写，也是该管理工具的软件包名称。 virt-manager是用于管理虚拟机的图形化的桌面用户接口，目前仅支持在 Linux或其他类 UNIX系统中运行。</p> 
<p>virt-viewer是 “Virtual Machine Viewer”（虚拟机查看器）工具的软件包和命令行工具 名称，它是一个显示虚拟化客户机的图形界面的工具。</p> 
<p>virt-install命令行工具为虚拟客户机的安装提供了一个便捷易用的方式</p> 
<h2>
<a id="23_KVM_82"></a>2.3 KVM服务及日志</h2> 
<p>libvirtd是作为一个服务（ service）配置在系统中的，所以可以通过 systemctl命令来对其进行操作。<br> 启动libvirtd</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>training@centos-template ~<span class="token punctuation">]</span>$ systemctl start libvirtd
<span class="token punctuation">[</span>training@centos-template ~<span class="token punctuation">]</span>$ systemctl status libvirtd
● libvirtd.service - Virtualization daemon
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/libvirtd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Fri <span class="token number">2022</span>-09-16 <span class="token number">14</span>:33:25 CST<span class="token punctuation">;</span> 17s ago
     Docs: man:libvirtd<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
           https://libvirt.org
 Main PID: <span class="token number">2911</span> <span class="token punctuation">(</span>libvirtd<span class="token punctuation">)</span>
    Tasks: <span class="token number">19</span> <span class="token punctuation">(</span>limit: <span class="token number">32768</span><span class="token punctuation">)</span>
   CGroup: /system.slice/libvirtd.service
           ├─2911 /usr/sbin/libvirtd
           ├─3017 /usr/sbin/dnsmasq --conf-file<span class="token operator">=</span>/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script<span class="token operator">=</span>/usr/libexec/libvirt_leaseshelper
           └─3018 /usr/sbin/dnsmasq --conf-file<span class="token operator">=</span>/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script<span class="token operator">=</span>/usr/libexec/libvirt_leaseshelper
</code></pre> 
<p>虚拟机相关的日志文件如下<br> • $HOME/.virtinst/virt-install.log virt-install工具日志文件。<br> • $HOME/.virt-manager/virt-manager.log virt-manager工具日志文件。<br> • /var/log/libvirt/qemu/ 每个正在运行的虚拟机的日志文件。如果虚拟机名为 centos，那么日志文件是<br> /var/log/libvirt/qemu/centos.log。</p> 
<h1>
<a id="3KVM_109"></a>3，KVM软件虚拟化结构</h1> 
<p>KVM配置文件</p> 
<p>libvirt相关的配置文件都在 /etc/libvirt/目录之中 ，如下</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>training@centos-template ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">ls</span> /etc/libvirt/ <span class="token parameter variable">-l</span>
<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> password <span class="token keyword">for</span> training: 
total <span class="token number">80</span>
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">450</span> Apr <span class="token number">28</span>  <span class="token number">2021</span> libvirt-admin.conf
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">547</span> Apr <span class="token number">28</span>  <span class="token number">2021</span> libvirt.conf
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">16529</span> Apr <span class="token number">28</span>  <span class="token number">2021</span> libvirtd.conf
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">1175</span> Apr <span class="token number">28</span>  <span class="token number">2021</span> lxc.conf
drwx------ <span class="token number">2</span> root root  <span class="token number">4096</span> Sep <span class="token number">16</span> <span class="token number">14</span>:33 nwfilter
drwx------ <span class="token number">3</span> root root    <span class="token number">22</span> Sep <span class="token number">16</span> <span class="token number">14</span>:24 qemu
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">30306</span> Apr <span class="token number">28</span>  <span class="token number">2021</span> qemu.conf
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">2169</span> Apr <span class="token number">28</span>  <span class="token number">2021</span> qemu-lockd.conf
drwx------ <span class="token number">2</span> root root     <span class="token number">6</span> Sep <span class="token number">16</span> <span class="token number">14</span>:33 secrets
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">3202</span> Apr <span class="token number">28</span>  <span class="token number">2021</span> virtlockd.conf
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">3247</span> Apr <span class="token number">28</span>  <span class="token number">2021</span> virtlogd.conf
</code></pre> 
<ul>
<li>/etc/libvirt/libvirt.conf 此配置文件 用于配置一些常用 libvirt连接（通常是远程连接）的别名。</li>
<li>/etc/libvirt/libvirtd.conf 是 libvirt的守护进程 libvirtd的配置文件，被修改 后需要让 libvirtd重新加载配置文件（或重启 libvirtd）才会生效。</li>
<li>/etc/libvirt/qemu.conf qemu.conf 是 libvirt对 QEMU的驱动的配置文件，包括 VNC、 SPICE等，以及连接它们时采用的权限认证方式的配置，也包括内存大页、 SELinux、 Cgroups等相关配置。</li>
<li>/etc/libvirt/qemu/目录 该 目录下存放的是使用 QEMU驱动的域的配置文件。</li>
</ul> 
<p>虚拟机配置文件</p> 
<p>在使用libvirt对虚拟化系统进行管理时，很多地方都是以 XML文件作为配置文件的，包 括客户机（域）的配置、宿主机网络接口配置、网络过滤、各个客户机的磁盘存储配置、磁盘加密、宿主机和客户机的 CPU特性，等等。</p> 
<p>客户机的 XML配置文件格式的示例</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--
WARNING: THIS IS AN AUTO GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh edit db01
or o ther application using the libvirt API.
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>kvm<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>db01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uuid</span><span class="token punctuation">&gt;</span></span>2e93f70b 78b0 41d5 b049 06c11e585463<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uuid</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>192.168.122.21<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span>
<span class="token attr-name">&lt;memory</span> <span class="token attr-name">unit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>KiB<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>1048576<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>memory</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>currentMemory</span> <span class="token attr-name">unit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>KiB<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>1048576<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>currentMemory</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>vcpu</span> <span class="token attr-name">placement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>static<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>vcpu</span><span class="token punctuation">&gt;</span></span>
...
</code></pre> 
<p>由上面的配置文件示例可以看到，在该域的XML文件中，所有有效配置都在 和 标签之间，这表明该配置文件是一个域的配置。（ XML文档中注释为 
 ) 通过 libvirt启动客户机，经过文件解析和命令参数的转换，最终也会调用 qemu命令行 工具来实际完成客户机的创建。</p> 
<h2>
<a id="31_162"></a>3.1配置文件说明</h2> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>kvm<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>domain 是一个所有虚拟机都需要的根元素，它有两个属性， type定义使用哪个虚拟机管理程序，值可以是：xen、 kvm、 qemu、 lxc、 kqemu，第二个参数是 id，它唯一的标示一个运行的虚拟机，不活跃的客户端没有id。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>db01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>name参数为虚拟机定义了一个简短的名字，必须唯一。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uuid</span><span class="token punctuation">&gt;</span></span>2e93f70b 78b0 41d5 b049 06c11e585463<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uuid</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>uuid为虚拟机定义了一个唯一的标示符， uuid的格式必须遵循 RFC 4122指定的格式，当创建虚拟机没有指定 uuid时会随机的生成一个 uuid。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>192.168.122.21<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>title参数提供一个对虚拟机简短的说明，它不能包含换行符。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>vcpu</span> <span class="token attr-name">placement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>static<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>vcpu</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>vcpu的内容是为虚拟机最多 分配几个 cpu，值处于 1~maxcpu之间 。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>features</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>acpi</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>apic</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>features</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>features标签，表示 Hypervisor为客户机打开或关闭 CPU或其他硬件的特性，这里打开了 ACPI、 APIC等特性。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>os</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span> <span class="token attr-name">arch</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>x86_64<span class="token punctuation">'</span></span> <span class="token attr-name">machine</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>pc i440fx rhel7.0.0<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>hvm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>boot</span> <span class="token attr-name">dev</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>hd<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>os</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>type表示客户机类型是 hvm类型 HVM hardware virtual machine，硬件虚拟机）原本是 Xen虚拟化中的概念，它表示在硬件辅助虚拟化技术（ Intel VT或 AMD-V等）的支持下不需要修改客户机操作系统就可以启动客户机。因为 KVM一定要依赖于硬件虚拟化技术的支持，所以在 KVM中，客户机类型应该总是 hvm。操作系统的架构是<br> x86_64。</p> 
<p>机器类型是pc-i440fx-rhel7.0.0（这是 libvirt中针对 RHEL 7系统的默认类型，也可以根据需要修改为其他类型）。</p> 
<p>boot选项用于设置客户机启动时的设备，这里有 hd（即硬盘）和 cdrom（光驱）两种，而且是按照硬盘、光驱的顺序启动的，它们在 XML配置文件中的先后顺序即启动时的先后顺序。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>memory</span> <span class="token attr-name">unit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>KiB<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>524288<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>memory</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>memory 定义客户端启动时可以分配到的最大内存，内存单位由 unit定义，单位可以是： K、 KiB、 M、 MiB、G、 GiB、 T、 TiB。默认是 KiB。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>currentMemory</span><span class="token punctuation">&gt;</span></span>1024000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>currentMemory</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>currentMemory 定义实际分给给客户端的内存她小于 memory的定义，如果 没有定义，值和 memory一致。</p> 
<h2>
<a id="32__229"></a>3.2 默认网络配置文件</h2> 
<p>虚拟网络的配置示例如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interface</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>network<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mac</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>52:54:c7:c1:72:f8<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">network</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>default<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>model</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virtio<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>address</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>pci<span class="token punctuation">'</span></span> <span class="token attr-name">domain</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x0000<span class="token punctuation">'</span></span> <span class="token attr-name">bus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x00<span class="token punctuation">'</span></span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x03<span class="token punctuation">'</span></span> <span class="token attr-name">function</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interface</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>这里type='network’和 表示使用 NAT的方式，并使用默认的网络配置，客户机将会分配到 192.168.122.0/24网段中的一个 IP地址。<br> 在宿主机中，通常会运行着DHCP和 DNS服务器，一般默认使用 dnsmasq软件查询。可以通过以下命令查看相关的进程：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>training@centos-template ~<span class="token punctuation">]</span>$ <span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> dnsmasq
nobody    <span class="token number">3017</span>     <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">14</span>:33 ?        00:00:00 /usr/sbin/dnsmasq --conf-file<span class="token operator">=</span>/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script<span class="token operator">=</span>/usr/libexec/libvirt_leaseshelper
root      <span class="token number">3018</span>  <span class="token number">3017</span>  <span class="token number">0</span> <span class="token number">14</span>:33 ?        00:00:00 /usr/sbin/dnsmasq --conf-file<span class="token operator">=</span>/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script<span class="token operator">=</span>/usr/libexec/libvirt_leaseshelper
training  <span class="token number">4011</span>  <span class="token number">1768</span>  <span class="token number">0</span> <span class="token number">15</span>:28 pts/1    00:00:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto dnsmasq
</code></pre> 
<p>由于配置使用了默认的NAT网络配置，可以在 libvirt相关的网络配置中看到一个 default.xml文件（ 具体路径为： ：/etc/libvirt/qemu/networks/default.xml），它配置了默认的连接方式：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template networks<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/etc/libvirt/qemu/networks
<span class="token punctuation">[</span>root@centos-template networks<span class="token punctuation">]</span><span class="token comment"># cat default.xml </span>
<span class="token operator">&lt;</span><span class="token operator">!</span>--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  <span class="token function">virsh</span> net-edit default
or other application using the libvirt API.
--<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>network<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>default<span class="token operator">&lt;</span>/name<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>uuid<span class="token operator">&gt;</span>cf7dfcaa-686a-49bf-a2dc-5405264a681a<span class="token operator">&lt;</span>/uuid<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>forward <span class="token assign-left variable">mode</span><span class="token operator">=</span><span class="token string">'nat'</span>/<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>bridge <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">'virbr0'</span> <span class="token assign-left variable">stp</span><span class="token operator">=</span><span class="token string">'on'</span> <span class="token assign-left variable">delay</span><span class="token operator">=</span><span class="token string">'0'</span>/<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>mac <span class="token assign-left variable">address</span><span class="token operator">=</span><span class="token string">'52:54:00:b1:10:db'</span>/<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>ip <span class="token assign-left variable">address</span><span class="token operator">=</span><span class="token string">'192.168.122.1'</span> <span class="token assign-left variable">netmask</span><span class="token operator">=</span><span class="token string">'255.255.255.0'</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>dhcp<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>range <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token string">'192.168.122.2'</span> <span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token string">'192.168.122.254'</span>/<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>/dhcp<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>/ip<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/network<span class="token operator">&gt;</span>
</code></pre> 
<h2>
<a id="33_279"></a>3.3默认存储池</h2> 
<p>在该客户机的XML配置文件中，关于机磁盘的配置如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disk</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>file<span class="token punctuation">'</span></span> <span class="token attr-name">device</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>disk<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>driver</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>qemu<span class="token punctuation">'</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>qcow2<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/var/lib/libvirt/images/db01.qcow2<span class="token punctuation">'</span></span>
  <span class="token attr-name">&lt;target</span> <span class="token attr-name">dev</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>vda<span class="token punctuation">'</span></span> <span class="token attr-name">bus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virtio<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>address</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>pci<span class="token punctuation">'</span></span> <span class="token attr-name">domain</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x0000<span class="token punctuation">'</span></span> <span class="token attr-name">bus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x00<span class="token punctuation">'</span></span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x10<span class="token punctuation">'</span></span> <span class="token attr-name">function</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disk</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>上面的配置表示，使用qcow2格式的 db01.qcow镜像文件作为客户机的磁盘，其在客户机中使用 virtio总线（使用 virtio-blk驱动），设备名称为 /dev/vda。</p> 
<p>标签是客户机磁盘配置的主标签，其中包含它的属性和一些 子标签。</p> 
<p>• type属性表示磁盘使用哪种类型作为磁盘的来源，其取值为 file、 block、 dir或 network中的一个，分别表示使用文件、块设备、目录或网络作为客户机磁盘的来源。<br> • device属性表示让客户机如何来使用该磁盘设备，其取值为 floppy、 disk、 cdrom或 lun中的一个，分别表示软盘、硬盘、光盘和 LUN（逻辑单元号），默认值为 disk（硬盘）。</p> 
<h1>
<a id="4_299"></a>4，虚拟机管理</h1> 
<h2>
<a id="41_301"></a>4.1命令行安装虚拟机</h2> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template networks<span class="token punctuation">]</span><span class="token comment">#  curl -o /tmp/CentOS-7-x86_64-Miniaml-2009.iso </span>
<span class="token operator">&gt;</span> https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso
</code></pre> 
<p>上面的镜像可以自行选择下载。</p> 
<p>开始安装虚拟机系统</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template networks<span class="token punctuation">]</span><span class="token comment"># virt-install </span>
<span class="token operator">&gt;</span> --virt-type kvm <span class="token punctuation"></span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--name</span> demo-001 <span class="token punctuation"></span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--memory</span> <span class="token number">1024</span> <span class="token punctuation"></span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--disk</span> /var/lib/libvirt/images/myvm.qcow2,size<span class="token operator">=</span><span class="token number">10</span> <span class="token punctuation"></span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--graphics</span> none <span class="token punctuation"></span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--network</span> default <span class="token punctuation"></span>
<span class="token operator">&gt;</span> --extra-args<span class="token operator">=</span><span class="token string">"console=ttyo console=ttyS0,115200"</span> <span class="token punctuation"></span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--location</span><span class="token operator">=</span>/tmp/CentOS-7-x86_64-Miniaml-2009.iso 
</code></pre> 
<p>当出现以下内容后开始配置，“！”感叹号的需要自定义设置。设置完成后按“b”进行系统安装。</p> 
<p><img src="https://images2.imgbox.com/03/4e/oMUSTZCI_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-RfpC14ud-1674010036843)(image-20220916171320417.png)]"></p> 
<ol start="5"><li>Installation Destination 第五项安装系统时，输入c默认安装即可。</li></ol> 
<p><img src="https://images2.imgbox.com/1c/4f/0h8vS9uz_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-sDGLRMTc-1674009412022)(image-20220916171710858.png)]"></p> 
<h2>
<a id="42__XML_334"></a>4.2 虚拟机配置文件 XML文件修改</h2> 
<p>我之前创建虚拟机是root用户创建的，后来登录时是普通用户，virsh list是看不到创建的虚拟机的。</p> 
<p>KVM支持对已有虚拟机配置进行修改，如磁盘大小、 CPU、内存大小等。在 /etc/libvirt/qemu目录下可以看到多个 xml文件，每一个 xml文件都是虚拟机的配置信息， 可以 通过 直接 修改这个文件就可以修改虚拟机的配置。</p> 
<p>在修改配置文件后，需要使用virsh define命令更新虚拟机配置 并且 需要重启虚拟机才会生效 。 官方推荐是使用 virsh edit命令来对文件进行编辑，该命令执行后的效果其实和使用 vim打开差不多，如果配置文件有错的话会进行提醒</p> 
<p>例如，修改虚拟机的cpu的个数：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh edit demo-001 </span>
···
  <span class="token operator">&lt;</span>vcpu <span class="token assign-left variable">placement</span><span class="token operator">=</span><span class="token string">'static'</span><span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">&lt;</span>/vcpu<span class="token operator">&gt;</span> <span class="token comment"># 将个数修改为 2</span>
···
</code></pre> 
<p>退出编辑的方式和vim一致。<br> 更新虚拟机配置</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh define /etc/libvirt/qemu/demo-001.xml </span>
Domain demo-001 defined from /etc/libvirt/qemu/demo-001.xml
</code></pre> 
<p>即使虚拟机仍处于运行状态也可以执行此命令，只是要到虚拟机重启后，新的配置才会起作用<br> 。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh reboot demo-001 </span>
Domain demo-001 is being rebooted
</code></pre> 
<p>进入虚拟机查看cpu数量</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh reboot demo-001 </span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># lscpu</span>
</code></pre> 
<p>ctrl+] 可以切换回宿主机终端</p> 
<h2>
<a id="43_vish_376"></a>4.3 vish命令行工具</h2> 
<p>virsh是 libvirt默认 的 命令行管理工具 ，可以通过 virsh -h来获取帮助</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh -h</span>
</code></pre> 
<p>从帮助页可以看出<br> virsh命令大概分了 以下组：<br> Domain Management（域管理 、 Domain Monitoring（域监控）、 Host and Hypervisor（主机及虚拟化）、 Interface（网卡接口）、 Network Filter（网络防火墙）、 Networking（网络）、 Node Device（节点设备驱动）、 Secret、Snapshot（快照）、 Storage Pool（存储池或存储策略）、 Storage Volume（存储卷）、 Virsh itself virsh shell自身相关）<br> 如果查看某一组帮助信息，我们可以使用 virsh help +组名；比如查看 storage volume组相关命令有哪些，可以使用 virsh help volume;</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh list</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh list --all # --all 选项可以看到 不活跃和活跃的域列表</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh start demo-001 </span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh shutdown demo-001 </span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh destroy demo-001 </span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh reboot demo-001 </span>
</code></pre> 
<p>使用xml文件创建虚拟机</p> 
<pre><code class="prism language-bash"><span class="token function">virsh</span> create xxx .xml
<span class="token function">virsh</span> define xxx.xml
<span class="token function">virsh</span> define ：从指定配置文件中创建虚拟，但不运行 ,create 是创建并运行；
</code></pre> 
<p>取消定义一个虚拟机</p> 
<pre><code class="prism language-bash"><span class="token function">virsh</span> undefine xxx
</code></pre> 
<p>注意：<br> 默认使用 undefine只会把对应配置文件和虚拟机实例删除 。<br> 设置虚拟机开机自启</p> 
<pre><code class="prism language-bash"><span class="token function">virsh</span> autostart xxx
</code></pre> 
<h2>
<a id="44_420"></a>4.4访问虚拟机</h2> 
<p>virsh console命令可以使用命令方式连接到虚拟机中，</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh console demo-001 </span>
Connected to domain demo-001
Escape character is ^<span class="token punctuation">]</span>
</code></pre> 
<p>以上命令 可以 连接 centos7虚拟机 的控制台， 若执行命令后 一直处于卡死的状态，是因为 centos7上默认没有允许 ttyS0。<br> 可以通过以下方式解决此问题，前提是必须要有一种方式能连接虚拟机，可以使用<br> ssh或 virt-manager 等方式进行连接。 连接到虚拟机后，在 /etc/securetty文件中添加 ttyS0</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> " /etc/securetty
</code></pre> 
<p>更新内核参数，需要重启才能生效</p> 
<pre><code class="prism language-bash">grubby update <span class="token assign-left variable">kernel</span><span class="token operator">=</span>ALL <span class="token assign-left variable">args</span><span class="token operator">=</span><span class="token string">"console=ttyS0"</span>
</code></pre> 
<p>重启完成后，再次使用virsh console连接</p> 
<p>ctrl+] 可以切换回宿主机终端</p> 
<h1>
<a id="5_448"></a>5，虚拟机镜像</h1> 
<p>qemu-img用于离线创建、转换和修改磁盘镜像文件。<br> 注意：不要使用qemu-img修改正在运行的虚拟机或任何其他进程使用的镜像，这可能会破坏镜像。<br> qemu-img命令有众多的子命令，每个子命令都使用不同的语法格式</p> 
<p>qeme-img info 命令可以 查看镜像文件的磁盘大小、 backing file、内部快照等详细信息。 例如查看 centos7虚拟机的镜像文件</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># qemu-img info /var/lib/libvirt/images/myvm.qcow2 </span>
image: /var/lib/libvirt/images/myvm.qcow2
<span class="token function">file</span> format: qcow2
virtual size: 10G <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">1</span>.6G
cluster_size: <span class="token number">65536</span>
Format specific information:
    compat: <span class="token number">1.1</span>
    lazy refcounts: <span class="token boolean">true</span>
</code></pre> 
<p>返回字段说明：<br> • image info命令中提供的 FILENAME。<br> • file format 镜像格式。<br> • virtual size 即虚拟机看到的磁盘大小。<br> • disk size 该镜像文件在主机文件系统上占用的空间大小。<br> • cluster_size 该镜像格式的 cluster_size（如果适用）。<br> • encrypted 该镜像是否加密，只有当加密时才显示。<br> • cleanly shut down：如果镜像是脏的，将显示 no，并且必须在 qemu 下次打开它时进行自动修复。<br> • backing file 如果该镜像有 backing file，则显示。<br> • backing file format backing file 的镜像格式（ if the image enforces it）。<br> • Snapshot list 列出该镜像所有内部快照。<br> • Format specific information 该镜像格式的特定信息。</p> 
<ul><li>raw格式</li></ul> 
<p>raw格式是一种很早的镜像格式，格式比较原始、简单，性能上也还不错。并且 raw格式镜像的一个突出好处是它支持转换成其他格式的镜像，或者作为其他格式镜像转换的中间格式。但是， raw格式的一个突出缺点就是不支持快照。 raw格式会 立刻分配 磁盘 空间 。</p> 
<ul><li>qcow2格式</li></ul> 
<p>qcow2格式是目前的一种主流镜像格式，性能上与 raw格式相差无几，但是支持虚拟机快照。 qcow2只是承诺给你分配空间，但是只有当你需要用空间的时候，才会给你空间。最多只给你承诺空间的大小，避免空间浪费</p> 
<h2>
<a id="51__489"></a>5.1 创建镜像</h2> 
<p>qemu-img的子命令 create可以用来创建镜像。使用 qemu-img创建镜像有两种方式 ：创建全新的镜像和增量镜像。</p> 
<p>创建全新的镜像，例如在/tmp目录下创建一个 2G的 qcow2格式的镜像 base.qcow2</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># qemu-img create -f qcow2 /tmp/base.qcow2 2G</span>
Formatting <span class="token string">'/tmp/base.qcow2'</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>qcow2 <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">2147483648</span> <span class="token assign-left variable">encryption</span><span class="token operator">=</span>off <span class="token assign-left variable">cluster_size</span><span class="token operator">=</span><span class="token number">65536</span> <span class="token assign-left variable">lazy_refcounts</span><span class="token operator">=</span>off 
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># qemu-img info /tmp/base.qcow2 </span>
image: /tmp/base.qcow2
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">2</span>.0G <span class="token punctuation">(</span><span class="token number">2147483648</span> bytes<span class="token punctuation">)</span>
disk size: 196K
cluster_size: <span class="token number">65536</span>
Format specific information:
    compat: <span class="token number">1.1</span>
    lazy refcounts: <span class="token boolean">false</span>
</code></pre> 
<p>在qemu-img create子命令中 如果使用了 -b BACKING_FILE选项，则新镜像文件将是 BACKING_FILE 的差异盘，此时不需要指定 SIZE。除非使用 commit 命令把差异盘中的数据提交到 BACKING_FILE 中，否则 BACKING_FILE 永远不会被修改。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># qemu-img create -f qcow2 -b /var/lib/libvirt/images/myvm.qcow2 /tmp/myvm-1.qcow2</span>
Formatting <span class="token string">'/tmp/myvm-1.qcow2'</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>qcow2 <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">10737418240</span> <span class="token assign-left variable">backing_file</span><span class="token operator">=</span><span class="token string">'/var/lib/libvirt/images/myvm.qcow2'</span> encry
<span class="token assign-left variable">ption</span><span class="token operator">=</span>off <span class="token assign-left variable">cluster_size</span><span class="token operator">=</span><span class="token number">65536</span> <span class="token assign-left variable">lazy_refcounts</span><span class="token operator">=</span>off 
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># qemu-img info /tmp/myvm-1.qcow2 </span>
image: /tmp/myvm-1.qcow2
<span class="token function">file</span> format: qcow2
virtual size: 10G <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: 196K
cluster_size: <span class="token number">65536</span>
backing file: /var/lib/libvirt/images/myvm.qcow2
Format specific information:
    compat: <span class="token number">1.1</span>
    lazy refcounts: <span class="token boolean">false</span>
</code></pre> 
<h2>
<a id="52__527"></a>5.2 镜像格式转换</h2> 
<p>qemu-img的 convert子命令可以 将镜像 文件（或其内部快照）从一种镜像格式转换为另一种镜像格式 。</p> 
<p>常用选项：<br> -p 显示进度。<br> -f 源镜像文件的格式。<br> -O（大写 o）目标镜像格式 、源镜像文件名称和目标文件名称。<br> 例如，将 qcow2格式的镜像转换为 raw格式的镜像 。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># qemu-img convert -f qcow2 -O raw /var/lib/libvirt/images/myvm.qcow2 myvm.raw</span>
</code></pre> 
<p>将raw格式的镜像转换为 qcow2</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># qemu-img convert -p -f raw -O qcow2 myvm.raw myvm.qcow2</span>
    <span class="token punctuation">(</span><span class="token number">100.00</span>/100%<span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="53_guestfs_548"></a>5.3 guestfs修改镜像</h2> 
<p>libguestfs是用于访问和修改虚拟机的磁盘镜像的一组工具集合。 libguestfs提供了访问和编辑客户机中的文件、脚本化修改客户机中的信息、监控磁盘使用和空闲的统计信息、 P2V、 V2V、创建客户机、克隆客户机、备份磁盘内容、格式化磁盘、调整磁盘大小等非常丰富的功能。</p> 
<p>安装 libguestfs</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># yum install libguestfs-tools查看镜像中的文件系统</span>
</code></pre> 
<p>查看镜像中的文件系统</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virt-df /var/lib/libvirt/images/myvm.qcow2 </span>
Filesystem                           1K-blocks       Used  Available  Use%
myvm.qcow2:/dev/sda1                   <span class="token number">1038336</span>     <span class="token number">107136</span>     <span class="token number">931200</span>   <span class="token number">11</span>%
myvm.qcow2:/dev/centos/root            <span class="token number">8374272</span>    <span class="token number">1251956</span>    <span class="token number">7122316</span>   <span class="token number">15</span>%
</code></pre> 
<p>将镜像中的文件系统挂载至本地目录</p> 
<p>例如：将myvm.qcow2镜像中的系统分区挂载到本地的 /mnt目录中。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># guestmount -a /var/lib/libvirt/images/myvm.qcow2  -m /dev/centos/root --rw /mnt</span>
</code></pre> 
<p>查看挂载后的目录，可以看到一个 几乎 完整的根文件系统。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># ls /mnt</span>
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
</code></pre> 
<p>卸载文件系统</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># umount /mnt</span>
</code></pre> 
<p>virt-edit</p> 
<p>该命令可以修改虚机或者镜像里面的内容<br> -d 选项指定虚拟机名称， 也可以直接对虚拟机磁盘文件操作 ,只需要将 -d domname换成 -a path_of_disk_file</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virt-edit -d demo-001 /etc/hosts</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virt-edit -a /var/lib/libvirt/images/centos7.qcow2 /etc/hosts</span>
</code></pre> 
<p>以上两个命令都可以编辑虚拟机内部的文件</p> 
<p>virt-copy-out</p> 
<p>此 命令可以把虚拟机里的文件复制 到当前主机中 , 例如 将 centos7虚拟机中的 /etc/hostname文件 复制到当前目录。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virt-copy-out -d demo-001 /etc/hostname ./</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># ls</span>
<span class="token function">hostname</span>  myvm.qcow2  myvm.raw
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># cat hostname </span>
localhost.localdomain
</code></pre> 
<p>virt-copy-in</p> 
<p>此命令可以将文件复制到虚拟机里面,用法和 virt-copy-out基本相同</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virt-copy-in -d centos7 /etc/resolv.conf /etc/</span>
</code></pre> 
<p>virt-cat</p> 
<p>可以查看虚拟机中文件的内容</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virt-cat -d demo-001 /etc/hostname</span>
localhost.localdomain
</code></pre> 
<h2>
<a id="54_virtsysprep__629"></a>5.4 virt-sysprep 制作虚拟镜像</h2> 
<p>virt-sysprep工具 也 来自 libguest-tools软件 包 。</p> 
<p>移除虚拟机中的私有信息</p> 
<p>virt-sysprep命令若不指定参数的，则 移除 所有 的私有信息 私有信息可以通过 --list-operations选项查看。 如<br> 果我们要手动 指定移除哪些操作，可以使用 --enable选项来指定</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virt-sysprep --list-operations</span>
<span class="token comment"># 例如只删除ssh-userdir和 bash-history，可以使用以下命令:</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virt-sysprep --enable bash-history,ssh-userdir -d demo-001</span>
</code></pre> 
<p>设置指定虚拟机的主机名</p> 
<p>在操作之前先将虚拟机关机</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh shutdown demo-001 </span>
Domain demo-001 is being <span class="token function">shutdown</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virt-sysprep --hostname test.com -d demo-001</span>
<span class="token punctuation">[</span>   <span class="token number">0.0</span><span class="token punctuation">]</span> Examining the guest <span class="token punctuation">..</span>.
 <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh start demo-001</span>
Domain demo-001 started
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virt-cat demo-001 /etc/hostname</span>
test.com
</code></pre> 
<h1>
<a id="6_660"></a>6，存储池管理</h1> 
<p>KVM平台以 存储池的形式对存储进行统一管理，所谓存储池可以理解为本地目录、通过远端磁盘阵列iSCSI、 NFS）分配过来磁盘或目录，当然也支持各类分布式文件系统。<br> 默认的存储是在/var/lib/libvirt/images目录下 。</p> 
<p>查看存储池</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh pool-list</span>
 Name                 State      Autostart 
-------------------------------------------
 images               active     <span class="token function">yes</span>       
 tmp                  active     <span class="token function">yes</span>       

<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh pool-list --details</span>
 Name    State    Autostart  Persistent   Capacity  Allocation  Available
--------------------------------------------------------------------------
 images  running  <span class="token function">yes</span>        <span class="token function">yes</span>         <span class="token number">26.98</span> GiB    <span class="token number">2.80</span> GiB  <span class="token number">24.18</span> GiB
 tmp     running  <span class="token function">yes</span>        <span class="token function">yes</span>         <span class="token number">26.98</span> GiB    <span class="token number">2.80</span> GiB  <span class="token number">24.18</span> GiB
</code></pre> 
<p>查看某一存储池的具体信息</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh pool-info images</span>
Name:           images
UUID:           81e446ed-3147-4a34-b78a-06691c3fe897
State:          running
Persistent:     <span class="token function">yes</span>
Autostart:      <span class="token function">yes</span>
Capacity:       <span class="token number">26.98</span> GiB
Allocation:     <span class="token number">2.80</span> GiB
Available:      <span class="token number">24.18</span> GiB
</code></pre> 
<p>以XML形式查看某一存储池的具体信息</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh pool-dumpxml images </span>
<span class="token operator">&lt;</span>pool <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'dir'</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>images<span class="token operator">&lt;</span>/name<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>uuid<span class="token operator">&gt;</span>81e446ed-3147-4a34-b78a-06691c3fe89<span class="token operator"><span class="token file-descriptor important">7</span>&lt;</span>/uuid<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>capacity <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">&gt;</span><span class="token number">2896848896</span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/capacity<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>allocation <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">&gt;</span><span class="token number">300453068</span><span class="token operator"><span class="token file-descriptor important">8</span>&lt;</span>/allocation<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>available <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">&gt;</span><span class="token number">2596395827</span><span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>/available<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>source<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>/source<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>target<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>path<span class="token operator">&gt;</span>/var/lib/libvirt/images<span class="token operator">&lt;</span>/path<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>permissions<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>mode<span class="token operator">&gt;</span>071<span class="token operator"><span class="token file-descriptor important">1</span>&lt;</span>/mode<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>owner<span class="token operator">&gt;</span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/owner<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>group<span class="token operator">&gt;</span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/group<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>/permissions<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>/target<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/pool<span class="token operator">&gt;</span>
</code></pre> 
<h2>
<a id="61__718"></a>6.1 存储池创建</h2> 
<p>采用本地目录方式创建KVM存储池</p> 
<p>定义存储池</p> 
<p>创建存储池</p> 
<p>查看所有存储池</p> 
<p>查看vmfspool的状态</p> 
<pre><code class="prism language-bash"><span class="token comment"># 采用本地目录方式创建KVM存储池</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># mkdir -p /data/vmfs</span>
<span class="token comment"># 定义存储池</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh pool-define-as vmfspool --type dir --target /data/vmfs</span>
Pool vmfspool defined
<span class="token comment"># 创建存储池</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh pool-build vmfspool</span>
Pool vmfspool built
<span class="token comment"># 查看所有存储池</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh pool-list --all</span>
 Name                 State      Autostart 
-------------------------------------------
 images               active     <span class="token function">yes</span>       
 tmp                  active     <span class="token function">yes</span>       
 vmfspool             inactive   no        
<span class="token comment"># 查看vmfspool的状态</span>
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh pool-info vmfspool </span>
Name:           vmfspool
UUID:           bfa7e49d-8ad6-4408-8ed3-6452c9cb5e46
State:          inactive
Persistent:     <span class="token function">yes</span>
Autostart:      no
</code></pre> 
<p>设置存储池自动启动</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh pool-autostart vmfspool</span>
Pool vmfspool marked as autostarted
</code></pre> 
<p>启动存储池</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh pool-start vmfspool</span>
Pool vmfspool started
</code></pre> 
<h2>
<a id="62__769"></a>6.2 存储池使用</h2> 
<p>存储池被分为存储卷，这些存储卷保存虚拟镜像或连接到虚拟机作为附加存储。</p> 
<p>查看存储卷</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh vol-list images</span>
 Name                 Path                                    
------------------------------------------------------------------------------
 myvm.qcow2           /var/lib/libvirt/images/myvm.qcow2   
</code></pre> 
<p>查看存储卷的详细信息</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh vol-info /var/lib/libvirt/images/myvm.qcow2 </span>
Name:           myvm.qcow2
Type:           <span class="token function">file</span>
Capacity:       <span class="token number">10.00</span> GiB
Allocation:     <span class="token number">1.61</span> GiB
</code></pre> 
<p>创建存储卷</p> 
<p>在images存储池中创建一个 qcow2格式的存储卷，大小为 1G</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh vol-create-as images vol.qcow2 1G --format qcow2</span>
Vol vol.qcow2 created
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh vol-list images</span>
 Name                 Path                                    
------------------------------------------------------------------------------
 myvm.qcow2           /var/lib/libvirt/images/myvm.qcow2      
 vol.qcow2            /var/lib/libvirt/images/vol.qcow2 
</code></pre> 
<h1>
<a id="7_806"></a>7，管理虚拟机快照</h1> 
<p>快照前先关机</p> 
<p>使用 snapshot创建快照。</p> 
<p>创建快照，这里需要注意，如果虚拟机中 使用了 raw格式的磁盘，创建快照时会出错。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh shutdown demo-001 </span>
Domain demo-001 is being <span class="token function">shutdown</span>

<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-create-as demo-001 snap-1</span>
Domain snapshot snap-1 created
<span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list demo-001 </span>
 Name                 Creation Time             State
------------------------------------------------------------
 snap-1               <span class="token number">2022</span>-09-19 <span class="token number">17</span>:09:13 +0800 shutoff
</code></pre> 
<p>在/var/lib/libvirt/qemu/snapshot目录下，有以虚拟机的域名为名的文件夹， 快照文件存放在此处 。</p> 
<p>虚拟机快照还原</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos-template training<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-revert demo-001 snap-1 </span>
</code></pre> 
<h1>
<a id="8_834"></a>8，云迁移策略</h1> 
<h2>
<a id="_835"></a>云迁移策略概述</h2> 
<p>云计算经过最近五年的产品能力完善、云产品持续新增和稳定性逐步增强，使得大家已经能够广泛接受云计算的理念并积极思考如何在自身业务中使用云计算。那么应用迁移上云应该如何操作，2011年Gartner的分析师提出了5R策略，随着后续的不断发展和补充，目前迁移上云的策略被一般认为为6R策略，本课程介绍的六种云迁移策略。</p> 
<h3>
<a id="1ReHost_837"></a>1，Re-Host</h3> 
<p>重新托管，也称为“直接迁移”，迁移复杂度：中<br> 应用进行云迁移时最常见的策略，即对应用程序运行环境不做改变的情况下迁移上云，一般的操作是P2V(Physical to Virtual,物理机迁移至虚拟机)、V2V(Virtual to Virtual,虚拟机迁移至虚拟机)。在企业期望快速上云或大型应用上云的场景中，这种策略比较合适</p> 
<h3>
<a id="2RePlatform_840"></a>2，Re-Platform</h3> 
<p>更换平台，也称为“修补后迁移”，迁移复杂度：高<br> 在迁移上云时，在不改变应用核心架构的基础上，对应用程序做些简单的云优化。例如将关系型数据库替换成云服务商提供的数据库服务、将自建消息中间件替换成云服务提供的消息队列服务、将HAProxy更换成云服务商提供的负载均衡服务，以此来降低部分管理成本提升效率</p> 
<h3>
<a id="3RePurchase_843"></a>3,Re-Purchase</h3> 
<p>重新购置，也称为“放弃后购买”,迁移复杂度：高<br> 是指放弃使用原先的产品，改为采购新的替代产品，例如原先企业采用传统软件许可模式的人力资源管理系统，将放弃并选用同类SaaS产品来进行替换，抑或是选用了该厂商的SaaS版本</p> 
<h3>
<a id="4ReArchitect_847"></a>4,Re-Architect</h3> 
<p>重构/重新构建,迁移复杂度：高<br> 改变应用的架构和开发模式，进行云原生的应用服务实现，例如单体应用向微服务架构改造，这种策略一般是在现有应用环境下难以满足日后功能、性能或规模上的需求时采用，该策略的迁移成本最高，但是长远来看会更为满足未来的需求</p> 
<h3>
<a id="5Retain_850"></a>5,Retain</h3> 
<p>保留,迁移复杂度：低<br> 在部分应用或者业务未做好上云准备，或是更为适合本地部署时，保留现状，不强行进行迁移上云操作。应用迁移应该有优先级设定，根据业务发展实际需要来进行操作</p> 
<h3>
<a id="6Retire_853"></a>6,Retire</h3> 
<p>停用,迁移复杂度：低<br> 确定不再使用当前的基础设施，表明这部分系统或应用已经没有使用价值且还在持续消息资源，应该进行必要的归档备份后停用</p> 
<h2>
<a id="_857"></a>一些步骤</h2> 
<ul>
<li> <p>第一阶段评估阶段<br> 第一步项目启动<br> 第二步现状梳理<br> 第三步应用系统关联关系分析</p> </li>
<li> <p>第二阶段设计阶段<br> 第四步云架构优化设计<br> 第五步云迁移方案设计</p> </li>
<li> <p>第三阶段实施阶段<br> 第六步目标架构搭建<br> 第七步迁移演练及实施<br> 第八步试运行</p> </li>
</ul> 
<p>T1 制定《迁移策略与标准》<br> 总体迁移策略与流程<br> 迁移批次规划原则<br> 迁移方式选择（逻辑迁移，物理迁移)<br> 数据迁移技术选择（离线迁移，在线迁移)<br> 迁移风险考虑</p> 
<p>T2 制定《迁移主计划》<br> 划分批次和时间<br> 制定迁移流程<br> 迁移团队和职责的定义<br> 迁移风险评估和风险控制</p> 
<p>T3 为各待迁移应用制定《迁移详细计划》<br> 迁移步骤<br> 验证计划（测试计划）<br> 应急方案和回退计划</p> 
<p>T4 为批次或应用制定《迁移演练计划》<br> 沙盘演练<br> HAProxy更换成云服务商提供的负载均衡服务，以此来降低部分管理成本提升效率</p> 
<h3>
<a id="3RePurchase_894"></a>3,Re-Purchase</h3> 
<p>重新购置，也称为“放弃后购买”,迁移复杂度：高<br> 是指放弃使用原先的产品，改为采购新的替代产品，例如原先企业采用传统软件许可模式的人力资源管理系统，将放弃并选用同类SaaS产品来进行替换，抑或是选用了该厂商的SaaS版本</p> 
<h3>
<a id="4ReArchitect_898"></a>4,Re-Architect</h3> 
<p>重构/重新构建,迁移复杂度：高<br> 改变应用的架构和开发模式，进行云原生的应用服务实现，例如单体应用向微服务架构改造，这种策略一般是在现有应用环境下难以满足日后功能、性能或规模上的需求时采用，该策略的迁移成本最高，但是长远来看会更为满足未来的需求</p> 
<h3>
<a id="5Retain_901"></a>5,Retain</h3> 
<p>保留,迁移复杂度：低<br> 在部分应用或者业务未做好上云准备，或是更为适合本地部署时，保留现状，不强行进行迁移上云操作。应用迁移应该有优先级设定，根据业务发展实际需要来进行操作</p> 
<h3>
<a id="6Retire_904"></a>6,Retire</h3> 
<p>停用,迁移复杂度：低<br> 确定不再使用当前的基础设施，表明这部分系统或应用已经没有使用价值且还在持续消息资源，应该进行必要的归档备份后停用</p> 
<h2>
<a id="_908"></a>一些步骤</h2> 
<ul>
<li> <p>第一阶段评估阶段<br> 第一步项目启动<br> 第二步现状梳理<br> 第三步应用系统关联关系分析</p> </li>
<li> <p>第二阶段设计阶段<br> 第四步云架构优化设计<br> 第五步云迁移方案设计</p> </li>
<li> <p>第三阶段实施阶段<br> 第六步目标架构搭建<br> 第七步迁移演练及实施<br> 第八步试运行</p> </li>
</ul> 
<p>T1 制定《迁移策略与标准》<br> 总体迁移策略与流程<br> 迁移批次规划原则<br> 迁移方式选择（逻辑迁移，物理迁移)<br> 数据迁移技术选择（离线迁移，在线迁移)<br> 迁移风险考虑</p> 
<p>T2 制定《迁移主计划》<br> 划分批次和时间<br> 制定迁移流程<br> 迁移团队和职责的定义<br> 迁移风险评估和风险控制</p> 
<p>T3 为各待迁移应用制定《迁移详细计划》<br> 迁移步骤<br> 验证计划（测试计划）<br> 应急方案和回退计划</p> 
<p>T4 为批次或应用制定《迁移演练计划》<br> 沙盘演练<br> 数据复制/切换演练</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>