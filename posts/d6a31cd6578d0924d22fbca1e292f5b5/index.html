<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>电机控制及调参 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">电机控制及调参</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <p></p>
<div class="toc">
 <h3>电机调参</h3>
 <ul>
<li><a href="#_1">一、电机相关</a></li>
<li>
<ul>
<li><a href="#0_3">0、废话</a></li>
<li><a href="#1_5">1、电机种类</a></li>
<li><a href="#2_21">2、电机控制方式</a></li>
</ul>
  </li>
<li><a href="#_29">二、电机控制器</a></li>
<li>
<ul>
<li><a href="#1PID_31">1、PID控制器</a></li>
<li><a href="#2PID__39">2、PID 各环节作用</a></li>
<li><a href="#3PID__86">3、PID 种类</a></li>
</ul>
  </li>
<li><a href="#_97">三、电机调参</a></li>
<li>
<ul>
<li><a href="#1Tmotor__100">1、Tmotor 调参</a></li>
<li>
<ul>
<li><a href="#11__102">1.1 控制框图</a></li>
<li><a href="#12_PID__108">1.2 PID 程序</a></li>
<li><a href="#13_Tmotor__238">1.3 Tmotor 控制的完整程序</a></li>
<li><a href="#14_PID__824">1.4 PID 调试技巧</a></li>
</ul>
   </li>
<li><a href="#2M2006M3508_830">2、M2006（M3508）调参</a></li>
<li>
<ul>
<li><a href="#21_M2006M3508_832">2.1 M2006（M3508）控制框图</a></li>
<li><a href="#22_M2006M3508__837">2.2 M2006与M3508 完整的控制程序</a></li>
<li><a href="#23__840">2.3 调试技巧</a></li>
</ul>
  </li>
</ul>
  </li>
<li><a href="#_842">四、存在的问题</a></li>
</ul>
</div>
<p></p> 
<h1>
<a id="_1"></a>一、电机相关</h1> 
<p>电机作为一种能将电能转化为机械能的装置，其在制造、医疗、运动控制等等许多地方都起着重要的作用。想学习了解机器人的小伙伴，从电机了解起走也是一条不错（坎坷）的道路。</p> 
<h2>
<a id="0_3"></a>0、废话</h2> 
<p>   其实电机对于我来说是接触的比较多了的，记得小时候玩四驱车，就特意将“马达”拆开来看过想搞懂原理，也单独将电机拿出来制作了一些小的diy，后来到了高中在学到了电磁学，算是了解了基础的原理了（在不停的刷题后），再后来到大学就是真正的使用了。第一次使用应该是在大一买的单片机，配了一个电机，有程序可以进行调速，但当时由于一些原因，没有再去使用。又到了大三，学习了电机拖动，对电机的认识又深了一点，也做了一些关于电机的实验。但是，令我难以忘记的是研究生开始调试电机的时候，真的是…一言难尽，之前也参考过许多大佬的博客，所以想把自己的这段难忘的经历做个总结，也给有需要的朋友一个参考。</p> 
<h2>
<a id="1_5"></a>1、电机种类</h2> 
<ul>
<li> <p>按<mark>电源</mark>种类分为：直流电机和交流电机。我们常见常用的电机大多是直流电机，相比前者，交流电机不需要换向器和电刷转换电流方向，与直流电机相比它的结构更简单，功率更大，在工业领域被广泛应用<br> <img src="https://images2.imgbox.com/5a/92/jnh2E5Sd_o.png" alt="在这里插入图片描述"></p> </li>
<li> <p>根据有无<mark>电刷</mark>分为：有刷电机和无刷电机。有刷电机结构简单、开发久技术成熟、响应速度快，起动扭矩大、运行平稳，起制动效果好、控制精度高、使用成本低，维修方便；而无刷电机由于无电刷，具有低干扰、噪音低、运转顺畅、寿命长、低维护成本等优点。于是我接触的以无刷电机为主。<br> <img src="https://images2.imgbox.com/78/1c/wVk1lA2x_o.png" alt="在这里插入图片描述"></p> </li>
<li> <p>根据有无<mark>反馈</mark>分为：步进电机和伺服电机。前者没有反馈信号，位置精度不够高，且转速远远小于后者。在需要精确的控制，伺服电机更加常用。</p> </li>
</ul> 
<table><tbody><tr>
<td>
    
     <img src="https://images2.imgbox.com/9d/df/og9wsvzU_o.png"> 
    
</td>
<td>
    
     <img src="https://images2.imgbox.com/2e/18/qvCEcWPm_o.png">
    
</td>
</tr></tbody></table> 
<h2>
<a id="2_21"></a>2、电机控制方式</h2> 
<ul>
<li>力矩控制：指定电机提供设置大小的力矩。（但是由于力矩传感器太贵了，这里的力矩的大小通常是通过电流换算的，其恒电流情况下，转矩=转矩常数*电流）</li>
<li>速度控制：指定电机达到设置的速度转动。</li>
<li>位置控制：指定电机转动到设置的位置。</li>
</ul> 
<p>由于位置是速度的积分，所以三种控制方式的控制框图是有要求的，下面是一种常见的控制结构图，当然，如果只针对某一两种控制模式，其控制方案将比这个更加简易。<br> <img src="https://images2.imgbox.com/38/d3/uQwJj9sr_o.png" alt="在这里插入图片描述"></p> 
<h1>
<a id="_29"></a>二、电机控制器</h1> 
<p>    为了方便用户的使用，市面上许多电机都是针对上面的控制方式进行了封装的，也就是我们常听说的——控制器。控制器的控制方案有许多，针对不同的控制环也有不同的控制方案，例如：对于电流环，有FOC矢量控制，速度、位置环有PID。当然，也有其他的控制算法，但这里我们就使用常用的就行了。现在我们也可以开始谈谈标题了。</p> 
<h2>
<a id="1PID_31"></a>1、PID控制器</h2> 
<p>    PID 是一种传统且经典的控制算法，在工程中应用非常广泛，相比其他高大上甚至只存在于 paper 上的算法， PID 是非常接地气的。<br>     PID ，即：Proportional（比例）、Integral（积分）、Differential（微分）的缩写。顾名思义，PID 控制算法是结合比例、积分和微分的融合怪，其规律可以描述为：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         u
        
        
         (
        
        
         t
        
        
         )
        
        
         =
        
        
         
          K
         
         
          p
         
        
        
         (
        
        
         e
        
        
         (
        
        
         t
        
        
         )
        
        
         +
        
        
         
          1
         
         
          
           T
          
          
           t
          
         
        
        
         
          ∫
         
         
          0
         
         
          t
         
        
        
         e
        
        
         (
        
        
         t
        
        
         )
        
        
         d
        
        
         t
        
        
         +
        
        
         
          T
         
         
          d
         
        
        
         
          
           d
          
          
           e
          
          
           (
          
          
           t
          
          
           )
          
         
         
          
           d
          
          
           t
          
         
        
       
       
         u(t)=K_p(e(t)+frac{1}{T_t}int_0^t e(t)dt+T_dfrac{de(t)}{dt} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">u</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1.03611em;vertical-align: -0.286108em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: -0.07153em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 2.45541em;vertical-align: -0.91195em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: -0.13889em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.836em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right: 0.44445em">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.54346em"><span class="" style="margin-left: -0.44445em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.91195em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mord mathdefault">d</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 2.113em;vertical-align: -0.686em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.13889em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">d</span><span class="mord mathdefault">t</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span><br>     其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         K
        
        
         p
        
       
      
      
       K_p
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.969438em;vertical-align: -0.286108em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: -0.07153em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em"><span class=""></span></span></span></span></span></span></span></span></span></span> 是比例增益，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         T
        
        
         t
        
       
      
      
       T_t
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: -0.13889em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span> 是积分时间常数，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         T
        
        
         d
        
       
      
      
       T_d
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.13889em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span> 是微分时间常数，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        u
       
       
        (
       
       
        t
       
       
        )
       
      
      
       u(t)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">u</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mclose">)</span></span></span></span></span> 是输入信号，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        e
       
       
        (
       
       
        t
       
       
        )
       
      
      
       e(t)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mclose">)</span></span></span></span></span> 是误差。<br> <img src="https://images2.imgbox.com/e0/e0/8TktDKih_o.png" alt="在这里插入图片描述"></p> 
<p>    三个环节在控制中也分别起着不同的控制作用。</p> 
<h2>
<a id="2PID__39"></a>2、PID 各环节作用</h2> 
<ul>
<li> <p>比例环节 P：比例环节与稳态误差相关，比例环节越大，上升速度越快，且稳态误差越小，但无论怎样多大都会存在误差，不能消除误差，而且过大还会导致震荡，反而不稳定<br> <img src="https://images2.imgbox.com/f2/21/3KJWMduz_o.png" alt="在这里插入图片描述"></p> </li>
<li> <p>积分环节 I：积分环节则可以消除误差，合适的积分环节可以很快的消除误差，但是设置较大会产生超调，并且过大也会导致震荡，从而不稳定<br> <img src="https://images2.imgbox.com/df/96/Nz9DnlcC_o.png" alt="在这里插入图片描述"></p> </li>
<li> <p>微分环节 D：微分环节具有预测作用，可以预测信号的变化方向，从而可以减小超调，提高响应速度，但过大会导致系统不稳定<br> <img src="https://images2.imgbox.com/ca/5f/WhXEUJWM_o.png" alt="在这里插入图片描述"></p> </li>
</ul> 
<p>matlab PID 的参考代码如下（上面的图是在下面代码基础上修改了一点，但是核心没有变）：</p> 
<pre><code class="prism language-matlab">%%  说明
% 被控系统： 1/(0.1s+1)
% 控制器：    PID
%%
clc,clear
ts=0.001;  %采样时间=0.001s
sys=tf(1,[0.1,1]);            %建立被控对象传递函数
dsys=c2d(sys,ts,'z')         % 离散化
[num,den]=tfdata(dsys,'v');   % 得到差分方程系数  y(k) = -den[2]*y(k-1) + num[2]*u(k-1)
e_last=0;      %前一时刻的偏差      
E_integ=0;     %累积偏差
u_last=0.0;    %前一时刻的控制量
y_last=0;      %前一时刻的输出
% PID参数
kp=1;    
ki=0;
kd=0;
u=zeros(1,10000);    %设置仿真长度
time=zeros(1,10000); %时刻点（设定10000个）
for k=1:1:10000
    time(k)=k*ts;    %时间
    r(k)=100;        %期望值
    y(k)=-1*den(2)*y_last + num(2)*u_last;    %系统响应输出序列
    e(k)=r(k)-y(k);                           %误差信号
    u(k)=kp*e(k)+ki*E_integ+kd*(e(k)-e_last); %系统PID控制器输出序列
    E_integ=E_integ+e(k);    %误差的累加和
    u_last=u(k);    	     %前一个的控制器输出值
    y_last=y(k);    	     %前一个的系统响应输出值
    e_last=e(k);		     %前一个误差信号的值
end
p1=plot(time,r,'-.');xlim([0,1]);hold on; %指令信号的曲线（即期望输入）
p2=plot(time,y,'--');xlim([0,1]);         %不含积分分离的PID曲线
hold on;
</code></pre> 
<h2>
<a id="3PID__86"></a>3、PID 种类</h2> 
<p>    上面的 PID公示 是针对连续情况下的，而在生活中，我们常常使用的是离散型的变量，比如时间，于是我们需要将 PID 的公式进行离散化，根据离散化的方法不同，PID 控制的公式就有两种，即位置式 PID 和增量式 PID,</p> 
<ul>
<li>位置式 PID<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
      
       
        
         
          u
         
         
          (
         
         
          n
         
         
          )
         
         
          =
         
         
          
           K
          
          
           p
          
         
         
          ∗
         
         
          e
         
         
          (
         
         
          n
         
         
          )
         
         
          +
         
         
          
           K
          
          
           i
          
         
         
          ∗
         
         
          ∑
         
         
          e
         
         
          (
         
         
          n
         
         
          )
         
         
          +
         
         
          
           K
          
          
           d
          
         
         
          ∗
         
         
          [
         
         
          e
         
         
          (
         
         
          n
         
         
          )
         
         
          −
         
         
          e
         
         
          (
         
         
          n
         
         
          −
         
         
          1
         
         
          )
         
         
          ]
         
         
          /
         
         
          T
         
        
        
         u(n)=K_p*e(n)+K_i*sum e(n)+K_d*[e(n)-e(n-1)]/T
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">u</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.969438em;vertical-align: -0.286108em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: -0.07153em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 0.83333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em"><span class="" style="margin-left: -0.07153em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1.60001em;vertical-align: -0.55001em"></span><span class="mop op-symbol large-op">∑</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 0.83333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.07153em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">[</span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mclose">]</span><span class="mord">/</span><span class="mord mathdefault" style="margin-right: 0.13889em">T</span></span></span></span></span></span><br> 从公式结构上看，位置式存在积分环节，误差会进行累加，当积分项饱和时，误差仍然会进行累加，当误差反向变化时，系统还需要一定时间从饱和区退出，所以常常需要积分限幅和输出限幅，实际使用位置式 pid 时一般常常使用 PD 进行控制。</li>
<li>增量式 PID<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
      
       
        
         
          Δ
         
         
          u
         
         
          (
         
         
          n
         
         
          )
         
         
          =
         
         
          
           K
          
          
           p
          
         
         
          ∗
         
         
          [
         
         
          e
         
         
          (
         
         
          n
         
         
          )
         
         
          −
         
         
          e
         
         
          (
         
         
          n
         
         
          −
         
         
          1
         
         
          )
         
         
          ]
         
         
          +
         
         
          
           K
          
          
           i
          
         
         
          ∗
         
         
          e
         
         
          (
         
         
          n
         
         
          )
         
         
          +
         
         
          
           K
          
          
           d
          
         
         
          ∗
         
         
          [
         
         
          e
         
         
          (
         
         
          n
         
         
          )
         
         
          −
         
         
          2
         
         
          ∗
         
         
          e
         
         
          (
         
         
          n
         
         
          −
         
         
          1
         
         
          )
         
         
          +
         
         
          e
         
         
          (
         
         
          n
         
         
          −
         
         
          2
         
         
          )
         
         
          ]
         
         
          /
         
         
          T
         
        
        
         Delta u(n)=K_p*[e(n)-e(n-1)]+K_i* e(n)+K_d*[e(n)-2*e(n-1)+e(n-2)]/T
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord">Δ</span><span class="mord mathdefault">u</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.969438em;vertical-align: -0.286108em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: -0.07153em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">[</span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 0.83333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em"><span class="" style="margin-left: -0.07153em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 0.83333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.07153em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">[</span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">2</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">]</span><span class="mord">/</span><span class="mord mathdefault" style="margin-right: 0.13889em">T</span></span></span></span></span></span><br> 增量式不包含积分环节，控制增量只与前后三次测量值有关，对外界的抗扰性比位置式更好。</li>
<li>两者关系<br> 可以看到前者计算得到的是输入量，而后者算得的是输入增量，许多同学可能已经猜到了后者就是前者差分得到的<br> 想更加具体的了解两者关系，可以看这位博主的： <a href="https://blog.csdn.net/as480133937/article/details/89508034">传送门</a>.</li>
</ul> 
<h1>
<a id="_97"></a>三、电机调参</h1> 
<p>    常见的调参方式是比较快乐的，直接在生产商写好的驱动下进行参数的设置以及测试，找到合适的参数，更有的还有调参软件，遍历参数寻找合适的参数，从而省去人工调试的复杂环节。<br>     但这里想要分享的调参方法要多一点步骤，但是大体方向是不变的，这里以 Tmotor 的 AK10-9 与 大疆的 M2006 两款无刷直流电机为例子进行介绍。</p> 
<h2>
<a id="1Tmotor__100"></a>1、Tmotor 调参</h2> 
<p>    Tmotor 的电机本来是有调参软件的，但是最开始的时候由于资料不完善，加上他的控制环不符合我们的应用要求，所以我们需要进行简单的修改。</p> 
<h3>
<a id="11__102"></a>1.1 控制框图</h3> 
<p>Tmotor 的运动控制框图如下，可以看到他的电流环采用 FOC 矢量控制，我们不能修改，另外两个环，速度环和位置环，只有比例环节，不能达到无误差的目标，所以我们需要在他的电流环上进行编写封装。<br> <img src="https://images2.imgbox.com/93/eb/ytPc62fA_o.png" alt="在这里插入图片描述"><br> 我们需要的控制环应该如下：<br> <img src="https://images2.imgbox.com/15/9e/r4C1ugqd_o.png" alt="在这里插入图片描述"><br> 下面我们先编写控制程序。</p> 
<h3>
<a id="12_PID__108"></a>1.2 PID 程序</h3> 
<p>之前探讨过离散 PID 有位置式 PID 算法和增量式 PID 算法，下面是根据其公式编写的 PID 程序，在使用之前需要稍稍修改一下参数。<br> <mark>位置式 PID</mark></p> 
<pre><code class="prism language-C">********************位置式 PID**************************
***        输入参数：电机电流速度位置等反馈值fed        ***
********************************************************
typedef struct PID
{
	float target;    //目标参考值
	float  deadband; //定义电机死区
	float err_now;   //定义当前误差
	float err_last;  //定义上一时刻误差
	float kp;        //比例环节系数
	float ki;        //积分环节系数
	float kd;        //微分环节系数，这里已将时间常数包含进去
	float Pout;      //比例环节输出
	float Iout;      //积分环节输出
	float Dout;      //微分环节输出
	float IntegLimt; //设置积分限幅
	float output;    //输出量
	float OutputLimt;//输出限幅
}PID_PARM;

//初始化PID参数的函数
void PID_parm_Init(PID_PARM *PID_parm,float target,float kp,float ki,float kd,float IntegLimt,float OutputLimt)
{
	PID_parm-&gt;target = target; 
	PID_parm-&gt;err_now = 0;
	PID_parm-&gt;err_last = 0;
	PID_parm-&gt;kp = kp; 
	PID_parm-&gt;ki = ki; 
	PID_parm-&gt;kd = kd; 
	PID_parm-&gt;Pout = 0;
	PID_parm-&gt;Iout = 0;
    PID_parm-&gt;Dout = 0;
	PID_parm-&gt;IntegLimt = IntegLimt;
	PID_parm-&gt;output = 0; 
	PID_parm-&gt;OutputLimt = OutputLimt;
}

//计算PID的函数
float PID_cal(PID_PARM *pid_parm,float feedback)
{
	pid_parm-&gt;err_now = pid_parm-&gt;target - feedback;
	pid_parm-&gt;Pout = pid_parm-&gt;kp*pid_parm-&gt;err_now;
	pid_parm-&gt;Iout += pid_parm-&gt;ki*pid_parm-&gt;err_now;
	pid_parm-&gt;Dout = pid_parm-&gt;kd*(pid_parm-&gt;err_now-pid_parm-&gt;err_last);
	//积分限幅
	if(pid_parm-&gt;Iout &gt; pid_parm-&gt;IntegLimt)  pid_parm-&gt;Iout = pid_parm-&gt;IntegLimt;
	else if(pid_parm-&gt;Iout &lt; -pid_parm-&gt;IntegLimt)  pid_parm-&gt;Iout = -pid_parm-&gt;IntegLimt;
	//输出限幅
	pid_parm-&gt;output = pid_parm-&gt;Pout + pid_parm-&gt;Iout + pid_parm-&gt;Dout;
	if(pid_parm-&gt;output &gt; pid_parm-&gt;OutputLimt)  pid_parm-&gt;output = pid_parm-&gt;OutputLimt;
	else if(pid_parm-&gt;output &lt; -pid_parm-&gt;OutputLimt)  pid_parm-&gt;output = -pid_parm-&gt;OutputLimt;
	//数据更新
	pid_parm-&gt;err_last = pid_parm-&gt;err_now;
	return  pid_parm-&gt;output;
}

float u;                  
PID_PARM pid_parm;
PID_parm_Init(&amp;pid_parm,10,1,0.1,,0.5,50,100);  //这里的参数随机给的，具体参数需要调节
u = PID_cal(&amp;pid_parm,fed);                     //计算出来的下一次输入
</code></pre> 
<p><mark>增量式 PID</mark></p> 
<pre><code class="prism language-C">********************增量式 PID**************************
***        输入参数：电机电流速度位置等反馈值fed        ***
********************************************************
typedef struct PID
{
	float target;      //目标参考值
	float  deadband; //定义电机死区
	float err_now;     //定义当前误差
	float err_last;    //定义上一时刻误差
	float err_llast;    //定义上上时刻误差
	float kp;          //比例环节系数
	float ki;          //积分环节系数
	float kd;          //微分环节系数，这里已将时间常数包含进去
	float Pout;        //比例环节输出
	float Iout;        //积分环节输出
	float Dout;        //微分环节输出
	float output;      //输出增量
	float output_last; //上一次输出的增量
	float OutputLimt;  //输出限幅
}PID_PARM;

//初始化PID参数的函数
void PID_parm_Init(PID_PARM *PID_parm,float target,float kp,float ki,float kd,float OutputLimt)
{
	PID_parm-&gt;target = target; 
	PID_parm-&gt;err_now = 0;
	PID_parm-&gt;err_last = 0;
	PID_parm-&gt;err_llast = 0;
	PID_parm-&gt;kp = kp; 
	PID_parm-&gt;ki = ki; 
	PID_parm-&gt;kd = kd; 
	PID_parm-&gt;Pout = 0;
	fPID_parm-&gt;Iout = 0;
	PID_parm-&gt;Dout = 0;
	PID_parm-&gt;output = 0; 
	PID_parm-&gt;output_last = 0; 
	PID_parm-&gt;OutputLimt = OutputLimt;
}

//计算PID的函数
float PID_cal(PID_PARM *pid_parm,float feedback)
{
	pid_parm-&gt;err_now = pid_parm-&gt;target - feedback;
	pid_parm-&gt;Pout = pid_parm-&gt;kp*(pid_parm-&gt;err_now - pid_parm-&gt;err_last);
	pid_parm-&gt;Iout = pid_parm-&gt;ki*pid_parm-&gt;err_now;
	pid_parm-&gt;Dout = pid_parm-&gt;kd*(pid_parm-&gt;err_now - 2*pid_parm-&gt;err_last + pid_parm-&gt;err_llast);
	//输出限幅
	pid_parm-&gt;output += pid_parm-&gt;Pout + pid_parm-&gt;Iout + pid_parm-&gt;Dout;
	if(pid_parm-&gt;output &gt; pid_parm-&gt;OutputLimt)  pid_parm-&gt;output = pid_parm-&gt;OutputLimt;
	else if(pid_parm-&gt;output &lt; -pid_parm-&gt;OutputLimt)  pid_parm-&gt;output = -pid_parm-&gt;OutputLimt;
	//数据更新
	pid_parm-&gt;err_llast = pid_parm-&gt;err_last;
	pid_parm-&gt;err_last = pid_parm-&gt;err_now;
	pid_parm-&gt;output_last = pid_parm-&gt;output;
	return  pid_parm-&gt;output;
}

float u;                  
PID_PARM pid_parm;
PID_parm_Init(&amp;pid_parm,10,1,0.1,,0.5,100);  //这里的参数随机给的，具体参数需要调节
u = PID_cal(&amp;pid_parm,fed);                  //计算出来的下一次输入
</code></pre> 
<h3>
<a id="13_Tmotor__238"></a>1.3 Tmotor 控制的完整程序</h3> 
<p>这里采用的 stm32 进行控制的，工程文件全部在下面：</p> 
<ul><li><mark>头文件们</mark></li></ul> 
<p>key.h</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__KEY_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__KEY_H</span>	 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span>  	 </span>

<span class="token comment">/*下面的方式是通过直接操作库函数方式读取IO*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY0</span> 		<span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span>GPIO_Pin_4<span class="token punctuation">)</span> </span><span class="token comment">//PE4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1</span> 		<span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span>GPIO_Pin_3<span class="token punctuation">)</span>	</span><span class="token comment">//PE3 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2</span> 		<span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span>GPIO_Pin_2<span class="token punctuation">)</span> </span><span class="token comment">//PE2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WK_UP</span> 	<span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span>GPIO_Pin_0<span class="token punctuation">)</span>	</span><span class="token comment">//PA0</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY0_PRES</span> 	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_PRES</span>	<span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_PRES</span>	<span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WKUP_PRES</span>   <span class="token expression"><span class="token number">4</span></span></span>

<span class="token keyword">void</span> <span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//IO初始化</span>
u8 <span class="token function">KEY_Scan</span><span class="token punctuation">(</span>u8<span class="token punctuation">)</span><span class="token punctuation">;</span>  		<span class="token comment">//按键扫描函数	</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>can.h</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__CAN_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__CAN_H</span>	 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span>	    	 					    </span>
	
<span class="token keyword">void</span> <span class="token function">CAN1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//CAN1初始化</span>
 
u8 <span class="token function">CAN1_Send_Msg</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">//发送数据 </span>
u8 <span class="token function">CAN1_Receive_Msg</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>pid.h</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__PID_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__PID_H</span>	 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span>	</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdlib.h"</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">PID</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">float</span> target<span class="token punctuation">;</span>      <span class="token comment">//目标参考值</span>
	<span class="token keyword">float</span> deadband<span class="token punctuation">;</span>    <span class="token comment">//定义电机死区</span>
	<span class="token keyword">float</span> err_now<span class="token punctuation">;</span>     <span class="token comment">//定义当前误差</span>
	<span class="token keyword">float</span> err_last<span class="token punctuation">;</span>    <span class="token comment">//定义上一时刻误差</span>
	<span class="token keyword">float</span> err_llast<span class="token punctuation">;</span>   <span class="token comment">//定义上上时刻误差</span>
	<span class="token keyword">float</span> kp<span class="token punctuation">;</span>          <span class="token comment">//比例环节系数</span>
	<span class="token keyword">float</span> ki<span class="token punctuation">;</span>          <span class="token comment">//积分环节系数</span>
	<span class="token keyword">float</span> kd<span class="token punctuation">;</span>          <span class="token comment">//微分环节系数，这里已将时间常数包含进去</span>
	<span class="token keyword">float</span> Pout<span class="token punctuation">;</span>        <span class="token comment">//比例环节输出</span>
	<span class="token keyword">float</span> Iout<span class="token punctuation">;</span>        <span class="token comment">//积分环节输出</span>
	<span class="token keyword">float</span> Dout<span class="token punctuation">;</span>        <span class="token comment">//微分环节输出</span>
	<span class="token keyword">float</span> IntegLimt<span class="token punctuation">;</span>   <span class="token comment">//设置积分限幅</span>
	<span class="token keyword">float</span> output<span class="token punctuation">;</span>      <span class="token comment">//输出量</span>
	<span class="token keyword">float</span> output_last<span class="token punctuation">;</span> <span class="token comment">//上一次输出的增量</span>
	<span class="token keyword">float</span> OutputLimt<span class="token punctuation">;</span>  <span class="token comment">//输出限幅</span>
<span class="token punctuation">}</span>PID_PARM<span class="token punctuation">;</span>

<span class="token keyword">void</span>  <span class="token function">PID_parm_Init</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>PID_parm<span class="token punctuation">,</span><span class="token keyword">float</span> target<span class="token punctuation">,</span><span class="token keyword">float</span> deadband<span class="token punctuation">,</span><span class="token keyword">float</span> kp<span class="token punctuation">,</span><span class="token keyword">float</span> ki<span class="token punctuation">,</span><span class="token keyword">float</span> kd<span class="token punctuation">,</span><span class="token keyword">float</span> IntegLimt<span class="token punctuation">,</span><span class="token keyword">float</span> OutputLimt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> <span class="token function">Pos_PID_cal</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>pid_parm<span class="token punctuation">,</span><span class="token keyword">float</span> feedback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> <span class="token function">Inc_PID_cal</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>pid_parm<span class="token punctuation">,</span><span class="token keyword">float</span> feedback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">PID_init</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>Spd_PID<span class="token punctuation">,</span>PID_PARM <span class="token operator">*</span>Pos_PID<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>motor.h</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__MOTOR_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__MOTOR_H</span>	 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span>	    	 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"pid.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">pi</span> <span class="token expression"><span class="token number">3.1415926</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P_MAX</span>   <span class="token expression"><span class="token number">12.5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">P_MIN</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">12.5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">V_MAX</span>  <span class="token expression"><span class="token number">46.57</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">V_MIN</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">46.57</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KP_MAX</span>  <span class="token expression"><span class="token number">500</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KP_MIN</span>  <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KD_MAX</span>  <span class="token expression"><span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KD_MIN</span>  <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">T_MAX</span>  <span class="token expression"><span class="token number">54</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">T_MIN</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">54</span></span></span>

<span class="token keyword">extern</span> u8 Tmotor_Mod_Buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>
	Tmotor_Open <span class="token operator">=</span> <span class="token number">0xfc</span><span class="token punctuation">,</span>
	Tmotor_Close <span class="token operator">=</span> <span class="token number">0xfd</span><span class="token punctuation">,</span>
	Tmotor_SetZero <span class="token operator">=</span> <span class="token number">0xfe</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>Tmotor_Mod<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
	u8 id<span class="token punctuation">;</span>                  	<span class="token comment">// id</span>
	<span class="token class-name">int16_t</span>	 	speed_rps<span class="token punctuation">;</span>    	<span class="token comment">// rad/s</span>
	<span class="token class-name">int16_t</span>  	real_torque<span class="token punctuation">;</span> 	  <span class="token comment">// 反馈力矩</span>

	<span class="token class-name">uint16_t</span> 	angle<span class="token punctuation">;</span>			    <span class="token comment">// 绝对角度</span>
<span class="token punctuation">}</span>Tmotor_measure_t<span class="token punctuation">;</span>

<span class="token keyword">extern</span> Tmotor_measure_t  TmotorData<span class="token punctuation">;</span>    <span class="token comment">// 保存Tmotor电机的状态</span>

<span class="token keyword">int</span> <span class="token function">float_to_uint</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> x_min<span class="token punctuation">,</span> <span class="token keyword">float</span> x_max<span class="token punctuation">,</span> <span class="token keyword">int</span> bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> <span class="token function">uint_to_float</span><span class="token punctuation">(</span><span class="token keyword">int</span> x_int<span class="token punctuation">,</span> <span class="token keyword">float</span> x_min<span class="token punctuation">,</span> <span class="token keyword">float</span> x_max<span class="token punctuation">,</span> <span class="token keyword">int</span> bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> <span class="token function">limitf</span><span class="token punctuation">(</span><span class="token keyword">float</span> val<span class="token punctuation">,</span> <span class="token keyword">float</span> min_val<span class="token punctuation">,</span> <span class="token keyword">float</span> max_val<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Tmotor_mod</span><span class="token punctuation">(</span>u8 mod<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">get_Tmotor_measure</span><span class="token punctuation">(</span>Tmotor_measure_t <span class="token operator">*</span>ptr<span class="token punctuation">,</span> CanRxMsg <span class="token operator">*</span>Rxmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">set_Tmotor_torque</span><span class="token punctuation">(</span><span class="token keyword">float</span> torque<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Tmotor_Speed_Control</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>PID_spd<span class="token punctuation">,</span><span class="token keyword">float</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Tmotor_Position_Control</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>PID_spd<span class="token punctuation">,</span>PID_PARM <span class="token operator">*</span>PID_pos<span class="token punctuation">,</span><span class="token keyword">float</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<ul><li><mark>源文件们</mark></li></ul> 
<p>key.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span> </span>

<span class="token keyword">void</span> <span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	 GPIO_InitTypeDef  GPIO_InitStructure<span class="token punctuation">;</span>
	 <span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOA<span class="token operator">|</span>RCC_AHB1Periph_GPIOE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使能GPIOE时钟</span>
	
	 GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_2<span class="token operator">|</span>GPIO_Pin_3<span class="token operator">|</span>GPIO_Pin_4<span class="token punctuation">;</span> <span class="token comment">//KEY0 KEY1 KEY2对应引脚</span>
	 GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN<span class="token punctuation">;</span><span class="token comment">//普通输入模式</span>
	 GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_100MHz<span class="token punctuation">;</span><span class="token comment">//100M</span>
	 GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span><span class="token comment">//上拉</span>
	 <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化GPIOE2，3，4</span>
	
	 GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_0<span class="token punctuation">;</span><span class="token comment">//WK_UP对应引脚PA0</span>
	 GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_DOWN <span class="token punctuation">;</span><span class="token comment">//下拉</span>
	 <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化GPIOA0</span>
<span class="token punctuation">}</span> 
<span class="token comment">//按键处理函数</span>
<span class="token comment">//返回按键值</span>
<span class="token comment">//mode:0,不支持连续按;1,支持连续按;</span>
<span class="token comment">//0，没有任何按键按下</span>
<span class="token comment">//1，KEY0按下</span>
<span class="token comment">//2，KEY1按下</span>
<span class="token comment">//3，KEY2按下 </span>
<span class="token comment">//4，WKUP按下 WK_UP</span>
<span class="token comment">//注意此函数有响应优先级,KEY0&gt;KEY1&gt;KEY2&gt;WK_UP!!</span>
u8 <span class="token function">KEY_Scan</span><span class="token punctuation">(</span>u8 mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	 
	<span class="token keyword">static</span> u8 key_up<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//按键按松开标志</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span>key_up<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//支持连按		  </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>key_up<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>KEY0<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY2<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>WK_UP<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//去抖动 </span>
		key_up<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>KEY0<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY2<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>WK_UP<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY0<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY1<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY2<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>WK_UP<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>key_up<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 	    
 	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 无按键按下</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>can.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"can.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"motor.h"</span></span>

Tmotor_measure_t  TmotorData<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">CAN1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 tsjw <span class="token operator">=</span> CAN_SJW_1tq<span class="token punctuation">;</span>
	u8 tbs2 <span class="token operator">=</span> CAN_BS2_4tq<span class="token punctuation">;</span>
	u8 tbs1 <span class="token operator">=</span> CAN_BS1_2tq<span class="token punctuation">;</span>
	u16 brp <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
	u8 mode <span class="token operator">=</span> CAN_Mode_Normal<span class="token punctuation">;</span>     <span class="token comment">// 提前配置好波特率  这里是1000k</span>
	
  	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span> 
	CAN_InitTypeDef        CAN_InitStructure<span class="token punctuation">;</span>
  	CAN_FilterInitTypeDef  CAN_FilterInitStructure<span class="token punctuation">;</span>

   	NVIC_InitTypeDef  NVIC_InitStructure<span class="token punctuation">;</span>

    <span class="token comment">//使能相关时钟</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOA<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使能PORTA时钟	                   											 </span>

  	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_CAN1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使能CAN1时钟	</span>
	
    <span class="token comment">//初始化GPIO</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_11<span class="token operator">|</span> GPIO_Pin_12<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span><span class="token comment">//复用功能</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span><span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_100MHz<span class="token punctuation">;</span><span class="token comment">//100MHz</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span><span class="token comment">//上拉</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化PA11,PA12</span>
	
	  <span class="token comment">//引脚复用映射配置</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span>GPIO_PinSource11<span class="token punctuation">,</span>GPIO_AF_CAN1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//GPIOA11复用为CAN1</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span>GPIO_PinSource12<span class="token punctuation">,</span>GPIO_AF_CAN1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//GPIOA12复用为CAN1</span>
	  
  	<span class="token comment">//CAN单元设置</span>
   	CAN_InitStructure<span class="token punctuation">.</span>CAN_TTCM<span class="token operator">=</span>DISABLE<span class="token punctuation">;</span>	<span class="token comment">//非时间触发通信模式   </span>
  	CAN_InitStructure<span class="token punctuation">.</span>CAN_ABOM<span class="token operator">=</span>ENABLE<span class="token punctuation">;</span>	<span class="token comment">//软件自动离线管理	  </span>
  	CAN_InitStructure<span class="token punctuation">.</span>CAN_AWUM<span class="token operator">=</span>DISABLE<span class="token punctuation">;</span><span class="token comment">//睡眠模式通过软件唤醒(清除CAN-&gt;MCR的SLEEP位)</span>
  	CAN_InitStructure<span class="token punctuation">.</span>CAN_NART<span class="token operator">=</span>ENABLE<span class="token punctuation">;</span>	<span class="token comment">//禁止报文自动传送 </span>
  	CAN_InitStructure<span class="token punctuation">.</span>CAN_RFLM<span class="token operator">=</span>DISABLE<span class="token punctuation">;</span>	<span class="token comment">//报文不锁定,新的覆盖旧的  </span>
  	CAN_InitStructure<span class="token punctuation">.</span>CAN_TXFP<span class="token operator">=</span>DISABLE<span class="token punctuation">;</span>	<span class="token comment">//优先级由报文标识符决定 </span>
  	CAN_InitStructure<span class="token punctuation">.</span>CAN_Mode<span class="token operator">=</span> mode<span class="token punctuation">;</span>	 <span class="token comment">//模式设置 </span>
  	CAN_InitStructure<span class="token punctuation">.</span>CAN_SJW<span class="token operator">=</span>tsjw<span class="token punctuation">;</span>	<span class="token comment">//重新同步跳跃宽度(Tsjw)为tsjw+1个时间单位 CAN_SJW_1tq~CAN_SJW_4tq</span>
  	CAN_InitStructure<span class="token punctuation">.</span>CAN_BS1<span class="token operator">=</span>tbs1<span class="token punctuation">;</span> <span class="token comment">//Tbs1范围CAN_BS1_1tq ~CAN_BS1_16tq</span>
  	CAN_InitStructure<span class="token punctuation">.</span>CAN_BS2<span class="token operator">=</span>tbs2<span class="token punctuation">;</span><span class="token comment">//Tbs2范围CAN_BS2_1tq ~	CAN_BS2_8tq</span>
  	CAN_InitStructure<span class="token punctuation">.</span>CAN_Prescaler<span class="token operator">=</span>brp<span class="token punctuation">;</span>  <span class="token comment">//分频系数(Fdiv)为brp+1	</span>
  	<span class="token function">CAN_Init</span><span class="token punctuation">(</span>CAN1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CAN_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 初始化CAN1 </span>
    
		<span class="token comment">//配置过滤器</span>
 	CAN_FilterInitStructure<span class="token punctuation">.</span>CAN_FilterNumber<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	  <span class="token comment">//过滤器0</span>
  	CAN_FilterInitStructure<span class="token punctuation">.</span>CAN_FilterMode<span class="token operator">=</span>CAN_FilterMode_IdMask<span class="token punctuation">;</span> 
  	CAN_FilterInitStructure<span class="token punctuation">.</span>CAN_FilterScale<span class="token operator">=</span>CAN_FilterScale_32bit<span class="token punctuation">;</span> <span class="token comment">//32位 </span>
  	CAN_FilterInitStructure<span class="token punctuation">.</span>CAN_FilterIdHigh<span class="token operator">=</span><span class="token number">0x0000</span><span class="token punctuation">;</span><span class="token comment">32位ID</span>
  	CAN_FilterInitStructure<span class="token punctuation">.</span>CAN_FilterIdLow<span class="token operator">=</span><span class="token number">0x0000</span><span class="token punctuation">;</span>
  	CAN_FilterInitStructure<span class="token punctuation">.</span>CAN_FilterMaskIdHigh<span class="token operator">=</span><span class="token number">0x0000</span><span class="token punctuation">;</span><span class="token comment">//32位MASK</span>
  	CAN_FilterInitStructure<span class="token punctuation">.</span>CAN_FilterMaskIdLow<span class="token operator">=</span><span class="token number">0x0000</span><span class="token punctuation">;</span>
   	CAN_FilterInitStructure<span class="token punctuation">.</span>CAN_FilterFIFOAssignment<span class="token operator">=</span>CAN_Filter_FIFO0<span class="token punctuation">;</span><span class="token comment">//过滤器0关联到FIFO0</span>
  	CAN_FilterInitStructure<span class="token punctuation">.</span>CAN_FilterActivation<span class="token operator">=</span>ENABLE<span class="token punctuation">;</span> <span class="token comment">//激活过滤器0</span>
  	<span class="token function">CAN_FilterInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CAN_FilterInitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//滤波器初始化</span>
		
	  <span class="token function">CAN_ITConfig</span><span class="token punctuation">(</span>CAN1<span class="token punctuation">,</span>CAN_IT_FMP0<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//FIFO0消息挂号中断允许.		    </span>
  
  	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> CAN1_RX0_IRQn<span class="token punctuation">;</span>
  	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// 主优先级为1</span>
  	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token comment">// 次优先级为2</span>
  	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
  	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>   

<span class="token keyword">void</span> <span class="token function">CAN1_RX0_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  	CanRxMsg RxMessage<span class="token punctuation">;</span>
    <span class="token function">CAN_Receive</span><span class="token punctuation">(</span>CAN1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>RxMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>RxMessage<span class="token punctuation">.</span>StdId <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span>
			<span class="token function">get_Tmotor_measure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TmotorData<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RxMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

u8 <span class="token function">CAN1_Send_Msg</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> msg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
		u8 mbox<span class="token punctuation">;</span>
		u16 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		CanTxMsg TxMessage<span class="token punctuation">;</span>
		TxMessage<span class="token punctuation">.</span>StdId<span class="token operator">=</span><span class="token number">0x01</span><span class="token punctuation">;</span>	 
		TxMessage<span class="token punctuation">.</span>ExtId<span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span>	 
		TxMessage<span class="token punctuation">.</span>IDE<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		  
		TxMessage<span class="token punctuation">.</span>RTR<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		  
		TxMessage<span class="token punctuation">.</span>DLC<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>		
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
			TxMessage<span class="token punctuation">.</span>Data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>				 	
		mbox<span class="token operator">=</span> <span class="token function">CAN_Transmit</span><span class="token punctuation">(</span>CAN1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TxMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">CAN_TransmitStatus</span><span class="token punctuation">(</span>CAN1<span class="token punctuation">,</span> mbox<span class="token punctuation">)</span><span class="token operator">==</span>CAN_TxStatus_Failed<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">0XFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span>i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;=</span><span class="token number">0XFFF</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>		
<span class="token punctuation">}</span>

u8 <span class="token function">CAN1_Receive_Msg</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>		   		   
		u8 i<span class="token punctuation">;</span>
		CanRxMsg RxMessage<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">CAN_MessagePending</span><span class="token punctuation">(</span>CAN1<span class="token punctuation">,</span>CAN_FIFO0<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//没有接收到数据,直接退出 </span>
		<span class="token function">CAN_Receive</span><span class="token punctuation">(</span>CAN1<span class="token punctuation">,</span> CAN_FIFO0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RxMessage<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取数据	</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>RxMessage<span class="token punctuation">.</span>DLC<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>RxMessage<span class="token punctuation">.</span>Data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
		<span class="token keyword">return</span> RxMessage<span class="token punctuation">.</span>DLC<span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
</code></pre> 
<p>pid.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"pid.h"</span></span>

<span class="token comment">//初始化PID参数的函数</span>
<span class="token keyword">void</span> <span class="token function">PID_parm_Init</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>PID_parm<span class="token punctuation">,</span><span class="token keyword">float</span> target<span class="token punctuation">,</span><span class="token keyword">float</span> deadband<span class="token punctuation">,</span><span class="token keyword">float</span> kp<span class="token punctuation">,</span><span class="token keyword">float</span> ki<span class="token punctuation">,</span><span class="token keyword">float</span> kd<span class="token punctuation">,</span><span class="token keyword">float</span> IntegLimt<span class="token punctuation">,</span><span class="token keyword">float</span> OutputLimt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	PID_parm<span class="token operator">-&gt;</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span> 
	PID_parm<span class="token operator">-&gt;</span>deadband <span class="token operator">=</span> deadband<span class="token punctuation">;</span>
	PID_parm<span class="token operator">-&gt;</span>err_now <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	PID_parm<span class="token operator">-&gt;</span>err_last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	PID_parm<span class="token operator">-&gt;</span>err_last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	PID_parm<span class="token operator">-&gt;</span>kp <span class="token operator">=</span> kp<span class="token punctuation">;</span> 
	PID_parm<span class="token operator">-&gt;</span>ki <span class="token operator">=</span> ki<span class="token punctuation">;</span> 
	PID_parm<span class="token operator">-&gt;</span>kd <span class="token operator">=</span> kd<span class="token punctuation">;</span> 
	PID_parm<span class="token operator">-&gt;</span>Pout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	PID_parm<span class="token operator">-&gt;</span>Iout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	PID_parm<span class="token operator">-&gt;</span>Dout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	PID_parm<span class="token operator">-&gt;</span>IntegLimt <span class="token operator">=</span> IntegLimt<span class="token punctuation">;</span>
	PID_parm<span class="token operator">-&gt;</span>output <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
	PID_parm<span class="token operator">-&gt;</span>output_last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	PID_parm<span class="token operator">-&gt;</span>OutputLimt <span class="token operator">=</span> OutputLimt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//计算位置PID的函数</span>
<span class="token keyword">float</span> <span class="token function">Pos_PID_cal</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>pid_parm<span class="token punctuation">,</span><span class="token keyword">float</span> feedback<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	pid_parm<span class="token operator">-&gt;</span>err_now <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>target <span class="token operator">-</span> feedback<span class="token punctuation">;</span>
	pid_parm<span class="token operator">-&gt;</span>Pout <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>kp<span class="token operator">*</span>pid_parm<span class="token operator">-&gt;</span>err_now<span class="token punctuation">;</span>
	pid_parm<span class="token operator">-&gt;</span>Iout <span class="token operator">+=</span> pid_parm<span class="token operator">-&gt;</span>ki<span class="token operator">*</span>pid_parm<span class="token operator">-&gt;</span>err_now<span class="token punctuation">;</span>
	pid_parm<span class="token operator">-&gt;</span>Dout <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>kd<span class="token operator">*</span><span class="token punctuation">(</span>pid_parm<span class="token operator">-&gt;</span>err_now<span class="token operator">-</span>pid_parm<span class="token operator">-&gt;</span>err_last<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//积分限幅</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid_parm<span class="token operator">-&gt;</span>Iout <span class="token operator">&gt;</span> pid_parm<span class="token operator">-&gt;</span>IntegLimt<span class="token punctuation">)</span>  pid_parm<span class="token operator">-&gt;</span>Iout <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>IntegLimt<span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid_parm<span class="token operator">-&gt;</span>Iout <span class="token operator">&lt;</span> <span class="token operator">-</span>pid_parm<span class="token operator">-&gt;</span>IntegLimt<span class="token punctuation">)</span>  pid_parm<span class="token operator">-&gt;</span>Iout <span class="token operator">=</span> <span class="token operator">-</span>pid_parm<span class="token operator">-&gt;</span>IntegLimt<span class="token punctuation">;</span>
	<span class="token comment">//输出限幅</span>
	pid_parm<span class="token operator">-&gt;</span>output <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>Pout <span class="token operator">+</span> pid_parm<span class="token operator">-&gt;</span>Iout <span class="token operator">+</span> pid_parm<span class="token operator">-&gt;</span>Dout<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid_parm<span class="token operator">-&gt;</span>output <span class="token operator">&gt;</span> pid_parm<span class="token operator">-&gt;</span>OutputLimt<span class="token punctuation">)</span>  pid_parm<span class="token operator">-&gt;</span>output <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>OutputLimt<span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid_parm<span class="token operator">-&gt;</span>output <span class="token operator">&lt;</span> <span class="token operator">-</span>pid_parm<span class="token operator">-&gt;</span>OutputLimt<span class="token punctuation">)</span>  pid_parm<span class="token operator">-&gt;</span>output <span class="token operator">=</span> <span class="token operator">-</span>pid_parm<span class="token operator">-&gt;</span>OutputLimt<span class="token punctuation">;</span>
	<span class="token comment">//数据更新</span>
	pid_parm<span class="token operator">-&gt;</span>err_last <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>err_now<span class="token punctuation">;</span>
	<span class="token keyword">return</span>  pid_parm<span class="token operator">-&gt;</span>output<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//计算增量PID的函数</span>
<span class="token keyword">float</span> <span class="token function">Inc_PID_cal</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>pid_parm<span class="token punctuation">,</span><span class="token keyword">float</span> feedback<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	pid_parm<span class="token operator">-&gt;</span>err_now <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>target <span class="token operator">-</span> feedback<span class="token punctuation">;</span>
	pid_parm<span class="token operator">-&gt;</span>Pout <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>kp<span class="token operator">*</span><span class="token punctuation">(</span>pid_parm<span class="token operator">-&gt;</span>err_now <span class="token operator">-</span> pid_parm<span class="token operator">-&gt;</span>err_last<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pid_parm<span class="token operator">-&gt;</span>Iout <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>ki<span class="token operator">*</span>pid_parm<span class="token operator">-&gt;</span>err_now<span class="token punctuation">;</span>
	pid_parm<span class="token operator">-&gt;</span>Dout <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>kd<span class="token operator">*</span><span class="token punctuation">(</span>pid_parm<span class="token operator">-&gt;</span>err_now <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">*</span>pid_parm<span class="token operator">-&gt;</span>err_last <span class="token operator">+</span> pid_parm<span class="token operator">-&gt;</span>err_llast<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//输出限幅</span>
	pid_parm<span class="token operator">-&gt;</span>output <span class="token operator">+=</span> pid_parm<span class="token operator">-&gt;</span>Pout <span class="token operator">+</span> pid_parm<span class="token operator">-&gt;</span>Iout <span class="token operator">+</span> pid_parm<span class="token operator">-&gt;</span>Dout<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid_parm<span class="token operator">-&gt;</span>output <span class="token operator">&gt;</span> pid_parm<span class="token operator">-&gt;</span>OutputLimt<span class="token punctuation">)</span>  pid_parm<span class="token operator">-&gt;</span>output <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>OutputLimt<span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid_parm<span class="token operator">-&gt;</span>output <span class="token operator">&lt;</span> <span class="token operator">-</span>pid_parm<span class="token operator">-&gt;</span>OutputLimt<span class="token punctuation">)</span>  pid_parm<span class="token operator">-&gt;</span>output <span class="token operator">=</span> <span class="token operator">-</span>pid_parm<span class="token operator">-&gt;</span>OutputLimt<span class="token punctuation">;</span>
	<span class="token comment">//数据更新</span>
	pid_parm<span class="token operator">-&gt;</span>err_llast <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>err_last<span class="token punctuation">;</span>
	pid_parm<span class="token operator">-&gt;</span>err_last <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>err_now<span class="token punctuation">;</span>
	pid_parm<span class="token operator">-&gt;</span>output_last <span class="token operator">=</span> pid_parm<span class="token operator">-&gt;</span>output<span class="token punctuation">;</span>
	<span class="token keyword">return</span>  pid_parm<span class="token operator">-&gt;</span>output<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//初始化PID参数</span>
<span class="token keyword">void</span> <span class="token function">PID_init</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>Spd_PID<span class="token punctuation">,</span>PID_PARM <span class="token operator">*</span>Pos_PID<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		<span class="token function">PID_parm_Init</span><span class="token punctuation">(</span>Pos_PID<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.6</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">180</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
		<span class="token function">PID_parm_Init</span><span class="token punctuation">(</span>Spd_PID<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.01</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.001</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre> 
<p>motor.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"motor.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"can.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"pid.h"</span></span>

u8 Tmotor_Mod_Buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>  <span class="token comment">//电机模式指令</span>
	<span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xfc</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xfd</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xfe</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//数值转换函数/</span>
<span class="token comment">/*                                            /
float_to_uint: 浮点转整型                     /
uint_to_float: 整形变浮点                     /
limitf:        限幅函数                       /
*/</span>                                            <span class="token comment">/</span>
<span class="token comment">///</span>
<span class="token keyword">int</span> <span class="token function">float_to_uint</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> x_min<span class="token punctuation">,</span> <span class="token keyword">float</span> x_max<span class="token punctuation">,</span> <span class="token keyword">int</span> bits<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> span <span class="token operator">=</span> x_max <span class="token operator">-</span> x_min<span class="token punctuation">;</span>
    <span class="token keyword">float</span> offset <span class="token operator">=</span> x_min<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> offset<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>bits<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> span<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">float</span> <span class="token function">uint_to_float</span><span class="token punctuation">(</span><span class="token keyword">int</span> x_int<span class="token punctuation">,</span> <span class="token keyword">float</span> x_min<span class="token punctuation">,</span> <span class="token keyword">float</span> x_max<span class="token punctuation">,</span> <span class="token keyword">int</span> bits<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> span <span class="token operator">=</span> x_max <span class="token operator">-</span> x_min<span class="token punctuation">;</span>
    <span class="token keyword">float</span> offset <span class="token operator">=</span> x_min<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> x_int<span class="token punctuation">)</span> <span class="token operator">*</span> span <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>bits<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">float</span> <span class="token function">limitf</span><span class="token punctuation">(</span><span class="token keyword">float</span> val<span class="token punctuation">,</span> <span class="token keyword">float</span> min_val<span class="token punctuation">,</span> <span class="token keyword">float</span> max_val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">float</span> val_real <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&lt;</span> min_val<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				val_real <span class="token operator">=</span> min_val<span class="token punctuation">;</span>
				<span class="token keyword">return</span> val_real<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;</span> max_val<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				val_real <span class="token operator">=</span> max_val<span class="token punctuation">;</span>
			  <span class="token keyword">return</span> val_real<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
				val_real <span class="token operator">=</span> val<span class="token punctuation">;</span>
			  <span class="token keyword">return</span> val_real<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/Tmotor电机指令</span>
<span class="token comment">/*                                                        /
Tmotor_mod:           设置电机模式（开、关、设置零点）    /
get_Tmotor_measure:   获取电机的反馈数据(16进制的)        /
set_Tmotor_torque:    设置电机力矩                        /
*/</span>                                                        <span class="token comment">/</span>
<span class="token comment">///</span>
<span class="token keyword">void</span> <span class="token function">Tmotor_mod</span><span class="token punctuation">(</span>u8 mod<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">switch</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> Tmotor_Open<span class="token operator">:</span>
			<span class="token function">CAN1_Send_Msg</span><span class="token punctuation">(</span>Tmotor_Mod_Buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		
		<span class="token keyword">case</span> Tmotor_Close<span class="token operator">:</span>
			<span class="token function">set_Tmotor_torque</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">CAN1_Send_Msg</span><span class="token punctuation">(</span>Tmotor_Mod_Buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		
		<span class="token keyword">case</span> Tmotor_SetZero<span class="token operator">:</span>
			<span class="token function">CAN1_Send_Msg</span><span class="token punctuation">(</span>Tmotor_Mod_Buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">get_Tmotor_measure</span><span class="token punctuation">(</span>Tmotor_measure_t <span class="token operator">*</span>ptr<span class="token punctuation">,</span> CanRxMsg <span class="token operator">*</span>Rxmsg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
		ptr<span class="token operator">-&gt;</span>id <span class="token operator">=</span> Rxmsg<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                                              <span class="token comment">//电机id</span>
		ptr<span class="token operator">-&gt;</span>angle <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Rxmsg<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span> <span class="token operator">|</span> Rxmsg<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//电机位置</span>
		ptr<span class="token operator">-&gt;</span>speed_rps  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Rxmsg<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span> <span class="token operator">|</span> Rxmsg<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//电机速度</span>
		ptr<span class="token operator">-&gt;</span>real_torque <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Rxmsg<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0f</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span> <span class="token operator">|</span> Rxmsg<span class="token operator">-&gt;</span>Data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//电机力矩</span>
<span class="token punctuation">}</span>


u8 <span class="token function">set_Tmotor_torque</span><span class="token punctuation">(</span><span class="token keyword">float</span> torque<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
		<span class="token keyword">int</span> p_int<span class="token punctuation">,</span>v_int<span class="token punctuation">,</span>kp_int<span class="token punctuation">,</span>kd_int<span class="token punctuation">,</span>t_int<span class="token punctuation">;</span>
		u8 mbox<span class="token punctuation">;</span>
		u16 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		CanTxMsg TxMessage<span class="token punctuation">;</span>	
		<span class="token comment">// 由于采用力矩模式，不使用位置和速度模式</span>
		kp_int <span class="token operator">=</span> <span class="token function">float_to_uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>KP_MIN<span class="token punctuation">,</span>KP_MAX<span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		kd_int <span class="token operator">=</span> <span class="token function">float_to_uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>KD_MIN<span class="token punctuation">,</span>KD_MAX<span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		p_int <span class="token operator">=</span> <span class="token function">float_to_uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>P_MIN<span class="token punctuation">,</span>P_MAX<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		v_int <span class="token operator">=</span> <span class="token function">float_to_uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>V_MIN<span class="token punctuation">,</span>V_MAX<span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 真正需要设置的是力矩</span>
		t_int <span class="token operator">=</span> <span class="token function">float_to_uint</span><span class="token punctuation">(</span>torque<span class="token punctuation">,</span>T_MIN<span class="token punctuation">,</span>T_MAX<span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		TxMessage<span class="token punctuation">.</span>StdId<span class="token operator">=</span><span class="token number">0x01</span><span class="token punctuation">;</span>	 <span class="token comment">// 标准标识符为1</span>
		TxMessage<span class="token punctuation">.</span>ExtId<span class="token operator">=</span><span class="token number">0x12</span><span class="token punctuation">;</span>	    <span class="token comment">// 设置扩展标示符（29位）这里不需要设置</span>
		TxMessage<span class="token punctuation">.</span>IDE<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		  <span class="token comment">// 使用扩展标识符</span>
		TxMessage<span class="token punctuation">.</span>RTR<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		  <span class="token comment">// 消息类型为数据帧，一帧8位</span>
		TxMessage<span class="token punctuation">.</span>DLC<span class="token operator">=</span><span class="token number">0x08</span><span class="token punctuation">;</span>							 <span class="token comment">// 发送两帧信息</span>

		TxMessage<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p_int<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">;</span>       <span class="token comment">//位置高8位</span>
		TxMessage<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> p_int<span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">;</span>     <span class="token comment">//位置低8位</span>
		TxMessage<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v_int<span class="token operator">&gt;&gt;</span><span class="token number">4</span><span class="token punctuation">;</span>       <span class="token comment">//速度高8位</span>
		TxMessage<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v_int<span class="token operator">&amp;</span><span class="token number">0xF</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>kp_int<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//速度低4位  KP高4位</span>
		TxMessage<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> kp_int<span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">;</span>    <span class="token comment">//KP低8位</span>
		TxMessage<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> kd_int<span class="token operator">&gt;&gt;</span><span class="token number">4</span><span class="token punctuation">;</span>		<span class="token comment">//KD高8位</span>
		TxMessage<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>kd_int<span class="token operator">&amp;</span><span class="token number">0xF</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>t_int<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//KP低4位  扭矩高4位</span>
		TxMessage<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> t_int<span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">;</span>		<span class="token comment">//扭矩低8位</span>
		mbox<span class="token operator">=</span> <span class="token function">CAN_Transmit</span><span class="token punctuation">(</span>CAN1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TxMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>   
		i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">CAN_TransmitStatus</span><span class="token punctuation">(</span>CAN1<span class="token punctuation">,</span> mbox<span class="token punctuation">)</span><span class="token operator">==</span>CAN_TxStatus_Failed<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">0XFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span>i<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//等待发送结束</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;=</span><span class="token number">0XFFF</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>		
<span class="token punctuation">}</span>

<span class="token comment">/Tmotor电机控制模式</span>
<span class="token comment">/*                                                        /
Tmotor_Speed_Control:   	速度控制                        /
Tmotor_Postion_Control:   位置控制                        /
*/</span>                                                        <span class="token comment">/</span>
<span class="token comment">///</span>

<span class="token keyword">void</span> <span class="token function">Tmotor_Speed_Control</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>PID_spd<span class="token punctuation">,</span><span class="token keyword">float</span> target<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 需要先初始化pid参数</span>
		<span class="token comment">// 速度环采用单环即可</span>
		<span class="token comment">//  spd单位rpm  所以将反馈的数据 *60/(2*pi)</span>
		<span class="token keyword">float</span> set_torque<span class="token punctuation">;</span>
		PID_spd<span class="token operator">-&gt;</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
		set_torque <span class="token operator">=</span> <span class="token function">Inc_PID_cal</span><span class="token punctuation">(</span>PID_spd<span class="token punctuation">,</span><span class="token function">uint_to_float</span><span class="token punctuation">(</span>TmotorData<span class="token punctuation">.</span>speed_rps<span class="token punctuation">,</span>V_MIN<span class="token punctuation">,</span>V_MAX<span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>pi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"v:%fn"</span><span class="token punctuation">,</span><span class="token function">uint_to_float</span><span class="token punctuation">(</span>TmotorData<span class="token punctuation">.</span>speed_rps<span class="token punctuation">,</span>V_MIN<span class="token punctuation">,</span>V_MAX<span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token operator">*</span> <span class="token number">60</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>pi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">set_Tmotor_torque</span><span class="token punctuation">(</span>set_torque<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Tmotor_Position_Control</span><span class="token punctuation">(</span>PID_PARM <span class="token operator">*</span>PID_spd<span class="token punctuation">,</span>PID_PARM <span class="token operator">*</span>PID_pos<span class="token punctuation">,</span><span class="token keyword">float</span> target<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//位置控制模式需要设置双环</span>
		<span class="token comment">//采用速度内环和位置外环</span>
		<span class="token comment">//电机反馈的角度单位是rad，需要转换为°,所以*180.f/pi</span>
		<span class="token keyword">float</span> set_torque<span class="token punctuation">;</span>
		<span class="token keyword">float</span> set_spd<span class="token punctuation">;</span>
		PID_pos<span class="token operator">-&gt;</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
		set_spd <span class="token operator">=</span> <span class="token function">Pos_PID_cal</span><span class="token punctuation">(</span>PID_pos<span class="token punctuation">,</span><span class="token function">uint_to_float</span><span class="token punctuation">(</span>TmotorData<span class="token punctuation">.</span>angle<span class="token punctuation">,</span>P_MIN<span class="token punctuation">,</span>P_MAX<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180.f</span><span class="token operator">/</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p:%fn"</span><span class="token punctuation">,</span><span class="token function">uint_to_float</span><span class="token punctuation">(</span>TmotorData<span class="token punctuation">.</span>angle<span class="token punctuation">,</span>P_MIN<span class="token punctuation">,</span>P_MAX<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180.f</span><span class="token operator">/</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		PID_spd<span class="token operator">-&gt;</span>target <span class="token operator">=</span> set_spd<span class="token punctuation">;</span>
		set_torque <span class="token operator">=</span> <span class="token function">Inc_PID_cal</span><span class="token punctuation">(</span>PID_spd<span class="token punctuation">,</span><span class="token function">uint_to_float</span><span class="token punctuation">(</span>TmotorData<span class="token punctuation">.</span>speed_rps<span class="token punctuation">,</span>V_MIN<span class="token punctuation">,</span>V_MAX<span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">30.f</span><span class="token operator">/</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">set_Tmotor_torque</span><span class="token punctuation">(</span>set_torque<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>main.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"can.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"pid.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"motor.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 	
		u8 key<span class="token punctuation">;</span>
		u8 key_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		u8 open_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> spd_target <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> pos_target <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		PID_PARM PID_pos<span class="token punctuation">;</span>
		PID_PARM PID_spd<span class="token punctuation">;</span>
		<span class="token comment">//初始化相关基础模块</span>
		<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置系统中断优先级分组2</span>
		<span class="token function">CAN1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置CAN波特率为1000k</span>
		<span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token number">168</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//初始化延时函数</span>
		<span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//初始化LED端口</span>
		<span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//初始化pid参数</span>
		<span class="token function">PID_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PID_spd<span class="token punctuation">,</span><span class="token operator">&amp;</span>PID_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//Tmotor_mod(Tmotor_Open);</span>
		LED0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token comment">//按键控制电机模式</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			key <span class="token operator">=</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
			<span class="token comment">//printf("%d",key);</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>		
			<span class="token punctuation">{<!-- --></span>				
					<span class="token keyword">switch</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>				 
						<span class="token keyword">case</span> WKUP_PRES<span class="token operator">:</span>	
							<span class="token function">Tmotor_mod</span><span class="token punctuation">(</span>Tmotor_Close<span class="token punctuation">)</span><span class="token punctuation">;</span>
							open_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
							<span class="token keyword">break</span><span class="token punctuation">;</span>
						<span class="token keyword">case</span> KEY0_PRES<span class="token operator">:</span>	
							key_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
							pos_target <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
							spd_target <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
							<span class="token keyword">break</span><span class="token punctuation">;</span>
						<span class="token keyword">case</span> KEY1_PRES<span class="token operator">:</span>	 
							<span class="token function">Tmotor_mod</span><span class="token punctuation">(</span>Tmotor_Open<span class="token punctuation">)</span><span class="token punctuation">;</span>
							open_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
							<span class="token keyword">break</span><span class="token punctuation">;</span>
						<span class="token keyword">case</span> KEY2_PRES<span class="token operator">:</span>	
							key_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
							<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//当需要执行时			</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>open_flag <span class="token operator">&amp;</span> key_flag<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
					<span class="token function">Tmotor_Speed_Control</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PID_spd<span class="token punctuation">,</span>spd_target<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//Tmotor_Position_Control(&amp;PID_spd,&amp;PID_pos,pos_target);</span>
					LED0 <span class="token operator">=</span> <span class="token operator">~</span>LED0<span class="token punctuation">;</span>
					<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//delay_ms(100);</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>   
</code></pre> 
<h3>
<a id="14_PID__824"></a>1.4 PID 调试技巧</h3> 
<p>    PID 的调试是比较复杂的一个活，所以一般来说都会有调参软件的，当当当当~<br>     这里当然没有了。。。<br>     所以我们就只有采用手动试！<br>     还有一点，我们现在考虑的是位置速度双闭环的系统，针对这个系统我们来进行调试。<br>     在试之前，我们还需要了解的是，位置式 PID 是输出的位置量（不一定就是位置），常用在位置环（双环时），增量式 PID 是输出的增量，存在稳态误差，常用在内环。同时考虑到位置是速度积分量，所以需要将速度环放在内部，位置环放在外部，<mark>先调内环，再调外环</mark>，调试的时候，可以先固定微分和积分环节为零，不断的从小到大增大比例环节，在增大到电机抖动就说明不行了，得降低，下降到稳态误差比较小且电机不抖得情况下，尝试增加积分，一点点加，加到电机转动不抖动且稳态误差几乎消除时即可，一般情况下此时稳态误差还会存在，且会伴随着电机在目标值附近来回徘徊，或者出现电机出现超调，即输出值先一下子大于目标值后然后降低到目标值附近（徘徊），这时就需要添加微分环节了，可以消除这个超调哦。调试好内环后，按照同样得方式调试外环参数，最终获得一个比较满意得参数即可。</p> 
<h2>
<a id="2M2006M3508_830"></a>2、M2006（M3508）调参</h2> 
<p>    做过RoboMaster比赛的同学应该接触的比较多，M2006与M3508是大疆出产的两款直流无刷减速电机，由于体积重量和所能提供的力矩大小各有特色各有不同的作用，之前因为项目原因简单的玩了一下。两款电机配备有各自的电机调速器（控制器），我们需要在其基础上对其进行控制。</p> 
<h3>
<a id="21_M2006M3508_832"></a>2.1 M2006（M3508）控制框图</h3> 
<p>    该电机只有底层的电流环，速度环和位置环均不存在，但其实和 Tmotor 电机的控制类似，我们同样可以在其上编写位置环和速度环控制。<br> <img src="https://images2.imgbox.com/d6/f4/5gPdbnSu_o.png" alt="在这里插入图片描述"><br>     添加了速度环和位置环的控制框图如下，和上面的其实并没有区别。<br> <img src="https://images2.imgbox.com/de/99/PzkWnp5x_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="22_M2006M3508__837"></a>2.2 M2006与M3508 完整的控制程序</h3> 
<p>    具体的控制程序并没有太大区别，不同的只有给定电流的指令。<br>     具体文件参考 Tmotor 文件进行修改。</p> 
<h3>
<a id="23__840"></a>2.3 调试技巧</h3> 
<p>    大疆的电机和 Tmotor 控制指令的执行是有区别的，Tmotor 的电机给了电流指令后，它会保存这个指令一直执行，所以只需要给定一次就好了；而 DJI 的它是以矩形波的形式让给定电流维持一小段时间，所以需要不断的给定电流指令。具体的调试技巧和上面大同小异，除了参数的问题，还需要注意指令发送的频率，一般来说100HZ左右都是可以达到比较满意的工况的。</p> 
<h1>
<a id="_842"></a>四、存在的问题</h1> 
<p>    在上面的电机控制中，运行程序的朋友们会发现电机依然存在问题，其中最明显的就是启动时的抖动问题，这个问题也是可以解决的，比如变 PID 控制或者对启动电流进行限制，实现软启动，也可以对电流上升的速度或加速度进行一个限制，如果有机会的话将会在后面将解决后的方案与大家分享。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>