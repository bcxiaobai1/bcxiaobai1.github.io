<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>基于STM32和oneNET云平台的数据采集系统(MQTT协议) - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于STM32和oneNET云平台的数据采集系统(MQTT协议)</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <p></p> 
<div class="toc"> 
 <h3>文章目录</h3> 
 <ul>
<li><a href="#_7">前言</a></li>
<li><a href="#onenet_9">一、onenet云平台产品创建</a></li>
<li><a href="#_29">二、硬件选择</a></li>
<li><a href="#_37">三、设计理念</a></li>
<li><a href="#_55">四、实战编程</a></li>
<li>
<ul>
<li><a href="#1__56">1. 传感器部分</a></li>
<li><a href="#2_ESP8266_321">2. ESP8266</a></li>
<li><a href="#3__547">3. 定时器</a></li>
<li><a href="#4__774">4. 串口</a></li>
<li><a href="#5_MQTT_961">5. MQTT</a></li>
</ul> 
  </li>
<li><a href="#_1236">五、进阶练习</a></li>
</ul> 
</div> 
<p></p> 
<hr> 
<h1>
<a id="_7"></a>前言</h1> 
<p>该篇为基于stm32+esp8266通过<strong>mqtt</strong>协议连接<strong>onenet</strong>物联网云平台，单片机部分将采集到的数据(温湿度、光照强度、压强等等)上传至云平台服务器，云平台可下发指令操控单片机，实现远程通信。</p> 
<h1>
<a id="onenet_9"></a>一、onenet云平台产品创建</h1> 
<p><strong>1. 第一步，注册账号后点击右上角 控制台</strong><br> <img src="https://images2.imgbox.com/08/2c/wCxJZrdW_o.png" alt="在这里插入图片描述"></p> 
<p><strong>2. 第二步，看左上角 选择切换旧版本</strong><br> <img src="https://images2.imgbox.com/30/e5/75Kcv1ev_o.png" alt="在这里插入图片描述"></p> 
<p><strong>3. 第三步，左上角，全部产品中选择多协议接入</strong><br> <img src="https://images2.imgbox.com/f1/9f/zaGOt3RX_o.png" alt="在这里插入图片描述"></p> 
<p><strong>4. 点击添加产品，填好产品信息(红框重点)</strong><br> <img src="https://images2.imgbox.com/9d/5f/xwnW7etA_o.png" alt="在这里插入图片描述"></p> 
<p><strong>5. 选择添加设备</strong><br> <img src="https://images2.imgbox.com/e9/e9/IsMSutam_o.png" alt="在这里插入图片描述"><br> <strong>6. 至此，完成产品创建，示例如下：</strong><br> <img src="https://images2.imgbox.com/15/ef/N0kpeOzH_o.png" alt="在这里插入图片描述"></p> 
<h1>
<a id="_29"></a>二、硬件选择</h1> 
<ul>
<li>
<strong>stm32开发板</strong><br> 原子哥、野火老师等各类开发板都可。</li>
<li>
<strong>esp8266 WiFi模块</strong><br> ATK-ESP-01或01S都可</li>
<li>
<strong>各类传感器</strong><br> DHT11温湿度传感器、GY-39光强度传感器、MQ-2烟雾传感器、led灯等等</li>
</ul> 
<h1>
<a id="_37"></a>三、设计理念</h1> 
<ol>
<li> <p>本项目需将传感器采集到的数据打印在串口供自己查看，所以这里需消费一个串口</p> </li>
<li> <p>esp8266需通过串口连接服务器，接收云服务器发送来的数据，所以这里也需消费一个串口</p> </li>
<li> <p>单片机(客户端)需每隔一段时间向云服务器发送ping命令(心跳包)，用于保持和服务器连接，因为长时间没给服务器发送数据会被服务器强制踢下线，所以这里需消费一个定时器</p> </li>
<li> <p>每隔一段时间需检测云服务器那边有没有向这边发送指令，并将串口二接收到的数据依次放入MQTT接收缓冲器中，并及时处理，所以这里需消费一个定时器</p> </li>
<li> <p>将传感器采集到的数据每隔一段时间重发更新，so，这里也需要消费一个定时器</p> </li>
</ol> 
<p>综上，共消费两个串口，三个定时器。</p> 
<p><strong>云端实时检测与远程操控：</strong><br> <img src="https://images2.imgbox.com/ae/26/UE9DYHAD_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e2/31/O2LaqTkv_o.png" alt="在这里插入图片描述"></p> 
<h1>
<a id="_55"></a>四、实战编程</h1> 
<h2>
<a id="1__56"></a>1. 传感器部分</h2> 
<p><strong>（1）DHT11</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：复位DHT11                                */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>  
<span class="token keyword">void</span> <span class="token function">DHT11_Rst</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	   
<span class="token punctuation">{<!-- --></span>                 
  <span class="token function">DHT11_IO_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//设置IO输出模式</span>
  <span class="token function">DHT11_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//拉低IO</span>
  <span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//拉低至少18ms，我们拉低30</span>
  <span class="token function">DHT11_OUT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//拉高IO</span>
  <span class="token function">DelayUs</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//主机拉高20~40us，我们拉高30us</span>
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：等待DHT11的回应                           */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：1错误 0正确                               */</span>
<span class="token comment">/*-------------------------------------------------*/</span> 
<span class="token keyword">char</span> <span class="token function">DHT11_Check</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 	   
<span class="token punctuation">{<!-- --></span>   
	<span class="token keyword">char</span> timeout<span class="token punctuation">;</span>                            <span class="token comment">//定义一个变量用于超时判断  </span>
	
	timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                             <span class="token comment">//超时变量清零    </span>
	<span class="token function">DHT11_IO_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//IO设置输入模式</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DHT11_DQ_IN <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//DHT11会拉低40~50us,我们等待70us超时时间	</span>
	<span class="token punctuation">{<!-- --></span>	 
		timeout<span class="token operator">++</span><span class="token punctuation">;</span>                           <span class="token comment">//超时变量+1</span>
		<span class="token function">DelayUs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       	 <span class="token comment">//延时1us</span>
	<span class="token punctuation">}</span> 
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout <span class="token operator">&gt;=</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>               <span class="token comment">//如果timeout&gt;=70,说明是因为超时退出的while循环，返回1表示错误</span>
	<span class="token keyword">else</span> timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                        <span class="token comment">//反之，说明是因为等到了DHT11拉低IO，退出的while循环，正确并清零timeout</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DHT11_DQ_IN <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//DHT11拉低后会再次拉高40~50us,,我们等待70us超时时间	</span>
	<span class="token punctuation">{<!-- --></span> 		
		timeout<span class="token operator">++</span><span class="token punctuation">;</span>                           <span class="token comment">//超时变量+1</span>
		<span class="token function">DelayUs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">//延时1us</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout <span class="token operator">&gt;=</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>               <span class="token comment">//如果timeout&gt;=70,说明是因为超时退出的while循环，返回2表示错误  </span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>                                <span class="token comment">//反之正确，返回0</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：读取一个位                                */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：1或0                                     */</span>
<span class="token comment">/*-------------------------------------------------*/</span> 
<span class="token keyword">char</span> <span class="token function">DHT11_Read_Bit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 			 
<span class="token punctuation">{<!-- --></span>
 	<span class="token keyword">char</span> timeout<span class="token punctuation">;</span>                          	   <span class="token comment">//定义一个变量用于超时判断  </span>
	
	timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                               <span class="token comment">//清零timeout	</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DHT11_DQ_IN <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//每一位数据开始，是12~14us的低电平，我们等40us</span>
	<span class="token punctuation">{<!-- --></span>   
		timeout<span class="token operator">++</span><span class="token punctuation">;</span>                             <span class="token comment">//超时变量+1</span>
		<span class="token function">DelayUs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">//延时1us</span>
	<span class="token punctuation">}</span>
	timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                               <span class="token comment">//清零timeout	</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DHT11_DQ_IN <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//接下来，DHT11会拉高IO，根据拉高的时间判断是0或1，我们等60us</span>
	<span class="token punctuation">{<!-- --></span>  
		timeout<span class="token operator">++</span><span class="token punctuation">;</span>                             <span class="token comment">//超时变量+1</span>
		<span class="token function">DelayUs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">//延时1us</span>
	<span class="token punctuation">}</span>
	<span class="token function">DelayUs</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment">//延时35us</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>DHT11_DQ_IN<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                   <span class="token comment">//如果延时后，是高电平，那么本位接收的是1，返回1</span>
	<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>		                       <span class="token comment">//反之延时后，是低电平，那么本位接收的是0，返回0</span>
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：读取一个字节                              */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：数据                                      */</span>
<span class="token comment">/*-------------------------------------------------*/</span> 
<span class="token keyword">char</span> <span class="token function">DHT11_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>    
<span class="token punctuation">{<!-- --></span>        
    <span class="token keyword">char</span> i<span class="token punctuation">;</span>                       				<span class="token comment">//定义一个变量用于for循环  </span>
	<span class="token keyword">char</span> dat<span class="token punctuation">;</span>                              		<span class="token comment">//定义一个变量用于保存数据 </span>
	dat <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	                        		<span class="token comment">//清除保存数据的变量</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>              		<span class="token comment">//一个字节8位，循环8次	</span>
   		dat <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>                    			<span class="token comment">//左移一位，腾出空位    </span>
	    dat <span class="token operator">|=</span> <span class="token function">DHT11_Read_Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      			<span class="token comment">//读取一位数据</span>
    <span class="token punctuation">}</span>						    
    <span class="token keyword">return</span> dat<span class="token punctuation">;</span>                   				<span class="token comment">//返回一个字节的数据</span>
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：读取一次数据温湿度                         */</span>
<span class="token comment">/*参  数：temp:温度值                               */</span>
<span class="token comment">/*参  数：humi:湿度值                               */</span>
<span class="token comment">/*返回值：1错误 0正确                               */</span>
<span class="token comment">/*-------------------------------------------------*/</span> 
<span class="token keyword">char</span> <span class="token function">DHT11_Read_Data</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>temp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>humi<span class="token punctuation">)</span>    
<span class="token punctuation">{<!-- --></span>        
 	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                                         <span class="token comment">//一次完整的数据有5个字节，定义一个缓冲区</span>
	
	<span class="token keyword">char</span> i<span class="token punctuation">;</span>                                              <span class="token comment">//定义一个变量用于for循环  </span>
	<span class="token function">DHT11_Rst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment">//复位DHT11	</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DHT11_Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>							     <span class="token comment">//判断DHT11回复状态=0的话，表示正确，进入if</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>                          <span class="token comment">//一次完整的数据有5个字节，循环5次		</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">DHT11_Read_Byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//每次读取一个字节</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">//判断数据校验，前4个字节相加应该等于第5个字节，正确的话，进入if	</span>
		<span class="token punctuation">{<!-- --></span>     
			<span class="token comment">//u1_printf("%drn",buf[0]); 	//温度数据</span>
			<span class="token comment">//u1_printf("%drn",buf[1]);</span>
			<span class="token comment">//u1_printf("%drn",buf[2]);	//湿度数据</span>
			<span class="token comment">//u1_printf("%drn",buf[3]);</span>
			<span class="token comment">//u1_printf("%drn",buf[4]);</span>
			<span class="token operator">*</span>humi <span class="token operator">=</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                              <span class="token comment">//湿度数据，保存在humi指针指向的地址变量中</span>
			<span class="token operator">*</span>temp <span class="token operator">=</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>							     <span class="token comment">//温度数据，保存在temp指针指向的地址变量中</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                                  <span class="token comment">//反之，数据校验错误，直接返回1</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>                                      <span class="token comment">//反之，如果DHT11回复状态=1的话，表示错误，进入else，直接返回2</span>
	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	                                         <span class="token comment">//读取正确返回0    </span>
<span class="token punctuation">}</span>  

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：初始化DHT11                              */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：1错误 0正确                              */</span>
<span class="token comment">/*-------------------------------------------------*/</span>    	 
<span class="token keyword">char</span> <span class="token function">DHT11_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>                  <span class="token comment">//定义一个IO端口参数结构体</span>
	
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能PA端口时钟</span>
	
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span>  GPIO_Pin_6<span class="token punctuation">;</span>            <span class="token comment">//准备设置PA8</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>     <span class="token comment">//速率50Mhz</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span>   	  <span class="token comment">//推免输出方式</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>            	  <span class="token comment">//设置PA8	</span>
	<span class="token function">DHT11_Rst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                          <span class="token comment">//复位DHT11</span>
	<span class="token keyword">return</span> <span class="token function">DHT11_Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">//返回DHT11的回复状态</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>（2）MQ-2</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Adc_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ADC_InitTypeDef ADC_InitStructure<span class="token punctuation">;</span> 
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>

	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA <span class="token operator">|</span>RCC_APB2Periph_ADC1<span class="token punctuation">,</span> ENABLE <span class="token punctuation">)</span><span class="token punctuation">;</span>	  <span class="token comment">//使能ADC1通道时钟</span>
 

	<span class="token function">RCC_ADCCLKConfig</span><span class="token punctuation">(</span>RCC_PCLK2_Div6<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//设置ADC分频因子6 72M/6=12,ADC最大时间不能超过14M</span>

	<span class="token comment">//PA1 作为模拟通道输入引脚                         </span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_1<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AIN<span class="token punctuation">;</span>		<span class="token comment">//模拟输入引脚</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>	

	<span class="token function">ADC_DeInit</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//复位ADC1 </span>

	ADC_InitStructure<span class="token punctuation">.</span>ADC_Mode <span class="token operator">=</span> ADC_Mode_Independent<span class="token punctuation">;</span>	<span class="token comment">//ADC工作模式:ADC1和ADC2工作在独立模式</span>
	ADC_InitStructure<span class="token punctuation">.</span>ADC_ScanConvMode <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span>	<span class="token comment">//模数转换工作在单通道模式</span>
	ADC_InitStructure<span class="token punctuation">.</span>ADC_ContinuousConvMode <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span>	<span class="token comment">//模数转换工作在单次转换模式</span>
	ADC_InitStructure<span class="token punctuation">.</span>ADC_ExternalTrigConv <span class="token operator">=</span> ADC_ExternalTrigConv_None<span class="token punctuation">;</span>	<span class="token comment">//转换由软件而不是外部触发启动</span>
	ADC_InitStructure<span class="token punctuation">.</span>ADC_DataAlign <span class="token operator">=</span> ADC_DataAlign_Right<span class="token punctuation">;</span>	<span class="token comment">//ADC数据右对齐</span>
	ADC_InitStructure<span class="token punctuation">.</span>ADC_NbrOfChannel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//顺序进行规则转换的ADC通道的数目</span>
	<span class="token function">ADC_Init</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//根据ADC_InitStruct中指定的参数初始化外设ADCx的寄存器   </span>

  
	<span class="token function">ADC_Cmd</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能指定的ADC1</span>
	
	<span class="token function">ADC_ResetCalibration</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能复位校准  </span>
	 
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">ADC_GetResetCalibrationStatus</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待复位校准结束</span>
	
	<span class="token function">ADC_StartCalibration</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">//开启AD校准</span>
 
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">ADC_GetCalibrationStatus</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">//等待校准结束</span>
 
<span class="token comment">//	ADC_SoftwareStartConvCmd(ADC1, ENABLE);		//使能指定的ADC1的软件转换启动功能</span>
<span class="token punctuation">}</span>

<span class="token comment">/**************************** ADC转换值获取函数 ****************************
功  能：获取ADC模块转换后的数值
参  数：无
返回值：存放ADC转换值
***************************************************************************/</span>
u16 <span class="token function">Get_adcvalue</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//设置指定ADC的规则组通道，一个序列，采样时间</span>
	<span class="token function">ADC_RegularChannelConfig</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ADC_Channel_1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ADC_SampleTime_239Cycles5 <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//ADC1,ADC通道,采样时间为239.5周期	  			    </span>
  
	<span class="token function">ADC_SoftwareStartConvCmd</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//使能指定的ADC1的软件转换启动功能	</span>
	 
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ADC_GetFlagStatus</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> ADC_FLAG_EOC <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待转换结束</span>

	<span class="token keyword">return</span> <span class="token function">ADC_GetConversionValue</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//返回最近一次ADC1规则组的转换结果</span>
<span class="token punctuation">}</span>

u16 <span class="token function">Get_Adc_Average</span><span class="token punctuation">(</span>u8 times<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 temp_val<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 t<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>times<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		temp_val<span class="token operator">+=</span><span class="token function">Get_adcvalue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> temp_val<span class="token operator">/</span>times<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>（3）LED</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：初始化LED函数                       	    */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>    	 
	GPIO_InitTypeDef GPIO_InitStr<span class="token punctuation">;</span>
	
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOB <span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//使能时钟</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOE <span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	    
	
	GPIO_InitStr<span class="token punctuation">.</span>GPIO_Mode<span class="token operator">=</span>GPIO_Mode_Out_PP<span class="token punctuation">;</span>    <span class="token comment">//结构体变量赋值</span>
	GPIO_InitStr<span class="token punctuation">.</span>GPIO_Pin<span class="token operator">=</span>GPIO_Pin_5<span class="token punctuation">;</span>
	GPIO_InitStr<span class="token punctuation">.</span>GPIO_Speed<span class="token operator">=</span>GPIO_Speed_50MHz<span class="token punctuation">;</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_InitStr<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//初始化GPIOB</span>
	<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span>GPIO_Pin_5<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//赋予 GPIO_Pin_5 初始为高电平</span>
	
	
	GPIO_InitStr<span class="token punctuation">.</span>GPIO_Mode<span class="token operator">=</span>GPIO_Mode_Out_PP<span class="token punctuation">;</span>  
	GPIO_InitStr<span class="token punctuation">.</span>GPIO_Pin<span class="token operator">=</span>GPIO_Pin_5<span class="token punctuation">;</span>
	GPIO_InitStr<span class="token punctuation">.</span>GPIO_Speed<span class="token operator">=</span>GPIO_Speed_50MHz<span class="token punctuation">;</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_InitStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span>GPIO_Pin_5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：LED开启                                  */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">LED_On</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>			
	<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_5<span class="token punctuation">)</span><span class="token punctuation">;</span> 						 <span class="token comment">//PD2 输出低</span>
<span class="token punctuation">}</span> 


<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：LED关闭                                  */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">LED_Off</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>		
	<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_5<span class="token punctuation">)</span><span class="token punctuation">;</span> 						 <span class="token comment">//PD2 输出高</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2>
<a id="2_ESP8266_321"></a>2. ESP8266</h2> 
<pre><code class="prism language-c"><span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：初始化WiFi的复位IO                       */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">WiFi_ResetIO_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>                    <span class="token comment">//定义一个设置IO端口参数的结构体</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span> RCC_APB2Periph_GPIOA <span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能PA端口时钟</span>
	
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_4<span class="token punctuation">;</span>               <span class="token comment">//准备设置PA4</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>       <span class="token comment">//速率50Mhz</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span>   	    <span class="token comment">//推免输出方式</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>            	    <span class="token comment">//设置PA4</span>
	<span class="token function">RESET_IO</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token comment">//复位IO拉高电平</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：WiFi发送设置指令                          */</span>
<span class="token comment">/*参  数：cmd：指令                                */</span>
<span class="token comment">/*参  数：timeout：超时时间（100ms的倍数）          */</span>
<span class="token comment">/*返回值：0：正确   其他：错误                      */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">char</span> <span class="token function">WiFi_SendCmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmd<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	WiFi_RxCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                           			<span class="token comment">//WiFi接收数据量变量清零                        </span>
	<span class="token function">memset</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WiFi_RXBUFF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>     			<span class="token comment">//清空WiFi接收缓冲区 </span>
	<span class="token function">WiFi_printf</span><span class="token punctuation">(</span><span class="token string">"%srn"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>                  			<span class="token comment">//发送指令</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span>										<span class="token comment">//等待超时时间到0</span>
	<span class="token punctuation">{<!-- --></span>                           			
		<span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             		    <span class="token comment">//延时100ms</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              			<span class="token comment">//如果接收到OK表示指令成功</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>       									<span class="token comment">//主动跳出while循环</span>
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>                 			<span class="token comment">//串口输出现在的超时时间</span>
	<span class="token punctuation">}</span>			
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          			<span class="token comment">//串口输出信息</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                    				<span class="token comment">//如果timeout&lt;=0，说明超时时间到了，也没能收到OK，返回1</span>
	<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>		         							<span class="token comment">//反之，表示正确，说明收到OK，通过break主动跳出while</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：WiFi复位                                 */</span>
<span class="token comment">/*参  数：timeout：超时时间（100ms的倍数）          */</span>
<span class="token comment">/*返回值：0：正确   其他：错误                      */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">char</span> <span class="token function">WiFi_Reset</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">RESET_IO</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    	  <span class="token comment">//复位IO拉低电平</span>
	<span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                  		  <span class="token comment">//延时500ms</span>
	<span class="token function">RESET_IO</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                   		  <span class="token comment">//复位IO拉高电平	</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span>									  <span class="token comment">//等待超时时间到0 </span>
	<span class="token punctuation">{<!-- --></span>                              		  
		<span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 	  <span class="token comment">//延时100ms</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token string">"ready"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>               	  <span class="token comment">//如果接收到ready表示复位成功</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>       						   		  <span class="token comment">//主动跳出while循环</span>
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>                     	  <span class="token comment">//串口输出现在的超时时间</span>
	<span class="token punctuation">}</span>
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              	  <span class="token comment">//串口输出信息</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                        		  <span class="token comment">//如果timeout&lt;=0，说明超时时间到了，也没能收到ready，返回1</span>
	<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>		         				   		  <span class="token comment">//反之，表示正确，说明收到ready，通过break主动跳出while</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：WiFi加入路由器指令                       */</span>
<span class="token comment">/*参  数：timeout：超时时间（1s的倍数）            */</span>
<span class="token comment">/*返回值：0：正确   其他：错误                     */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">char</span> <span class="token function">WiFi_JoinAP</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>		
	WiFi_RxCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                    <span class="token comment">//WiFi接收数据量变量清零                        </span>
	<span class="token function">memset</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WiFi_RXBUFF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//清空WiFi接收缓冲区 </span>
	<span class="token function">WiFi_printf</span><span class="token punctuation">(</span><span class="token string">"AT+CWJAP="%s","%s"rn"</span><span class="token punctuation">,</span> SSID<span class="token punctuation">,</span> PASS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//发送指令	</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span>									   <span class="token comment">//等待超时时间到0</span>
	<span class="token punctuation">{<!-- --></span>                                   
		<span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             		   <span class="token comment">//延时1s</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//如果接收到WIFI GOT IP表示成功</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>       						           <span class="token comment">//主动跳出while循环</span>
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">//串口输出现在的超时时间</span>
	<span class="token punctuation">}</span>
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"rn%srn"</span><span class="token punctuation">,</span> WiFi_RX_BUF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             	       <span class="token comment">//串口输出信息</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                              <span class="token comment">//如果timeout&lt;=0，说明超时时间到了，也没能收到WIFI GOT IP，返回1</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>                                              <span class="token comment">//正确，返回0</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：连接TCP服务器，并进入透传模式            */</span>
<span class="token comment">/*参  数：timeout： 超时时间（100ms的倍数）        */</span>
<span class="token comment">/*返回值：0：正确  其他：错误                      */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">char</span> <span class="token function">WiFi_Connect_Server</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	WiFi_RxCounter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                              	<span class="token comment">//WiFi接收数据量变量清零                        </span>
	<span class="token function">memset</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>WiFi_RXBUFF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//清空WiFi接收缓冲区   </span>
	<span class="token function">WiFi_printf</span><span class="token punctuation">(</span><span class="token string">"AT+CIPSTART="TCP","%s",%drn"</span><span class="token punctuation">,</span> ServerIP<span class="token punctuation">,</span> ServerPort<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送连接服务器指令</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span>								<span class="token comment">//等待超时与否</span>
	<span class="token punctuation">{<!-- --></span>                           
		<span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             	<span class="token comment">//延时100ms	</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token string">"CONNECT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment">//如果接受到CONNECT表示连接成功</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>                                  <span class="token comment">//跳出while循环</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token string">"CLOSED"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token comment">//如果接受到CLOSED表示服务器未开启</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                               <span class="token comment">//服务器未开启返回1</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token string">"ALREADY CONNECTED"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//如果接受到ALREADY CONNECTED已经建立连接</span>
			<span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>                               <span class="token comment">//已经建立连接返回2</span>
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//串口输出现在的超时时间  </span>
	<span class="token punctuation">}</span>
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">//串口输出信息</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>                       <span class="token comment">//超时错误，返回3</span>
	<span class="token keyword">else</span>                                            <span class="token comment">//连接成功，准备进入透传</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"连接服务器成功，准备进入透传rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//串口显示信息</span>
		WiFi_RxCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                          <span class="token comment">//WiFi接收数据量变量清零                        </span>
		<span class="token function">memset</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WiFi_RXBUFF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//清空WiFi接收缓冲区     </span>
		<span class="token function">WiFi_printf</span><span class="token punctuation">(</span><span class="token string">"AT+CIPSENDrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//发送进入透传指令</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span>							 <span class="token comment">//等待超时与否</span>
		<span class="token punctuation">{<!-- --></span>                            
			<span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">//延时100ms	</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token string">"rnOKrnrn&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//如果成立表示进入透传成功</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>                          	 <span class="token comment">//跳出while循环</span>
			<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//串口输出现在的超时时间  </span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>timeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span>                      <span class="token comment">//透传超时错误，返回4	</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	                                     <span class="token comment">//成功返回0	</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：WiFi_Smartconfig                         */</span>
<span class="token comment">/*参  数：timeout：超时时间（1s的倍数）            */</span>
<span class="token comment">/*返回值：0：正确   其他：错误                     */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">char</span> <span class="token function">WiFi_Smartconfig</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	WiFi_RxCounter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                           		<span class="token comment">//WiFi接收数据量变量清零                        </span>
	<span class="token function">memset</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>WiFi_RXBUFF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>     		<span class="token comment">//清空WiFi接收缓冲区     </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span>									<span class="token comment">//等待超时时间到0</span>
	<span class="token punctuation">{<!-- --></span>                           		
		<span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         				<span class="token comment">//延时1s</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token string">"connected"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    	 		  <span class="token comment">//如果串口接受到connected表示成功</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>                                  		<span class="token comment">//跳出while循环  </span>
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>                 		<span class="token comment">//串口输出现在的超时时间  </span>
	<span class="token punctuation">}</span>	
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          		<span class="token comment">//串口输出信息</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                     		<span class="token comment">//超时错误，返回1</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>                                   		<span class="token comment">//正确返回0</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：等待加入路由器                           */</span>
<span class="token comment">/*参  数：timeout：超时时间（1s的倍数）            */</span>
<span class="token comment">/*返回值：0：正确   其他：错误                     */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">char</span> <span class="token function">WiFi_WaitAP</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>		
	<span class="token keyword">while</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>                               <span class="token comment">//等待超时时间到0</span>
		<span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             		<span class="token comment">//延时1s</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>WiFi_RX_BUF<span class="token punctuation">,</span> <span class="token string">"WIFI GOT IP"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment">//如果接收到WIFI GOT IP表示成功</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>       						   								  <span class="token comment">//主动跳出while循环</span>
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//串口输出现在的超时时间</span>
	<span class="token punctuation">}</span>
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">//串口输出信息</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                         <span class="token comment">//如果timeout&lt;=0，说明超时时间到了，也没能收到WIFI GOT IP，返回1</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>                                       <span class="token comment">//正确，返回0</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：WiFi连接服务器                           */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：0：正确   其他：错误                     */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">char</span> <span class="token function">WiFi_Connect_IoTServer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"准备复位模块rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//串口提示数据</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WiFi_Reset</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>								<span class="token comment">//复位，100ms超时单位，总计5s超时时间</span>
	<span class="token punctuation">{<!-- --></span>                             
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"复位失败，准备重启rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	      <span class="token comment">//返回非0值，进入if，串口提示数据</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                                   <span class="token comment">//返回1</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"复位成功rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//串口提示数据</span>
	
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"准备设置STA模式rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//串口提示数据</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WiFi_SendCmd</span><span class="token punctuation">(</span><span class="token string">"AT+CWMODE=1"</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//设置STA模式，100ms超时单位，总计5s超时时间</span>
	<span class="token punctuation">{<!-- --></span>             
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"设置STA模式失败，准备重启rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回非0值，进入if，串口提示数据</span>
		<span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>                                   <span class="token comment">//返回2</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"设置STA模式成功rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//串口提示数据</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>wifi_mode<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//如果联网模式=0：SSID和密码写在程序里 </span>
	<span class="token punctuation">{<!-- --></span>                              
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"准备取消自动连接rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//串口提示数据</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WiFi_SendCmd</span><span class="token punctuation">(</span><span class="token string">"AT+CWAUTOCONN=0"</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		 <span class="token comment">//取消自动连接，100ms超时单位，总计5s超时时间</span>
		<span class="token punctuation">{<!-- --></span>       
			<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"取消自动连接失败，准备重启rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回非0值，进入if，串口提示数据</span>
			<span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>                                  <span class="token comment">//返回3</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"取消自动连接成功rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//串口提示数据</span>
				
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"准备连接路由器rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//串口提示数据	</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WiFi_JoinAP</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//连接路由器,1s超时单位，总计30s超时时间</span>
		<span class="token punctuation">{<!-- --></span>                          
			<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"连接路由器失败，准备重启rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//返回非0值，进入if，串口提示数据</span>
			<span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span>                                 <span class="token comment">//返回4	</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"连接路由器成功rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//串口提示数据			</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"准备设置透传rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//串口提示数据</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WiFi_SendCmd</span><span class="token punctuation">(</span><span class="token string">"AT+CIPMODE=1"</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 			 <span class="token comment">//设置透传，100ms超时单位，总计5s超时时间</span>
	<span class="token punctuation">{<!-- --></span>           
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"设置透传失败，准备重启rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//返回非0值，进入if，串口提示数据</span>
		<span class="token keyword">return</span> <span class="token number">8</span><span class="token punctuation">;</span>                                    <span class="token comment">//返回8</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"设置透传成功rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//串口提示数据</span>
	
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"准备关闭多路连接rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//串口提示数据</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WiFi_SendCmd</span><span class="token punctuation">(</span><span class="token string">"AT+CIPMUX=0"</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 				 <span class="token comment">//关闭多路连接，100ms超时单位，总计5s超时时间</span>
	<span class="token punctuation">{<!-- --></span>            
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"关闭多路连接失败，准备重启rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回非0值，进入if，串口提示数据</span>
		<span class="token keyword">return</span> <span class="token number">9</span><span class="token punctuation">;</span>                                    <span class="token comment">//返回9</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"关闭多路连接成功rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//串口提示数据</span>
	 
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"准备连接服务器rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//串口提示数据</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WiFi_Connect_Server</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      				 <span class="token comment">//连接服务器，100ms超时单位，总计10s超时时间</span>
	<span class="token punctuation">{<!-- --></span>            
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"连接服务器失败，准备重启rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//返回非0值，进入if，串口提示数据</span>
		<span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>                                   <span class="token comment">//返回10</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"连接服务器成功rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//串口提示数据	</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>                                        <span class="token comment">//正确返回0</span>
<span class="token punctuation">}</span>
	
</code></pre> 
<h2>
<a id="3__547"></a>3. 定时器</h2> 
<p><strong>（1）初始化</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：定时器2使能10s定时                        */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">TIM2_ENABLE_10S</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure<span class="token punctuation">;</span>             <span class="token comment">//定义一个设置定时器的变量</span>
	NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>                           <span class="token comment">//定义一个设置中断的变量	</span>
	
	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//设置中断向量分组：第2组 抢先优先级：0 1 2 3 子优先级：0 1 2 3		</span>
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//使能TIM2时钟	</span>
	<span class="token function">TIM_DeInit</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">)</span><span class="token punctuation">;</span>                                              <span class="token comment">//定时器2寄存器恢复默认值	</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> <span class="token number">20000</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 	           <span class="token comment">//设置自动重装载值</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_Prescaler <span class="token operator">=</span> <span class="token number">36000</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>             <span class="token comment">//设置定时器预分频数</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_CounterMode <span class="token operator">=</span> TIM_CounterMode_Up<span class="token punctuation">;</span><span class="token comment">//向上计数模式</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_ClockDivision <span class="token operator">=</span> TIM_CKD_DIV1<span class="token punctuation">;</span>    <span class="token comment">//1分频</span>
	<span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseInitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//设置TIM2</span>
	
	<span class="token function">TIM_ClearITPendingBit</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//清除溢出中断标志位</span>
	<span class="token function">TIM_ITConfig</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//使能TIM2溢出中断    </span>
	<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment">//开TIM2                          </span>
	
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> TIM2_IRQn<span class="token punctuation">;</span>                <span class="token comment">//设置TIM2中断</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>      <span class="token comment">//抢占优先级2</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>             <span class="token comment">//子优先级1</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>                <span class="token comment">//中断通道使能</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">//设置中断</span>
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：定时器3使能30s定时                       */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">TIM3_ENABLE_30S</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure<span class="token punctuation">;</span>             <span class="token comment">//定义一个设置定时器的变量</span>
	NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>                           <span class="token comment">//定义一个设置中断的变量</span>
	
	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//设置中断向量分组：第2组 抢先优先级：0 1 2 3 子优先级：0 1 2 3		</span>
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM3<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//使能TIM3时钟	</span>
	<span class="token function">TIM_DeInit</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">)</span><span class="token punctuation">;</span>                                              <span class="token comment">//定时器3寄存器恢复默认值	</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> <span class="token number">60000</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 	           <span class="token comment">//设置自动重装载值</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_Prescaler <span class="token operator">=</span> <span class="token number">36000</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>             <span class="token comment">//设置定时器预分频数</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_CounterMode <span class="token operator">=</span> TIM_CounterMode_Up<span class="token punctuation">;</span><span class="token comment">//向上计数模式</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_ClockDivision <span class="token operator">=</span> TIM_CKD_DIV1<span class="token punctuation">;</span>    <span class="token comment">//1分频</span>
	<span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseInitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//设置TIM3</span>
	
	<span class="token function">TIM_ClearITPendingBit</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//清除溢出中断标志位</span>
	<span class="token function">TIM_ITConfig</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//使能TIM3溢出中断    </span>
	<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment">//开TIM3                          </span>
	
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> TIM3_IRQn<span class="token punctuation">;</span>                <span class="token comment">//设置TIM3中断</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>      <span class="token comment">//抢占优先级2</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>             <span class="token comment">//子优先级0</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>                <span class="token comment">//中断通道使能</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">//设置中断</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：定时器3使能2s定时                        */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">TIM3_ENABLE_2S</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure<span class="token punctuation">;</span>             <span class="token comment">//定义一个设置定时器的变量</span>
	NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>                           <span class="token comment">//定义一个设置中断的变量</span>
	
	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//设置中断向量分组：第2组 抢先优先级：0 1 2 3 子优先级：0 1 2 3		</span>
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM3<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//使能TIM3时钟</span>
	<span class="token function">TIM_DeInit</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">)</span><span class="token punctuation">;</span>                                              <span class="token comment">//定时器3寄存器恢复默认值	</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> <span class="token number">20000</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 	           <span class="token comment">//设置自动重装载值</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_Prescaler <span class="token operator">=</span> <span class="token number">7200</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>              <span class="token comment">//设置定时器预分频数</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_CounterMode <span class="token operator">=</span> TIM_CounterMode_Up<span class="token punctuation">;</span><span class="token comment">//向上计数模式</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_ClockDivision <span class="token operator">=</span> TIM_CKD_DIV1<span class="token punctuation">;</span>    <span class="token comment">//1分频</span>
	<span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseInitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//设置TIM3</span>
	
	<span class="token function">TIM_ClearITPendingBit</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//清除溢出中断标志位</span>
	<span class="token function">TIM_ITConfig</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//使能TIM3溢出中断    </span>
	<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment">//开TIM3                          </span>
	
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> TIM3_IRQn<span class="token punctuation">;</span>                <span class="token comment">//设置TIM3中断</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token comment">//抢占优先级1</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>             <span class="token comment">//子优先级0</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>                <span class="token comment">//中断通道使能</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">//设置中断</span>
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：定时器4初始化                            */</span>
<span class="token comment">/*参  数：arr：自动重装值   0~65535                */</span>
<span class="token comment">/*参  数：psc：时钟预分频数 0~65535                */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*说  明：定时时间：arr*psc*1000/72000000  单位ms  */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">TIM4_Init</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> arr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> psc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure<span class="token punctuation">;</span>              <span class="token comment">//定义一个设置定时器的变量</span>
	NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>                            <span class="token comment">//定义一个设置中断的变量</span>
	
	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//设置中断向量分组：第2组 抢先优先级：0 1 2 3 子优先级：0 1 2 3		</span>
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM4<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//使能TIM4时钟	</span>
    TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> arr<span class="token punctuation">;</span> 	                <span class="token comment">//设置自动重装载值</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_Prescaler <span class="token operator">=</span> psc<span class="token punctuation">;</span>                  <span class="token comment">//设置定时器预分频数</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_CounterMode <span class="token operator">=</span> TIM_CounterMode_Up<span class="token punctuation">;</span> <span class="token comment">//向上计数模式</span>
	TIM_TimeBaseInitStructure<span class="token punctuation">.</span>TIM_ClockDivision <span class="token operator">=</span> TIM_CKD_DIV1<span class="token punctuation">;</span>     <span class="token comment">//1分频</span>
	<span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseInitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">//设置TIM4</span>
	
	<span class="token function">TIM_ClearITPendingBit</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//清除溢出中断标志位</span>
	<span class="token function">TIM_ITConfig</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">//使能TIM4溢出中断    </span>
	<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment">//先关闭TIM4                          </span>
	
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> TIM4_IRQn<span class="token punctuation">;</span>                 <span class="token comment">//设置TIM4中断</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">//抢占优先级1</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>              <span class="token comment">//子优先级0</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>                 <span class="token comment">//中断通道使能</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">//设置中断</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>（2）中断</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：定时器4中断服务函数。处理MQTT数据          */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">TIM4_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">TIM_GetITStatus</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token comment">//如果TIM_IT_Update置位，表示TIM4溢出中断，进入if	</span>
	<span class="token punctuation">{<!-- --></span>                	
		<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MQTT_RxDataInPtr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Usart2_RxBuff<span class="token punctuation">,</span> Usart2_RxCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//拷贝数据到接收缓冲区</span>
		MQTT_RxDataInPtr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Usart2_RxCounter<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span>                  	<span class="token comment">//记录数据长度高字节</span>
		MQTT_RxDataInPtr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Usart2_RxCounter<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span>					 	<span class="token comment">//记录数据长度低字节</span>
		MQTT_RxDataInPtr <span class="token operator">+=</span> RBUFF_UNIT<span class="token punctuation">;</span>                                	<span class="token comment">//指针下移</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>MQTT_RxDataInPtr <span class="token operator">==</span> MQTT_RxDataEndPtr<span class="token punctuation">)</span>                     	<span class="token comment">//如果指针到缓冲区尾部了</span>
			MQTT_RxDataInPtr <span class="token operator">=</span> MQTT_RxDataBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    	<span class="token comment">//指针归位到缓冲区开头</span>
		Usart2_RxCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                        	<span class="token comment">//串口2接收数据量变量清零</span>
		<span class="token function">TIM_SetCounter</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                     	<span class="token comment">//清零定时器3计数器，重新计时ping包发送时间</span>
		<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                        				 	<span class="token comment">//关闭TIM4定时器</span>
		<span class="token function">TIM_SetCounter</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        			 	<span class="token comment">//清零定时器4计数器</span>
		<span class="token function">TIM_ClearITPendingBit</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>     			 	<span class="token comment">//清除TIM4溢出中断标志 	</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：定时器3中断服务函数                      */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">TIM3_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">TIM_GetITStatus</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token comment">//如果TIM_IT_Update置位，表示TIM3溢出中断，进入if	</span>
		<span class="token punctuation">{<!-- --></span>  
		<span class="token keyword">switch</span><span class="token punctuation">(</span>pingFlag<span class="token punctuation">)</span> 					<span class="token comment">//判断pingFlag的状态</span>
		<span class="token punctuation">{<!-- --></span>                               
			<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>							<span class="token comment">//如果pingFlag等于0，表示正常状态，发送Ping报文  </span>
					<span class="token function">MQTT_PingREQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//添加Ping报文到发送缓冲区  </span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>							<span class="token comment">//如果pingFlag等于1，说明上一次发送到的ping报文，没有收到服务器回复，所以1没有被清除为0，可能是连接异常，我们要启动快速ping模式</span>
					<span class="token function">TIM3_ENABLE_2S</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	    <span class="token comment">//我们将定时器6设置为2s定时,快速发送Ping报文</span>
					<span class="token function">MQTT_PingREQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//添加Ping报文到发送缓冲区  </span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>							<span class="token comment">//如果pingFlag等于2，说明还没有收到服务器回复</span>
			<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>				            <span class="token comment">//如果pingFlag等于3，说明还没有收到服务器回复</span>
			<span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>				            <span class="token comment">//如果pingFlag等于4，说明还没有收到服务器回复	</span>
					<span class="token function">MQTT_PingREQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  		<span class="token comment">//添加Ping报文到发送缓冲区 </span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>							<span class="token comment">//如果pingFlag等于5，说明我们发送了多次ping，均无回复，应该是连接有问题，我们重启连接</span>
					connectFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">//连接状态置0，表示断开，没连上服务器</span>
					<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关TIM3 				</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>			
		<span class="token punctuation">}</span>
		pingFlag<span class="token operator">++</span><span class="token punctuation">;</span>           		   		<span class="token comment">//pingFlag自增1，表示又发送了一次ping，期待服务器的回复</span>
		<span class="token function">TIM_ClearITPendingBit</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除TIM3溢出中断标志 	</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：定时器2中断服务函数                      */</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
	<span class="token keyword">extern</span> u16 ADC_Val<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TIM2_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> humidity<span class="token punctuation">;</span>				<span class="token comment">//定义一个变量，保存湿度值</span>
	<span class="token keyword">char</span> temperature<span class="token punctuation">;</span>			<span class="token comment">//定义一个变量，保存温度值	</span>
				
	<span class="token keyword">char</span> head1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> temp<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>				<span class="token comment">//定义一个临时缓冲区1,不包括报头</span>
	<span class="token keyword">char</span> tempAll<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">//定义一个临时缓冲区2，包括所有数据</span>
	
	<span class="token keyword">int</span>	dataLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">//报文长度</span>
	<span class="token function">ADC_Val_Disp</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//气敏检测</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">TIM_GetITStatus</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>	
	<span class="token punctuation">{<!-- --></span> 
		<span class="token function">DHT11_Read_Data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temperature<span class="token punctuation">,</span><span class="token operator">&amp;</span>humidity<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取温湿度值</span>

		<span class="token function">memset</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				    <span class="token comment">//清空缓冲区1</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>tempAll<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//清空缓冲区2</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>head1<span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//清空MQTT头</span>

		<span class="token function">sprintf</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span><span class="token string">"{"MQ":"%d","TM":"%d","HM":"%d"}"</span><span class="token punctuation">,</span>
					  	<span class="token punctuation">(</span>ADC_Val<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> temperature<span class="token punctuation">,</span> humidity<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//构建报文</span>

		head1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span> 						<span class="token comment">//固定报头</span>
		head1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> 						<span class="token comment">//固定报头</span>
		head1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>  				<span class="token comment">//剩余长度	</span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>tempAll<span class="token punctuation">,</span> <span class="token string">"%c%c%c%s"</span><span class="token punctuation">,</span> head1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> head1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> head1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"rn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//串口显示相关数据</span>
		<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"%srn"</span><span class="token punctuation">,</span> tempAll <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		dataLen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token function">MQTT_PublishQs0</span><span class="token punctuation">(</span>Data_TOPIC_NAME<span class="token punctuation">,</span>tempAll<span class="token punctuation">,</span> dataLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//添加数据，发布给服务器</span>
		
		<span class="token function">TIM_ClearITPendingBit</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>   	
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2>
<a id="4__774"></a>4. 串口</h2> 
<p><strong>（1）初始化</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：初始化串口1发送功能                      */</span>
<span class="token comment">/*参  数：bound：波特率                            */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">Usart1_Init</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> bound<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  	 	
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>     <span class="token comment">//定义一个设置GPIO功能的变量</span>
	USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span>   <span class="token comment">//定义一个设置串口功能的变量</span>
   
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_USART1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能串口1时钟</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//使能GPIOA时钟</span>
	
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_9<span class="token punctuation">;</span>              <span class="token comment">//准备设置PA9</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>      <span class="token comment">//IO速率50M</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span>	       <span class="token comment">//复用推挽输出，用于串口1的发送</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//设置PA9</span>
   
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_10<span class="token punctuation">;</span>             <span class="token comment">//准备设置PA10 </span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN_FLOATING<span class="token punctuation">;</span>  <span class="token comment">//浮空输入，用于串口1的接收</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//设置PA10</span>
	
	USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> bound<span class="token punctuation">;</span>                                    <span class="token comment">//波特率设置</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>                    <span class="token comment">//8个数据位</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>                         <span class="token comment">//1个停止位</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No<span class="token punctuation">;</span>                            <span class="token comment">//无奇偶校验位</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span><span class="token comment">//无硬件数据流控制</span>
                                                                                   <span class="token comment">//如果不使能接收模式</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Tx <span class="token punctuation">;</span>	                           <span class="token comment">//只发模式        </span>
    <span class="token function">USART_Init</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment">//设置串口1	</span>
	<span class="token function">USART_Cmd</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                            						   <span class="token comment">//使能串口1</span>
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：串口1 printf函数                         */</span>
<span class="token comment">/*参  数：char* fmt,...  格式化输出字符串和参数     */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token function">__align</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">char</span> Usart1_TxBuff<span class="token punctuation">[</span>USART1_TXBUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>  

<span class="token keyword">void</span> <span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>  
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> length<span class="token punctuation">;</span>
	
	va_list ap<span class="token punctuation">;</span>
	<span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">vsprintf</span><span class="token punctuation">(</span>Usart1_TxBuff<span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	
	length <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>Usart1_TxBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>		
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">0X40</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>			
		USART1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> Usart1_TxBuff<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">0X40</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>	
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：初始化串口2发送功能                        */</span>
<span class="token comment">/*参  数：bound：波特率                             */</span>
<span class="token comment">/*返回值：无                                        */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">Usart2_Init</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> bound<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  	 	
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>     <span class="token comment">//定义一个设置GPIO功能的变量</span>
	USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span>   <span class="token comment">//定义一个设置串口功能的变量</span>
	NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>     <span class="token comment">//如果使能接收功能，定义一个设置中断的变量</span>

	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//设置中断向量分组：第2组 抢先优先级：0 1 2 3 子优先级：0 1 2 3	</span>
      
	
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_USART2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能串口2时钟</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//使能GPIOA时钟</span>
	<span class="token function">USART_DeInit</span><span class="token punctuation">(</span>USART2<span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token comment">//串口2寄存器重新设置为默认值</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_2<span class="token punctuation">;</span>              <span class="token comment">//准备设置PA2</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>      <span class="token comment">//IO速率50M</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span>	       <span class="token comment">//复用推挽输出，用于串口2的发送</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//设置PA2</span>
   
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_3<span class="token punctuation">;</span>              <span class="token comment">//准备设置PA3</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN_FLOATING<span class="token punctuation">;</span>  <span class="token comment">//浮空输入，用于串口2的接收</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//设置PA3</span>
	
	USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> bound<span class="token punctuation">;</span>                                    <span class="token comment">//波特率设置</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>                    <span class="token comment">//8个数据位</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>                         <span class="token comment">//1个停止位</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No<span class="token punctuation">;</span>                            <span class="token comment">//无奇偶校验位</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span><span class="token comment">//无硬件数据流控制</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Tx <span class="token operator">|</span> USART_Mode_Rx<span class="token punctuation">;</span>	               <span class="token comment">//收发模式</span>
      
    <span class="token function">USART_Init</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment">//设置串口2	</span>

	<span class="token function">USART_ClearFlag</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> USART_FLAG_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>	              <span class="token comment">//清除接收标志位</span>
	<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//开启接收中断</span>
    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> USART2_IRQn<span class="token punctuation">;</span>         <span class="token comment">//设置串口2中断</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//抢占优先级0</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		  <span class="token comment">//子优先级0</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>			  <span class="token comment">//中断通道使能</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>	                          <span class="token comment">//设置串口2中断 </span>

	<span class="token function">USART_Cmd</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">//使能串口2</span>
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：串口2 printf函数                          */</span>
<span class="token comment">/*参  数：char* fmt,...  格式化输出字符串和参数      */</span>
<span class="token comment">/*返回值：无                                        */</span>
<span class="token comment">/*-------------------------------------------------*/</span>

<span class="token function">__align</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">char</span> USART2_TxBuff<span class="token punctuation">[</span>USART2_TXBUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>  

<span class="token keyword">void</span> <span class="token function">u2_printf</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>  
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> length<span class="token punctuation">;</span>
	
	va_list ap<span class="token punctuation">;</span>
	<span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">vsprintf</span><span class="token punctuation">(</span>USART2_TxBuff<span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	
	length<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>USART2_TxBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>		
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART2<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">0X40</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>			
		USART2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> USART2_TxBuff<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART2<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">0X40</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>	
<span class="token punctuation">}</span>

<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：串口2发送缓冲区中的数据                    */</span>
<span class="token comment">/*参  数：data：数据                                */</span>
<span class="token comment">/*返回值：无                                        */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">u2_TxData</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span>	i<span class="token punctuation">;</span>	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART2<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">0X40</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>			
		USART2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART2<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">0X40</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>（2）中断</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/*-------------------------------------------------*/</span>
<span class="token comment">/*函数名：串口2接收中断函数（最高优先级，处理接收数据）*/</span>
<span class="token comment">/*参  数：无                                       */</span>
<span class="token comment">/*返回值：无                                       */</span>
<span class="token comment">/*-------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">USART2_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>   
<span class="token punctuation">{<!-- --></span>                      
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetITStatus</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>    <span class="token comment">//如果USART_IT_RXNE标志置位，表示有数据到了，进入if分支</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token keyword">if</span><span class="token punctuation">(</span>connectFlag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 							     <span class="token comment">//如果connectFlag等于0，当前还没有连接服务器，处于指令配置状态</span>
		<span class="token punctuation">{<!-- --></span>                                     
			<span class="token keyword">if</span><span class="token punctuation">(</span>USART2<span class="token operator">-&gt;</span>DR<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>                                     			 <span class="token comment">//处于指令配置状态时，非零值才保存到缓冲区	</span>
				Usart2_RxBuff<span class="token punctuation">[</span>Usart2_RxCounter<span class="token punctuation">]</span> <span class="token operator">=</span> USART2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span><span class="token comment">//保存到缓冲区	</span>
				Usart2_RxCounter<span class="token operator">++</span><span class="token punctuation">;</span> 						 <span class="token comment">//每接收1个字节的数据，Usart2_RxCounter加1，表示接收的数据总量+1 </span>
			<span class="token punctuation">}</span>					
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>		                                           	 <span class="token comment">//反之connectFlag等于1，连接上服务器了	</span>
			Usart2_RxBuff<span class="token punctuation">[</span>Usart2_RxCounter<span class="token punctuation">]</span> <span class="token operator">=</span> USART2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>    <span class="token comment">//把接收到的数据保存到Usart2_RxBuff中				</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>Usart2_RxCounter <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>    									    											 <span class="token comment">//如果Usart2_RxCounter等于0，表示是接收的第1个数据，进入if分支				</span>
				<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>																						 <span class="token comment">//else分支，表示果Usart2_RxCounter不等于0，不是接收的第一个数据</span>
			<span class="token punctuation">{<!-- --></span>                        									    
				<span class="token function">TIM_SetCounter</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
			<span class="token punctuation">}</span>	
			Usart2_RxCounter<span class="token operator">++</span><span class="token punctuation">;</span>         				     <span class="token comment">//每接收1个字节的数据，Usart2_RxCounter加1，表示接收的数据总量+1 </span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> 
<h2>
<a id="5_MQTT_961"></a>5. MQTT</h2> 
<pre><code class="prism language-c"><span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token comment">/*函数名：初始化接收,发送,命令数据的 缓冲区 以及各状态参数  */</span>
<span class="token comment">/*参  数：无                                                */</span>
<span class="token comment">/*返回值：无                                                */</span>
<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">MQTT_Buff_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	MQTT_RxDataInPtr<span class="token operator">=</span>MQTT_RxDataBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 				 <span class="token comment">//指向发送缓冲区存放数据的指针归位</span>
	MQTT_RxDataOutPtr<span class="token operator">=</span>MQTT_RxDataInPtr<span class="token punctuation">;</span> 				 <span class="token comment">//指向发送缓冲区读取数据的指针归位</span>
	MQTT_RxDataEndPtr<span class="token operator">=</span>MQTT_RxDataBuf<span class="token punctuation">[</span>R_NUM<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		     <span class="token comment">//指向发送缓冲区结束的指针归位</span>
	
	MQTT_TxDataInPtr<span class="token operator">=</span>MQTT_TxDataBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>					 <span class="token comment">//指向发送缓冲区存放数据的指针归位</span>
	MQTT_TxDataOutPtr<span class="token operator">=</span>MQTT_TxDataInPtr<span class="token punctuation">;</span>				     <span class="token comment">//指向发送缓冲区读取数据的指针归位</span>
	MQTT_TxDataEndPtr<span class="token operator">=</span>MQTT_TxDataBuf<span class="token punctuation">[</span>T_NUM<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>           <span class="token comment">//指向发送缓冲区结束的指针归位</span>
	
	MQTT_CMDInPtr<span class="token operator">=</span>MQTT_CMDBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                        <span class="token comment">//指向命令缓冲区存放数据的指针归位</span>
	MQTT_CMDOutPtr<span class="token operator">=</span>MQTT_CMDInPtr<span class="token punctuation">;</span>                        <span class="token comment">//指向命令缓冲区读取数据的指针归位</span>
	MQTT_CMDEndPtr<span class="token operator">=</span>MQTT_CMDBuf<span class="token punctuation">[</span>C_NUM<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              	 <span class="token comment">//指向命令缓冲区结束的指针归位</span>

	<span class="token function">MQTT_ConectPack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                	 <span class="token comment">//发送缓冲区添加连接报文</span>
	<span class="token function">MQTT_Subscribe</span><span class="token punctuation">(</span>S_TOPIC_NAME<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	                 	 <span class="token comment">//发送缓冲区添加订阅topic，等级0	</span>
	
	pingFlag <span class="token operator">=</span> connectPackFlag <span class="token operator">=</span> subcribePackFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//各个参数清零</span>
<span class="token punctuation">}</span>

<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token comment">/*函数名：云初始化参数，得到客户端ID，用户名和密码          */</span>
<span class="token comment">/*参  数：无                                                */</span>
<span class="token comment">/*返回值：无                                                */</span>
<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">IoT_Parameter_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	<span class="token function">memset</span><span class="token punctuation">(</span>ClientID<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">//客户端ID的缓冲区全部清零</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>ClientID<span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span>DEVICEID<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//构建客户端ID，并存入缓冲区</span>
	ClientID_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>ClientID<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//计算客户端ID的长度</span>
	
	<span class="token function">memset</span><span class="token punctuation">(</span>Username<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">//用户名的缓冲区全部清零</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>Username<span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span>PRODUCTID<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//构建用户名，并存入缓冲区</span>
	Username_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Username<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//计算用户名的长度</span>
	
	<span class="token function">memset</span><span class="token punctuation">(</span>Passward<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">//用户名的缓冲区全部清零</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>Passward<span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span>AUTHENTICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//构建密码，并存入缓冲区</span>
	Passward_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Passward<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//计算密码的长度</span>
	
	<span class="token function">memset</span><span class="token punctuation">(</span>ServerIP<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">sprintf</span><span class="token punctuation">(</span>ServerIP<span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"183.230.40.39"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//构建服务器域名</span>
	ServerPort <span class="token operator">=</span> <span class="token number">6002</span><span class="token punctuation">;</span>                                   <span class="token comment">//服务器端口号6002</span>
	
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"服 务 器：%s:%drn"</span><span class="token punctuation">,</span>ServerIP<span class="token punctuation">,</span>ServerPort<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//串口输出调试信息</span>
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"客户端ID：%srn"</span><span class="token punctuation">,</span>ClientID<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//串口输出调试信息</span>
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"用 户 名：%srn"</span><span class="token punctuation">,</span>Username<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//串口输出调试信息</span>
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"密    码：%srn"</span><span class="token punctuation">,</span>Passward<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//串口输出调试信息</span>
<span class="token punctuation">}</span>

<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token comment">/*函数名：连接服务器报文                                    */</span>
<span class="token comment">/*参  数：无                                                */</span>
<span class="token comment">/*返回值：无                                                */</span>
<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">MQTT_ConectPack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	<span class="token keyword">int</span> temp<span class="token punctuation">,</span>Remaining_len<span class="token punctuation">;</span>
	
	Fixed_len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                                                        <span class="token comment">//连接报文中，固定报头长度暂时先=1</span>
	Variable_len <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>                                                    <span class="token comment">//连接报文中，可变报头长度=10</span>
	Payload_len <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> ClientID_len <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> Username_len <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> Passward_len<span class="token punctuation">;</span> <span class="token comment">//连接报文中，负载长度      </span>
	Remaining_len <span class="token operator">=</span> Variable_len <span class="token operator">+</span> Payload_len<span class="token punctuation">;</span>                           <span class="token comment">//剩余长度=可变报头长度+负载长度</span>
	
	temp_buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">;</span>                         <span class="token comment">//固定报头第1个字节 ：固定0x01		</span>
	<span class="token keyword">do</span><span class="token punctuation">{<!-- --></span>                                        <span class="token comment">//循环处理固定报头中的剩余长度字节，字节量根据剩余字节的真实长度变化</span>
		temp <span class="token operator">=</span> Remaining_len<span class="token operator">%</span><span class="token number">128</span><span class="token punctuation">;</span>              <span class="token comment">//剩余长度取余128</span>
		Remaining_len <span class="token operator">=</span> Remaining_len<span class="token operator">/</span><span class="token number">128</span><span class="token punctuation">;</span>     <span class="token comment">//剩余长度取整128</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>Remaining_len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>               	
			temp <span class="token operator">|=</span> <span class="token number">0x80</span><span class="token punctuation">;</span>                      <span class="token comment">//按协议要求位7置位          </span>
		temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>           <span class="token comment">//剩余长度字节记录一个数据</span>
		Fixed_len<span class="token operator">++</span><span class="token punctuation">;</span>	                       <span class="token comment">//固定报头总长度+1    </span>
	<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>Remaining_len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//如果Remaining_len&gt;0的话，再次进入循环</span>
	
	temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>     <span class="token comment">//可变报头第1个字节 ：固定0x00	            </span>
	temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x04</span><span class="token punctuation">;</span>     <span class="token comment">//可变报头第2个字节 ：固定0x04</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x4D</span><span class="token punctuation">;</span>	 <span class="token comment">//可变报头第3个字节 ：固定0x4D</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x51</span><span class="token punctuation">;</span>	 <span class="token comment">//可变报头第4个字节 ：固定0x51</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x54</span><span class="token punctuation">;</span>	 <span class="token comment">//可变报头第5个字节 ：固定0x54</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x54</span><span class="token punctuation">;</span>     <span class="token comment">//可变报头第6个字节 ：固定0x54</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x04</span><span class="token punctuation">;</span>	 <span class="token comment">//可变报头第7个字节 ：固定0x04</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xC2</span><span class="token punctuation">;</span>	 <span class="token comment">//可变报头第8个字节 ：使能用户名和密码校验，不使用遗嘱，不保留会话</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> 	 <span class="token comment">//可变报头第9个字节 ：保活时间高字节 0x00</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x64</span><span class="token punctuation">;</span>	 <span class="token comment">//可变报头第10个字节：保活时间高字节 0x64   100s</span>
	
	<span class="token comment">/*     CLIENT_ID      */</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> ClientID_len<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span>                			  	<span class="token comment">//客户端ID长度高字节</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> ClientID_len<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span>               			  	<span class="token comment">//客户端ID长度低字节</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ClientID<span class="token punctuation">,</span>ClientID_len<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//复制过来客户端ID字串	</span>
	<span class="token comment">/*     用户名        */</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">12</span><span class="token operator">+</span>ClientID_len<span class="token punctuation">]</span> <span class="token operator">=</span> Username_len<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span> 				<span class="token comment">//用户名长度高字节</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">13</span><span class="token operator">+</span>ClientID_len<span class="token punctuation">]</span> <span class="token operator">=</span> Username_len<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span> 				<span class="token comment">//用户名长度低字节</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">14</span><span class="token operator">+</span>ClientID_len<span class="token punctuation">]</span><span class="token punctuation">,</span>Username<span class="token punctuation">,</span>Username_len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//复制过来用户名字串	</span>
	<span class="token comment">/*      密码        */</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">14</span><span class="token operator">+</span>ClientID_len<span class="token operator">+</span>Username_len<span class="token punctuation">]</span> <span class="token operator">=</span> Passward_len<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span>	<span class="token comment">//密码长度高字节</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">15</span><span class="token operator">+</span>ClientID_len<span class="token operator">+</span>Username_len<span class="token punctuation">]</span> <span class="token operator">=</span> Passward_len<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span>	<span class="token comment">//密码长度低字节</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">16</span><span class="token operator">+</span>ClientID_len<span class="token operator">+</span>Username_len<span class="token punctuation">]</span><span class="token punctuation">,</span>Passward<span class="token punctuation">,</span>Passward_len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//复制过来密码字串</span>

	<span class="token function">TxDataBuf_Deal</span><span class="token punctuation">(</span>temp_buff<span class="token punctuation">,</span> Fixed_len <span class="token operator">+</span> Variable_len <span class="token operator">+</span> Payload_len<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//加入发送数据缓冲区</span>
<span class="token punctuation">}</span>

<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token comment">/*函数名：SUBSCRIBE订阅topic报文                            */</span>
<span class="token comment">/*参  数：QoS：订阅等级                                     */</span>
<span class="token comment">/*参  数：topic_name：订阅topic报文名称                     */</span>
<span class="token comment">/*返回值：无                                                */</span>
<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">MQTT_Subscribe</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>topic_name<span class="token punctuation">,</span> <span class="token keyword">int</span> QoS<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	Fixed_len <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                              		   <span class="token comment">//SUBSCRIBE报文中，固定报头长度=2</span>
	Variable_len <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                          			   <span class="token comment">//SUBSCRIBE报文中，可变报头长度=2	</span>
	Payload_len <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>topic_name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>   		   <span class="token comment">//计算有效负荷长度 = 2字节(topic_name长度)+ topic_name字符串的长度 + 1字节服务等级</span>
	
	temp_buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x82</span><span class="token punctuation">;</span>                                   <span class="token comment">//第1个字节 ：固定0x82                      </span>
	temp_buff<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Variable_len <span class="token operator">+</span> Payload_len<span class="token punctuation">;</span>             <span class="token comment">//第2个字节 ：可变报头+有效负荷的长度	</span>
	temp_buff<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>                                   <span class="token comment">//第3个字节 ：报文标识符高字节，固定使用0x00</span>
	temp_buff<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>		                           <span class="token comment">//第4个字节 ：报文标识符低字节，固定使用0x01</span>
	temp_buff<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>topic_name<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span>                 <span class="token comment">//第5个字节 ：topic_name长度高字节</span>
	temp_buff<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>topic_name<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span>		           <span class="token comment">//第6个字节 ：topic_name长度低字节</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp_buff<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> topic_name<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>topic_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//第7个字节开始 ：复制过来topic_name字串		</span>
	temp_buff<span class="token punctuation">[</span><span class="token number">6</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>topic_name<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> QoS<span class="token punctuation">;</span>               <span class="token comment">//最后1个字节：订阅等级</span>
	
	<span class="token function">TxDataBuf_Deal</span><span class="token punctuation">(</span>temp_buff<span class="token punctuation">,</span> Fixed_len <span class="token operator">+</span> Variable_len <span class="token operator">+</span> Payload_len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//加入发送数据缓冲区</span>
<span class="token punctuation">}</span>

<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token comment">/*函数名：PING报文，心跳包                                   */</span>
<span class="token comment">/*参  数：无                                                */</span>
<span class="token comment">/*返回值：无                                                */</span>
<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">MQTT_PingREQ</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	temp_buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xC0</span><span class="token punctuation">;</span>              <span class="token comment">//第1个字节 ：固定0xC0                      </span>
	temp_buff<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>              <span class="token comment">//第2个字节 ：固定0x00 </span>

	<span class="token function">TxDataBuf_Deal</span><span class="token punctuation">(</span>temp_buff<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//加入数据到缓冲区</span>
<span class="token punctuation">}</span>

<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token comment">/*函数名：等级0 发布消息报文                                  */</span>
<span class="token comment">/*参  数：topic_name：topic名称                              */</span>
<span class="token comment">/*参  数：data：数据                                         */</span> 
<span class="token comment">/*参  数：data_len：数据长度                                 */</span>
<span class="token comment">/*返回值：无                                                 */</span>
<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">MQTT_PublishQs0</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>topic<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> data_len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	<span class="token keyword">int</span> temp<span class="token punctuation">,</span>Remaining_len<span class="token punctuation">;</span>
	
	Fixed_len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                              <span class="token comment">//固定报头长度暂时先等于：1字节</span>
	Variable_len <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//可变报头长度：2字节(topic长度)+ topic字符串的长度</span>
	Payload_len <span class="token operator">=</span> data_len<span class="token punctuation">;</span>                     <span class="token comment">//有效负荷长度：就是data_len</span>
	Remaining_len <span class="token operator">=</span> Variable_len <span class="token operator">+</span> Payload_len<span class="token punctuation">;</span> <span class="token comment">//剩余长度=可变报头长度+负载长度</span>
	
	temp_buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>                      	<span class="token comment">//固定报头第1个字节 ：固定0x30   	</span>
	<span class="token keyword">do</span><span class="token punctuation">{<!-- --></span>                                         <span class="token comment">//循环处理固定报头中的剩余长度字节，字节量根据剩余字节的真实长度变化</span>
		temp <span class="token operator">=</span> Remaining_len<span class="token operator">%</span><span class="token number">128</span><span class="token punctuation">;</span>           	<span class="token comment">//剩余长度取余128</span>
		Remaining_len <span class="token operator">=</span> Remaining_len<span class="token operator">/</span><span class="token number">128</span><span class="token punctuation">;</span>      <span class="token comment">//剩余长度取整128</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>Remaining_len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>               	
			temp <span class="token operator">|=</span> <span class="token number">0x80</span><span class="token punctuation">;</span>                    	<span class="token comment">//按协议要求位7置位          </span>
		temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>            <span class="token comment">//剩余长度字节记录一个数据</span>
		Fixed_len<span class="token operator">++</span><span class="token punctuation">;</span>	                     	<span class="token comment">//固定报头总长度+1    </span>
	<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>Remaining_len<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//如果Remaining_len&gt;0的话，再次进入循环</span>
		             
	temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span>                       <span class="token comment">//可变报头第1个字节     ：topic长度高字节</span>
	temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span>		                  <span class="token comment">//可变报头第2个字节     ：topic长度低字节</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp_buff<span class="token punctuation">[</span>Fixed_len<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">//可变报头第3个字节开始 ：拷贝topic字符串	</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp_buff<span class="token punctuation">[</span>Fixed_len <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> data_len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//有效负荷：拷贝data数据</span>
	
	<span class="token function">TxDataBuf_Deal</span><span class="token punctuation">(</span>temp_buff<span class="token punctuation">,</span> Fixed_len <span class="token operator">+</span> Variable_len <span class="token operator">+</span> Payload_len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加入发送数据缓冲区	</span>
<span class="token punctuation">}</span>

<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token comment">/*函数名：处理服务器发来的等级0的推送                          */</span>
<span class="token comment">/*参  数：redata：接收的数据                                 */</span>
<span class="token comment">/*返回值：无                                                 */</span>
<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">MQTT_DealPushdata_Qs0</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>redata<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span>  re_len<span class="token punctuation">;</span>               	           <span class="token comment">//定义一个变量，存放接收的数据总长度</span>
	<span class="token keyword">int</span>  pack_num<span class="token punctuation">;</span>                         <span class="token comment">//定义一个变量，当多个推送一起过来时，保存推送的个数</span>
    <span class="token keyword">int</span>  temp<span class="token punctuation">,</span>temp_len<span class="token punctuation">;</span>                    <span class="token comment">//定义一个变量，暂存数据</span>
    <span class="token keyword">int</span>  totle_len<span class="token punctuation">;</span>                        <span class="token comment">//定义一个变量，存放已经统计的推送的总数据量</span>
	<span class="token keyword">int</span>  topic_len<span class="token punctuation">;</span>              	       <span class="token comment">//定义一个变量，存放推送中主题的长度</span>
	<span class="token keyword">int</span>  cmd_len<span class="token punctuation">;</span>                          <span class="token comment">//定义一个变量，存放推送中包含的命令数据的长度</span>
	<span class="token keyword">int</span>  cmd_loca<span class="token punctuation">;</span>                         <span class="token comment">//定义一个变量，存放推送中包含的命令的起始位置</span>
	<span class="token keyword">int</span>  i<span class="token punctuation">;</span>                                <span class="token comment">//定义一个变量，用于for循环</span>
	<span class="token keyword">int</span>  local<span class="token punctuation">,</span>multiplier<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> tempbuff<span class="token punctuation">[</span>RBUFF_UNIT<span class="token punctuation">]</span><span class="token punctuation">;</span>	   <span class="token comment">//临时缓冲区</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>                   <span class="token comment">//redata过来的时候，第一个字节是数据总量，data用于指向redata的第2个字节，真正的数据开始的地方</span>
		
	re_len <span class="token operator">=</span> redata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">256</span><span class="token operator">+</span>redata<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                     <span class="token comment">//获取接收的数据总长度		</span>
	data <span class="token operator">=</span> <span class="token operator">&amp;</span>redata<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                                    <span class="token comment">//data指向redata的第2个字节，真正的数据开始的 </span>
	pack_num <span class="token operator">=</span> temp_len <span class="token operator">=</span> totle_len <span class="token operator">=</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>           <span class="token comment">//各个变量清零</span>
	local <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	multiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">do</span><span class="token punctuation">{<!-- --></span>
		pack_num<span class="token operator">++</span><span class="token punctuation">;</span>                                       <span class="token comment">//开始循环统计推送的个数，每次循环推送的个数+1	</span>
		<span class="token keyword">do</span><span class="token punctuation">{<!-- --></span>
			temp <span class="token operator">=</span> data<span class="token punctuation">[</span>totle_len <span class="token operator">+</span> local<span class="token punctuation">]</span><span class="token punctuation">;</span>   
			temp_len <span class="token operator">+=</span> <span class="token punctuation">(</span>temp <span class="token operator">&amp;</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token operator">*</span> multiplier<span class="token punctuation">;</span>
			multiplier <span class="token operator">*=</span> <span class="token number">128</span><span class="token punctuation">;</span>
			local<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>temp <span class="token operator">&amp;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		totle_len <span class="token operator">+=</span> <span class="token punctuation">(</span>temp_len <span class="token operator">+</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//累计统计的总的推送的数据长度</span>
		re_len <span class="token operator">-=</span> <span class="token punctuation">(</span>temp_len <span class="token operator">+</span> local<span class="token punctuation">)</span> <span class="token punctuation">;</span>                    <span class="token comment">//接收的数据总长度 减去 本次统计的推送的总长度      </span>
		local <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		multiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		temp_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>re_len<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment">//如果接收的数据总长度等于0了，说明统计完毕了</span>
	<span class="token function">u1_printf</span><span class="token punctuation">(</span><span class="token string">"本次接收了%d个推送数据rn"</span><span class="token punctuation">,</span>pack_num<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//串口输出信息</span>
	temp_len <span class="token operator">=</span> totle_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                		      <span class="token comment">//各个变量清零</span>
	local <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	multiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pack_num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>			<span class="token comment">//已经统计到了接收的推送个数，开始for循环，取出每个推送的数据 </span>
	<span class="token punctuation">{<!-- --></span>                                		
		<span class="token keyword">do</span><span class="token punctuation">{<!-- --></span>
			temp <span class="token operator">=</span> data<span class="token punctuation">[</span>totle_len <span class="token operator">+</span> local<span class="token punctuation">]</span><span class="token punctuation">;</span>   
			temp_len <span class="token operator">+=</span> <span class="token punctuation">(</span>temp <span class="token operator">&amp;</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token operator">*</span> multiplier<span class="token punctuation">;</span>
			multiplier <span class="token operator">*=</span> <span class="token number">128</span><span class="token punctuation">;</span>
			local<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>temp <span class="token operator">&amp;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				
		topic_len <span class="token operator">=</span> data<span class="token punctuation">[</span>local <span class="token operator">+</span> totle_len<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">256</span> <span class="token operator">+</span> data<span class="token punctuation">[</span>local <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> totle_len<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">//计算本次推送数据中主题占用的数据量</span>
		cmd_len <span class="token operator">=</span> temp_len <span class="token operator">-</span> topic_len<span class="token punctuation">;</span>                              			   <span class="token comment">//计算本次推送数据中命令数据占用的数据量</span>
		cmd_loca <span class="token operator">=</span> totle_len <span class="token operator">+</span> local <span class="token operator">+</span>  topic_len<span class="token punctuation">;</span>                  			   <span class="token comment">//计算本次推送数据中命令数据开始的位置</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>tempbuff<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">[</span>cmd_loca<span class="token punctuation">]</span><span class="token punctuation">,</span> cmd_len<span class="token punctuation">)</span><span class="token punctuation">;</span>                   			   <span class="token comment">//命令数据拷贝出来		                 </span>
		<span class="token function">CMDBuf_Deal</span><span class="token punctuation">(</span>tempbuff<span class="token punctuation">,</span> cmd_len<span class="token punctuation">)</span><span class="token punctuation">;</span>                             			   <span class="token comment">//加入命令到缓冲区</span>
		totle_len <span class="token operator">+=</span> <span class="token punctuation">(</span>temp_len <span class="token operator">+</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span>                              			   <span class="token comment">//累计已经统计的推送的数据长度</span>
		local <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		multiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		temp_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	
<span class="token punctuation">}</span>

<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token comment">/*函数名：处理发送缓冲区                                      */</span>
<span class="token comment">/*参  数：data：数据                                         */</span>
<span class="token comment">/*参  数：size：数据长度								                      */</span>
<span class="token comment">/*返回值：无                                                 */</span>
<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">TxDataBuf_Deal</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MQTT_TxDataInPtr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//拷贝数据到发送缓冲区	</span>
	MQTT_TxDataInPtr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span>               <span class="token comment">//记录数据长度</span>
	MQTT_TxDataInPtr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span>               <span class="token comment">//记录数据长度</span>
	MQTT_TxDataInPtr <span class="token operator">+=</span> TBUFF_UNIT<span class="token punctuation">;</span>               <span class="token comment">//指针下移</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>MQTT_TxDataInPtr <span class="token operator">==</span> MQTT_TxDataEndPtr<span class="token punctuation">)</span>     <span class="token comment">//如果指针到缓冲区尾部了</span>
		MQTT_TxDataInPtr <span class="token operator">=</span> MQTT_TxDataBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">//指针归位到缓冲区开头</span>
<span class="token punctuation">}</span>

<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token comment">/*函数名：处理命令缓冲区									 */</span>
<span class="token comment">/*参  数：data：数据                                        */</span>
<span class="token comment">/*参  数：size：数据长度                                    */</span>
<span class="token comment">/*返回值：无                                                */</span>
<span class="token comment">/*----------------------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">CMDBuf_Deal</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MQTT_CMDInPtr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//拷贝数据到命令缓冲区</span>
	MQTT_CMDInPtr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span>              	  <span class="token comment">//记录数据长度</span>
	MQTT_CMDInPtr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span>                  <span class="token comment">//记录数据长度</span>
	MQTT_CMDInPtr<span class="token punctuation">[</span>size<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">''</span><span class="token punctuation">;</span>                 <span class="token comment">//加入字符串结束符</span>
	MQTT_CMDInPtr <span class="token operator">+=</span> CBUFF_UNIT<span class="token punctuation">;</span>               	  <span class="token comment">//指针下移</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>MQTT_CMDInPtr <span class="token operator">==</span> MQTT_CMDEndPtr<span class="token punctuation">)</span>           <span class="token comment">//如果指针到缓冲区尾部了</span>
		MQTT_CMDInPtr <span class="token operator">=</span> MQTT_CMDBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        	  <span class="token comment">//指针归位到缓冲区开头</span>
<span class="token punctuation">}</span>

</code></pre> 
<h1>
<a id="_1236"></a>五、进阶练习</h1> 
<p>在以上基础上可尝试以下功能：</p> 
<ul>
<li> 
  <ol><li>在裸机的环境上加入实时操作系统，如FreeRTOS</li></ol> </li>
<li> 
  <ol start="2"><li>将上传至云平台的数据存入本地数据库</li></ol> </li>
<li> 
  <ol start="3"><li>多台客户端同时连接云服务器</li></ol> </li>
<li> 
  <ol start="4"><li>开发移动APP，通过连接数据库查看实时数据并可操控stm32端，例：云服务器并通过更新数据库状态改变向客户端发送相关指令实现远端操控。</li></ol> </li>
<li> 
  <ol start="5"><li><strong>…</strong></li></ol> </li>
</ul>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>