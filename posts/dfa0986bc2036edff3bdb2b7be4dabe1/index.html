<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>如何构建一个 NodeJS 影院微服务并使用 Docker 部署 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何构建一个 NodeJS 影院微服务并使用 Docker 部署</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <p><img src="https://images2.imgbox.com/9d/06/cvViCiIg_o.gif" alt="在这里插入图片描述"></p> 
<p></p> 
<div class="toc"> 
 <h3>文章目录</h3> 
 <ul><li>
<ul>
<li><a href="#_3">前言</a></li>
<li><a href="#_19">什么是微服务？</a></li>
<li><a href="#_40">构建电影目录微服务</a></li>
<li><a href="#_50">构建微服务</a></li>
<li><a href="#_NodeJS__MongoDB__419">从 NodeJS 连接到 MongoDB 数据库</a></li>
<li><a href="#_650">总结</a></li>
</ul> 
 </li></ul> 
</div> 
<p></p> 
<h2>
<a id="_3"></a>前言</h2> 
<p>如何构建一个 NodeJS 影院微服务并使用 Docker 部署。在这个系列中，将构建一个 NodeJS 微服务，并使用 Docker Swarm 集群进行部署。</p> 
<p>以下是将要使用的工具：</p> 
<ul>
<li>NodeJS 版本7.2.0</li>
<li>MongoDB 3.4.1</li>
<li>Docker for Mac 1.12.6</li>
</ul> 
<p>在尝试本指南之前，应该具备：</p> 
<ul>
<li>NodeJS 的基本知识</li>
<li>Docker 的基本知识（并且已经安装了 Docker）</li>
<li>MongoDB 的基本知识（并且数据库服务正在运行）</li>
</ul> 
<h2>
<a id="_19"></a>什么是微服务？</h2> 
<p>微服务是一个单独的自包含单元，与其他许多单元一起构成一个大型应用程序。通过将应用程序拆分为小单元，每个部分都可以独立部署和扩展，可以由不同的团队和不同的编程语言编写，并且可以单独进行测试。</p> 
<p>微服务架构意味着应用程序由许多较小的、独立的应用程序组成，这些应用程序能够在自己的内存空间中运行，并且可以在可能的多个独立计算机上独立扩展。</p> 
<p><strong>微服务的好处：</strong></p> 
<ul>
<li>应用程序启动更快，这使得开发人员更具生产力，并加快了部署速度。</li>
<li>每个服务可以独立于其他服务部署 — 更容易频繁部署服务的新版本。</li>
<li>更容易扩展开发，也可能具有性能优势。</li>
<li>消除对技术栈的长期承诺。在开发新服务时，可以选择新的技术栈。</li>
<li>微服务通常更好组织，因为每个微服务有一个非常具体的工作，不涉及其他组件的工作。</li>
<li>解耦的服务也更容易重新组合和重新配置，以服务不同应用程序的目的（例如，同时为 Web 客户端和公共 API 提供服务）。</li>
</ul> 
<p><strong>微服务的缺点：</strong></p> 
<ul>
<li>开发人员必须处理创建分布式系统的额外复杂性。</li>
<li>部署复杂性。在生产环境中，部署和管理许多不同服务类型的系统也会带来操作复杂性。</li>
<li>在构建新的微服务架构时，可能会发现许多交叉关注点，这些交叉关注点在设计时没有预料到。</li>
</ul> 
<h2>
<a id="_40"></a>构建电影目录微服务</h2> 
<p><img src="https://images2.imgbox.com/59/53/zyOkdE35_o.png" alt=""></p> 
<p>假设正在一家电影院的 IT 部门工作，给了我们一个任务，将他们的电影票务和杂货店从单体系统重构为微服务。</p> 
<p>因此，在“构建 NodeJS 电影目录微服务”系列中，将仅关注电影目录服务。</p> 
<p>在这个架构中，可以看到有 3 种不同的设备使用该微服务，即 POS（销售点）、移动设备/平板电脑和计算机。POS 和移动设备/平板电脑都有自己的应用程序（在 electron 中开发），并直接使用微服务，而计算机则通过 Web 应用程序访问微服务（一些专家也将 Web 应用程序视为微服务）。</p> 
<h2>
<a id="_50"></a>构建微服务</h2> 
<p>现在，来模拟在最喜欢的电影院预订一场电影首映的过程。</p> 
<p>首先，想看看电影院目前正在上映哪些电影。以下图表显示了通过 REST 进行的内部通信，通过此 REST 通信，可以使用 API 来获取目前正在上映的电影。</p> 
<p><img src="https://images2.imgbox.com/92/77/yCG8YRgm_o.png" alt=""></p> 
<p>电影服务的 API 将具有以下 RAML 规范：</p> 
<pre><code class="prism language-raml">#%RAML 1.0
title: cinema
version: v1
baseUri: /

types:
  Movie:
    properties:
      id: string
      title: string
      runtime: number
      format: string
      plot: string
      releaseYear: number
      releaseMonth: number
      releaseDay: number
    example:
      id: "123"
      title: "Assasins Creed"
      runtime: 115
      format: "IMAX"
      plot: "Lorem ipsum dolor sit amet"
      releaseYear : 2017
      releaseMonth: 1
      releaseDay: 6

  MoviePremieres:
    type: Movie []


resourceTypes:
  Collection:
    get:
      responses:
        200:
          body:
            application/json:
              type: &lt;&lt;item&gt;&gt;

/movies:
  /premieres:
    type:  { Collection: {item : MoviePremieres } }

  /{id}:
    type:  { Collection: {item : Movie } }
</code></pre> 
<p>如果不了解 RAML，可以查看这个很好的教程。</p> 
<p>API 项目的结构将如下所示：</p> 
<ul>
<li>api/ # 我们的API</li>
<li>config/ # 应用程序配置</li>
<li>mock/ # 不是必需的，仅用于数据示例</li>
<li>repository/ # 抽象出数据库</li>
<li>server/ # 服务器设置代码</li>
<li>package.json # 依赖项</li>
<li>index.js # 应用程序的主入口</li>
</ul> 
<p>首先要看的部分是 repository。这是对数据库进行查询的地方。</p> 
<pre><code class="prism language-js">
<span class="token string">'use strict'</span>
<span class="token comment">// factory function, that holds an open connection to the db,</span>
<span class="token comment">// and exposes some functions for accessing the data.</span>
<span class="token keyword">const</span> <span class="token function-variable function">repository</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  
  <span class="token comment">// since this is the movies-service, we already know</span>
  <span class="token comment">// that we are going to query the `movies` collection</span>
  <span class="token comment">// in all of our functions.</span>
  <span class="token keyword">const</span> collection <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">getMoviePremiers</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> movies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">const</span> currentDay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">releaseYear</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">$gt</span><span class="token operator">:</span> currentDay<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token literal-property property">$lte</span><span class="token operator">:</span> currentDay<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">releaseMonth</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">$gte</span><span class="token operator">:</span> currentDay<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token literal-property property">$lte</span><span class="token operator">:</span> currentDay<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">releaseDay</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">$lte</span><span class="token operator">:</span> currentDay<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> cursor <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
      <span class="token keyword">const</span> <span class="token function-variable function">addMovie</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">movie</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        movies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>movie<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> <span class="token function-variable function">sendMovies</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'An error occured fetching all movies, err:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>movies<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      cursor<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>addMovie<span class="token punctuation">,</span> sendMovies<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token function-variable function">getMovieById</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> projection <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
      <span class="token keyword">const</span> <span class="token function-variable function">sendMovie</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> movie</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">An error occured fetching a movie with id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, err: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>movie<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// fetch a movie by id -- mongodb syntax</span>
      collection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">id</span><span class="token operator">:</span> id<span class="token punctuation">}</span><span class="token punctuation">,</span> projection<span class="token punctuation">,</span> sendMovie<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// this will close the database connection</span>
  <span class="token keyword">const</span> <span class="token function-variable function">disconnect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    db<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    getAllMovies<span class="token punctuation">,</span>
    getMoviePremiers<span class="token punctuation">,</span>
    getMovieById<span class="token punctuation">,</span>
    disconnect
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">connect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">connection</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'connection db not supplied!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">repository</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// this only exports a connected repo</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>connect<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>可能已经注意到，向 repository 的 connect ( connection ) 方法提供了一个 <code>connection</code> 对象。在这里，使用了 JavaScript 的一个重要特性“闭包”，repository 对象返回了一个闭包，其中的每个函数都可以访问 <code>db</code> 对象和 <code>collection</code> 对象，<code>db</code> 对象保存着数据库连接。在这里，抽象了连接的数据库类型，repository 对象不知道数据库是什么类型的，对于这种情况来说，是一个 MongoDB 连接。甚至不需要知道是单个数据库还是复制集连接。虽然使用了 MongoDB 语法，但可以通过应用 SOLID 原则中的依赖反转原则，将存储库功能抽象得更深，将 MongoDB 语法转移到另一个文件中，并只调用数据库操作的接口（例如，使用 mongoose 模型）。</p> 
<p>有一个 <code>repository/repository.spec.js</code> 文件来测试这个模块，稍后在文章中会谈到测试。</p> 
<p>接下来要看的是 <code>server.js</code> 文件。</p> 
<pre><code class="prism language-js"><span class="token string">'use strict'</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> helmet <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'helmet'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> movieAPI <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../api/movies'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">start</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// we need to verify if we have a repository added and a server port</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>repo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'The server must be started with a connected repository'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>port<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'The server must be started with an available port'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// let's init a express app, and add some middlewares</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">helmet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Something went wrong!, err:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Something went wrong!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment">// we add our API's to the express app</span>
    <span class="token function">movieAPI</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    
    <span class="token comment">// finally we start the server, and return the newly created server </span>
    <span class="token keyword">const</span> server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>start<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>在这里，创建了一个新的 express 应用程序，验证是否提供了 repository 和 server port 对象，然后为 express 应用程序应用一些中间件，例如用于日志记录的 <code>morgan</code>，用于安全性的 <code>helmet</code>，以及一个错误处理函数，最后导出一个 start 函数来启动服务器。</p> 
<blockquote> 
 <p>Helmet 包含了整整 11 个软件包，它们都用于阻止恶意方破坏或使用应用程序来伤害其用户。</p> 
</blockquote> 
<p>好的，现在既然服务器使用了电影的 API，继续查看 movies.js 文件。</p> 
<pre><code class="prism language-js"><span class="token string">'use strict'</span>
<span class="token keyword">const</span> status <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http-status'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>repo<span class="token punctuation">}</span> <span class="token operator">=</span> options
  
  <span class="token comment">// here we get all the movies </span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/movies'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    repo<span class="token punctuation">.</span><span class="token function">getAllMovies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">movies</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>movies<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token comment">// here we retrieve only the premieres</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/movies/premieres'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    repo<span class="token punctuation">.</span><span class="token function">getMoviePremiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">movies</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>movies<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token comment">// here we get a movie by id</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/movies/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    repo<span class="token punctuation">.</span><span class="token function">getMovieById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">movie</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>movie<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这里，为API创建了路由，并根据监听的路由调用了 repo 函数。repo 在这里使用了接口技术方法，在这里使用了著名的“为接口编码而不是为实现编码”，因为 express 路由不知道是否有一个数据库对象、数据库查询逻辑等，它只调用处理所有数据库问题的 repo 函数。</p> 
<p>所有文件都有与源代码相邻的单元测试，看看 <code>movies.js</code> 的测试是如何进行的。</p> 
<p>可以将测试看作是对正在构建的应用程序的安全保障。不仅会在本地机器上运行，还会在 CI 服务上运行，以确保失败的构建不会被推送到生产系统。</p> 
<p>为了编写单元测试，必须对所有依赖项进行存根，即为模块提供虚拟依赖项。看看 <code>spec</code> 文件。</p> 
<pre><code class="prism language-js"><span class="token comment">/* eslint-env mocha */</span>
<span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'supertest'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../server/server'</span><span class="token punctuation">)</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Movies API'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">let</span> testMovies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">'id'</span><span class="token operator">:</span> <span class="token string">'3'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'title'</span><span class="token operator">:</span> <span class="token string">'xXx: Reactivado'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'format'</span><span class="token operator">:</span> <span class="token string">'IMAX'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'releaseYear'</span><span class="token operator">:</span> <span class="token number">2017</span><span class="token punctuation">,</span>
    <span class="token string-property property">'releaseMonth'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">'releaseDay'</span><span class="token operator">:</span> <span class="token number">20</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">'id'</span><span class="token operator">:</span> <span class="token string">'4'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'title'</span><span class="token operator">:</span> <span class="token string">'Resident Evil: Capitulo Final'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'format'</span><span class="token operator">:</span> <span class="token string">'IMAX'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'releaseYear'</span><span class="token operator">:</span> <span class="token number">2017</span><span class="token punctuation">,</span>
    <span class="token string-property property">'releaseMonth'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">'releaseDay'</span><span class="token operator">:</span> <span class="token number">27</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">'id'</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'title'</span><span class="token operator">:</span> <span class="token string">'Assasins Creed'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'format'</span><span class="token operator">:</span> <span class="token string">'IMAX'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'releaseYear'</span><span class="token operator">:</span> <span class="token number">2017</span><span class="token punctuation">,</span>
    <span class="token string-property property">'releaseMonth'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">'releaseDay'</span><span class="token operator">:</span> <span class="token number">6</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>

  <span class="token keyword">let</span> testRepo <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">getAllMovies</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>testMovies<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">getMoviePremiers</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>testMovies<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">movie</span> <span class="token operator">=&gt;</span> movie<span class="token punctuation">.</span>releaseYear <span class="token operator">===</span> <span class="token number">2017</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">getMovieById</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>testMovies<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">movie</span> <span class="token operator">=&gt;</span> movie<span class="token punctuation">.</span>id <span class="token operator">===</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
      <span class="token literal-property property">repo</span><span class="token operator">:</span> testRepo
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">serv</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      app <span class="token operator">=</span> serv
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    app<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    app <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'can return all movies'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/movies'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>should<span class="token punctuation">.</span><span class="token function">containEql</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">'id'</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
          <span class="token string-property property">'title'</span><span class="token operator">:</span> <span class="token string">'Assasins Creed'</span><span class="token punctuation">,</span>
          <span class="token string-property property">'format'</span><span class="token operator">:</span> <span class="token string">'IMAX'</span><span class="token punctuation">,</span>
          <span class="token string-property property">'releaseYear'</span><span class="token operator">:</span> <span class="token number">2017</span><span class="token punctuation">,</span>
          <span class="token string-property property">'releaseMonth'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token string-property property">'releaseDay'</span><span class="token operator">:</span> <span class="token number">6</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> done<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'can get movie premiers'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/movies/premiers'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>should<span class="token punctuation">.</span><span class="token function">containEql</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">'id'</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'title'</span><span class="token operator">:</span> <span class="token string">'Assasins Creed'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'format'</span><span class="token operator">:</span> <span class="token string">'IMAX'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'releaseYear'</span><span class="token operator">:</span> <span class="token number">2017</span><span class="token punctuation">,</span>
        <span class="token string-property property">'releaseMonth'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string-property property">'releaseDay'</span><span class="token operator">:</span> <span class="token number">6</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> done<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'returns 200 for an known movie'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/movies/1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>should<span class="token punctuation">.</span><span class="token function">containEql</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">'id'</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
          <span class="token string-property property">'title'</span><span class="token operator">:</span> <span class="token string">'Assasins Creed'</span><span class="token punctuation">,</span>
          <span class="token string-property property">'format'</span><span class="token operator">:</span> <span class="token string">'IMAX'</span><span class="token punctuation">,</span>
          <span class="token string-property property">'releaseYear'</span><span class="token operator">:</span> <span class="token number">2017</span><span class="token punctuation">,</span>
          <span class="token string-property property">'releaseMonth'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token string-property property">'releaseDay'</span><span class="token operator">:</span> <span class="token number">6</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> done<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-js"><span class="token comment">/* eslint-env mocha */</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./server'</span><span class="token punctuation">)</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Server'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should require a port to start'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">repo</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>should<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">rejectedWith</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">port</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should require a repository to start'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>should<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">rejectedWith</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">repository</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>可以看到，为 movies API 存根了依赖项，并验证了需要提供一个 server port 和一个 repository 对象。</p> 
<p>继续看一下如何创建传递给 repository 模块的 db 连接对象，现在定义说每个微服务都必须有自己的数据库，但是对于示例，将使用一个 MongoDB 复制集服务器，但每个微服务都有自己的数据库。</p> 
<h2>
<a id="_NodeJS__MongoDB__419"></a>从 NodeJS 连接到 MongoDB 数据库</h2> 
<p>以下是需要从 NodeJS 连接到 MongoDB 数据库的配置。</p> 
<pre><code class="prism language-js"><span class="token keyword">const</span> MongoClient <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongodb'</span><span class="token punctuation">)</span>

<span class="token comment">// here we create the url connection string that the driver needs</span>
<span class="token keyword">const</span> <span class="token function-variable function">getMongoURL</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> options<span class="token punctuation">.</span>servers
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> prev <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>cur<span class="token punctuation">.</span>ip<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>cur<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'mongodb://'</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>url<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>options<span class="token punctuation">.</span>db<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

<span class="token comment">// mongoDB function to connect, open and authenticate</span>
<span class="token keyword">const</span> <span class="token function-variable function">connect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> mediator</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  mediator<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'boot.ready'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    MongoClient<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span> <span class="token function">getMongoURL</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">db</span><span class="token operator">:</span> options<span class="token punctuation">.</span><span class="token function">dbParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">server</span><span class="token operator">:</span> options<span class="token punctuation">.</span><span class="token function">serverParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">replset</span><span class="token operator">:</span> options<span class="token punctuation">.</span><span class="token function">replsetParameters</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>repl<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> db</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          mediator<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'db.error'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        db<span class="token punctuation">.</span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>user<span class="token punctuation">,</span> options<span class="token punctuation">.</span>pass<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mediator<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'db.error'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          mediator<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'db.ready'</span><span class="token punctuation">,</span> db<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>connect<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里可能有更好的方法，但基本上可以这样创建与 MongoDB 的复制集连接。</p> 
<p>传递了一个 options 对象，其中包含 Mongo 连接所需的所有参数，并且传递了一个事件 — 中介者对象，当通过认证过程时，它将发出 db 对象。</p> 
<blockquote> 
 <p><strong>注意</strong> 在这里，使用了一个事件发射器对象，因为使用 promise 的方法在某种程度上并没有在通过认证后返回 db 对象，顺序变得空闲。所以这可能是一个很好的挑战，看看发生了什么，并尝试使用 promise 的方法。</p> 
</blockquote> 
<p>现在，既然正在传递一个 options 对象来进行参数设置，让我们看看这是从哪里来的，因此要查看的下一个文件是 config.js。</p> 
<pre><code class="prism language-js"><span class="token comment">// simple configuration file</span>

<span class="token comment">// database parameters</span>
<span class="token keyword">const</span> dbSettings <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">db</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB</span> <span class="token operator">||</span> <span class="token string">'movies'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_USER</span> <span class="token operator">||</span> <span class="token string">'cristian'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pass</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_PASS</span> <span class="token operator">||</span> <span class="token string">'cristianPassword2017'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">repl</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_REPLS</span> <span class="token operator">||</span> <span class="token string">'rs1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">servers</span><span class="token operator">:</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_SERVERS</span><span class="token punctuation">)</span> <span class="token operator">?</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_SERVERS</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'192.168.99.100:27017'</span><span class="token punctuation">,</span>
    <span class="token string">'192.168.99.101:27017'</span><span class="token punctuation">,</span>
    <span class="token string">'192.168.99.102:27017'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">dbParameters</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">w</span><span class="token operator">:</span> <span class="token string">'majority'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">wtimeout</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
    <span class="token literal-property property">j</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">readPreference</span><span class="token operator">:</span> <span class="token string">'ReadPreference.SECONDARY_PREFERRED'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">native_parser</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">serverParameters</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">autoReconnect</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">poolSize</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token literal-property property">socketoptions</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">keepAlive</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
      <span class="token literal-property property">connectTimeoutMS</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
      <span class="token literal-property property">socketTimeoutMS</span><span class="token operator">:</span> <span class="token number">30000</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">replsetParameters</span><span class="token operator">:</span> <span class="token punctuation">(</span>replset <span class="token operator">=</span> <span class="token string">'rs1'</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">replicaSet</span><span class="token operator">:</span> replset<span class="token punctuation">,</span>
    <span class="token literal-property property">ha</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">haInterval</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
    <span class="token literal-property property">poolSize</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token literal-property property">socketoptions</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">keepAlive</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
      <span class="token literal-property property">connectTimeoutMS</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
      <span class="token literal-property property">socketTimeoutMS</span><span class="token operator">:</span> <span class="token number">30000</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// server parameters</span>
<span class="token keyword">const</span> serverSettings <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> dbSettings<span class="token punctuation">,</span> serverSettings <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>这是配置文件，大部分配置代码都是硬编码的，但正如看到的，一些属性使用环境变量作为选项。环境变量被视为最佳实践，因为这可以隐藏数据库凭据、服务器参数等。</p> 
<p>最后，对于构建电影服务 API 的最后一步是使用 index.js 将所有内容组合在一起。</p> 
<pre><code class="prism language-js"><span class="token string">'use strict'</span>
<span class="token comment">// we load all the depencies we need</span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>EventEmitter<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./server/server'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> repository <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./repository/repository'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config/'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mediator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// verbose logging when we are starting the server</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--- Movies Service ---'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Connecting to movies repository...'</span><span class="token punctuation">)</span>

<span class="token comment">// log unhandled execpetions</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'uncaughtException'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Unhandled Exception'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'uncaughtRejection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> promise</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Unhandled Rejection'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// event listener when the repository has been connected</span>
mediator<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'db.ready'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> rep
  repository<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">repo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Repository Connected. Starting Server'</span><span class="token punctuation">)</span>
      rep <span class="token operator">=</span> repo
      <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">port</span><span class="token operator">:</span> config<span class="token punctuation">.</span>serverSettings<span class="token punctuation">.</span>port<span class="token punctuation">,</span>
        repo
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server started succesfully, running on port: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>config<span class="token punctuation">.</span>serverSettings<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        rep<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
mediator<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'db.error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// we load the connection to the repository</span>
config<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>dbSettings<span class="token punctuation">,</span> mediator<span class="token punctuation">)</span>
<span class="token comment">// init the repository connection, and the event listener will handle the rest</span>
mediator<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'boot.ready'</span><span class="token punctuation">)</span>
</code></pre> 
<p>在这里，组合了所有的电影 API 服务，添加了一些错误处理，然后加载配置、启动存储库，并最后启动服务器。</p> 
<p>因此，到目前为止，已经完成了与 API 开发相关的所有内容。</p> 
<p>下面是项目中需要用到的初始化以及运行命令：</p> 
<ul>
<li>npm install # 设置Node依赖项</li>
<li>npm test # 使用mocha进行单元测试</li>
<li>npm start # 启动服务</li>
<li>npm run node-debug # 以调试模式运行服务器</li>
<li>npm run chrome-debug # 使用chrome调试Node</li>
<li>npm run lint # 使用standard进行代码lint</li>
</ul> 
<p>最后，第一个微服务已经在本地运行，并通过执行 npm start 命令启动。</p> 
<p>现在是时候将其放入 Docker 容器中。</p> 
<p>首先，需要使用“使用 Docker 部署 MongoDB 复制集”的文章中的 Docker 环境，如果没有，则需要进行一些额外的修改步骤，以便为微服务设置数据库，以下是一些命令，进行测试电影服务。</p> 
<p>首先创建 Dockerfile，将 NodeJS 微服务制作成 Docker 容器。</p> 
<pre><code class="prism language-docker"># Node v7作为基本映像以支持ES6
FROM node:7.2.0
# 为新容器创建一个新用户，并避免root用户
RUN useradd --user-group --create-home --shell /bin/false nupp &amp;&amp; 
    apt-get clean
ENV HOME=/home/nupp
COPY package.json npm-shrinkwrap.json $HOME/app/
COPY src/ $HOME/app/src
RUN chown -R nupp:nupp $HOME/* /usr/local/
WORKDIR $HOME/app
RUN npm cache clean &amp;&amp; 
    npm install --silent --progress=false --production
RUN chown -R nupp:nupp $HOME/*
USER nupp
EXPOSE 3000
CMD ["npm", "start"]
</code></pre> 
<p>使用 NodeJS 镜像作为 Docker 镜像的基础，然后为镜像创建一个用户以避免非 root 用户，接下来，将 src 复制到镜像中，然后安装依赖项，暴露一个端口号，并最后实例化电影服务。</p> 
<p>接下来，需要构建 Docker 镜像，使用以下命令：</p> 
<pre><code>$ docker build -t movies-service .
</code></pre> 
<p>首先看一下构建命令。</p> 
<ul>
<li>
<code>docker build</code> 告诉引擎要创建一个新的镜像。</li>
<li>
<code>-t movies-service</code> 用标记 <code>movies-service</code> 标记此镜像。从现在开始，可以根据标记引用此镜像。</li>
<li>.：使用当前目录来查找 <code>Dockerfile</code>。</li>
</ul> 
<p>经过一些控制台输出后，新镜像中就有了 NodeJS 应用程序，所以现在需要做的就是使用以下命令运行镜像：</p> 
<pre><code>$ docker run --name movie-service -p 3000:3000 -e DB_SERVERS="192.168.99.100:27017 192.168.99.101:27017 192.168.99.100:27017" -d movies-service
</code></pre> 
<p>在上面的命令中，传递了一个环境变量，它是一个服务器数组，需要连接到 MongoDB 复制集的服务器，这只是为了说明，有更好的方法可以做到这一点，比如读取一个环境变量文件。</p> 
<p>现在，容器已经运行起来了，获取 <code>docker-machine</code> IP地址，以获取微服务的 IP 地址，现在准备对微服务进行一次集成测试，另一个测试选项可以是JMeter，它是一个很好的工具，可以模拟HTTP请求。</p> 
<p>这是集成测试，将检查一个 API 调用。</p> 
<pre><code class="prism language-js"><span class="token comment">/* eslint-env mocha */</span>
<span class="token keyword">const</span> supertest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'supertest'</span><span class="token punctuation">)</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'movies-service'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">supertest</span><span class="token punctuation">(</span><span class="token string">'http://192.168.99.100:3000'</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'returns a 200 for a collection of movies'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>

    api<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/movies/premiers'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> done<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="_650"></a>总结</h2> 
<p>创建了用于查询电影院正在上映的电影的 movies 服务，使用 RAML 规范设计了 API，然后开始构建 API，并进行了相应的单元测试，最后，组合了所有内容，使微服务完整，并能够启动 movies 服务服务器。</p> 
<p>然后，将微服务放入 Docker 容器中，以进行一些集成测试。</p> 
<p>微服务架构可以为大型应用程序带来许多好处，但也需要小心管理和设计，以处理分布式系统的复杂性和其他挑战。使用 Docker 容器可以简化微服务的部署和管理，使其更加灵活和可扩展。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>