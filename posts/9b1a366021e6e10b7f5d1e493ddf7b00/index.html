<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Python 大白从零开始 OpenCV 学习课-6. 灰度变换与直方图处理 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python 大白从零开始 OpenCV 学习课-6. 灰度变换与直方图处理</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <h1>
<a id="_OpenCV_6__0"></a>从零开始 OpenCV 学习课-6. 灰度变换与直方图处理</h1> 
<p>本系列面向 Python 小白，从零开始实战解说 OpenCV 项目实战。</p> 
<p>空间域的图像处理方法直接对图像的像素点进行处理，空间域图像处理技术主要是灰度变换和空间滤波。</p> 
<p>本节介绍图像的灰度变化与直方图处理，提供完整例程和运行结果：二值处理，反色变换，线性变换，分段线性变换，对比度拉伸，灰度级分层，非线性变换，直方图处理，直方图均衡化，直方图匹配，局部直方图处理，统计量增强，反向投影。</p> 
<hr> 
<p></p>
<div class="toc">
 <h3>文章目录</h3>
 <ul>
<li><a href="#_OpenCV_6__0">从零开始 OpenCV 学习课-6. 灰度变换与直方图处理</a></li>
<li>
<ul>
<li><a href="#1__14">1. 图像增强技术</a></li>
<li><a href="#2__28">2. 图像的灰度化处理和二值化处理</a></li>
<li>
<ul><li><a href="#147__85">例程：1.47 图像的二值变换（固定阈值）</a></li></ul>
   </li>
<li><a href="#3__115">3. 图像的灰度变换</a></li>
<li>
<ul>
<li><a href="#31__125">3.1 反色变换（图像反转）</a></li>
<li><a href="#148__134">例程：1.48 图像的反色变换</a></li>
<li><a href="#32__159">3.2 线性灰度变换</a></li>
<li><a href="#149__186">例程：1.49 图像的线性灰度变换</a></li>
<li><a href="#33__230">3.3 分段线性灰度变换</a></li>
<li><a href="#150__249">例程：1.50 分段线性灰度变换（对比度拉伸）</a></li>
<li><a href="#153__301">例程：1.53 分段线性灰度变换（灰度级分层）</a></li>
<li><a href="#154__352">例程：1.54 分段线性灰度变换（比特平面分层）</a></li>
<li><a href="#34__388">3.4 非线性灰度变换：对数变换和指数变换</a></li>
<li><a href="#155__400">例程：1.55 图像的对数变换</a></li>
<li><a href="#35__426">3.5 非线性灰度变换：幂律变换（伽马变换）</a></li>
<li><a href="#156__439">例程：1.56 图像的幂律变换</a></li>
</ul>
   </li>
<li><a href="#4__466">4. 图像的直方图处理</a></li>
<li>
<ul>
<li><a href="#41__468">4.1 灰度直方图</a></li>
<li><a href="#157__504">例程：1.57 图像的灰度直方图</a></li>
<li><a href="#42__527">4.2 直方图均衡化</a></li>
<li><a href="#158__572">例程：1.58 直方图均衡</a></li>
<li><a href="#43__605">4.3 直方图匹配</a></li>
<li><a href="#159__625">例程：1.59 灰度图像直方图匹配</a></li>
<li><a href="#160__676">例程：1.60 彩色图像直方图匹配</a></li>
<li><a href="#44__718">4.4 局部直方图处理</a></li>
<li><a href="#161__749">基本例程：1.61 自适应的局部直方图均衡</a></li>
<li><a href="#45__775">4.5 直方图统计量图像增强</a></li>
<li><a href="#161__794">基本例程：1.61 直方图统计量图像增强</a></li>
<li><a href="#46__822">4.6 直方图反向投影（反向追踪）</a></li>
<li><a href="#164__852">基本例程：1.64 直方图反向投影追踪</a></li>
</ul>
  </li>
</ul>
 </li>
</ul>
</div>
<p></p> 
<br> 
<h2>
<a id="1__14"></a>1. 图像增强技术</h2> 
<p>图像增强（Image Enhancement）的方法主要有空间域变换、频率域变换和伪彩色处理。</p> 
<ul>
<li>空间域变换：空间域是指图像平面，空间域的图像处理方法直接对图像的像素点进行处理。空间域图像处理技术主要是灰度变换和空间滤波。</li>
<li>频率域变换： 通过傅立叶变换，在频率域进行处理，然后再转换回空间域。</li>
<li>伪彩色处理：把灰度图像映射到彩色空间，常用于遥感图像、医学影像处理。</li>
</ul> 
<p><img src="https://images2.imgbox.com/46/62/OLPPMc5m_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<br> 
<h2>
<a id="2__28"></a>2. 图像的灰度化处理和二值化处理</h2> 
<p>按照颜色对图像进行分类，可以分为二值图像、灰度图像和彩色图像。</p> 
<ul>
<li>二值图像：只有黑色和白色两种颜色的图像。每个像素点可以用 0/1 表示，0 表示黑色，1 表示白色。</li>
<li>灰度图像：只有灰度的图像。每个像素点用 8bit 数字 [0,255] 表示灰度，如：0 表示纯黑，255 表示纯白。</li>
<li>彩色图像：彩色图像通常采用红色（R）、绿色（G）和蓝色（B）三个色彩通道的组合表示。</li>
</ul> 
<p>OpenCV 中彩色图像使用 BGR 格式。彩色图像进行灰度化处理，可以在读取图像文件时直接读取为灰度图像，也可以通过颜色空间转换函数 <strong>cv2.cvtColor</strong> 将彩色图像转换为灰度图像。</p> 
<p>灰度化处理相关函数和例程介绍，详见 [OpenCV 学习课-2.图像读取与显示]。</p> 
<pre><code class="prism language-python"><span class="token comment"># 1.1 图像的读取</span>
    imgFile <span class="token operator">=</span> <span class="token string">"../images/imgLena.tif"</span>  <span class="token comment"># 读取文件的路径</span>
    img1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>imgFile<span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># flags=1 读取彩色图像(BGR)</span>
    img2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>imgFile<span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># flags=0 读取为灰度图像</span>

<span class="token comment"># 1.10 图像显示(plt.imshow)</span>
    imgRGB <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>  <span class="token comment"># 图片格式转换：BGR(OpenCV) -&gt; RGB(PyQt5)</span>
    imGray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>  <span class="token comment"># 图片格式转换：BGR(OpenCV) -&gt; Gray    </span>
</code></pre> 
<p>进一步地，通过函数 <strong>cv2.threshold</strong> 可以对图像进行二值化处理。</p> 
<p><strong>函数说明：</strong></p> 
<pre><code>cv2.threshold(src, thresh, maxval, type[, dst]) → retval, dst
</code></pre> 
<p>函数 threshold() 可以将灰度图像转换为二值图像，图像完全由像素 0 和 255 构成，呈现出只有黑白两色的视觉效果。</p> 
<p>灰度阈值化通过选取的灰度阈值 thresh，将每个像素的灰度值与阈值进行比较，将灰度大于阈值的像素点置为最大灰度，小于阈值的像素点置为最小灰度，得到二值图像，可以突出图像轮廓，把目标从背景中分割出来。</p> 
<p><strong>参数说明：</strong></p> 
<ul>
<li>scr：变换操作的输入图像，nparray 二维数组，<strong>必须是单通道灰度图像！</strong>
</li>
<li>thresh：阈值，取值范围 0~255</li>
<li>maxval：填充色，取值范围 0～255，一般取 255</li>
<li>type：变换类型 
  <ul>
<li>cv2.THRESH_BINARY：大于阈值时置 255，否则置 0</li>
<li>cv2.THRESH_BINARY_INV：大于阈值时置 0，否则置 255</li>
<li>cv2.THRESH_TRUNC：大于阈值时置为阈值 thresh，否则不变（保持原色）</li>
<li>cv2.THRESH_TOZERO：大于阈值时不变（保持原色），否则置 0</li>
<li>cv2.THRESH_TOZERO_INV：大于阈值时置 0，否则不变（保持原色）</li>
<li>cv2.THRESH_OTSU：使用 OTSU 算法选择阈值</li>
</ul> </li>
<li>返回值 retval：返回二值化的阈值</li>
<li>返回值 dst：返回阈值变换的输出图像</li>
</ul> 
<p><strong>注意：</strong></p> 
<ul>
<li> 
  <ol><li>函数 <strong>cv2.threshold</strong> 进行固定阈值的二值化处理；函数 <strong>cv2.adaptiveThreshold</strong> 为自适应阈值的二值化处理函数，可以通过比较像素点与周围像素点的关系动态调整阈值。</li></ol> </li>
<li> 
  <ol start="2"><li>确切地说，只有 type 为 cv2.THRESH_BINARY 或 cv2.THRESH_BINARY_INV 时输出为二值图像，其它变换类型时进行阈值处理但并不是二值处理。</li></ol> </li>
</ul> 
<br> 
<h3>
<a id="147__85"></a>例程：1.47 图像的二值变换（固定阈值）</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.47 固定阈值二值变换</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/imgLena.tif"</span><span class="token punctuation">)</span>  <span class="token comment"># 读取彩色图像(BGR)</span>
    imgGray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/imgLena.tif"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># flags=0 读取为灰度图像</span>
    <span class="token comment"># imgGray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)  # 颜色转换：BGR(OpenCV) -&gt; Gray</span>

    <span class="token comment"># cv2.threshold(src, thresh, maxval, type[, dst]) → retval, dst</span>
    ret1<span class="token punctuation">,</span> img1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>imgGray<span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_BINARY<span class="token punctuation">)</span>  <span class="token comment"># 转换为二值图像, thresh=63</span>
    ret2<span class="token punctuation">,</span> img2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>imgGray<span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_BINARY<span class="token punctuation">)</span>  <span class="token comment"># 转换为二值图像, thresh=127</span>
    ret3<span class="token punctuation">,</span> img3 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>imgGray<span class="token punctuation">,</span> <span class="token number">191</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_BINARY<span class="token punctuation">)</span>  <span class="token comment"># 转换为二值图像, thresh=191</span>
    ret4<span class="token punctuation">,</span> img4 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>imgGray<span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_BINARY_INV<span class="token punctuation">)</span>  <span class="token comment"># 逆二值图像，BINARY_INV</span>
    ret5<span class="token punctuation">,</span> img5 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>imgGray<span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_TRUNC<span class="token punctuation">)</span>  <span class="token comment"># TRUNC 阈值处理，THRESH_TRUNC</span>
    ret6<span class="token punctuation">,</span> img6 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>imgGray<span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_TOZERO<span class="token punctuation">)</span>  <span class="token comment"># TOZERO 阈值处理，THRESH_TOZERO</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    titleList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"1. BINARY(thresh=63)"</span><span class="token punctuation">,</span> <span class="token string">"2. BINARY(thresh=127)"</span><span class="token punctuation">,</span> <span class="token string">"3. BINARY(thresh=191)"</span><span class="token punctuation">,</span> <span class="token string">"4. THRESH_BINARY_INV"</span><span class="token punctuation">,</span> <span class="token string">"5. THRESH_TRUNC"</span><span class="token punctuation">,</span> <span class="token string">"6. THRESH_TOZERO"</span><span class="token punctuation">]</span>
    imageList <span class="token operator">=</span> <span class="token punctuation">[</span>img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> img3<span class="token punctuation">,</span> img4<span class="token punctuation">,</span> img5<span class="token punctuation">,</span> img6<span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span>titleList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imageList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'gray'</span><span class="token punctuation">)</span>  <span class="token comment"># 灰度图像 ndim=2</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/43/54/XZg4Jysh_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<br> 
<h2>
<a id="3__115"></a>3. 图像的灰度变换</h2> 
<p>灰度变换是图像增强的重要方法，可以使图像动态范围扩大、图像对比度增强，图像更清晰，特征更明显，从而改善图像的显示效果。</p> 
<p>灰度变换就是按一定规则（灰度映射函数）修改图像每一个像素的灰度值，从而改变图像灰度的动态范围。按照灰度映射函数的性质，灰度变换可以分为线性变换、分段线性和非线性变换，非线性变换中对数变换、指数变换和幂律变换（n次幂、n次根）最为常用。常见的灰度变换函数的形状如下图所示。</p> 
<p><img src="https://images2.imgbox.com/44/b4/T29zexsY_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="31__125"></a>3.1 反色变换（图像反转）</h3> 
<p>图像的反色变换，即图像反转，将黑色像素点变白色，白色像素点变黑色。广义的反色变换也可以应用于彩色图像，即对所有像素点取补。</p> 
<p>图像的反转处理可以增强暗色区域中的白色或灰色细节。</p> 
<p>注意图像反转（Invert）与图像翻转（Flip）的区别：图像翻转是沿对称轴的几何变换，像素值不变；图像反转是像素颜色的逆转，像素位置不变。</p> 
<h3>
<a id="148__134"></a>例程：1.48 图像的反色变换</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.48 图像的反色变换</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/imgLena.tif"</span><span class="token punctuation">)</span>  <span class="token comment"># 读取彩色图像(BGR)</span>
    imgGray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>  <span class="token comment"># 颜色转换：BGR(OpenCV) -&gt; Gray</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># 图片的高度和宽度</span>

    <span class="token comment"># imgInv = np.zeros_like(img)  # 创建与 img 相同形状的黑色图像</span>
    imgInv <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  <span class="token comment"># 创建空白数组</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">:</span>
            imgInv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span> <span class="token operator">-</span> imgGray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">131</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"imgBGR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">132</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgGray<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"imgGray"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">133</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgInv<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"imgInv"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5d/63/CoKKERgr_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="32__159"></a>3.2 线性灰度变换</h3> 
<p>线性灰度变换将原始图像灰度值的动态范围按线性关系扩展到指定范围或整个动态范围。</p> 
<p>线性灰度变化对图像的每一个像素作线性拉伸，可以凸显图像的细节，提高图像的对比度。</p> 
<p>线性灰度变换可以由以下公式描述 ：<br> <span class="katex--display">KaTeX parse error: No such environment: align at position 8: begin{̲a̲l̲i̲g̲n̲}̲ Dt &amp;= frac{d-…</span><br> 式中，D 为原始图像的灰度值，Dt 为线性灰度变换后的图像灰度值。</p> 
<ul>
<li>当 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         α
        
        
         =
        
        
         1
        
        
         ，
        
        
         β
        
        
         =
        
        
         0
        
       
       
        alpha = 1，beta = 0
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.88888em;vertical-align: -0.19444em"></span><span class="mord">1</span><span class="mord cjk_fallback">，</span><span class="mord mathdefault" style="margin-right: 0.05278em">β</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">0</span></span></span></span></span> 时，保持原始图像不变</li>
<li>当 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         α
        
        
         =
        
        
         1
        
        
         ，
        
        
         β
        
        
         &gt;
        
        
         0
        
       
       
        alpha = 1，beta &gt; 0
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.88888em;vertical-align: -0.19444em"></span><span class="mord">1</span><span class="mord cjk_fallback">，</span><span class="mord mathdefault" style="margin-right: 0.05278em">β</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">0</span></span></span></span></span> 时，图像的灰度值上移，灰度图像颜色发白（彩色图像颜色发亮）</li>
<li>当 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         α
        
        
         =
        
        
         1
        
        
         ，
        
        
         β
        
        
         &lt;
        
        
         0
        
       
       
        alpha = 1，beta &lt; 0
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.88888em;vertical-align: -0.19444em"></span><span class="mord">1</span><span class="mord cjk_fallback">，</span><span class="mord mathdefault" style="margin-right: 0.05278em">β</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">0</span></span></span></span></span> 时，图像的灰度值下移，灰度图像颜色发黑（彩色图像颜色发暗）</li>
<li>当 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         α
        
        
         &gt;
        
        
         1
        
       
       
        alpha&gt;1
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em;vertical-align: -0.0391em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">1</span></span></span></span></span> 时，图像的对比度增强</li>
<li>当 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         0
        
        
         &lt;
        
        
         α
        
        
         &lt;
        
        
         1
        
       
       
        0 &lt; alpha &lt; 1
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68354em;vertical-align: -0.0391em"></span><span class="mord">0</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.5782em;vertical-align: -0.0391em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">1</span></span></span></span></span> 时，图像的对比度减小</li>
<li>当 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         α
        
        
         &lt;
        
        
         0
        
        
         ，
        
        
         β
        
        
         =
        
        
         255
        
       
       
        alpha &lt; 0，beta=255
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em;vertical-align: -0.0391em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.88888em;vertical-align: -0.19444em"></span><span class="mord">0</span><span class="mord cjk_fallback">，</span><span class="mord mathdefault" style="margin-right: 0.05278em">β</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">5</span></span></span></span></span> 时，图像暗区域变亮，亮区域变暗，图像求补</li>
<li>当 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         α
        
        
         =
        
        
         −
        
        
         1
        
        
         ，
        
        
         β
        
        
         =
        
        
         255
        
       
       
        alpha = -1，beta = 255
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.88888em;vertical-align: -0.19444em"></span><span class="mord">−</span><span class="mord">1</span><span class="mord cjk_fallback">，</span><span class="mord mathdefault" style="margin-right: 0.05278em">β</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">5</span></span></span></span></span> 时，图像的灰度值反转</li>
</ul> 
<p>直方图正规化是根据图像的最小灰度级和最大灰度级，将其拉伸到灰度级全域 [0,255] 的线性变换。<br></p> 
<br> 
<h3>
<a id="149__186"></a>例程：1.49 图像的线性灰度变换</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.49 图像的线性灰度变换</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/imgLena.tif"</span><span class="token punctuation">)</span>  <span class="token comment"># 读取彩色图像(BGR)</span>
    imgGray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>  <span class="token comment"># 颜色转换：BGR(OpenCV) -&gt; Gray</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># 图片的高度和宽度</span>
    img1 <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  <span class="token comment"># 创建空白数组</span>
    img2 <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  <span class="token comment"># 创建空白数组</span>
    img3 <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  <span class="token comment"># 创建空白数组</span>
    img4 <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  <span class="token comment"># 创建空白数组</span>
    img5 <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  <span class="token comment"># 创建空白数组</span>
    img6 <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  <span class="token comment"># 创建空白数组</span>

    <span class="token comment"># Dt[i,j] = alfa*D[i,j] + beta</span>
    alfa1<span class="token punctuation">,</span> beta1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span>  <span class="token comment"># alfa=1,beta&gt;0: 灰度值上移</span>
    alfa2<span class="token punctuation">,</span> beta2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">50</span>  <span class="token comment"># alfa=1,beta&lt;0: 灰度值下移</span>
    alfa3<span class="token punctuation">,</span> beta3 <span class="token operator">=</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0</span>  <span class="token comment"># alfa&gt;1,beta=0: 对比度增强</span>
    alfa4<span class="token punctuation">,</span> beta4 <span class="token operator">=</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">0</span>  <span class="token comment"># 0&lt;alfa&lt;1,beta=0: 对比度减小</span>
    alfa5<span class="token punctuation">,</span> beta5 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span>  <span class="token comment"># alfa&lt;0,beta=0: 暗区域变亮，亮区域变暗</span>
    alfa6<span class="token punctuation">,</span> beta6 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">255</span>  <span class="token comment"># alfa=-1,beta=255: 灰度值反转</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">:</span>
            img1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>imgGray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span>beta1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># alfa=1,beta&gt;0: 颜色发白</span>
            img2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span>imgGray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span>beta2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># alfa=1,beta&lt;0: 颜色发黑</span>
            img3<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>alfa3<span class="token operator">*</span>imgGray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># alfa&gt;1,beta=0: 对比度增强</span>
            img4<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>alfa4<span class="token operator">*</span>imgGray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 0&lt;alfa&lt;1,beta=0: 对比度减小</span>
            img5<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> alfa5<span class="token operator">*</span>imgGray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span>beta5  <span class="token comment"># alfa&lt;0,beta=255: 暗区域变亮，亮区域变暗</span>
            img6<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>alfa6<span class="token operator">*</span>imgGray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span>beta6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># alfa=-1,beta=255: 灰度值反转</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    titleList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"1. imgGray"</span><span class="token punctuation">,</span> <span class="token string">"2. beta=50"</span><span class="token punctuation">,</span> <span class="token string">"3. beta=-50"</span><span class="token punctuation">,</span> <span class="token string">"4. alfa=1.5"</span><span class="token punctuation">,</span> <span class="token string">"5. alfa=0.75"</span><span class="token punctuation">,</span> <span class="token string">"6. alfa=-0.5"</span><span class="token punctuation">]</span>
    imageList <span class="token operator">=</span> <span class="token punctuation">[</span>imgGray<span class="token punctuation">,</span> img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> img3<span class="token punctuation">,</span> img4<span class="token punctuation">,</span> img5<span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span>titleList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imageList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e0/1f/EHzWGYCk_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="33__230"></a>3.3 分段线性灰度变换</h3> 
<p>分段线性变换函数可以增强图像各部分的反差，增强感兴趣的灰度区间、抑制不感兴趣的灰度级。</p> 
<p>分段线性函数的优点是可以根据需要拉伸特征物的灰度细节，一些重要的变换只能用分段函数来描述和实现，缺点则是参数较多不容易确定。</p> 
<p>分段线性函数通用公式如下：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         D
        
        
         t
        
        
         =
        
        
         
          {
         
         
          
           
            
             
              
               
                
                 c
                
                
                 a
                
               
              
              
               D
              
             
            
           
           
            
             
              
               ,
              
              
               0
              
              
               ≤
              
              
               D
              
              
               &lt;
              
              
               a
              
             
            
           
          
          
           
            
             
              
               
                
                 
                  d
                 
                 
                  −
                 
                 
                  c
                 
                
                
                 
                  b
                 
                 
                  −
                 
                 
                  a
                 
                
               
              
              
               [
              
              
               D
              
              
               −
              
              
               a
              
              
               ]
              
              
               +
              
              
               c
              
             
            
           
           
            
             
              
               ,
              
              
               a
              
              
               ≤
              
              
               D
              
              
               ≤
              
              
               b
              
             
            
           
          
          
           
            
             
              
               
                
                 
                  f
                 
                 
                  −
                 
                 
                  d
                 
                
                
                 
                  e
                 
                 
                  −
                 
                 
                  b
                 
                
               
              
              
               [
              
              
               D
              
              
               −
              
              
               a
              
              
               ]
              
              
               +
              
              
               d
              
             
            
           
           
            
             
              
               ,
              
              
               b
              
              
               &lt;
              
              
               D
              
              
               ≤
              
              
               e
              
             
            
           
          
         
        
       
       
         Dt = begin{cases} dfrac{c}{a} D &amp;, 0 leq D &lt; a\ dfrac{d-c}{b-a}[D-a]+c &amp;, a leq D leq b\ dfrac{f-d}{e-b}[D-a]+d &amp;, b &lt; D leq e\ end{cases} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 6.0751em;vertical-align: -2.78755em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.25002em"><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎩</span></span></span><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎪</span></span></span><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎪</span></span></span><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎪</span></span></span><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎪</span></span></span><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎨</span></span></span><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎪</span></span></span><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎪</span></span></span><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎪</span></span></span><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎪</span></span></span><span class=""><span class="pstrut" style="height: 3.15em"></span><span class="delimsizinginner delim-size4"><span class="">⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.75002em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.28755em"><span class=""><span class="pstrut" style="height: 3.37144em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.10756em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">a</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span></span></span><span class=""><span class="pstrut" style="height: 3.37144em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">b</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">a</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">d</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.76933em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">a</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">c</span></span></span><span class=""><span class="pstrut" style="height: 3.37144em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">e</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">b</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em">f</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.76933em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">a</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.78755em"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 1em"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.28755em"><span class=""><span class="pstrut" style="height: 3.37144em"></span><span class="mord"><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord">0</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">a</span></span></span><span class=""><span class="pstrut" style="height: 3.37144em"></span><span class="mord"><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">b</span></span></span><span class=""><span class="pstrut" style="height: 3.37144em"></span><span class="mord"><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.78755em"><span class=""></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span><br> 式中，D 为原始图像的灰度值，Dt 为线性灰度变换后的图像灰度值。</p> 
<br> 
<h3>
<a id="150__249"></a>例程：1.50 分段线性灰度变换（对比度拉伸）</h3> 
<p>对比度拉伸可以扩展图像中的灰度级范围，从而覆盖设备的理想灰度范围。</p> 
<p>对比度拉伸变换函数可以有不同的实现方案，如将原始灰度范围拉伸到较宽的灰度范围；或将原始灰度范围拉伸到全域灰度范围（0，255）；或将原始灰度范围拉伸到较宽的灰度范围，同时对下限或上限进行截断处理。</p> 
<p>本例程令 <strong>(r1, s1) = (rMin, 0)、(r2, s2) = (rmax, L-1)</strong>，其中 rMin、rMax 表示图像中最小灰度值和最大灰度值，将原始图像的灰度级分段线性拉伸到整个范围 [0, L-1]。运行结果的左图显示本例程的拉伸变换曲线。</p> 
<pre><code>    # 1.50 分段线性灰度变换 (对比度拉伸)
    imgGray = cv2.imread("../images/Fig0310b.tif", flags=0)  # flags=0 读取为灰度图像
    height, width = imgGray.shape[:2]  # 图片的高度和宽度

    # constrast stretch, (r1,s1)=(rMin,0), (r2,s2)=(rMax,255)
    rMin = imgGray.min()  # 原始图像灰度的最小值
    rMax = imgGray.max()  # 原始图像灰度的最大值
    r1, s1 = rMin, 0  # (x1,y1)
    r2, s2 = rMax, 255  # (x2,y2)

    imgStretch = np.empty((width, height), np.uint8)  # 创建空白数组
    k1 = s1 / r1  # imgGray[h,w] &lt; r1:
    k2 = (s2-s1) / (r2-r1)  # r1 &lt;= imgGray[h,w] &lt;= r2
    k3 = (255-s2) / (255-r2)  # imgGray[h,w] &gt; r2
    for h in range(height):
        for w in range(width):
            if imgGray[h,w] &lt; r1:
                imgStretch[h,w] = k1 * imgGray[h,w]
            elif r1 &lt;= imgGray[h,w] &lt;= r2:
                imgStretch[h,w] = k2 * (imgGray[h,w] - r1) + s1
            elif imgGray[h,w] &gt; r2:
                imgStretch[h,w] = k3 * (imgGray[h,w] - r2) + s2

    plt.figure(figsize=(10,3.5))
    plt.subplots_adjust(left=0.2, bottom=0.2, right=0.9, top=0.8, wspace=0.1, hspace=0.1)
    plt.subplot(131), plt.title("s=T(r)")
    x = [0, 96, 182, 255]
    y = [0, 30, 220, 255]
    plt.plot(x, y)
    plt.axis([0,256,0,256])
    plt.text(105, 25, "(r1,s1)", fontsize=10)
    plt.text(120, 215, "(r2,s2)", fontsize=10)
    plt.xlabel("r, Input value")
    plt.ylabel("s, Output value")
    plt.subplot(132), plt.imshow(imgGray, cmap='gray', vmin=0, vmax=255), plt.title("Original"), plt.axis('off')
    plt.subplot(133), plt.imshow(imgStretch, cmap='gray', vmin=0, vmax=255), plt.title("Stretch"), plt.axis('off')
    plt.show()
</code></pre> 
<p><img src="https://images2.imgbox.com/70/d2/yV69oYlm_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="153__301"></a>例程：1.53 分段线性灰度变换（灰度级分层）</h3> 
<p>灰度级分层可以突出图像中特定的灰度级区间，可以对灰度级进行分层处理。</p> 
<p>灰度级分层有两种常用方案：一种方案是二值处理，将感兴趣的灰度级区间设为较大的灰度值，其它区间设为较小的灰度值；另一种方案是窗口处理，将感兴趣的灰度级区间设为较大的灰度值，其它区间不变。</p> 
<p>两种灰度级分层方案的分段变换公式分别为：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         D
        
        
         
          t
         
         
          1
         
        
        
         =
        
        
         
          {
         
         
          
           
            
             
              d
             
            
           
           
            
             
              
               ,
              
              
               a
              
              
               ≤
              
              
               D
              
              
               ≤
              
              
               b
              
             
            
           
          
          
           
            
             
              c
             
            
           
           
            
             
              
               ,
              
              
               e
              
              
               l
              
              
               s
              
              
               e
              
             
            
           
          
         
        
        
        
         D
        
        
         
          t
         
         
          2
         
        
        
         =
        
        
         
          {
         
         
          
           
            
             
              d
             
            
           
           
            
             
              
               ,
              
              
               a
              
              
               ≤
              
              
               D
              
              
               ≤
              
              
               b
              
             
            
           
          
          
           
            
             
              D
             
            
           
           
            
             
              
               ,
              
              
               e
              
              
               l
              
              
               s
              
              
               e
              
             
            
           
          
         
        
       
       
         Dt_1 = begin{cases} d &amp;, a leq D leq b\ c &amp;, else end{cases} \ Dt_2 = begin{cases} d &amp;, a leq D leq b\ D &amp;, else end{cases} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em;vertical-align: -0.15em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 3.00003em;vertical-align: -1.25003em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">{<!-- --></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.69em"><span class=""><span class="pstrut" style="height: 3.008em"></span><span class="mord"><span class="mord mathdefault">d</span></span></span><span class=""><span class="pstrut" style="height: 3.008em"></span><span class="mord"><span class="mord mathdefault">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.19em"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 1em"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.69em"><span class=""><span class="pstrut" style="height: 3.008em"></span><span class="mord"><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">b</span></span></span><span class=""><span class="pstrut" style="height: 3.008em"></span><span class="mord"><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right: 0.01968em">l</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.19em"><span class=""></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height: 0.83333em;vertical-align: -0.15em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 3.00003em;vertical-align: -1.25003em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">{<!-- --></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.69em"><span class=""><span class="pstrut" style="height: 3.008em"></span><span class="mord"><span class="mord mathdefault">d</span></span></span><span class=""><span class="pstrut" style="height: 3.008em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.19em"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 1em"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.69em"><span class=""><span class="pstrut" style="height: 3.008em"></span><span class="mord"><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">b</span></span></span><span class=""><span class="pstrut" style="height: 3.008em"></span><span class="mord"><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right: 0.01968em">l</span><span class="mord mathdefault">s</span><span class="mord mathdefault">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.19em"><span class=""></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span><br> 式中，D 为原始图像的灰度值，Dt1、Dt2 为灰度变换后的图像灰度值。</p> 
<p>例程 1.53 对于肾部区域主动脉血管造影图像，采用灰度级分层技术增强主要血管，将感兴趣的灰度级区间显示为白色。方案一进行二值化处理，将其它灰度区间设为黑色；方案二则保留其它灰度区间的灰度值不变。</p> 
<pre><code>    # # 1.53 分段线性灰度变换 (灰度级分层)  # Gray layered
    imgGray = cv2.imread("../images/Fig0312a.tif", flags=0)  # flags=0 读取为灰度图像
    width, height = imgGray.shape[:2]  # 图片的高度和宽度

    # Gray layered strategy 1: binary image
    a, b = 155, 245  # 突出 [a, b] 区间的灰度
    imgLayer1 = imgGray.copy()
    imgLayer1[(imgLayer1[:,:]&lt;a) | (imgLayer1[:,:]&gt;b)] = 0  # 其它区域：黑色
    imgLayer1[(imgLayer1[:,:]&gt;=a) &amp; (imgLayer1[:,:]&lt;=b)] = 255  # 灰度级窗口：白色

    # Gray layered strategy 2: grayscale image
    imgLayer2 = imgGray.copy()
    imgLayer2[(imgLayer2[:,:]&gt;=a) &amp; (imgLayer2[:,:]&lt;=b)] = 255  # 灰度级窗口：白色，其它区域不变

    plt.figure(figsize=(10, 6))
    plt.subplot(131), plt.imshow(imgGray, cmap='gray'), plt.title('Original'), plt.axis('off')
    plt.subplot(132), plt.imshow(imgLayer1, cmap='gray'), plt.title('Binary layered'), plt.axis('off')
    plt.subplot(133), plt.imshow(imgLayer2, cmap='gray'), plt.title('Grayscale layered'), plt.axis('off')
    plt.show()
</code></pre> 
<p><img src="https://images2.imgbox.com/d8/77/qlCGv6sx_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="154__352"></a>例程：1.54 分段线性灰度变换（比特平面分层）</h3> 
<p>像素值也可以表示为二进制形式，对 8bits 二进制数的每一位进行切片，可以得到 8 个比特平面，称为比特平面分层（Bit-plane slicing）。<br> 通常，高阶比特平面包含了大量有视觉意义的数据，而低阶比特平面包含了更精细的灰度细节。因此，比特平面分层可以用于图像压缩和图像重建。</p> 
<pre><code>    # # 1.54 分段线性灰度变换 (比特平面分层)  Bit-plane slicing
    img = cv2.imread("../images/Fig0726a.tif", flags=0)  # flags=0 读取为灰度图像
    height, width = img.shape[:2]  # 图片的高度和宽度
    # imgRec = np.zeros((height, width), dtype=np.uint8)  # 创建零数组

    plt.figure(figsize=(10, 8))
    for l in range(9, 0, -1):
        plt.subplot(3, 3, (9-l)+1, xticks=[], yticks=[])
        if l==9:
            plt.imshow(img, cmap='gray'), plt.title('Original')
        else:
            imgBit = np.empty((height, width), dtype=np.uint8)  # 创建空数组
            for w in range(width):
                for h in range(height):
                    x = np.binary_repr(img[w,h], width=8)  # 以字符串形式返回输入数字的二进制表示形式
                    x = x[::-1]
                    a = x[l-1]
                    imgBit[w,h] = int(a)  # 第 i 位二进制的值
            plt.imshow(imgBit, cmap='gray')
            plt.title(f"{bin((l-1))}")
    plt.show()
</code></pre> 
<p><img src="https://images2.imgbox.com/1f/c0/daoCYs56_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<br> 
<h3>
<a id="34__388"></a>3.4 非线性灰度变换：对数变换和指数变换</h3> 
<p>对数变换可以由以下公式描述：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         D
        
        
         t
        
        
         =
        
        
         c
        
        
         ∗
        
        
         l
        
        
         o
        
        
         g
        
        
         (
        
        
         1
        
        
         +
        
        
         D
        
        
         )
        
       
       
         Dt = c * log(1+D) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.46528em;vertical-align: 0em"></span><span class="mord mathdefault">c</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.01968em">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right: 0.03588em">g</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mclose">)</span></span></span></span></span></span><br> 对数曲线在像素值较低的区域斜率大，在像素值较高的区域斜率小。对数变换将输入中范围较窄的低灰度值映射为范围较宽的灰度级，输入中的高灰度值则被映射为范围较窄的灰度级。对数变换后，较暗区域的对比度提升，可以增强图像的暗部细节。</p> 
<p>对数变换实现了扩展低灰度值而压缩高灰度值的效果，广泛应用于频谱图像的显示中。对数变换的典型应用是傅立叶频谱的动态范围很宽，直接显示时受显示设备动态范围的限制而丢失大量的暗部细节；使用对数变换将图像的动态范围进行非线性压缩后，就可以清晰地显示。</p> 
<br> 
<h3>
<a id="155__400"></a>例程：1.55 图像的对数变换</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.55 图像的非线性灰度变换：对数变换</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/Fig0305a.tif"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># flags=0 读取为灰度图像</span>

    normImg <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">255</span><span class="token punctuation">.</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span>x<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>x<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token comment"># 归一化</span>
    fft <span class="token operator">=</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>fft2<span class="token punctuation">(</span>img<span class="token punctuation">)</span>  <span class="token comment"># 傅里叶变换</span>
    fft_shift <span class="token operator">=</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>fftshift<span class="token punctuation">(</span>fft<span class="token punctuation">)</span>  <span class="token comment"># 中心化</span>
    amp <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>fft_shift<span class="token punctuation">)</span>  <span class="token comment"># 傅里叶变换的频谱</span>
    amp <span class="token operator">=</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>normImg<span class="token punctuation">(</span>amp<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 映射到 [0, 255]</span>
    ampLog <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>fft_shift<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 对数变换</span>
    ampLog <span class="token operator">=</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>normImg<span class="token punctuation">(</span>ampLog<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 映射到 [0, 255]</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">131</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Original'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">132</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>amp<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"FFT spectrum"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">133</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>ampLog<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"FFT spectrum - log trans"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4a/12/mDrEYbAQ_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="35__426"></a>3.5 非线性灰度变换：幂律变换（伽马变换）</h3> 
<p>幂律变换也称伽马变换，可以提升暗部细节，对发白（曝光过度）或过暗（曝光不足）的图片进行矫正。</p> 
<p>幂律变换可以由以下公式描述：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         D
        
        
         t
        
        
         =
        
        
         c
        
        
         ∗
        
        
         (
        
        
         D
        
        
         +
        
        
         ϵ
        
        
         
          )
         
         
          γ
         
        
       
       
         Dt = c * (D+epsilon)^{gamma} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.46528em;vertical-align: 0em"></span><span class="mord mathdefault">c</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">D</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">ϵ</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05556em">γ</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br> 伽马变换本质上是对图像矩阵中的每个值进行幂运算。$ 0&lt; gamma &lt;1$ 时，拉伸图像中灰度级较低的区域，压缩灰度级较高的部分，增加图像的对比度；<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        γ
       
       
        &gt;
       
       
        1
       
      
      
       gamma &gt;1
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.73354em;vertical-align: -0.19444em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">1</span></span></span></span></span> 时，拉伸图像中灰度级较高的区域，压缩灰度级较低的部分，降低图像的对比度。<br> 伽马变换通过非线性变换对人类视觉特性进行补偿，最大化地利用有效的灰度级带宽。很多拍摄、显示、打印设备的亮度曲线都符合幂律曲线，因此伽马变换广泛应用于各种设备显示效果的调校，称为伽马校正。</p> 
<br> 
<h3>
<a id="156__439"></a>例程：1.56 图像的幂律变换</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.56 图像的非线性灰度变换: 幂律变换 (伽马变换)</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/imgB2.jpg"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># flags=0 读取为灰度图像</span>

    gammaList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.125</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">]</span>  <span class="token comment"># gamma 值</span>
    normImg <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">255</span><span class="token punctuation">.</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token operator">-</span>x<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>x<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token comment"># 归一化为 [0,255]</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>gammaList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        imgGamma <span class="token operator">=</span> np<span class="token punctuation">.</span>power<span class="token punctuation">(</span>img<span class="token punctuation">,</span> gammaList<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
        imgGamma <span class="token operator">=</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>normImg<span class="token punctuation">(</span>imgGamma<span class="token punctuation">)</span><span class="token punctuation">)</span>

        plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgGamma<span class="token punctuation">,</span>  cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"$gamma=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>gammaList<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">$"</span></span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b9/53/PlNgjroc_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<br> 
<h2>
<a id="4__466"></a>4. 图像的直方图处理</h2> 
<h3>
<a id="41__468"></a>4.1 灰度直方图</h3> 
<p>图像直方图是反映图像像素分布的统计表，横坐标代表像素值的取值区间，纵坐标代表每一像素值在图像中的像素总数或者所占的百分比。 灰度直方图是图像灰度级的函数，用来描述每个灰度级在图像矩阵中的像素个数。</p> 
<p>灰度直方图反映了图像中的灰度分布规律，直观地表现了图像中各灰度级的占比，很好地体现出图像的亮度和对比度信息：灰度图分布居中说明亮度正常，偏左说明亮度较暗，偏右表明亮度较高；狭窄陡峭表明对比度降低，宽泛平缓表明对比度较高。</p> 
<p>根据直方图的形态可以判断图像的质量，通过调控直方图的形态可以改善图像的质量。</p> 
<p>OpenCV 提供了函数 <strong>cv2.calcHist</strong> 可以计算直方图，Numpy 中的函数 <strong>np.bincount</strong> 也可以实现同样的功能。</p> 
<p><strong>函数说明：</strong></p> 
<pre><code>cv2.calcHist(images, channels, mask, histSize, ranges[, hist[, accumulate ]]) → hist
</code></pre> 
<p>函数 cv2.calcHist 可以计算一维直方图或二维直方图，函数的参数 images, channels, histSize, ranges 在计算一维直方图时也要带 [] 号。</p> 
<p><strong>参数说明：</strong></p> 
<ul>
<li>images：输入图像，用 [] 括号表示</li>
<li>channels： 直方图计算的通道，用 [] 括号表示</li>
<li>mask：掩模图像，一般置为 None</li>
<li>histSize：直方柱的数量，一般取 256</li>
<li>ranges：像素值的取值范围，一般为 [0,256]</li>
<li>返回值 hist：返回每一像素值在图像中的像素总数，形状为 (histSize,1)</li>
</ul> 
<p><strong>注意：</strong></p> 
<ul>
<li> 
  <ol><li>参数 images, channels, histSize, ranges 都要带 [] 号。</li></ol> </li>
<li> 
  <ol start="2"><li>mask 是与 images 大小相同的掩模图像，掩模为 0 的区域不作处理。不使用掩模时设为 None。<br> 3. channels 设置对彩色图像的指定通道计算直方图，灰度图像时设为 0。<br> 4. Numpy 中的函数 <strong>np.bincount</strong> 也可以实现同样的功能，但该函数返回值的形状为 (histSize,)</li></ol> </li>
</ul> 
<br> 
<h3>
<a id="157__504"></a>例程：1.57 图像的灰度直方图</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.57 图像的灰度直方图</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/imgLena.tif"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># flags=0 读取为灰度图像</span>

    histCV <span class="token operator">=</span> cv2<span class="token punctuation">.</span>calcHist<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># OpenCV 函数 cv2.calcHist</span>
    histNP<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>img<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>histCV<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> histNP<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>  <span class="token comment"># histCV: (256, 1), histNP: (256,)</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">131</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Original"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">132</span><span class="token punctuation">,</span>xticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>histCV<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> histCV<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Gray Hist(cv2.calcHist)"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">133</span><span class="token punctuation">,</span>xticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>histCV<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>bins<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histNP<span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Gray Hist(np.histogram)"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/87/f8/XTpIwnsg_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="42__527"></a>4.2 直方图均衡化</h3> 
<p>直方图均衡化是一种简单有效的图像增强技术。根据直方图的形态可以判断图像的质量，通过调控直方图的形态可以改善图像的质量。</p> 
<p>直方图均衡化是将原始图像通过函数变换，调控图像的灰度分布，得到直方图分布合理的新图像，以此来调节图像亮度、增强动态范围偏小的图像的对比度。</p> 
<p>由于人眼视觉特性，直方图均匀分布的图像视觉效果较好。直方图均衡化的基本思想是对图像中占比大的灰度级进行展宽，而对占比小的灰度级进行压缩，使图像的直方图分布较为均匀，扩大灰度值差别的动态范围，从而增强图像整体的对比度。</p> 
<p>因此，直方图均衡化就是对图像进行非线性拉伸，重新分配图像像素值，本质上是根据直方图对图像进行线性或非线性灰度变换。</p> 
<p>例如，直方图均衡化可以把原始图像的直方图调整到均匀分布，增加像素之间灰度值差别的动态范围，从而增强图像整体的对比度。</p> 
<p>通过累积分布函数（cumulative distribution function, CDF）可以实现将原图像 r 的分布转换成 s 的均匀分布，累计分布函数（CDF）就是是概率密度函数（probability density function, PDF）的积分。</p> 
<p>若 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         p
        
        
         r
        
       
       
        (
       
       
        r
       
       
        )
       
      
      
       p_r(r)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mclose">)</span></span></span></span></span> 和 $p_s(s) $表示原图像 r 和新图像 s 的概率密度函数，则：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         s
        
        
         =
        
        
         T
        
        
         (
        
        
         r
        
        
         )
        
        
         =
        
        
         (
        
        
         L
        
        
         −
        
        
         1
        
        
         )
        
        
         
          ∫
         
         
          0
         
         
          r
         
        
        
         
          p
         
         
          r
         
        
        
         (
        
        
         r
        
        
         )
        
        
         d
        
        
         r
        
       
       
         s=T(r)= (L-1) int _0 ^r p_r(r) dr 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.13889em">T</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 2.32624em;vertical-align: -0.91195em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right: 0.44445em">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.41429em"><span class="" style="margin-left: -0.44445em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.91195em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mclose">)</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span></span></span></span></span></span><br> 其离散形式为：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          s
         
         
          k
         
        
        
         =
        
        
         T
        
        
         (
        
        
         
          r
         
         
          k
         
        
        
         )
        
        
         =
        
        
         (
        
        
         L
        
        
         −
        
        
         1
        
        
         )
        
        
         
          ∑
         
         
          
           j
          
          
           =
          
          
           0
          
         
         
          k
         
        
        
         
          p
         
         
          r
         
        
        
         (
        
        
         
          r
         
         
          j
         
        
        
         )
        
        
         =
        
        
         (
        
        
         L
        
        
         −
        
        
         1
        
        
         )
        
        
         
          ∑
         
         
          
           j
          
          
           =
          
          
           0
          
         
         
          k
         
        
        
         
          
           n
          
          
           j
          
         
         
          N
         
        
       
       
         s_k = T(r_k) = (L-1) sum_{j=0}^k p_r(r_j) = (L-1) sum_{j=0}^k frac{n_j}{N} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.13889em">T</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.02778em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 3.24989em;vertical-align: -1.41378em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.83611em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05724em">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.41378em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em"><span class="" style="margin-left: -0.02778em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 3.24989em;vertical-align: -1.41378em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.83611em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05724em">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.41378em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.10756em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em">N</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span><br> 于是，可以通过原图像的直方图直接求出均衡化后各像素的灰度级 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         s
        
        
         k
        
       
      
      
       s_k
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span>，得到实现直方图均衡的转换函数：</p> 
<p>（1）计算原始灰度图像的直方图；</p> 
<p>（2）通过直方图累加计算原始图像的累计分布函数 CDF；</p> 
<p>（3）基于累计分布函数 CDF，通过插值计算得到新的灰度值。</p> 
<p>OpenCV 提供了函数 <strong>cv2. equalizeHist</strong> 可以实现直方图均衡化。</p> 
<p><strong>函数说明：</strong></p> 
<pre><code>cv2.qualizeHist(src[, dst]) → dst
</code></pre> 
<p><strong>参数说明：</strong></p> 
<ul>
<li>src：输入图像</li>
<li>返回值 dst：输出图像，直方图均衡化</li>
</ul> 
<br> 
<h3>
<a id="158__572"></a>例程：1.58 直方图均衡</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.58 直方图均衡</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/Fig0310b.tif"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># flags=0 读取为灰度图像</span>

    imgEqu <span class="token operator">=</span> cv2<span class="token punctuation">.</span>equalizeHist<span class="token punctuation">(</span>img<span class="token punctuation">)</span>  <span class="token comment"># 使用 cv2.qualizeHist 完成直方图均衡化变换</span>

    <span class="token comment"># histogram equalization image</span>
    <span class="token comment"># histImg, bins = np.histogram(img.flatten(), 256)  # 计算原始图像直方图</span>
    <span class="token comment"># cdf = histImg.cumsum()  # 计算累积分布函数 CDF</span>
    <span class="token comment"># cdf = cdf * 255 / cdf[-1]  # 累计函数 CDF 归一化: [0,1]-&gt;[0,255]</span>
    <span class="token comment"># imgEqu = np.interp(img.flatten(), bins[:256], cdf)  # 线性插值，计算新的灰度值</span>
    <span class="token comment"># imgEqu = imgEqu.reshape(img.shape)  # 将压平的图像数组重新变成二维数组</span>

    fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">221</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Original image (youcans)"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>  <span class="token comment"># 原始图像</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">,</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Hist-equalized image"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgEqu<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>  <span class="token comment"># 转换图像</span>
    histImg<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>img<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算原始图像直方图</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">223</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>bins<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histImg<span class="token punctuation">)</span>  <span class="token comment"># 原始图像直方图</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Histogram of original image"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>histImg<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    histEqu<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>imgEqu<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算原始图像直方图</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>bins<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histEqu<span class="token punctuation">)</span>  <span class="token comment"># 转换图像直方图</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Histogram of equalized image"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>histImg<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/49/0d/tTlQXKo6_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="43__605"></a>4.3 直方图匹配</h3> 
<p>直方图均衡直接对图像全局进行均衡化，生成具有均匀直方图的图像，并不考虑局部图像区域的具体情况。对于一幅图像的局部区域、具体缺陷，有时需要生成具有特殊形状直方图的图像。</p> 
<p>直方图匹配又称为直方图规定化，是指将图像的直方图调整为规定的形状。 例如，将一幅图像或某一区域的直方图匹配到另一幅影像上，使两幅影像的色调保持一致。</p> 
<p>这就需要在直方图均衡的基础上，再进行一次反变换，将均匀形状的直方图调整为规定的形状。</p> 
<p>直方图匹配的主要步骤为：</p> 
<p>（1）通过规定图像 z 的直方图 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         p
        
        
         z
        
       
       
        (
       
       
        z
       
       
        )
       
      
      
       p_z(z)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.04398em">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.04398em">z</span><span class="mclose">)</span></span></span></span></span>，计算其直方图均衡变换的 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         s
        
        
         k
        
       
      
      
       s_k
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span>；</p> 
<p>（2）通过 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         s
        
        
         k
        
       
      
      
       s_k
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span> 计算图像 z 的直方图均衡变换函数 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        G
       
      
      
       G
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em;vertical-align: 0em"></span><span class="mord mathdefault">G</span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        G
       
       
        (
       
       
        
         z
        
        
         q
        
       
       
        )
       
       
        =
       
       
        
         s
        
        
         k
        
       
      
      
       G(z_q)=s_k
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.03611em;vertical-align: -0.286108em"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: -0.04398em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.58056em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span>；</p> 
<p>（3）计算变换函数 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        G
       
      
      
       G
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em;vertical-align: 0em"></span><span class="mord mathdefault">G</span></span></span></span></span> 的逆变换函数 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         G
        
        
         
          −
         
         
          1
         
        
       
      
      
       G^{-1}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em;vertical-align: 0em"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         z
        
        
         q
        
       
       
        =
       
       
        
         G
        
        
         
          −
         
         
          1
         
        
       
       
        (
       
       
        
         s
        
        
         k
        
       
       
        )
       
      
      
       z_q=G^{-1}(s_k)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.716668em;vertical-align: -0.286108em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: -0.04398em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1.06411em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>；</p> 
<p>（4）对输入图像 r 进行直方图均衡得到均衡图像 s，然后再用逆变换函数 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         G
        
        
         
          −
         
         
          1
         
        
       
      
      
       G^{-1}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em;vertical-align: 0em"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span> 将其映射到 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         p
        
        
         z
        
       
       
        (
       
       
        z
       
       
        )
       
      
      
       p_z(z)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.04398em">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.04398em">z</span><span class="mclose">)</span></span></span></span></span>，得到直方图匹配图像 z。本步骤中的两次变换，也可以合并为一次完成。</p> 
<br> 
<h3>
<a id="159__625"></a>例程：1.59 灰度图像直方图匹配</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.59 灰度图像直方图匹配</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/imgGaia.tif"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># flags=0 读取为灰度图像</span>
    imgRef <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/Fig0307a.tif"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 匹配模板图像, matching template</span>

    <span class="token comment"># imgOut = calcHistMatch(img, imgRef)  # 子程序：直方图匹配</span>

    <span class="token comment"># 计算累计直方图</span>
    histImg<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>img<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算原始图像直方图</span>
    histRef<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>imgRef<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算匹配模板直方图</span>
    cdfImg <span class="token operator">=</span> histImg<span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 计算原始图像累积分布函数 CDF</span>
    cdfRef <span class="token operator">=</span> histRef<span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 计算匹配模板累积分布函数 CDF</span>

    <span class="token comment"># 计算直方图匹配转换函数</span>
    transM <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        index <span class="token operator">=</span> <span class="token number">0</span>
        vMin <span class="token operator">=</span> np<span class="token punctuation">.</span>fabs<span class="token punctuation">(</span>cdfImg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> cdfRef<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            diff <span class="token operator">=</span> np<span class="token punctuation">.</span>fabs<span class="token punctuation">(</span>cdfImg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> cdfRef<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">&lt;</span> vMin<span class="token punctuation">)</span><span class="token punctuation">:</span>
                index <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
                vMin <span class="token operator">=</span> diff
        transM<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> index

    <span class="token comment"># 直方图匹配</span>
    <span class="token comment"># imgOut = np.zeros_like(img)</span>
    imgOut <span class="token operator">=</span> transM<span class="token punctuation">[</span>img<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>

    fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">231</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Original image"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>  <span class="token comment"># 原始图像</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">232</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Matching template"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgRef<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>  <span class="token comment"># 匹配模板</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">233</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Matching output"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgOut<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>  <span class="token comment"># 匹配结果</span>
    histImg<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>img<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算原始图像直方图</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">234</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>bins<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histImg<span class="token punctuation">)</span>
    histRef<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>imgRef<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算匹配模板直方图</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">235</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>bins<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histRef<span class="token punctuation">)</span>
    histOut<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>imgOut<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算匹配结果直方图</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">236</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>bins<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histOut<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/2b/c5/R8X0hefM_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="160__676"></a>例程：1.60 彩色图像直方图匹配</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.60 彩色图像的直方图匹配</span>

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/imgGaia.tif"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># flags=1 读取为彩色图像</span>
    imgRef <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/imgLena.tif"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 匹配模板图像 (matching template)</span>

    _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> channel <span class="token operator">=</span> img<span class="token punctuation">.</span>shape
    imgOut <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        histImg<span class="token punctuation">,</span> _ <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算原始图像直方图</span>
        histRef<span class="token punctuation">,</span> _ <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>imgRef<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算匹配模板直方图</span>
        cdfImg <span class="token operator">=</span> np<span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span>histImg<span class="token punctuation">)</span>  <span class="token comment"># 计算原始图像累积分布函数 CDF</span>
        cdfRef <span class="token operator">=</span> np<span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span>histRef<span class="token punctuation">)</span>  <span class="token comment"># 计算匹配模板累积分布函数 CDF</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            tmp <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>cdfImg<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-</span> cdfRef<span class="token punctuation">)</span>
            tmp <span class="token operator">=</span> tmp<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
            index <span class="token operator">=</span> tmp<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># find the smallest number in tmp, get the index of this number</span>
            imgOut<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token operator">==</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> index

    fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">231</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Original image"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 显示原始图像</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">232</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Matching template"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>imgRef<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 显示匹配模板</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">233</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Matching output"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>imgOut<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 显示匹配结果</span>
    histImg<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>img<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算原始图像直方图</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">234</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>bins<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histImg<span class="token punctuation">)</span>
    histRef<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>imgRef<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算匹配模板直方图</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">235</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>bins<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histRef<span class="token punctuation">)</span>
    histOut<span class="token punctuation">,</span> bins <span class="token operator">=</span> np<span class="token punctuation">.</span>histogram<span class="token punctuation">(</span>imgOut<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 计算匹配结果直方图</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">236</span><span class="token punctuation">,</span> yticks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>bins<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histOut<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/15/51/7JeexLNm_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="44__718"></a>4.4 局部直方图处理</h3> 
<p>直方图均衡和直方图匹配都是基于整幅图像的灰度分布进行全局变换，并非针对图像局部区域的细节进行增强。</p> 
<p>直方图处理对于局部同样适用，局部直方图处理的思想是基于像素邻域的灰度分布进行直方图变换处理。</p> 
<p>局部直方图处理的过程是：</p> 
<p>（1）设定某一大小的模板（矩形邻域），在图像中沿逐个像素移动；</p> 
<p>（2）对每个像素位置，计算模板区域的直方图，对该局部区域进行直方图均衡或直方图匹配变换，变换结果只用于模板区域中心像素点的灰度值修正；</p> 
<p>（3）模板（邻域）在图像中逐行逐列移动，遍历所有像素点，完成对整幅图像的局部直方图处理。</p> 
<p>OpenCV 提供了类 <strong>cv2. createCLAHE</strong> 用于创建自适应均衡化的对象和方法，可以实现局部直方图处理。</p> 
<p><strong>函数说明：</strong></p> 
<pre><code>cv2.createCLAHE([, clipLimit[, tileGridSize]]) → retval
</code></pre> 
<p><strong>参数说明：</strong></p> 
<ul>
<li>clipLimit：颜色对比度的阈值，可选项，默认值 8</li>
<li>titleGridSize：局部直方图均衡化的模板（邻域）大小，可选项，默认值 (8,8)</li>
</ul> 
<p><strong>cv2. createCLAHE</strong> 是一种限制对比度自适应直方图均衡化方法（Contrast Limited Adaptive Hitogram Equalization），采用了限制直方图分布的方法和加速的插值方法。</p> 
<br> 
<h3>
<a id="161__749"></a>基本例程：1.61 自适应的局部直方图均衡</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.61 局部直方图均衡化</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/FigClahe.jpg"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># flags=0 读取为灰度图像</span>

    imgEqu <span class="token operator">=</span> cv2<span class="token punctuation">.</span>equalizeHist<span class="token punctuation">(</span>img<span class="token punctuation">)</span>  <span class="token comment"># 全局直方图均衡化</span>
    clahe <span class="token operator">=</span> cv2<span class="token punctuation">.</span>createCLAHE<span class="token punctuation">(</span>clipLimit<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span> tileGridSize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 创建 CLAHE 对象</span>
    imgLocalEqu <span class="token operator">=</span> clahe<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>  <span class="token comment"># 自适应的局部直方图均衡化</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">131</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Original'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">132</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Global Equalize Hist'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgEqu<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">133</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Local Equalize Hist'</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgLocalEqu<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/09/10/Mgdtbx0v_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="45__775"></a>4.5 直方图统计量图像增强</h3> 
<p>直方图统计量图像增强，是基于直方图的统计量信息（如均值和方差）对图像的灰度和对比度进行调整。直方图统计量不仅用于图像的全局增强，在图像局部增强中更加有效。</p> 
<p>局部均值和方差是根据像素邻域特征进行灰度调整的基础。像素邻域的局部均值是平均灰度的测度，局部方差是对比度的测度。使用局部均值和方差可以开发出简单而强大的图像局部增强算法。</p> 
<p>以下基于 Rafael C. Gonzalez “Digital Image Processing (4th.Ed.)” 中的方法和案例进行介绍。</p> 
<p>增强后的图像 g(x,y) 与原始图像 f(x,y) 的修正公式为：<br> <span class="katex--display">KaTeX parse error: No such environment: align at position 8: begin{̲a̲l̲i̲g̲n̲}̲g(x,y)&amp;=begin{…</span></p> 
<p>如果待增强区域相对平均灰度更暗，可以选择 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         k
        
        
         0
        
       
       
        =
       
       
        0
       
       
        ,
       
       
        
         k
        
        
         1
        
       
       
        =
       
       
        0.1
       
      
      
       k_0 = 0, k_1 = 0.1
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.84444em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: -0.03148em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.88888em;vertical-align: -0.19444em"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: -0.03148em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span></span></span></span></span>；如果待增强区域的对比度很低，可以选择 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         k
        
        
         2
        
       
       
        =
       
       
        0
       
       
        ,
       
       
        
         k
        
        
         3
        
       
       
        =
       
       
        0.1
       
      
      
       k_2 = 0, k_3 = 0.1
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.84444em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: -0.03148em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.88888em;vertical-align: -0.19444em"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: -0.03148em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span></span></span></span></span>。</p> 
<p>需要指出的是，这种方法只对某些特殊类型的图像有效，而且需要针对具体图像进行 ROI 设置和参数调节，才能取得较好的图像增强效果。</p> 
<br> 
<h3>
<a id="161__794"></a>基本例程：1.61 直方图统计量图像增强</h3> 
<pre><code class="prism language-python">    <span class="token comment"># # 1.63 直方图统计量图像增强</span>
    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/Fig0326a.tif"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># flags=0 读取为灰度图像</span>

    imgROI <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">:</span><span class="token number">120</span><span class="token punctuation">]</span>
    maxImg<span class="token punctuation">,</span> maxROI <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imgROI<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    const <span class="token operator">=</span> maxImg <span class="token operator">/</span> maxROI
    imgHSE <span class="token operator">=</span> enhanceHistStat<span class="token punctuation">(</span>img<span class="token punctuation">,</span> const<span class="token punctuation">)</span>  <span class="token comment"># 子程序：直方图统计量增强 (自定义方法)</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">131</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Original image"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">132</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Global equalize histogram"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    imgEqu <span class="token operator">=</span> cv2<span class="token punctuation">.</span>equalizeHist<span class="token punctuation">(</span>img<span class="token punctuation">)</span>  <span class="token comment"># 使用 cv2.qualizeHist 完成直方图均衡化变换</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgEqu<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">133</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Histogram statistic enhance"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgHSE<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">,</span> vmin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> vmax<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/78/9a/gmRnBfOy_o.png" alt="在这里插入图片描述"></p> 
<br> 
<h3>
<a id="46__822"></a>4.6 直方图反向投影（反向追踪）</h3> 
<p>直方图反向投影是一种在输入图像中查找与特定模板图像匹配最佳的点或区域的方法，可以对特定颜色物体、特定灰度物体进行查找、跟踪，常用于图像查找、图像分割。</p> 
<p>直方图反向投影处理的原理，是计算某一特征的直方图模型，再使用该模型去寻找图像中存在的特征。</p> 
<p>直方图反向投影处理的过程，首先建立模板区域的直方图，再将直方图投影到输入图像，计算输入图像中每个像素点的像素值与直方图匹配概率，得到概率图像并以一定阈值进行二值化处理。</p> 
<p>OpenCV 提供的函数 <strong>cv2.calcBackProject()</strong> 可以用来做直方图反向投影。</p> 
<p><strong>函数说明：</strong></p> 
<pre><code>cv2.calcBackProject(images, channels, hist, ranges, scale[, dst]) → dst
</code></pre> 
<p><strong>参数说明：</strong></p> 
<ul>
<li> <p>images：颜色对比度的阈值，可选项，默认值 8</p> </li>
<li> <p>channels： 计算反向投影的图像通道</p> </li>
<li> <p>hist： 查找模板区域的直方图</p> </li>
<li> <p>ranges：每个维度中直方图单元边界的数组</p> </li>
<li> <p>scale：反向投影输出的缩放比例</p> </li>
<li> <p>返回值 dst：返回反向投影的输出图像</p> </li>
</ul> 
<br> 
<h3>
<a id="164__852"></a>基本例程：1.64 直方图反向投影追踪</h3> 
<pre><code class="prism language-python">    <span class="token comment"># 1.64 直方图反向投影</span>
    roi <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/BallFrag.png"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 查找的图像区域</span>
    target <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"../images/imgBall.png"</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 被查找的目标图像</span>

    hsvRoi <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>roi<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2HSV<span class="token punctuation">)</span>
    hsvTar <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>target<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2HSV<span class="token punctuation">)</span>

    histRoi <span class="token operator">=</span> cv2<span class="token punctuation">.</span>calcHist<span class="token punctuation">(</span><span class="token punctuation">[</span>hsvRoi<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 计算目标直方图</span>
    cv2<span class="token punctuation">.</span>normalize<span class="token punctuation">(</span>histRoi<span class="token punctuation">,</span> histRoi<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>NORM_MINMAX<span class="token punctuation">)</span>  <span class="token comment"># 归一化 -&gt;[0,255]</span>

    dst <span class="token operator">=</span> cv2<span class="token punctuation">.</span>calcBackProject<span class="token punctuation">(</span><span class="token punctuation">[</span>hsvTar<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histRoi<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 反向投影</span>
    disc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getStructuringElement<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>MORPH_ELLIPSE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 定义椭圆结构形状</span>
    imgConv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>filter2D<span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> disc<span class="token punctuation">)</span>  <span class="token comment"># 图像卷积</span>

    ret<span class="token punctuation">,</span> thresh <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>imgConv<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 图像二值化处理，得到掩模模板</span>
    imgTrack <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>target<span class="token punctuation">,</span> target<span class="token punctuation">,</span> mask<span class="token operator">=</span>thresh<span class="token punctuation">)</span>  <span class="token comment"># 以 thresh 为掩模按位与，显示查找区域</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">131</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>target<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"target image"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">132</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>thresh<span class="token punctuation">,</span> <span class="token string">'gray'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"tracking mask"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">133</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>imgTrack<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"tracking result"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<br> 
<p><img src="https://images2.imgbox.com/c6/10/qyr06JZR_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<br> 
<p><strong>版权声明：</strong></p> 
<p>注：本文中部分原始图片来自 Rafael C. Gonzalez “Digital Image Processing, 4th.Ed.” Fig3.10b，特此致谢。</p> 
<p><strong>欢迎关注<a href="https://blog.csdn.net/youcans/category_11031564.html">『Python 小白从零开始 OpenCV 学习课 @ youcans』</a> 原创作品</strong></p> 
<p>原创作品，转载必须标注原文链接：https://blog.csdn.net/youcans/article/details/121328057</p> 
<p>Copyright 2021 youcans, XUPT</p> 
<p>Crated：2021-11-18</p> 
<br> 
<blockquote> 
 <p><strong>欢迎关注 <a href="https://blog.csdn.net/youcans/category_11031564.html">『Python小白从零开始 OpenCV 学习课』</a> 系列，持续更新</strong></p> 
</blockquote> 
<p><a href="https://blog.csdn.net/youcans/article/details/120995650">Python 大白从零开始 OpenCV 学习课-1.安装与环境配置</a><br> <a href="https://blog.csdn.net/youcans/article/details/121068773">Python 大白从零开始 OpenCV 学习课-2.图像读取与显示</a><br> <a href="https://blog.csdn.net/youcans/article/details/121068795">Python 大白从零开始 OpenCV 学习课-3.图像的创建与修改</a><br> <a href="https://blog.csdn.net/youcans/article/details/121136047">Python 大白从零开始 OpenCV 学习课-4.图像的叠加与混合</a><br> <a href="https://blog.csdn.net/youcans/article/details/121288020">Python 大白从零开始 OpenCV 学习课-5.图像的几何变换</a><br> <a href="https://blog.csdn.net/youcans/article/details/121328057">Python 大白从零开始 OpenCV 学习课-6. 灰度变换与直方图处理</a></p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>