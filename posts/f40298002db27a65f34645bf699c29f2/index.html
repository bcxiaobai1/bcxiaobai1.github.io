<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>G0第25章：Gin框架进阶项目实战 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">G0第25章：Gin框架进阶项目实战</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <h1>
<a id="1_Gin_0"></a>1 Gin框架源码解析</h1> 
<p>通过阅读gin框架的源码来探究gin框架路由与中间件的秘密。</p> 
<h2>
<a id="11_Gin_2"></a>1.1 Gin框架路由详解</h2> 
<p>gin框架使用的是定制版本的httprouter，其路由的原理是大量使用公共前缀的树结构，它基本上是一个紧凑的Trie tree 或者只是（Radix Tree）。具有公共前缀的节点也共享一个公共父节点。</p> 
<h4>
<a id="Radix_Tree_4"></a>Radix Tree</h4> 
<p>基数树，由成为PAT位树，是一种更节省空间的前缀树。对于基数树的每个节点，如果该节点是唯一的子树的话，就和父节点合并。<br> <img src="https://images2.imgbox.com/68/98/jI3MtMDH_o.png" alt="请添加图片描述"><br> Radix Tree 可以被认为是一颗简洁版的前缀树。我们注册路由的过程就是构造前缀树的过程，具有公共前缀的节点也共享一个公共父节点。假设我们现在注册有以下路由信息：</p> 
<pre><code class="prism language-go">r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> func1<span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/search/"</span><span class="token punctuation">,</span> func2<span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/support/"</span><span class="token punctuation">,</span> func3<span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/blog/"</span><span class="token punctuation">,</span> func4<span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/blog/:post/"</span><span class="token punctuation">,</span> func5<span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/about-us/"</span><span class="token punctuation">,</span> func6<span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/about-us/team/"</span><span class="token punctuation">,</span> func7<span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/contact/"</span><span class="token punctuation">,</span> func8<span class="token punctuation">)</span>
</code></pre> 
<p>那么我们会得到一个GET方法对应的路由树，具体结构如下：</p> 
<pre><code class="prism language-shell">Priority   Path             Handle
<span class="token number">9</span>          <span class="token punctuation"></span>                *<span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token number">3</span>          ├s               nil
<span class="token number">2</span>          <span class="token operator">|</span>├earch<span class="token punctuation"></span>         *<span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
<span class="token number">1</span>          <span class="token operator">|</span>└upport<span class="token punctuation"></span>        *<span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">3</span>&gt;</span>
<span class="token number">2</span>          ├blog<span class="token punctuation"></span>           *<span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span>
<span class="token number">1</span>          <span class="token operator">|</span>    └:post      nil
<span class="token number">1</span>          <span class="token operator">|</span>         └<span class="token punctuation"></span>     *<span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">5</span>&gt;</span>
<span class="token number">2</span>          ├about-us<span class="token punctuation"></span>       *<span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span>
<span class="token number">1</span>          <span class="token operator">|</span>        └team<span class="token punctuation"></span>  *<span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span>
<span class="token number">1</span>          └contact<span class="token punctuation"></span>        *<span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">8</span>&gt;</span>
</code></pre> 
<p>上面最右边那一列每个*&lt;数字&gt;表示Handle处理函数的内存地址(一个指针)。从根节点遍历到叶子节点我们就能得到完整的路由表。<br> 例如：blog/:post其中:post只是实际文章名称的占位符(参数)。与hash-maps不同，<strong>这种树结构还允许我们使用像:post参数这种动态部分，因为我们实际上是根据路由模式进行匹配，而不仅仅是比较哈希值。</strong></p> 
<p>由于URL路径具有层次结构，并且只使用优先的一组字符（字节值），所以很可能有许多常见的前缀。这使得我们可以很容易的将路由简化为更小的问题。此外，<font color="red"> 路由器为每种请求方法管理一棵单独的树。 </font>一方面,它比在每个节点中都保存一个method-&gt; handle map 更加节省空间，它还使我们甚至可以在开始在前缀树中查找之前大大减少路由问题。</p> 
<p>为了获得更好的伸缩性，每个树级别上的子节点都按 Priority （优先级）排序，其中优先级（最左列）就是在子节点（子节点、子子节点等等）注册的句柄的数量。这样做有两个好处：</p> 
<ul>
<li>1、首先优先匹配被大多数路由路径包含的节点。这样可以让尽可能多的路由快速被定位；</li>
<li>2、类似于成本补偿。最长的路径可以被优先匹配，补偿体现在最长的路径需要花费更长的时间来定位，如果最长路径的节点能被优先匹配（即每次拿子节点都命中），那么路由匹配所花的时间不一定比短路径的路由长。<br> 节点匹配路径：从左到右、从上到下。（每个-可以看做一个节点）</li>
</ul> 
<pre><code class="prism language-shell">├------------
   ├---------
   ├-----
   ├----
   ├--
   ├--
   └-
</code></pre> 
<h4>
<a id="_52"></a>路由树节点</h4> 
<p>路由树是由一个个节点构成的，gin框架路由树的节点由 node 结构体表示，它有以下字段：</p> 
<pre><code class="prism language-go"><span class="token comment">// tree.go</span>

<span class="token keyword">type</span> node <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">// 节点路径，比如上面的s，earch，和upport</span>
	path      <span class="token builtin">string</span>
	<span class="token comment">// 和children字段对应, 保存的是分裂的分支的第一个字符</span>
	<span class="token comment">// 例如search和support, 那么s节点的indices对应的"eu"</span>
	<span class="token comment">// 代表有两个分支, 分支的首字母分别是e和u</span>
	indices   <span class="token builtin">string</span>
	<span class="token comment">// 儿子节点</span>
	children  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node
	<span class="token comment">// 处理函数链条（切片）</span>
	handlers  HandlersChain
	<span class="token comment">// 优先级，子节点、子子节点等注册的handler数量</span>
	priority  <span class="token builtin">uint32</span>
	<span class="token comment">// 节点类型，包括static, root, param, catchAll</span>
	<span class="token comment">// static: 静态节点（默认），比如上面的s，earch等节点</span>
	<span class="token comment">// root: 树的根节点</span>
	<span class="token comment">// catchAll: 有*匹配的节点</span>
	<span class="token comment">// param: 参数节点</span>
	nType     nodeType
	<span class="token comment">// 路径上最大参数个数</span>
	maxParams <span class="token builtin">uint8</span>
	<span class="token comment">// 节点是否是参数节点，比如上面的:post</span>
	wildChild <span class="token builtin">bool</span>
	<span class="token comment">// 完整路径</span>
	fullPath  <span class="token builtin">string</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4>
<a id="_85"></a>请求方法树</h4> 
<p>在gin的路由中，每一个 HTTP Method (GET、POST、PUT、DELETE…)都对应了一颗 radix tree ， 我们注册路由的时候会调用下面的 addRoute 函数</p> 
<pre><code class="prism language-go"><span class="token comment">// gin.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>engine <span class="token operator">*</span>Engine<span class="token punctuation">)</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handlers HandlersChain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">// liwenzhou.com...</span>
   
   <span class="token comment">// 获取请求方法对应的树</span>
	root <span class="token operator">:=</span> engine<span class="token punctuation">.</span>trees<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span>
	<span class="token keyword">if</span> root <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
	
	   <span class="token comment">// 如果没有就创建一个</span>
		root <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
		root<span class="token punctuation">.</span>fullPath <span class="token operator">=</span> <span class="token string">"/"</span>
		engine<span class="token punctuation">.</span>trees <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>engine<span class="token punctuation">.</span>trees<span class="token punctuation">,</span> methodTree<span class="token punctuation">{<!-- --></span>method<span class="token punctuation">:</span> method<span class="token punctuation">,</span> root<span class="token punctuation">:</span> root<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	root<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从上面的代码中我们可以看到在注册路由的时候都是先根据请求方法获取对应的树，也就是gin框架会为每一个请求方法创建一棵对应的树。只不过需要注意到一个细节是gin框架中保存请求方法对应树关系并不是使用的map而是使用的切片，engine.trees的类型是methodTrees，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> methodTree <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	method <span class="token builtin">string</span>
	root   <span class="token operator">*</span>node
<span class="token punctuation">}</span>

<span class="token keyword">type</span> methodTrees <span class="token punctuation">[</span><span class="token punctuation">]</span>methodTree  <span class="token comment">// slice</span>
</code></pre> 
<p>而获取请求方法对应树的get方法定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>trees methodTrees<span class="token punctuation">)</span> <span class="token function">get</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>node <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tree <span class="token operator">:=</span> <span class="token keyword">range</span> trees <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> tree<span class="token punctuation">.</span>method <span class="token operator">==</span> method <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> tree<span class="token punctuation">.</span>root
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6>
<a id="map___126"></a>为什么使用切片而不是map来存储 请求方法-&gt;树 的结构呢？</h6> 
<p><strong>GPT解答：</strong></p> 
<blockquote> 
 <blockquote> 
  <p>1、性能考虑：在某些情况下，遍历小型切片的性能可能优于在映射中查找键。尤其是在请求方法数量相对较少的情况下（比如HTTP有GET, POST, PUT, DELETE等方法），线性搜索切片可能比在哈希表（也就是map）中查找更快；<br> 2、内存占用：相较于map，切片通常会使用更少的内存。如果我们只需要存储少量的元素，那么切片可能会是更经济的选择；<br> 3、简单性：使用切片可能会让代码更加简洁易读。在这个函数中，我们可以直接使用一个for循环来查找匹配的元素。如果我们使用map，我们就需要处理map返回的第二个值，这个值用来表示键是否存在于map中；<br> 4、保持顺序：切片保持了元素的插入顺序，这在某些应用中可能是必需的。与此相反，map在Go语言中是无序的。</p> 
 </blockquote> 
</blockquote> 
<p>顺着这个思路，我们可以看一下gin框架中engine的初始化方法中，确实对tress字段做了一次内存申请：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Engine <span class="token punctuation">{<!-- --></span>
	<span class="token function">debugPrintWARNINGNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	engine <span class="token operator">:=</span> <span class="token operator">&amp;</span>Engine<span class="token punctuation">{<!-- --></span>
		RouterGroup<span class="token punctuation">:</span> RouterGroup<span class="token punctuation">{<!-- --></span>
			Handlers<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
			basePath<span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
			root<span class="token punctuation">:</span>     <span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token comment">// liwenzhou.com ...</span>
		<span class="token comment">// 初始化容量为9的切片（HTTP1.1请求方法共9种）</span>
		trees<span class="token punctuation">:</span>                  <span class="token function">make</span><span class="token punctuation">(</span>methodTrees<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token comment">// liwenzhou.com...</span>
	<span class="token punctuation">}</span>
	engine<span class="token punctuation">.</span>RouterGroup<span class="token punctuation">.</span>engine <span class="token operator">=</span> engine
	engine<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>New <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> engine<span class="token punctuation">.</span><span class="token function">allocateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> engine
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="_157"></a>注册路由</h4> 
<p><strong>注册路由的逻辑主要有addRoute函数和insertChild方法。</strong></p> 
<h6>
<a id="addRoute_159"></a>addRoute</h6> 
<pre><code class="prism language-go"><span class="token comment">// tree.go</span>

<span class="token comment">// addRoute 将具有给定句柄的节点添加到路径中。</span>
<span class="token comment">// 不是并发安全的</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handlers HandlersChain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	fullPath <span class="token operator">:=</span> path
	n<span class="token punctuation">.</span>priority<span class="token operator">++</span>
	numParams <span class="token operator">:=</span> <span class="token function">countParams</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>  <span class="token comment">// 数一下参数个数</span>

	<span class="token comment">// 空树就直接插入当前节点</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>numParams<span class="token punctuation">,</span> path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
		n<span class="token punctuation">.</span>nType <span class="token operator">=</span> root
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	parentFullPathIndex <span class="token operator">:=</span> <span class="token number">0</span>

walk<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 更新当前节点的最大参数个数</span>
		<span class="token keyword">if</span> numParams <span class="token operator">&gt;</span> n<span class="token punctuation">.</span>maxParams <span class="token punctuation">{<!-- --></span>
			n<span class="token punctuation">.</span>maxParams <span class="token operator">=</span> numParams
		<span class="token punctuation">}</span>

		<span class="token comment">// 找到最长的通用前缀</span>
		<span class="token comment">// 这也意味着公共前缀不包含“:”"或“*” /</span>
		<span class="token comment">// 因为现有键不能包含这些字符。</span>
		i <span class="token operator">:=</span> <span class="token function">longestCommonPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> n<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

		<span class="token comment">// 分裂边缘（此处分裂的是当前树节点）</span>
		<span class="token comment">// 例如一开始path是search，新加入support，s是他们通用的最长前缀部分</span>
		<span class="token comment">// 那么会将s拿出来作为parent节点，增加earch和upport作为child节点</span>
		<span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			child <span class="token operator">:=</span> node<span class="token punctuation">{<!-- --></span>
				path<span class="token punctuation">:</span>      n<span class="token punctuation">.</span>path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 公共前缀后的部分作为子节点</span>
				wildChild<span class="token punctuation">:</span> n<span class="token punctuation">.</span>wildChild<span class="token punctuation">,</span>
				indices<span class="token punctuation">:</span>   n<span class="token punctuation">.</span>indices<span class="token punctuation">,</span>
				children<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
				handlers<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>handlers<span class="token punctuation">,</span>
				priority<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>priority <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//子节点优先级-1</span>
				fullPath<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Update maxParams (max of all children)</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> child<span class="token punctuation">.</span>children <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> v<span class="token punctuation">.</span>maxParams <span class="token operator">&gt;</span> child<span class="token punctuation">.</span>maxParams <span class="token punctuation">{<!-- --></span>
					child<span class="token punctuation">.</span>maxParams <span class="token operator">=</span> v<span class="token punctuation">.</span>maxParams
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{<!-- --></span><span class="token operator">&amp;</span>child<span class="token punctuation">}</span>
			<span class="token comment">// []byte for proper unicode char conversion, see #65</span>
			n<span class="token punctuation">.</span>indices <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{<!-- --></span>n<span class="token punctuation">.</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>
			n<span class="token punctuation">.</span>handlers <span class="token operator">=</span> <span class="token boolean">nil</span>
			n<span class="token punctuation">.</span>wildChild <span class="token operator">=</span> <span class="token boolean">false</span>
			n<span class="token punctuation">.</span>fullPath <span class="token operator">=</span> fullPath<span class="token punctuation">[</span><span class="token punctuation">:</span>parentFullPathIndex<span class="token operator">+</span>i<span class="token punctuation">]</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 将新来的节点插入新的parent节点作为子节点</span>
		<span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			path <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>

			<span class="token keyword">if</span> n<span class="token punctuation">.</span>wildChild <span class="token punctuation">{<!-- --></span>  <span class="token comment">// 如果是参数节点</span>
				parentFullPathIndex <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
				n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
				n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

				<span class="token comment">// Update maxParams of the child node</span>
				<span class="token keyword">if</span> numParams <span class="token operator">&gt;</span> n<span class="token punctuation">.</span>maxParams <span class="token punctuation">{<!-- --></span>
					n<span class="token punctuation">.</span>maxParams <span class="token operator">=</span> numParams
				<span class="token punctuation">}</span>
				numParams<span class="token operator">--</span>

				<span class="token comment">// 检查通配符是否匹配</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 检查更长的通配符, 例如 :name and :names</span>
					<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'/'</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">continue</span> walk
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>

				pathSeg <span class="token operator">:=</span> path
				<span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">!=</span> catchAll <span class="token punctuation">{<!-- --></span>
					pathSeg <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">SplitN</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
				<span class="token punctuation">}</span>
				prefix <span class="token operator">:=</span> fullPath<span class="token punctuation">[</span><span class="token punctuation">:</span>strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> pathSeg<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>path
				<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"'"</span> <span class="token operator">+</span> pathSeg <span class="token operator">+</span>
					<span class="token string">"' in new path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span>
					<span class="token string">"' conflicts with existing wildcard '"</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>path <span class="token operator">+</span>
					<span class="token string">"' in existing prefix '"</span> <span class="token operator">+</span> prefix <span class="token operator">+</span>
					<span class="token string">"'"</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 取path首字母，用来与indices做比较</span>
			c <span class="token operator">:=</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

			<span class="token comment">// 处理参数后加斜线情况</span>
			<span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">==</span> param <span class="token operator">&amp;&amp;</span> c <span class="token operator">==</span> <span class="token char">'/'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
				parentFullPathIndex <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
				n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
				n<span class="token punctuation">.</span>priority<span class="token operator">++</span>
				<span class="token keyword">continue</span> walk
			<span class="token punctuation">}</span>

			<span class="token comment">// 检查路path下一个字节的子节点是否存在</span>
			<span class="token comment">// 比如s的子节点现在是earch和upport，indices为eu</span>
			<span class="token comment">// 如果新加一个路由为super，那么就是和upport有匹配的部分u，将继续分列现在的upport节点</span>
			<span class="token keyword">for</span> i<span class="token punctuation">,</span> max <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> c <span class="token operator">==</span> n<span class="token punctuation">.</span>indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
					parentFullPathIndex <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
					i <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
					n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
					<span class="token keyword">continue</span> walk
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 否则就插入</span>
			<span class="token keyword">if</span> c <span class="token operator">!=</span> <span class="token char">':'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">!=</span> <span class="token char">'*'</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// []byte for proper unicode char conversion, see #65</span>
				<span class="token comment">// 注意这里是直接拼接第一个字符到n.indices</span>
				n<span class="token punctuation">.</span>indices <span class="token operator">+=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{<!-- --></span>c<span class="token punctuation">}</span><span class="token punctuation">)</span>
				child <span class="token operator">:=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{<!-- --></span>
					maxParams<span class="token punctuation">:</span> numParams<span class="token punctuation">,</span>
					fullPath<span class="token punctuation">:</span>  fullPath<span class="token punctuation">,</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 追加子节点</span>
				n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">,</span> child<span class="token punctuation">)</span>
				n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
				n <span class="token operator">=</span> child
			<span class="token punctuation">}</span>
			n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>numParams<span class="token punctuation">,</span> path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 已经注册过的节点</span>
		<span class="token keyword">if</span> n<span class="token punctuation">.</span>handlers <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"handlers are already registered for path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>handlers <span class="token operator">=</span> handlers
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其实上面的代码很好理解，大家可以参照动画尝试将以下情形代入上面的代码逻辑，体味整个路由树构造的详细过程：</p> 
<p>第一次注册路由，例如注册search<br> 继续注册一条没有公共前缀的路由，例如blog<br> 注册一条与先前注册的路由有公共前缀的路由，例如support</p> 
<p><img src="https://images2.imgbox.com/d2/df/L5f2oA8N_o.png" alt="请添加图片描述"></p> 
<h4>
<a id="insertChild_313"></a>insertChild</h4> 
<pre><code class="prism language-go"><span class="token comment">// tree.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">insertChild</span><span class="token punctuation">(</span>numParams <span class="token builtin">uint8</span><span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> fullPath <span class="token builtin">string</span><span class="token punctuation">,</span> handlers HandlersChain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 找到所有的参数</span>
	<span class="token keyword">for</span> numParams <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 查找前缀直到第一个通配符</span>
		wildcard<span class="token punctuation">,</span> i<span class="token punctuation">,</span> valid <span class="token operator">:=</span> <span class="token function">findWildcard</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 没有发现通配符</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 通配符的名称必须包含':' 和 '*'</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>valid <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"only one wildcard per path segment is allowed, has: '"</span> <span class="token operator">+</span>
				wildcard <span class="token operator">+</span> <span class="token string">"' in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 检查通配符是否有名称</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"wildcards must be named with a non-empty name in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 检查这个节点是否有已经存在的子节点</span>
		<span class="token comment">// 如果我们在这里插入通配符，这些子节点将无法访问</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"wildcard segment '"</span> <span class="token operator">+</span> wildcard <span class="token operator">+</span>
				<span class="token string">"' conflicts with existing children in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> wildcard<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">':'</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// param</span>
			<span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 在当前通配符之前插入前缀</span>
				n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>
				path <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span>

			n<span class="token punctuation">.</span>wildChild <span class="token operator">=</span> <span class="token boolean">true</span>
			child <span class="token operator">:=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{<!-- --></span>
				nType<span class="token punctuation">:</span>     param<span class="token punctuation">,</span>
				path<span class="token punctuation">:</span>      wildcard<span class="token punctuation">,</span>
				maxParams<span class="token punctuation">:</span> numParams<span class="token punctuation">,</span>
				fullPath<span class="token punctuation">:</span>  fullPath<span class="token punctuation">,</span>
			<span class="token punctuation">}</span>
			n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{<!-- --></span>child<span class="token punctuation">}</span>
			n <span class="token operator">=</span> child
			n<span class="token punctuation">.</span>priority<span class="token operator">++</span>
			numParams<span class="token operator">--</span>

			<span class="token comment">// 如果路径没有以通配符结束</span>
			<span class="token comment">// 那么将有另一个以'/'开始的非通配符子路径。</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

				child <span class="token operator">:=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{<!-- --></span>
					maxParams<span class="token punctuation">:</span> numParams<span class="token punctuation">,</span>
					priority<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>
					fullPath<span class="token punctuation">:</span>  fullPath<span class="token punctuation">,</span>
				<span class="token punctuation">}</span>
				n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{<!-- --></span>child<span class="token punctuation">}</span>
				n <span class="token operator">=</span> child  <span class="token comment">// 继续下一轮循环</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 否则我们就完成了。将处理函数插入新叶子中</span>
			n<span class="token punctuation">.</span>handlers <span class="token operator">=</span> handlers
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// catchAll</span>
		<span class="token keyword">if</span> i<span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> numParams <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"catch-all routes are only allowed at the end of the path in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'/'</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"catch-all conflicts with existing handle for the path segment root in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// currently fixed width 1 for '/'</span>
		i<span class="token operator">--</span>
		<span class="token keyword">if</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'/'</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"no / before catch-all in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>
		
		<span class="token comment">// 第一个节点:路径为空的catchAll节点</span>
		child <span class="token operator">:=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{<!-- --></span>
			wildChild<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			nType<span class="token punctuation">:</span>     catchAll<span class="token punctuation">,</span>
			maxParams<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
			fullPath<span class="token punctuation">:</span>  fullPath<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 更新父节点的maxParams</span>
		<span class="token keyword">if</span> n<span class="token punctuation">.</span>maxParams <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
			n<span class="token punctuation">.</span>maxParams <span class="token operator">=</span> <span class="token number">1</span>
		<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{<!-- --></span>child<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>indices <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">)</span>
		n <span class="token operator">=</span> child
		n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

		<span class="token comment">// 第二个节点:保存变量的节点</span>
		child <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{<!-- --></span>
			path<span class="token punctuation">:</span>      path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			nType<span class="token punctuation">:</span>     catchAll<span class="token punctuation">,</span>
			maxParams<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
			handlers<span class="token punctuation">:</span>  handlers<span class="token punctuation">,</span>
			priority<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>
			fullPath<span class="token punctuation">:</span>  fullPath<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{<!-- --></span>child<span class="token punctuation">}</span>

		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 如果没有找到通配符，只需插入路径和句柄</span>
	n<span class="token punctuation">.</span>path <span class="token operator">=</span> path
	n<span class="token punctuation">.</span>handlers <span class="token operator">=</span> handlers
	n<span class="token punctuation">.</span>fullPath <span class="token operator">=</span> fullPath
<span class="token punctuation">}</span>
</code></pre> 
<p>insertChild 函数是根据path本身进行分割，将/分开的部分分别作为节点保存，形成一棵树结构。参数匹配中的:和*的区别是，前者是匹配一个字段而后者是匹配后面所有的路径。</p> 
<h4>
<a id="_438"></a>路由匹配</h4> 
<p>我们先来看gin框架处理请求的入口函数ServeHTTP：</p> 
<pre><code class="prism language-go"><span class="token comment">// gin.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>engine <span class="token operator">*</span>Engine<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 这里使用了对象池</span>
	c <span class="token operator">:=</span> engine<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Context<span class="token punctuation">)</span>
  <span class="token comment">// 这里有一个细节就是Get对象后做初始化</span>
	c<span class="token punctuation">.</span>writermem<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>Request <span class="token operator">=</span> req
	c<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	engine<span class="token punctuation">.</span><span class="token function">handleHTTPRequest</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>  <span class="token comment">// 我们要找的处理HTTP请求的函数</span>

	engine<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>  <span class="token comment">// 处理完请求后将对象放回池子</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数很长，这里省略了部分代码，只保留相关逻辑代码：</p> 
<pre><code class="prism language-go"><span class="token comment">// gin.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>engine <span class="token operator">*</span>Engine<span class="token punctuation">)</span> <span class="token function">handleHTTPRequest</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// liwenzhou.com...</span>

	<span class="token comment">// 根据请求方法找到对应的路由树</span>
	t <span class="token operator">:=</span> engine<span class="token punctuation">.</span>trees
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> tl <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tl<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>method <span class="token operator">!=</span> httpMethod <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		root <span class="token operator">:=</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>root
		<span class="token comment">// 在路由树中根据path查找</span>
		value <span class="token operator">:=</span> root<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>rPath<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Params<span class="token punctuation">,</span> unescape<span class="token punctuation">)</span>
		<span class="token keyword">if</span> value<span class="token punctuation">.</span>handlers <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			c<span class="token punctuation">.</span>handlers <span class="token operator">=</span> value<span class="token punctuation">.</span>handlers
			c<span class="token punctuation">.</span>Params <span class="token operator">=</span> value<span class="token punctuation">.</span>params
			c<span class="token punctuation">.</span>fullPath <span class="token operator">=</span> value<span class="token punctuation">.</span>fullPath
			c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 执行函数链条</span>
			c<span class="token punctuation">.</span>writermem<span class="token punctuation">.</span><span class="token function">WriteHeaderNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	
	<span class="token comment">// liwenzhou.com...</span>
	c<span class="token punctuation">.</span>handlers <span class="token operator">=</span> engine<span class="token punctuation">.</span>allNoRoute
	<span class="token function">serveError</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> default404Body<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>路由匹配是由节点的 getValue 方法实现的。getValue 根据给定的路径（键）返回 nodeValue 值，保存注册的处理函数和匹配到的路径参数数据。如果找不到任何处理函数，则会尝试TS(尾随斜杠重定向)。代码虽然很长，但还算比较工整。<br> 大家可以借助注释看一下路由查找及参数匹配的逻辑。</p> 
<pre><code class="prism language-go"><span class="token comment">// tree.go</span>

<span class="token keyword">type</span> nodeValue <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	handlers HandlersChain
	params   Params  <span class="token comment">// []Param</span>
	tsr      <span class="token builtin">bool</span>
	fullPath <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// liwenzhou.com...</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">getValue</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> po Params<span class="token punctuation">,</span> unescape <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>value nodeValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	value<span class="token punctuation">.</span>params <span class="token operator">=</span> po
walk<span class="token punctuation">:</span> <span class="token comment">// Outer loop for walking the tree</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		prefix <span class="token operator">:=</span> n<span class="token punctuation">.</span>path
		<span class="token keyword">if</span> path <span class="token operator">==</span> prefix <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 我们应该已经到达包含处理函数的节点。</span>
			<span class="token comment">// 检查该节点是否注册有处理函数</span>
			<span class="token keyword">if</span> value<span class="token punctuation">.</span>handlers <span class="token operator">=</span> n<span class="token punctuation">.</span>handlers<span class="token punctuation">;</span> value<span class="token punctuation">.</span>handlers <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				value<span class="token punctuation">.</span>fullPath <span class="token operator">=</span> n<span class="token punctuation">.</span>fullPath
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">if</span> path <span class="token operator">==</span> <span class="token string">"/"</span> <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>wildChild <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>nType <span class="token operator">!=</span> root <span class="token punctuation">{<!-- --></span>
				value<span class="token punctuation">.</span>tsr <span class="token operator">=</span> <span class="token boolean">true</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 没有找到处理函数 检查这个路径末尾+/ 是否存在注册函数</span>
			indices <span class="token operator">:=</span> n<span class="token punctuation">.</span>indices
			<span class="token keyword">for</span> i<span class="token punctuation">,</span> max <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'/'</span> <span class="token punctuation">{<!-- --></span>
					n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
					value<span class="token punctuation">.</span>tsr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>handlers <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token operator">||</span>
						<span class="token punctuation">(</span>n<span class="token punctuation">.</span>nType <span class="token operator">==</span> catchAll <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>handlers <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token function">len</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> prefix <span class="token punctuation">{<!-- --></span>
			path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token comment">// 如果该节点没有通配符(param或catchAll)子节点</span>
			<span class="token comment">// 我们可以继续查找下一个子节点</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>n<span class="token punctuation">.</span>wildChild <span class="token punctuation">{<!-- --></span>
				c <span class="token operator">:=</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
				indices <span class="token operator">:=</span> n<span class="token punctuation">.</span>indices
				<span class="token keyword">for</span> i<span class="token punctuation">,</span> max <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> c <span class="token operator">==</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
						n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">// 遍历树</span>
						<span class="token keyword">continue</span> walk
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// 没找到</span>
				<span class="token comment">// 如果存在一个相同的URL但没有末尾/的叶子节点</span>
				<span class="token comment">// 我们可以建议重定向到那里</span>
				value<span class="token punctuation">.</span>tsr <span class="token operator">=</span> path <span class="token operator">==</span> <span class="token string">"/"</span> <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>handlers <span class="token operator">!=</span> <span class="token boolean">nil</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 根据节点类型处理通配符子节点</span>
			n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
			<span class="token keyword">switch</span> n<span class="token punctuation">.</span>nType <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> param<span class="token punctuation">:</span>
				<span class="token comment">// find param end (either '/' or path end)</span>
				end <span class="token operator">:=</span> <span class="token number">0</span>
				<span class="token keyword">for</span> end <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">[</span>end<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'/'</span> <span class="token punctuation">{<!-- --></span>
					end<span class="token operator">++</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// 保存通配符的值</span>
				<span class="token keyword">if</span> <span class="token function">cap</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>maxParams<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					value<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span>Params<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span>maxParams<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
				value<span class="token punctuation">.</span>params <span class="token operator">=</span> value<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">// 在预先分配的容量内扩展slice</span>
				value<span class="token punctuation">.</span>params<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Key <span class="token operator">=</span> n<span class="token punctuation">.</span>path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
				val <span class="token operator">:=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>end<span class="token punctuation">]</span>
				<span class="token keyword">if</span> unescape <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">var</span> err <span class="token builtin">error</span>
					<span class="token keyword">if</span> value<span class="token punctuation">.</span>params<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">,</span> err <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">QueryUnescape</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
						value<span class="token punctuation">.</span>params<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> val <span class="token comment">// fallback, in case of error</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					value<span class="token punctuation">.</span>params<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> val
				<span class="token punctuation">}</span>

				<span class="token comment">// 继续向下查询</span>
				<span class="token keyword">if</span> end <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
						path <span class="token operator">=</span> path<span class="token punctuation">[</span>end<span class="token punctuation">:</span><span class="token punctuation">]</span>
						n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
						<span class="token keyword">continue</span> walk
					<span class="token punctuation">}</span>

					<span class="token comment">// ... but we can't</span>
					value<span class="token punctuation">.</span>tsr <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">==</span> end<span class="token operator">+</span><span class="token number">1</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">if</span> value<span class="token punctuation">.</span>handlers <span class="token operator">=</span> n<span class="token punctuation">.</span>handlers<span class="token punctuation">;</span> value<span class="token punctuation">.</span>handlers <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
					value<span class="token punctuation">.</span>fullPath <span class="token operator">=</span> n<span class="token punctuation">.</span>fullPath
					<span class="token keyword">return</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 没有找到处理函数. 检查此路径末尾加/的路由是否存在注册函数</span>
					<span class="token comment">// 用于 TSR 推荐</span>
					n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
					value<span class="token punctuation">.</span>tsr <span class="token operator">=</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">"/"</span> <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>handlers <span class="token operator">!=</span> <span class="token boolean">nil</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span>

			<span class="token keyword">case</span> catchAll<span class="token punctuation">:</span>
				<span class="token comment">// 保存通配符的值</span>
				<span class="token keyword">if</span> <span class="token function">cap</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>maxParams<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					value<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span>Params<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span>maxParams<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
				value<span class="token punctuation">.</span>params <span class="token operator">=</span> value<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">// 在预先分配的容量内扩展slice</span>
				value<span class="token punctuation">.</span>params<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Key <span class="token operator">=</span> n<span class="token punctuation">.</span>path<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
				<span class="token keyword">if</span> unescape <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">var</span> err <span class="token builtin">error</span>
					<span class="token keyword">if</span> value<span class="token punctuation">.</span>params<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">,</span> err <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">QueryUnescape</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
						value<span class="token punctuation">.</span>params<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> path <span class="token comment">// fallback, in case of error</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					value<span class="token punctuation">.</span>params<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> path
				<span class="token punctuation">}</span>

				value<span class="token punctuation">.</span>handlers <span class="token operator">=</span> n<span class="token punctuation">.</span>handlers
				value<span class="token punctuation">.</span>fullPath <span class="token operator">=</span> n<span class="token punctuation">.</span>fullPath
				<span class="token keyword">return</span>

			<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"invalid node type"</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 找不到，如果存在一个在当前路径最后添加/的路由</span>
		<span class="token comment">// 我们会建议重定向到那里</span>
		value<span class="token punctuation">.</span>tsr <span class="token operator">=</span> <span class="token punctuation">(</span>path <span class="token operator">==</span> <span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">||</span>
			<span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> prefix<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'/'</span> <span class="token operator">&amp;&amp;</span>
				path <span class="token operator">==</span> prefix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>handlers <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h1>
<a id="12_Gin_641"></a>1.2 Gin框架中间件详解</h1> 
<p>gin框架涉及中间件相关有4个常用的方法，它们分别是c.Next()、c.Abort()、c.Set()、c.Get()。</p> 
<h4>
<a id="_644"></a>中间件的注册</h4> 
<p>gin框架中的中间件设计很巧妙，我们可以首先从我们最常用的r := gin.Default()的Default函数开始看，它内部构造一个新的engine之后就通过Use()函数注册了Logger中间件和Recovery中间件：</p> 
<pre><code class="prism language-go">
<span class="token keyword">func</span> <span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Engine <span class="token punctuation">{<!-- --></span>
	<span class="token function">debugPrintWARNINGDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	engine <span class="token operator">:=</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	engine<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Recovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 默认注册的两个中间件</span>
	<span class="token keyword">return</span> engine
<span class="token punctuation">}</span>
</code></pre> 
<p>继续往下查看一下Use()函数的代码：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>engine <span class="token operator">*</span>Engine<span class="token punctuation">)</span> <span class="token function">Use</span><span class="token punctuation">(</span>middleware <span class="token operator">...</span>HandlerFunc<span class="token punctuation">)</span> IRoutes <span class="token punctuation">{<!-- --></span>
	engine<span class="token punctuation">.</span>RouterGroup<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token operator">...</span><span class="token punctuation">)</span>  <span class="token comment">// 实际上还是调用的RouterGroup的Use函数</span>
	engine<span class="token punctuation">.</span><span class="token function">rebuild404Handlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	engine<span class="token punctuation">.</span><span class="token function">rebuild405Handlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> engine
<span class="token punctuation">}</span>
</code></pre> 
<p>从下方的代码可以看出，注册中间件其实就是将中间件函数追加到group.Handlers中：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>group <span class="token operator">*</span>RouterGroup<span class="token punctuation">)</span> <span class="token function">Use</span><span class="token punctuation">(</span>middleware <span class="token operator">...</span>HandlerFunc<span class="token punctuation">)</span> IRoutes <span class="token punctuation">{<!-- --></span>
	group<span class="token punctuation">.</span>Handlers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>group<span class="token punctuation">.</span>Handlers<span class="token punctuation">,</span> middleware<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> group<span class="token punctuation">.</span><span class="token function">returnObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而我们注册路由时会将对应路由的函数和之前的中间件函数结合到一起：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>group <span class="token operator">*</span>RouterGroup<span class="token punctuation">)</span> <span class="token function">handle</span><span class="token punctuation">(</span>httpMethod<span class="token punctuation">,</span> relativePath <span class="token builtin">string</span><span class="token punctuation">,</span> handlers HandlersChain<span class="token punctuation">)</span> IRoutes <span class="token punctuation">{<!-- --></span>
	absolutePath <span class="token operator">:=</span> group<span class="token punctuation">.</span><span class="token function">calculateAbsolutePath</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span>
	handlers <span class="token operator">=</span> group<span class="token punctuation">.</span><span class="token function">combineHandlers</span><span class="token punctuation">(</span>handlers<span class="token punctuation">)</span>  <span class="token comment">// 将处理请求的函数与中间件函数结合</span>
	group<span class="token punctuation">.</span>engine<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>httpMethod<span class="token punctuation">,</span> absolutePath<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
	<span class="token keyword">return</span> group<span class="token punctuation">.</span><span class="token function">returnObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中结合操作的函数内容如下，注意观察这里是如何实现拼接两个切片得到一个新切片的。</p> 
<pre><code class="prism language-go"><span class="token keyword">const</span> abortIndex <span class="token builtin">int8</span> <span class="token operator">=</span> math<span class="token punctuation">.</span>MaxInt8 <span class="token operator">/</span> <span class="token number">2</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>group <span class="token operator">*</span>RouterGroup<span class="token punctuation">)</span> <span class="token function">combineHandlers</span><span class="token punctuation">(</span>handlers HandlersChain<span class="token punctuation">)</span> HandlersChain <span class="token punctuation">{<!-- --></span>
	finalSize <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>group<span class="token punctuation">.</span>Handlers<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>handlers<span class="token punctuation">)</span>
	<span class="token keyword">if</span> finalSize <span class="token operator">&gt;=</span> <span class="token function">int</span><span class="token punctuation">(</span>abortIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">// 这里有一个最大限制</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"too many handlers"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	mergedHandlers <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>HandlersChain<span class="token punctuation">,</span> finalSize<span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>mergedHandlers<span class="token punctuation">,</span> group<span class="token punctuation">.</span>Handlers<span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>mergedHandlers<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>group<span class="token punctuation">.</span>Handlers<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
	<span class="token keyword">return</span> mergedHandlers
<span class="token punctuation">}</span>
</code></pre> 
<p>也就是说，我们会将一个路由的中间件函数和处理函数结合到一起组成一条处理函数链条HandlersChain，而它本质上就是一个由HandlerFunc组成的切片：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> HandlersChain <span class="token punctuation">[</span><span class="token punctuation">]</span>HandlerFunc
</code></pre> 
<p><img src="https://images2.imgbox.com/fa/af/x4QYqr4e_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/14/92/bwaHHxSI_o.png" alt="请添加图片描述"></p> 
<h4>
<a id="_701"></a>中间件的执行</h4> 
<p>我们在上面路由匹配的时候见过如下逻辑：</p> 
<pre><code class="prism language-go">value <span class="token operator">:=</span> root<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>rPath<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Params<span class="token punctuation">,</span> unescape<span class="token punctuation">)</span>
<span class="token keyword">if</span> value<span class="token punctuation">.</span>handlers <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
  c<span class="token punctuation">.</span>handlers <span class="token operator">=</span> value<span class="token punctuation">.</span>handlers
  c<span class="token punctuation">.</span>Params <span class="token operator">=</span> value<span class="token punctuation">.</span>params
  c<span class="token punctuation">.</span>fullPath <span class="token operator">=</span> value<span class="token punctuation">.</span>fullPath
  c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 执行函数链条</span>
  c<span class="token punctuation">.</span>writermem<span class="token punctuation">.</span><span class="token function">WriteHeaderNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中c.Next()就是很关键的一步，它的代码很简单：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	c<span class="token punctuation">.</span>index<span class="token operator">++</span>
	<span class="token keyword">for</span> c<span class="token punctuation">.</span>index <span class="token operator">&lt;</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>handlers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>c<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>index<span class="token operator">++</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从上面的代码可以看到，这里通过索引遍历HandlersChain链条，从而实现依次调用该路由的每一个函数（中间件或处理请求的函数）。</p> 
<p><img src="https://images2.imgbox.com/a1/b8/UT8kkJw7_o.png" alt="请添加图片描述"><br> 我们可以在中间件函数中通过再次调用c。Next()实现嵌套调用(funcl中调用func2；func2中调用func3)，</p> 
<p><img src="https://images2.imgbox.com/1c/a2/IxrhsGQi_o.png" alt="请添加图片描述"><br> 或者通过调用c.Abort()中断整个调用链条，从当前函数返回。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	c<span class="token punctuation">.</span>index <span class="token operator">=</span> abortIndex  <span class="token comment">// 直接将索引置为最大限制值，从而退出循环</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="cSetcGet_737"></a>c.Set()/c.Get()</h4> 
<p>c.Set()和c.Get()这两个方法多用于在多个函数之间通过c传递数据的，比如我们可以在认证中间件中获取当前请求的相关信息（userID等）通过c.Set()存入c，然后在后续处理业务逻辑的函数中通过c.Get()来获取当前请求的用户。c就像是一根绳子，将该次请求相关的所有的函数都串起来了<br> <img src="https://images2.imgbox.com/d3/b3/9ReXqEsT_o.png" alt="请添加图片描述"></p> 
<h4>
<a id="_740"></a>总结</h4> 
<ul>
<li>1、gin框架路由使用前缀树，路由注册的过程是构造前缀树的过程，路由匹配的过程就是查找前缀树的过程</li>
<li>2、gin框架的中间件函数和处理函数是以切片形式的调用链条存在的，我们可以顺序调用也可以借助c.Next()方法实现嵌套调用</li>
<li>3、借助c.Set()和c.Get()方法我们能够在不同的中间件函数中传递数据。</li>
</ul> 
<hr> 
<h1>
<a id="2_GoMySQLRedis_746"></a>2 Go连接MySQL/Redis</h1> 
<p>Go语言中的 database/sql 包提供了保证SQL或类SQL数据库的泛用接口，并不提供具体的数据库驱动。使用 database/sql 包时必须注入至少一个数据库驱动。</p> 
<p>我们常用的数据库基本上都有完整的第三方实现：例如：MySQL驱动https://github.com/go-sql-driver/mysql</p> 
<h2>
<a id="21_databasesqlsqx_751"></a>2.1 database/sql及sqx使用</h2> 
<h4>
<a id="_752"></a>下载依赖</h4> 
<pre><code class="prism language-shell">go get -u github.com/go-sql-driver/mysql
</code></pre> 
<h4>
<a id="MySQL_756"></a>使用MySQL驱动</h4> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">Open</span><span class="token punctuation">(</span>driverName<span class="token punctuation">,</span> dataSourceName <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<p>Open打开一个dirverName指定的数据库，dataSourceName指定数据源，一般至少包括数据库文件名和其它连接必要的信息。</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"database/sql"</span>

	<span class="token boolean">_</span> <span class="token string">"github.com/go-sql-driver/mysql"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">// DSN:Data Source Name</span>
	dsn <span class="token operator">:=</span> <span class="token string">"user:password@tcp(127.0.0.1:3306)/dbname"</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> dsn<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 注意这行代码要写在上面err判断的下面</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6>
<a id="_defer_dbCloseif_err__nil_778"></a>思考题： 为什么上面代码中的defer db.Close()语句不应该写在if err != nil的前面呢？</h6> 
<h6>
<a id="defer_dbClosedsndbnildefer_dbClosepanic_779"></a>假如defer db.Close()在其前边，那么假如输入的dsn是错误的，db将会直接返回一个nil，而对于defer db.Close()将会panic，就不会执行到错误处理。</h6> 
<h4>
<a id="_780"></a>初始化连接</h4> 
<p>Open函数可能只是验证其参数格式是否正确，实际上并不创建与数据库的连接。如果要检查数据源的名称是否真实有效，应该调用panic方法。<br> 返回的DB对象可以安全地被多个goroutine并发使用，并且维护其自己的空闲连接池。因此，open函数应该仅仅被调用一次，很少需要关闭这个DB对象。<br> 接下来，我们定义一个全局的变量 db，用来保存数据库连接对象。将上面的示例代码拆分出一个独立的initDB函数，只需要在程序启动时调用一次该函数完成全局变量db的初始化，其他函数就可以直接使用全局变量db 了。</p> 
<pre><code class="prism language-go"><span class="token comment">// 定义一个全局对象db</span>
<span class="token keyword">var</span> db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB

<span class="token comment">// 定义一个初始化数据库的函数</span>
<span class="token keyword">func</span> <span class="token function">initDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// DSN:Data Source Name</span>
	dsn <span class="token operator">:=</span> <span class="token string">"user:password@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&amp;parseTime=True"</span>
	<span class="token comment">// 不会校验账号密码是否正确</span>
	<span class="token comment">// 注意！！！这里不要使用:=，我们是给全局变量赋值，然后在main函数中使用全局变量db</span>
	db<span class="token punctuation">,</span> err <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> dsn<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// 尝试与数据库建立连接（校验dsn是否正确）</span>
	err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	err <span class="token operator">:=</span> <span class="token function">initDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 调用输出化数据库的函数</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"init db failed,err:%vn"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中sql.DB是表示连接的数据库对象（结构体实例），它保存了连接数据库相关的所有信息。内部维护着一个具有零到多个底层连接的连接池，它可以安全地被多个goroutine同时使用。</p> 
<h4>
<a id="SetMaxOpenConns_815"></a>SetMaxOpenConns</h4> 
<p>func (db *DB) SetMaxOpenConns(n int)<br> 设置与数据库建立连接的最大数目。如果n大于0且小于最大闲置连接数，会将最大闲置连接数减小到匹配最大开启连接数的限制。如果n&lt;=0，不会限制最大开启连接数，默认为0（无限制）。</p> 
<h4>
<a id="SetMaxIdleConns_818"></a>SetMaxIdleConns</h4> 
<p>func(db *DB)SetMaxIdleConns(n int)<br> 设置连接池中的最大限制连接数。如果n大于最大开启连接数，则新的最大闲置连接数会减小到匹配最大开启连接数的限制。如果n&lt;=0，不会保留闲置连接。</p> 
<p><img src="https://images2.imgbox.com/d0/c3/DD9wdGxm_o.png" alt="请添加图片描述"></p> 
<hr> 
<h2>
<a id="22_goredis_827"></a>2.2 go-redis库使用</h2> 
<hr> 
<h1>
<a id="3_Go_Web_835"></a>3 搭建Go Web开发脚手架</h1> 
<h2>
<a id="31_zap_837"></a>3.1 zap日志库使用</h2> 
<h2>
<a id="32_Viperi_838"></a>3.2 Viperi配置管理库使用</h2> 
<h2>
<a id="33__839"></a>3.3 优雅关机与平滑重启</h2> 
<h2>
<a id="34_CLD_840"></a>3.4 CLD代码分层</h2> 
<hr> 
<h1>
<a id="4_bluebellReddit_850"></a>4 bluebell项目实战(仿Reddit论坛项目)</h1> 
<h2>
<a id="41_1D_852"></a>4.1 分布式1D生成</h2> 
<h2>
<a id="42_JWT_853"></a>4.2 JWT认证</h2> 
<h2>
<a id="43_MySQL_854"></a>4.3 基于MySQL实现主业务</h2> 
<h2>
<a id="44_Redis_855"></a>4.4 基于Redis实现投票业务</h2> 
<h2>
<a id="45_Docker_856"></a>4.5 基于Docker搭建开发环境</h2> 
<h2>
<a id="46__857"></a>4.6 代码发布与项目部署</h2> 
<h2>
<a id="47__858"></a>4.7 多到写不下的实战经验与技巧…</h2>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>