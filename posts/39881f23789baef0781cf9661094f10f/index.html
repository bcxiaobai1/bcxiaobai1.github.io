<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>用Python做了个图片识别系统(附源码) - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">用Python做了个图片识别系统(附源码)</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <p>本项目将使用python3去识别图片是否为色情图片，会使用到PIL这个图像处理库，并且编写算法来划分图像的皮肤区域</p> 
<h2>
<a id="PIL_3"></a>介绍一下PIL：</h2> 
<p>PIL（Python Image Library）是一种免费的图像处理工具包，这个软件包提供了基本的图像处理功能，如：改变图像大小，旋转</p> 
<p>图像，图像格式转化，色场空间转换（这个我不太懂），图像增强（就是改善清晰度，突出图像有用信息），直方图处理，插值</p> 
<p>（利用已知邻近像素点的灰度值来产生未知像素点的灰度值）和滤波等等。虽然这个软件包要实现复杂的图像处理算法并不太适</p> 
<p>合，但是python的快速开发能力以及面向对象等等诸多特点使得它非常适合用来进行原型开发。</p> 
<p>在 PIL 中，任何一副图像都是用一个 Image 对象表示，而这个类由和它同名的模块导出，因此，要加载一副图像，最简单的形式</p> 
<p>是这样的：<br> <img src="https://images2.imgbox.com/79/01/Uttr8gw8_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> Image
img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>“dip<span class="token punctuation">.</span>jpg”<span class="token punctuation">)</span>
</code></pre> 
<p>注意：<mark>第一行的 Image 是模块名；第二行的 img 是一个 Image 对象；</mark> Image 类是在 Image 模块中定义的。关于 Image 模</p> 
<p>块和 Image 类，切记不要混淆了。现在，我们就可以对 img 进行各种操作了，所有对 img 的 操作最终都会反映到到 dip.img 图</p> 
<p>像上</p> 
<h2>
<a id="_30"></a>环境准备</h2> 
<p>PIL 2009 年之后就没有更新了，也不支持 Python3 ，于是有了 Alex Clark 领导的公益项目 Pillow 。Pillow 是一个对 PIL 友好的分</p> 
<p>支，支持 Python3，所以我们这里安装的是 Pillow，这是它的官方文档。</p> 
<p>默认已经有python3.0以上和包管理工具pip3。那要执行如下命令升级pip3并安装Pillow 工具包：</p> 
<pre><code class="prism language-python">sudo install <span class="token operator">-</span>U pip3
sudo install Pillow
</code></pre> 
<h2>
<a id="_43"></a>程序原理</h2> 
<p>根据颜色（肤色）找出图片中皮肤的区域，然后通过一些条件判断是否为色情图片。</p> 
<p>程序的关键步骤如下：</p> 
<pre><code class="prism language-python">python学习交流Q群：<span class="token number">906715085</span><span class="token comment">####</span>
<span class="token number">1.</span>遍历每个像素，检查像素颜色是否为肤色


<span class="token number">2.</span>将相邻的肤色像素归为一个皮肤区域，得到若干个皮肤区域


<span class="token number">3.</span>剔除像素数量极少的皮肤区域
</code></pre> 
<p>我们定义非色情图片的判定规则如下（满足任意一个判断为真）：</p> 
<pre><code class="prism language-python"><span class="token number">1.</span>皮肤区域的个数小于<span class="token number">3</span>个


<span class="token number">2.</span>皮肤区域的像素与图像所有像素的比值小于<span class="token number">15</span><span class="token operator">%</span>


<span class="token number">3.</span>最大皮肤区域小于总皮肤面积的<span class="token number">45</span><span class="token operator">%</span>


<span class="token number">4.</span>皮肤区域数量超过<span class="token number">60</span>个
</code></pre> 
<p>这些规则你可以尝试更改，直到程序效果让自己满意为止。关于像素肤色判定这方面，公式可以在网上找到很多，但是世界上不</p> 
<p>可能有正确率100%的公式。你可以用自己找到的公式，在程序完成后慢慢调试。</p> 
<p><img src="https://images2.imgbox.com/a1/5d/VoGZ5LQw_o.png" alt="在这里插入图片描述"></p> 
<p>•RGB颜色模式</p> 
<pre><code class="prism language-python">第一种：<span class="token operator">==</span>r <span class="token operator">&gt;</span> <span class="token number">95</span> <span class="token keyword">and</span> g <span class="token operator">&gt;</span> <span class="token number">40</span> <span class="token keyword">and</span> g <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token keyword">and</span> b <span class="token operator">&gt;</span> <span class="token number">20</span> <span class="token keyword">and</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">15</span> <span class="token keyword">and</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>r <span class="token operator">-</span> g<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">15</span> <span class="token keyword">and</span> r <span class="token operator">&gt;</span> g <span class="token keyword">and</span> r <span class="token operator">&gt;</span> b<span class="token operator">==</span>

第二种：<span class="token operator">==</span>nr <span class="token operator">=</span> r <span class="token operator">/</span> <span class="token punctuation">(</span>r <span class="token operator">+</span> g <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> ng <span class="token operator">=</span> g <span class="token operator">/</span> <span class="token punctuation">(</span>r <span class="token operator">+</span> g <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> nb <span class="token operator">=</span> b <span class="token operator">/</span> <span class="token punctuation">(</span>r <span class="token operator">+</span>g <span class="token operator">+</span> b<span class="token punctuation">)</span> ，nr <span class="token operator">/</span> ng <span class="token operator">&gt;</span> <span class="token number">1.185</span> <span class="token keyword">and</span> r <span class="token operator">*</span> b <span class="token operator">/</span> <span class="token punctuation">(</span>r <span class="token operator">+</span> g <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">&gt;</span> <span class="token number">0.107</span> <span class="token keyword">and</span> r <span class="token operator">*</span> g <span class="token operator">/</span> <span class="token punctuation">(</span>r <span class="token operator">+</span> g <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">&gt;</span> <span class="token number">0.112</span><span class="token operator">==</span>
</code></pre> 
<pre><code class="prism language-python">•HSV颜色模式

<span class="token operator">==</span>h <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> h <span class="token operator">&lt;</span> <span class="token number">35</span> <span class="token keyword">and</span> s <span class="token operator">&gt;</span> <span class="token number">0.23</span> <span class="token keyword">and</span> s <span class="token operator">&lt;</span> <span class="token number">0.68</span><span class="token operator">==</span>



•YCbCr颜色模式

<span class="token operator">==</span><span class="token number">97.5</span> <span class="token operator">&lt;=</span> cb <span class="token operator">&lt;=</span> <span class="token number">142.5</span> <span class="token keyword">and</span> <span class="token number">134</span> <span class="token operator">&lt;=</span> cr <span class="token operator">&lt;=</span> <span class="token number">176</span><span class="token operator">==</span>
</code></pre> 
<p>一幅图像有零个到多个的皮肤区域，程序按发现顺序给它们编号，第一个发现的区域编号为0，第n个发现的区域编号为n-1</p> 
<p>用一种类型来表示像素，我们给这个类型取名为Skin，包含了像素的一些信息：唯一的编号id、是/否肤色skin、皮肤区域号</p> 
<p>region、横坐标x、纵坐标y</p> 
<p>遍历所有像素时，我们为每个像素创建一个与之对应的Skin对象，并设置对象的所有属性，其中region属性即为像素所在的皮肤</p> 
<p>区域编号，创建对象时初始化为无意义的None。关于每个像素的id值，左上角为原点，像素id值按照像素坐标排布，那么看起来</p> 
<p>如下图：<br> <img src="https://images2.imgbox.com/94/ee/haeOoU6Q_o.png" alt="在这里插入图片描述"></p> 
<p>其实id的顺序也即遍历的顺序。遍历所有像素时，创建Skin对象后，如果当前像素为肤色，且相邻的像素有肤色的，那么我们把</p> 
<p>这些肤色像素归到一个皮肤区域。</p> 
<p>相邻像素的定义：通常都能想到是当前像素周围的8个像素，然而实际上只需要定义4个就可以了，位置分别在当前像素的左方，</p> 
<p>左上方，正上方，右上方。因为另外四个像素都在当前像素后面，我们还未给这4个像素创建对应的Skin对象：</p> 
<p><img src="https://images2.imgbox.com/fe/de/gXzBnDPX_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/3f/0e/1aNpEvhi_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="_135"></a>实现脚本</h2> 
<p>直接在python中新建nude.py文件，在这个文件进行代码编写：</p> 
<p>导入所需要的模块：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">import</span> _io
<span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
</code></pre> 
<p>我们将设计一个Nude类：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Nude</span><span class="token punctuation">:</span>
</code></pre> 
<p>这个类里面我们首先使用 collections.namedtuple() 定义一个 Skin 类型：</p> 
<pre><code class="prism language-python">Skin <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">"Skin"</span><span class="token punctuation">,</span> <span class="token string">"id skin region x y"</span><span class="token punctuation">)</span>
</code></pre> 
<p>collections.namedtuple() 函数实际上是一个返回 Python 中标准元组类型子类的一个工厂方法。你需要传递一个类型名和你需要</p> 
<p>的字段给它，然后它就会返回一个类，你可以初始化这个类，为你定义的字段传递值等。详情参见官方文档。</p> 
<p>然后定义 Nude 类的初始化方法：</p> 
<pre><code class="prism language-python">python学习交流Q群：<span class="token number">906715085</span><span class="token comment">###</span>
<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path_or_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 若 path_or_image 为 Image.Image 类型的实例，直接赋值</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>path_or_image<span class="token punctuation">,</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>image <span class="token operator">=</span> path_or_image
    <span class="token comment"># 若 path_or_image 为 str 类型的实例，打开图片</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>path_or_image<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>path_or_image<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/89/58/DtefKxDO_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token comment"># 获得图片所有颜色通道</span>
bands <span class="token operator">=</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>getbands<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 判断是否为单通道图片（也即灰度图），是则将灰度图转换为 RGB 图</span>
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>bands<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token comment"># 新建相同大小的 RGB 图像</span>
    new_img <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
    <span class="token comment"># 拷贝灰度图 self.image 到 RGB图 new_img.paste （PIL 自动进行颜色通道转换）</span>
    new_img<span class="token punctuation">.</span>paste<span class="token punctuation">(</span>self<span class="token punctuation">.</span>image<span class="token punctuation">)</span>
    f <span class="token operator">=</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>filename
    <span class="token comment"># 替换 self.image</span>
    self<span class="token punctuation">.</span>image <span class="token operator">=</span> new_img
    self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>filename <span class="token operator">=</span> f
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 存储对应图像所有像素的全部 Skin 对象</span>
self<span class="token punctuation">.</span>skin_map <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># 检测到的皮肤区域，元素的索引即为皮肤区域号，元素都是包含一些 Skin 对象的列表</span>
self<span class="token punctuation">.</span>detected_regions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># 元素都是包含一些 int 对象（区域号）的列表</span>
<span class="token comment"># 这些元素中的区域号代表的区域都是待合并的区域</span>
self<span class="token punctuation">.</span>merge_regions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># 整合后的皮肤区域，元素的索引即为皮肤区域号，元素都是包含一些 Skin 对象的列表</span>
self<span class="token punctuation">.</span>skin_regions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># 最近合并的两个皮肤区域的区域号，初始化为 -1</span>
self<span class="token punctuation">.</span>last_from<span class="token punctuation">,</span> self<span class="token punctuation">.</span>last_to <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token comment"># 色情图像判断结果</span>
self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token comment"># 处理得到的信息</span>
self<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token comment"># 图像宽高</span>
self<span class="token punctuation">.</span>width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>height <span class="token operator">=</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>size
<span class="token comment"># 图像总像素</span>
self<span class="token punctuation">.</span>total_pixels <span class="token operator">=</span> self<span class="token punctuation">.</span>width <span class="token operator">*</span> self<span class="token punctuation">.</span>height
</code></pre> 
<p><img src="https://images2.imgbox.com/62/ad/nanY7nih_o.png" alt="在这里插入图片描述"></p> 
<p>isinstane(object, classinfo) 如果参数 object 是参数 classinfo 的实例，返回真，否则假；参数 classinfo 可以是一个包含若干 type</p> 
<p>对象的元组，如果参数 object 是其中任意一个类型的实例，返回真，否则假。</p> 
<p>涉及到效率问题，越大的图片所需要消耗的资源与时间越大，因此有时候可能需要对图片进行缩小。所以需要有图片缩小方法：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">resize</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> maxwidth<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> maxheight<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">""</span>"
    基于最大宽高按比例重设图片大小，
    注意：这可能影响检测算法的结果

    如果没有变化返回 <span class="token number">0</span>
    原宽度大于 maxwidth 返回 <span class="token number">1</span>
    原高度大于 maxheight 返回 <span class="token number">2</span>
    原宽高大于 maxwidth<span class="token punctuation">,</span> maxheight 返回 <span class="token number">3</span>

    maxwidth <span class="token operator">-</span> 图片最大宽度
    maxheight <span class="token operator">-</span> 图片最大高度
    传递参数时都可以设置为 <span class="token boolean">False</span> 来忽略
</code></pre> 
<p><img src="https://images2.imgbox.com/95/57/6ED3yHpe_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token string">""</span>"
<span class="token comment"># 存储返回值</span>
ret <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">if</span> maxwidth<span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>width <span class="token operator">&gt;</span> maxwidth<span class="token punctuation">:</span>
        wpercent <span class="token operator">=</span> <span class="token punctuation">(</span>maxwidth <span class="token operator">/</span> self<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
        hsize <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>height <span class="token operator">*</span> wpercent<span class="token punctuation">)</span><span class="token punctuation">)</span>
        fname <span class="token operator">=</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>filename
        <span class="token comment"># Image.LANCZOS 是重采样滤波器，用于抗锯齿</span>
        self<span class="token punctuation">.</span>image <span class="token operator">=</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>maxwidth<span class="token punctuation">,</span> hsize<span class="token punctuation">)</span><span class="token punctuation">,</span> Image<span class="token punctuation">.</span>LANCZOS<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>filename <span class="token operator">=</span> fname
        self<span class="token punctuation">.</span>width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>height <span class="token operator">=</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>size
        self<span class="token punctuation">.</span>total_pixels <span class="token operator">=</span> self<span class="token punctuation">.</span>width <span class="token operator">*</span> self<span class="token punctuation">.</span>height
        ret <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token keyword">if</span> maxheight<span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>height <span class="token operator">&gt;</span> maxheight<span class="token punctuation">:</span>
        hpercent <span class="token operator">=</span> <span class="token punctuation">(</span>maxheight <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span>
        wsize <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">float</span><span class="token punctuation">(</span>hpercent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        fname <span class="token operator">=</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>filename
        self<span class="token punctuation">.</span>image <span class="token operator">=</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>wsize<span class="token punctuation">,</span> maxheight<span class="token punctuation">)</span><span class="token punctuation">,</span> Image<span class="token punctuation">.</span>LANCZOS<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>filename <span class="token operator">=</span> fname
        self<span class="token punctuation">.</span>width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>height <span class="token operator">=</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>size
        self<span class="token punctuation">.</span>total_pixels <span class="token operator">=</span> self<span class="token punctuation">.</span>width <span class="token operator">*</span> self<span class="token punctuation">.</span>height
        ret <span class="token operator">+=</span> <span class="token number">2</span>
<span class="token keyword">return</span> ret
</code></pre> 
<pre><code class="prism language-python">Image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>size<span class="token punctuation">,</span> resample<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

size – 包含宽高像素数的元祖 <span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span> resample – 可选的重采样滤波器

返回 Image 对象

然后便是最关键之一的解析方法了：
<span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 如果已有结果，返回本对象</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>result <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self
    <span class="token comment"># 获得图片所有像素数据</span>
    pixels <span class="token operator">=</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/85/09/aFiPp1xL_o.png" alt="在这里插入图片描述"></p> 
<p>接着，遍历每个像素，为每个像素创建对应的 Skin 对象，其中 self._classify_skin() 这个方法是检测像素颜色是否为肤色：</p> 
<pre><code class="prism language-python">python学习交流Q群：<span class="token number">906715085</span><span class="token comment">###</span>
<span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 得到像素的 RGB 三个通道的值</span>
        <span class="token comment"># [x, y] 是 [(x,y)] 的简便写法</span>
        r <span class="token operator">=</span> pixels<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>   <span class="token comment"># red</span>
        g <span class="token operator">=</span> pixels<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>   <span class="token comment"># green</span>
        b <span class="token operator">=</span> pixels<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment"># blue</span>
        <span class="token comment"># 判断当前像素是否为肤色像素</span>
        isSkin <span class="token operator">=</span> <span class="token boolean">True</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>_classify_skin<span class="token punctuation">(</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">False</span>
        <span class="token comment"># 给每个像素分配唯一 id 值（1, 2, 3...height*width）</span>
        <span class="token comment"># 注意 x, y 的值从零开始</span>
        _id <span class="token operator">=</span> x <span class="token operator">+</span> y <span class="token operator">*</span> self<span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token comment"># 为每个像素创建一个对应的 Skin 对象，并添加到 self.skin_map 中</span>
        self<span class="token punctuation">.</span>skin_map<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>Skin<span class="token punctuation">(</span>_id<span class="token punctuation">,</span> isSkin<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>若当前像素并不是肤色，那么跳过本次循环，继续遍历：</p> 
<pre><code class="prism language-python">  <span class="token comment"># 若当前像素不为肤色像素，跳过此次循环</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> isSkin<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
</code></pre> 
<p>若当前像素是肤色像素，那么就需要处理了，先遍历其相邻像素。</p> 
<p>一定要注意相邻像素的索引值，因为像素的 id 值是从 1 开始编起的，而索引是从 0 编起的。变量 _id是存有当前像素的 id 值，</p> 
<p>所以当前像素在 self.skin_map 中的索引值为 _id - 1，以此类推，那么其左方的相邻像素在 self.skin_map 中的索引值为 _id - 1 -</p> 
<p>1 ，左上方为 _id - 1 - self.width - 1，上方为 _id - 1 - self.width ，右上方为 _id - 1 - self.width + 1 ：</p> 
<pre><code class="prism language-python"><span class="token comment"># 设左上角为原点，相邻像素为符号 *，当前像素为符号 ^，那么相互位置关系通常如下图</span>
    <span class="token comment"># ***</span>
    <span class="token comment"># *^</span>

    <span class="token comment"># 存有相邻像素索引的列表，存放顺序为由大到小，顺序改变有影响</span>
    <span class="token comment"># 注意 _id 是从 1 开始的，对应的索引则是 _id-1</span>
    check_indexes <span class="token operator">=</span> <span class="token punctuation">[</span>_id <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment"># 当前像素左方的像素</span>
                     _id <span class="token operator">-</span> self<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment"># 当前像素左上方的像素</span>
                     _id <span class="token operator">-</span> self<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 当前像素的上方的像素</span>
                     _id <span class="token operator">-</span> self<span class="token punctuation">.</span>width<span class="token punctuation">]</span>  <span class="token comment"># 当前像素右上方的像素</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f5/d9/LhIdXOkt_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">把<span class="token builtin">id</span>值从<span class="token number">0</span>编起：
            <span class="token comment"># 用来记录相邻像素中肤色像素所在的区域号，初始化为 -1</span>
            region <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
            <span class="token comment"># 遍历每一个相邻像素的索引</span>
            <span class="token keyword">for</span> index <span class="token keyword">in</span> check_indexes<span class="token punctuation">:</span>
                <span class="token comment"># 尝试索引相邻像素的 Skin 对象，没有则跳出循环</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
                <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
                <span class="token comment"># 相邻像素若为肤色像素：</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>skin<span class="token punctuation">:</span>
                    <span class="token comment"># 若相邻像素与当前像素的 region 均为有效值，且二者不同，且尚未添加相同的合并任务</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>region <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">and</span>
                            region <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">and</span> region <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span>
                            self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>region <span class="token operator">!=</span> region <span class="token keyword">and</span>
                            self<span class="token punctuation">.</span>last_from <span class="token operator">!=</span> region <span class="token keyword">and</span>
                            self<span class="token punctuation">.</span>last_to <span class="token operator">!=</span> self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>region<span class="token punctuation">)</span> <span class="token punctuation">:</span>
                        <span class="token comment"># 那么这添加这两个区域的合并任务</span>
                        self<span class="token punctuation">.</span>_add_merge<span class="token punctuation">(</span>region<span class="token punctuation">,</span> self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>region<span class="token punctuation">)</span>
                    <span class="token comment"># 记录此相邻像素所在的区域号</span>
                    region <span class="token operator">=</span> self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>region
</code></pre> 
<p>self._add_merge() 这个方法接收两个区域号，它将会把两个区域号添加到 self.merge_regions 中的元素中，self.merge_regions</p> 
<p>的每一个元素都是一个列表，这些列表中存放了 1 到多个的区域号，区域号代表的区域是连通的，需要合并。</p> 
<p>检测的图像里，有些前几行的像素的相邻像素并没有 4 个，所以需要用 try “试错”。</p> 
<p>然后相邻像素的若是肤色像素，如果两个像素的皮肤区域号都为有效值且不同，因为两个区域中的像素相邻，那么其实这两个区</p> 
<p>域是连通的，说明需要合并这两个区域。记录下此相邻肤色像素的区域号，之后便可以将当前像素归到这个皮肤区域里了。<br> <img src="https://images2.imgbox.com/ab/8d/swGIOTQw_o.png" alt="在这里插入图片描述"></p> 
<p>遍历完所有相邻像素后，分两种情况处理：</p> 
<p>1.所有相邻像素都不是肤色像素：发现了新的皮肤区域。</p> 
<p>2.存在区域号为有效值的相邻肤色像素：region 的中存储的值有用了，把当前像素归到这个相邻像素所在的区域。</p> 
<pre><code class="prism language-python">  <span class="token comment"># 遍历完所有相邻像素后，若 region 仍等于 -1，说明所有相邻像素都不是肤色像素</span>
    <span class="token keyword">if</span> region <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token comment"># 更改属性为新的区域号，注意元祖是不可变类型，不能直接更改属性</span>
        _skin <span class="token operator">=</span> self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>_replace<span class="token punctuation">(</span>region<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>detected_regions<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> _skin
        <span class="token comment"># 将此肤色像素所在区域创建为新区域</span>
        self<span class="token punctuation">.</span>detected_regions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># region 不等于 -1 的同时不等于 None，说明有区域号为有效值的相邻肤色像素</span>
    <span class="token keyword">elif</span> region <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># 将此像素的区域号更改为与相邻像素相同</span>
        _skin <span class="token operator">=</span> self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>_replace<span class="token punctuation">(</span>region<span class="token operator">=</span>region<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> _skin
        <span class="token comment"># 向这个区域的像素列表中添加此像素</span>
        self<span class="token punctuation">.</span>detected_regions<span class="token punctuation">[</span>region<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>skin_map<span class="token punctuation">[</span>_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>somenamedtuple._replace(kwargs) 返回一个替换指定字段的值为参数的 namedtuple实例</p> 
<p>遍历完所有像素之后，图片的皮肤区域划分初步完成了，只是在变量 self.merge_regions 中还有一些连通的皮肤区域号，它们需</p> 
<p>要合并，合并之后就可以进行色情图片判定了：</p> 
<pre><code class="prism language-python"><span class="token comment"># 完成所有区域合并任务，合并整理后的区域存储到 self.skin_regions</span>
self<span class="token punctuation">.</span>_merge<span class="token punctuation">(</span>self<span class="token punctuation">.</span>detected_regions<span class="token punctuation">,</span> self<span class="token punctuation">.</span>merge_regions<span class="token punctuation">)</span>
<span class="token comment"># 分析皮肤区域，得到判定结果</span>
self<span class="token punctuation">.</span>_analyse_regions<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> self
</code></pre> 
<p>方法 self._merge() 便是用来合并这些连通的皮肤区域的。方法 self._analyse_regions()，运用之前在程序原理一节定义的非色情</p> 
<p>图像判定规则，从而得到判定结果。现在编写我们还没写过的调用过的 Nude 类的方法。</p> 
<p>首先是 self._classify_skin() 方法，这个方法是检测像素颜色是否为肤色，之前在程序原理一节已经把肤色判定该公式列举了出</p> 
<p>来，现在是用的时候了：</p> 
<pre><code class="prism language-python"><span class="token comment"># 基于像素的肤色检测技术</span>
<span class="token keyword">def</span> <span class="token function">_classify_skin</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 根据RGB值判定</span>
    rgb_classifier <span class="token operator">=</span> r <span class="token operator">&gt;</span> <span class="token number">95</span> <span class="token keyword">and</span> 
        g <span class="token operator">&gt;</span> <span class="token number">40</span> <span class="token keyword">and</span> g <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token keyword">and</span> 
        b <span class="token operator">&gt;</span> <span class="token number">20</span> <span class="token keyword">and</span> 
        <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">15</span> <span class="token keyword">and</span> 
        <span class="token builtin">abs</span><span class="token punctuation">(</span>r <span class="token operator">-</span> g<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">15</span> <span class="token keyword">and</span> 
        r <span class="token operator">&gt;</span> g <span class="token keyword">and</span> 
        r <span class="token operator">&gt;</span> b
    <span class="token comment"># 根据处理后的 RGB 值判定</span>
    nr<span class="token punctuation">,</span> ng<span class="token punctuation">,</span> nb <span class="token operator">=</span> self<span class="token punctuation">.</span>_to_normalized<span class="token punctuation">(</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
    norm_rgb_classifier <span class="token operator">=</span> nr <span class="token operator">/</span> ng <span class="token operator">&gt;</span> <span class="token number">1.185</span> <span class="token keyword">and</span> 
        <span class="token builtin">float</span><span class="token punctuation">(</span>r <span class="token operator">*</span> b<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">+</span> g <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.107</span> <span class="token keyword">and</span> 
        <span class="token builtin">float</span><span class="token punctuation">(</span>r <span class="token operator">*</span> g<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">+</span> g <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.112</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ce/25/ONSiNCib_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token comment"># HSV 颜色模式下的判定</span>
h<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v <span class="token operator">=</span> self<span class="token punctuation">.</span>_to_hsv<span class="token punctuation">(</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
hsv_classifier <span class="token operator">=</span> h <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> 
    h <span class="token operator">&lt;</span> <span class="token number">35</span> <span class="token keyword">and</span> 
    s <span class="token operator">&gt;</span> <span class="token number">0.23</span> <span class="token keyword">and</span> 
    s <span class="token operator">&lt;</span> <span class="token number">0.68</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># YCbCr 颜色模式下的判定</span>
y<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> cr <span class="token operator">=</span> self<span class="token punctuation">.</span>_to_ycbcr<span class="token punctuation">(</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span>  b<span class="token punctuation">)</span>
ycbcr_classifier <span class="token operator">=</span> <span class="token number">97.5</span> <span class="token operator">&lt;=</span> cb <span class="token operator">&lt;=</span> <span class="token number">142.5</span> <span class="token keyword">and</span> <span class="token number">134</span> <span class="token operator">&lt;=</span> cr <span class="token operator">&lt;=</span> <span class="token number">176</span>

<span class="token comment"># 效果不是很好，还需改公式</span>
<span class="token comment"># return rgb_classifier or norm_rgb_classifier or hsv_classifier or ycbcr_classifier</span>
<span class="token keyword">return</span> ycbcr_classifier
</code></pre> 
<p>颜色模式的转换并不是本实验的重点，转换公式可以在网上找到，这里我们直接拿来用就行：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">_to_normalized</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> <span class="token number">0.0001</span>
    <span class="token keyword">if</span> g <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        g <span class="token operator">=</span> <span class="token number">0.0001</span>
    <span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        b <span class="token operator">=</span> <span class="token number">0.0001</span>
    _sum <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>r <span class="token operator">+</span> g <span class="token operator">+</span> b<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>r <span class="token operator">/</span> _sum<span class="token punctuation">,</span> g <span class="token operator">/</span> _sum<span class="token punctuation">,</span> b <span class="token operator">/</span> _sum<span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">_to_ycbcr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 公式来源：</span>
    <span class="token comment"># http://stackoverflow.com/questions/19459831/rgb-to-ycbcr-conversion-problems</span>
    y <span class="token operator">=</span> <span class="token number">.299</span><span class="token operator">*</span>r <span class="token operator">+</span> <span class="token number">.587</span><span class="token operator">*</span>g <span class="token operator">+</span> <span class="token number">.114</span><span class="token operator">*</span>b
    cb <span class="token operator">=</span> <span class="token number">128</span> <span class="token operator">-</span> <span class="token number">0.168736</span><span class="token operator">*</span>r <span class="token operator">-</span> <span class="token number">0.331364</span><span class="token operator">*</span>g <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">*</span>b
    cr <span class="token operator">=</span> <span class="token number">128</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">*</span>r <span class="token operator">-</span> <span class="token number">0.418688</span><span class="token operator">*</span>g <span class="token operator">-</span> <span class="token number">0.081312</span><span class="token operator">*</span>b
    <span class="token keyword">return</span> y<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> cr

<span class="token keyword">def</span> <span class="token function">_to_hsv</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h <span class="token operator">=</span> <span class="token number">0</span>
    _sum <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>r <span class="token operator">+</span> g <span class="token operator">+</span> b<span class="token punctuation">)</span>
    _max <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    _min <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    diff <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>_max <span class="token operator">-</span> _min<span class="token punctuation">)</span>
    <span class="token keyword">if</span> _sum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        _sum <span class="token operator">=</span> <span class="token number">0.0001</span>

    <span class="token keyword">if</span> _max <span class="token operator">==</span> r<span class="token punctuation">:</span>
        <span class="token keyword">if</span> diff <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            h <span class="token operator">=</span> sys<span class="token punctuation">.</span>maxsize
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            h <span class="token operator">=</span> <span class="token punctuation">(</span>g <span class="token operator">-</span> b<span class="token punctuation">)</span> <span class="token operator">/</span> diff
    <span class="token keyword">elif</span> _max <span class="token operator">==</span> g<span class="token punctuation">:</span>
        h <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>g <span class="token operator">-</span> r<span class="token punctuation">)</span> <span class="token operator">/</span> diff<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        h <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">-</span> g<span class="token punctuation">)</span> <span class="token operator">/</span> diff<span class="token punctuation">)</span>

    h <span class="token operator">*=</span> <span class="token number">60</span>
    <span class="token keyword">if</span> h <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        h <span class="token operator">+=</span> <span class="token number">360</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span>h<span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">3.0</span> <span class="token operator">*</span> <span class="token punctuation">(</span>_min <span class="token operator">/</span> _sum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">3.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _max<span class="token punctuation">]</span>
</code></pre> 
<p>self._add_merge() 方法主要是对 self.merge_regions 操作，而self.merge_regions 的元素都是包含一些 int 对象（区域号）的列</p> 
<p>表，列表中的区域号代表的区域都是待合并的区。self._add_merge() 方法接收两个区域号，将之添加到 self.merge_regions 中。<br> <img src="https://images2.imgbox.com/ac/86/eaw4Jrnj_o.png" alt="在这里插入图片描述"></p> 
<p>这两个区域号以怎样的形式添加，要分 3 种情况处理：</p> 
<pre><code class="prism language-python"><span class="token number">1.</span>传入的两个区域号都存在于 self<span class="token punctuation">.</span>merge_regions 中


<span class="token number">2.</span>传入的两个区域号有一个区域号存在于 self<span class="token punctuation">.</span>merge_regions 中


<span class="token number">3.</span>传入的两个区域号都不存在于 self<span class="token punctuation">.</span>merge_regions 中
</code></pre> 
<p>具体的处理方法，见代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">_add_merge</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> _from<span class="token punctuation">,</span> _to<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 两个区域号赋值给类属性</span>
    self<span class="token punctuation">.</span>last_from <span class="token operator">=</span> _from
    self<span class="token punctuation">.</span>last_to <span class="token operator">=</span> _to
    
    <span class="token comment"># 记录 self.merge_regions 的某个索引值，初始化为 -1</span>
    from_index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token comment"># 记录 self.merge_regions 的某个索引值，初始化为 -1</span>
    to_index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>


    <span class="token comment"># 遍历每个 self.merge_regions 的元素</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> region <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>merge_regions<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 遍历元素中的每个区域号</span>
        <span class="token keyword">for</span> r_index <span class="token keyword">in</span> region<span class="token punctuation">:</span>
            <span class="token keyword">if</span> r_index <span class="token operator">==</span> _from<span class="token punctuation">:</span>
                from_index <span class="token operator">=</span> index
            <span class="token keyword">if</span> r_index <span class="token operator">==</span> _to<span class="token punctuation">:</span>
                to_index <span class="token operator">=</span> index

    <span class="token comment"># 若两个区域号都存在于 self.merge_regions 中</span>
    <span class="token keyword">if</span> from_index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> to_index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token comment"># 如果这两个区域号分别存在于两个列表中</span>
        <span class="token comment"># 那么合并这两个列表</span>
        <span class="token keyword">if</span> from_index <span class="token operator">!=</span> to_index<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>merge_regions<span class="token punctuation">[</span>from_index<span class="token punctuation">]</span><span class="token punctuation">.</span>extend<span class="token punctuation">(</span>self<span class="token punctuation">.</span>merge_regions<span class="token punctuation">[</span>to_index<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">del</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>merge_regions<span class="token punctuation">[</span>to_index<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>

    <span class="token comment"># 若两个区域号都不存在于 self.merge_regions 中</span>
    <span class="token keyword">if</span> from_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> to_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token comment"># 创建新的区域号列表</span>
        self<span class="token punctuation">.</span>merge_regions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>_from<span class="token punctuation">,</span> _to<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token comment"># 若两个区域号中有一个存在于 self.merge_regions 中</span>
    <span class="token keyword">if</span> from_index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> to_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token comment"># 将不存在于 self.merge_regions 中的那个区域号</span>
        <span class="token comment"># 添加到另一个区域号所在的列表</span>
        self<span class="token punctuation">.</span>merge_regions<span class="token punctuation">[</span>from_index<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>_to<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token comment"># 若两个待合并的区域号中有一个存在于 self.merge_regions 中</span>
    <span class="token keyword">if</span> from_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> to_index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token comment"># 将不存在于 self.merge_regions 中的那个区域号</span>
        <span class="token comment"># 添加到另一个区域号所在的列表</span>
        self<span class="token punctuation">.</span>merge_regions<span class="token punctuation">[</span>to_index<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>_from<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/91/7b/WuLXuDGp_o.png" alt="在这里插入图片描述"></p> 
<p>在序列中循环时，索引位置和对应值可以使用 enumerate() 函数同时得到，在上面的代码中，索引位置即为 index ，对应值即为</p> 
<p>region。self._merge() 方法则是将 self.merge_regions 中的元素中的区域号所代表的区域合并，得到新的皮肤区域列表：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">_merge</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> detected_regions<span class="token punctuation">,</span> merge_regions<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 新建列表 new_detected_regions </span>
    <span class="token comment"># 其元素将是包含一些代表像素的 Skin 对象的列表</span>
    <span class="token comment"># new_detected_regions 的元素即代表皮肤区域，元素索引为区域号</span>
    new_detected_regions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># 将 merge_regions 中的元素中的区域号代表的所有区域合并</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> region <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>merge_regions<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            new_detected_regions<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
            new_detected_regions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> r_index <span class="token keyword">in</span> region<span class="token punctuation">:</span>
            new_detected_regions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>extend<span class="token punctuation">(</span>detected_regions<span class="token punctuation">[</span>r_index<span class="token punctuation">]</span><span class="token punctuation">)</span>
            detected_regions<span class="token punctuation">[</span>r_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># 添加剩下的其余皮肤区域到 new_detected_regions</span>
    <span class="token keyword">for</span> region <span class="token keyword">in</span> detected_regions<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            new_detected_regions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>region<span class="token punctuation">)</span>

    <span class="token comment"># 清理 new_detected_regions</span>
    self<span class="token punctuation">.</span>_clear_regions<span class="token punctuation">(</span>new_detected_regions<span class="token punctuation">)</span>

        <span class="token comment"># 添加剩下的其余皮肤区域到 new_detected_regions</span>
        <span class="token keyword">for</span> region <span class="token keyword">in</span> detected_regions<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                new_detected_regions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>region<span class="token punctuation">)</span>

        <span class="token comment"># 清理 new_detected_regions</span>
        self<span class="token punctuation">.</span>_clear_regions<span class="token punctuation">(</span>new_detected_regions<span class="token punctuation">)</span>
</code></pre> 
<p>self._clear_regions() 方法只将像素数大于指定数量的皮肤区域保留到 self.skin_regions ：</p> 
<pre><code class="prism language-python"><span class="token comment"># 皮肤区域清理函数</span>
<span class="token comment"># 只保存像素数大于指定数量的皮肤区域</span>
<span class="token keyword">def</span> <span class="token function">_clear_regions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> detected_regions<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> region <span class="token keyword">in</span> detected_regions<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>skin_regions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>region<span class="token punctuation">)</span>


self<span class="token punctuation">.</span>_analyse_regions<span class="token punctuation">(</span><span class="token punctuation">)</span> 是很简单的，它的工作只是进行一系列判断，得出图片是否色情的结论：
<span class="token comment"># 分析区域</span>
<span class="token keyword">def</span> <span class="token function">_analyse_regions</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 如果皮肤区域小于 3 个，不是色情</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>skin_regions<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">"Less than 3 skin regions ({_skin_regions_size})"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            _skin_regions_size<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>skin_regions<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>result

    <span class="token comment"># 为皮肤区域排序</span>
    self<span class="token punctuation">.</span>skin_regions <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>skin_regions<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span>
                               reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># 计算皮肤总像素数</span>
    total_skin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>skin_region<span class="token punctuation">)</span> <span class="token keyword">for</span> skin_region <span class="token keyword">in</span> self<span class="token punctuation">.</span>skin_regions<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 如果皮肤区域与整个图像的比值小于 15%，那么不是色情图片</span>
    <span class="token keyword">if</span> total_skin <span class="token operator">/</span> self<span class="token punctuation">.</span>total_pixels <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">"Total skin percentage lower than 15 ({:.2f})"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>total_skin <span class="token operator">/</span> self<span class="token punctuation">.</span>total_pixels <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>result

    <span class="token comment"># 如果最大皮肤区域小于总皮肤面积的 45%，不是色情图片</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>skin_regions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> total_skin <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">&lt;</span> <span class="token number">45</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">"The biggest region contains less than 45 ({:.2f})"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>skin_regions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> total_skin <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>result

    <span class="token comment"># 皮肤区域数量超过 60个，不是色情图片</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>skin_regions<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">60</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">"More than 60 skin regions ({})"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>skin_regions<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>result

    <span class="token comment"># 其它情况为色情图片</span>
    self<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">"Nude!!"</span>
    self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>result


然后可以组织下分析得出的信息：
<span class="token keyword">def</span> <span class="token function">inspect</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    _image <span class="token operator">=</span> <span class="token string">'{} {} {}×{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> self<span class="token punctuation">.</span>image<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"{_image}: result={_result} message='{_message}'"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>_image<span class="token operator">=</span>_image<span class="token punctuation">,</span> _result<span class="token operator">=</span>self<span class="token punctuation">.</span>result<span class="token punctuation">,</span> _message<span class="token operator">=</span>self<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/66/40/ER6C8Jae_o.png" alt="在这里插入图片描述"></p> 
<p>Nude 类如果就这样完成了，最后运行脚本时只能得到一些真或假的结果，我们需要更直观的感受程序的分析效果，我们可以生成</p> 
<p>一张原图的副本，不过这个副本图片中只有黑白色，白色代表皮肤区域，那么这样我们能直观感受到程序分析的效果了。</p> 
<p>前面的代码中我们有获得图像的像素的 RGB 值的操作，设置像素的 RGB 值也就是其逆操作，还是很简单的，不过注意设置像素的 RGB 值时不能在原图上操作：</p> 
<pre><code class="prism language-python">python学习交流Q群：<span class="token number">906715085</span><span class="token comment">###</span>
<span class="token comment"># 将在源文件目录生成图片文件，将皮肤区域可视化</span>
<span class="token keyword">def</span> <span class="token function">showSkinRegions</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 未得出结果时方法返回</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>result <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>
    <span class="token comment"># 皮肤像素的 ID 的集合</span>
    skinIdSet <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 将原图做一份拷贝</span>
    simage <span class="token operator">=</span> self<span class="token punctuation">.</span>image
    <span class="token comment"># 加载数据</span>
    simageData <span class="token operator">=</span> simage<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 将皮肤像素的 id 存入 skinIdSet</span>
    <span class="token keyword">for</span> sr <span class="token keyword">in</span> self<span class="token punctuation">.</span>skin_regions<span class="token punctuation">:</span>
        <span class="token keyword">for</span> pixel <span class="token keyword">in</span> sr<span class="token punctuation">:</span>
            skinIdSet<span class="token punctuation">.</span>add<span class="token punctuation">(</span>pixel<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
    <span class="token comment"># 将图像中的皮肤像素设为白色，其余设为黑色</span>
    <span class="token keyword">for</span> pixel <span class="token keyword">in</span> self<span class="token punctuation">.</span>skin_map<span class="token punctuation">:</span>
        <span class="token keyword">if</span> pixel<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">not</span> <span class="token keyword">in</span> skinIdSet<span class="token punctuation">:</span>
            simageData<span class="token punctuation">[</span>pixel<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pixel<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            simageData<span class="token punctuation">[</span>pixel<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pixel<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span>
    <span class="token comment"># 源文件绝对路径</span>
    filePath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>self<span class="token punctuation">.</span>image<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
    <span class="token comment"># 源文件所在目录</span>
    fileDirectory <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span>
    <span class="token comment"># 源文件的完整文件名</span>
    fileFullName <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
    <span class="token comment"># 分离源文件的完整文件名得到文件名和扩展名</span>
    fileName<span class="token punctuation">,</span> fileExtName <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>fileFullName<span class="token punctuation">)</span>
    <span class="token comment"># 保存图片</span>
    simage<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'{}{}_{}{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>fileDirectory<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span><span class="token string">'Nude'</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>result <span class="token keyword">else</span> <span class="token string">'Normal'</span><span class="token punctuation">,</span> fileExtName<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>变量 skinIdSet 使用集合而不是列表是有性能上的考量的，Python 中的集合是哈希表实现的，查询效率很高。最后支持一下命令</p> 
<p>行参数就大功告成啦！我们使用 argparse 这个模块来实现命令行的支持。argparse 模块使得编写用户友好的命令行接口非常容</p> 
<p>易。程序只需定义好它要求的参数，然后 argparse 将负责如何从 sys.argv 中解析出这些参数。argparse 模块还会自动生成帮助</p> 
<p>和使用信息并且当用户赋给程序非法的参数时产生错误信息。</p> 
<p>具体使用方法请查看argparse的 官方文档</p> 
<pre><code class="prism language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> argparse

    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">'Detect nudity in images.'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'image'</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'+'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Images you wish to test'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-r'</span><span class="token punctuation">,</span> <span class="token string">'--resize'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Reduce image size to increase speed of scanning'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-v'</span><span class="token punctuation">,</span> <span class="token string">'--visualization'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Generating areas of skin image'</span><span class="token punctuation">)</span>

    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> fname <span class="token keyword">in</span> args<span class="token punctuation">.</span>files<span class="token punctuation">:</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">:</span>
            n <span class="token operator">=</span> Nude<span class="token punctuation">(</span>fname<span class="token punctuation">)</span>
            <span class="token keyword">if</span> args<span class="token punctuation">.</span>resize<span class="token punctuation">:</span>
                n<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>maxheight<span class="token operator">=</span><span class="token number">800</span><span class="token punctuation">,</span> maxwidth<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">)</span>
            n<span class="token punctuation">.</span>parse<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> args<span class="token punctuation">.</span>visualization<span class="token punctuation">:</span>
                n<span class="token punctuation">.</span>showSkinRegions<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>result<span class="token punctuation">,</span> n<span class="token punctuation">.</span>inspect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">"is not a file"</span><span class="token punctuation">)</span>
</code></pre> 
<p>测试效果</p> 
<p>先来一张很正经的测试图片：</p> 
<p><img src="https://images2.imgbox.com/b6/31/luq5EThC_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/fe/3b/gW4cuK35_o.png" alt="在这里插入图片描述"></p> 
<p>在PyCharm中的终端运行下面的命令执行脚本，注意是python3而不是python：<br> python3 nude.py -v 1.jpg</p> 
<p>运行截图：</p> 
<p><img src="https://images2.imgbox.com/fd/96/ZtGBCteA_o.png" alt="在这里插入图片描述"></p> 
<p>这表示1.jpg不是一张色情图片</p> 
<p>总结</p> 
<p>这个项目就是熟悉了一下PIL的使用，了解了色情图片检查的原理。主要实现难点是在皮肤区域的检测与整合这一方面。项目还有</p> 
<p>许多可以改进的地方，比如肤色检测公式，色情判定条件，还有性能问题，我得去学习一下用多线程或多进程提高性能。关于这</p> 
<p>篇文章，喜欢的小伙伴记得点赞收藏，关注我才能看更多有意思的，有不懂的地方记得评论留言哟！！</p> 
<p><img src="https://images2.imgbox.com/d2/39/qsDw3fPl_o.png" alt="在这里插入图片描述"></p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>