<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>golang Redis的新数据类型github.com/go-redis/redis/v8实践 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">golang Redis的新数据类型github.com/go-redis/redis/v8实践</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="htmledit_views">
                    <h2 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>Redis的新数据类型</strong></span></span></strong><a href="#3575205883"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h2> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">在redis中，后面添加了几个比较高级的数据类型 hyperloglog基数统计、GEO存储地理位置、bitmap位图、stream为消息队列设计的数据类型 这 4 种数据类型。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><img alt="" height="233" src="https://images2.imgbox.com/6c/d6/GbaZYNXA_o.png" width="325"></p> 
<p> </p> 
<p style="margin-left:0;text-align:left"></p> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>HyperLogLog类型</strong></span></span></strong><a href="#3118800880"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<h4 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>HyperLogLog简介</strong></span></span></strong><a href="#1962076966"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h4> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">HyperLogLog 是一种用于数据统计的集合类型，叫基数统计。它有点类似布隆过滤器的算法。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">比如说 Google 要计算用户执行不同搜索的数量，这种统计量肯定很大，精确计算话需要消耗大量内存空间来计算。但是如果我们不要求计算精确的数量，而是大致的数量，就可以用 HyperLogLog 这种近似算法来计算集合中的不同元素数量，它可以去重。虽然这种算法不能算出精确数量值，但计算的值也是八九不离十，且占用内存空间少很多。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">统计大量数据的 UV、PV 就可以用这个数据类型。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">hyperloglog 的命令文档：</span></span></span></p> 
<ul>
<li style="text-align:left"><a href="https://redis.io/commands/?group=hyperloglog%EF%BC%8C%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3" title="https://redis.io/commands/?group=hyperloglog，官方文档">https://redis.io/commands/?group=hyperloglog，官方文档</a></li>
<li style="text-align:left"><a href="https://redis.io/docs/data-types/hyperloglogs/" title="Redis HyperLogLog | Redis">Redis HyperLogLog | Redis</a></li>
<li style="text-align:left"><a href="http://redisdoc.com/hyperloglog/index.html%EF%BC%8C%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3" title="http://redisdoc.com/hyperloglog/index.html，参考文档">http://redisdoc.com/hyperloglog/index.html，参考文档</a></li>
</ul> 
<h4 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>命令介绍</strong></span></span></strong><a href="#3150672446"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h4> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">hyperloglog 常用命令：</span></span></span></p> 
<ol>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">PFADD：PFADD key element [element …]，将任意数量的元素添加到指定 hyperloglog 中</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">PFCOUNT：PFCOUNT key [key ...]，如果是单个键，返回给定键在hyperloglog中的近似值，不存在则返回 0；如果是多个键，返回给定hyperloglog的并集的近似值。</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">PFMERGE：PFMERGE destkey sourcekey [sourcekey …]，将多个hyperloglog合并为一个hyperloglog，合并后近似值为并集</span></span></li>
</ol> 
<h4 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>代码例子</strong></span></span></strong><a href="#2798632204"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h4> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">代码例子，官方的一个例子，</span></span><a href="https://github.com/redis/go-redis/blob/v8/example/hll/main.go" title="hll/main.go">hll/main.go</a><span style="background-color:#ffffff"><span style="color:#314659">，改一点：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"time"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/go-redis/redis/v8"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx := context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"localhost:6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Password:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">DB:          </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">IdleTimeout: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">350</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">PoolSize:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">50</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 连接池连接数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx, cancel := context.WithTimeout(context.Background(), time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cancel()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err := rdb.Ping(ctx).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 检查连接redis是否成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Connect Failed: %v n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 设置hyperloglog的键myset</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> i := </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">; i &lt; </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">; i++ {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err := rdb.PFAdd(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"myset"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, fmt.Sprint(i)).Err(); err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">//PFCount, 返回hyperloglog的近似值</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">card, err := rdb.PFCount(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"myset"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"PFCount: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, card)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// PFMerge，合并2个hyperloglog</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> i := </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">; i &lt; </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">; i++ {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err = rdb.PFAdd(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"myset2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, fmt.Sprintf(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"val%d"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, i)).Err(); err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb.PFMerge(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mergeset"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"myset"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"myset2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">card, _ = rdb.PFCount(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mergeset"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"merge: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, card)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">/*output:</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">PFCount:  10</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">merge:  20</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">*/</span></span></span></p> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>GEO地理位置空间索引</strong></span></span></strong><a href="#763381936"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<h4 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>GEO简介</strong></span></span></strong><a href="#801912474"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h4> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">GEO(Geospatial) 主要用于存储地理位置信息，存储地理位置经纬度信息。我们点餐用的 APP 就会用到地理位置信息服务。这些都是 属于 LBS(Location-Based Service) 地理位置信息服务。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">geospatial index 地理位置空间索引，可以用经纬度查询彼此之间距离，范围大小等。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">GEO 命令文档：</span></span></span></p> 
<ul>
<li style="text-align:left"><a href="https://redis.io/commands/?group=geo%EF%BC%8C%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3" title="https://redis.io/commands/?group=geo，官方文档">https://redis.io/commands/?group=geo，官方文档</a></li>
<li style="text-align:left"><a href="https://redis.io/docs/data-types/geospatial/" title="Redis geospatial | Redis">Redis geospatial | Redis</a></li>
<li style="text-align:left"><a href="http://redisdoc.com/geo/index.html%EF%BC%8C%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3" title="http://redisdoc.com/geo/index.html，参考文档">http://redisdoc.com/geo/index.html，参考文档</a></li>
</ul> 
<h4 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>命令介绍</strong></span></span></strong><a href="#1841685789"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h4> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">GEO 常用命令：</span></span></span></p> 
<ol>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">GEOADD：将纬度、经度、名字添加到指定的键里</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">GEORADIUS：以给定的经纬度为中心，返回键包含的位置元素中，与中心的距离不超过给定最大距离的所有位置元素。在Redis6.2.0 废弃</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">GEOPOS：GEOPOS key [member [member ...]]，从键里返回所有给定位置元素的位置（经度和纬度）</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">GEODIST：返回两个位置之间的距离</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">GEOHASH：返回一个或多个位置元素的 Geohash 表示</span></span></li>
</ol> 
<h4 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>代码例子</strong></span></span></strong><a href="#3375959676"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h4> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"time"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/go-redis/redis/v8"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"localhost:6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Password:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">DB:          </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">IdleTimeout: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">350</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">PoolSize:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">50</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 连接池连接数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx, cancel := context.WithTimeout(context.Background(), time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cancel()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err := rdb.Ping(ctx).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 检查连接redis是否成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Connect Failed: %v n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// GEOADD，添加一个</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">val, err := rdb.GeoAdd(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"town-geo-key"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, &amp;redis.GeoLocation{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Longitude: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">113.2442</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Latitude:  </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">23.12592</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Name:      </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"niwan-town"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"GeoAdd: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, val)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// GEOADD，添加多个</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">val, _ = rdb.GeoAdd(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"town-geo-key"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&amp;redis.GeoLocation{Longitude: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">113.2442</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, Latitude: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">23.12592</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, Name: </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"niwan-town"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">},</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&amp;redis.GeoLocation{Longitude: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">113.38397</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, Latitude: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">22.93599</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, Name: </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"panyu-town"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">},</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&amp;redis.GeoLocation{Longitude: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">113.60845</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, Latitude: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">22.77144</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, Name: </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"nansha-town"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">},</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&amp;redis.GeoLocation{Longitude: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">113.829579</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, Latitude: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">23.290497</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, Name: </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"zengcheng-town"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">},</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Mulit GeoAdd : "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, val)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// GEOPOS，根据名字获取经纬度</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">lonlats, err := rdb.GeoPos(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"town-geo-key"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"zengcheng-town"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"panyu-town"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> _, lonlat := </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">range</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> lonlats {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"GeoPos, "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Longitude: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, lonlat.Longitude, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Latitude: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, lonlat.Latitude)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// GEODIST , 计算两地距离</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">distance, err := rdb.GeoDist(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"town-geo-key"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"niwan-town"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"nansha-town"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"m"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// m-米，km-千米，mi-英里</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"GeoDist: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, distance, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">" m"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// GEOHASH，计算hash值</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">hash, _ := rdb.GeoHash(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"town-geo-key"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"zengcheng-town"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"zengcheng-town geohash: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, hash)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// GEORADIUS，计算范围内包含的经纬度位置</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">radius, _ := rdb.GeoRadius(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"town-geo-key"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">113.829579</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">23.290497</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, &amp;redis.GeoRadiusQuery{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Radius:      </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">800</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Unit:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"km"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">WithCoord:   </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">true</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,  </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// WITHCOORD参数，返回结果会带上匹配位置的经纬度</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">WithDist:    </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">true</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,  </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// WITHDIST参数，返回结果会带上匹配位置与给定地理位置的距离。</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">WithGeoHash: </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">true</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,  </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// WITHHASH参数，返回结果会带上匹配位置的hash值。</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Count:       </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">4</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,     </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// COUNT参数，可以返回指定数量的结果。</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Sort:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"ASC"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 传入ASC为从近到远排序，传入DESC为从远到近排序。</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> _, v := </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">range</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> radius {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"GeoRadius: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, v)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 上面式子里参数更多详情请看这里：http://redisdoc.com/geo/georadius.html</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">/*</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">GeoAdd:  0</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">Mulit GeoAdd :  0</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">GeoPos,  Longitude:  113.8295790553093 Latitude:  23.290497021802757</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">GeoPos,  Longitude:  113.3839675784111 Latitude:  22.935990920457606</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">GeoDist:  54280.9773  m</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">zengcheng-town geohash:  [ws0uqrbhvr0]</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">GeoRadius:  {zengcheng-town 113.8295790553093 23.290497021802757 0 4046592114973855}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">GeoRadius:  {panyu-town 113.3839675784111 22.935990920457606 60.2724 4046531372960175}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">*/</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>Stream作为消息队列</strong></span></span></strong><a href="#2777755022"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<h4 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>stream简介</strong></span></span></strong><a href="#2211411353"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h4> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Redis5.0 增加了 Stream 数据类型，stream 类型可以支持消息队列，因为它具备消息队列的很多特性。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Stream 是什么呢？</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">stream 是一种数据结构，它类似于一种追加日志。你能够使用 stream 实时记录并关联相关事件。stream 使用场景：</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">Event sourcing 事件硕源（比如跟踪用户操作，点击事件等）</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">Sensor monitoring 传感器监控（比如从设备中读取数据）</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">Notifications 通知（比如将每个用户的通知信息单独记录在 stream 中）</span></span></li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">stream 是一个包含零个或任意多个元素数据的有序队列，队列中的每个元素都包含一个 ID 和任意多个键值对，这些元素根据 ID 大小在流中有序排列。ID 是由毫秒和顺序数组成，比如 10000000000000-0。</span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">stream 流中的每个元素可以包含一个或任意多个键值对，同一流中不同元素可以包含不同数量的键值对。</span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">来一张 stream 流的存储示意图：</span></span></span></p> 
<p style="margin-left:0;text-align:left"></p> 
<h4 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>stream命令用法讲解</strong></span></span></strong><a href="#817414922"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h4> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">stream 命令文档：</span></span></span></p> 
<ul><li style="text-align:left"><a href="https://redis.io/commands/?group=stream" title="Commands | Redis">Commands | Redis</a></li></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Stream 是 5.0 才增加的数据类型，所以详细讲解下相关命令的用法。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">消息队列相关的命令：</span></span></span></p> 
<ol><li style="text-align:left">
<span style="background-color:#ffffff"><span style="color:#314659">XADD：向某个消息队列中添加消息，添加到流尾部，</span></span><a href="https://redis.io/commands/xadd/" title="XADD | Redis">XADD | Redis</a>
</li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#969896">// 语法</span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XADD key [NOMKSTREAM] [&lt;MAXLEN | MINID&gt; [= | ~] threshold [LIMIT count]] &lt;* | id&gt; field value [field value ...]</span></span></p> 
<ul><li style="text-align:left"></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key：表示消息队列名称</span></span></p> 
<ul>
<li style="text-align:left">
</li>
<li style="text-align:left">
</li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[NOMKSTREAM]：可选参数，表示 key 不存在新建</span></span></p> 
<ul>
<li style="text-align:left">
</li>
<li style="text-align:left">
</li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[&lt;MAXLEN | MINID&gt; [= | ~] threshold [LIMIT count]：可选参数，&lt;MAXLEN | MINID&gt; 表示消息队列中消息的最大长度或消息ID的最小值；</span></span></p> 
<ul><li style="text-align:left"></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[= | ~] 设置精确的值或大约值；</span></span></p> 
<ul><li style="text-align:left"></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">threshold 表示具体设置的值，超过 threshold 值后会将旧的值删除；</span></span></p> 
<ul><li style="text-align:left"></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[LIMIT count] (Redis6.2后加入的参数) 限制数量；</span></span></p> 
<ul><li style="text-align:left"></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">&lt;* | id&gt; 表示消息 ID，* 表示由 Redis 生成，id 则是自定义生成；</span></span></p> 
<ul><li style="text-align:left"></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">field value [field value ...] 具体消息内容的键值对，可以传入多个。</span></span></p> 
<ul><li style="text-align:left"></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">redis-cli 下示例：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&gt; XADD mystream * sensor-id </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">1234</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> temperature </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">19.81518951480106-0</span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 用 XADD 命令增加了2组数据 sensor-id:1234 和 temperature:19.8，消息队列的 key 是 mystream，* 表示Redis自动生成id。// 1518951480106-0，返回redis生成的id，由毫秒时间和顺序编号组成。</span></span></span></p> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XREAD：从某一消息队列中读取消息</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XREAD </span></span><span style="background-color:#f2f4f5"><span style="color:#795da3">[COUNT count]</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">[BLOCK milliseconds]</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> STREAMS key </span></span><span style="background-color:#f2f4f5"><span style="color:#795da3">[key ...]</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> id</span></span><span style="background-color:#f2f4f5"><span style="color:#795da3">[id ...]</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[COUNT count]：可选参数，表示读取消息的数量，COUNT 为关键字，小写count表示具体的数值</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[BLOCK milliseconds]：可选参数，BLOCK 为关键字，表示设置 XREAD 为阻塞模式，默认非阻塞，milliseconds 表示阻塞具体时间</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">STREAMS key [key ...]：STREAMS 为关键字，key 表示消息队列名称，可以传入多个消息队列名称</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">id[id ...]：表示从哪个消息ID读取，与上面的 key 一一对应。id为0表示从第一条开始读取。阻塞模式可以使用$表示最新消息ID</span></span></li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">redis-cli 下示例：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&gt; xread COUNT </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">2</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> STREAMS mystream </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0-0</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 读取 2 个消息队列stream</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&gt; xadd myapple * applekeyone apple1</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&gt; xread COUNT </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">2</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> STREAMS mystream myapple </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0-0</span></span> <span style="background-color:#f2f4f5"><span style="color:#880000">0-0</span></span></span></p> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XLEN：获取消息队列长度</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#969896">// 语法</span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XLEN key</span></span></p> 
<ul><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key: 表示消息队列名称</span></span></li></ul> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&gt; xlen mystream</span></span></span></p> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XRANGE：获取范围队列长度</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XRANGE key </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">start</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">end</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> [COUNT count]</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key： 消息队列名称</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">start：起始消息 ID</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">end：结束消息 ID</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[COUNT count]：读取指定消息的数量。COUNT 关键字，count 数值</span></span></li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">例子：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// - + 表示读取所有</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&gt; xrange mystream - +  </span></span></span></p> 
<ol><li style="text-align:left">
<span style="background-color:#ffffff"><span style="color:#314659">XDEL：消息队列删除，</span></span><a href="https://redis.io/commands/xdel/" title="XDEL | Redis">XDEL | Redis</a>
</li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XDEL key </span></span><span style="background-color:#f2f4f5"><span style="color:#0000ff">id</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> [</span></span><span style="background-color:#f2f4f5"><span style="color:#0000ff">id</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> ...]</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key：消息队列名称</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">id：消息队列ID</span></span></li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">例子：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&gt; xadd myapple * applekeyone apple1</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"1678952235530-0"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&gt; xadd myapple * two apple2</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"1678953271739-0"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&gt; xadd myapple * three apple3</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"1678953284915-0"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">&gt; xdel myapple </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">1678953271739-0</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><strong><span style="background-color:#ffffff"><span style="color:#314659">XGROUP 相关命令</span></span></strong></span></p> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XGROUP CREATE：创建消费者组</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XGROUP CREATE key group &lt;</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">id</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> | $&gt; [</span></span><span style="background-color:#f2f4f5"><span style="color:#0000ff">MKSTREAM</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">]</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">CREATE：关键字</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key： 消息队列名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">group：要创建的消费者组名称</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">&lt;id | $&gt;：消费者从哪个 ID 开始消费数据，id - 指定消息id，id为0表示从第一个获取，$ - 表示只消费新产生的消息。</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[MKSTREAM]：可选参数，如果指定消息队列不存在，则自动创建</span></span></li>
</ul> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XGROUP SETID：设置消费者组中下一条要读取的命令</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XGROUP SETID </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">key</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">group</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> &lt;id | $&gt;</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">SETID：关键字</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key：消息队列名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">group：消费者组名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">&lt;id | $&gt;：指定具体消息id，0 可以表示重新开始处理消费者组中所有消息，$ 表示只处理新产生的消息</span></span></li>
</ul> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XGROUP DESTORY：销毁消费者组</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XGROUP DESTROY </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">key</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">group</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">DESTORY：关键字</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key：消息队列名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">group：要销毁的消费组名</span></span></li>
</ul> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XGROUP CRATECONSUMER：创建消费者</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XGROUP CREATECONSUMER </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">key</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">group</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> consumer</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">CREATECONSUMER：关键字</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key：消息队列名称</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">group：消费者组名称</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">consumer：要创建的消费者名称</span></span></li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">10：XGROUP DELCONSUMER：删除消费者</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XGROUP DELCONSUMER </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">key</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">group</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> consumer</span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><strong><span style="background-color:#ffffff"><span style="color:#314659">XINFO 相关命令</span></span></strong></span></p> 
<ol><li style="text-align:left">
<span style="background-color:#ffffff"><span style="color:#314659">XINFO CONSUMERS：用于监控消费者，</span></span><a href="https://redis.io/commands/xinfo-consumers/" title="XINFO CONSUMERS | Redis">XINFO CONSUMERS | Redis</a>
</li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XINFO CONSUMERS </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">key</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">group</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">CONSUMERS：关键字</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key：消息队列名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">group：消费者组名</span></span></li>
</ul> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XIFNO GROUPS：用于监控消费者组</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XINFO </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">GROUPS</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> key</span></span></p> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XINFO STREAM：监控消息队列</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XINFO STREAM key [FULL [</span></span><span style="background-color:#f2f4f5"><span style="color:#0000ff">COUNT</span></span> <span style="background-color:#f2f4f5"><span style="color:#0000ff">count</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">]]</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">STREAM：关键字</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key：消息队列名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[FULL [COUNT count]]：FULL 表示所有消息队列；COUNT 关键字，count 表示数值，多少个消息队列</span></span></li>
</ul> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XREADGROUP：分组消费</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XREADGROUP GROUP group consumer </span></span><span style="background-color:#f2f4f5"><span style="color:#795da3">[COUNT count]</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">[BLOCK milliseconds]</span></span></p> 
<p style="margin-left:.0001pt;text-align:left">  <span style="background-color:#f2f4f5"><span style="color:#795da3">[NOACK]</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> STREAMS key </span></span><span style="background-color:#f2f4f5"><span style="color:#795da3">[key ...]</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> id </span></span><span style="background-color:#f2f4f5"><span style="color:#795da3">[id ...]</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">GROUP：关键字</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">group：消费者组名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[COUNT count]：可选参数，指定读取消息的数量。COUNT 为关键字，count 读取具体的数值</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[BLOCK milliseconds]：可选参数，设置为阻塞读取。BLOCK 为关键字，milliseconds 设置阻塞时间。默认为非阻塞</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[NOACK]：可选参数，表示不要将消息加入Pending等待队列中，相当于消息读取时进行消息确认</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">STREAMS：关键字</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key [key ...]：消息队列的名称，可以传入多个名称。</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">id [id ...]：从哪个消息ID开始读，与上面的 key 一一对应。如果为 0 表示从第一条消息开始读。在阻塞模式中，可以用 $ 表示最新的消息ID。非阻塞模式下 $ 没有意义。</span></span></li>
</ul> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XPENDING：用于获取等待队列。等待队列中保存了消费者组内被读取但还未完成处理的消息，也就是还没被ACK的消息</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XPENDING key group </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">[[IDLE min-idle-time] start end count [consumer]]</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key：消息队列名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">group：消费者组的名称</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[IDLE min-idle-time]：可选参数，IDLE 关键字，表示指定消息已读取时长，min-idle-time 表示具体数值</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">start：起始消息ID</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">end：结束消息ID</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">count：读取消息的条数</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[consumer]：可选参数，表示消费者名称</span></span></li>
</ul> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XACK：用于进行消息确认</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XACK key group </span></span><span style="background-color:#f2f4f5"><span style="color:#0000ff">id</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> [</span></span><span style="background-color:#f2f4f5"><span style="color:#0000ff">id</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> ...]</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key：消息队列名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">group：消费者组名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">id：消息ID，可以传入多个</span></span></li>
</ul> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XCLAIM：消息转移。当某个等待队列中的消息长时间没有被处理（没被ACK）时，可以用这个命令将其转移到其它消费者等待列表中。</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XCLAIM key group consumer min-idle-</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">time</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> id </span></span><span style="background-color:#f2f4f5"><span style="color:#795da3">[id ...]</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">[IDLE ms]</span></span></p> 
<p style="margin-left:.0001pt;text-align:left">  <span style="background-color:#f2f4f5"><span style="color:#795da3">[TIME unix-time-milliseconds]</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">[RETRYCOUNT count]</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">[FORCE]</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">[JUSTID]</span></span></p> 
<p style="margin-left:.0001pt;text-align:left">  <span style="background-color:#f2f4f5"><span style="color:#795da3">[LASTID lastid]</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key：消息队列名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">group：消费者组名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">consumer：消费者名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">min-idle-time：表示消息空闲时长（表示消息已经读取，但还未处理）</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">id [id...]：可选参数，要转移的消息ID，可传入多个ID</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[IDLE ms]：可选参数，设置消息空闲时间</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[TIME unix-time-milliseconds]：可选参数，它将空闲时间设置为特定的UNIX时间，以毫秒为单位。</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[RETRYCOUNT count]：可选参数，设置重试计数器的值，每次消息读取时，计数器的值都会递增。一般不需要修改这个值。</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[FORCE]：可选参数，强制将消息ID加入到执行消费者的等待列表中</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[JUSTID]：可选参数，仅返回要转移消息的ID，使用此参数意味着重试计数器不会递增</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[LASTID lastid]：可选参数，返回最后一个消息ID</span></span></li>
</ul> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XREADGROUP：对消息组进行读取</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#333333">XREADGROUP GROUP group consumer </span></span><span style="background-color:#f2f4f5"><span style="color:#795da3">[COUNT count]</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">[BLOCK milliseconds]</span></span></p> 
<p style="margin-left:.0001pt;text-align:left">  <span style="background-color:#f2f4f5"><span style="color:#795da3">[NOACK]</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> STREAMS key </span></span><span style="background-color:#f2f4f5"><span style="color:#795da3">[key ...]</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> id </span></span><span style="background-color:#f2f4f5"><span style="color:#795da3">[id ...]</span></span></p> 
<ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">GROUP：关键字</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">group：消费者组名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">consumer：消费者名</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[COUNT count]：可选参数，每个流读取的数量，COUNT 为关键字，count为读取数值</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[BLOCK milliseconds]：可选参数，用阻塞的方式执行。BLOCK 为关键字，milliseconds为阻塞毫秒数。如果为 0 表示阻塞直到出现可返回的元素为止。</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">[NOACK]：可选参数，读取消息时是否确认。true-需要确认，false-不需要确认</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">STREAMS key [key ...] id [id ...]：STREAMS 关键字，key 消息队列明，id 消息ID。</span></span></li>
</ul> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">XTRIM：对流进行裁剪，</span></span></li></ol> 
<h4 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>stream tutorial</strong></span></span></strong><a href="#3409198295"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h4> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">官方地址：</span></span><a href="https://redis.io/docs/data-types/streams-tutorial/" title="Redis Streams tutorial | Redis">Redis Streams tutorial | Redis</a></span></p> 
<h4 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>代码例子</strong></span></span></strong><a href="#941421806"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h4> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">xadd 添加一个消息队列：</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"time"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/go-redis/redis/v8"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"localhost:6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Password:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">DB:          </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">IdleTimeout: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">350</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">PoolSize:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">50</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 连接池连接数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx, cancel := context.WithTimeout(context.Background(), time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cancel()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err := rdb.Ping(ctx).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 检查连接redis是否成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Connect Failed: %v n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XADD，添加消息到对尾（这个代码每运行一次就增加一次内容）</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">err = rdb.XAdd(ctx, &amp;redis.XAddArgs{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Stream:     </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 设置流stream的 key，消息队列名</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">NoMkStream: </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">false</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,         </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//为false，key不存在会新建</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">MaxLen:     </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10000</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,         </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//消息队列最大长度，队列长度超过设置最大长度后，旧消息会被删除</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Approx:     </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">false</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,         </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//默认false，设为true时，模糊指定stram的长度</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ID:         </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"*"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,           </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//消息ID，* 表示由Redis自动生成</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Values: []</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">interface</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{}{ </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//消息队列的内容，键值对形式</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"apple"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"12.0"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"orange"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"5.6"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"banana"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"7.6"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">},</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// MinID: "id",//超过设置长度值，丢弃小于MinID消息id</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// Limit: 1000, //限制长度，基本不用</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}).Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">创建一个消费者组</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"time"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/go-redis/redis/v8"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"localhost:6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Password:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">DB:          </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">IdleTimeout: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">350</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">PoolSize:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">50</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 连接池连接数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx, cancel := context.WithTimeout(context.Background(), time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cancel()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err := rdb.Ping(ctx).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 检查连接redis是否成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Connect Failed: %v n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XGroupCreate，创建一个消费者组</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">err = rdb.XGroupCreate(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_group1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"0"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Err() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 0-从第一个获取，$-从最新获取</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">获取、读取消息队列信息、确认信息、获取流信息、消费者组信息、消费者信息</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"time"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/go-redis/redis/v8"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"localhost:6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Password:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">DB:          </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">IdleTimeout: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">350</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">PoolSize:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">50</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 连接池连接数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx, cancel := context.WithTimeout(context.Background(), time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cancel()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err := rdb.Ping(ctx).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 检查连接redis是否成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Connect Failed: %v n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">//XLEN，获取stream中元素数量，也就是消息队列长度</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">len</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err := rdb.XLen(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XLen: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#0000ff">len</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XRead，从消息队列获取数据，阻塞或非阻塞</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">val, err := rdb.XRead(ctx, &amp;redis.XReadArgs{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Block:   time.Second * </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,               </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 如果Block设置为0，表示一直阻塞，默认非阻塞。这里设置阻塞10s</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Count:   </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">2</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,                              </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 读取消息的数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Streams: []</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">string</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{<!-- --></span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"0-0"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">}, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 消息队列名称，从哪个ID开始读起，0-0 表示从mystreamone的第一个ID开始读</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XRead: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, val)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XRANGE，从队列左边获取值，ID 从小到大</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">vals, err := rdb.XRange(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"-"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"+"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//- + 表示读取所有</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XRange: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, vals)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XRangeN，从队列左边获取N个值，ID 从小到大</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">vals, _ = rdb.XRangeN(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"-"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"+"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">2</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//顺序获取队列前2个值</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XRangeN: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, vals)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XRevRange，从队列右边获取值，ID 从大到小，与XRANGE相反</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">vals, _ = rdb.XRevRange(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"+"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"-"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XRevRange: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, vals)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XRevRangeN，从队列右边获取N个值，ID 从大到小</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// rdb.XRevRangeN(ctx, "mystreamone", "+", "-", 2).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">//XDEL - 删除消息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">//err = rdb.XDel(ctx, "mystreamone", "1678984704869-0").Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// ========= 消费者组相关操作 API ===========</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XGroupCreate，创建一个消费者组</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">/*</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">   err = rdb.XGroupCreate(ctx, "mystreamone", "test_group1", "0").Err() // 0-从第一个获取，$-从最新获取</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">if err != nil {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">panic(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">*/</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XReadGroup，读取消费者中消息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">readgroupval, err := rdb.XReadGroup(ctx, &amp;redis.XReadGroupArgs{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// Streams第二个参数为ID，list of streams and ids, e.g. stream1 stream2 id1 id2</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// id为 &gt;，表示最新未读消息ID，也是未被分配给其他消费者的最新消息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// id为 0 或其他，表示可以获取已读但未确认的消息。这种情况下BLOCK和NOACK都会忽略</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// id为具体ID，表示获取这个消费者组的pending的历史消息，而不是新消息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Streams:  []</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">string</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{<!-- --></span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"&gt;"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">},</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Group:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_group1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,    </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//消费者组名</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Consumer: </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_consumer1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 消费者名</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Count:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">1</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Block:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,    </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 是否阻塞，=0 表示阻塞且没有超时限制。只要大于1条消息就立即返回</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">NoAck:    </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">true</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// true-表示读取消息时确认消息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XReadGroup: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, readgroupval)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XPending，获取待处理的消息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">count, err := rdb.XPending(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_group1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XPending: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, count)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XAck , 将消息标记为已处理</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">err = rdb.XAck(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_group1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"1678984704869-0"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XClaim ， 转移消息的归属权</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">claiminfo, err := rdb.XClaim(ctx, &amp;redis.XClaimArgs{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Stream:   </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Group:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_group1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Consumer: </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_consumer2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">MinIdle:  time.Second * </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 表示要转移的消息需要最少空闲 10s 才能转移</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Messages: []</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">string</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{<!-- --></span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"1678984704869-0"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">},</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XClaim: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, claiminfo)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XInfoStream , 获取流的消息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">info, err := rdb.XInfoStream(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XInfoStream: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, info)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XInfoGroups , 获取消费者组消息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">groupinfo, _ := rdb.XInfoGroups(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XInfoGroups: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, groupinfo)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XInfoConsumer ，获取消费者信息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">consumerinfo, _ := rdb.XInfoConsumers(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_group1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XInfoConsumers: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, consumerinfo)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">删除相关信息</span></span></li></ol> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">删除消息队列里的消息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//XDEL - 删除消息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">count, _ := rdb.XDel(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"1678984704869-0"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"1678984915646-0"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"1678985389693-0"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"1678985099142-0"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XDel: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, count)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">删除消费者信息和消费者组信息</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">//XGroupDelConsumer，删除消费者</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">count, _ := rdb.XGroupDelConsumer(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_group1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_consumer1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XGroupDelConsumer: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, count)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// XGroupDestroy , 删除消费者组</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">count, _ = rdb.XGroupDestroy(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mystreamone"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"test_group1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"XGroupDestroy: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, count)</span></span></span></p> 
<h2 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>二、Pipelining管道化</strong></span></span></strong><a href="#3580154512"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h2> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Redis 中的 pipelining 是一种通过一次发送多个命令而不必等待对每个命令响应，用这种方式来提高性能的一种技术。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">下面的大部分代码来自 go-redis 官方文档：</span></span><a href="https://redis.uptrace.dev/guide/go-redis-pipelines.html%E3%80%82" title="https://redis.uptrace.dev/guide/go-redis-pipelines.html。">https://redis.uptrace.dev/guide/go-redis-pipelines.html。</a></span></p> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">pipeline 基础使用， 用 pipeline 一次执行多条命令：</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"time"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/go-redis/redis/v8"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"localhost:6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Password:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">DB:          </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">IdleTimeout: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">350</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">PoolSize:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">50</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 连接池连接数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx, cancel := context.WithTimeout(context.Background(), time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cancel()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err := rdb.Ping(ctx).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 检查连接redis是否成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Connect Failed: %v n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 一次执行 2 个删除命令</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb.Set(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"setkey1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"value1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb.Set(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"setkey2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"value2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">pipe := rdb.Pipeline()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">pipe.Del(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"setkey1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">pipe.Del(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"setkey2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">cmds, err := pipe.Exec(ctx)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Pipeline: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, cmds)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 一次执行写和加上过期时间命令，用 pipeline 一次执行这2条命令</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">incr := pipe.Incr(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"pipeline_counter"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)           </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// Incr 相当于写入</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">pipe.Expire(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"pipeline_counter"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">60</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">) </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 加上过期时间</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">cmds, err = pipe.Exec(ctx)  </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 执行 pipeline</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff">    <span style="background-color:#f2f4f5"><span style="color:#969896">// 执行 pipe.Exec() 后获取结果</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Pipeline: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, incr.Val())</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<ol><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">Pipelined 方法</span></span></li></ol> 
<ul><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">它可以把 pipeline 执行多条命令作为一个函数整体来执行，看着像省略 Exec() 执行方法，其实这个 Pipelined 函数里就包含了 Exec()。执行后返回结果。代码示例如下：</span></span></li></ul> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// Pipelined, 另外一种方法 Pipelined</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">var</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> incr2 *redis.IntCmd</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">cmds, err := rdb.Pipelined(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(pipe redis.Pipeliner)</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    incr2 = pipe.Incr(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"pipeline_counter2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    pipe.Expire(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"pipeline_counter2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">60</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff">    <span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span> <span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff">    <span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Pipelined: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, incr2.Val())</span></span></span></p> 
<ul><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">批量结果，Pipelined 执行后批量返回结果，返回结果都存储在类似于 *redis.XXXCmd 的指针中，</span></span></li></ul> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 遍历 pipeline 命令执行后的返回值</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">cmds, err := rdb.Pipelined(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(pipe redis.Pipeliner)</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff">    <span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> i := </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">; i &lt; </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">5</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">; i++ {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">        pipe.Set(ctx, fmt.Sprintf(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"key%d"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, i), fmt.Sprintf(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"val%d"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, i), </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    }</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff">    <span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span> <span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff">    <span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> _, cmd := </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">range</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cmds {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    fmt.Println(cmd.(*redis.StatusCmd).Val())</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<ul><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">Pipelined() 方法简析，源码如下：</span></span></li></ul> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// https://github.com/redis/go-redis/blob/v8/pipeline.go#L128</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (c *Pipeline)</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> Pipelined(ctx context.Context, fn </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(Pipeliner)</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">) ([]Cmder, </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">) {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err := fn(c); err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span> <span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    cmds, err := c.Exec(ctx) </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 看见没，这里会执行 Exec() 方法</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_ = c.Close()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cmds, err</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// Pipeliner 是一个接口，接口就可以调用实现了它的方法了</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">type</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> Pipeliner </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">interface</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">StatefulCmdable</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Len() </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">int</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Do(ctx context.Context, args ...</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">interface</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{}) *Cmd</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Process(ctx context.Context, cmd Cmder) </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Close() </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Discard() </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Exec(ctx context.Context) ([]Cmder, </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<h2 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>三、Transaction事务</strong></span></span></strong><a href="#3602722094"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h2> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>事务命令介绍</strong></span></span></strong><a href="#1658617388"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Redis 事务允许在单个步骤中执行一组命令。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">事务中所有命令都被序列化并按照顺序执行。另外一个客户端发送的请求永远不会在Redis事务执行过程中得到处理，这保证了命令作为单个命令原子执行。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">在 Redis 中使用事务时，有几个相关命令，</span></span><span style="background-color:#f2f4f5"><span style="color:#314659">EXEC、MULTI、WATCH、UNWATCH</span></span><span style="background-color:#ffffff"><span style="color:#314659">，还有一个 </span></span><span style="background-color:#f2f4f5"><span style="color:#314659">DISCARD</span></span><span style="background-color:#ffffff"><span style="color:#314659">。</span></span></span></p> 
<ul><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">MULTI：标记一个事务开始。在一个事务内有多条命令会按照先后顺序放进一个队列中，最后由 EXEC 命令原子的执行。</span></span></li></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">multi 命令例子：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; MULTI</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">OK</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; INCR count1</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">QUEUED</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; INCR count2</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">QUEUED</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; PING</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">QUEUED</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; EXEC</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">1) (integer) 1</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">2) (integer) 2</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">3) PONG</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt;</span></span></span></p> 
<ul><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">EXEC：触发执行事务内的所有命令，如上面的例子。</span></span></li></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">如果某个或某些 key 正处于 WATCH 命令监视之下，并且事务中有和这些 key 相关的命令，那么 EXEC 命令只有在这个或这些key 没有被其他命令所改动的情况下执行并生效，否则该事务会被打断。</span></span></p> 
<ul><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">WATCH：监视一个key或多个key，如果事务在执行之前，这个key或多个key被其他命令改动，那么事务将被打断</span></span></li></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#f2f4f5"><span style="color:#314659">WATCH key [key …]</span></span></p> 
<ul><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">UNWATCH：取消 WATCH 命令对所有key的监视。它没有任何参数。</span></span></li></ul> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; WATCH lockone locktwo</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">OK</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; MULTI</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">OK</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; SET lockone "testwatch"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">QUEUED</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; INCR locktwo</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">QUEUED</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; EXEC</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">1) OK</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">2) (integer) 1</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">如果你又开另外一个客户端：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; WATCH lockone locktwo</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">OK</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; MULTI</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">OK</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; SET lockone "testwatch2"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">QUEUED</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; INCR locktwo</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">QUEUED</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; EXEC  # locktwo 这时被另外一个客户端修改了，testwatch2 执行也失败</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">(nil)</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">UNWATCH 命令：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; UNWATCH</span></span></span></p> 
<ul><li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">DISCARD：取消事务，放弃执行事务内的所有命令</span></span></li></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">DISCARD 命令例子：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; MULTI</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">OK</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; PING</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">QUEUED</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; SET helloworld "hello"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">QUEUED</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">127.0.0.1:6379&gt; DISCARD</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">OK</span></span></span></p> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>TxPipeline和TxPipelined包装MULTI和EXEC</strong></span></span></strong><a href="#1857753163"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">TxPipeline 和 TxPipelined 是把 Redis 中的 2 个事务命令 MULTI 和 EXEC 包装起来，然后用 pipeline 来执行命令。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">这 2 个命令和 pipeline 和 pipelined 用法几乎相同。</span></span></span></p> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>代码例子</strong></span></span></strong><a href="#1950940084"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"time"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/go-redis/redis/v8"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"localhost:6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Password:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">DB:          </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">IdleTimeout: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">350</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">PoolSize:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">50</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 连接池连接数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx, cancel := context.WithTimeout(context.Background(), time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cancel()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err := rdb.Ping(ctx).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 检查连接redis是否成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Connect Failed: %v n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 一次执行 2 个删除命令</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb.Set(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"setkey1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"value1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb.Set(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"setkey2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"value2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">//TxPipeline</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">txpipe := rdb.TxPipeline()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">txpipe.Del(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"setkey1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">txpipe.Del(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"setkey2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">cmds, err := txpipe.Exec(ctx) </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 执行 TxPipeline 里的命令</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"TxPipeline: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, cmds)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// TxPipelined</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">var</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> incr2 *redis.IntCmd</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">cmds, err = rdb.TxPipelined(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(txpipe redis.Pipeliner)</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">txpipe.Set(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"txpipeline_counter2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">30</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">120</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">incr2 = txpipe.Incr(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"txpipeline_counter2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">txpipe.Expire(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"txpipeline_counter2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">300</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span> <span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"TxPipelined: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, incr2.Val())</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"cmds: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, cmds)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">/*</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">TxPipeline:  [del setkey1: 1 del setkey2: 1]</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">TxPipelined:  31</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">cmds:  [set txpipeline_counter2 30 ex 120: OK incr txpipeline_counter2: 31 expire txpipeline_counter2 300: true]</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">*/</span></span></span></p> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>Watch监视</strong></span></span></strong><a href="#1094751369"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">watch 监视一个key或多个key。如果事务在执行之前，这个key或多个key被其他命令改动，那么事务将被打断。</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">你使用 watch 在一个客户端上监视一些操作命令，然后另外开一个客户端执行相同的命令，那么 watch 会监视这种变动从而取消事务操作。</span></span></span></p> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>代码例子</strong></span></span></strong><a href="#3610747517"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">这是官方文档的一个例子，改一下：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"strconv"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"sync"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"time"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/go-redis/redis/v8"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"localhost:6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Password:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">DB:          </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">IdleTimeout: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">350</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">PoolSize:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">50</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 连接池连接数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx, cancel := context.WithTimeout(context.Background(), time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cancel()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err := rdb.Ping(ctx).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 检查连接redis是否成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Connect Failed: %v n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">var</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> incr </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">string</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">incr = </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(key </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">string</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">err = rdb.Watch(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(tx *redis.Tx)</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> { </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//Watch 监控函数</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">n, err := tx.Get(ctx, key).Int64() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 先查询下当前watch监听的key的值</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> &amp;&amp; err != redis.Nil {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 如果key的值没有改变的话，pipe 函数才会调用成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err = tx.TxPipelined(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(pipe redis.Pipeliner)</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">pipe.Set(ctx, key, strconv.FormatInt(n+</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">1</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">), </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span> <span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}, key)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err == redis.TxFailedErr {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> incr(key)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">keyname := </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"keynameone"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">var</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> wg sync.WaitGroup</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> i := </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">; i &lt; </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">; i++ {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">wg.Add(</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">1</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">go</span></span> <span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> wg.Done()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">err := incr(keyname)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"[for] err: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">wg.Wait()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">n, err := rdb.Get(ctx, keyname).Int64()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"last key val: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, n)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<h2 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>四、pub/sub 发布/订阅</strong></span></span></strong><a href="#468861046"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h2> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>简介</strong></span></span></strong><a href="#2858853619"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Redis 的发布订阅功能，有三大部分：发布者、订阅者和 Channel 频道。发布者和订阅者都是 Redis 客户端，Channel 频道是Redis 服务器。发布者将消息发送到某个频道，订阅了这条频道的订阅者就能收到这条消息。</span></span></span></p> 
<p style="margin-left:0;text-align:left"></p> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>常用命令</strong></span></span></strong><a href="#3067543686"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<ul><li style="text-align:left"></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">PUBLISH ：</span></span><span style="background-color:#f2f4f5"><span style="color:#314659">publish channel message</span></span><span style="background-color:#ffffff"><span style="color:#314659">，向channel频道发布消息</span></span></p> 
<ul>
<li style="text-align:left">
</li>
<li style="text-align:left">
</li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">SUBSCRIBE：</span></span><span style="background-color:#f2f4f5"><span style="color:#314659">subscribe channel [channel ...]</span></span><span style="background-color:#ffffff"><span style="color:#314659">，订阅频道</span></span></p> 
<ul>
<li style="text-align:left">
</li>
<li style="text-align:left">
</li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">PSUBSCRIBE：</span></span><span style="background-color:#f2f4f5"><span style="color:#314659">psubscribe pattern [pattern …]</span></span><span style="background-color:#ffffff"><span style="color:#314659">，订阅多个符合模式的频道</span></span></p> 
<ul>
<li style="text-align:left">
</li>
<li style="text-align:left">
</li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">UNSUBSCRIBE：</span></span><span style="background-color:#f2f4f5"><span style="color:#314659">unsubscribe [channel [channel …]]</span></span><span style="background-color:#ffffff"><span style="color:#314659">，客户端退订频道，可以退订多个频道</span></span></p> 
<ul>
<li style="text-align:left">
</li>
<li style="text-align:left">
</li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">PUNSUBSCRIBE：</span></span><span style="background-color:#f2f4f5"><span style="color:#314659">punsubscribe [pattern [pattern …]]</span></span><span style="background-color:#ffffff"><span style="color:#314659">，指定客户端退订多个符合模式的频道</span></span></p> 
<ul>
<li style="text-align:left">
</li>
<li style="text-align:left">
</li>
</ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">PUBSUB：查看订阅和发布系统状态的命令，它由数个不同格式子命令组成</span></span></p> 
<ul><li style="text-align:left"></ul> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>代码例子</strong></span></span></strong><a href="#1724829906"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">publish 频道发布消息：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"time"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/go-redis/redis/v8"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"localhost:6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Password:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">DB:          </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">IdleTimeout: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">350</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">PoolSize:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">50</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 连接池连接数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx, cancel := context.WithTimeout(context.Background(), time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cancel()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err := rdb.Ping(ctx).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 检查连接redis是否成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Connect Failed: %v n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx = context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 向频道 mychannel1 发布消息 payload1</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">err = rdb.Publish(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"payload1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">val, err := rdb.Publish(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"hello"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(val)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb.Publish(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"hello2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">subscribe 订阅频道消息：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// Subscribe，订阅频道接收消息// pubsub := rdb.Subscribe(ctx, "mychannel1")</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">pubsub := rdb.Subscribe(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> pubsub.Close()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 第一种接收消息方法// ch := pubsub.Channel()// for msg := range ch {// fmt.Println(msg.Channel, msg.Payload)// }</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 第二种接收消息方法</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    msg, err := pubsub.ReceiveMessage(ctx)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff">    <span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff">        <span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    }</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    fmt.Println(msg.Channel, msg.Payload)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">PSubscribe 模式匹配订阅频道消息：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">pubsub := rdb.PSubscribe(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel*"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> pubsub.Close()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 第一种接收消息方法</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ch := pubsub.Channel()</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> msg := </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">range</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> ch {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    fmt.Println(msg.Channel, msg.Payload)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Unsubscribe 退订频道：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// Subscribe，订阅频道</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">pubsub := rdb.Subscribe(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychanne2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> pubsub.Close()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 退订具体频道</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">unsub := pubsub.Unsubscribe(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// 按照模式匹配退订</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">pubsub.PUnsubscribe(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel*"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">查询频道相关信息、订阅者信息：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ps := rdb.Subscribe(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel*"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> ps.Close()</span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// PubSubChannels，查询活跃的频道</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"====PubSubChannels===="</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">channels, _ := rdb.PubSubChannels(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//"" 为空，查询所有活跃的channel频道</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> ch, v := </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">range</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> channels {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    fmt.Println(ch, v)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 指定匹配模式</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">channels, _ = rdb.PubSubChannels(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel*"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> ch, v := </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">range</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> channels {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"PubSubChannels* ："</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, ch, v)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"====PubSubNumSub===="</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// PubSubNumSub，具体的channel有多少个订阅者</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">numsub, _ := rdb.PubSubNumSub(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel1"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel2"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Result()</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> ch, count := </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">range</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> numsub {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">    fmt.Println(ch, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">","</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, count) </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// ch-channel名字，count-channel的订阅者数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// PubSubNumPat， 模式匹配</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">pubsub := rdb.PSubscribe(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"mychannel*"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> pubsub.Close()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">numsubpat, _ := rdb.PubSubNumPat(ctx).Result()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"PubSubNumPat: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, numsubpat)</span></span></span></p> 
<h2 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>五、Lua脚本</strong></span></span></strong><a href="#1685792697"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h2> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>介绍</strong></span></span></strong><a href="#3677780734"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">从Redis2.6开始，通过内置的 Lua 解释器，可以使用 EVAL 命令对 lua 脚本进行求值。</span></span></span></p> 
<ul><li style="text-align:left">
<span style="background-color:#ffffff"><span style="color:#314659">EVAL：语法 </span></span><span style="background-color:#f2f4f5"><span style="color:#314659">EVAL script numkeys key [key …] arg [arg …]</span></span> 
  <ul>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">script：一段 lua5.1脚本程序，它会被运行在redis服务器下</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">numkeys：用于指定健名参数的个数</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">key [key …]：从 EVAL 的第三个参数开始算起，表示在脚本中所用到的那些 Redis 键(key)。这些键可以通过lua的全局变量KEYS数组获取，用 1 访问形式 KEYS[1], 2 是 KEYS[2]</span></span></li>
<li style="text-align:left"><span style="background-color:#ffffff"><span style="color:#314659">arg [arg …]：附加参数，可以在lua中用全局变量 ARGV 数组访问，访问形式 ARGV[1]，ARGC[2] 等。</span></span></li>
</ul>
</li></ul> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">命令例子：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">&gt; </span></span><span style="background-color:#f2f4f5"><span style="color:#0000ff">eval</span></span> <span style="background-color:#f2f4f5"><span style="color:#df5000">"return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> 2 key1 key2 first second</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">1) "key1"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">2) "key2"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">3) "first"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">4) "second"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">// first second 都是附加参数</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">在 Lua 脚本中，可以用 redis.call() 和 redis.pcall() 来还行 Redis 命令。</span></span></span></p> 
<h3 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>代码例子</strong></span></span></strong><a href="#3398382227"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h3> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">直接拿官网的例子来看，</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// https://github.com/redis/go-redis/blob/master/example/lua-scripting/main.go</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/redis/go-redis/v9"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx := context.Background()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr: </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">":6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_ = rdb.FlushDB(ctx).Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Printf(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"# INCR BYn"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">for</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> _, change := </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">range</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> []</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">int</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{+</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">1</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, +</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">5</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">} {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">num, err := incrBy.Run(ctx, rdb, []</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">string</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{<!-- --></span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"my_counter"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">}, change).Int()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Printf(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"incr by %d: %dn"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, change, num)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Printf(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"n# SUMn"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">sum, err := sum.Run(ctx, rdb, []</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">string</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{<!-- --></span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"my_sum"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">}, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">1</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">2</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">3</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Int()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Printf(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"sum is: %dn"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, sum)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">var</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> incrBy = redis.NewScript(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">`</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">local key = KEYS[1]</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">local change = ARGV[1]</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">local value = redis.call("GET", key)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">if not value then</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">  value = 0</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">end</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">value = value + change</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">redis.call("SET", key, value)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">return value</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">`</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">var</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> sum = redis.NewScript(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">`</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">local key = KEYS[1]</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">local sum = redis.call("GET", key)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">if not sum then</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">  sum = 0</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">end</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">local num_arg = #ARGV</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">for i = 1, num_arg do</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">  sum = sum + ARGV[i]</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">end</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">redis.call("SET", key, sum)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">return sum</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">`</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<h2 style="margin-left:0pt;text-align:left"><span style="background-color:#ffffff"><strong><strong><span style="background-color:#ffffff"><span style="color:#314659"><strong>六、Do任意命令和用户自定义命令</strong></span></span></strong><a href="#2492189777"><strong><span style="background-color:#ffffff"><span style="color:#2d8cf0"><strong>#</strong></span></span></strong></a></strong></span></h2> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">go-redis 中提供了一个 Do 方法，它可以执行任意方法.</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Do方法例子：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">package</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> main</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">import</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"context"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"fmt"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"time"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#df5000">"github.com/go-redis/redis/v8"</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">main</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">()</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">rdb := redis.NewClient(&amp;redis.Options{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Addr:        </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"localhost:6379"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">Password:    </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">""</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">DB:          </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">0</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">IdleTimeout: </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">350</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">PoolSize:    </span></span><span style="background-color:#f2f4f5"><span style="color:#880000">50</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 连接池连接数量</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">})</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx, cancel := context.WithTimeout(context.Background(), time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">10</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">defer</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cancel()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_, err := rdb.Ping(ctx).Result() </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 检查连接redis是否成功</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">if</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> err != </span></span><span style="background-color:#f2f4f5"><span style="color:#0086b3">nil</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Connect Failed: %v n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#0000ff">panic</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">v := rdb.Do(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"get"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"key_does_not_exist"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).String()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Printf(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"%q n"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, v)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">err = rdb.Do(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"set"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"set-key"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"set-val"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"EX"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, time.Second*</span></span><span style="background-color:#f2f4f5"><span style="color:#880000">120</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).Err()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Do set: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, err)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">v = rdb.Do(ctx, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"get"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, </span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"set-key"</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">).String()</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">fmt.Println(</span></span><span style="background-color:#f2f4f5"><span style="color:#df5000">"Do get: "</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">, v)</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:0;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Do 源码：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#ffffff"><span style="color:#314659">Copy</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#969896">// https://github.com/redis/go-redis/blob/v8.2.0/redis.go#LL592C2-L592C2</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> (c *Client)</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> Do(ctx context.Context, args ...</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">interface</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{}) *Cmd {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">cmd := NewCmd(ctx, args...) </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 构造 Cmd struct</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_ = c.Process(ctx, cmd) </span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// 执行 cmd</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> cmd</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//https://github.com/redis/go-redis/blob/v8.2.0/command.go#L196</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">func</span></span> <span style="background-color:#f2f4f5"><span style="color:#795da3">NewCmd</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">(ctx context.Context, args ...</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">interface</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{})</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> *Cmd {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#a71d5d">return</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> &amp;Cmd{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">baseCmd: baseCmd{<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx:  ctx,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">args: args,</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">},</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span><span style="background-color:#f2f4f5"><span style="color:#969896">// https://github.com/redis/go-redis/blob/v8.2.0/command.go#L183</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">type</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> Cmd </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">struct</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">baseCmd</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">val </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">interface</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span><span style="background-color:#f2f4f5"><span style="color:#969896">//https://github.com/redis/go-redis/blob/v8.2.0/command.go#L111 </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">type</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> baseCmd </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">struct</span></span><span style="background-color:#f2f4f5"><span style="color:#333333"> {<!-- --></span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">ctx    context.Context</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">args   []</span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">interface</span></span><span style="background-color:#f2f4f5"><span style="color:#333333">{}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">err    </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">error</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">keyPos </span></span><span style="background-color:#f2f4f5"><span style="color:#a71d5d">int8</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">_readTimeout *time.Duration</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left"><span style="background-color:#ffffff"><span style="background-color:#f2f4f5"><span style="color:#333333">}</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:justify"></p>
                </div>

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>