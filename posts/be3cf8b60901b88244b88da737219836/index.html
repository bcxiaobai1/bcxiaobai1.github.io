<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>NXP S32K146 CAN通讯 TJA1043（一） - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">NXP S32K146 CAN通讯 TJA1043（一）</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <p>今天来调一下nxp S32K146的CAN通讯，硬件部分使用的是NXP TJA1043 CAN通讯芯片先翻译一下数据手册。<br> <strong>一、TJA1043 有这么几个特点：</strong><br> ①几种保护和诊断功能，包括母线短路检测和电池连接检测<br> ②CANFD快速阶段以高达5Mbit/s的数据速率进行可靠的通信。<br> ③用于节点诊断和故障控制的仅监听模式<br> ④传输数据(TXD)主要超时功能与诊断（如何实现？）<br> ⑤TJA1043支持五种操作模式。控制引脚STB_N和EN用于选择操作模式。 在模式之间切换允许通过引脚ERR_N访问许多诊断标志。<br> 其他都略过了，详细看一下7.1 Operating modes</p> 
<blockquote> 
 <p><strong>正常模式Normal mode</strong><br> 在正常模式下，收发器可以通过总线CANH和CANL传输和接收数据。差分接收器将总线上的模拟数据转换为数字数据，然后输出到引脚RXD。引脚INH是运行的，因此由引脚INH控制的电压调节器也将是运行的。<br> <strong>只听模式 Listen-only mode</strong><br> 在只听模式下，收发器的发射器被禁用，有效地提供了收发器的只听”功能。接收器仍将将引脚CANH和CANL上的模拟总线信号转换为数字数据，可通过引脚RXD输出，引脚INH保持运行的。<br> <strong>待机模式Standby mode</strong><br> 待机模式是TJA1043的一级节电模式，提供减少电流消耗。在备用模式下，收发器无法传输或接收数据，并激活低功率接收机以监控总线活动。引脚INH仍然是运行的，所以由这个引脚控制的电压调节器也将是运行的。Pins RXD和ERR_N将反映任何活动的唤醒请求。<br> <strong>进入睡眠模式Go-to-Sleep mode</strong><br> 进入睡眠模式是进入睡眠模式的控制路径。在进入睡眠模式下，收发器表现为待机模式，并附加了一个向收发器发出进入睡眠的命令。在进入睡眠模式之前，收发器将保持最短保持时间。如果pin STB_N或pin EN的状态发生改变，或者在结束（分钟）之前设置了唤醒标志，收发器将不会进入休眠模式。<br> <strong>睡眠模式 Sleep mode</strong><br> 睡眠模式是TJA1043的二级节电模式。睡眠模式通过进入睡眠模式进入，当VCC或VIO的欠压检测时间在相关电压水平恢复时进入。在睡眠模式下，收发器按照待机模式的描述行为，除了引脚INH设置为浮动。由此引脚控制的电压调节器将关闭，进入引脚VBAT的电流将减少到最小。pin STB_N、EN和Wake标志可以用来从睡眠模式中唤醒。<br> <strong>注</strong>：INH拉出控制供电芯片的使能脚，也就是通过该引脚控制电源芯片是否使能。</p> 
</blockquote> 
<p>再翻译一下 7.2内部标志<br> TJA1043使用7个内部标志为其故障安全回退模式控制和系统诊断支持。控制器可以通过引脚ERR_N轮询其中五个标志。在任何时候，引脚ERR_N上可用的标志取决于活动操作模式和许多其他条件。</p> 
<blockquote> 
 <p><strong>UVNOM标志</strong><br> UVNOM是VCC和VIO欠压检测标志。当引脚VCC上的电压低于VCC欠压检测电压Vuvd(VCC)，且持续时间超过欠压检测时间tdet(uv)，或者当引脚VIO上的电压低于Vuvd(VIO)且持续时间超过tdet(uv)时，设置该标志。设置UVNOM标志后，收发器进入Sleep模式，节省电能，保证总线不受干扰。在睡眠模式下，连接到引脚INH的稳压器是禁用的，避免任何额外的功耗，可能产生的短路条件。任何唤醒请求，设置Pwon标志或STB_N上的LOW-to-HIGH转换将清除UVNOM和定时器，允许稳压器重新激活(至少直到UVNOM再次被设置)。如果VCC和VIO恢复时间超过欠压恢复时间trec(uv)， UVNOM也将被清除。然后，收发器将切换到由引脚STB_N和EN上的逻辑电平指示的工作模式。<br> <strong>UVBAT 标志</strong><br> UVBAT是VBAT欠压检测标志。当引脚VBAT上的电压低于vvd (VBAT)时设置该标志。当设置UVBAT时，收发器将尝试进入待机模式以节省电力，并将从总线断开(零负载)。当引脚VBAT电压恢复时，UVBAT被清除。然后，收发器将切换到由引脚STB_N和EN上的逻辑电平指示的工作模式。<br> <strong>Pwon 标志</strong><br> Pwon是VBAT开机标志。当引脚VBAT上的电压在之前下降到vvd (VBAT)以下后恢复时，设置该标志(通常是因为电池断开)。设置Pwon标志可以清除UVNOM标志和定时器。唤醒和唤醒源标志的设置，以确保在所有供应条件下的一致系统上电。在Listen-only模式下，Pwon标志可以通过引脚ERR_N进行轮询。当收发器进入Normal模式时，该标志被清除。<br> <strong>wake 标志</strong><br> 当收发器检测到本地或远程唤醒请求时设置唤醒标志。当引脚WAKE上的逻辑电平发生变化时，检测到本地唤醒请求，并且新电平至少在唤醒后保持稳定。可在待机模式、转睡眠模式或睡眠模式下设置唤醒标志。设置唤醒标志可以清除UVNOM标志和定时器。一旦设置，唤醒标志状态立即在引脚ERR_N和RXD上可用(提供VIO和VBAT)。该标志也在上电时设置，当设置UVNOM标志或收发器进入正常模式时清除。<br> <strong>Remote wake-up (via the CAN bus)</strong><br> 当总线上检测到专用的唤醒模式(在ISO 11898- 2:16中指定)时，TJA1043从待机或睡眠模式中唤醒。这种过滤有助于避免虚假的唤醒事件。一个虚假的唤醒序列可以被触发，例如，一个主导箝位总线或主导相位由噪声或尖峰总线上。唤醒模式包括:<br> •至少唤醒(busdom)的主导阶段紧随其后<br> •随后是至少苏醒(busrec)的隐性阶段<br> •至少唤醒(busdom)的主导阶段<br> 在上述阶段之间的显性或隐性位，分别比twake(busdom) twake(busrec)短被忽略。在tto(wake)总线内必须接收到完全的显性-隐性-显性模式，才能被识别为有效的唤醒模式(见图5)。否则，内部唤醒逻辑将被重置。然后需要重新传输完整的唤醒模式来触发唤醒事件。引脚RXD保持高，直到唤醒事件被触发。当收到一个有效的唤醒模式时，如果以下任何一个事件发生，RXD上的唤醒事件不会被标记:<br> •TJA1043切换到普通模式<br> •在to(wake)总线中没有接收到完整的唤醒模式<br> •检测到VCC或VIO欠压<br> <strong>剩下的标志也不翻译了也不大能用上。。。。</strong></p> 
</blockquote> 
<p><strong>二、S32K146 FLEXCAN SDK解读：</strong><br> FlexCAN 模块是一个通信控制器，该模块实现了 CAN 协议即CAN2.0B 协议规范。 FlexCAN 模块的字模块，包括了用来存储消息缓冲的相关联的内存区域，Rx 全局掩码寄存器、Rx 私有掩码寄存器、Rx 先进先出队列以及 Rx 队列标识过滤器。消息缓冲区存储在一个专用于 FlexCAN 模块的 RAM 区，请求存取 RAM 接收和传输消息帧，验证接收到的消息以及进行错误处理。控制器主机接口子模块用来选择接收和传输的消息缓冲区，使用仲裁与 ID 匹配算法，以建立同 CPU 或者其他模块的连接。<br> <strong>模块特征</strong>：</p> 
<ol>
<li>0 到 8<br> 字节长度报文缓冲区，每个报文缓冲区都可以配置成发送缓冲区或者接受缓冲区，支持标准和扩展帧格式，每个消息缓冲区都有自己的接受掩码控制寄存器</li>
<li>全功能的接受队列，该队列可以存储最多 6 个帧，并且自动进行内部指针处理，传输中止能力；可编程的 CAN 协议接口的时钟源，可以是总线时钟也可以是外部晶振；没有使用的结构空间可以当成普通的 RAM 空间使用；等其他特征。</li>
</ol> 
<p><strong>操作模式</strong></p> 
<ol>
<li>正常模式（用户与管理员） 在正常模式下，CAN 模块收发数据帧、处理错误，CAN协议的所有功能全部开启。对于一些控制比较严格的寄存器，在用户模式和管理员模式下访问时又区别的。</li>
<li>冻结模式<br> 如果 MCR 寄存器的 FRZ 位被置位，那么将开启 CAN 模块的冻结模式。当 MCR 的 HALT 位置位时或者在 MCU 级请求调试模式（Debug Mode）并且 MCR 寄存器的FRZ_ACK 位被置位时，CAN<br> 模块将进入到冻结模式。</li>
<li>监听模式<br> 当控制 1 寄存器的 LOM 位置位时，模块将进入到监听模式。在该模式下，CAN 模块禁止数据收发，所有的错误计数器都被冻结，且该模块工作在 CAN 被动错误模式。只有被其他 CAN节点应答了的报文才可以被监听的节点接受。如果 FlexCAN 检测到一个还没有被应答的报文，则标记为一个 BIT0 错误（不会改变 REC），将如同它试图应答报文一些样。</li>
<li>监听模式<br> 如果控制 1 寄存器的 LPB 位被置位，模块将进入到回环模式。在该模式下，FlexCAN 工作在内部闭环模式用于自测。从发送器发送出的比特流输出回内部的接收器输入。输入引脚将会被忽略，并且输出引脚将处于逻辑 1 状态。发送报文时，FlexCAN 模块和正常模式一样，而接收器则认为接受它自己的报文与接受远程节点的报文相同。FlexCAN 为保证能正确接受到自己发送的报文，将忽略应答间隙内的应答字段。报文接受发送时，如果中断使能则 FlexCAN 将向CPU 产生中断。</li>
<li>模块禁止模式<br> 当 MCR 寄存器的 MDIS 位被 CPU 置位并且 LPM_ACK 位被FlexCAN 模块置位时，模块将会进入该低功耗模式。如果模块被禁止，那么模块将会请求停止 CAN 协议引擎的时钟并且请求禁止控制器主机接口子模块。通过忽略 MCR 寄存器 MDIS 位可以退出该模式。有关该模块的更多信息参考“模块禁止模式”节。</li>
<li>睡眠模式<br> 当 MCR 寄存器的 DOZE 位被置位、在 MCU 级请求睡眠模式并且由 FlexCAN 置位 MCR 寄存器的 LPM_ACK 位时模块将进入到该低功耗模式。当模块处于睡眠模式时，FlexCAN 将会请求禁止CAN 协议引擎的时钟并且请求禁止 CAN 控制器主机接口子系统。当 MCR 寄存器的 DOZE 位被忽略（negated）、当 MCU 离开睡眠模式时或者当检测到 CAN 总线上有活动并且自醒机制开启时模块将退出睡眠模式。</li>
<li>停止模式<br> 在 MCU 级请求模式并且由 FlexCAN 模块置位 MCR 寄存器的 LPM_ACK 位时，模块将会进入到该低功耗模式。在停止模式中，模块将会将自己置于不活动状态，然后通知 CPU 可以关闭所有的时钟。当请求离开停止模式或者当检测到 CAN 总线上有或者并且开启了自醒即使时，FlexCAN将会退出该模式。</li>
</ol> 
<p><em><strong>SDK函数分析（一）</strong></em></p> 
<pre><code class="prism language-c"><span class="token comment">//这个函数将为经典帧设置所有的时间段值，</span>
<span class="token comment">//或者为FD帧的仲裁阶段设置扩展的时间段。</span>
<span class="token comment">//这些时间段值由用户传入，并基于所需的波特率。</span>
<span class="token keyword">void</span> <span class="token function">FLEXCAN_DRV_SetBitrate</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">flexcan_time_segment_t</span> <span class="token operator">*</span>bitrate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>instance <span class="token operator">&lt;</span> CAN_INSTANCE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>bitrate <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    CAN_Type <span class="token operator">*</span> base <span class="token operator">=</span> g_flexcanBase<span class="token punctuation">[</span>instance<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_FD</span></span>
    bool fdEnabled <span class="token operator">=</span> <span class="token function">FLEXCAN_IsFDEnabled</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token comment">//只有在冻结模式下才能被写入，在其他模式下该位被硬件锁定</span>
    <span class="token function">FLEXCAN_EnterFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_FD</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fdEnabled<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Set extended time segments*/</span>
        <span class="token function">FLEXCAN_SetExtendedTimeSegments</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> bitrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Set time segments*/</span>
        <span class="token function">FLEXCAN_SetTimeSegments</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> bitrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">FLEXCAN_ExitFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">FLEXCAN_SetTimeSegments</span><span class="token punctuation">(</span>CAN_Type <span class="token operator">*</span> base<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">flexcan_time_segment_t</span> <span class="token operator">*</span>timeSeg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>timeSeg <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//0bit 传播时间段 16-18bit 相位段2位时间长度 19-21 相位段1位时间长度</span>
<span class="token comment">//31-24 bit 预分频器分频系数</span>
    <span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>CTRL1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>CTRL1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CAN_CTRL1_PROPSEG_MASK <span class="token operator">|</span> CAN_CTRL1_PSEG2_MASK <span class="token operator">|</span>
                                        CAN_CTRL1_PSEG1_MASK <span class="token operator">|</span> CAN_CTRL1_PRESDIV_MASK<span class="token punctuation">)</span> <span class="token operator">|</span>
                                        CAN_CTRL1_RJW_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>CTRL1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>CTRL1<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token function">CAN_CTRL1_PROPSEG</span><span class="token punctuation">(</span>timeSeg<span class="token operator">-&gt;</span>propSeg<span class="token punctuation">)</span> <span class="token operator">|</span>
                                      <span class="token function">CAN_CTRL1_PSEG2</span><span class="token punctuation">(</span>timeSeg<span class="token operator">-&gt;</span>phaseSeg2<span class="token punctuation">)</span> <span class="token operator">|</span>
                                      <span class="token function">CAN_CTRL1_PSEG1</span><span class="token punctuation">(</span>timeSeg<span class="token operator">-&gt;</span>phaseSeg1<span class="token punctuation">)</span> <span class="token operator">|</span>
                                      <span class="token function">CAN_CTRL1_PRESDIV</span><span class="token punctuation">(</span>timeSeg<span class="token operator">-&gt;</span>preDivider<span class="token punctuation">)</span> <span class="token operator">|</span>
                                      <span class="token function">CAN_CTRL1_RJW</span><span class="token punctuation">(</span>timeSeg<span class="token operator">-&gt;</span>rJumpwidth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//FLEXCAN进入冻结模式</span>
<span class="token keyword">void</span> <span class="token function">FLEXCAN_EnterFreezeMode</span><span class="token punctuation">(</span>CAN_Type <span class="token operator">*</span> base<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	bool enabled <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token comment">//使能进入冻结模式</span>
    base<span class="token operator">-&gt;</span>MCR <span class="token operator">=</span> <span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;</span> <span class="token operator">~</span>CAN_MCR_FRZ_MASK<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">CAN_MCR_FRZ</span><span class="token punctuation">(</span><span class="token number">1U</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//暂停FlexCAN模块</span>
    base<span class="token operator">-&gt;</span>MCR <span class="token operator">=</span> <span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;</span> <span class="token operator">~</span>CAN_MCR_HALT_MASK<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">CAN_MCR_HALT</span><span class="token punctuation">(</span><span class="token number">1U</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//判断是否关FLEXCAN模块</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;</span> CAN_MCR_MDIS_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_MCR_MDIS_SHIFT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0U</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		enabled <span class="token operator">=</span> true<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		base<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;=</span> <span class="token operator">~</span>CAN_MCR_MDIS_MASK<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token comment">//冻结模式确认位</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;</span> CAN_MCR_FRZACK_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_MCR_FRZACK_SHIFT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0U</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>false <span class="token operator">==</span> enabled<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	base<span class="token operator">-&gt;</span>MCR <span class="token operator">|=</span> CAN_MCR_MDIS_MASK<span class="token punctuation">;</span>
    	<span class="token comment">//是否进入低功耗</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;</span> CAN_MCR_LPMACK_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_MCR_LPMACK_SHIFT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0U</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//这个函数将返回经典帧或FD帧仲裁阶段的当前比特率设置。</span>
<span class="token keyword">void</span>  <span class="token function">FLEXCAN_DRV_GetBitrate</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span> <span class="token class-name">flexcan_time_segment_t</span> <span class="token operator">*</span>bitrate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>instance <span class="token operator">&lt;</span> CAN_INSTANCE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>bitrate <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> CAN_Type <span class="token operator">*</span> base <span class="token operator">=</span> g_flexcanBase<span class="token punctuation">[</span>instance<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_FD</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>true <span class="token operator">==</span> <span class="token function">FLEXCAN_IsFDEnabled</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">/* Get the Extended time segments*/</span>
    	<span class="token function">FLEXCAN_GetExtendedTimeSegments</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> bitrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">/* Get the time segments*/</span>
    	<span class="token function">FLEXCAN_GetTimeSegments</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> bitrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//这个函数将返回经典帧或FD帧仲裁阶段的当前比特率设置</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">FLEXCAN_GetTimeSegments</span><span class="token punctuation">(</span><span class="token keyword">const</span> CAN_Type <span class="token operator">*</span> base<span class="token punctuation">,</span> <span class="token class-name">flexcan_time_segment_t</span> <span class="token operator">*</span>timeSeg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>timeSeg <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//得到刚才寄存器里面配置的值</span>
    timeSeg<span class="token operator">-&gt;</span>preDivider <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>CTRL1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_CTRL1_PRESDIV_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_CTRL1_PRESDIV_SHIFT<span class="token punctuation">;</span>
    timeSeg<span class="token operator">-&gt;</span>propSeg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>CTRL1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_CTRL1_PROPSEG_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_CTRL1_PROPSEG_SHIFT<span class="token punctuation">;</span>
    timeSeg<span class="token operator">-&gt;</span>phaseSeg1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>CTRL1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_CTRL1_PSEG1_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_CTRL1_PSEG1_SHIFT<span class="token punctuation">;</span>
    timeSeg<span class="token operator">-&gt;</span>phaseSeg2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>CTRL1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_CTRL1_PSEG2_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_CTRL1_PSEG2_SHIFT<span class="token punctuation">;</span>
    timeSeg<span class="token operator">-&gt;</span>rJumpwidth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>CTRL1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_CTRL1_RJW_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_CTRL1_RJW_SHIFT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//关于FLEXCAN的SDK分成两层 上层：flexcan_driver.c 底层flexcan_access.c</span>
</code></pre> 
<p><em><strong>SDK函数分析（二）</strong></em></p> 
<pre><code class="prism language-c">
<span class="token comment">//Set RX masking type</span>
<span class="token comment">//flexcan_rx_mask_type_t  分为全局/个人屏蔽</span>
<span class="token keyword">void</span>  <span class="token function">FLEXCAN_DRV_SetRxMaskType</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span> <span class="token class-name">flexcan_rx_mask_type_t</span> type<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>instance <span class="token operator">&lt;</span> CAN_INSTANCE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    CAN_Type <span class="token operator">*</span> base <span class="token operator">=</span> g_flexcanBase<span class="token punctuation">[</span>instance<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">FLEXCAN_EnterFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上边分析了</span>
    <span class="token function">FLEXCAN_SetRxMaskType</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FLEXCAN_ExitFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上边分析了</span>
<span class="token punctuation">}</span>
<span class="token comment">//判断是全局还是个人屏蔽</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">FLEXCAN_SetRxMaskType</span><span class="token punctuation">(</span>CAN_Type <span class="token operator">*</span> base<span class="token punctuation">,</span> <span class="token class-name">flexcan_rx_mask_type_t</span> type<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//关闭个别接收掩码和队列功能。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> FLEXCAN_RX_MASK_GLOBAL<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        base<span class="token operator">-&gt;</span>MCR <span class="token operator">=</span> <span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;</span> <span class="token operator">~</span>CAN_MCR_IRMQ_MASK<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">CAN_MCR_IRMQ</span><span class="token punctuation">(</span><span class="token number">0U</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token comment">//开启个别接收掩码和队列功能。</span>
    <span class="token punctuation">{<!-- --></span>
        base<span class="token operator">-&gt;</span>MCR <span class="token operator">=</span> <span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;</span> <span class="token operator">~</span>CAN_MCR_IRMQ_MASK<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">CAN_MCR_IRMQ</span><span class="token punctuation">(</span><span class="token number">1U</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//设置Rx FIFO全局掩码为11位标准掩码或29位扩展掩码</span>
<span class="token keyword">void</span> <span class="token function">FLEXCAN_DRV_SetRxFifoGlobalMask</span><span class="token punctuation">(</span>
    <span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span>
    <span class="token class-name">flexcan_msgbuff_id_type_t</span> id_type<span class="token punctuation">,</span>
    <span class="token class-name">uint32_t</span> mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>instance <span class="token operator">&lt;</span> CAN_INSTANCE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//FLEXCAN_GetRxFifoIdFormat中两位用来定义接受队列过滤器表元素的格式</span>
    <span class="token comment">// 格式A：每一个ID过滤表元素有一个全ID（标准的以及扩展的）；</span>
    <span class="token comment">//格式B：每一个ID过滤表元素都有两个全标准IDs或者两个14比特（标准的及扩展的）的IDs；</span>
    <span class="token comment">//格式C：每一个过滤表元素有四个8比特标准IDs；</span>
    <span class="token comment">//格式D：拒绝所有的帧</span>
    <span class="token class-name">flexcan_rx_fifo_id_element_format_t</span> formatType<span class="token punctuation">;</span>
    CAN_Type <span class="token operator">*</span> base <span class="token operator">=</span> g_flexcanBase<span class="token punctuation">[</span>instance<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> calcMask <span class="token operator">=</span> <span class="token number">0U</span><span class="token punctuation">;</span>

    <span class="token function">FLEXCAN_EnterFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否开启接收队列。该位用来控制是否开启接收队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>true <span class="token operator">==</span> <span class="token function">FLEXCAN_IsRxFifoEnabled</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>   <span class="token comment">//返回过滤器元素的格式</span>
		formatType <span class="token operator">=</span> <span class="token function">FLEXCAN_GetRxFifoIdFormat</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
		calcMask <span class="token operator">=</span> <span class="token function">FLEXCAN_GetRxFifoMask</span><span class="token punctuation">(</span>id_type<span class="token punctuation">,</span> formatType<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//FLEXCAN_SetRxFifoGlobalMask设置接收队列 FIFO 全局掩码寄存器（CANx_RXFGMASK）该寄存器位于 RAM 区。</span>
<span class="token comment">//如果接收 FIFO 队列被使能，RXFGMASK 被用来屏蔽接收队列 FIFO 过滤器表元素，</span>
<span class="token comment">//这些表元素由于 CTRL2[RFEN]字段的设定并没有相应的 RXIMR。该寄存器只能在冻结模式下被写入，在其他模式下该字段被硬件锁定。</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>formatType<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
<span class="token comment">//FLEXCAN_SetRxFifoGlobalMask</span>
<span class="token comment">//设置接收队列FIFO全局掩码位。这些比特位以完美对齐的方式用来屏蔽ID过滤器表元素</span>
			<span class="token keyword">case</span> FLEXCAN_RX_FIFO_ID_FORMAT_A <span class="token operator">:</span>
				<span class="token function">FLEXCAN_SetRxFifoGlobalMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> calcMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> FLEXCAN_RX_FIFO_ID_FORMAT_B <span class="token operator">:</span>
				<span class="token function">FLEXCAN_SetRxFifoGlobalMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">(</span>calcMask <span class="token operator">|</span> <span class="token punctuation">(</span>calcMask <span class="token operator">&gt;&gt;</span> FLEXCAN_RX_FIFO_ID_FILTER_FORMATB_EXT_SHIFT1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> FLEXCAN_RX_FIFO_ID_FORMAT_C <span class="token operator">:</span>
				<span class="token function">FLEXCAN_SetRxFifoGlobalMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">(</span>calcMask <span class="token operator">|</span> <span class="token punctuation">(</span>calcMask <span class="token operator">&gt;&gt;</span> FLEXCAN_RX_FIFO_ID_FILTER_FORMATC_SHIFT1<span class="token punctuation">)</span> <span class="token operator">|</span>
												  	  	  	  <span class="token punctuation">(</span>calcMask <span class="token operator">&gt;&gt;</span> FLEXCAN_RX_FIFO_ID_FILTER_FORMATC_SHIFT2<span class="token punctuation">)</span> <span class="token operator">|</span>
															  <span class="token punctuation">(</span>calcMask <span class="token operator">&gt;&gt;</span> FLEXCAN_RX_FIFO_ID_FILTER_FORMATC_SHIFT3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span> <span class="token operator">:</span>
				<span class="token function">FLEXCAN_SetRxFifoGlobalMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFFU</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">FLEXCAN_ExitFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//设置邮箱全局掩码</span>
<span class="token keyword">void</span> <span class="token function">FLEXCAN_DRV_SetRxMbGlobalMask</span><span class="token punctuation">(</span>
    <span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span>
    <span class="token class-name">flexcan_msgbuff_id_type_t</span> id_type<span class="token punctuation">,</span>
    <span class="token class-name">uint32_t</span> mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>instance <span class="token operator">&lt;</span> CAN_INSTANCE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CAN_Type <span class="token operator">*</span> base <span class="token operator">=</span> g_flexcanBase<span class="token punctuation">[</span>instance<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">FLEXCAN_EnterFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>id_type <span class="token operator">==</span> FLEXCAN_MSG_ID_STD<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
<span class="token comment">//设置接受邮箱全局掩码寄存器（CANx_RXMGMASK）</span>
        <span class="token function">FLEXCAN_SetRxMsgBuffGlobalStdMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>id_type <span class="token operator">==</span> FLEXCAN_MSG_ID_EXT<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">FLEXCAN_SetRxMsgBuffGlobalExtMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token function">FLEXCAN_ExitFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//缓冲区14过滤字段提供掩码</span>
<span class="token keyword">void</span> <span class="token function">FLEXCAN_DRV_SetRxMb14Mask</span><span class="token punctuation">(</span>
    <span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span>
    <span class="token class-name">flexcan_msgbuff_id_type_t</span> id_type<span class="token punctuation">,</span>
    <span class="token class-name">uint32_t</span> mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>instance <span class="token operator">&lt;</span> CAN_INSTANCE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CAN_Type <span class="token operator">*</span> base <span class="token operator">=</span> g_flexcanBase<span class="token punctuation">[</span>instance<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">FLEXCAN_EnterFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id_type <span class="token operator">==</span> FLEXCAN_MSG_ID_STD<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
<span class="token comment">//提供该寄存器是为了对传统的支持。当 MCR[IRMQ]位被置位时，RX14MASK 无效。</span>
<span class="token comment">//RX14MASK 用来给报文缓冲区 14 的过滤字段提供掩码。</span>
        <span class="token function">FLEXCAN_SetRxMsgBuff14StdMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>id_type <span class="token operator">==</span> FLEXCAN_MSG_ID_EXT<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">FLEXCAN_SetRxMsgBuff14ExtMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token function">FLEXCAN_ExitFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//RX15MASK 用来给报文缓冲区 15 的过滤字段提供掩码。</span>
<span class="token keyword">void</span> <span class="token function">FLEXCAN_DRV_SetRxMb15Mask</span><span class="token punctuation">(</span>
    <span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span>
    <span class="token class-name">flexcan_msgbuff_id_type_t</span> id_type<span class="token punctuation">,</span>
    <span class="token class-name">uint32_t</span> mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">//略同上</span>
<span class="token punctuation">}</span>
<span class="token comment">//设置个别掩码</span>
<span class="token class-name">status_t</span> <span class="token function">FLEXCAN_DRV_SetRxIndividualMask</span><span class="token punctuation">(</span>
    <span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span>
    <span class="token class-name">flexcan_msgbuff_id_type_t</span> id_type<span class="token punctuation">,</span>
    <span class="token class-name">uint8_t</span> mb_idx<span class="token punctuation">,</span>
    <span class="token class-name">uint32_t</span> mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>instance <span class="token operator">&lt;</span> CAN_INSTANCE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CAN_Type <span class="token operator">*</span> base <span class="token operator">=</span> g_flexcanBase<span class="token punctuation">[</span>instance<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">FLEXCAN_EnterFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//MAXMB最大报文缓冲区个数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mb_idx <span class="token operator">&gt;</span> <span class="token function">FLEXCAN_GetMaxMsgBuffNum</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>mb_idx <span class="token operator">&gt;=</span> CAN_RXIMR_COUNT<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">FLEXCAN_ExitFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> STATUS_CAN_BUFF_OUT_OF_RANGE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//开启接收队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>false <span class="token operator">==</span> <span class="token function">FLEXCAN_IsRxFifoEnabled</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token comment">//标准帧</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>id_type <span class="token operator">==</span> FLEXCAN_MSG_ID_STD<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
<span class="token comment">//设置接收私有掩码寄存器</span>
			<span class="token function">FLEXCAN_SetRxIndividualStdMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mb_idx<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>id_type <span class="token operator">==</span> FLEXCAN_MSG_ID_EXT<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
<span class="token comment">//设置接收私有掩码寄存器</span>
			<span class="token function">FLEXCAN_SetRxIndividualExtMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mb_idx<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span><span class="token comment">//单个掩码配置的最大过滤器是(7 + RFFN * 2)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mb_idx <span class="token operator">&lt;=</span> <span class="token function">FLEXCAN_GetNoOfIndividualMBsRxFIFO</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
<span class="token comment">//返回过滤器元素的格式</span>
			<span class="token class-name">flexcan_rx_fifo_id_element_format_t</span> formatType <span class="token operator">=</span> <span class="token function">FLEXCAN_GetRxFifoIdFormat</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//以FIFO模式的格式ID类型计算全局掩码</span>
			<span class="token class-name">uint32_t</span> calcMask <span class="token operator">=</span> <span class="token function">FLEXCAN_GetRxFifoMask</span><span class="token punctuation">(</span>id_type<span class="token punctuation">,</span> formatType<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span>formatType<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">case</span> FLEXCAN_RX_FIFO_ID_FORMAT_A <span class="token operator">:</span>
					<span class="token function">FLEXCAN_SetRxIndividualMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mb_idx<span class="token punctuation">,</span> calcMask<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置接收私有掩码寄存器,以FIFO模式的格式ID类型计算全局掩码</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> FLEXCAN_RX_FIFO_ID_FORMAT_B <span class="token operator">:</span>
					<span class="token function">FLEXCAN_SetRxIndividualMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mb_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>calcMask <span class="token operator">|</span> <span class="token punctuation">(</span>calcMask <span class="token operator">&gt;&gt;</span> FLEXCAN_RX_FIFO_ID_FILTER_FORMATB_EXT_SHIFT1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> FLEXCAN_RX_FIFO_ID_FORMAT_C <span class="token operator">:</span>
					<span class="token function">FLEXCAN_SetRxIndividualMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mb_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>calcMask <span class="token operator">|</span> <span class="token punctuation">(</span>calcMask <span class="token operator">&gt;&gt;</span> FLEXCAN_RX_FIFO_ID_FILTER_FORMATC_SHIFT1<span class="token punctuation">)</span> <span class="token operator">|</span>
																  	  	  <span class="token punctuation">(</span>calcMask <span class="token operator">&gt;&gt;</span> FLEXCAN_RX_FIFO_ID_FILTER_FORMATC_SHIFT2<span class="token punctuation">)</span> <span class="token operator">|</span>
																		  <span class="token punctuation">(</span>calcMask <span class="token operator">&gt;&gt;</span> FLEXCAN_RX_FIFO_ID_FILTER_FORMATC_SHIFT3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">default</span> <span class="token operator">:</span>
					<span class="token function">FLEXCAN_SetRxIndividualMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mb_idx<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFFU</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
    	<span class="token keyword">else</span>
    	<span class="token punctuation">{<!-- --></span>
    		<span class="token keyword">if</span> <span class="token punctuation">(</span>id_type <span class="token operator">==</span> FLEXCAN_MSG_ID_STD<span class="token punctuation">)</span>
    		<span class="token punctuation">{<!-- --></span>
    			<span class="token function">FLEXCAN_SetRxIndividualStdMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mb_idx<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span>
    		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>id_type <span class="token operator">==</span> FLEXCAN_MSG_ID_EXT<span class="token punctuation">)</span>
    		<span class="token punctuation">{<!-- --></span>
    			<span class="token function">FLEXCAN_SetRxIndividualExtMask</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mb_idx<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span>
    		<span class="token keyword">else</span>
    		<span class="token punctuation">{<!-- --></span>
    		<span class="token punctuation">}</span>
    	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">FLEXCAN_ExitFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><em><strong>SDK函数分析（三）</strong></em></p> 
<pre><code class="prism language-c"><span class="token comment">//flexcan初始化</span>
<span class="token class-name">status_t</span> <span class="token function">FLEXCAN_DRV_Init</span><span class="token punctuation">(</span>
   <span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span>
   <span class="token class-name">flexcan_state_t</span> <span class="token operator">*</span>state<span class="token punctuation">,</span>
   <span class="token keyword">const</span> <span class="token class-name">flexcan_user_config_t</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>instance <span class="token operator">&lt;</span> CAN_INSTANCE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>g_flexcanStatePtr<span class="token punctuation">[</span>instance<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">status_t</span> result<span class="token punctuation">;</span>
    CAN_Type <span class="token operator">*</span> base <span class="token operator">=</span> g_flexcanBase<span class="token punctuation">[</span>instance<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">flexcan_time_segment_t</span> bitrate<span class="token punctuation">;</span>
    <span class="token class-name">status_t</span> osifStat<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FLEXCAN_IsEnabled</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">FLEXCAN_EnterFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FLEXCAN_Disable</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//CAN引擎时钟源。CTRL1 13BIT 该位用来为CAN协议引擎（PE）选择时钟源，</span>
<span class="token comment">//可以是设备外设时钟（有PLL驱动）也可以是外部晶体振荡器时钟。</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_PE_CLKSRC_SELECT</span></span>
    <span class="token function">FLEXCAN_SelectClock</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> data<span class="token operator">-&gt;</span>pe_clock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token comment">/* Enable the CAN clock */</span>
    <span class="token function">FLEXCAN_Enable</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FLEXCAN_EnterFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始化 1.复位 2.中止传输 3.清空RAM 4.寄存器重置</span>
    <span class="token comment">//5.状态与错误寄存器init</span>
    <span class="token function">FLEXCAN_Init</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_FD</span></span>
    <span class="token function">FLEXCAN_SetFDEnabled</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> data<span class="token operator">-&gt;</span>fd_enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FLEXCAN_IsFDEnabled</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token operator">!=</span> data<span class="token operator">-&gt;</span>fd_enable<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> STATUS_ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token comment">//flexcan_user_config_t配置FD是否使能</span>
    <span class="token function">FLEXCAN_SetStuffBitCount</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> data<span class="token operator">-&gt;</span>fd_enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token comment">//不是回环模式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>flexcanMode <span class="token operator">!=</span> FLEXCAN_LOOPBACK_MODE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token comment">//MCR-&gt;SRXDIS使能自接受</span>
        <span class="token function">FLEXCAN_SetSelfReception</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>is_rx_fifo_needed<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token comment">//使能循环队列 1.mcr-&gt;rfen 2.CTRL-&gt;RFEN接收队列FIFO过滤器的数目</span>
    <span class="token comment">//3.设置接受队列全局掩码寄存器（RXFGMASK）</span>
    <span class="token comment">//4.接收私有掩码寄存器RXIMR</span>
        result <span class="token operator">=</span> <span class="token function">FLEXCAN_EnableRxFifo</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>data<span class="token operator">-&gt;</span>num_id_filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> STATUS_SUCCESS<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_DMA_ENABLE</span></span>
    <span class="token comment">/* Enable DMA support for RxFIFO transfer, if requested. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>transfer_type <span class="token operator">==</span> FLEXCAN_RXFIFO_USING_DMA<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FLEXCAN_IsRxFifoEnabled</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">FLEXCAN_SetRxFifoDMA</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> STATUS_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>transfer_type <span class="token operator">==</span> FLEXCAN_RXFIFO_USING_INTERRUPTS<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token function">FLEXCAN_SetRxFifoDMA</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_FD</span></span>
<span class="token comment">//这个寄存器包含CAN FD操作的控制位。</span>
<span class="token comment">// 它还定义了分配在RAM(内存块)的不同分区中的消息缓冲区的数据大小，如下表所示。</span>
    <span class="token function">FLEXCAN_SetPayloadSize</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> data<span class="token operator">-&gt;</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token comment">//设置缓冲区数量</span>
    result <span class="token operator">=</span> <span class="token function">FLEXCAN_SetMaxMsgBuffNum</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> data<span class="token operator">-&gt;</span>max_num_mb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> STATUS_SUCCESS<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_FD</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FLEXCAN_IsFDEnabled</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        bitrate <span class="token operator">=</span> data<span class="token operator">-&gt;</span>bitrate<span class="token punctuation">;</span>
        <span class="token function">FLEXCAN_SetExtendedTimeSegments</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bitrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bitrate <span class="token operator">=</span> data<span class="token operator">-&gt;</span>bitrate_cbt<span class="token punctuation">;</span>
        <span class="token function">FLEXCAN_SetFDTimeSegments</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bitrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">{<!-- --></span>
        bitrate <span class="token operator">=</span> data<span class="token operator">-&gt;</span>bitrate<span class="token punctuation">;</span>
        <span class="token function">FLEXCAN_SetTimeSegments</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bitrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">FLEXCAN_SetOperationMode</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> data<span class="token operator">-&gt;</span>flexcanMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>flexcanMode <span class="token operator">!=</span> FLEXCAN_FREEZE_MODE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token function">FLEXCAN_ExitFreezeMode</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">FLEXCAN_EnableIRQs</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> FEATURE_CAN_MAX_MB_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        osifStat <span class="token operator">=</span> <span class="token function">OSIF_SemaCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token operator">-&gt;</span>mbs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mbSema<span class="token punctuation">,</span> <span class="token number">0U</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>osifStat <span class="token operator">!=</span> STATUS_SUCCESS<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">OSIF_SemaDestroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token operator">-&gt;</span>mbs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>mbSema<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> STATUS_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        state<span class="token operator">-&gt;</span>mbs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>isBlocking <span class="token operator">=</span> false<span class="token punctuation">;</span>
        state<span class="token operator">-&gt;</span>mbs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mb_message <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        state<span class="token operator">-&gt;</span>mbs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> FLEXCAN_MB_IDLE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_MEM_ERR_DET</span></span>
    <span class="token function">FLEXCAN_DisableMemErrorDetection</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    state<span class="token operator">-&gt;</span>transferType <span class="token operator">=</span> data<span class="token operator">-&gt;</span>transfer_type<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_DMA_ENABLE</span></span>
    state<span class="token operator">-&gt;</span>rxFifoDMAChannel <span class="token operator">=</span> data<span class="token operator">-&gt;</span>rxFifoDMAChannel<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    state<span class="token operator">-&gt;</span>callback <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    state<span class="token operator">-&gt;</span>callbackParam <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    state<span class="token operator">-&gt;</span>error_callback <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    state<span class="token operator">-&gt;</span>errorCallbackParam <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    g_flexcanStatePtr<span class="token punctuation">[</span>instance<span class="token punctuation">]</span> <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>STATUS_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><em><strong>SDK函数分析（四）</strong></em></p> 
<pre><code class="prism language-c"><span class="token comment">//发送mb cofig</span>
<span class="token class-name">status_t</span> <span class="token function">FLEXCAN_DRV_ConfigTxMb</span><span class="token punctuation">(</span>
    <span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span>
    <span class="token class-name">uint8_t</span> mb_idx<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token class-name">flexcan_data_info_t</span> <span class="token operator">*</span>tx_info<span class="token punctuation">,</span>
    <span class="token class-name">uint32_t</span> msg_id<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>instance <span class="token operator">&lt;</span> CAN_INSTANCE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>tx_info <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">flexcan_msgbuff_code_status_t</span> cs<span class="token punctuation">;</span>
    CAN_Type <span class="token operator">*</span> base <span class="token operator">=</span> g_flexcanBase<span class="token punctuation">[</span>instance<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//这个没啥说的就是赋值</span>
    cs<span class="token punctuation">.</span>dataLen <span class="token operator">=</span> tx_info<span class="token operator">-&gt;</span>data_length<span class="token punctuation">;</span>
    cs<span class="token punctuation">.</span>msgIdType <span class="token operator">=</span> tx_info<span class="token operator">-&gt;</span>msg_id_type<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_FD</span></span>
    cs<span class="token punctuation">.</span>enable_brs <span class="token operator">=</span> tx_info<span class="token operator">-&gt;</span>enable_brs<span class="token punctuation">;</span>
    cs<span class="token punctuation">.</span>fd_enable <span class="token operator">=</span> tx_info<span class="token operator">-&gt;</span>fd_enable<span class="token punctuation">;</span>
    cs<span class="token punctuation">.</span>fd_padding <span class="token operator">=</span> tx_info<span class="token operator">-&gt;</span>fd_padding<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    cs<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>FLEXCAN_TX_INACTIVE<span class="token punctuation">;</span>
    <span class="token comment">//下边解释</span>
    <span class="token keyword">return</span> <span class="token function">FLEXCAN_SetTxMsgBuff</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> mb_idx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cs<span class="token punctuation">,</span> msg_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//设置flexcan 发送msg buff</span>
<span class="token class-name">status_t</span> <span class="token function">FLEXCAN_SetTxMsgBuff</span><span class="token punctuation">(</span>
    CAN_Type <span class="token operator">*</span> base<span class="token punctuation">,</span>
    <span class="token class-name">uint32_t</span> msgBuffIdx<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token class-name">flexcan_msgbuff_code_status_t</span> <span class="token operator">*</span>cs<span class="token punctuation">,</span>
    <span class="token class-name">uint32_t</span> msgId<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>msgData<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span>cs <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> val1<span class="token punctuation">,</span> val2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> flexcan_mb_config <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> databyte<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> dlc_value<span class="token punctuation">;</span>
    <span class="token class-name">status_t</span> stat <span class="token operator">=</span> STATUS_SUCCESS<span class="token punctuation">;</span>
<span class="token comment">//这个函数多墨迹几句在四的结尾处</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span>flexcan_mb <span class="token operator">=</span> <span class="token function">FLEXCAN_GetMsgBuffRegion</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> msgBuffIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//拿到刚才给的地址 指针指向</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span>flexcan_mb_id   <span class="token operator">=</span> <span class="token operator">&amp;</span>flexcan_mb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint8_t</span>  <span class="token operator">*</span>flexcan_mb_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flexcan_mb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span>flexcan_mb_data_32 <span class="token operator">=</span> <span class="token operator">&amp;</span>flexcan_mb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span>msgData_32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>msgData<span class="token punctuation">;</span>
<span class="token comment">//最大缓冲区的个数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgBuffIdx <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>MCR<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_MCR_MAXMB_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_MCR_MAXMB_SHIFT<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        stat <span class="token operator">=</span> STATUS_CAN_BUFF_OUT_OF_RANGE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>MCR <span class="token operator">&amp;</span> CAN_MCR_RFEN_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_MCR_RFEN_SHIFT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0U</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//这几句解释起来真烦</span>
        <span class="token comment">//这个CTRL2寄存器的27-24（RFEN）</span>
        <span class="token comment">//这4位用来定义了下表中所示的接收队列过滤器的数目</span>
        <span class="token comment">//过滤器使用的越多，满足条件的邮箱越少</span>
        <span class="token comment">//eg:RFEN=01 消息邮箱 MB8-63 val1=0x01</span>
        val1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>CTRL2<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_CTRL2_RFFN_MASK<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> CAN_CTRL2_RFFN_SHIFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//val2 = 9</span>
        val2 <span class="token operator">=</span> <span class="token function">RxFifoOcuppiedLastMsgBuff</span><span class="token punctuation">(</span>val1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//为啥现在我也不知道。。。脑子不够用了，搞不动了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgBuffIdx <span class="token operator">&lt;=</span> val2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            stat <span class="token operator">=</span>  STATUS_CAN_BUFF_OUT_OF_RANGE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">==</span> STATUS_SUCCESS<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_FD</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FLEXCAN_IsFDEnabled</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> cs<span class="token operator">-&gt;</span>enable_brs<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            base<span class="token operator">-&gt;</span>FDCTRL <span class="token operator">=</span> <span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>FDCTRL <span class="token operator">&amp;</span> <span class="token operator">~</span>CAN_FDCTRL_FDRATE_MASK<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">CAN_FDCTRL_FDRATE</span><span class="token punctuation">(</span><span class="token number">1U</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>cs<span class="token operator">-&gt;</span>dataLen <span class="token operator">&lt;=</span> <span class="token function">FLEXCAN_GetPayloadSize</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token function">DEV_ASSERT</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>cs<span class="token operator">-&gt;</span>dataLen <span class="token operator">&lt;=</span> <span class="token number">8U</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        dlc_value <span class="token operator">=</span> <span class="token function">FLEXCAN_ComputeDLCValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>cs<span class="token operator">-&gt;</span>dataLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgData <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">uint8_t</span> payload_size <span class="token operator">=</span> <span class="token function">FLEXCAN_ComputePayloadSize</span><span class="token punctuation">(</span>dlc_value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span><span class="token function">defined</span><span class="token punctuation">(</span>CPU_S32K116<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>CPU_S32K118<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> msgData_32<span class="token punctuation">;</span>
            databyte <span class="token operator">=</span> <span class="token function">FLEXCAN_DataTransferTxMsgBuff</span><span class="token punctuation">(</span> flexcan_mb_data_32<span class="token punctuation">,</span> cs<span class="token punctuation">,</span> msgData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>databyte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> databyte <span class="token operator">&lt;</span> <span class="token punctuation">(</span>cs<span class="token operator">-&gt;</span>dataLen <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">3U</span><span class="token punctuation">)</span><span class="token punctuation">;</span> databyte <span class="token operator">+=</span> <span class="token number">4U</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">FlexcanSwapBytesInWord</span><span class="token punctuation">(</span>msgData_32<span class="token punctuation">[</span>databyte <span class="token operator">&gt;&gt;</span> <span class="token number">2U</span><span class="token punctuation">]</span><span class="token punctuation">,</span> flexcan_mb_data_32<span class="token punctuation">[</span>databyte <span class="token operator">&gt;&gt;</span> <span class="token number">2U</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> databyte <span class="token operator">&lt;</span> cs<span class="token operator">-&gt;</span>dataLen<span class="token punctuation">;</span> databyte<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                flexcan_mb_data<span class="token punctuation">[</span><span class="token function">FlexcanSwapBytesInWordIndex</span><span class="token punctuation">(</span>databyte<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span>  msgData<span class="token punctuation">[</span>databyte<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/* Add padding, if needed */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>databyte <span class="token operator">=</span> cs<span class="token operator">-&gt;</span>dataLen<span class="token punctuation">;</span> databyte <span class="token operator">&lt;</span> payload_size<span class="token punctuation">;</span> databyte<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                flexcan_mb_data<span class="token punctuation">[</span><span class="token function">FlexcanSwapBytesInWordIndex</span><span class="token punctuation">(</span>databyte<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> cs<span class="token operator">-&gt;</span>fd_padding<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* Clean up the arbitration field area */</span>
        <span class="token operator">*</span>flexcan_mb <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>flexcan_mb_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">/* Set the ID according the format structure */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cs<span class="token operator">-&gt;</span>msgIdType <span class="token operator">==</span> FLEXCAN_MSG_ID_EXT<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* ID [28-0] */</span>
            <span class="token operator">*</span>flexcan_mb_id <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>CAN_ID_STD_MASK <span class="token operator">|</span> CAN_ID_EXT_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>flexcan_mb_id <span class="token operator">|=</span> <span class="token punctuation">(</span>msgId <span class="token operator">&amp;</span> <span class="token punctuation">(</span>CAN_ID_STD_MASK <span class="token operator">|</span> CAN_ID_EXT_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* Set IDE */</span>
            flexcan_mb_config <span class="token operator">|=</span> CAN_CS_IDE_MASK<span class="token punctuation">;</span>
            <span class="token comment">/* Clear SRR bit */</span>
            flexcan_mb_config <span class="token operator">&amp;=</span> <span class="token operator">~</span>CAN_CS_SRR_MASK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cs<span class="token operator">-&gt;</span>msgIdType <span class="token operator">==</span> FLEXCAN_MSG_ID_STD<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* ID[28-18] */</span>
            <span class="token operator">*</span>flexcan_mb_id <span class="token operator">&amp;=</span> <span class="token operator">~</span>CAN_ID_STD_MASK<span class="token punctuation">;</span>
            <span class="token operator">*</span>flexcan_mb_id <span class="token operator">|=</span> <span class="token punctuation">(</span>msgId <span class="token operator">&lt;&lt;</span> CAN_ID_STD_SHIFT<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_ID_STD_MASK<span class="token punctuation">;</span>
            <span class="token comment">/* make sure IDE and SRR are not set */</span>
            flexcan_mb_config <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>CAN_CS_IDE_MASK <span class="token operator">|</span> CAN_CS_SRR_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* Set the length of data in bytes */</span>
        flexcan_mb_config <span class="token operator">&amp;=</span> <span class="token operator">~</span>CAN_CS_DLC_MASK<span class="token punctuation">;</span>
        flexcan_mb_config <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>dlc_value <span class="token operator">&lt;&lt;</span> CAN_CS_DLC_SHIFT<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_CS_DLC_MASK<span class="token punctuation">;</span>
        <span class="token comment">/* Set MB CODE */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cs<span class="token operator">-&gt;</span>code <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>FLEXCAN_TX_NOT_USED<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cs<span class="token operator">-&gt;</span>code <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>FLEXCAN_TX_REMOTE<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/* Set RTR bit */</span>
                flexcan_mb_config <span class="token operator">|=</span> CAN_CS_RTR_MASK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/* Reset the code */</span>
            flexcan_mb_config <span class="token operator">&amp;=</span> <span class="token operator">~</span>CAN_CS_CODE_MASK<span class="token punctuation">;</span>
            <span class="token comment">/* Set the code */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cs<span class="token operator">-&gt;</span>fd_enable<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                flexcan_mb_config <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cs<span class="token operator">-&gt;</span>code <span class="token operator">&lt;&lt;</span> CAN_CS_CODE_SHIFT<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_CS_CODE_MASK<span class="token punctuation">)</span> <span class="token operator">|</span> CAN_MB_EDL_MASK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                flexcan_mb_config <span class="token operator">|=</span> <span class="token punctuation">(</span>cs<span class="token operator">-&gt;</span>code <span class="token operator">&lt;&lt;</span> CAN_CS_CODE_SHIFT<span class="token punctuation">)</span> <span class="token operator">&amp;</span> CAN_CS_CODE_MASK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cs<span class="token operator">-&gt;</span>enable_brs<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                flexcan_mb_config <span class="token operator">|=</span> CAN_MB_BRS_MASK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token operator">*</span>flexcan_mb <span class="token operator">|=</span> flexcan_mb_config<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> stat<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//根据msgBuffIdx返回地址</span>
<span class="token keyword">volatile</span> <span class="token class-name">uint32_t</span><span class="token operator">*</span> <span class="token function">FLEXCAN_GetMsgBuffRegion</span><span class="token punctuation">(</span>
        CAN_Type <span class="token operator">*</span> base<span class="token punctuation">,</span>
        <span class="token class-name">uint32_t</span> msgBuffIdx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FEATURE_CAN_HAS_FD</span></span>
    <span class="token class-name">uint8_t</span> payload_size <span class="token operator">=</span> <span class="token function">FLEXCAN_GetPayloadSize</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token class-name">uint8_t</span> payload_size <span class="token operator">=</span> <span class="token number">8U</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token class-name">uint8_t</span> arbitration_field_size <span class="token operator">=</span> <span class="token number">8U</span><span class="token punctuation">;</span>
<span class="token comment">//#define CAN_RAMn_COUNT                           128u    </span>
<span class="token comment">//typedef struct </span>
<span class="token comment">//{<!-- --></span>
<span class="token comment">// __IO uint32_t RAMn[CAN_RAMn_COUNT]; array offset: 0x80, </span>
<span class="token comment">//} CAN_Type, *CAN_MemMapPtr;</span>
<span class="token comment">//根据上边这几句所以uint32_t ramBlockSize = 512U;</span>
    <span class="token class-name">uint32_t</span> ramBlockSize <span class="token operator">=</span> <span class="token number">512U</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> ramBlockOffset<span class="token punctuation">;</span>
    <span class="token comment">//一个MB的大小</span>
    <span class="token class-name">uint8_t</span> mb_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>payload_size <span class="token operator">+</span> arbitration_field_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//按这个算最大的mb个数</span>
    <span class="token class-name">uint8_t</span> maxMbNum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ramBlockSize <span class="token operator">/</span> mb_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//偏移 eg msgBuffIdx =1 ramBlockOffset =0</span>
    ramBlockOffset <span class="token operator">=</span> <span class="token number">128U</span> <span class="token operator">*</span> <span class="token punctuation">(</span>msgBuffIdx <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>maxMbNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//在这块ram中索引=0+1*16/4=4</span>
    <span class="token class-name">uint32_t</span> mb_index <span class="token operator">=</span> ramBlockOffset <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>msgBuffIdx <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>maxMbNum<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>mb_size <span class="token operator">&gt;&gt;</span> <span class="token number">2U</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>base<span class="token operator">-&gt;</span>RAMn<span class="token punctuation">[</span>mb_index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//最大512个字节 根据mb_size算一共有几个偏移多少返回地址 </span>
</code></pre> 
<p><em><strong>初始化需要的SDK函数</strong></em></p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Can0Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//TJA1043 EN STB 全部使能高电平进入正常收发状态</span>
    <span class="token function">hal_mcu_can_modeset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FLEXCAN_DRV_Init</span><span class="token punctuation">(</span>INST_CANCOM0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>canCom0_State<span class="token punctuation">,</span> <span class="token operator">&amp;</span>canCom0_InitConfig0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FLEXCAN_DRV_ConfigRxMb</span><span class="token punctuation">(</span>INST_CANCOM0<span class="token punctuation">,</span> RX_MAILBOX_0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data_std_info<span class="token punctuation">,</span> <span class="token number">0x87</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">FLEXCAN_DRV_ConfigTxMb</span><span class="token punctuation">(</span>INST_CANCOM0<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>data_std_info<span class="token punctuation">,</span> <span class="token number">0x228</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FLEXCAN_DRV_InstallEventCallback</span><span class="token punctuation">(</span>INST_CANCOM0<span class="token punctuation">,</span> canRxCallback<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FLEXCAN_DRV_Receive</span><span class="token punctuation">(</span>INST_CANCOM0<span class="token punctuation">,</span> RX_MAILBOX_0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>recvMsg0<span class="token punctuation">)</span><span class="token punctuation">;</span>
｝
<span class="token comment">//CALLBACK 发什么回什么</span>
<span class="token keyword">void</span> <span class="token function">canRxCallback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> instance<span class="token punctuation">,</span> <span class="token class-name">flexcan_event_type_t</span> eventType<span class="token punctuation">,</span>
		<span class="token class-name">uint32_t</span> buffIdx<span class="token punctuation">,</span> <span class="token class-name">flexcan_state_t</span> <span class="token operator">*</span>flexcanState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>eventType <span class="token operator">==</span> FLEXCAN_EVENT_RX_COMPLETE<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
			<span class="token function">FLEXCAN_DRV_Receive</span><span class="token punctuation">(</span>INST_CANCOM0<span class="token punctuation">,</span> RX_MAILBOX_0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>recvMsg0<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">FLEXCAN_DRV_Send</span><span class="token punctuation">(</span>INST_CANCOM0<span class="token punctuation">,</span> TX_MAILBOX_0 <span class="token punctuation">,</span> <span class="token operator">&amp;</span>data_std_info <span class="token punctuation">,</span> recvMsg0<span class="token punctuation">.</span>msgId<span class="token punctuation">,</span> recvMsg0<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e6/1f/OR5UA8EX_o.png" alt="发送什么回复什么"><br> 接下来搞一下 掩码及UDS诊断-&gt;NXP S32K146 CAN通讯 TJA1043（二）</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>