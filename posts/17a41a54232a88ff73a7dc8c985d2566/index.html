<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>强化学习入门笔记 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">强化学习入门笔记</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    
                        
                    
                    <h1>
<a id="_0"></a>强化学习</h1> 
<h2>
<a id="_2"></a>相关概念</h2> 
<p>我们先回忆一下童年，来看看超级玛丽这款游戏</p> 
<p><img src="https://images2.imgbox.com/8d/eb/W8WP1EJZ_o.png" alt="在这里插入图片描述" width="500"></p> 
<p>在这款游戏里面的，我们需要控制超级玛丽进行左右行走、跳、攻击等动作，来躲避或攻击小动物、吃金币以及各种类型的增益道具。最终，获得的金币数量的多少以及通关代表我们玩游戏玩的好不好。</p> 
<p>那么，如果我们希望让机器来玩这个游戏呢？怎么能让机器在合适的时候做出合适的动作？这就是强化学习要学的东西。</p> 
<h3>
<a id="_13"></a>模型表示</h3> 
<p>在强化学习中，我们把超级玛丽称作<strong>智能体（Agent）</strong>，而把游戏机制称作<strong>环境（Environment）</strong>，把每一帧画面称作<strong>状态（State）</strong>，把超级玛丽的行为称为<strong>动作（Action）</strong>，把获得的金币数量或者通关称为<strong>奖励或回报（Reward）</strong></p> 
<p>我们玩一局超级玛丽开始的画面是固定的，这叫<strong>初始状态</strong>。我们根据状态选择执行合适的动作，这叫<strong>策略</strong>，通常表示为<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        π
       
       
        (
       
       
        a
       
       
        ∣
       
       
        s
       
       
        )
       
      
      
       pi(a|s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord">∣</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>。通常策略分为随机性策略和确定性策略，随机性策略即<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        a
       
       
        ∼
       
       
        π
       
       
        (
       
       
        a
       
       
        ∣
       
       
        s
       
       
        )
       
      
      
       asim pi(a|s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord">∣</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>，确定性策略即<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        a
       
       
        =
       
       
        π
       
       
        (
       
       
        s
       
       
        )
       
      
      
       a = pi(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>。</p> 
<p>执行动作之后，游戏画面更新，这个过程叫做<strong>状态转移</strong>。当游戏失败或通关时，到达<strong>终止状态</strong>。</p> 
<p>所以一局游戏就是给定初始状态下，不断地发生状态转移直到到达终止状态的过程。我们把这整个过程叫做马尔科夫决策过程，并且我们把从初态到终态的其中一种可能的序列称为一条轨迹。即 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        τ
       
       
        =
       
       
        
         s
        
        
         0
        
       
       
        ,
       
       
        
         a
        
        
         0
        
       
       
        ,
       
       
        
         r
        
        
         1
        
       
       
        ,
       
       
        
         s
        
        
         1
        
       
       
        ,
       
       
        
         a
        
        
         1
        
       
       
        ,
       
       
        
         r
        
        
         2
        
       
       
        ,
       
       
        
         s
        
        
         2
        
       
       
        ,
       
       
        .
       
       
        .
       
       
        .
       
       
        ,
       
       
        
         s
        
        
         T
        
       
      
      
       tau = s_0,a_0,r_1,s_1,a_1,r_2,s_2,...,s_T
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.625em;vertical-align: -0.19444em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: -0.02778em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: -0.02778em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p><img src="https://images2.imgbox.com/0e/88/HB3VRkaB_o.png" alt="在这里插入图片描述" width="400"></p> 
<p><img src="https://images2.imgbox.com/38/7a/3xWWFMT2_o.png" alt="在这里插入图片描述" width="450"></p> 
<p>从图上我们可以看出所谓的马尔科夫决策过程就是一个有向图模型，<strong>回报是我们附加的用于训练的概念</strong>，它本质上<strong>与模型无关</strong>，通常是<strong>当前状态和动作的函数</strong>，因此不参与有向图的概率分解。</p> 
<p>因此我们可以对马尔科夫决策过程的一条轨迹进行建模<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         p
        
        
         (
        
        
         τ
        
        
         )
        
        
         =
        
        
         p
        
        
         (
        
        
         
          s
         
         
          0
         
        
        
         )
        
        
         
          ∏
         
         
          
           i
          
          
           =
          
          
           0
          
         
         
          
           T
          
          
           −
          
          
           1
          
         
        
        
         π
        
        
         (
        
        
         
          a
         
         
          i
         
        
        
         ∣
        
        
         
          s
         
         
          i
         
        
        
         )
        
        
         ∗
        
        
         p
        
        
         (
        
        
         
          s
         
         
          
           i
          
          
           +
          
          
           1
          
         
        
        
         ∣
        
        
         
          s
         
         
          i
         
        
        
         ,
        
        
         
          a
         
         
          i
         
        
        
         )
        
       
       
         p(tau) = p(s_0)prod_{i=0}^{T-1} pi(a_i|s_i)*p(s_{i+1}|s_i,a_i) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 3.10601em;vertical-align: -1.27767em"></span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∏</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.27767em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em"><span class=""></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span><br> 这就是强化学习的模型表示。</p> 
<h3>
<a id="_37"></a>目标函数</h3> 
<p>从机器学习的三要素出发，在明确模型之后，我们应该考虑学习准则或者叫目标函数。</p> 
<p>强化学习中，要评估策略的好坏，跟奖励有关。</p> 
<p>当我们根据策略做出一个动作后，我们可以根据即时奖励来评估动作的好坏<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           G
          
          
           t
          
         
         
          =
         
         
          
           r
          
          
           
            t
           
           
            +
           
           
            1
           
          
         
        
       
       
         {large G_t = r_{t+1}} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.06666em;vertical-align: -0.246664em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.260053em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel sizing reset-size6 size7">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord sizing reset-size6 size7"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 但这样我们或许就成了短视的人，只能看到当前的好处，看不到大局。因此，另一个方案是采用从该时刻开始到游戏结束时的累计奖励作为评估标准，这样我们就能纵观全局，考虑了当前动作对未来的深远影响。<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           G
          
          
           t
          
         
         
          =
         
         
          
           r
          
          
           
            t
           
           
            +
           
           
            1
           
          
         
         
          +
         
         
          
           r
          
          
           
            t
           
           
            +
           
           
            2
           
          
         
         
          +
         
         
          .
         
         
          .
         
         
          .
         
         
          +
         
         
          
           r
          
          
           T
          
         
        
       
       
         {large G_t = r_{t+1}+r_{t+2}+...+r_T} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.06666em;vertical-align: -0.246664em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.260053em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel sizing reset-size6 size7">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord sizing reset-size6 size7"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin sizing reset-size6 size7">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord sizing reset-size6 size7"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin sizing reset-size6 size7">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord sizing reset-size6 size7">.</span><span class="mord sizing reset-size6 size7">.</span><span class="mord sizing reset-size6 size7">.</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin sizing reset-size6 size7">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord sizing reset-size6 size7"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.305553em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 但是这样也有问题，有的时候后期的奖励跟我们当前的动作其实并没有太大联系，我们加上后期奖励之后反倒有可能产生错误的评估结果。因此出现了一种折中的办法，即增加折扣率<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            G
           
           
            t
           
          
          
           =
          
          
           
            r
           
           
            
             t
            
            
             +
            
            
             1
            
           
          
          
           +
          
          
           γ
          
          
           
            r
           
           
            
             t
            
            
             +
            
            
             2
            
           
          
          
           +
          
          
           
            γ
           
           
            2
           
          
          
           
            r
           
           
            
             t
            
            
             +
            
            
             3
            
           
          
          
           +
          
          
           .
          
          
           .
          
          
           .
          
          
           
            γ
           
           
            
             T
            
            
             −
            
            
             1
            
           
          
          
           
            r
           
           
            T
           
          
         
        
       
       
         {large {G_t = r_{t+1}+gamma r_{t+2}+ gamma^2 r_{t+3}+...gamma^{T-1}r_T} } 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.28893em;vertical-align: -0.246664em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.260053em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.842627em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.868553em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.305553em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></span><br> 我们可以看到，当<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        γ
       
      
      
       gamma
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em;vertical-align: -0.19444em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span></span></span></span></span>为0时，为第一种情况，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        γ
       
      
      
       gamma
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em;vertical-align: -0.19444em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span></span></span></span></span>为1时，为第二种情况，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        0
       
       
        &lt;
       
       
        γ
       
       
        &lt;
       
       
        1
       
      
      
       0&lt;gamma&lt;1
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68354em;vertical-align: -0.0391em"></span><span class="mord">0</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.73354em;vertical-align: -0.19444em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.64444em;vertical-align: 0em"></span><span class="mord">1</span></span></span></span></span>时，即为折中的办法，可根据现实情况自由调整。</p> 
<p>因为策略和状态转移都有一定的随机性，所以每次试验得到的轨迹是一个随机序列，其收获的总回报也不一样。强化学习的目标是学习到一个策略<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         π
        
        
         θ
        
       
       
        (
       
       
        a
       
       
        ∣
       
       
        s
       
       
        )
       
      
      
       pi_theta(a|s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord">∣</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>来最大化期望回报（Expected Return），即希望智能体执行一系列的动作来获得尽可能多的平均回报。<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           J
          
          
           (
          
          
           θ
          
          
           )
          
          
           =
          
          
           
            E
           
           
            
             τ
            
            
             ∼
            
            
             
              p
             
             
              θ
             
            
            
             (
            
            
             τ
            
            
             )
            
           
          
          
           [
          
          
           G
          
          
           (
          
          
           τ
          
          
           )
          
          
           ]
          
          
           =
          
          
           
            E
           
           
            
             τ
            
            
             ∼
            
            
             
              p
             
             
              θ
             
            
            
             (
            
            
             τ
            
            
             )
            
           
          
          
           [
          
          
           
            G
           
           
            0
           
          
          
           ]
          
          
           =
          
          
           
            E
           
           
            
             τ
            
            
             ∼
            
            
             
              p
             
             
              θ
             
            
            
             (
            
            
             τ
            
            
             )
            
           
          
          
           [
          
          
           
            ∑
           
           
            
             t
            
            
             =
            
            
             0
            
           
           
            
             T
            
            
             −
            
            
             1
            
           
          
          
           
            γ
           
           
            t
           
          
          
           
            r
           
           
            
             t
            
            
             +
            
            
             1
            
           
          
          
           ]
          
         
        
       
       
         {large {J(theta) = mathbb{E}_{tausim p_theta(tau)}[G(tau)] = mathbb{E}_{tausim p_theta(tau)}[G_0]= mathbb{E}_{tausim p_theta(tau)}[sum_{t=0}^{T-1}gamma^tr_{t+1}]} } 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 3.66668em;vertical-align: -1.50001em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord mathdefault" style="margin-right: 0.09618em">J</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.17603em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.17603em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.17603em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mopen">[</span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.80556em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.2em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.2em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25001em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.823053em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></span></span></span><br> 为什么最大化期望回报就能作为强化学习的目标？</p> 
<p>显然不同的轨迹导致不同的结果，我们希望回报越大的轨迹对应的概率越大，反过来，如果回报大的轨迹对应的概率小，那么得到的期望回报就越小。因此，最大化期望回报就会使得学习出来的模型会尽可能让大回报的轨迹更可能发生。</p> 
<h3>
<a id="_65"></a>值函数</h3> 
<p>对我来说，值函数并不是先验的概念。我的意思是，前面所介绍的概念都是在定义强化学习时所必须的概念，不可或缺。但值函数确实在强化学习定义下，为了解决问题而导出的数学概念。</p> 
<p>我们重新考虑期望回报的问题，虽然我们明确了强化学习的目标函数是期望回报，但并没有说如何计算它。显然如果直接按照期望的定义计算那是非常复杂的，因为我们根本不可能列出所有可能的轨迹。</p> 
<p>于是贝尔曼通过动态规划的思想简化了它的计算问题</p> 
<p>首先，<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              
               
                E
               
               
                
                 τ
                
                
                 ∼
                
                
                 p
                
                
                 (
                
                
                 τ
                
                
                 )
                
               
              
              
               [
              
              
               G
              
              
               (
              
              
               τ
              
              
               )
              
              
               ]
              
             
            
           
           
            
             
              
              
               =
              
              
               
                E
               
               
                
                 s
                
                
                 ∼
                
                
                 p
                
                
                 
                  (
                 
                 
                  
                   s
                  
                  
                   0
                  
                 
                 
                  )
                 
                
               
              
              
               
                [
               
               
                
                 E
                
                
                 
                  τ
                 
                 
                  ∼
                 
                 
                  p
                 
                 
                  (
                 
                 
                  τ
                 
                 
                  )
                 
                
               
               
                
                 [
                
                
                 
                  ∑
                 
                 
                  
                   t
                  
                  
                   =
                  
                  
                   0
                  
                 
                 
                  
                   T
                  
                  
                   −
                  
                  
                   1
                  
                 
                
                
                 
                  γ
                 
                 
                  t
                 
                
                
                 
                  r
                 
                 
                  
                   t
                  
                  
                   +
                  
                  
                   1
                  
                 
                
                
                 ∣
                
                
                 
                  τ
                 
                 
                  
                   s
                  
                  
                   0
                  
                 
                
                
                 =
                
                
                 s
                
                
                 ]
                
               
               
                ]
               
              
             
            
           
          
          
           
            
             
            
           
           
            
             
              
              
               =
              
              
               
                E
               
               
                
                 s
                
                
                 ∼
                
                
                 p
                
                
                 
                  (
                 
                 
                  
                   s
                  
                  
                   0
                  
                 
                 
                  )
                 
                
               
              
              
               
                [
               
               
                
                 V
                
                
                 π
                
               
               
                (
               
               
                s
               
               
                )
               
               
                ]
               
              
             
            
           
          
         
        
       
       
         {large mathbf{begin{aligned} mathbb{E}_{tau sim p(tau)}[G(tau)] &amp;=mathbb{E}_{s sim pleft(s_{0}right)}left[mathbb{E}_{tau sim p(tau)}left[sum_{t=0}^{T-1} gamma^{t} r_{t+1} mid tau_{s_{0}}=sright]right] \ &amp;=mathbb{E}_{s sim pleft(s_{0}right)}left[V^{pi}(s)right] end{aligned}} } 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 5.82669em;vertical-align: -2.61334em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.67779em"><span class=""><span class="pstrut" style="height: 3.80556em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mopen">[</span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mclose">]</span></span></span><span class=""><span class="pstrut" style="height: 3.80556em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.17779em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.67779em"><span class=""><span class="pstrut" style="height: 3.80556em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.31131em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size3 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.34033em"><span class="" style="margin-left: 0em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mclose sizing reset-size4 size3 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.10002em"><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎣</span></span></span><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.50002em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.10002em"><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎣</span></span></span><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.50002em"><span class=""></span></span></span></span></span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.80556em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.2em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.2em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25001em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.823053em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.13704em"><span class="" style="margin-left: -0.1132em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.34033em"><span class="" style="margin-left: 0em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.245333em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">s</span><span class="mclose sizing reset-size7 size6"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.10002em"><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎦</span></span></span><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.50002em"><span class=""></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.10002em"><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎦</span></span></span><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.50002em"><span class=""></span></span></span></span></span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.80556em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.31131em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size3 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.34033em"><span class="" style="margin-left: 0em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mclose sizing reset-size4 size3 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">]</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.17779em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br> 我们把<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         V
        
        
         π
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       V^pi(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>称为状态价值函数，即在给定初始状态为s的情况的期望回报<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            V
           
           
            π
           
          
          
           (
          
          
           s
          
          
           )
          
          
           =
          
          
           
            E
           
           
            
             τ
            
            
             ∼
            
            
             p
            
            
             (
            
            
             τ
            
            
             )
            
           
          
          
           
            [
           
           
            
             ∑
            
            
             
              t
             
             
              =
             
             
              0
             
            
            
             
              T
             
             
              −
             
             
              1
             
            
           
           
            
             γ
            
            
             t
            
           
           
            
             r
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            ∣
           
           
            
             τ
            
            
             
              s
             
             
              0
             
            
           
           
            =
           
           
            s
           
           
            ]
           
          
         
        
       
       
         {large {V^pi(s) = mathbb{E}_{tau sim p(tau)}left[sum_{t=0}^{T-1} gamma^{t} r_{t+1} mid tau_{s_{0}}=sright]}} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 3.66669em;vertical-align: -1.50002em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.10002em"><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎣</span></span></span><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.50002em"><span class=""></span></span></span></span></span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.80556em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.2em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.2em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25001em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.823053em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.13704em"><span class="" style="margin-left: -0.1132em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.34033em"><span class="" style="margin-left: 0em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.245333em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">s</span><span class="mclose sizing reset-size7 size6"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.10002em"><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎦</span></span></span><span class=""><span class="pstrut" style="height: 3.155em"></span><span class="delimsizinginner delim-size4"><span class="">⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.50002em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br> 经过一系列的数学手段<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              
               
                V
               
               
                π
               
              
              
               (
              
              
               s
              
              
               )
              
              
               =
              
              
               
                E
               
               
                
                 τ
                
                
                 
                  0
                 
                 
                  :
                 
                 
                  T
                 
                 
                  ∼
                 
                 
                  p
                 
                
               
              
              
               
                [
               
               
                
                 r
                
                
                 1
                
               
               
                +
               
               
                γ
               
               
                
                 ∑
                
                
                 
                  t
                 
                 
                  =
                 
                 
                  1
                 
                
                
                 
                  T
                 
                 
                  −
                 
                 
                  1
                 
                
               
               
                
                 γ
                
                
                 
                  t
                 
                 
                  −
                 
                 
                  1
                 
                
               
               
                
                 r
                
                
                 
                  t
                 
                 
                  +
                 
                 
                  1
                 
                
               
               
                ∣
               
               
                
                 τ
                
                
                 
                  s
                 
                 
                  0
                 
                
               
               
                =
               
               
                s
               
               
                ]
               
              
             
            
           
          
          
           
            
             
              
               =
              
              
               
                E
               
               
                
                 a
                
                
                 ∼
                
                
                 π
                
                
                 (
                
                
                 a
                
                
                 ∣
                
                
                 s
                
                
                 )
                
               
              
              
               
                E
               
               
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 ∼
                
                
                 p
                
                
                 
                  (
                 
                 
                  
                   s
                  
                  
                   ′
                  
                 
                 
                  ∣
                 
                 
                  s
                 
                 
                  ,
                 
                 
                  a
                 
                 
                  )
                 
                
               
              
              
               
                E
               
               
                
                 
                  τ
                 
                 
                  
                   1
                  
                  
                   :
                  
                  
                   T
                  
                 
                
                
                 ∼
                
                
                 p
                
                
                 (
                
                
                 τ
                
                
                 )
                
               
              
              
               
                [
               
               
                r
               
               
                
                 (
                
                
                 s
                
                
                 ,
                
                
                 a
                
                
                 ,
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 )
                
               
               
                +
               
               
                γ
               
               
                
                 ∑
                
                
                 
                  t
                 
                 
                  =
                 
                 
                  1
                 
                
                
                 
                  T
                 
                 
                  −
                 
                 
                  1
                 
                
               
               
                
                 γ
                
                
                 
                  t
                 
                 
                  −
                 
                 
                  1
                 
                
               
               
                
                 r
                
                
                 
                  t
                 
                 
                  +
                 
                 
                  1
                 
                
               
               
                ∣
               
               
                
                 τ
                
                
                 
                  s
                 
                 
                  1
                 
                
               
               
                =
               
               
                
                 s
                
                
                 ′
                
               
               
                ]
               
              
             
            
           
          
          
           
            
             
              
               =
              
              
               
                E
               
               
                
                 a
                
                
                 ∼
                
                
                 π
                
                
                 (
                
                
                 a
                
                
                 ∣
                
                
                 s
                
                
                 )
                
               
              
              
               
                E
               
               
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 ∼
                
                
                 p
                
                
                 
                  (
                 
                 
                  
                   s
                  
                  
                   ′
                  
                 
                 
                  ∣
                 
                 
                  s
                 
                 
                  ,
                 
                 
                  a
                 
                 
                  )
                 
                
               
              
              
               
                [
               
               
                r
               
               
                
                 (
                
                
                 s
                
                
                 ,
                
                
                 a
                
                
                 ,
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 )
                
               
               
                +
               
               
                γ
               
               
                
                 E
                
                
                 
                  
                   τ
                  
                  
                   
                    1
                   
                   
                    :
                   
                   
                    T
                   
                  
                 
                 
                  ∼
                 
                 
                  p
                 
                 
                  (
                 
                 
                  τ
                 
                 
                  )
                 
                
               
               
                
                 [
                
                
                 
                  ∑
                 
                 
                  
                   t
                  
                  
                   =
                  
                  
                   1
                  
                 
                 
                  
                   T
                  
                  
                   −
                  
                  
                   1
                  
                 
                
                
                 
                  γ
                 
                 
                  
                   t
                  
                  
                   −
                  
                  
                   1
                  
                 
                
                
                 
                  r
                 
                 
                  
                   t
                  
                  
                   +
                  
                  
                   1
                  
                 
                
                
                 ∣
                
                
                 
                  τ
                 
                 
                  
                   s
                  
                  
                   1
                  
                 
                
                
                 =
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 ]
                
               
               
                ]
               
              
             
            
           
          
          
           
            
             
              
               =
              
              
               
                E
               
               
                
                 a
                
                
                 ∼
                
                
                 π
                
                
                 (
                
                
                 a
                
                
                 ∣
                
                
                 s
                
                
                 )
                
               
              
              
               
                E
               
               
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 ∼
                
                
                 p
                
                
                 
                  (
                 
                 
                  
                   s
                  
                  
                   ′
                  
                 
                 
                  ∣
                 
                 
                  s
                 
                 
                  ,
                 
                 
                  a
                 
                 
                  )
                 
                
               
              
              
               
                [
               
               
                r
               
               
                
                 (
                
                
                 s
                
                
                 ,
                
                
                 a
                
                
                 ,
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 )
                
               
               
                +
               
               
                γ
               
               
                
                 V
                
                
                 π
                
               
               
                
                 (
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 )
                
               
               
                ]
               
              
              
               .
              
             
            
           
          
         
        
       
       
         {large mathbf{begin{array}{l} V^{pi}(s)=mathbb{E}_{tau_{0: T sim p}}left[r_{1}+gamma sum_{t=1}^{T-1} gamma^{t-1} r_{t+1} mid tau_{s_{0}}=sright] \ =mathbb{E}_{a sim pi(a mid s)} mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)} mathbb{E}_{tau_{1: T} sim p(tau)}left[rleft(s, a, s^{prime}right)+gamma sum_{t=1}^{T-1} gamma^{t-1} r_{t+1} mid tau_{s_{1}}=s^{prime}right] \ =mathbb{E}_{a sim pi(a mid s)} mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)}left[rleft(s, a, s^{prime}right)+gamma mathbb{E}_{tau_{1: T} sim p(tau)}left[sum_{t=1}^{T-1} gamma^{t-1} r_{t+1} mid tau_{s_{1}}=s^{prime}right]right] \ =mathbb{E}_{a sim pi(a mid s)} mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)}left[rleft(s, a, s^{prime}right)+gamma V^{pi}left(s^{prime}right)right] . end{array}} } 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 6.9943em;vertical-align: -3.19715em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord"><span class="mtable"><span class="arraycolsep" style="width: 0.5em"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.16429em"><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.65004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.13704em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: -0.1132em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.313527em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.359018em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size2">[</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop"><span class="mop op-symbol small-op">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.97022em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.297343em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.792627em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.13704em"><span class="" style="margin-left: -0.1132em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.34033em"><span class="" style="margin-left: 0em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.245333em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">s</span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size2">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">a</span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size6 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">a</span><span class="mclose sizing reset-size4 size6 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.488533em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: -0.1132em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.167697em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size2">[</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.733373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop"><span class="mop op-symbol small-op">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.97022em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.297343em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.792627em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.13704em"><span class="" style="margin-left: -0.1132em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.34033em"><span class="" style="margin-left: 0em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.245333em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.733373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size2">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">a</span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size6 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">a</span><span class="mclose sizing reset-size4 size6 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.488533em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size2">[</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.733373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: -0.1132em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.167697em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size2">[</span></span><span class="mop"><span class="mop op-symbol small-op">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.97022em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.297343em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.792627em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.279627em"><span class="" style="margin-left: -0.02778em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.205553em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.13704em"><span class="" style="margin-left: -0.1132em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.34033em"><span class="" style="margin-left: 0em;margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.245333em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.733373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size2">]</span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size2">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">a</span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size6 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">a</span><span class="mclose sizing reset-size4 size6 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.488533em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">[</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.733373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.65004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.733373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">]</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord">.</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.66429em"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em"></span></span></span></span></span></span></span></span></span></span><br> 我们最终得到了<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         V
        
        
         π
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       V_pi(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: -0.22222em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>的迭代关系，这个关系叫做<strong>贝尔曼方程</strong>。</p> 
<p>可以证明，只要给定策略和状态转移概率，那么我们可以随机初始化<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         V
        
        
         π
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       V_pi(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: -0.22222em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>的值，通过反复迭代，最终会收敛到一个正确的状态价值函数。至于证明方法我们暂且不管。</p> 
<p>仅有一个状态值函数还不够，毕竟在计算<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         V
        
        
         π
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       V^pi(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>之前，我们需要先知道策略<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        π
       
       
        (
       
       
        a
       
       
        ∣
       
       
        s
       
       
        )
       
      
      
       pi(a|s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord">∣</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>，但是好巧不巧的是强化学习学的就是<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        π
       
       
        (
       
       
        a
       
       
        ∣
       
       
        s
       
       
        )
       
      
      
       pi(a|s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord">∣</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>…</p> 
<p>那就这样吧，我们也不用最大化期望回报了，我们直接通过最大化状态价值函数来求<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        π
       
      
      
       pi
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span></span></span></span></span><br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         π
        
        
         =
        
        
         a
        
        
         r
        
        
         g
        
        
         m
        
        
         a
        
        
         
          x
         
         
          π
         
        
        
         
          V
         
         
          π
         
        
        
         (
        
        
         s
        
        
         )
        
       
       
         pi = argmax_pi V^pi(s) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mord mathdefault" style="margin-right: 0.03588em">g</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span></span><br> 其实我们很容易想到，这东西肯定没有闭式解。所以只能通过迭代的方式更新<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        π
       
      
      
       pi
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span></span></span></span></span>，但是要怎么更新呢?</p> 
<p>其实有两种方法，我们后面会讲到，现在先简单提一下。一个是将<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        π
       
      
      
       pi
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span></span></span></span></span>参数化成<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         π
        
        
         θ
        
       
       
        (
       
       
        a
       
       
        ∣
       
       
        s
       
       
        )
       
      
      
       pi_theta(a|s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord">∣</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>，我们通过计算期望回报对<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        θ
       
      
      
       theta
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span></span></span>的梯度从而使用梯度下降的算法优化<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        θ
       
      
      
       theta
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span></span></span>。另一个就是我们下面要讲的东西。</p> 
<p>我们需要引入一个新的概念叫做状态-动作价值函数<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            Q
           
           
            π
           
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
          
           =
          
          
           
            E
           
           
            
             
              s
             
             
              ′
             
            
            
             ∼
            
            
             p
            
            
             
              (
             
             
              
               s
              
              
               ′
              
             
             
              ∣
             
             
              s
             
             
              ,
             
             
              a
             
             
              )
             
            
           
          
          
           
            [
           
           
            r
           
           
            
             (
            
            
             s
            
            
             ,
            
            
             a
            
            
             ,
            
            
             
              s
             
             
              ′
             
            
            
             )
            
           
           
            +
           
           
            γ
           
           
            
             V
            
            
             π
            
           
           
            
             (
            
            
             
              s
             
             
              ′
             
            
            
             )
            
           
           
            ]
           
          
         
        
       
       
         {large mathbf{Q^pi(s,a) = mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)}left[rleft(s, a, s^{prime}right)+gamma V^{pi}left(s^{prime}right)right]}} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.52629em;vertical-align: -0.58624em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord"><span class="mord mathbf">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathbf">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathbf mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size6 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathbf mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathbf mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathbf mtight">a</span><span class="mclose sizing reset-size4 size6 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.488533em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">[</span></span><span class="mord mathbf">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathbf">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathbf">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathbf">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord mathbf" style="margin-right: 0.01597em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathbf">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">]</span></span></span></span></span></span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         Q
        
        
         π
        
       
       
        (
       
       
        s
       
       
        ,
       
       
        a
       
       
        )
       
      
      
       Q^pi(s,a)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span>表示给定初始状态和初始动作后的期望回报，通过<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         Q
        
        
         π
        
       
       
        (
       
       
        s
       
       
        ,
       
       
        a
       
       
        )
       
      
      
       Q^pi(s,a)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span>的定义，我们可以将<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         V
        
        
         π
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       V^pi(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>的自迭代转变为<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         V
        
        
         π
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       V^pi(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>与<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         Q
        
        
         π
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       Q^pi(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>的相互迭代。因为<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            V
           
           
            π
           
          
          
           (
          
          
           s
          
          
           )
          
          
           =
          
          
           
            E
           
           
            
             a
            
            
             ∼
            
            
             π
            
            
             (
            
            
             a
            
            
             ∣
            
            
             s
            
            
             )
            
           
          
          
           
            Q
           
           
            π
           
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
         
        
       
       
         {large mathbf{V^pi(s) = mathbb{E}_{a sim pi(a mid s)} Q^pi(s,a)}} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.28624em;vertical-align: -0.38624em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord"><span class="mord mathbf" style="margin-right: 0.01597em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">s</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span><span class="mopen mtight">(</span><span class="mord mathbf mtight">a</span><span class="mrel mtight">∣</span><span class="mord mathbf mtight">s</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathbf">a</span><span class="mclose">)</span></span></span></span></span></span></span></span><br> 那么为什么非要引入它呢？</p> 
<p>假设在状态s，有一个动作<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         a
        
        
         ∗
        
       
      
      
       a^*
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.688696em;vertical-align: 0em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>，如果<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         Q
        
        
         π
        
       
       
        (
       
       
        s
       
       
        ,
       
       
        
         a
        
        
         ∗
        
       
       
        )
       
       
        =
       
       
        
         
          max
         
         
          ⁡
         
        
        
         a
        
       
       
        
         Q
        
        
         π
        
       
       
        (
       
       
        s
       
       
        ,
       
       
        a
       
       
        )
       
      
      
       Q^pi(s,a^*) = max_a Q^pi(s,a)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span>，这样一来就是说在状态<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        s
       
      
      
       s
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault">s</span></span></span></span></span>下执行动作<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         a
        
        
         ∗
        
       
      
      
       a^*
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.688696em;vertical-align: 0em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>是回报最高的。所以我们自然可以调高<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        π
       
       
        (
       
       
        
         a
        
        
         ∗
        
       
       
        ∣
       
       
        s
       
       
        )
       
      
      
       pi(a^*|s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.688696em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>的值从而达到优化策略的目的</p> 
<h3>
<a id="_119"></a>优化算法</h3> 
<p>在介绍完强化学习的模型表示和目标函数后，自然而然来到第三个要素，即优化算法。强化学习的算法主要分为两大类。一类是基于值函数的优化算法，另一类是基于策略优化的算法。强化学习算法分类如图</p> 
<div class="mermaid sequence-diagram">
 
  #mermaid-svg-kWHfWaxWXyHboKDq {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-kWHfWaxWXyHboKDq .error-icon{fill:#552222;}#mermaid-svg-kWHfWaxWXyHboKDq .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-kWHfWaxWXyHboKDq .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-kWHfWaxWXyHboKDq .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-kWHfWaxWXyHboKDq .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-kWHfWaxWXyHboKDq .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-kWHfWaxWXyHboKDq .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-kWHfWaxWXyHboKDq .marker{fill:#333333;stroke:#333333;}#mermaid-svg-kWHfWaxWXyHboKDq .marker.cross{stroke:#333333;}#mermaid-svg-kWHfWaxWXyHboKDq svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-kWHfWaxWXyHboKDq .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-kWHfWaxWXyHboKDq .cluster-label text{fill:#333;}#mermaid-svg-kWHfWaxWXyHboKDq .cluster-label span{color:#333;}#mermaid-svg-kWHfWaxWXyHboKDq .label text,#mermaid-svg-kWHfWaxWXyHboKDq span{fill:#333;color:#333;}#mermaid-svg-kWHfWaxWXyHboKDq .node rect,#mermaid-svg-kWHfWaxWXyHboKDq .node circle,#mermaid-svg-kWHfWaxWXyHboKDq .node ellipse,#mermaid-svg-kWHfWaxWXyHboKDq .node polygon,#mermaid-svg-kWHfWaxWXyHboKDq .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-kWHfWaxWXyHboKDq .node .label{text-align:center;}#mermaid-svg-kWHfWaxWXyHboKDq .node.clickable{cursor:pointer;}#mermaid-svg-kWHfWaxWXyHboKDq .arrowheadPath{fill:#333333;}#mermaid-svg-kWHfWaxWXyHboKDq .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-kWHfWaxWXyHboKDq .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-kWHfWaxWXyHboKDq .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-kWHfWaxWXyHboKDq .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-kWHfWaxWXyHboKDq .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-kWHfWaxWXyHboKDq .cluster text{fill:#333;}#mermaid-svg-kWHfWaxWXyHboKDq .cluster span{color:#333;}#mermaid-svg-kWHfWaxWXyHboKDq div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-kWHfWaxWXyHboKDq :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
  
   
    
    
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
     
      
      
       
        
       
      
     
    
    
     
      
       
       
        <div>
         <span id="L-L-强化学习-策略优化" class="edgeLabel L-LS-强化学习' L-LE-策略优化"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-强化学习-值函数优化" class="edgeLabel L-LS-强化学习' L-LE-值函数优化"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-策略优化-策略梯度" class="edgeLabel L-LS-策略优化' L-LE-策略梯度"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-策略梯度-Reinforce算法" class="edgeLabel L-LS-策略梯度' L-LE-Reinforce算法"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-Reinforce算法-Reinforce-With-Baseline" class="edgeLabel L-LS-Reinforce算法' L-LE-Reinforce-With-Baseline"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-值函数优化-模型已知" class="edgeLabel L-LS-值函数优化' L-LE-模型已知"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-值函数优化-模型未知" class="edgeLabel L-LS-值函数优化' L-LE-模型未知"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-模型已知-动态规划" class="edgeLabel L-LS-模型已知' L-LE-动态规划"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-模型未知-蒙特卡罗" class="edgeLabel L-LS-模型未知' L-LE-蒙特卡罗"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-模型未知-时序差分" class="edgeLabel L-LS-模型未知' L-LE-时序差分"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-动态规划-策略迭代" class="edgeLabel L-LS-动态规划' L-LE-策略迭代"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-动态规划-值迭代" class="edgeLabel L-LS-动态规划' L-LE-值迭代"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-时序差分-Sarsa" class="edgeLabel L-LS-时序差分' L-LE-Sarsa"></span>
        </div>
       
      
     
     
      
       
       
        <div>
         <span id="L-L-时序差分-Q-Learning" class="edgeLabel L-LS-时序差分' L-LE-Q-Learning"></span>
        </div>
       
      
     
    
    
     
      
      
       
        
         <div>
          强化学习
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          策略优化
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          值函数优化
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          策略梯度
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          Reinforce算法
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          Reinforce-With-Baseline
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          模型已知
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          模型未知
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          动态规划
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          蒙特卡罗
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          时序差分
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          策略迭代
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          值迭代
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          Sarsa
         </div>
        
       
      
     
     
      
      
       
        
         <div>
          Q-Learning
         </div>
        
       
      
     
    
   
  
 
</div> 
<p>基于值函数的优化算法一般采用确定性策略，基于策略优化的算法则一般采用随机性策略，当然也适用于确定性策略。</p> 
<h3>
<a id="_141"></a>动态规划</h3> 
<p>之所以叫动态规划算法，是因为这一类的算法都是基于贝尔曼方程的价值迭代。让我们回顾一下贝尔曼方程<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            Q
           
           
            π
           
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
          
           =
          
          
           
            E
           
           
            
             
              s
             
             
              ′
             
            
            
             ∼
            
            
             p
            
            
             
              (
             
             
              
               s
              
              
               ′
              
             
             
              ∣
             
             
              s
             
             
              ,
             
             
              a
             
             
              )
             
            
           
          
          
           
            [
           
           
            r
           
           
            
             (
            
            
             s
            
            
             ,
            
            
             a
            
            
             ,
            
            
             
              s
             
             
              ′
             
            
            
             )
            
           
           
            +
           
           
            γ
           
           
            
             V
            
            
             π
            
           
           
            
             (
            
            
             
              s
             
             
              ′
             
            
            
             )
            
           
           
            ]
           
          
         
        
        
        
         
          
           
            V
           
           
            π
           
          
          
           (
          
          
           s
          
          
           )
          
          
           =
          
          
           
            E
           
           
            
             a
            
            
             ∼
            
            
             π
            
            
             (
            
            
             a
            
            
             ∣
            
            
             s
            
            
             )
            
           
          
          
           
            Q
           
           
            π
           
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
         
        
       
       
         {large mathbf{Q^pi(s,a) = mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)}left[rleft(s, a, s^{prime}right)+gamma V^{pi}left(s^{prime}right)right]}} \ {large mathbf{V^pi(s) = mathbb{E}_{a sim pi(a mid s)} Q^pi(s,a)}} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.52629em;vertical-align: -0.58624em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord"><span class="mord mathbf">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathbf">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathbf mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size6 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathbf mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathbf mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathbf mtight">a</span><span class="mclose sizing reset-size4 size6 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.488533em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">[</span></span><span class="mord mathbf">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathbf">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathbf">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathbf">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord mathbf" style="margin-right: 0.01597em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathbf">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">]</span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height: 1.28624em;vertical-align: -0.38624em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mord"><span class="mord mathbf" style="margin-right: 0.01597em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">s</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span><span class="mopen mtight">(</span><span class="mord mathbf mtight">a</span><span class="mrel mtight">∣</span><span class="mord mathbf mtight">s</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.321867em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathbf">a</span><span class="mclose">)</span></span></span></span></span></span></span></span><br> 我们之前介绍过，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        π
       
      
      
       pi
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span></span></span></span></span>只能通过反复迭代获得，但在介绍了状态价值函数之后，我们可以对迭代对象有更多的考虑，因为对于确定性策略，有<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         π
        
        
         (
        
        
         s
        
        
         )
        
        
         =
        
        
         a
        
        
         r
        
        
         g
        
        
         m
        
        
         a
        
        
         
          x
         
         
          a
         
        
        
         Q
        
        
         (
        
        
         s
        
        
         ,
        
        
         a
        
        
         )
        
       
       
         pi(s) = argmax_aQ(s,a) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mord mathdefault" style="margin-right: 0.03588em">g</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord mathdefault">Q</span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span></span><br> 也就是说，如果我们能得到最优的状态动作价值函数，我们就能直接导出最优策略。所以现在有两个路子，一个是我们随机初始化策略和状态动作价值函数，然后在当前策略下通过贝尔曼方程求得最优的价值函数，最后根据价值函数更新策略这就叫<strong>策略迭代</strong>。另一个是我们随机初始化价值函数，然后通过价值函数导出当前最优策略，并根据最优策略更新价值函数，最终得到最优价值函数。这叫<strong>值迭代</strong>。</p> 
<h4>
<a id="_154"></a>策略迭代</h4> 
<p>通常我们把策略迭代分为两个阶段，即<strong>策略评估</strong>和<strong>策略改进</strong>，策略评估顾名思义就是评估当前策略好不好，评估的标准就是价值函数，所以策略评估就是求价值函数。策略改进我们前面讲过，就是利用价值函数改进策略。之所以叫策略迭代就是因为我们主要的迭代对象就是策略，而价值函数只有一个中间过程。</p> 
<p><img src="https://images2.imgbox.com/48/9a/qjKe5R8w_o.png" alt="" width="450"></p> 
<h4>
<a id="_161"></a>值迭代</h4> 
<p>值迭代的对象是价值函数，策略更新反而变成了中间过程。可能从下面的算法过程第三行大家没有看到策略的出现，但其实里面已经包含了求根据价值函数导出最优策略的过程。</p> 
<p><img src="https://images2.imgbox.com/f9/0a/DPA6yfq0_o.png" alt="在这里插入图片描述" width="450"></p> 
<p>虽然从思想上策略迭代和值迭代刚好相反，但是在实际算法过程上，值迭代就相当于在使用贝尔曼方程计算价值函数时只迭代一次的策略迭代。</p> 
<p>值得注意的是，上面介绍的是基于状态价值函数V的值迭代，但我们也可以使用状态动作价值函数Q<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              
               
                Q
               
               
                π
               
              
              
               (
              
              
               s
              
              
               ,
              
              
               a
              
              
               )
              
             
            
           
           
            
             
              
              
               =
              
              
               
                E
               
               
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 ∼
                
                
                 p
                
                
                 
                  (
                 
                 
                  
                   s
                  
                  
                   ′
                  
                 
                 
                  ∣
                 
                 
                  s
                 
                 
                  ,
                 
                 
                  a
                 
                 
                  )
                 
                
               
              
              
               
                [
               
               
                r
               
               
                
                 (
                
                
                 s
                
                
                 ,
                
                
                 a
                
                
                 ,
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 )
                
               
               
                +
               
               
                γ
               
               
                
                 V
                
                
                 π
                
               
               
                (
               
               
                
                 s
                
                
                 ′
                
               
               
                )
               
               
                ]
               
              
             
            
           
          
          
           
            
             
            
           
           
            
             
              
              
               =
              
              
               
                E
               
               
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 ∼
                
                
                 p
                
                
                 
                  (
                 
                 
                  
                   s
                  
                  
                   ′
                  
                 
                 
                  ∣
                 
                 
                  s
                 
                 
                  ,
                 
                 
                  a
                 
                 
                  )
                 
                
               
              
              
               
                [
               
               
                r
               
               
                
                 (
                
                
                 s
                
                
                 ,
                
                
                 a
                
                
                 ,
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 )
                
               
               
                +
               
               
                γ
               
               
                
                 
                  max
                 
                 
                  ⁡
                 
                
                
                 
                  a
                 
                 
                  ′
                 
                
               
               
                
                 Q
                
                
                 π
                
               
               
                (
               
               
                
                 s
                
                
                 ′
                
               
               
                ,
               
               
                
                 a
                
                
                 ′
                
               
               
                )
               
               
                ]
               
              
             
            
           
          
         
        
       
       
         {large begin{aligned} Q^pi(s,a) &amp;= mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)}left[rleft(s, a, s^{prime}right)+gamma V^pi(s^prime)right] \ &amp;=mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)}left[rleft(s, a, s^{prime}right)+gamma max_{a^prime} Q^pi(s^prime,a^prime)right] end{aligned}} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 4.71427em;vertical-align: -2.05713em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.21428em"><span class=""><span class="pstrut" style="height: 3.25833em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span><span class=""><span class="pstrut" style="height: 3.25833em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.71428em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.21428em"><span class=""><span class="pstrut" style="height: 3.25833em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size6 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">a</span><span class="mclose sizing reset-size4 size6 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.488533em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">[</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.25833em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size6 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">a</span><span class="mclose sizing reset-size4 size6 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.488533em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size3">[</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.43056em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span><span class=""><span class="pstrut" style="height: 2.8em"></span><span class=""><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.734447em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size3">]</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.71428em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<h4>
<a id="_178"></a>代码介绍</h4> 
<p>光贴个简单的算法截图大家可能还不能很好的理解这个过程，那么我们来看看实际的代码吧。</p> 
<p>在介绍具体的算法代码之前，我们先来介绍一下整体框架。</p> 
<p>首先是gym这个库，gym提供了强化学习需要的环境, 可以创造一些数据集, 用来测试和学习强化学习。</p> 
<p>假如我们要产生一条完整的轨迹并计算回报</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> gym
<span class="token comment"># 创建游戏环境</span>
env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">'CartPole-v0'</span><span class="token punctuation">)</span>
<span class="token comment"># policy是一维的tensor，可以存放每个状态对应的动作</span>
<span class="token keyword">def</span> <span class="token function">run_episode</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> policy<span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> render<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    total_reward <span class="token operator">=</span> <span class="token number">0</span>
    step_idx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
     	<span class="token comment"># 显示游戏画面</span>
        <span class="token keyword">if</span> render<span class="token punctuation">:</span>
            env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
        obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>policy<span class="token punctuation">[</span>obs<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 计算折扣累积回报</span>
        total_reward <span class="token operator">+=</span> <span class="token punctuation">(</span>gamma <span class="token operator">**</span> step_idx <span class="token operator">*</span> reward<span class="token punctuation">)</span>
        step_idx <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> total_reward
</code></pre> 
<p>依照策略迭代的算法，我们的算法框架如下</p> 
<pre><code class="prism language-python"><span class="token comment"># 总的策略迭代算法框架</span>
<span class="token keyword">def</span> <span class="token function">policy_iteration</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 初始化一个随机策略</span>
    <span class="token comment"># 即对每个状态赋予一个动作（确定性策略、状态离散）</span>
    policy <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n<span class="token punctuation">,</span> size<span class="token operator">=</span>env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>n<span class="token punctuation">)</span>
    max_iterations <span class="token operator">=</span> <span class="token number">20000</span>
    gamma <span class="token operator">=</span> <span class="token number">1.0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_iterations<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 策略评估</span>
        old_policy_v <span class="token operator">=</span> compute_policy_v<span class="token punctuation">(</span>env<span class="token punctuation">,</span> policy<span class="token punctuation">,</span> gamma<span class="token punctuation">)</span>
        <span class="token comment"># 策略改进</span>
        new_policy <span class="token operator">=</span> extract_policy<span class="token punctuation">(</span>env<span class="token punctuation">,</span> old_policy_v<span class="token punctuation">,</span> gamma<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span>policy <span class="token operator">==</span> new_policy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断策略是否收敛</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Policy-Iteration converged at iteration %d.'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        policy <span class="token operator">=</span> new_policy  <span class="token comment"># 如果没收敛，则以当前你策略为起点，继续循环策略评估和策略提升两个过程</span>
    <span class="token keyword">return</span> policy
</code></pre> 
<p>具体如何用贝尔曼方程计算价值函数，即如何进行策略评估</p> 
<pre><code class="prism language-python"><span class="token comment"># 计算当前策略下的价值函数</span>
<span class="token keyword">def</span> <span class="token function">compute_policy_v</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> policy<span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 初始化值函数为０</span>
    v <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>n<span class="token punctuation">)</span>
    eps <span class="token operator">=</span> <span class="token number">1e-10</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        prev_v <span class="token operator">=</span> np<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token comment"># 遍历前一时刻的每一个状态</span>
        <span class="token keyword">for</span> s <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            a <span class="token operator">=</span> policy<span class="token punctuation">[</span>s<span class="token punctuation">]</span>
            v<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p <span class="token operator">*</span> <span class="token punctuation">(</span>r <span class="token operator">+</span> gamma <span class="token operator">*</span> prev_v<span class="token punctuation">[</span>s_<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p<span class="token punctuation">,</span> s_<span class="token punctuation">,</span> r<span class="token punctuation">,</span> _ <span class="token keyword">in</span> env<span class="token punctuation">.</span>env<span class="token punctuation">.</span>P<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 如果更新前后的值函数Ｖ小于给定阈值，说明收敛了，返回v_pi</span>
        <span class="token keyword">if</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>fabs<span class="token punctuation">(</span>prev_v <span class="token operator">-</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> eps<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Value function converged."</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> v
</code></pre> 
<p>策略改进，即根据公式 <span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         Q
        
        
         π
        
       
       
        (
       
       
        s
       
       
        ,
       
       
        a
       
       
        )
       
       
        =
       
       
        
         E
        
        
         
          
           s
          
          
           ′
          
         
         
          ∼
         
         
          p
         
         
          
           (
          
          
           
            s
           
           
            ′
           
          
          
           ∣
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
         
        
       
       
        
         [
        
        
         r
        
        
         
          (
         
         
          s
         
         
          ,
         
         
          a
         
         
          ,
         
         
          
           s
          
          
           ′
          
         
         
          )
         
        
        
         +
        
        
         γ
        
        
         
          V
         
         
          π
         
        
        
         
          (
         
         
          
           s
          
          
           ′
          
         
         
          )
         
        
        
         ]
        
       
      
      
       mathbf{Q^pi(s,a) = mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)}left[rleft(s, a, s^{prime}right)+gamma V^{pi}left(s^{prime}right)right]}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.10709em;vertical-align: -0.3552em"></span><span class="mord"><span class="mord"><span class="mord mathbf">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathbf">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.682829em"><span class="" style="margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathbf mtight">p</span><span class="minner mtight"><span class="mopen mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathbf mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.682829em"><span class="" style="margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathbf mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathbf mtight">a</span><span class="mclose mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">[</span><span class="mord mathbf">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathbf">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathbf">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathbf">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord mathbf" style="margin-right: 0.01597em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathbf">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter">]</span></span></span></span></span></span></span> 利用<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         V
        
        
         π
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       V^pi(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>求出<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         Q
        
        
         π
        
       
       
        (
       
       
        s
       
       
        ,
       
       
        a
       
       
        )
       
      
      
       Q^pi(s,a)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span>，然后根据<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         Q
        
        
         π
        
       
       
        (
       
       
        s
       
       
        ,
       
       
        a
       
       
        )
       
      
      
       Q^pi(s,a)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span>导出最优策略</p> 
<pre><code class="prism language-python"><span class="token comment"># 主要步骤２：策略提升</span>
<span class="token keyword">def</span> <span class="token function">extract_policy</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> v<span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 初始化策略</span>
    policy <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> s <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        q_sa <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n<span class="token punctuation">)</span>
        <span class="token comment"># 评估当前状态下，每个动作的收益</span>
        <span class="token keyword">for</span> a <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 计算动作值函数q</span>
            q_sa<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p <span class="token operator">*</span> <span class="token punctuation">(</span>r <span class="token operator">+</span> gamma <span class="token operator">*</span> v<span class="token punctuation">[</span>s_<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p<span class="token punctuation">,</span> s_<span class="token punctuation">,</span> r<span class="token punctuation">,</span> _ <span class="token keyword">in</span> env<span class="token punctuation">.</span>env<span class="token punctuation">.</span>P<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 更新后的策略是相对于q的贪婪策略，所以使用max操作</span>
        <span class="token comment"># 这里由于可能有多个最大值，我们等概率随机选择分配</span>
        policy<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>np<span class="token punctuation">.</span>argwhere<span class="token punctuation">(</span>q_sa <span class="token operator">==</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>q_sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 返回提升的策略，根据策略提升理论，这个策略肯定比上一次迭代的策略要好</span>
    <span class="token keyword">return</span> policy
</code></pre> 
<p>完整代码见github（还没传，待续）</p> 
<h3>
<a id="_275"></a>蒙特卡罗</h3> 
<p>在模型已知的情况下，也就是我们知道马尔科夫决策过程的状态转移概率时，我们可以才可以通过策略迭代或者值迭代的方法去求解最优策略。但是模型未知的情况下，我们没有办法直接精确计算贝尔曼方程中的期望了。于是蒙特卡罗算法提出，我们可以通过采样来近似Q函数。也就是经验分布近似期望（大数定律）的思想<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         Q
        
        
         (
        
        
         s
        
        
         ,
        
        
         a
        
        
         )
        
        
         =
        
        
         
          Q
         
         
          ^
         
        
        
         (
        
        
         s
        
        
         ,
        
        
         a
        
        
         )
        
        
         =
        
        
         
          1
         
         
          N
         
        
        
         
          ∑
         
         
          
           i
          
          
           =
          
          
           1
          
         
         
          N
         
        
        
         G
        
        
         (
        
        
         
          τ
         
         
          i
         
        
        
         ∣
        
        
         
          s
         
         
          0
         
        
        
         =
        
        
         s
        
        
         ,
        
        
         
          a
         
         
          0
         
        
        
         =
        
        
         a
        
        
         )
        
       
       
         Q(s,a) = hat Q(s,a) = frac{1}{N}sum_{i=1}^{N}G(tau_i|s_0=s,a_0=a) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">Q</span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1.19677em;vertical-align: -0.25em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.94677em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord mathdefault">Q</span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="accent-body">^</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em"><span class=""></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 3.10601em;vertical-align: -1.27767em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em">N</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.27767em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 0.625em;vertical-align: -0.19444em"></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span></span></p> 
<h4>
<a id="_282"></a>蒙特卡罗的增量形式</h4> 
<p>上面的基于蒙特卡罗的策略迭代虽然确实是一种方法，但它并不好。因为一次迭代需要进行SxAxN次采样。所以我们也想考虑一下蒙特卡罗算法与值迭代的结合。但是值迭代是利用贝尔曼方程更新价值函数，显然贝尔曼方程是用不了了，那么有什么新的迭代形式呢？<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              
               Q
              
              
               ^
              
             
             
              N
             
             
              π
             
            
            
             (
            
            
             s
            
            
             ,
            
            
             a
            
            
             )
            
           
          
         
         
          
           
            
            
             =
            
            
             
              1
             
             
              N
             
            
            
             
              ∑
             
             
              
               n
              
              
               =
              
              
               1
              
             
             
              N
             
            
            
             G
            
            
             
              (
             
             
              
               τ
              
              
               
                
                 s
                
                
                 0
                
               
               
                =
               
               
                s
               
               
                ,
               
               
                
                 a
                
                
                 0
                
               
               
                =
               
               
                a
               
              
              
               
                (
               
               
                n
               
               
                )
               
              
             
             
              )
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              1
             
             
              N
             
            
            
             
              (
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 
                  s
                 
                 
                  0
                 
                
                
                 =
                
                
                 s
                
                
                 ,
                
                
                 
                  a
                 
                 
                  0
                 
                
                
                 =
                
                
                 a
                
               
               
                
                 (
                
                
                 N
                
                
                 )
                
               
              
              
               )
              
             
             
              +
             
             
              
               ∑
              
              
               
                n
               
               
                =
               
               
                1
               
              
              
               
                N
               
               
                −
               
               
                1
               
              
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 
                  s
                 
                 
                  0
                 
                
                
                 =
                
                
                 s
                
                
                 ,
                
                
                 
                  a
                 
                 
                  0
                 
                
                
                 =
                
                
                 a
                
               
               
                
                 (
                
                
                 n
                
                
                 )
                
               
              
              
               )
              
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              1
             
             
              N
             
            
            
             
              (
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 
                  s
                 
                 
                  0
                 
                
                
                 =
                
                
                 s
                
                
                 ,
                
                
                 
                  a
                 
                 
                  0
                 
                
                
                 =
                
                
                 a
                
               
               
                
                 (
                
                
                 N
                
                
                 )
                
               
              
              
               )
              
             
             
              +
             
             
              (
             
             
              N
             
             
              −
             
             
              1
             
             
              )
             
             
              
               
                Q
               
               
                ^
               
              
              
               
                N
               
               
                −
               
               
                1
               
              
              
               π
              
             
             
              (
             
             
              s
             
             
              ,
             
             
              a
             
             
              )
             
             
              )
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              
               Q
              
              
               ^
              
             
             
              
               N
              
              
               −
              
              
               1
              
             
             
              π
             
            
            
             (
            
            
             s
            
            
             ,
            
            
             a
            
            
             )
            
            
             +
            
            
             
              1
             
             
              N
             
            
            
             
              (
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 
                  s
                 
                 
                  0
                 
                
                
                 =
                
                
                 s
                
                
                 ,
                
                
                 
                  a
                 
                 
                  0
                 
                
                
                 =
                
                
                 a
                
               
               
                
                 (
                
                
                 N
                
                
                 )
                
               
              
              
               )
              
             
             
              −
             
             
              
               
                Q
               
               
                ^
               
              
              
               
                N
               
               
                −
               
               
                1
               
              
              
               π
              
             
             
              (
             
             
              s
             
             
              ,
             
             
              a
             
             
              )
             
             
              )
             
            
            
             .
            
           
          
         
        
       
       
         begin{aligned} hat{Q}_{N}^{pi}(s, a) &amp;=frac{1}{N} sum_{n=1}^{N} Gleft(tau_{s_{0}=s, a_{0}=a}^{(n)}right) \ &amp;=frac{1}{N}left(Gleft(tau_{s_{0}=s, a_{0}=a}^{(N)}right)+sum_{n=1}^{N-1} Gleft(tau_{s_{0}=s, a_{0}=a}^{(n)}right)right.\ &amp;=frac{1}{N}left(Gleft(tau_{s_{0}=s, a_{0}=a}^{(N)}right)+(N-1) hat{Q}_{N-1}^{pi}(s, a)right) \ &amp;=hat{Q}_{N-1}^{pi}(s, a)+frac{1}{N}left(Gleft(tau_{s_{0}=s, a_{0}=a}^{(N)} right)-hat{Q}_{N-1}^{pi}(s, a)right). end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 11.4058em;vertical-align: -5.45289em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 5.95289em"><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.94677em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">Q</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="accent-body">^</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 5.45289em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 5.95289em"><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em">N</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.938em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">a</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.383108em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em">N</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">(</span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.938em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">a</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.383108em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.938em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">a</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.383108em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em">N</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.938em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">a</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.383108em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.10903em">N</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.94677em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">Q</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="accent-body">^</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.305331em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.94677em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">Q</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="accent-body">^</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.305331em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em">N</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.938em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">a</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.383108em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.94677em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">Q</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="accent-body">^</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.305331em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord">.</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 5.45289em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 从结果来看，我们可以每增加一个样本，Q迭代一次，因为N是超参数，我们可以直接将1/N整体替换为<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        α
       
      
      
       alpha
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span></span></span></span></span>为作为新的超参数<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          Q
         
         
          
           t
          
          
           +
          
          
           1
          
         
        
        
         (
        
        
         s
        
        
         ,
        
        
         a
        
        
         )
        
        
         =
        
        
         
          Q
         
         
          t
         
        
        
         (
        
        
         s
        
        
         ,
        
        
         a
        
        
         )
        
        
         +
        
        
         α
        
        
         
          (
         
         
          G
         
         
          
           (
          
          
           
            τ
           
           
            
             
              s
             
             
              0
             
            
            
             =
            
            
             s
            
            
             ,
            
            
             
              a
             
             
              0
             
            
            
             =
            
            
             a
            
           
           
            
             (
            
            
             N
            
            
             )
            
           
          
          
           )
          
         
         
          −
         
         
          
           
            Q
           
           
            ^
           
          
          
           
            N
           
           
            −
           
           
            1
           
          
          
           π
          
         
         
          (
         
         
          s
         
         
          ,
         
         
          a
         
         
          )
         
         
          )
         
        
       
       
         Q_{t+1}(s,a) = Q_t(s,a) + alpha left(Gleft(tau_{s_{0}=s, a_{0}=a}^{(N)} right)-hat{Q}_{N-1}^{pi}(s, a)right) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1.80002em;vertical-align: -0.65002em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.938em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">a</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.383108em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.94677em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">Q</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="accent-body">^</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.305331em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span></span></span></span></span></span></p> 
<h4>
<a id="_298"></a>蒙特卡罗+策略迭代</h4> 
<p>假如我们把蒙特卡罗方法与策略迭代相结合，即将价值函数的计算部分用蒙特卡罗方法代替。另外我们这里用的价值函数是Q(s,a)不是V(s)，因为其实我们更新策略需要的是Q，V的作用不大。</p> 
<ul>
<li> <p>随机初始化策略</p> </li>
<li> <p>循环</p> 
  <ul>
<li>策略评估 
    <ul>
<li>遍历每一个<span class="katex--inline"><span class="katex"><span class="katex-mathml">
         
          
           
            
             s
            
           
           
            s
           
          
         </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault">s</span></span></span></span></span>，遍历每一个<span class="katex--inline"><span class="katex"><span class="katex-mathml">
         
          
           
            
             a
            
           
           
            a
           
          
         </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault">a</span></span></span></span></span>
</li>
<li>非增量形式：以<span class="katex--inline"><span class="katex"><span class="katex-mathml">
         
          
           
            
             s
            
            
             ,
            
            
             a
            
           
           
            s,a
           
          
         </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em;vertical-align: -0.19444em"></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span></span></span></span></span>作为初始状态和动作，然后根据策略采样N条轨迹，计算平均回报作为<span class="katex--inline"><span class="katex"><span class="katex-mathml">
         
          
           
            
             Q
            
            
             (
            
            
             s
            
            
             ,
            
            
             a
            
            
             )
            
           
           
            Q(s,a)
           
          
         </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">Q</span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span>
</li>
<li>增量形式： 
      <ul>
<li>随机初始化Q价值</li>
<li>循环直到收敛</li>
<li>以<span class="katex--inline"><span class="katex"><span class="katex-mathml">
           
            
             
              
               s
              
              
               ,
              
              
               a
              
             
             
              s,a
             
            
           </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em;vertical-align: -0.19444em"></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span></span></span></span></span>作为初始状态和动作，然后根据策略采样1条轨迹</li>
<li><span class="katex--inline"><span class="katex"><span class="katex-mathml">
           
            
             
              
               
                Q
               
               
                
                 t
                
                
                 +
                
                
                 1
                
               
              
              
               (
              
              
               s
              
              
               ,
              
              
               a
              
              
               )
              
              
               =
              
              
               
                Q
               
               
                t
               
              
              
               (
              
              
               s
              
              
               ,
              
              
               a
              
              
               )
              
              
               +
              
              
               α
              
              
               
                (
               
               
                G
               
               
                
                 (
                
                
                 
                  τ
                 
                 
                  
                   
                    s
                   
                   
                    0
                   
                  
                  
                   =
                  
                  
                   s
                  
                  
                   ,
                  
                  
                   
                    a
                   
                   
                    0
                   
                  
                  
                   =
                  
                  
                   a
                  
                 
                 
                  
                   (
                  
                  
                   N
                  
                  
                   )
                  
                 
                
                
                 )
                
               
               
                −
               
               
                
                 
                  Q
                 
                 
                  ^
                 
                
                
                 
                  N
                 
                 
                  −
                 
                 
                  1
                 
                
                
                 π
                
               
               
                (
               
               
                s
               
               
                ,
               
               
                a
               
               
                )
               
               
                )
               
              
             
             
              Q_{t+1}(s,a) = Q_t(s,a) + alpha left(Gleft(tau_{s_{0}=s, a_{0}=a}^{(N)} right)-hat{Q}_{N-1}^{pi}(s, a)right)
             
            
           </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1.80002em;vertical-align: -0.65002em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">a</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2527em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.94677em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">Q</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="accent-body">^</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.333662em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span></span></span></span></span></li>
</ul> </li>
</ul> </li>
<li>策略改进 
    <ul><li>根据<span class="katex--inline"><span class="katex"><span class="katex-mathml">
         
          
           
            
             π
            
            
             =
            
            
             a
            
            
             r
            
            
             g
            
            
             m
            
            
             a
            
            
             
              x
             
             
              a
             
            
            
             Q
            
            
             (
            
            
             s
            
            
             ,
            
            
             a
            
            
             )
            
           
           
            pi = argmax_aQ(s,a)
           
          
         </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mord mathdefault" style="margin-right: 0.03588em">g</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord mathdefault">Q</span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span>更新<span class="katex--inline"><span class="katex"><span class="katex-mathml">
         
          
           
            
             π
            
           
           
            pi
           
          
         </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span></span></span></span></span>
</li></ul> </li>
</ul> </li>
<li> <p>直到收敛</p> </li>
</ul> 
<h4>
<a id="_317"></a>蒙特卡罗+值迭代</h4> 
<p>之所以迭代式中没有max，是因为max体现在直接使用Q函数进行采样的过程中，其实跟蒙特卡罗+策略迭代的方式是等价的，除了采样次数或增量迭代的次数之外。</p> 
<ul>
<li>随机初始化Q价值函数</li>
<li>循环 
  <ul>
<li>遍历每一个s，遍历每一个a</li>
<li>以<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           s
          
          
           ,
          
          
           a
          
         
         
          s,a
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em;vertical-align: -0.19444em"></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span></span></span></span></span>作为初始状态和动作，根据价值函数采样1条轨迹<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           (
          
          
           a
          
          
           =
          
          
           a
          
          
           r
          
          
           g
          
          
           m
          
          
           a
          
          
           
            x
           
           
            a
           
          
          
           Q
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
          
           )
          
         
         
          left( a=argmax_aQ(s,a)right)
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mord mathdefault" style="margin-right: 0.03588em">g</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord mathdefault">Q</span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose delimcenter">)</span></span></span></span></span></span>
</li>
<li>只有增量形式：<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            Q
           
           
            
             t
            
            
             +
            
            
             1
            
           
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
          
           =
          
          
           
            Q
           
           
            t
           
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
          
           +
          
          
           α
          
          
           
            (
           
           
            G
           
           
            
             (
            
            
             
              τ
             
             
              
               
                s
               
               
                0
               
              
              
               =
              
              
               s
              
              
               ,
              
              
               
                a
               
               
                0
               
              
              
               =
              
              
               a
              
             
             
            
            
             )
            
           
           
            −
           
           
            
             
              Q
             
             
              ^
             
            
            
             t
            
            
             π
            
           
           
            (
           
           
            s
           
           
            ,
           
           
            a
           
           
            )
           
           
            )
           
          
         
         
          Q_{t+1}(s,a) = Q_t(s,a) + alpha left(Gleft(tau_{s_{0}=s, a_{0}=a}^{} right)-hat{Q}_{t}^{pi}(s, a)right)
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1.80002em;vertical-align: -0.65002em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.363em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">a</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.383108em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.94677em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault">Q</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="accent-body">^</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.19444em"><span class=""></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span></span></span></span></span>
</li>
</ul> </li>
<li>直到Q收敛</li>
</ul> 
<h3>
<a id="_328"></a>时序差分方法</h3> 
<p>前面我们用蒙特卡罗对策略迭代和值迭代做了初步的结合或改进以应对模型未知的情况，但是我们发现即便是采用值迭代的算法，每次迭代都至少需要SxA次采样，并且每次采样都是一条完整的轨迹。事实上我们会发现，策略迭代和值迭代都是利用一次状态转移进行训练的。所以说，蒙特卡罗与动态规划的结合的潜力还没有被挖掘完全。</p> 
<p>根据增量迭代公式<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              Q
             
             
              
               t
              
              
               +
              
              
               1
              
             
             
              π
             
            
            
             (
            
            
             s
            
            
             ,
            
            
             a
            
            
             )
            
           
          
         
         
          
           
            
            
             =
            
            
             
              Q
             
             
              t
             
             
              π
             
            
            
             (
            
            
             s
            
            
             ,
            
            
             a
            
            
             )
            
            
             +
            
            
             α
            
            
             
              (
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 
                  s
                 
                 
                  0
                 
                
                
                 =
                
                
                 s
                
                
                 ,
                
                
                 
                  a
                 
                 
                  0
                 
                
                
                 =
                
                
                 a
                
               
               
              
              
               )
              
             
             
              −
             
             
              
               Q
              
              
               t
              
              
               π
              
             
             
              (
             
             
              s
             
             
              ,
             
             
              a
             
             
              )
             
             
              )
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              Q
             
             
              t
             
             
              π
             
            
            
             (
            
            
             s
            
            
             ,
            
            
             a
            
            
             )
            
            
             +
            
            
             α
            
            
             
              (
             
             
              r
             
             
              +
             
             
              γ
             
             
              ∗
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 
                  s
                 
                 
                  0
                 
                
                
                 =
                
                
                 s
                
                
                 ,
                
                
                 
                  a
                 
                 
                  0
                 
                
                
                 =
                
                
                 a
                
                
                 ,
                
                
                 
                  s
                 
                 
                  1
                 
                
                
                 =
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 ,
                
                
                 
                  a
                 
                 
                  1
                 
                
                
                 =
                
                
                 
                  a
                 
                 
                  ′
                 
                
               
               
              
              
               )
              
             
             
              −
             
             
              
               Q
              
              
               t
              
              
               π
              
             
             
              (
             
             
              s
             
             
              ,
             
             
              a
             
             
              )
             
             
              )
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              Q
             
             
              t
             
             
              π
             
            
            
             (
            
            
             s
            
            
             ,
            
            
             a
            
            
             )
            
            
             +
            
            
             α
            
            
             
              (
             
             
              r
             
             
              +
             
             
              γ
             
             
              ∗
             
             
              
               Q
              
              
               t
              
              
               π
              
             
             
              (
             
             
              
               s
              
              
               ′
              
             
             
              ,
             
             
              
               a
              
              
               ′
              
             
             
              )
             
             
              −
             
             
              
               Q
              
              
               t
              
              
               π
              
             
             
              (
             
             
              s
             
             
              ,
             
             
              a
             
             
              )
             
             
              )
             
            
           
          
         
        
       
       
         begin{aligned} Q_{t+1}^pi(s,a) &amp;= Q_t^pi(s,a) + alpha left(Gleft(tau_{s_{0}=s, a_{0}=a}^{} right)-{Q}_{t}^{pi}(s, a)right)\ &amp;=Q_t^pi(s,a) + alpha left(r+gamma*Gleft(tau_{s_{0}=s, a_{0}=a,s_1=s^prime,a_1=a^prime}^{} right)-{Q}_{t}^{pi}(s, a)right) \ &amp;= Q_t^pi(s,a)+alpha left(r+gamma*Q_t^pi(s^prime,a^prime)-{Q}_{t}^{pi}(s, a)right) end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 4.56622em;vertical-align: -2.03311em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.53311em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.305331em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.03311em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.53311em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.413em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">a</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.383108em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size1">)</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.413em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">a</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.682829em"><span class="" style="margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.317314em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.682829em"><span class="" style="margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.383108em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size1">)</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.801892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.801892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose delimcenter">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.03311em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 于是我们最终得到下面的迭代式<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          Q
         
         
          
           t
          
          
           +
          
          
           1
          
         
         
          π
         
        
        
         (
        
        
         s
        
        
         ,
        
        
         a
        
        
         )
        
        
         =
        
        
         
          Q
         
         
          t
         
         
          π
         
        
        
         (
        
        
         s
        
        
         ,
        
        
         a
        
        
         )
        
        
         +
        
        
         α
        
        
         
          (
         
         
          r
         
         
          +
         
         
          γ
         
         
          ∗
         
         
          
           Q
          
          
           t
          
          
           π
          
         
         
          (
         
         
          
           s
          
          
           ′
          
         
         
          ,
         
         
          
           a
          
          
           ′
          
         
         
          )
         
         
          −
         
         
          
           Q
          
          
           t
          
          
           π
          
         
         
          (
         
         
          s
         
         
          ,
         
         
          a
         
         
          )
         
         
          )
         
        
       
       
         Q_{t+1}^pi(s,a) = Q_t^pi(s,a)+alpha left(r+gamma*Q_t^pi(s^prime,a^prime)-{Q}_{t}^{pi}(s, a)right) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.05533em;vertical-align: -0.305331em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.305331em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span></span><span class="base"><span class="strut" style="height: 1.05189em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.801892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.801892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.714392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose delimcenter">)</span></span></span></span></span></span></span><br> 这个迭代式中<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         Q
        
        
         
          t
         
         
          +
         
         
          1
         
        
        
         π
        
       
       
        (
       
       
        s
       
       
        ,
       
       
        a
       
       
        )
       
      
      
       Q_{t+1}^pi(s,a)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.05644em;vertical-align: -0.306439em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.306439em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         Q
        
        
         t
        
        
         π
        
       
       
        (
       
       
        s
       
       
        ,
       
       
        a
       
       
        )
       
      
      
       Q_t^pi(s,a)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span></span>是迭代前后的价值函数的值，涉及的数据也是只包括一次状态转移的<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        s
       
       
        ,
       
       
        a
       
       
        ,
       
       
        r
       
       
        ,
       
       
        
         s
        
        
         ′
        
       
       
        ,
       
       
        
         a
        
        
         ′
        
       
      
      
       s,a,r,s^prime,a^prime
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.946332em;vertical-align: -0.19444em"></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>。然而，我们同时也能注意到，迭代式的右边的更新的部分除了Q(s,a)本身，还包括了<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        Q
       
       
        (
       
       
        
         s
        
        
         ′
        
       
       
        ,
       
       
        
         a
        
        
         ′
        
       
       
        )
       
      
      
       Q(s^prime,a^prime)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.00189em;vertical-align: -0.25em"></span><span class="mord mathdefault">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，我们可以想到它的迭代是不稳定的，后面会有针对这部分的改进，这是后话了</p> 
<p>这个式子也可以换个思路得到，根据Q函数的贝尔曼方程<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              
               
                Q
               
               
                π
               
              
              
               (
              
              
               s
              
              
               ,
              
              
               a
              
              
               )
              
             
            
           
           
            
             
              
              
               =
              
              
               
                E
               
               
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 ∼
                
                
                 p
                
                
                 
                  (
                 
                 
                  
                   s
                  
                  
                   ′
                  
                 
                 
                  ∣
                 
                 
                  s
                 
                 
                  ,
                 
                 
                  a
                 
                 
                  )
                 
                
               
              
              
               
                [
               
               
                r
               
               
                
                 (
                
                
                 s
                
                
                 ,
                
                
                 a
                
                
                 ,
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 )
                
               
               
                +
               
               
                γ
               
               
                
                 Q
                
                
                 π
                
               
               
                (
               
               
                
                 s
                
                
                 ′
                
               
               
                ,
               
               
                
                 a
                
                
                 ′
                
               
               
                )
               
               
                ]
               
              
              
               ,
              
              
               
                a
               
               
                ′
               
              
              
               =
              
              
               π
              
              
               (
              
              
               
                s
               
               
                ′
               
              
              
               )
              
             
            
           
          
         
        
       
       
         {large begin{aligned} Q^pi(s,a) &amp;= mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)}left[rleft(s, a, s^{prime}right)+gamma Q^pi(s^prime,a^prime)right],a^prime = pi(s^prime) end{aligned}} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.95424em;vertical-align: -0.67712em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.06427em"><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.564267em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.06427em"><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size6 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">a</span><span class="mclose sizing reset-size4 size6 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.488533em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">[</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">]</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.564267em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></span><br> 蒙特卡罗的方法本质上是经验分布近似期望，而跟具体的应用无关。我们完全可以用采样的方式近似在转移分布上的期望。</p> 
<p>显然，我们需要采样的数据包括<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        s
       
       
        ,
       
       
        a
       
       
        ,
       
       
        r
       
       
        ,
       
       
        
         s
        
        
         ′
        
       
      
      
       s,a,r,s^prime
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.946332em;vertical-align: -0.19444em"></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.751892em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>，我们把这样一组数据叫做一个Transition。于是<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              
               
                Q
               
               
                π
               
              
              
               (
              
              
               s
              
              
               ,
              
              
               a
              
              
               )
              
             
            
           
           
            
             
              
              
               =
              
              
               
                1
               
               
                N
               
              
              
               
                ∑
               
               
                
                 n
                
                
                 =
                
                
                 1
                
               
               
                N
               
              
              
               r
              
              
               
                (
               
               
                s
               
               
                ,
               
               
                a
               
               
                ,
               
               
                
                 s
                
                
                 ′
                
               
               
                )
               
              
              
               +
              
              
               γ
              
              
               
                Q
               
               
                π
               
              
              
               (
              
              
               
                s
               
               
                ′
               
              
              
               ,
              
              
               
                a
               
               
                ′
               
              
              
               )
              
             
            
           
          
          
           
            
             
            
           
           
            
             
              
              
               =
              
              
               
                Q
               
               
                π
               
              
              
               (
              
              
               s
              
              
               ,
              
              
               a
              
              
               )
              
              
               +
              
              
               
                1
               
               
                N
               
              
              
               (
              
              
               r
              
              
               
                (
               
               
                s
               
               
                ,
               
               
                a
               
               
                ,
               
               
                
                 s
                
                
                 ′
                
               
               
                )
               
              
              
               +
              
              
               γ
              
              
               
                Q
               
               
                π
               
              
              
               (
              
              
               
                s
               
               
                ′
               
              
              
               ,
              
              
               
                a
               
               
                ′
               
              
              
               )
              
              
               −
              
              
               
                Q
               
               
                π
               
              
              
               (
              
              
               s
              
              
               ,
              
              
               a
              
              
               )
              
              
               )
              
             
            
           
          
         
        
       
       
         {large begin{aligned} Q^pi(s,a) &amp;= frac{1}{N}sum_{n=1}^{N}rleft(s, a, s^{prime}right)+gamma Q^pi(s^prime,a^prime) \ &amp;= Q^pi(s,a)+frac{1}{N}(rleft(s, a, s^{prime}right)+gamma Q^pi(s^prime,a^prime)-Q^pi(s,a)) end{aligned}} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 6.7956em;vertical-align: -3.0978em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.0815em"><span class=""><span class="pstrut" style="height: 3.80556em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span><span class=""><span class="pstrut" style="height: 3.80556em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.5815em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.0815em"><span class=""><span class="pstrut" style="height: 3.80556em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em"><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em">N</span></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size7 size6"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.80556em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.2em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.2em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25001em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span class=""><span class="pstrut" style="height: 3.80556em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mopen nulldelimiter sizing reset-size7 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em"><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em">N</span></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3.2em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size7 size6"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.5815em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></span><br> 同样，将1/N用<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        α
       
      
      
       alpha
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span></span></span></span></span>替代后，<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            Q
           
           
            
             t
            
            
             +
            
            
             1
            
           
           
            π
           
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
          
           =
          
          
           
            Q
           
           
            t
           
           
            π
           
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
          
           +
          
          
           α
          
          
           
            (
           
           
            r
           
           
            +
           
           
            γ
           
           
            ∗
           
           
            
             Q
            
            
             t
            
            
             π
            
           
           
            (
           
           
            
             s
            
            
             ′
            
           
           
            ,
           
           
            
             a
            
            
             ′
            
           
           
            )
           
           
            −
           
           
            
             Q
            
            
             t
            
            
             π
            
           
           
            (
           
           
            s
           
           
            ,
           
           
            a
           
           
            )
           
           
            )
           
          
         
        
       
       
         large{Q_{t+1}^pi(s,a) = Q_t^pi(s,a)+alpha left(r+gamma*Q_t^pi(s^prime,a^prime)-{Q}_{t}^{pi}(s, a)right)} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.30311em;vertical-align: -0.363064em"></span><span class="mord sizing reset-size6 size7"><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.302553em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span></span></span></span></span></span></span><br> 在得到上述迭代式后，我们可以重新考虑蒙特卡罗与策略迭代和值迭代结合的方式，从而衍生出两个新的算法:Sarsa和Q Learning</p> 
<h4>
<a id="Sarsa_367"></a>Sarsa</h4> 
<p>总体上，Sarsa = 蒙特卡罗+策略迭代+时序差分</p> 
<p>细节上稍微有些区别</p> 
<p><img src="https://images2.imgbox.com/9f/1c/S225ZW5R_o.png" alt="在这里插入图片描述" width="450"></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         (
        
        
         请
        
        
         暂
        
        
         时
        
        
         忽
        
        
         略
        
        
         掉
        
        
         算
        
        
         法
        
        
         中
        
        
         出
        
        
         现
        
        
         的
        
        
         ϵ
        
        
         )
        
       
       
         (请暂时忽略掉算法中出现的epsilon) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord cjk_fallback">请</span><span class="mord cjk_fallback">暂</span><span class="mord cjk_fallback">时</span><span class="mord cjk_fallback">忽</span><span class="mord cjk_fallback">略</span><span class="mord cjk_fallback">掉</span><span class="mord cjk_fallback">算</span><span class="mord cjk_fallback">法</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">出</span><span class="mord cjk_fallback">现</span><span class="mord cjk_fallback">的</span><span class="mord mathdefault">ϵ</span><span class="mclose">)</span></span></span></span></span></span><br> 第七行对应的就是策略评估的过程，但是只迭代了一次，这样一来，似乎如果值迭代也是正常改进的话，二者可能就完全相同了。</p> 
<h4>
<a id="Q_Learning_380"></a>Q Learning</h4> 
<p>Q Learning = 蒙特卡罗+值迭代+时序差分</p> 
<p>在应用了值迭代（最优策略）的思想后，迭代式修改如下<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            Q
           
           
            
             t
            
            
             +
            
            
             1
            
           
           
            π
           
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
          
           =
          
          
           
            Q
           
           
            t
           
           
            π
           
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           )
          
          
           +
          
          
           α
          
          
           
            (
           
           
            r
           
           
            +
           
           
            γ
           
           
            
             
              max
             
             
              ⁡
             
            
            
             
              a
             
             
              ′
             
            
           
           
            
             Q
            
            
             t
            
            
             π
            
           
           
            (
           
           
            
             s
            
            
             ′
            
           
           
            ,
           
           
            
             a
            
            
             ′
            
           
           
            )
           
           
            −
           
           
            
             Q
            
            
             t
            
            
             π
            
           
           
            (
           
           
            s
           
           
            ,
           
           
            a
           
           
            )
           
           
            )
           
          
         
        
       
       
         large{Q_{t+1}^pi(s,a) = Q_t^pi(s,a)+alpha left(r+gamma max_{a^prime}Q_t^pi(s^prime,a^prime)-{Q}_{t}^{pi}(s, a)right)} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.40003em;vertical-align: -0.89003em"></span><span class="mord sizing reset-size6 size7"><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.302553em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size3">(</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.43056em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span><span class=""><span class="pstrut" style="height: 2.8em"></span><span class=""><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.734447em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-left: 0em;margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight">t</span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size3">)</span></span></span></span></span></span></span></span></span><br> 我简单解释一下为什么这么加一个max</p> 
<p>值迭代中<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              
               
                Q
               
               
                π
               
              
              
               (
              
              
               s
              
              
               ,
              
              
               a
              
              
               )
              
             
            
           
           
            
             
              
              
               =
              
              
               
                E
               
               
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 ∼
                
                
                 p
                
                
                 
                  (
                 
                 
                  
                   s
                  
                  
                   ′
                  
                 
                 
                  ∣
                 
                 
                  s
                 
                 
                  ,
                 
                 
                  a
                 
                 
                  )
                 
                
               
              
              
               
                [
               
               
                r
               
               
                
                 (
                
                
                 s
                
                
                 ,
                
                
                 a
                
                
                 ,
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 )
                
               
               
                +
               
               
                γ
               
               
                
                 V
                
                
                 π
                
               
               
                (
               
               
                
                 s
                
                
                 ′
                
               
               
                )
               
               
                ]
               
              
             
            
           
          
          
           
            
             
            
           
           
            
             
              
              
               =
              
              
               
                E
               
               
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 ∼
                
                
                 p
                
                
                 
                  (
                 
                 
                  
                   s
                  
                  
                   ′
                  
                 
                 
                  ∣
                 
                 
                  s
                 
                 
                  ,
                 
                 
                  a
                 
                 
                  )
                 
                
               
              
              
               
                [
               
               
                r
               
               
                
                 (
                
                
                 s
                
                
                 ,
                
                
                 a
                
                
                 ,
                
                
                 
                  s
                 
                 
                  ′
                 
                
                
                 )
                
               
               
                +
               
               
                γ
               
               
                
                 
                  max
                 
                 
                  ⁡
                 
                
                
                 
                  a
                 
                 
                  ′
                 
                
               
               
                
                 Q
                
                
                 π
                
               
               
                (
               
               
                
                 s
                
                
                 ′
                
               
               
                ,
               
               
                
                 a
                
                
                 ′
                
               
               
                )
               
               
                ]
               
              
             
            
           
          
         
        
       
       
         {large begin{aligned} Q^pi(s,a) &amp;= mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)}left[rleft(s, a, s^{prime}right)+gamma V^pi(s^prime)right] \ &amp;=mathbb{E}_{s^{prime} sim pleft(s^{prime} mid s, aright)}left[rleft(s, a, s^{prime}right)+gamma max_{a^prime} Q^pi(s^prime,a^prime)right] end{aligned}} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 4.71427em;vertical-align: -2.05713em"></span><span class="mord"><span class="mord sizing reset-size6 size7"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.21428em"><span class=""><span class="pstrut" style="height: 3.25833em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span><span class=""><span class="pstrut" style="height: 3.25833em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.71428em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.21428em"><span class=""><span class="pstrut" style="height: 3.25833em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size6 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">a</span><span class="mclose sizing reset-size4 size6 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.488533em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">[</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.25833em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∼</span><span class="mord mathdefault mtight">p</span><span class="minner mtight"><span class="mopen sizing reset-size4 size6 mtight delimcenter"><span class="mtight">(</span></span><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∣</span><span class="mord mathdefault mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">a</span><span class="mclose sizing reset-size4 size6 mtight delimcenter"><span class="mtight">)</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.488533em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size3">[</span></span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.43056em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70267em"><span class="" style="margin-right: 0.0625em"><span class="pstrut" style="height: 2.6em"></span><span class="sizing reset-size4 size2 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span><span class=""><span class="pstrut" style="height: 2.8em"></span><span class=""><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.734447em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.70004em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.783373em"><span class="" style="margin-right: 0.0416667em"><span class="pstrut" style="height: 2.8em"></span><span class="sizing reset-size7 size4 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose sizing reset-size7 size6 delimcenter"><span class="delimsizing size3">]</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.71428em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></span><br> 这个式子应用蒙特卡罗方法推倒下去就会出现带max的结果</p> 
<p><img src="https://images2.imgbox.com/28/86/uXwlZskY_o.png" alt="在这里插入图片描述" width="450"></p> 
<h3>
<a id="_402"></a>补充</h3> 
<h4>
<a id="epsilon_404"></a><span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        ϵ
       
      
      
       epsilon
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault">ϵ</span></span></span></span></span>贪心法</h4> 
<p>我们现在来把之前留的<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        ϵ
       
      
      
       epsilon
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault">ϵ</span></span></span></span></span>的坑填一下。</p> 
<p>我们前面介绍的算法通常是基于确定性策略的，如此，我们使用该策略进行采样时，可能没办法采样到更多可能的轨迹。对于策略迭代都还好，毕竟策略每一轮都在迭代，每次采样的轨迹很可能不同，但是对于值迭代来说，这就是致命的问题，因为值迭代的行为策略没有更新过，所以每次采样出来的轨迹有可能完全相同。</p> 
<p>所以，为了增强对环境的探索能力，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        ϵ
       
      
      
       epsilon
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault">ϵ</span></span></span></span></span>贪心法如下</p> 
<p><img src="https://images2.imgbox.com/ac/4a/TwrJsVYd_o.png" alt="在这里插入图片描述" width="400"></p> 
<p>这样一来，将行为策略转化为随机性策略，同时又不影响目标策略</p> 
<h4>
<a id="_417"></a>同策略与异策略</h4> 
<p>我们前面介绍了SARSA算法和Q学习算法，有提到说SARSA是一种同策略的算法，而Q Learning是异策略的算法。那么同策略和异策略呢？</p> 
<p>在强化学习的算法中，我们通常会涉及到两种策略，一种是行为策略，一种是目标策略。行为策略就是我们通过采样获得训练数据时使用的采样策略。而目标策略则是在用采样的数据进行训练的过程中所使用的策略。</p> 
<p>所谓的同策略(On-Policy)即行为策略与目标策略一致，反之即为异策略(Off-Policy)</p> 
<p>SARSA算法采样的时候是使用<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         π
        
        
         ϵ
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       pi^epsilon(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">ϵ</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>策略，而在训练过程中更新的也是该策略，所以SARSA是一个同策略算法。</p> 
<p>Q Learning采样的时候使用<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         π
        
        
         ϵ
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       pi^epsilon(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">ϵ</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>，而训练过程中从来没有更新过<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         π
        
        
         ϵ
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       pi^epsilon(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">ϵ</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>，而是生成了临时的最优策略用于计算Q函数，所以Q Learning是异策略的算法</p> 
<h3>
<a id="_429"></a>策略梯度</h3> 
<p>前面介绍的SARSA和Q Learning都是基于值函数的优化算法，我之前提到过，要求得策略，除了前面介绍的算法外，另一个是将<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        π
       
      
      
       pi
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.03588em">π</span></span></span></span></span>参数化成<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         π
        
        
         θ
        
       
       
        (
       
       
        a
       
       
        ∣
       
       
        s
       
       
        )
       
      
      
       pi_theta(a|s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord">∣</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>，我们通过计算期望回报对<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        θ
       
      
      
       theta
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span></span></span>的梯度从而使用梯度下降的算法优化<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        θ
       
      
      
       theta
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span></span></span>，这种方法叫做策略梯度。</p> 
<p>我们的目标函数是期望回报，那么</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              ∂
             
             
              J
             
             
              (
             
             
              θ
             
             
              )
             
            
            
             
              ∂
             
             
              θ
             
            
           
          
         
         
          
           
            
            
             =
            
            
             
              ∂
             
             
              
               ∂
              
              
               θ
              
             
            
            
             ∫
            
            
             
              p
             
             
              θ
             
            
            
             (
            
            
             τ
            
            
             )
            
            
             G
            
            
             (
            
            
             τ
            
            
             )
            
            
             d
            
            
             τ
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             ∫
            
            
             
              (
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              
               p
              
              
               θ
              
             
             
              (
             
             
              τ
             
             
              )
             
             
              )
             
            
            
             G
            
            
             (
            
            
             τ
            
            
             )
            
            
             d
            
            
             τ
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             ∫
            
            
             
              p
             
             
              θ
             
            
            
             (
            
            
             τ
            
            
             )
            
            
             
              (
             
             
              
               1
              
              
               
                
                 p
                
                
                 θ
                
               
               
                (
               
               
                τ
               
               
                )
               
              
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              
               p
              
              
               θ
              
             
             
              (
             
             
              τ
             
             
              )
             
             
              )
             
            
            
             G
            
            
             (
            
            
             τ
            
            
             )
            
            
             d
            
            
             τ
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             ∫
            
            
             
              p
             
             
              θ
             
            
            
             (
            
            
             τ
            
            
             )
            
            
             
              (
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               p
              
              
               θ
              
             
             
              (
             
             
              τ
             
             
              )
             
             
              )
             
            
            
             G
            
            
             (
            
            
             τ
            
            
             )
            
            
             d
            
            
             τ
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              E
             
             
              
               τ
              
              
               ∼
              
              
               
                p
               
               
                θ
               
              
              
               (
              
              
               τ
              
              
               )
              
             
            
            
             
              [
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               p
              
              
               θ
              
             
             
              (
             
             
              τ
             
             
              )
             
             
              G
             
             
              (
             
             
              τ
             
             
              )
             
             
              ]
             
            
            
             ,
            
           
          
         
        
       
       
         begin{aligned} frac{partial mathcal{J}(theta)}{partial theta} &amp;=frac{partial}{partial theta} int p_{theta}(tau) G(tau) mathrm{d} tau \ &amp;=intleft(frac{partial}{partial theta} p_{theta}(tau)right) G(tau) mathrm{d} tau \ &amp;=int p_{theta}(tau)left(frac{1}{p_{theta}(tau)} frac{partial}{partial theta} p_{theta}(tau)right) G(tau) mathrm{d} tau \ &amp;=int p_{theta}(tau)left(frac{partial}{partial theta} log p_{theta}(tau)right) G(tau) mathrm{d} tau \ &amp;=mathbb{E}_{tau sim p_{theta}(tau)}left[frac{partial}{partial theta} log p_{theta}(tau) G(tau)right], end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 13.3894em;vertical-align: -6.44468em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 6.94468em"><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord"><span class="mord mathcal" style="margin-right: 0.18472em">J</span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 6.44468em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 6.94468em"><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-symbol large-op" style="margin-right: 0.44445em">∫</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mop op-symbol large-op" style="margin-right: 0.44445em">∫</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mop op-symbol large-op" style="margin-right: 0.44445em">∫</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mop op-symbol large-op" style="margin-right: 0.44445em">∫</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.151229em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 6.44468em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             ∂
            
            
             
              ∂
             
             
              θ
             
            
           
          
         
         
          
           
            
            
             log
            
            
             ⁡
            
            
             
              p
             
             
              θ
             
            
            
             (
            
            
             τ
            
            
             )
            
            
             =
            
            
             
              ∂
             
             
              
               ∂
              
              
               θ
              
             
            
            
             log
            
            
             ⁡
            
            
             
              (
             
             
              p
             
             
              
               (
              
              
               
                s
               
               
                0
               
              
              
               )
              
             
             
              
               ∏
              
              
               
                t
               
               
                =
               
               
                0
               
              
              
               
                T
               
               
                −
               
               
                1
               
              
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              p
             
             
              
               (
              
              
               
                s
               
               
                
                 t
                
                
                 +
                
                
                 1
                
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               ,
              
              
               
                a
               
               
                t
               
              
              
               )
              
             
             
              )
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              ∂
             
             
              
               ∂
              
              
               θ
              
             
            
            
             
              (
             
             
              log
             
             
              ⁡
             
             
              p
             
             
              
               (
              
              
               
                s
               
               
                0
               
              
              
               )
              
             
             
              +
             
             
              
               ∑
              
              
               
                t
               
               
                =
               
               
                0
               
              
              
               
                T
               
               
                −
               
               
                1
               
              
             
             
              log
             
             
              ⁡
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              +
             
             
              
               ∑
              
              
               
                t
               
               
                =
               
               
                0
               
              
              
               
                T
               
               
                −
               
               
                1
               
              
             
             
              log
             
             
              ⁡
             
             
              p
             
             
              
               (
              
              
               
                s
               
               
                
                 t
                
                
                 +
                
                
                 1
                
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               ,
              
              
               
                a
               
               
                t
               
              
              
               )
              
             
             
              )
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              ∑
             
             
              
               t
              
              
               =
              
              
               0
              
             
             
              
               T
              
              
               −
              
              
               1
              
             
            
            
             
              ∂
             
             
              
               ∂
              
              
               θ
              
             
            
            
             log
            
            
             ⁡
            
            
             
              π
             
             
              θ
             
            
            
             
              (
             
             
              
               a
              
              
               t
              
             
             
              ∣
             
             
              
               s
              
              
               t
              
             
             
              )
             
            
           
          
         
        
       
       
         begin{aligned} frac{partial}{partial theta} &amp; log p_{theta}(tau)=frac{partial}{partial theta} log left(pleft(s_{0}right) prod_{t=0}^{T-1} pi_{theta}left(a_{t} mid s_{t}right) pleft(s_{t+1} mid s_{t}, a_{t}right)right) \ &amp;=frac{partial}{partial theta}left(log pleft(s_{0}right)+sum_{t=0}^{T-1} log pi_{theta}left(a_{t} mid s_{t}right)+sum_{t=0}^{T-1} log pleft(s_{t+1} mid s_{t}, a_{t}right)right) \ &amp;=sum_{t=0}^{T-1} frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 10.1863em;vertical-align: -4.84317em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 5.34317em"><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.84317em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 5.34317em"><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">(</span></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∏</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size4">)</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">(</span></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.208331em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size4">)</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.84317em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              ∂
             
             
              J
             
             
              (
             
             
              θ
             
             
              )
             
            
            
             
              ∂
             
             
              θ
             
            
           
          
         
         
          
           
            
            
             =
            
            
             
              E
             
             
              
               τ
              
              
               ∼
              
              
               
                p
               
               
                θ
               
              
              
               (
              
              
               τ
              
              
               )
              
             
            
            
             
              [
             
             
              
               (
              
              
               
                ∑
               
               
                
                 t
                
                
                 =
                
                
                 0
                
               
               
                
                 T
                
                
                 −
                
                
                 1
                
               
              
              
               
                ∂
               
               
                
                 ∂
                
                
                 θ
                
               
              
              
               log
              
              
               ⁡
              
              
               
                π
               
               
                θ
               
              
              
               
                (
               
               
                
                 a
                
                
                 t
                
               
               
                ∣
               
               
                
                 s
                
                
                 t
                
               
               
                )
               
              
              
               )
              
             
             
              G
             
             
              (
             
             
              τ
             
             
              )
             
             
              ]
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              E
             
             
              
               τ
              
              
               ∼
              
              
               
                p
               
               
                θ
               
              
              
               (
              
              
               τ
              
              
               )
              
             
            
            
             
              [
             
             
              
               (
              
              
               
                ∑
               
               
                
                 t
                
                
                 =
                
                
                 0
                
               
               
                
                 T
                
                
                 −
                
                
                 1
                
               
              
              
               
                ∂
               
               
                
                 ∂
                
                
                 θ
                
               
              
              
               log
              
              
               ⁡
              
              
               
                π
               
               
                θ
               
              
              
               
                (
               
               
                
                 a
                
                
                 t
                
               
               
                ∣
               
               
                
                 s
                
                
                 t
                
               
               
                )
               
              
              
               )
              
             
             
              
               (
              
              
               G
              
              
               
                (
               
               
                
                 τ
                
                
                 
                  0
                 
                 
                  :
                 
                 
                  t
                 
                
               
               
                )
               
              
              
               +
              
              
               
                γ
               
               
                t
               
              
              
               G
              
              
               
                (
               
               
                
                 τ
                
                
                 
                  t
                 
                 
                  :
                 
                 
                  T
                 
                
               
               
                )
               
              
              
               )
              
             
             
              ]
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              E
             
             
              
               τ
              
              
               ∼
              
              
               
                p
               
               
                θ
               
              
              
               (
              
              
               τ
              
              
               )
              
             
            
            
             
              [
             
             
              
               ∑
              
              
               
                t
               
               
                =
               
               
                0
               
              
              
               
                T
               
               
                −
               
               
                1
               
              
             
             
              
               (
              
              
               
                ∂
               
               
                
                 ∂
                
                
                 θ
                
               
              
              
               log
              
              
               ⁡
              
              
               
                π
               
               
                θ
               
              
              
               
                (
               
               
                
                 a
                
                
                 t
                
               
               
                ∣
               
               
                
                 s
                
                
                 t
                
               
               
                )
               
              
              
               
                γ
               
               
                t
               
              
              
               G
              
              
               
                (
               
               
                
                 τ
                
                
                 
                  t
                 
                 
                  :
                 
                 
                  T
                 
                
               
               
                )
               
              
              
               )
              
             
             
              ]
             
            
           
          
         
        
       
       
         begin{aligned} frac{partial mathcal{J}(theta)}{partial theta} &amp;=mathbb{E}_{tau sim p_{theta}(tau)}left[left(sum_{t=0}^{T-1} frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right)right) G(tau)right] \ &amp;=mathbb{E}_{tau sim p_{theta}(tau)}left[left(sum_{t=0}^{T-1} frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right)right)left(Gleft(tau_{0: t}right)+gamma^{t} Gleft(tau_{t: T}right)right)right] \ &amp;=mathbb{E}_{tau sim p_{theta}(tau)}left[sum_{t=0}^{T-1}left(frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} Gleft(tau_{t: T}right)right)right] end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 10.1863em;vertical-align: -4.84317em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 5.34317em"><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord"><span class="mord mathcal" style="margin-right: 0.18472em">J</span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.84317em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 5.34317em"><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.151229em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">[</span></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size4">)</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size4">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.151229em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">[</span></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size4">)</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size1">)</span></span></span><span class="mclose delimcenter"><span class="delimsizing size4">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.151229em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">[</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">)</span></span></span><span class="mclose delimcenter"><span class="delimsizing size4">]</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.84317em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>公式(28)中从第二步到第三步省略了一个极其复杂的过程</p> 
<p>证明过程参考链接（待添加）</p> 
<p>最后，我们显然也是无法直接计算期望的，所以也可以采用蒙特卡罗法进行近似。<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           ∂
          
          
           J
          
          
           (
          
          
           θ
          
          
           )
          
         
         
          
           ∂
          
          
           θ
          
         
        
        
         ≈
        
        
         
          1
         
         
          N
         
        
        
         
          ∑
         
         
          
           n
          
          
           =
          
          
           1
          
         
         
          N
         
        
        
         
          (
         
         
          
           ∑
          
          
           
            t
           
           
            =
           
           
            0
           
          
          
           
            T
           
           
            −
           
           
            1
           
          
         
         
          
           ∂
          
          
           
            ∂
           
           
            θ
           
          
         
         
          log
         
         
          ⁡
         
         
          
           π
          
          
           θ
          
         
         
          
           (
          
          
           
            a
           
           
            t
           
           
            
             (
            
            
             n
            
            
             )
            
           
          
          
           ∣
          
          
           
            s
           
           
            t
           
           
            
             (
            
            
             n
            
            
             )
            
           
          
          
           )
          
         
         
          
           γ
          
          
           t
          
         
         
          
           G
          
          
           
            τ
           
           
            
             t
            
            
             :
            
            
             T
            
           
           
            
             (
            
            
             n
            
            
             )
            
           
          
         
         
          )
         
        
       
       
         frac{partial mathcal{J}(theta)}{partial theta} approx frac{1}{N} sum_{n=1}^{N}left(sum_{t=0}^{T-1} frac{partial}{partial theta} log pi_{theta}left(a_{t}^{(n)} mid s_{t}^{(n)}right) gamma^{t} G_{tau_{t: T}^{(n)}}right) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.113em;vertical-align: -0.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord"><span class="mord mathcal" style="margin-right: 0.18472em">J</span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 3.09545em;vertical-align: -1.26711em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.32144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10903em">N</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.10903em">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.245756em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.245756em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.74136em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05909em"><span class="" style="margin-left: -0.1132em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.53571em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span><span class="" style="margin-right: 0.0714286em"><span class="pstrut" style="height: 2.53571em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.339293em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.634065em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size4">)</span></span></span></span></span></span></span></span></p> 
<h4>
<a id="Reinforce_470"></a>Reinforce</h4> 
<p>结合随机梯度算法，将上式转化为增量形式即为Reinforce算法</p> 
<p><img src="https://images2.imgbox.com/02/22/AJt9pP0W_o.png" alt="在这里插入图片描述" width="450"></p> 
<h4>
<a id="Reinforce_With_Baseline_477"></a>Reinforce With Baseline</h4> 
<p>Reinforce有一个缺点是不同路径之间的方差很大，导致训练不稳定，这是在<strong>高维空间</strong>使用蒙特卡罗方法的通病。注意，这里明确了是高维空间，之前介绍的Sarsa和Q Learning也用了蒙特卡罗算法，但是他们只是对一个transition采样，所以问题不大，但是Reinforce是对整个轨迹采样，那么采样空间的维度就变得太高了，所以才会出现稳定性差的问题。</p> 
<p>那么如何解决呢？</p> 
<p>其实很简单，如下<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           ∂
          
          
           J
          
          
           (
          
          
           θ
          
          
           )
          
         
         
          
           ∂
          
          
           θ
          
         
        
        
         ≈
        
        
         
          ∑
         
         
          
           t
          
          
           =
          
          
           0
          
         
         
          
           T
          
          
           −
          
          
           1
          
         
        
        
         
          ∂
         
         
          
           ∂
          
          
           θ
          
         
        
        
         log
        
        
         ⁡
        
        
         
          π
         
         
          θ
         
        
        
         
          (
         
         
          
           a
          
          
           t
          
          
           
            (
           
           
            n
           
           
            )
           
          
         
         
          ∣
         
         
          
           s
          
          
           t
          
          
           
            (
           
           
            n
           
           
            )
           
          
         
         
          )
         
        
        
         
          γ
         
         
          t
         
        
        
         
          (
         
         
          
           G
          
          
           
            τ
           
           
            
             t
            
            
             :
            
            
             T
            
           
           
            
             (
            
            
             n
            
            
             )
            
           
          
         
         
          −
         
         
          
           V
          
          
           ϕ
          
         
         
          (
         
         
          
           s
          
          
           t
          
         
         
          )
         
         
          )
         
        
       
       
         frac{partial mathcal{J}(theta)}{partial theta} approx sum_{t=0}^{T-1} frac{partial}{partial theta} log pi_{theta}left(a_{t}^{(n)} mid s_{t}^{(n)}right) gamma^{t} left(G_{tau_{t: T}^{(n)}}-V_phi(s_t)right) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.113em;vertical-align: -0.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord"><span class="mord mathcal" style="margin-right: 0.18472em">J</span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 3.09545em;vertical-align: -1.26711em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.245756em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.245756em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.74136em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05909em"><span class="" style="margin-left: -0.1132em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.53571em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span><span class="" style="margin-right: 0.0714286em"><span class="pstrut" style="height: 2.53571em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.339293em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.634065em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.22222em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size2">)</span></span></span></span></span></span></span></span><br> 我们注意到，上式与Reinforce的差别仅仅是对G减去了一个V(st)，但是它的可行性和有效性的数学证明却不是一目了然的。</p> 
<p>我们可以证明，任意引入一个与at无关的b(st)，不改变期望形式的策略梯度。</p> 
<p>首先，<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              ∂
             
             
              J
             
             
              (
             
             
              θ
             
             
              )
             
            
            
             
              ∂
             
             
              θ
             
            
           
          
         
         
          
           
            
            
             =
            
            
             
              E
             
             
              
               τ
              
              
               ∼
              
              
               
                p
               
               
                θ
               
              
              
               (
              
              
               τ
              
              
               )
              
             
            
            
             
              [
             
             
              
               ∑
              
              
               
                t
               
               
                =
               
               
                0
               
              
              
               
                T
               
               
                −
               
               
                1
               
              
             
             
              
               (
              
              
               
                ∂
               
               
                
                 ∂
                
                
                 θ
                
               
              
              
               log
              
              
               ⁡
              
              
               
                π
               
               
                θ
               
              
              
               
                (
               
               
                
                 a
                
                
                 t
                
               
               
                ∣
               
               
                
                 s
                
                
                 t
                
               
               
                )
               
              
              
               
                γ
               
               
                t
               
              
              
               G
              
              
               
                (
               
               
                
                 τ
                
                
                 
                  t
                 
                 
                  :
                 
                 
                  T
                 
                
               
               
                )
               
              
              
               )
              
             
             
              ]
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              ∑
             
             
              
               t
              
              
               =
              
              
               0
              
             
             
              
               T
              
              
               −
              
              
               1
              
             
            
            
             
              E
             
             
              
               τ
              
              
               ∼
              
              
               
                p
               
               
                θ
               
              
              
               (
              
              
               τ
              
              
               )
              
             
            
            
             
              [
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              
               γ
              
              
               t
              
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 t
                
                
                 :
                
                
                 T
                
               
              
              
               )
              
             
             
              ]
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              ∑
             
             
              
               t
              
              
               =
              
              
               0
              
             
             
              
               T
              
              
               −
              
              
               1
              
             
            
            
             
              E
             
             
              
               s
              
              
               t
              
             
            
            
             
              E
             
             
              
               a
              
              
               t
              
             
            
            
             
              [
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              
               γ
              
              
               t
              
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 t
                
                
                 :
                
                
                 T
                
               
              
              
               )
              
             
             
              ]
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              ∑
             
             
              
               t
              
              
               =
              
              
               0
              
             
             
              
               T
              
              
               −
              
              
               1
              
             
            
            
             
              
               ∂
              
              
               
                J
               
               
                t
               
              
              
               (
              
              
               θ
              
              
               )
              
             
             
              
               ∂
              
              
               θ
              
             
            
           
          
         
        
       
       
         begin{aligned} frac{partial mathcal{J}(theta)}{partial theta} &amp;=mathbb{E}_{tau sim p_{theta}(tau)}left[sum_{t=0}^{T-1}left(frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} Gleft(tau_{t: T}right)right)right] \ &amp;=sum_{t=0}^{T-1}mathbb{E}_{tau sim p_{theta}(tau)}left[frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} Gleft(tau_{t: T}right)right] \ &amp;=sum_{t=0}^{T-1}mathbb{E}_{s_t}mathbb{E}_{a_t}left[frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} Gleft(tau_{t: T}right)right] \ &amp;=sum_{t=0}^{T-1}frac{partial mathcal{J}_{t}(theta)}{partial theta} end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 13.5818em;vertical-align: -6.5409em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 7.0409em"><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord"><span class="mord mathcal" style="margin-right: 0.18472em">J</span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 6.5409em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 7.0409em"><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.151229em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">[</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">)</span></span></span><span class="mclose delimcenter"><span class="delimsizing size4">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.151229em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right: 0.1132em">τ</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.82834em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.82834em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class=""><span class="pstrut" style="height: 3.05em"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.26711em"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right: 0.18472em">J</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 6.5409em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 其次，引入b(st)后，<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              ∂
             
             
              
               J
              
              
               t
              
             
             
              (
             
             
              θ
             
             
              )
             
            
            
             
              ∂
             
             
              θ
             
            
           
          
         
         
          
           
            
            
             =
            
            
             
              E
             
             
              
               s
              
              
               t
              
             
            
            
             
              E
             
             
              
               a
              
              
               t
              
             
            
            
             
              [
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              
               γ
              
              
               t
              
             
             
              
               (
              
              
               G
              
              
               
                (
               
               
                
                 τ
                
                
                 
                  t
                 
                 
                  :
                 
                 
                  T
                 
                
               
               
                )
               
              
              
               −
              
              
               b
              
              
               (
              
              
               
                s
               
               
                t
               
              
              
               )
              
              
               )
              
             
             
              ]
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              E
             
             
              
               s
              
              
               t
              
             
            
            
             
              E
             
             
              
               a
              
              
               t
              
             
            
            
             
              [
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              
               γ
              
              
               t
              
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 t
                
                
                 :
                
                
                 T
                
               
              
              
               )
              
             
             
              ]
             
            
            
             +
            
            
             
              E
             
             
              
               s
              
              
               t
              
             
            
            
             
              E
             
             
              
               a
              
              
               t
              
             
            
            
             
              [
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              
               γ
              
              
               t
              
             
             
              b
             
             
              (
             
             
              
               s
              
              
               t
              
             
             
              )
             
             
              ]
             
            
           
          
         
        
       
       
         begin{aligned} frac{partial mathcal{J}_{t}(theta)}{partial theta} &amp;=mathbb{E}_{s_t}mathbb{E}_{a_t}left[frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} left(Gleft(tau_{t: T}right)-b(s_t)right)right] \ &amp;=mathbb{E}_{s_t}mathbb{E}_{a_t}left[frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} Gleft(tau_{t: T}right)right]+mathbb{E}_{s_t}mathbb{E}_{a_t}left[frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} b(s_t)right] end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 5.40006em;vertical-align: -2.45003em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95003em"><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right: 0.18472em">J</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45003em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95003em"><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45003em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 其中，<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              E
             
             
              
               a
              
              
               t
              
             
            
            
             
              [
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              
               γ
              
              
               t
              
             
             
              b
             
             
              (
             
             
              
               s
              
              
               t
              
             
             
              )
             
             
              ]
             
            
           
          
         
         
          
           
            
            
             =
            
            
             b
            
            
             (
            
            
             
              s
             
             
              t
             
            
            
             )
            
            
             ∫
            
            
             
              π
             
             
              θ
             
            
            
             (
            
            
             
              a
             
             
              t
             
            
            
             ∣
            
            
             
              s
             
             
              t
             
            
            
             )
            
            
             
              ∂
             
             
              
               ∂
              
              
               θ
              
             
            
            
             log
            
            
             ⁡
            
            
             
              π
             
             
              θ
             
            
            
             
              (
             
             
              
               a
              
              
               t
              
             
             
              ∣
             
             
              
               s
              
              
               t
              
             
             
              )
             
            
            
             d
            
            
             
              a
             
             
              t
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             b
            
            
             (
            
            
             
              s
             
             
              t
             
            
            
             )
            
            
             ∫
            
            
             
              ∂
             
             
              
               ∂
              
              
               θ
              
             
            
            
             
              π
             
             
              θ
             
            
            
             
              (
             
             
              
               a
              
              
               t
              
             
             
              ∣
             
             
              
               s
              
              
               t
              
             
             
              )
             
            
            
             d
            
            
             
              a
             
             
              t
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              ∂
             
             
              
               ∂
              
              
               θ
              
             
            
            
             b
            
            
             (
            
            
             
              s
             
             
              t
             
            
            
             )
            
            
             ∫
            
            
             
              π
             
             
              θ
             
            
            
             
              (
             
             
              
               a
              
              
               t
              
             
             
              ∣
             
             
              
               s
              
              
               t
              
             
             
              )
             
            
            
             d
            
            
             
              a
             
             
              t
             
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              ∂
             
             
              
               ∂
              
              
               θ
              
             
            
            
             
              (
             
             
              b
             
             
              (
             
             
              
               s
              
              
               t
              
             
             
              )
             
             
              ∗
             
             
              1
             
             
              )
             
            
            
             =
            
            
             0
            
           
          
         
        
       
       
         begin{aligned} mathbb{E}_{a_t}left[frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} b(s_t)right] &amp;= b(s_t)intpi_theta(a_t mid s_t)frac{partial}{partial theta}log pi_{theta}left(a_{t} mid s_{t}right)da_t \ &amp;=b(s_t)intfrac{partial}{partial theta}pi_{theta}left(a_{t} mid s_{t}right)da_t \ &amp;=frac{partial}{partial theta}b(s_t)intpi_{theta}left(a_{t} mid s_{t}right)da_t \ &amp;= frac{partial}{partial theta}left(b(s_t)* 1right) =0 end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 10.1248em;vertical-align: -4.81243em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 5.31242em"><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.81243em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 5.31242em"><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-symbol large-op" style="margin-right: 0.44445em">∫</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">d</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-symbol large-op" style="margin-right: 0.44445em">∫</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">d</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop op-symbol large-op" style="margin-right: 0.44445em">∫</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">d</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord">1</span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.81243em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 因此<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             
              ∂
             
             
              
               J
              
              
               t
              
             
             
              (
             
             
              θ
             
             
              )
             
            
            
             
              ∂
             
             
              θ
             
            
           
          
         
         
          
           
            
            
             =
            
            
             
              E
             
             
              
               s
              
              
               t
              
             
            
            
             
              E
             
             
              
               a
              
              
               t
              
             
            
            
             
              [
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              
               γ
              
              
               t
              
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 t
                
                
                 :
                
                
                 T
                
               
              
              
               )
              
             
             
              ]
             
            
            
             +
            
            
             0
            
           
          
         
        
        
         
          
           
          
         
         
          
           
            
            
             =
            
            
             
              E
             
             
              
               s
              
              
               t
              
             
            
            
             
              E
             
             
              
               a
              
              
               t
              
             
            
            
             
              [
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              
               γ
              
              
               t
              
             
             
              G
             
             
              
               (
              
              
               
                τ
               
               
                
                 t
                
                
                 :
                
                
                 T
                
               
              
              
               )
              
             
             
              ]
             
            
           
          
         
        
       
       
         begin{aligned} frac{partial mathcal{J}_{t}(theta)}{partial theta} &amp;=mathbb{E}_{s_t}mathbb{E}_{a_t}left[frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} Gleft(tau_{t: T}right)right]+0 \ &amp;=mathbb{E}_{s_t}mathbb{E}_{a_t}left[frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} Gleft(tau_{t: T}right)right] end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 5.40006em;vertical-align: -2.45003em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95003em"><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right: 0.18472em">J</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45003em"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95003em"><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord">0</span></span></span><span class=""><span class="pstrut" style="height: 3.45em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.296343em"><span class="" style="margin-left: 0em;margin-right: 0.0714286em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45003em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 证到这里答案已经呼之欲出了，在此省略之后的内容。</p> 
<p>另外，我们虽然确实保证了期望形式的策略梯度保持不变，但我们实际训练时用的是蒙特卡罗方法近似的，所以增加baseline前后的策略梯度肯定还是会有一点差别的。</p> 
<p>另外，关于减小方差的证明<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             V
            
            
             a
            
            
             r
            
            
             
              (
             
             
              
               ∂
              
              
               
                ∂
               
               
                θ
               
              
             
             
              log
             
             
              ⁡
             
             
              
               π
              
              
               θ
              
             
             
              
               (
              
              
               
                a
               
               
                t
               
              
              
               ∣
              
              
               
                s
               
               
                t
               
              
              
               )
              
             
             
              
               γ
              
              
               t
              
             
             
              
               (
              
              
               G
              
              
               
                (
               
               
                
                 τ
                
                
                 
                  t
                 
                 
                  :
                 
                 
                  T
                 
                
               
               
                )
               
              
              
               −
              
              
               b
              
              
               (
              
              
               
                s
               
               
                t
               
              
              
               )
              
              
               )
              
             
             
              )
             
            
            
             =
            
            
             E
            
            
             
              
               [
              
              
               
                ∂
               
               
                
                 ∂
                
                
                 θ
                
               
              
              
               log
              
              
               ⁡
              
              
               
                π
               
               
                θ
               
              
              
               
                (
               
               
                
                 a
                
                
                 t
                
               
               
                ∣
               
               
                
                 s
                
                
                 t
                
               
               
                )
               
              
              
               
                γ
               
               
                t
               
              
              
               
                (
               
               
                G
               
               
                
                 (
                
                
                 
                  τ
                 
                 
                  
                   t
                  
                  
                   :
                  
                  
                   T
                  
                 
                
                
                 )
                
               
               
                −
               
               
                b
               
               
                (
               
               
                
                 s
                
                
                 t
                
               
               
                )
               
               
                )
               
              
              
               ]
              
             
             
              2
             
            
            
             −
            
           
          
         
        
        
         
          
           
            
             
              (
             
             
              E
             
             
              
               [
              
              
               
                ∂
               
               
                
                 ∂
                
                
                 θ
                
               
              
              
               log
              
              
               ⁡
              
              
               
                π
               
               
                θ
               
              
              
               
                (
               
               
                
                 a
                
                
                 t
                
               
               
                ∣
               
               
                
                 s
                
                
                 t
                
               
               
                )
               
              
              
               
                γ
               
               
                t
               
              
              
               
                (
               
               
                G
               
               
                
                 (
                
                
                 
                  τ
                 
                 
                  
                   t
                  
                  
                   :
                  
                  
                   T
                  
                 
                
                
                 )
                
               
               
                −
               
               
                b
               
               
                (
               
               
                
                 s
                
                
                 t
                
               
               
                )
               
               
                )
               
              
              
               ]
              
             
             
              )
             
            
            
             2
            
           
          
         
        
       
       
         begin{aligned} Varleft(frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} left(Gleft(tau_{t: T}right)-b(s_t)right)right) = mathbb{E}left[frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} left(Gleft(tau_{t: T}right)-b(s_t)right)right]^2 -\ left(mathbb{E}left[frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t} left(Gleft(tau_{t: T}right)-b(s_t)right)right]right)^2 \ end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 5.80808em;vertical-align: -2.65404em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.15404em"><span class=""><span class="pstrut" style="height: 3.65401em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.02778em">r</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathbb">E</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.65401em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord">−</span></span></span><span class=""><span class="pstrut" style="height: 3.65401em"></span><span class="mord"><span class="minner"><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mord mathbb">E</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter">)</span></span><span class="mclose delimcenter"><span class="delimsizing size3">]</span></span></span><span class="mclose delimcenter"><span class="delimsizing size3">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.65401em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.65404em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 后一部分前面已经证明过与b(st)无关，所以我们只考虑前半部分<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          
           
            
             E
            
            
             
              [
             
             
              
               
                (
               
               
                
                 ∂
                
                
                 
                  ∂
                 
                 
                  θ
                 
                
               
               
                log
               
               
                ⁡
               
               
                
                 π
                
                
                 θ
                
               
               
                
                 (
                
                
                 
                  a
                 
                 
                  t
                 
                
                
                 ∣
                
                
                 
                  s
                 
                 
                  t
                 
                
                
                 )
                
               
               
                
                 γ
                
                
                 t
                
               
               
                )
               
              
              
               2
              
             
             
              
               
                (
               
               
                G
               
               
                
                 (
                
                
                 
                  τ
                 
                 
                  
                   t
                  
                  
                   :
                  
                  
                   T
                  
                 
                
                
                 )
                
               
               
                −
               
               
                b
               
               
                (
               
               
                
                 s
                
                
                 t
                
               
               
                )
               
               
                )
               
              
              
               2
              
             
             
              ]
             
            
            
             
              &lt;
             
             
              ？
             
            
            
             E
            
            
             
              [
             
             
              
               
                (
               
               
                
                 ∂
                
                
                 
                  ∂
                 
                 
                  θ
                 
                
               
               
                log
               
               
                ⁡
               
               
                
                 π
                
                
                 θ
                
               
               
                
                 (
                
                
                 
                  a
                 
                 
                  t
                 
                
                
                 ∣
                
                
                 
                  s
                 
                 
                  t
                 
                
                
                 )
                
               
               
                
                 γ
                
                
                 t
                
               
               
                )
               
              
              
               2
              
             
             
              G
             
             
              
               
                (
               
               
                
                 τ
                
                
                 
                  t
                 
                 
                  :
                 
                 
                  T
                 
                
               
               
                )
               
              
              
               2
              
             
             
              ]
             
            
           
          
         
        
       
       
         begin{aligned} mathbb{E}left[left(frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t}right)^2 left(Gleft(tau_{t: T}right)-b(s_t)right)^2right] &lt;_？ mathbb{E}left[left(frac{partial}{partial theta} log pi_{theta}left(a_{t} mid s_{t}right) gamma^{t}right)^2 Gleft(tau_{t: T}right)^2right] end{aligned} 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 3.30003em;vertical-align: -1.40002em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.90002em"><span class=""><span class="pstrut" style="height: 3.75em"></span><span class="mord"><span class="mord"><span class="mord mathbb">E</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">[</span></span><span class="minner"><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size3">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.65401em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.954008em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size4">]</span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel"><span class="mrel">&lt;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord cjk_fallback mtight">？</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathbb">E</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size4">[</span></span><span class="minner"><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord" style="margin-right: 0.05556em">∂</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mop">lo<span style="margin-right: 0.01389em">g</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em"><span class="" style="margin-left: -0.03588em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.02778em">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.05556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.843556em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size3">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.65401em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.954008em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose delimcenter"><span class="delimsizing size4">]</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.40002em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 可以看出，如果有<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         
          (
         
         
          G
         
         
          
           (
          
          
           
            τ
           
           
            
             t
            
            
             :
            
            
             T
            
           
          
          
           )
          
         
         
          −
         
         
          b
         
         
          (
         
         
          
           s
          
          
           t
          
         
         
          )
         
         
          )
         
        
        
         2
        
       
       
        &lt;
       
       
        G
       
       
        
         
          (
         
         
          
           τ
          
          
           
            t
           
           
            :
           
           
            T
           
          
         
         
          )
         
        
        
         2
        
       
      
      
       left(Gleft(tau_{t: T}right)-b(s_t)right)^2&lt;Gleft(tau_{t: T}right)^2
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.20401em;vertical-align: -0.25em"></span><span class="minner"><span class="minner"><span class="mopen delimcenter">(</span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.954008em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1.20401em;vertical-align: -0.25em"></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="minner"><span class="minner"><span class="mopen delimcenter">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.954008em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>，那么就能减小方差，所以b(st)并不是随便取的，我们需要让b(st)尽可能地与G接近。因此实际中采用的就是<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         V
        
        
         π
        
       
       
        (
       
       
        
         s
        
        
         t
        
       
       
        )
       
      
      
       V^pi(s_t)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，即相当于Gt的期望，所以自然会比较接近Gt。</p> 
<p>但是现在又有一个问题，本来我们的期望回报就是用蒙特卡罗近似的，现在又引入一个期望，我们又怎么办呢？再用一次蒙特卡罗吗？显然不可能，因为这样就无限套娃了</p> 
<p>事实上我们是用一组新的参数<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        ϕ
       
      
      
       phi
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em;vertical-align: -0.19444em"></span><span class="mord mathdefault">ϕ</span></span></span></span></span>估计<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         V
        
        
         π
        
       
       
        (
       
       
        s
       
       
        )
       
      
      
       V^pi(s)
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span></span>，在训练过程中除了优化策略函数的参数<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        θ
       
      
      
       theta
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span></span></span>，也同时优化<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        ϕ
       
      
      
       phi
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em;vertical-align: -0.19444em"></span><span class="mord mathdefault">ϕ</span></span></span></span></span>。</p> 
<p>于是，最终的Reinforce With Baseline如下</p> 
<p><img src="https://images2.imgbox.com/a8/ca/UiSfvNix_o.png" alt="在这里插入图片描述" width="450"></p> 
<p>大家看到对<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        θ
       
      
      
       theta
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em;vertical-align: 0em"></span><span class="mord mathdefault" style="margin-right: 0.02778em">θ</span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        ϕ
       
      
      
       phi
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em;vertical-align: -0.19444em"></span><span class="mord mathdefault">ϕ</span></span></span></span></span>不同的梯度更新千万不要怵，其实目标函数是一样的，只不过对不同参数求导得到不同结果而已。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>