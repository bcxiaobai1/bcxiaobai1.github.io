<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>【MySQL】 MySQL亿级数据、主从架构，Sharding分片 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【MySQL】 MySQL亿级数据、主从架构，Sharding分片</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    
                        
                    
                    <p>数据库Mysql</p> 
<p></p> 
<div class="toc"> 
 <h3>内容管理</h3> 
 <ul>
<li><a href="#MySQL_94">MySQL填充亿级数据</a></li>
<li>
<ul>
<li><a href="#Insert_into_select_102">Insert into select</a></li>
<li><a href="#loop_insert_161">存储过程loop insert</a></li>
<li><a href="#Loadfile_CVS_182">Loadfile 导入CVS文件</a></li>
</ul> 
  </li>
<li><a href="#MySQL_sysbenchmysqlslap_206">MySQL基准测试： sysbench、mysqlslap</a></li>
<li>
<ul>
<li><a href="#sysbench_219">sysbench</a></li>
<li><a href="#mysqlslap_351">mysqlslap</a></li>
</ul> 
  </li>
<li><a href="#SQL_396">SQL优化</a></li>
<li>
<ul>
<li><a href="#_406">分页查询优化</a></li>
<li><a href="#SQLmysqldumpslow_451">慢SQL日志工具mysqldumpslow</a></li>
</ul> 
  </li>
<li><a href="#MySQL_513">MySQL主从复制</a></li>
<li>
<ul>
<li><a href="#MySQL__knowledge_523">MySQL主从复制 knowledge</a></li>
<li><a href="#MySQL_563">MySQL二进制日志</a></li>
<li>
<ul>
<li><a href="#log_binsql_log_bin_599">log_bin和sql_log_bin</a></li>
<li><a href="#_605">二进制文件操作</a></li>
<li><a href="#binary_bin_log_MySQL_691">使用binary bin log 恢复MySQL</a></li>
</ul> 
   </li>
<li><a href="#MySQL_711">MySQL主从复制架构</a></li>
<li>
<ul>
<li><a href="#show_master_status___750">show master status 查看主库状态</a></li>
<li><a href="#show_slave_statsu__784">show slave statsu 查看从库状态</a></li>
<li><a href="#flush_table_with_read_lock_____795">flush table with read lock 主库只读锁</a></li>
<li><a href="#slave_stop____810">slave stop 停止从库备份行为</a></li>
<li><a href="#mysqldump___814">mysqldump 轻量级备份【文件传输】</a></li>
<li><a href="#scp____844">scp 备份转移</a></li>
<li><a href="#database_856">从库新建空database</a></li>
<li><a href="#reset_salve__862">通过reset salve 命令方式将从库连接到主库</a></li>
<li><a href="#mysql_878">mysql将备份导入从库的数据库</a></li>
<li><a href="#set_global_read_only__1__886">set global read_only = 1 从库开启只读模式</a></li>
<li><a href="#slave_start__890">slave start 启动从库</a></li>
<li><a href="#unlock___tables___894">unlock tables 解锁主库增删改操作</a></li>
<li><a href="#_898">检查主从复制是否</a></li>
</ul> 
   </li>
<li><a href="#SpringBootMySQLAOP_1043">SpringBoot整合MySQL主从架构【原生AOP]</a></li>
<li><a href="#MySQL_Prometheus__Grafana_1164">MySQL集群监控 Prometheus + Grafana</a></li>
<li><a href="#_Sharding_1180">分库分表 【Sharding】</a></li>
<li>
<ul>
<li><a href="#_1188">分库分表操作方式</a></li>
<li>
<ul>
<li><a href="#_1192">垂直分表</a></li>
<li><a href="#_1202">垂直分库</a></li>
<li><a href="#_1208">水平分库</a></li>
<li><a href="#_1214">水平分表</a></li>
</ul> 
    </li>
<li><a href="#_1244">数据分片</a></li>
<li>
<ul>
<li><a href="#_1250">分片算法</a></li>
<li><a href="#_1262">分片策略</a></li>
</ul> 
    </li>
<li><a href="#_problem_1273">分库分表 的problem</a></li>
<li><a href="#ShardingJDBC___1291">Sharding-JDBC 数据分片，读写分离</a></li>
</ul> 
   </li>
<li><a href="#Shardingjdbc_1299">Sharding-jdbc使用</a></li>
<li>
<ul>
<li><a href="#_1381">数据源配置</a></li>
<li><a href="#__sharding_1457">分片策略配置 -- 完整配置，使用sharding</a></li>
</ul> 
  </li>
</ul> 
 </li>
</ul> 
</div> 
<p></p> 
<hr> 
<p>本文着重介绍分布式微服务环境下MySQL的高可用部署</p> 
<hr> 
<blockquote> 
 <p>前面的文章是基础bg，这篇文章将介绍微服务下的MySQL，亿级数据填充，高可用集群，慢查询日志，SQL的高并发测试</p> 
 <p>java中性能优化捉妖就是考虑GC，优化循环、业务，减少内存的开销OOM（比如20万长度的List）减少从数据源提取的数据量（提取一个上亿数据的大表）、多线程转为线程池，优化GC</p> 
 <p>微服务下讲究的就是分离解耦，包括动静分离、前后端分离、主动分离（读写分离）</p> 
</blockquote> 
<p>开始之前举一个高性能的例子</p> 
<blockquote> 
 <p>场景需要获取User表所有的用户数量， 读出全部数据再List.size肯定没有直接MySQL中进行Count快</p> 
</blockquote> 
<p>这里既然提高了性能，简单介绍性能测试要求微服务的基本要求：</p> 
<blockquote> 
 <ul>
<li>模拟生产环境，95%用户的响应时间是否小于N秒， 一般来说，打开APP，初始化不应该超过3s，页面跳转不应该超过1s，跳转效益也等待不应该超过0.5s，搜索数据时间不应该超过0.5s</li>
<li>高并发场景，访问一个接口是否调用了过多的接口，比如登录要请求N个接口，高并发下，响应可能很慢</li>
<li>用户操作是否有监控功能，是否可以监控微服务的性能和服务端硬件性能</li>
<li>高并发下的慢连接、慢读取、慢请求 测试,保证不会因为客户端性能影响服务器性能 【 比如弱网条件下，APP网络差，要和服务端建立websocket长连接，java服务器推送数据后，APP未接收到，java服务器因为OOM而崩溃】</li>
<li>长时间大量用户连续登录退出是否会引发OOM、缓存失效、缓存穿透</li>
</ul> 
</blockquote> 
<p>开发业务时，需要关注的点：</p> 
<blockquote> 
 <p>分页处理技术： 单击加载更多，是否返回重复数据…</p> 
 <p>数据显示是否完整： 关注最后一页的数据</p> 
 <p>页面展示排序的方式： 后台服务器负责排序，前台JS负责排序，注重注意到底哪里承担排序职责</p> 
 <p>页面跳转是否正常： 尤其携带cookie等是否正常跳转</p> 
 <p>异常情况处理： 是否给前台用户返回过多的堆栈信息</p> 
 <p>程序可逆性： 保证增加数据后可以删除数据，删除数据后可以回滚</p> 
 <p>日志分割： 日志是否有效，是否按照日期分割方便提取</p> 
 <p>日志可读性： 日志存储信息是否有效，方便排查</p> 
 <p>程序灾备处理： 数据库渗透，是否有备份可以迅速恢复</p> 
 <p>程序高可用处理： 高并发导致服务器崩溃，是否可以继续提供服务</p> 
 <p>断网弱网处理： 弱网时是否包含超时约定，或者拒绝服务的约定</p> 
 <p>数据处理： 数据量较大时是否可以压缩，限流削峰处理</p> 
 <p>脱敏机制： 密码等意思信息是否正常脱敏</p> 
 <p>数据及时性： web控制台修改数据，APP是否及时有效更新</p> 
</blockquote> 
<p>I/O阻塞会闲置CPU造成浪费，多线程增加锁之后会造成锁等待（SQL偶尔执行慢）、创建销毁维护大量线程，线程切换都很耗时，数据量过大、慢请求控制…</p> 
<p>数据库的种类繁多，Cfeng接触的比较多的类型为Key-value数据库Redis、文档数据库MongoDB和ElasticSearch， 关系型数据库MySQL</p> 
<p>对于MySQL来说，常用的相关工具包括：</p> 
<ul>
<li>性能基准测试工具： sysbench、mysqlslap</li>
<li>应用程序Web压测： JMeter</li>
<li>MySQL服务器CPU监控： Grafana + Prometheus</li>
<li>集群分库： MyCat</li>
<li>统计工具： percona-toolkit</li>
<li>慢SQL查询： mysqldumpslow</li>
<li>分布式事务： Seata</li>
<li>事务处理测试： hammerDB</li>
<li>快速备份和恢复： mysqlhotcopy</li>
<li>常规备份和恢复： mysqldump</li>
<li>二进制日志（binlog）的解析工具： Maxwell</li>
</ul> 
<p>数据库作为应用性能的一个关键点，在使用时需要进行完备的性能测试：</p> 
<pre><code class="prism language-test">1. 初始化架构，设计数据库表和接口后，对于数据表的结构进行基准性能测试，得到结构基准信息

2. 数据库主从复制、MyCat集群优化后，需要进行压力测试，保证MySQL的单节点性能

3. 编码结束对可能执行的SQL进行计划解读，进行索引优化

4. 对数据库作业务存储量测试， 存储不同的数据量的SQL响应时间

5. 数据库疲劳测试，数据库是否会内存泄露

6. 灾备测试： 主从结构如果机器挂了，是否可以正常提供服务

7.安全测试： 防火墙、脱敏.....
</code></pre> 
<h1>
<a id="MySQL_94"></a>MySQL填充亿级数据</h1> 
<p>要正确模拟线上环境，需要给数据库填充亿级数据，传统插入Insert插入数据过慢</p> 
<p>使用Java等语言连接数据库操作MySQL，除了语言本身损耗，还包括语言和数据库连接的损耗；所以要给数据库增大数据量，不推荐使用语言连接的方式</p> 
<p>除了第三方工具，这里给出3种解决方案来填充亿级数据</p> 
<h2>
<a id="Insert_into_select_102"></a>Insert into select</h2> 
<p>该方式不涉及IO，所以速度最快，但是因为大多重复数据，自由度不高，【同时该方式不能用于数据库表迁移，因为SELECT 全表扫描，InnoDB行级锁会锁住大量数据，表的使用就崩溃】</p> 
<p>Insert Into Select 语句可以先从一个表中复制数据，再将数据插入目标表，目标表已经存在的行不受影响</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> target_table <span class="token keyword">SELECT</span> 字段<span class="token number">1</span>，<span class="token number">2.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> origin_table
</code></pre> 
<p>连续执行多次，因为是指数级增长，可以快速填充</p> 
<p>但是数据会出现大量重复，并且执行该语句多次会越来越慢，因为一次性插入庞大数据【从最开始0.000Xms ----&gt; 几分钟】</p> 
<p>比如向一个s_id,s_name, s_birth, s_sex的student表填充上亿数据，就可以多执行几次</p> 
<pre><code class="prism language-sql"><span class="token keyword">use</span> cfengtest<span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">select</span> <span class="token boolean">null</span><span class="token punctuation">,</span>s_name<span class="token punctuation">,</span>s_birth<span class="token punctuation">,</span>s_sex <span class="token keyword">from</span> student<span class="token punctuation">;</span>
</code></pre> 
<p>插入上百万数据时，执行很慢</p> 
<pre><code class="prism language-perl"><span class="token number">16</span><span class="token punctuation">:</span><span class="token number">26</span><span class="token punctuation">:</span><span class="token number">50</span>	insert into student select null<span class="token punctuation">,</span><span class="token regex">s_name,s_birth,s_sex</span> from student	<span class="token number">1572864</span> row<span class="token punctuation">(</span><span class="token regex">s) affected Records: 1572864  Duplicates: 0  Warnings: 0	28.844 sec 
# 这里插入157万数据，耗时28s， 但是还是很快了，直接将查询结果插入，不涉及IO
cfeng迅速就将数据扩充到628万

mysql&gt; select count(*) from student;
+----------+
| count(*)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>  <span class="token number">6285728</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">1</span> row in set <span class="token punctuation">(</span><span class="token number">1.35</span> sec<span class="token punctuation">)</span>

select <span class="token operator">*</span> from studnet limit <span class="token number">6000000</span>，<span class="token number">10</span>；
<span class="token number">10</span> rows in set <span class="token punctuation">(</span><span class="token number">4.91</span> sec<span class="token punctuation">)</span>  <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> Limit数值过大成为慢SQL
</code></pre> 
<p>这里需要注意，Mysql的数据执行需要缓冲区，需要在InnoDB的buffer pool种处理缓存：</p> 
<p>包括数据缓存、索引缓存、缓存数据、内部结构</p> 
<p><strong>当MySQL大批量执行INSERT INTO SELECT ，要求InnoDB的buffer pool足够大</strong></p> 
<p>解决缓存区异常的方案：</p> 
<ol>
<li>INSET INTO SELECT 语句加上Limit 限制一次性插入的数量</li>
<li>增加innodb_buffer_size的值</li>
</ol> 
<p>查看默认的数据库引擎的参数：</p> 
<p><mark>show variables like ‘%innodb%’</mark></p> 
<p>innodb_buffer_pool_size | 8388608 默认大小8MB</p> 
<p>修改大小为64MB， 在LINUX系统修改my.cnf， windows系统为my.ini，修改重新运行即可</p> 
<h2>
<a id="loop_insert_161"></a>存储过程loop insert</h2> 
<p>虽然存储过程不具有一致性，修改麻烦，不推荐使用，但是还是具有优势</p> 
<p>存储过程就是数据库中可以完成某种特定功能的SQL语句集合</p> 
<pre><code class="prism language-sql"><span class="token keyword">delimiter</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> demo_in_parameter<span class="token punctuation">(</span><span class="token operator">in</span> i <span class="token keyword">int</span><span class="token punctuation">)</span> 
<span class="token keyword">BEGIN</span>
	<span class="token keyword">WHILE</span> i <span class="token operator">&lt;</span> <span class="token number">10000000</span> <span class="token keyword">DO</span>
		<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'cfeng'</span><span class="token punctuation">,</span><span class="token string">'2001-07-01'</span><span class="token punctuation">,</span><span class="token string">'男'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">SET</span> i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span>
<span class="token keyword">end</span>$$
</code></pre> 
<p>可以使用存储方案的随机函数创建数据，如果要使用事务，提交事务不要太频繁，避免磁盘IO异常</p> 
<p>调用该存储过程 call demo_in_parameter(0)</p> 
<h2>
<a id="Loadfile_CVS_182"></a>Loadfile 导入CVS文件</h2> 
<p>Loadfile就是利用java语言或者python先创建CVS、txt，再将数据存放在文件中，通过MySQL的loadfile命令，将文件数据导入</p> 
<ul><li>准备文件，利用java编写相应的CVS文件，内容</li></ul> 
<pre><code class="prism language-cvs">N cfeng   2001/1/1 男
N cLEI    1999/12/1 男
.....
</code></pre> 
<ul><li> <p>将文件导入Mysql</p> <p>通过Load data infile xxx into table 命令导入数据</p> <pre><code class="prism language-sql"><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> <span class="token keyword">infile</span> <span class="token string">'/xxxx/xxx'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> student
</code></pre> </li></ul> 
<p>第三方的解决方案还包括DataFactory、DataFaker， 专业服务，当然数据自由度更高</p> 
<p>大数据量表的查询要么优化索引，要么优化代码和网络</p> 
<h1>
<a id="MySQL_sysbenchmysqlslap_206"></a>MySQL基准测试： sysbench、mysqlslap</h1> 
<p>填充大数据量之后，可能会存在问题：</p> 
<ul>
<li>MySQL单表数据过亿，返回数据速度极慢是正确的吗？</li>
<li>单台MySQL数据库最大承载访问量？</li>
<li>主从复制如何选择策略减少对单台数据库的性能影响？</li>
<li>如何为MySQL数据库配置参数达到最优？</li>
</ul> 
<p>要想了解主从复制对于数据库性能的影响，就可以分别测试主从复制集群和单节点访问，得到两种响应结果</p> 
<p>从代码上说：MySQL单表数据量过大确实更消耗性能，但是类似HashMap（超4000慢），但还是可以满足应用需求，速度也不一定是极慢（如果只是返回10条数据，还是ms级别 ---- cfeng验证过）</p> 
<h2>
<a id="sysbench_219"></a>sysbench</h2> 
<p>模块化、跨平台、开源的多线程基准测试锅具，可以执行<mark>CPU、内存、线程、IO、数据库</mark>等方面的测试</p> 
<pre><code class="prism language-j">CPU --- 处理器性能      threads--- 线程调度性能  mutex --- 互斥锁性能
memory --- 内存分配和传输速度性能    fileio --- 文件IO性能  oltp -- 数据库性能（OLTP基准测试）
</code></pre> 
<p>对于数据库，主要测试不同系统参数下数据库的负载情况，支持MySQL等少量数据库</p> 
<p>使用方式 ：</p> 
<ol>
<li>prepare： 造数据</li>
<li>run ： 执行脚本进行测试</li>
<li>cleanup： 删除测试数据</li>
</ol> 
<p>sysbench需要从mysql官网下载https://github.com/akopytov/sysbench</p> 
<pre><code class="prism language-prel">wget https://downloads.mysql.com/source/dbt2-0.37.50.16.tar.gz

tar -zvxf sysbench-0.4.12.14.tar.gz

cd sysbench-0.4.12.14

./configure

yum install mysql-devel

make 

make install
</code></pre> 
<p>通过sysbench --version 查看是否按照成功</p> 
<p>Sysbench的命令参数</p> 
<pre><code class="prism language-java">sysbench <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">[</span>testname<span class="token punctuation">]</span> <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
</code></pre> 
<p>options是sysbench的基本参数，指定sysbench的并发度，压测时长，线程数、总等待数…</p> 
<p>testname是sysbench的基准测试名称，可选项包括fileio、memory、cpu，捆绑的Lua脚本名称或者定制的Lua脚本</p> 
<p>command指定sysbench执行哪些测试命令，包括prepare、run、cleanup</p> 
<ul><li>压测CPU</li></ul> 
<pre><code class="prism language-s">sysbench --test=cpu  run

压测过程使用top发现CPU使用率飙升
</code></pre> 
<ul><li>压测内存</li></ul> 
<pre><code>sysbench --test=memory run
</code></pre> 
<ul><li>压测磁盘IO， 需要prepare、run、cleanup</li></ul> 
<pre><code>sysbench --test=fileio --file-total-size=1G prepare

sysbench --test=fileio --file-total-size=1G --file-test-mode=rndrw run

sysbench --test=fileio --file-total-size=1G cleanup
</code></pre> 
<ul><li>压测MySQL</li></ul> 
<pre><code class="prism language-j">sysbench 
--test=oltp 
--db-dirver=mysql 
--mysql-table-engine=myisam 
--mysql-db=mytest 
--oltp-table-size=100 
--mysql-socket=/var/lib/mysql/myslq.sock 
--mysql-host=192.168.204.100 
--mysql-user=cfeng 
--mysql-password=cfeng 
prepare


sysbench 
--test=oltp 
--db-dirver=mysql 
--mysql-table-engine=myisam 
--mysql-db=mytest 
--oltp-table-size=100 
--mysql-socket=/var/lib/mysql/myslq.sock 
--mysql-host=192.168.204.100 
--mysql-user=cfeng 
--mysql-password=cfeng 
run


sysbench 
--test=oltp 
--db-dirver=mysql 
--mysql-table-engine=myisam 
--mysql-db=mytest 
--oltp-table-size=100 
--mysql-socket=/var/lib/mysql/myslq.sock 
--mysql-host=192.168.204.100 
--mysql-user=cfeng 
--mysql-password=cfeng 
cleanup


压测数据库TPS性能
sysbench 
--db-dirver=mysql 
--time=180 
--thread=4 
--report-interval=1 
--mysql-host=192.168.204.100 
--mysql-port=3306 
--mysql-user=cfeng 
--mysql-password=cfeng 
--oltp_read_write 
--db-ps-mode=disable
run
</code></pre> 
<p>这里只是简单介绍一下，开拓一下，如果详细使用后会出文章?</p> 
<h2>
<a id="mysqlslap_351"></a>mysqlslap</h2> 
<p>mysqlslap是MySQL提供的压测工具，模拟多个并发客户访问MySQL执行压测，提供高负荷攻击MySQL的数据性能报告</p> 
<pre><code class="prism language-jav">C:UsersOME&gt;mysqlslap --help
mysqlslap  Ver 8.0.27 for Win64 on x86_64 (MySQL Community Server - GPL)
Copyright (c) 2005, 2021, Oracle and/or its affiliates.
</code></pre> 
<p>MySQL5版本之后安装之后就会携带mysqlslap工具，不管是windows或者Linux版本</p> 
<p>mysqlslap的命令</p> 
<pre><code class="prism language-per">mysqlslap [options]
</code></pre> 
<p>参数包括–auto-generate-sql等，具体可仔细搜索</p> 
<pre><code class="prism language-prel">mysqlslap  -a -u root --onle-print
</code></pre> 
<p>测试100个并发自动生成的SQL测试脚本，执行1000次查询</p> 
<pre><code class="prism language-perl">mysqlslap <span class="token operator">-u</span> root <span class="token operator">-p</span> <span class="token operator">-</span>a <span class="token operator">--</span>concurrency<span class="token operator">=</span><span class="token number">100</span> <span class="token operator">--</span>number<span class="token operator">-</span>of<span class="token operator">-</span>queries <span class="token number">1000</span>
</code></pre> 
<p>自定义数据压测</p> 
<pre><code class="prism language-perl">mysqlslap <span class="token operator"></span>
<span class="token operator">-u</span> root <span class="token operator"></span>
<span class="token operator">-p</span> <span class="token operator"></span>
<span class="token operator">--</span>delimiter<span class="token operator">=</span><span class="token string">';'</span> <span class="token operator"></span>
<span class="token operator">--</span>create<span class="token operator">=</span><span class="token string">"create table a (b int) ; inset into a values 23"</span> <span class="token operator"></span>
<span class="token operator">--</span>query<span class="token operator">=</span><span class="token string">"select * from a"</span> <span class="token operator"></span>
<span class="token operator">--</span>concurrency<span class="token operator">=</span><span class="token number">50</span> <span class="token operator"></span>
<span class="token operator">--</span>iterations<span class="token operator">=</span><span class="token number">200</span>
</code></pre> 
<p>处理Sysbench之外，还有很多的Linux压测工具，比如磁盘IO压测工具fio</p> 
<h1>
<a id="SQL_396"></a>SQL优化</h1> 
<p>当场景的响应速度不满意时，可以对SQL进行优化，这个时候需要考虑问题： 当前SQL如何扫描MySQL，导致反应速度慢？ 如何增加索引，怎么增加？</p> 
<p>优化一条复杂的SQL语句，可以将SQL语句拆开测试，检测每一行的运行时间，分析较慢的位置，可以使用explain查看执行任务【使用index与否】</p> 
<p><strong>SHOW WARNINGS</strong>优化只能作为参考，比如可能只是将* 变为了所有的字段，不是很智能</p> 
<p>之前提过SQL优化主要就是合理的使用索引，恰当使用索引可以提升查询的效率</p> 
<h2>
<a id="_406"></a>分页查询优化</h2> 
<p>当表中的数据量过大时，分页查询limit的耗时可能非常长</p> 
<pre><code class="prism language-java">mysql<span class="token operator">&gt;</span> <span class="token class-name">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token class-name">FROM</span> student<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>  <span class="token number">6285728</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">1</span> row in set <span class="token punctuation">(</span><span class="token number">1.61</span> sec<span class="token punctuation">)</span>
    
mysql<span class="token operator">&gt;</span> explain select <span class="token operator">*</span> from student limit <span class="token number">3000000</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> table   <span class="token operator">|</span> partitions <span class="token operator">|</span> type <span class="token operator">|</span> possible_keys <span class="token operator">|</span> key  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> rows    <span class="token operator">|</span> filtered <span class="token operator">|</span> <span class="token class-name">Extra</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token constant">SIMPLE</span>      <span class="token operator">|</span> student <span class="token operator">|</span> <span class="token constant">NULL</span>       <span class="token operator">|</span> <span class="token constant">ALL</span>  <span class="token operator">|</span> <span class="token constant">NULL</span>          <span class="token operator">|</span> <span class="token constant">NULL</span> <span class="token operator">|</span> <span class="token constant">NULL</span>    <span class="token operator">|</span> <span class="token constant">NULL</span> <span class="token operator">|</span> <span class="token number">6267580</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token constant">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token number">1</span> row in set<span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>按照之前提过的SQL的执行顺序，是SELECT之后才会进行Limit，所以会直接进行全表扫描，并不会过滤</p> 
<p>随着LimitM,N的增大，分页速度会越来越慢， 可以优化分页查询</p> 
<ul>
<li>可以先查询相关结果的主键， 再进行连接查询 【这样会走主键Index】回表扫描</li>
<li>或者可以直接将ID作为where条件过滤，先将结果滤出，避免全表扫描</li>
</ul> 
<pre><code class="prism language-m">mysql&gt; explain select * from (select s_id from student limit 3000000,3000) t, student s where t.s_id = s.s_id;
+----+-------------+------------+------------+--------+---------------+---------+---------+--------+---------+----------+-------------+
| id | select_type | table      | partitions | type   | possible_keys | key     | key_len | ref    | rows    | filtered | Extra       |
+----+-------------+------------+------------+--------+---------------+---------+---------+--------+---------+----------+-------------+
|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ALL    | NULL          | NULL    | NULL    | NULL   | 3003000 |   100.00 | NULL        |
|  1 | PRIMARY     | s          | NULL       | eq_ref | PRIMARY       | PRIMARY | 4       | t.s_id |       1 |   100.00 | NULL        |
|  2 | DERIVED     | student    | NULL       | index  | NULL          | PRIMARY | 4       | NULL   | 6267580 |   100.00 | Using index |
+----+-------------+------------+------------+--------+---------------+---------+---------+--------+---------+----------+-------------+
3 rows in set, 1 warning (0.01 sec)
</code></pre> 
<p>优化之后，会走主键索引，提升效率</p> 
<p>或者直接通过where过滤掉结果，走主键索引，不会全表扫描，效率一下就提升</p> 
<h2>
<a id="SQLmysqldumpslow_451"></a>慢SQL日志工具mysqldumpslow</h2> 
<p>分析MySQL性能时，需要查看数据库的哪些SQL的效率低下，需要使用数据库的慢查询，会记录所有的超过long_query_time的语句，便于进行优化</p> 
<p>常用的慢SQL日志分析工具包含mysqldumpslow，mysqlsla，mysql-explain-slow-log、myprofi等工具</p> 
<p>mysqldumpslow是官方自带的命令</p> 
<p>可以检查慢查询功能是否开启： 使用show variables like “%slow”</p> 
<pre><code class="prism language-perl">mysql<span class="token operator">&gt;</span> show variables like <span class="token string">"%slow%"</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> Variable_name               <span class="token operator">|</span> Value                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> log_slow_admin_statements   <span class="token operator">|</span> OFF                      <span class="token operator">|</span>
<span class="token operator">|</span> log_slow_extra              <span class="token operator">|</span> OFF                      <span class="token operator">|</span>
<span class="token operator">|</span> log_slow_replica_statements <span class="token operator">|</span> OFF                      <span class="token operator">|</span>
<span class="token operator">|</span> log_slow_slave_statements   <span class="token operator">|</span> OFF                      <span class="token operator">|</span>
<span class="token operator">|</span> slow_launch_time            <span class="token operator">|</span> <span class="token number">2</span>                        <span class="token operator">|</span>
<span class="token operator">|</span> slow_query_log              <span class="token operator">|</span> ON                       <span class="token operator">|</span>
<span class="token operator">|</span> slow_query_log_file         <span class="token operator">|</span> DESKTOP<span class="token operator">-</span>4A4BD0R<span class="token operator">-</span>slow<span class="token operator">.</span>log <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
</code></pre> 
<p>要开启慢查询功能，需要再配置文件中修改，/etc/my.cnf中修改slow_query</p> 
<pre><code class="prism language-r">slow_query_log<span class="token operator">=</span><span class="token number">1</span>  <span class="token comment">#开启慢查询日志</span>
long_query_time<span class="token operator">=</span><span class="token number">1</span>  <span class="token comment">#查过多少s认为为慢SQL</span>
show_query_log_file   <span class="token comment">#慢SQL日志文件位置</span>
log_queries_not_using_indexed <span class="token comment">#记录未使用SQL的记录</span>
</code></pre> 
<p>重启服务，可以看到慢SQL功能已经开启</p> 
<p>检查延时多少s后返回的SQL作为慢SQL</p> 
<pre><code class="prism language-[">show variables like "%long%"
</code></pre> 
<p>当执行慢SQL之后，相关的记录会放入日志</p> 
<blockquote> 
 <p>mysqldumpslow的命令解释：</p> 
 <p>-h : 帮助</p> 
 <p>-r ： 返回记录</p> 
 <p>-t： 返回前面多少记录</p> 
 <p>-g： 正则表达式</p> 
 <p>-s ： 排序参数 【c 大到小，t，l，at，al，ar】</p> 
</blockquote> 
<pre><code class="prism language-sql">mysqldumpslow <span class="token operator">-</span>s c <span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>mysqld<span class="token operator">/</span>mysqld<span class="token operator">-</span>slow<span class="token punctuation">.</span>log
</code></pre> 
<p>开启慢SQL功能会导致MySQL性能损耗上升，导致性能不足，速度下降，对于高并发程序，在生产环境不要开启慢SQL，在测试环境中使用即可； 要避免生产事故</p> 
<h1>
<a id="MySQL_513"></a>MySQL主从复制</h1> 
<p>随着数据量的增大，单台机器已经不能承受压力，同时为了高可用性，需要使用集群</p> 
<p>在Redis使用时，最常见的就是主从复制的集群，Redis主从复制，读写分离，采用哨兵进行监控，实现宕机后的自动化选举 【数据RDB通过socket传输给集群内其余的机器】</p> 
<p><img src="https://images2.imgbox.com/09/0f/QKu07GTd_o.png" alt="img"></p> 
<p>MySQL同样支持集群，MySQL主从复制也是解决单台实例瓶颈问题，业务量增大后，IO密集，单台实例是不能支撑的，多库存储，降低磁盘IO次数，提高单台机器的IO访问性能</p> 
<h2>
<a id="MySQL__knowledge_523"></a>MySQL主从复制 knowledge</h2> 
<p>MySQL主从复制是将数据从一台MySQL服务器复制到从节点，包括所有数据库实例、特定数据库实例或者特定表，<mark>采用异步的复制方式</mark>，，从节点不需要一直访问主机，在远程服务上更新自己的数据</p> 
<p>主服务器就是master服务器，当数据更改时，会将数据的更改记录在二进制日志中</p> 
<p>从服务器就是slave服务器，从服务器slave会定期对主服务器的二进制文件进行探测，观测是否发生改变，如果发生改变，那么<strong>从服务器会启动一个IO线程，请求更新数据</strong></p> 
<pre><code class="prism language-kj">客户端SQL更新命令

主服务器执行SQL语句

主服务器写二进制日志

从服务器启动IO线程

从服务器从IO线程写盘 relay-log

从服务器启动SQL线程读

从服务器执行更新命令relay-info
</code></pre> 
<ul>
<li>在进行集群搭建时，需要保证主从数据库的版本相同，避免位置异常</li>
<li>主服务器和从服务器的时间必须同步，否则二者线程时间不一致，导致数据同步失败</li>
<li>从服务器最好有多台，可以进行数据参考，同时增加可用性</li>
</ul> 
<p><strong>集群架构拓扑结构</strong></p> 
<p>（1）一主一从： 从服务器只能读取数据，主服务器可以写入或者读取数据，少见，一般采用多从</p> 
<p>（2）主主复制： 将两台服务器都设置master，都可以读取或者写入数据，可能会出现混乱</p> 
<p>（3）联级复制： master A —&gt; slave B -----&gt; slave C ， slaveB和slave C会替换掉旧的master A，同时B和C构成新的主从关系，适合数据迁移</p> 
<p>（4）多主一从： 适合写多读少，只有一台从服务器读取数据</p> 
<p>（5）一主多从： 适合读多写少，master写入，多台slave进行读取</p> 
<h2>
<a id="MySQL_563"></a>MySQL二进制日志</h2> 
<p>在Redis中，持久化方式为RDB和AOF，RDB日志文件就是redis进行主从复制的参照， 在MySQL中，主从复制的数据传送依靠的是MySQL的二进制文件</p> 
<p>mysql二进制日志是一个二进制文件，记录了修改数据或者可能引起数据变更的SQL语句，记录了更改的所有的操作，同时记录的语句发生时间、执行时长等信息，不记录SELECT等不会更改数据的操作，<strong>二进制日志是主从复制的基础</strong></p> 
<p>之前的慢查询的变量为long，二进制日志可以查询变量log_bin</p> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">"log_bin"</span>


mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">"log_bin"</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token operator">|</span> log_bin       <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.04</span> sec<span class="token punctuation">)</span>


<span class="token operator">+</span><span class="token comment">---------------------------------+--------------------------------------------------------+</span>
<span class="token operator">|</span> Variable_name                   <span class="token operator">|</span> <span class="token keyword">Value</span>                                                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------------------+--------------------------------------------------------+</span>
<span class="token operator">|</span> log_bin                         <span class="token operator">|</span> <span class="token keyword">ON</span>                                                     <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_basename                <span class="token operator">|</span> D:MySQL<span class="token keyword">Data</span> Directory<span class="token keyword">Data</span>DESKTOP<span class="token operator">-</span><span class="token number">4</span>A4BD0R<span class="token operator">-</span>bin       <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_index                   <span class="token operator">|</span> D:MySQL<span class="token keyword">Data</span> Directory<span class="token keyword">Data</span>DESKTOP<span class="token operator">-</span><span class="token number">4</span>A4BD0R<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_trust_function_creators <span class="token operator">|</span> <span class="token keyword">OFF</span>                                                    <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_use_v1_row_events       <span class="token operator">|</span> <span class="token keyword">OFF</span>                                                    <span class="token operator">|</span>
<span class="token operator">|</span> sql_log_bin                     <span class="token operator">|</span> <span class="token keyword">ON</span>                                                     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------------------+--------------------------------------------------------+</span>
<span class="token number">6</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>ON 代表开启了二进制日志，模糊查询其他的参数可以看到二进制文件的存放位置等</p> 
<h3>
<a id="log_binsql_log_bin_599"></a>log_bin和sql_log_bin</h3> 
<p>log_bin主要 数据恢复，主从服务器同步数据，可以通过配置文件开启日志，log_bin只是报告当前二进制文件的状态，不能修改，只能通过配置文件修改后重启服务</p> 
<p>sql_log_bin 是一个动态变量， 可以是局部变量，也可以是全局变量，其可以修改，【相当于log_bin只能查看，sql_log_bin可以修改】，如果在一个会话中设置为OFF，则所有的更新操作都不会记录日志，所以使用log_bin还原数据，为了避免将还原的UPDATE操作写入日志，出现循环复制，<strong>关闭sql_log_bin</strong></p> 
<h3>
<a id="_605"></a>二进制文件操作</h3> 
<ul><li>查看二进制文件 直接show binary logs即可</li></ul> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">binary</span> logs<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-----------+-----------+</span>
<span class="token operator">|</span> Log_name                   <span class="token operator">|</span> File_size <span class="token operator">|</span> Encrypted <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-----------+-----------+</span>
<span class="token operator">|</span> DESKTOP<span class="token operator">-</span><span class="token number">4</span>A4BD0R<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000549</span> <span class="token operator">|</span>       <span class="token number">179</span> <span class="token operator">|</span> <span class="token keyword">No</span>        <span class="token operator">|</span>
<span class="token operator">|</span> DESKTOP<span class="token operator">-</span><span class="token number">4</span>A4BD0R<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000623</span> <span class="token operator">|</span>       <span class="token number">156</span> <span class="token operator">|</span> <span class="token keyword">No</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-----------+-----------+</span>
<span class="token number">75</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.52</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>或者也可以使用show master logs 查看</p> 
<ul><li>删除某个日志前的所有的二进制文件</li></ul> 
<p>通过expire_logs_days设定后会依据时间自动删除二进制日志， 同时也可以使用purge命令手动删除</p> 
<pre><code class="prism language-sql"><span class="token keyword">purge</span> <span class="token keyword">binary</span> logs <span class="token keyword">to</span> <span class="token string">"DESKTOP-4A4BD0R-bin.000623"</span>
</code></pre> 
<p>执行后就会删除DESKTOP-4A4BD0R-bin.000623 日志</p> 
<ul><li>删除 某个节点前的二进制日志文件</li></ul> 
<p>直接purge before 时间即可</p> 
<pre><code class="prism language-sql"><span class="token keyword">purge</span> <span class="token keyword">binary</span> logs before <span class="token string">'2022-11-19 12:00:00'</span>
</code></pre> 
<p>删除7天前的二进制日志文件</p> 
<pre><code class="prism language-sql"><span class="token keyword">purge</span> <span class="token keyword">binary</span> logs before date_sub<span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">interval</span> <span class="token number">7</span> days<span class="token punctuation">)</span>
</code></pre> 
<ul><li>删除所有的二进制日志文件</li></ul> 
<pre><code class="prism language-sql">reset master
</code></pre> 
<ul><li>查看二进制日志</li></ul> 
<p>直接system命令即可查看</p> 
<pre><code class="prism language-sql">system mysqlbinlog <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000001</span>
</code></pre> 
<p>其中就会包含对表的各种操作，比如创建表等，但是是整个冗杂在一起</p> 
<p>还可以使用show binlog events in “” 进行观察</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> binlog events <span class="token operator">in</span> <span class="token string">"DESKTOP-4A4BD0R-bin.000623"</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-----+----------------+-----------+-------------+-----------------------------------+</span>
<span class="token operator">|</span> Log_name                   <span class="token operator">|</span> Pos <span class="token operator">|</span> Event_type     <span class="token operator">|</span> Server_id <span class="token operator">|</span> End_log_pos <span class="token operator">|</span> Info                              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-----+----------------+-----------+-------------+-----------------------------------+</span>
<span class="token operator">|</span> DESKTOP<span class="token operator">-</span><span class="token number">4</span>A4BD0R<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000623</span> <span class="token operator">|</span>   <span class="token number">4</span> <span class="token operator">|</span> Format_desc    <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>         <span class="token number">125</span> <span class="token operator">|</span> Server ver: <span class="token number">8.0</span><span class="token number">.27</span><span class="token punctuation">,</span> Binlog ver: <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">|</span> DESKTOP<span class="token operator">-</span><span class="token number">4</span>A4BD0R<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000623</span> <span class="token operator">|</span> <span class="token number">125</span> <span class="token operator">|</span> Previous_gtids <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>         <span class="token number">156</span> <span class="token operator">|</span>                                   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+-----+----------------+-----------+-------------+-----------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>可以通过pos 参数，指定查询某个节点之后的数据, 如果数据十分庞大，还可以使用分页参数limit</p> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> binlog events <span class="token operator">in</span> <span class="token string">"DESKTOP..."</span> <span class="token keyword">from</span> <span class="token number">475</span> <span class="token keyword">limit</span> <span class="token number">2</span>
</code></pre> 
<ul><li>复制二进制日志将其转为文本文件</li></ul> 
<pre><code class="prism language-sql">mysqlbinlog <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000001</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>log<span class="token punctuation">.</span>txt
</code></pre> 
<p>就是 定向符 &gt; 指定文件的位置</p> 
<p>之后使用linux命令cat /log.txt | grep “drop” 就可以正常查询所有的drop内容</p> 
<h3>
<a id="binary_bin_log_MySQL_691"></a>使用binary bin log 恢复MySQL</h3> 
<p>使用二进制日志恢复MySQL，使用的是mysqlbinlog命令</p> 
<p>直接版本回滚，–stop-pos即可</p> 
<pre><code class="prism language-sql"><span class="token number">1.</span> 删除mytest<span class="token punctuation">.</span>zfx_tbl表
  <span class="token keyword">drop</span> <span class="token keyword">table</span> mytest<span class="token punctuation">.</span>zfx_tbl<span class="token punctuation">;</span>
  <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>

<span class="token number">2.</span>执行mysqlbinlog ，查看需要将数据回滚到哪个时间节点
  mysqlbinlog <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">00002</span>
  
<span class="token number">3.</span>执行回滚<span class="token punctuation">,</span> 指定sotp pos 回滚到哪一行
  mysqlbinlog <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">00001</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">00002</span> <span class="token comment">--stop-pos=65488 |mysql -u root -p </span>
  
<span class="token number">4.</span> 数据恢复成功
</code></pre> 
<h2>
<a id="MySQL_711"></a>MySQL主从复制架构</h2> 
<p>首先需要构建主从复制架构，准备多台MySQL机器，每台机器数据库中包含亿级测试数据</p> 
<pre><code class="prism language-1">192.168.204.100   Master
192.168.204.101   slave
192.168.204.102   slave
</code></pre> 
<p>搭建主从复制架构，需要配置机器的配置文件</p> 
<p>主库Master的配置文件/etc/my.cnf</p> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
datadir<span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># 这些配置Cfeng之前的博客包含，只给出主从架构的配置 </span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">1</span>     <span class="token comment">#主从复制ID</span>
log<span class="token operator">-</span>bin <span class="token operator">=</span>mysql<span class="token operator">-</span>bin    <span class="token comment">#二进制日志生成的日志名称</span>
binlog<span class="token operator">-</span>format<span class="token operator">=</span> <span class="token keyword">ROW</span>    <span class="token comment">#主从复制的模式与配置</span>
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span>db<span class="token operator">=</span> cfengtest   <span class="token comment">#主从复制数据库的库名</span>
</code></pre> 
<p>从库Slave的配置文件/etc/my.cnf</p> 
<pre><code class="prism language-sql"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
datadir<span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># 这些配置Cfeng之前的博客包含，只给出主从架构的配置 </span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">2</span>     <span class="token comment">#主从复制ID</span>
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span>db<span class="token operator">=</span> cfengtest   <span class="token comment">#主从复制数据库的库名</span>
relay<span class="token operator">-</span>log<span class="token operator">=</span>relay<span class="token operator">-</span>log
</code></pre> 
<h3>
<a id="show_master_status___750"></a>show master status 查看主库状态</h3> 
<p>可以通过show master status查看主库状态</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------------------------+----------+--------------+------------------+-------------------+</span>
<span class="token operator">|</span> <span class="token keyword">File</span>                       <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+----------+--------------+------------------+-------------------+</span>
<span class="token operator">|</span> DESKTOP<span class="token operator">-</span><span class="token number">4</span>A4BD0R<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000623</span> <span class="token operator">|</span>      <span class="token number">156</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------+----------+--------------+------------------+-------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>当指定主从复制的数据库时，就会进行主从复制， 为了保证<strong>除此主从复制的数据完整性</strong>， 可以如下操作</p> 
<blockquote> 
 <p>停止主库的增删改</p> 
 <p>停止从库的复制行为</p> 
 <p>清空从库的所有数据</p> 
 <p>将主库的日志文件mysql-bin… 全量复制到从库</p> 
 <p>检查当前主库的Pos参数写到多少行</p> 
 <p>不从00001开始备份，改变量master_log_pos改成当前的行数</p> 
 <p>开启从库的只读模式</p> 
 <p>开启从库复制行为</p> 
 <p>开启主库的增删改行为</p> 
</blockquote> 
<h3>
<a id="show_slave_statsu__784"></a>show slave statsu 查看从库状态</h3> 
<p>通过show slave status可以查看从库的状态，缓存性质的语句，如果服务崩溃、异常、重启，那么涵盖的数据就不准确，可能会消失</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> slave <span class="token keyword">status</span><span class="token punctuation">;</span>
Empty <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>因为此时还没有开始主从复制，所以从库的状态就是空，当主从复制之后，就会显式Master Host、Mater User等信息，Relay_log_File为从库中继器中存储的已同步的数据内容，Slave_IO_Running和Slave_SQL_Running都是YES，代表主从复制部署成功</p> 
<h3>
<a id="flush_table_with_read_lock_____795"></a>flush table with read lock 主库只读锁</h3> 
<p>主从复制过程中，停止主库的更新操作 ---- 给数据库全局加上只读锁?</p> 
<p>flush table with read lock</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> flush <span class="token keyword">table</span> <span class="token keyword">with</span> <span class="token keyword">read</span> <span class="token keyword">lock</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>数据库的所有表都变为只读模式，更新操作（增，删，改） 都会失败</p> 
<p>该命令获取锁也是需要等待其他的操作释放锁，如果其他的语句包括显式锁SELECT占用锁，那么命令就会阻塞等待完成</p> 
<h3>
<a id="slave_stop____810"></a>slave stop 停止从库备份行为</h3> 
<p>在从库的控制台输入slave stop 就可以停止备份行为</p> 
<h3>
<a id="mysqldump___814"></a>mysqldump 轻量级备份【文件传输】</h3> 
<p>mysqldump备份： 通过协议连接MySQL，将需要备份的数据查询出来，将这些查询出来的数据转换为对应的insert语句，当需要还原时，执行INSERT语句即可</p> 
<p>直接mysqldump [选项] 数据库 &gt; （位置）文件名.sql 就可以备份</p> 
<pre><code class="prism language-sql">C:UsersOMEY<span class="token operator">-</span>PC<span class="token operator">&gt;</span>mysqldump <span class="token operator">-</span>u cfeng <span class="token operator">-</span>p cfengrest <span class="token operator">&gt;</span> D:Webstudycfengrest<span class="token punctuation">.</span><span class="token keyword">sql</span>
Enter password: <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
</code></pre> 
<p>mysqldump当数据为浮点类型时，会出现精度丢失，逻辑备份慢于物理备份，其是串行化备份，并行可以使用mydumper</p> 
<p>数据量大时，不推荐使用效率低下的mysqldump</p> 
<p>数据备份的方式：</p> 
<ul>
<li>完整备份： 备份整库数据</li>
<li>部分备份： 
  <ul>
<li>增量备份： 备份最近一次完整备份或者增量备份后更改的数据</li>
<li>差异备份： 备份最近一次完整备份后修改的数据</li>
</ul> </li>
</ul> 
<p>数据库的备份的方式：</p> 
<ul>
<li>冷备份： 读写操作都不可执行</li>
<li>温备份： 读操作可以执行，但是不能进行写操作</li>
<li>热备份： 读写操作都可以执行</li>
</ul> 
<p>MyISAM不支持热备份，InnoDB都是支持的</p> 
<h3>
<a id="scp____844"></a>scp 备份转移</h3> 
<p>scp： secure copy， 基于ssh的远程文件拷贝命令，scp加密，rcp不加密</p> 
<p>比如使用scp命令将主库的cfengrest文件传输到从库服务器的root文件夹下： 使用root账号</p> 
<pre><code class="prism language-linux">scp cfengrest.sql root@192.168.204.101:/root/
</code></pre> 
<p>输入密码后就可以传输文件，可视化界面工具xftp是在windows中使用</p> 
<h3>
<a id="database_856"></a>从库新建空database</h3> 
<p>要使用备份数据，先新建一个空的数据库</p> 
<p>create database XXX default charset uft8</p> 
<h3>
<a id="reset_salve__862"></a>通过reset salve 命令方式将从库连接到主库</h3> 
<p>配置cnf之后，重启Mysql，除此之外，还可以通过MySQL命令的方式连接主库</p> 
<p>需要注意，主库的user@password需要允许外部连接，同时主库的mysql端口开放</p> 
<p>在从库的mysql控制台输入：</p> 
<pre><code class="prism language-mysql">reset slave;

CHANGE MASTER TO MASTER_HOST = '192.168.204.100', MASTER_PORT=3306, MASTER_USER='cfeng', MASTER_PASSWORD='XXX', MASTER_LOG_FILE='mysql_bin.000004',MASTER_LOG_POS=1558;

slave start;
</code></pre> 
<h3>
<a id="mysql_878"></a>mysql将备份导入从库的数据库</h3> 
<p>直接通过mysql命令即可</p> 
<pre><code class="prism language-sql">mysql <span class="token operator">-</span>u root <span class="token operator">-</span>p xxxx<span class="token operator">&lt;</span> 文件<span class="token punctuation">.</span><span class="token keyword">sql</span>
</code></pre> 
<h3>
<a id="set_global_read_only__1__886"></a>set global read_only = 1 从库开启只读模式</h3> 
<p>set global read_only = 1就可以开启只读模式， =0 就是关闭只读模式，只读模式不会影响从库的同步复制，普通用户不能进行数据修改操作，如果super_read_only=on，那么管理员也是只读</p> 
<h3>
<a id="slave_start__890"></a>slave start 启动从库</h3> 
<p>可以通过slave stop 暂停主从，使用reset重置关系，使用start开启主从复制</p> 
<h3>
<a id="unlock___tables___894"></a>unlock tables 解锁主库增删改操作</h3> 
<p>可以通过unlock tables 解锁之前的flush table with read lock， 之后就可以正常进行修改操作</p> 
<h3>
<a id="_898"></a>检查主从复制是否</h3> 
<p>直接在主库插入一个值，再在从库中查询该值是否存在</p> 
<p>可以show slave status，如果Running参数为YES也说明生效</p> 
<blockquote> 
 <p>主从架构过程可能存在问题：</p> 
 <ol><li>数据不同步： show slave status 出现1032，如果数据同步需要一致，那么停止所有的复制行为，执行stop slave，重新同步主库已有数据到从库； 如果不需要一致，那么停止从库复制行为，跳过一次错误</li></ol> 
 <pre><code class="prism language-sql">stop slave
<span class="token keyword">set</span> <span class="token keyword">global</span>  sql_slave_skip_counter <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">start</span> slave
</code></pre> 
 <ol><li>接收包过小 1236， 可以设置一下，比如4MB</li></ol> 
 <pre><code class="prism language-sql">slave stop
reset slave
<span class="token keyword">set</span> <span class="token keyword">global</span> max_allowed_packet <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span>
</code></pre> 
 <ol><li>连接错误： 1045， 无法连接到主库，那就重新使用命令连接到主库</li></ol> 
</blockquote> 
<p>下面给出Cfeng具体使用CentOS的操作</p> 
<p>首先192.168.204.100上面包含mysql、redis等， 为了快速搭建集群，使用虚拟机克隆的方式直接克隆两台虚拟机</p> 
<blockquote> 
 <p>克隆时，选择创建完整实例</p> 
 <p>因为源主机采用的静态IP，所以克隆出的虚拟机需要修改MAC、uuid和静态IP值【网卡名称】</p> 
 <p>点击NAT设置，高级—&gt; 生成新的MAC地址 （MAC如果相同则会冲突不能访问网络】</p> 
 <p>之后进入/etc/sysconfig/network-scripts</p> 
 <p>将原网卡名称ens33改为新的网卡名称比如eth1， 修改之后进入该文件， 修改HDADDR = 新的MAC地址</p> 
 <p>同时修改UUID为新的UUID （使用命令uuidgen可以生成）</p> 
 <p>修改静态IP为新的IP： 192.168.204.101</p> 
 <p>之后reboot ，ping 成功</p> 
</blockquote> 
<p>之后cfeng使用204.100作为master， 101和102作为slave为虚拟机克隆，数据库配置文件和auto.cnf的配置都克隆了，需要修改为不同的</p> 
<blockquote> 
 <p>进入/usr/local/etc/myMysql.cnf （也就是mysql配置文件位置）</p> 
 <p>进入修改server-id 【这类似分布式系统的唯一标识】，开启日志mysql-bin； cfeng依次修改为100，101，102</p> 
 <p>之后进入auto.cnf修改UUID，这里可以先find -name auto.cnf； 找到后，使用uuidgen生成新的UUID写入</p> 
 <p>之后重启服务systemctl restart mysql</p> 
</blockquote> 
<p>重置主机日志【清除所有的日志】</p> 
<pre><code class="prism language-sql">reset master<span class="token punctuation">;</span>

<span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">------------------+----------+--------------+------------------+-------------------+</span>
<span class="token operator">|</span> <span class="token keyword">File</span>             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+----------+--------------+------------------+-------------------+</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000001</span> <span class="token operator">|</span>      <span class="token number">156</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------+----------+--------------+------------------+-------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>这里的pos和file都是从机连接的参数</p> 
<p>查询从机状态show slave status，如果不为空，那么先stop slave，之后reset slave， 连接主机</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> change master <span class="token keyword">to</span> master_host<span class="token operator">=</span><span class="token string">'192.168.204.100'</span><span class="token punctuation">,</span>master_user<span class="token operator">=</span><span class="token string">'cfeng'</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> master_port<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>master_password<span class="token operator">=</span><span class="token string">'aXXXXXXXX0X'</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> master_log_file<span class="token operator">=</span><span class="token string">'mysql-bin.000001'</span><span class="token punctuation">,</span>master_log_pos<span class="token operator">=</span><span class="token number">156</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">9</span> <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>连接之后，就可以开启主从复制了，直接start slave</p> 
<p>这个时候可以查看状态</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>G<span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
               Slave_IO_State: Waiting <span class="token keyword">for</span> source <span class="token keyword">to</span> send event
                  Master_Host: <span class="token number">192.168</span><span class="token number">.204</span><span class="token number">.100</span>
                  Master_User: cfeng
                  Master_Port: <span class="token number">3306</span>
                Connect_Retry: <span class="token number">60</span>
              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000001</span>
          Read_Master_Log_Pos: <span class="token number">497</span>
               Relay_Log_File: hadoopbase2<span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000002</span>
                Relay_Log_Pos: <span class="token number">665</span>
        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000001</span>
             Slave_IO_Running: Yes
</code></pre> 
<p>当slave_IO和SQL都是YES代表开启成功， 当然设置只读状态就是在配置文件中设置read_only =1； 或者全局加上只读锁，flush … read lock</p> 
<p>这个时候就是正常的主从复制了，体系正常运转，<mark>slave 机器定时探测主机的mysql-bin二进制日志，发生改变就会将更改操作通过relay-log拉入本地执行，达到同步</mark>【主从复制的关键就是binlog】</p> 
<p>在主库中插入数据，从机可以正常读取</p> 
<pre><code class="prism language-mysql">mysql&gt; insert into test_user values (7,34,'HC1987','masterAndSlave','123456');
Query OK, 1 row affected (0.02 sec)


mysql&gt; select * from test_user;
+----+----------+------------+----------------+----------+
| id | user_age | user_class | user_name      | user_pwd |
+----+----------+------------+----------------+----------+
|  1 |       12 | HC2005     | Cfeng          | a123456  |
|  2 |       12 | HC11班    | KDJGHAG        | 1234     |
|  3 |       18 | HC19班    | HJCKHHH         | iuuuihh  |
|  4 |       21 | HC1987     | 小X           | gdgfsh   |
|  5 |       23 | HC1990     | SMall huan     | joihihih |
|  6 |       23 | HC1878     | 小XDChat       | iihhhlk  |
|  7 |       34 | HC1987     | masterAndSlave | 123456   |
+----+----------+------------+----------------+----------+
7 rows in set (0.00 sec)

</code></pre> 
<p>主从架构搭建成功，主从复制，主写从读，读写分离</p> 
<p>之前提过redis主从复制有所区别</p> 
<blockquote> 
 <p>reids复制原理：</p> 
 <p>初次建立连接时，master生成RDB快照发送给slave，slave加载所有数据</p> 
 <p>之后就和mysql一样进行增量复制，只是redis是通过长连接的方式， 主机执行写命令，会通过长连接同步发送给salve， 二者维护一个<code>同步的偏移量</code>，当连接断掉，就直接断点续传即可， 这个offset复制偏移量如果不一致，那么就会重新进行全量复制</p> 
</blockquote> 
<p>mysql是slave定时扫描master的binlog， redis是master和slave长连接，master执行写操作将命令主动发送给从机执行 【mysql是从机主导，redis是主机操作】</p> 
<p>redis的高可用使用哨兵模式，通过哨兵集群，定期进行心跳检测，自动进行故障处理，选举新的master</p> 
<p>mysql也可以利用类似的模式，比如MHA工具，通过MHA实例检测Mysql集群，健康检测心跳，当主机宕机后，MHA会选取relay-log的POS最大的作为master来尽量保证一致性</p> 
<h2>
<a id="SpringBootMySQLAOP_1043"></a>SpringBoot整合MySQL主从架构【原生AOP]</h2> 
<p>整合主从架构，首先就是需要配置数据源，这里使用Druid（可视化）数据源，在配置文件中指定master和slave结构</p> 
<pre><code class="prism language-yaml"><span class="token comment">###### mysql 主从复制架构 #####</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">druid</span><span class="token punctuation">:</span>
      <span class="token key atrule">master</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.204.100<span class="token punctuation">:</span>3306/test_user<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-8&amp;useSSL=true&amp;servertimezone=GMT%2B8</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> cfeng
        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">1234556</span>

      <span class="token key atrule">slave1</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.204.101<span class="token punctuation">:</span>3306/test_user<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-8&amp;useSSL=true&amp;servertimezone=GMT%2B8</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> cfeng
        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">1234556</span>

      <span class="token key atrule">slave2</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.204.102<span class="token punctuation">:</span>3306/test_user<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-8&amp;useSSL=true&amp;servertimezone=GMT%2B8</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> cfeng
        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">1234556</span>
        
 <span class="token punctuation">...</span>.. 其余的druid本身配置省略
</code></pre> 
<p>之后编写数据源配置文件MySQLDatasourceConfig，将上面配置的数据源注入</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MysqlDatasourceConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span><span class="token string">"spring.datasource.druid.master"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">masterDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"select master data source"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">DruidDataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span><span class="token string">"spring.datasource.druid.slave1"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">slaveDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"select slave datasource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">DruidDataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span><span class="token string">"spring.datasource.druid.slave2"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">slave2DataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"select slave2 datasource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">DruidDataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编写一个ThreadLocal本地线程管理类，设置当前线程使用的数据源</p> 
<blockquote> 
 <p>ThreadLocal的主要作用是实现数据隔离，运行时数据区分为私有的虚拟机栈和本地方法栈、PC ，以及共享的堆Heap、元数据区MeataSpace、直接内存DM；</p> 
 <p>而当并发访问共享数据时，可能出现安全问题，常见的丢失修改，库存超卖等， 一种解决方案就是锁 ---- 串行化操作 【比如单机的JUC、AQS、synchronized； 分布式的分布式锁 redis的SETNX、zookeeper的临时节点、包括乐观锁也可以】</p> 
 <p>另外一种解决方案就是使用ThreadLocal，数据隔离，一个Thread会维护一个ThreadLocalMap，Map中就是数据键值对，key是弱引用在虚拟机栈，存在内存泄露、以及OOM等风险（Map在堆中），如果不手动清理remove，那么很有可能会泄露【线程结束，对象还是存在】</p> 
 <p>线程栈中的ThreadLocals是本地变量，所以Heap中的对象只有本线程才能访问，自然不存在安全问题；对于一个Local，每一个线程都是具有对应的资源副本， 只是注意OOM</p> 
 <p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-489iotDe-1669793698548)(https://tse1-mm.cn.bing.net/th/id/OIP-C.RJ0_VGu-qckeFW2DpLPMegHaEt?pid=ImgDet&amp;rs=1)]</p> 
</blockquote> 
<p>在ThreadLocal中存储当前线程使用的数据源，切面After之后需要清理，避免内存泄露，【当然进行主从分离可以使用成熟的Sharding-JDBC】</p> 
<pre><code class="prism language-java"> <span class="token operator">*</span> <span class="token constant">AOP</span>切面管理： 主写从读，读写分离
 <span class="token operator">*</span><span class="token operator">/</span>

<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceAop</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//读取类型的数据库</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* indv.cfeng.service..*.select*(..))"</span> <span class="token operator">+</span>
    <span class="token string">"||execution(* indv.cfeng.service..*.find*(..))"</span> <span class="token operator">+</span>
    <span class="token string">"||execution(* indv.cfeng.service..*.get*(..))"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"read only operate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* indv.cfeng.service..*.insert*(..))"</span> <span class="token operator">+</span>
    <span class="token string">"||execution(* indv.cfeng.service..*.add*(..))"</span> <span class="token operator">+</span>
    <span class="token string">"||execution(* indv.cfeng.service..*.delete*(..))"</span><span class="token operator">+</span>
    <span class="token string">"||execution(* indv.cfeng.service..*.update*(..))"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writePointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"write opreate,into masterdb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//Before</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"readPointcut()"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//当前线程设置为Slave数据源， 多台从机，需要进行负载均衡</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"writePointcut()"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//当前线程设置为Master数据源</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">"writePointcut(),readPointcut()"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//service操作结束需要清除本地线程的该对象，避免内存泄露OOM</span>
        <span class="token comment">//DBContextHolder.cleanAll();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="MySQL_Prometheus__Grafana_1164"></a>MySQL集群监控 Prometheus + Grafana</h2> 
<p>之前cfeng在SpringBoot部分就介绍过这个两个工具，结合进行可视化监控，功能强大</p> 
<p>Prometheus是开源的服务监控系统和时序数据库，K8s内部就使用该数据库，Prometheus数据访问快，具有高效的数据压缩算法，减少IO瓶颈</p> 
<p>可以部署监控服务器，提供7 * 24 监控； 问题预警、告警</p> 
<blockquote> 
 <p>Prometheus不依赖分布式存储，但服务器节点是自主的，通过中间网关支持push模型，支持多种多样的图表和界面展示 ： Grafana</p> 
</blockquote> 
<p>监控MySQL可以直接下载mysqld_exporter插件，安装启动后，重启Prometheus， 就可以看到Mysql信息</p> 
<p>安装Grafana后，配置DataSource为Prometheus，再自定义图标Graph，可视化监控mysql</p> 
<p>具体安装部署流程就不详细说明，这里只是给出集群监控的解决方案?</p> 
<h2>
<a id="_Sharding_1180"></a>分库分表 【Sharding】</h2> 
<p>随着数据库存储内容增加，比如成长为亿级数据的单表，就算主从复制也是无法很好的解决数据量过大的问题，此时就需要进行表切割，将过大的表切割存储在不同的MySQL节点中，以便存储更多的内容</p> 
<p>该问题的解决方案就是分库分表 ---- 对应的就是分布式微服务；</p> 
<p>单体项目比如DB中包含商品表，商家表，订单表， 拆分为微服务之后，数据库可能就变为商品服务的DB，商家服务的DB，订单服务的DB，数据库中存放的可能就是原始的大表拆分的多个小数据量的表（比如20W【offerCampus微服务项目就进行了分库分表 — 垂直分库，水平分表】</p> 
<h3>
<a id="_1188"></a>分库分表操作方式</h3> 
<p>分库分表的方式有很多：</p> 
<h4>
<a id="_1192"></a>垂直分表</h4> 
<p>比如商品表中包含： 名称、封面、价格、描述等信息字段， 垂直分表就是将表垂直切割，将字段进行划分</p> 
<p>比如划分为商品基础信息表： 名称、封面、价格 … ； 商品描述信息表： 描述…</p> 
<p>按照数据库的设计，如果是自然主键，那么二者只要对应的ID同，就可以进行信息的合并； 这样就划分成了两个表， 但是表的元组数量是不变的， 同时表的数量增加了，增加了IO</p> 
<p>为了减少表的数量，可以进行垂直分库</p> 
<h4>
<a id="_1202"></a>垂直分库</h4> 
<p>垂直分库就是将部分表划分到另外的数据库中，不同的数据库可能部署在不同的服务器；分库一般就是按照业务需求进行拆分，常见的比如商城系统，分为订单服务的订单DB、商家DB、商品DB…</p> 
<p>分库之后可以减少IO操作，提升访问效率</p> 
<h4>
<a id="_1208"></a>水平分库</h4> 
<p>垂直分库之后其实对应的就是不同的微服务，但是垂直划分，数据量还是很大，因为数据行不断增加，为解决这个问题，可以水平分库</p> 
<p>比如将商品DB划分为商品DB1，和商品DB2， 将商品ID为奇数的存进DB1,将商品ID为偶数的记录存入DB2， 这样原大数据量的数据库就变为两个1/2数据量的DB</p> 
<h4>
<a id="_1214"></a>水平分表</h4> 
<p>水平分库会导致数据库数量增加，可能会导致服务器数量需求增加，提高了硬件成本，运维不易</p> 
<p>除了水平分库，还可以水平分表，比如商品DB的商品表，按照ID奇偶性，划分为两个表商品1表，商品2表</p> 
<p>虽然增加了数据库中表的数量，但是单表的数据量减少，访问效率提升</p> 
<p><strong>水平拆分后的数据库表（相同逻辑和数据结构）的总称就是逻辑表</strong>，比如Order拆分的Order1，Order2，逻辑表就是Order</p> 
<p><strong>在分片的数据库中真实存在的物理表 ---- 真实表</strong>， 比如Order1，Order2，他们是真实存在的，而原来的Order逻辑表已经不存在了，被拆分了</p> 
<p><strong>数据分片的最小单元 ----- 数据节点</strong>，数据源名称 + 数据表组成，也就是在分库分表后的一张数据库表，比如水平拆分的数据库中的数据表： offershow-user1.sysUser0</p> 
<p><strong>所有数据源都存在的表 ---- 广播表</strong>，表结构、表中的数据在每一个数据库中都完全一致，适用于数据量不大但是与海量数据进行关联查询的表，比如数据字典表dict</p> 
<p><strong>分片规则一致的主表和子表为绑定表</strong>，比如垂直分表Order成Oder和Order_item，都是按照ID进行拆分，互为绑定关系，关联查询不会出现笛卡尔积关联</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> i<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> t_order o <span class="token keyword">join</span> t_order_item i <span class="token keyword">ON</span> o<span class="token punctuation">.</span>order_id <span class="token operator">=</span> i<span class="token punctuation">.</span>order_id <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>order_id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span> 
</code></pre> 
<p>主键查询一定要避免索引失效</p> 
<p>如果将这两张表进行水平分表，也就是说这两张表只是逻辑表，真实表如果各有2个，那就是t_order0,t_order1, t_order_item0,t_oreder_item1</p> 
<p>不配置绑定关系，那就是自由组合，路由的SQL一共4条： 2 * 2</p> 
<p>配置之后，真实表0和0组合，1和1组合 — 这也才符合要求</p> 
<h3>
<a id="_1244"></a>数据分片</h3> 
<p>分片Sharding是一种与水平切分相关的数据库架构模式。是数据库分区的一种，将大型数据库划分为更小、更快的部分，部分就是数据碎片。</p> 
<p><strong>用于分片的数据库字段就是分片键</strong>， 是将数据库表水平拆分的关键字段； 比如将Order订单按照ID尾数取模分片，则ID就是分片键，如果没有分片键，那么全路由，性能差；Sharding-JDBC支持多个字段分片</p> 
<h4>
<a id="_1250"></a>分片算法</h4> 
<p>通过分片算法依靠分片键将数据分片，支持=， &gt;=, &lt;=,BETWEEN和IN分片，分片算法可以自行实现， 分片算法和业务紧密关联，没有内置算法， 只是通过分片策略提供Interface</p> 
<p><strong>精确分片算法</strong>： 对应的就是PreciseSHardingAlgorithm， 用于处理使用单一字段作为分片键的 使用 =， 或者IN 进行分片， 配合StandardShardingStategy使用</p> 
<p><strong>范围分片算法</strong>: 对应的就是RangeShardingAlgorithm， 用于单一字段作为分片键的BETWEEN AND、 &gt; , &lt; , &gt;= , &lt;=， 配合StandardShardingStrategy使用</p> 
<p><strong>复合分片算法</strong>： 对应的ComplexKeysShardingAlgothm， 处理多个字段作为分片键， 需要自行实现相关的逻辑，配合ComplexShardingStrategy策略</p> 
<p><strong>Hint分片 算法</strong>： 对应的就是HintShardingAlgorithm， 处理通过Hint指定分片值而非从SQL提取分片值，配合HintShardingStrategy策略</p> 
<h4>
<a id="_1262"></a>分片策略</h4> 
<p>包含分片键和分片算法，真正用于分片操作的就是分片键 + 分片算法， 就是分片策略</p> 
<ul>
<li>标准分片策略 StandShardingStrategy： 也就是SQL语句中 =， &gt; =等分片操作支持，只支持单一字段作为分片键，算法包括精确分片算法和范围分片算法，**PreciseShardingAlgorithm是必选的，也就是精确算法，而范围算法可选</li>
<li>复合分片策略: ComplexShardingStrategy, 提供SQL的=， &gt; ， &lt; …等分片操作支持，支持多分片键，并未过多封装，需要手动实现</li>
<li>行表达式分片策略 InlineShardingStrategy： 使用Groovy表达式，对SQL中=和IN提供支持，支持单分片键，是精确分片算法的简易版</li>
<li>Hint分片策略： HintShardingStrategy， 通过Hint指定分片值，不是从SQL中提取分片值</li>
</ul> 
<p>分布式主键： 用于在分布式环境下生成全局唯一的id，Sharding-JDBC提供内置的分布式主键生成器，还提供主键生成器接口，为保证数据库性能，主键ID必须自增，避免造成数据页面分裂</p> 
<h3>
<a id="_problem_1273"></a>分库分表 的problem</h3> 
<p>分布式微服务分库分表，相较与单机项目，需要考虑 ：</p> 
<ul>
<li>分布式事务解决方案</li>
<li>跨界点连接查询（分页、排序…)</li>
<li>多数据源的管理 【集群可用性】</li>
</ul> 
<p>可以借助第三方的工具作为解决方案，比如Seata，Sharding-JDBC、MHA， 连接查询则可以进行服务调用再补填【外键会失效】</p> 
<p>集群高可用可以使用MHA，或者HAProxy</p> 
<p>HAProxy是C编写，提供高可用性、负载均衡、基于TCP和HTTP的服务代理，HAProxy运行在当前硬件上，可以支持数万的并发连接，保护Web服务器不暴露到网络中</p> 
<p>除此之外，还有许多高可用架构方案： 比如Nginx、LVX、Keepalived…</p> 
<p>Keepalived + HAProxy + MySQL： 基于HAProxy和Keepalived负载均衡，容易发生<code>脑裂</code> — 联系两个节点的心跳线断开，整体HA系统会分裂为两个独立服务，互相认为对方故障，争夺资源，导致故障</p> 
<h3>
<a id="ShardingJDBC___1291"></a>Sharding-JDBC 数据分片，读写分离</h3> 
<p>Sharding-JDBC不是用来进行分库分表的，主要是进行数据分片和读写分离，通过sql语义分析，将读操作和写操作分别路由到主、从DB（就是上面的AOP），主要就是提供透明化的读写分离</p> 
<p>主要就是简化了读写分离和数据源管理的操作【原生方式需要AOP】</p> 
<p>提供一主多从的架构，配合分库分表，同一线程同一数据库连接，如果包含写操作，那么之后的读操作都直接从主库读取【Connection为重量级对象，切换浪费时间， 同时保证数据的一致性 — 同步有一定延迟】，事务的读写使用主库</p> 
<h2>
<a id="Shardingjdbc_1299"></a>Sharding-jdbc使用</h2> 
<p>Sharing-JDBC主要就是解析配置文件，进行SQL解析、优化、路由、改写， 之后将结果集汇总返回客户端。</p> 
<p>Sharding-JDBC就是一个增强的JDBC(JDBC的编程6步：Datasource、Connection、Statement(PS)、ResultSet)， 而Sharding-jdbc实现了上面几个接口 ： ShardingDatasource、ShardingConnection、ShardingStatement（PS）、ShardingResultSet</p> 
<p>通过ShardingDataSource获取到一个ShardingConnection</p> 
<pre><code class="prism language-java"><span class="token class-name">DatasourceUtil</span><span class="token punctuation">.</span><span class="token function">fetchConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Connection</span> con <span class="token operator">=</span> dataSoure<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>基于这个ShardingConnection，可以获取ShardingPS对象</p> 
<pre><code class="prism language-java">stmt <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>connetion<span class="token punctuation">,</span>transaction<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>SQL执行handler.query(stmt, resultHandler)，返回结果集</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Statement</span> statement<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">PrepareStatement</span> ps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> statement<span class="token punctuation">;</span>
    ps<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resultSetHandler<span class="token punctuation">.</span><span class="token function">handleResultSets</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行的核心的ps的execute()方法，其中执行了clear、prepare等</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">clearPrevious</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initPrepareStatementExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> preparedStatementExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">clearBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在prepare()方法中，prepareEngine.prepare会调用Route执行路由</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">RouteContext</span> <span class="token function">executeRoute</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> clonedParamenters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerRouteDecorator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span>sql<span class="token punctuation">,</span>cloneParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Sharding-jdbc的执行过程： SQL解析 =&gt; 执行器优化 =&gt; SQL路由 =&gt; SQL改写 =&gt; SQL执行 =&gt; 结果归并</p> 
<p><img src="https://images2.imgbox.com/6a/10/6O6hIS7W_o.jpg" alt="img"></p> 
<ul>
<li>SQL解析： 主要就是词法解析和语法解析，比如一个SQL，分析select等判断是什么类型，Shrading-jdbc之前使用Druid作为解析引擎，1.5之后使用自研的</li>
<li>执行器优化： 这和原生的MySQL的优化器一样，会对SQL进行优化，比如联合索引的顺序会自动调整…</li>
<li>SQL路由： 也就是根据分片的规则配置解析上下文的分片条件，将SQL定位到真正的数据源，分为直接路由（Hint）、简单路由、笛卡尔积路由 【分片路由和广播路由】 其实就是之前的AOP，会解析出相关的执行行为和分片键值路由到对应的数据库</li>
</ul> 
<p><img src="https://images2.imgbox.com/ec/5d/CVL9cemt_o.png" alt="img"></p> 
<p>其实就是数据库是否分片，如果没有进行分片，那么就是广播路由，只需要将其路由到master或者slave， 如果进行分片，那么需要判断是单表或者绑定表…</p> 
<ul>
<li>SQL改写 ： 因为程序中的SQL语句是逻辑表名，而实际是分片存储的，所以需要将SQL逻辑表改为真实表，同时会优化分页查询</li>
<li>SQL执行： 改写完成就能够正确执行，因为可能会链接多个数据源（集群），所以Sharding-JDBC使用多线程方式执行SQL</li>
<li>结果归并： 从各数据节点中获取结果后，进行数据的封装，分页、排序…</li>
</ul> 
<p>要在项目中使用Sharding-jdbc，需要引入相关的starter</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sharding-jdbc-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${sharding.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>其他的依赖比如mysql、druid、mybatis-plus等引入即可</p> 
<h3>
<a id="_1381"></a>数据源配置</h3> 
<p>如果数据源使用sharding配置，那么会自动将数据源注入到spring容器</p> 
<p>也就是直接使用shardingsphere进行配置，但是一般项目都是直接配置的数据源，没有使用shardingsphere配置，这个时候，需要禁用sharding的自动装配，改写数据源配置</p> 
<p>启动类上面exclude自动装配</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shardingsphere<span class="token punctuation">.</span>shardingjdbc<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span>SpringBootConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XXXX</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p>之后定义一个Datasource的配置类，将数据源改写为Sharding</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringBootShardingRuleConfigurationProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token class-name">SpringBootMasterSlaveRuleConfigurationProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">SpringBootEncryptRuleConfigurationProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">SpringBootPropertiesConfigurationProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureBefore</span><span class="token punctuation">(</span><span class="token class-name">DataSourceConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceConfig</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SpringBootShardingRuleConfigurationProperties</span> shardingRule<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SpringBootPropertiesConfigurationProperties</span> props<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"shardingDataSource"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">ShardingRuleCondition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">shardingDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取其它方式配置的数据源</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DruidDataSourceWrapper</span><span class="token punctuation">&gt;</span></span> beans <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">DruidDataSourceWrapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> dataSourceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        beans<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dataSourceMap<span class="token operator">::</span><span class="token function">put</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建shardingDataSource</span>
        <span class="token keyword">return</span> <span class="token class-name">ShardingDataSourceFactory</span><span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span>dataSourceMap<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ShardingRuleConfigurationYamlSwapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>shardingRule<span class="token punctuation">)</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span><span class="token function">getProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">sqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SqlSessionFactoryBean</span> sqlSessionFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将shardingDataSource设置到SqlSessionFactory中</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span><span class="token function">shardingDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 其它设置</span>
        <span class="token keyword">return</span> sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>自定义分布式ID生成器</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeqShardingKeyGenerator</span> <span class="token keyword">implements</span> <span class="token class-name">ShardingKeyGenerator</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"SEQ"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// 获取分布式id逻辑</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="__sharding_1457"></a>分片策略配置 – 完整配置，使用sharding</h3> 
<p>也就是分片之后，要进行正确的路由，或者进行主从的路由</p> 
<p>这里演示的数据源直接就使用Sharding配置</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
<span class="token comment">#    driver-class-name: com.mysql.jdbc.Driver</span>
<span class="token comment">#    url: jdbc:mysql://127.0.0.1:3306/yiciyu?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;useSSL=false&amp;zeroDateTimeBehavior=convertToNull</span>
<span class="token comment">#    username: root</span>
<span class="token comment">#    password: 123456</span>

<span class="token comment">## 需要druid监控页面</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
    <span class="token key atrule">druid</span><span class="token punctuation">:</span>
      <span class="token key atrule">stat-view-servlet</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">loginUsername</span><span class="token punctuation">:</span> admin
        <span class="token key atrule">loginPassword</span><span class="token punctuation">:</span> <span class="token number">123456</span>
      <span class="token key atrule">web-stat-filter</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 
<span class="token comment"># 使用sharding配置数据源，同时配置多个，names指定即可，比如主从，或者分片</span>
  <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token comment">##common配置，不需要放在druid中</span>
       <span class="token key atrule">common</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
        <span class="token key atrule">initial-size</span><span class="token punctuation">:</span> <span class="token number">6</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">3</span>
        <span class="token key atrule">maxActive</span><span class="token punctuation">:</span> <span class="token number">20</span>
        <span class="token comment"># 配置获取连接等待超时的时间</span>
        <span class="token key atrule">maxWait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
        <span class="token comment"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span>
        <span class="token key atrule">timeBetweenEvictionRunsMillis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
        <span class="token comment"># 配置一个连接在池中最小生存的时间，单位是毫秒</span>
        <span class="token key atrule">minEvictableIdleTimeMillis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
        <span class="token comment">#Oracle需要打开注释</span>
        <span class="token comment">#validationQuery: SELECT 1 FROM DUAL</span>
        <span class="token key atrule">testWhileIdle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">testOnBorrow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">testOnReturn</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token comment"># 打开PSCache，并且指定每个连接上PSCache的大小</span>
        <span class="token key atrule">poolPreparedStatements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">maxPoolPreparedStatementPerConnectionSize</span><span class="token punctuation">:</span> <span class="token number">20</span>
        <span class="token comment"># 配置监控统计拦截的filters，去掉后监控界面sql无法统计，'wall'用于防火墙</span>
        <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat<span class="token punctuation">,</span>wall<span class="token punctuation">,</span>slf4j
        <span class="token comment"># 通过connectProperties属性来打开mergeSql功能；慢SQL记录</span>
        <span class="token key atrule">connectionProperties</span><span class="token punctuation">:</span> druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000
        <span class="token key atrule">wall</span><span class="token punctuation">:</span>
          <span class="token key atrule">multi-statement-allow</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
   <span class="token comment">#配置分片数据源</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span> ds0<span class="token punctuation">,</span>ds1
      <span class="token key atrule">ds0</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/sharding_db_0<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;useSSL=false&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
      <span class="token key atrule">ds1</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3308/sharding_db_1<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;useSSL=false&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
 <span class="token comment">##配置分片路由的策略或者数据节点选择， 使用tables指定具体的数据库表</span>
    <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
      <span class="token key atrule">tables</span><span class="token punctuation">:</span>
        <span class="token key atrule">XXX</span><span class="token punctuation">:</span> 
          <span class="token key atrule">actual-data-nodes</span><span class="token punctuation">:</span> msds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{<!-- --></span>0..1<span class="token punctuation">}</span>.XXX$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{<!-- --></span>0..1<span class="token punctuation">}</span>
          <span class="token key atrule">database-strategy</span><span class="token punctuation">:</span>
            <span class="token key atrule">inline</span><span class="token punctuation">:</span>
              <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> merchant_id
              <span class="token comment">#计算方式：value % [库数]</span>
              <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> msds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{<!-- --></span>merchant_id % 2<span class="token punctuation">}</span>
          <span class="token key atrule">table-strategy</span><span class="token punctuation">:</span>
            <span class="token key atrule">inline</span><span class="token punctuation">:</span>
              <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> merchant_id
              <span class="token comment">#计算方式：value / [库数] % [表数]，示例中仅通过merchant_id后两位路由，为保障</span>
              <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> cms_merchant_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{<!-- --></span>((int) (Integer.parseInt(Long.toString(merchant_id).substring(1)) / 2)) % 2<span class="token punctuation">}</span>
      <span class="token comment">#可缺省，缺省时走单库方式, 配置主从架构，指定master数据源，和slave数据源节点</span>
      <span class="token key atrule">master-slave-rules</span><span class="token punctuation">:</span>
        <span class="token key atrule">msds0</span><span class="token punctuation">:</span>
          <span class="token key atrule">master-data-source-name</span><span class="token punctuation">:</span> ds0
          <span class="token key atrule">slave-data-source-names</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> ds0
          <span class="token punctuation">-</span> ds0
        <span class="token key atrule">msds1</span><span class="token punctuation">:</span>
          <span class="token key atrule">master-data-source-name</span><span class="token punctuation">:</span> ds1
          <span class="token key atrule">slave-data-source-names</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> ds1
          <span class="token punctuation">-</span> ds1
              
          
    
<span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span>  classpath<span class="token punctuation">:</span>mapper/<span class="token important">**/*.xml</span>
  <span class="token key atrule">type-aliases-package</span><span class="token punctuation">:</span> com.yiciyu.<span class="token important">*.entity</span><span class="token punctuation">,</span>com.yiciyu.<span class="token important">*.model</span>
  <span class="token key atrule">global-config</span><span class="token punctuation">:</span>
    <span class="token key atrule">db-config</span><span class="token punctuation">:</span>
      <span class="token key atrule">id-type</span><span class="token punctuation">:</span> auto
      <span class="token key atrule">table-underline</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<p>这里注意，数据源使用sharding配置，Druid又会报错，需要将Druid的数据源自动装配给exclude</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">autoconfigure</span><span class="token punctuation">:</span>
    <span class="token key atrule">exclude</span><span class="token punctuation">:</span> com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure
</code></pre> 
<p>同时引入将自动配置排除了，所以监控页面可能显示不出，显示的核心类为DruidDynamicDataSourceConfiguration， 其上的注解会Import DruidWebStatFilterConfiguration</p> 
<p>将这个类复制出来，自定义名称，主要是Import上面Filter</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">DruidDataSourceAutoConfigure</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">DruidStatProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DruidSpringAopConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token class-name">DruidStatViewServletConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token class-name">DruidWebStatFilterConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token class-name">DruidFilterConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DruidShardingJdbcDataSourceConfiguration</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在项目中的代码正常编写即可</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
	<span class="token keyword">void</span> <span class="token function">multQueryTests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//inline不支持range（即between、大于小于等范围查询）</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MerchantEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> merchantDao<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MerchantEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">"merchant_id"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">100L</span><span class="token punctuation">,</span> <span class="token number">101L</span><span class="token punctuation">,</span> <span class="token number">102L</span><span class="token punctuation">,</span> <span class="token number">103L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"list==="</span> <span class="token operator">+</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>也就是正常按照Mybatis-plus之前的格式编写接口，Sharding-JDBC就是为了进行透明化操作，需要链接数据库时，或自动AOP?</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>