<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>高通音频架构（三） - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">高通音频架构（三）</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <h2>
<a id="Kernel_0"></a>一、Kernel层</h2> 
<p>音频由于其特殊的工作，使得它的结构特别的复杂，而且在自己的结构基础上还引入了ALSA架构，不过在android系统上所引入的并非完整的ALSA架构而是精简版的tinyalsa，但是就算精简版也是内容相当丰厚。除此，音频还拥有自己的单独的处理器ADSP以及独立的电源管理系统DAPM(便携式动态音频电源管理），使得音频在任何时候都是以最低功耗运行，降低了便携设备的功耗。在某些播放场景甚至不需要CPU的介入，比如接打电话的通过音频，如果手机处于休眠可以不需要唤醒CPU直接传递语音数据。要想知道整个过程中音频数据的流转需要一步步去了解，音频架构中所涉及到的各个部分，缺一环则不可，先看看ALSA架构。</p> 
<p><img src="https://images2.imgbox.com/0c/17/JuLGOxpJ_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="_ALSA_6"></a>二、 ALSA</h2> 
<p>Advanced Linux Sound Architecture 高级Linux音频架构，对于android系统来说其实用的只是一个精简版的ALSA架构，有一部分ALSA的接口是放在用户空间，供上层调用来接通kernel</p> 
<p>根据音频数据的流向再把音频内核分为以下三个层次：</p> 
<ul>
<li>tinyAlsa</li>
<li>ALSA Core</li>
<li>ASoC</li>
</ul> 
<h3>
<a id="21_Tinyalsa_16"></a>2.1 Tinyalsa</h3> 
<p>ALSA lib的源码地址在：external/tinyalsa目录下，其中包含：tinyplay/tinycap/tinymix，这些是供用户空间之间调用的alsa接口，用来播放、录音及控制。并且它们的代码非常的简单，其主要功能是解耦，方便调试，这里不做过多赘述。</p> 
<h3>
<a id="22_ALSA_CORE_19"></a>2.2 ALSA CORE</h3> 
<p>ASLA核心他的主要代码是在kernel/msm-x.xx/sound/core，alsa 核心层，向上提供逻辑设备（PCM / CTL / MIDI / TIMER /…）系统调用，向下驱动硬件设备（ Machine / I2S / DMA / CODEC ）</p> 
<h3>
<a id="23_ASoc_22"></a>2.3 ASoc</h3> 
<p>ASoc（ALSA system on chip） 是建立在标准 alsa core 基础上，为了更好支持嵌入式系统和应用于移动设备的音频 codec 的一套软件体系。主要代码存在于：vendor/qcom/opensource/audio-kernel，kernel/msm-x.xx/sound</p> 
<p>ASoC被分为Machine、Platform和Codec三大部分。<br> 其中的Machine驱动负责Platform和Codec之间的耦合和设备或板子特定的代码。</p> 
<p>Platform驱动 的主要作用是完成音频数据的管理，最终通过CPU的数字音频接口（DAI）把音频数据传送给Codec进行处理，最终由Codec输出驱动耳机或者是喇叭的音信信号。</p> 
<ul>
<li> <p>Machine</p> 
  <ul>
<li> <p>用于描述设备组件信息和特定的控制如耳机/外放等。</p> </li>
<li> <p>Machine是指某一款机器，可以是某款设备，某款开发板，又或者是某款智能手机，由此可以看出Machine几乎是不可重用的，每个Machine上的硬件实现可能都不一样，CPU不一样，Codec不一样，音频的输入、输出设备也不一样，Machine为CPU、Codec、输入输出设备提供了一个载体。</p> </li>
<li> <p>Machine 这一部分将平台驱动和 Codec 驱动绑定在一起，描述了板级的硬件特征。<br> 主要负责 Platform 和 Codec 之间的耦合以及部分和设备或板子特定的代码。<br> Machine驱动负责处理机器特有的一些控件和音频事件（例如，当播放音频时，需要先行打开一个放大器）；</p> </li>
<li> <p>单独的 Platform 和 Codec 驱动是不能工作的，它必须由 Machine 驱动把它们结合在一起才能完成整个设备的音频处理工作。</p> </li>
<li> <p>ASoC 的一切都从 Machine 驱动开始，包括声卡的注册，绑定 Platform 和 Codec 驱动等等。</p> </li>
</ul> </li>
<li> <p>Platform</p> 
  <ul>
<li> <p>用于实现平台相关的DMA驱动和音频接口等。</p> </li>
<li> <p>Platform 一般是指某一个SoC平台，比如 pxaxxx,s3cxxxx,omapxxx 等等，与音频相关的通常包含该 SoC 中的时钟、DMA、I2S、PCM等等，只要指定了 SoC，那么我们可以认为它会有一个对应的 Platform，它只与 SoC 相关，与 Machine 无关，这样我们就可以把 Platform 抽象出来，使得同一款 SoC 不用做任何的改动，就可以用在不同的 Machine 中。实际上，把 Platform 认为是某个 SoC 更好理解。</p> </li>
<li> <p>这一部分只关心CPU本身，不关心Codec。<br> 主要处理两个问题：DMA引擎 和 SoC集成的PCM、I2S或AC ‘97数字接口控制。<br> 主要作用是完成音频数据的管理，最终通过CPU的数字音频接口（DAI）把音频数据传送给Codec进行处理，最终由Codec输出驱动耳机或者是喇叭的音信信号。</p> </li>
<li> <p>在具体实现上，ASoC 有把 Platform 驱动分为两个部分：snd_soc_platform_driver 和 snd_soc_dai_driver。</p> </li>
<li> <p>其中，platform_driver 负责管理音频数据，把音频数据通过dma或其他操作传送至cpu dai中，dai_driver则主要完成cpu一侧的dai的参数配置，同时也会通过一定的途径把必要的dma等参数与snd_soc_platform_driver进行交互。</p> </li>
</ul> </li>
<li> <p>Codec</p> 
  <ul>
<li> <p>用于实现平台无关的功能，如寄存器读写接口，音频接口，各widgets的控制接口和DAPM的实现等。</p> </li>
<li> <p>字面上的意思就是编解码器，Codec里面包含了I2S接口、D/A、A/D、Mixer、PA（功放），通常包含多种输入（Mic、Line-in、I2S、PCM）和 多个输出（耳机、喇叭、听筒，Line-out），Codec和Platform一样，是可重用的部件，同一个 Codec 可以被不同的Machine使用。嵌入式 Codec 通常通过I2C对内部的寄存器进行控制。</p> </li>
<li> <p>这一部分只关心 Codec 本身，与 CPU 平台相关的特性不由此部分操作。</p> </li>
<li> <p>在移动设备中，Codec 的作用可以归结为4种，分别是：<br> 1. 对 PCM 等信号进行 D/A 转换，把数字的音频信号转换为模拟信号。<br> 2. 对Mic、Linein或者其他输入源的模拟信号进行A/D转换，把模拟的声音信号转变CPU能够处理的数字信号。<br> 3. 对音频通路进行控制，比如播放音乐，收听调频收音机，又或者接听电话时，音频信号在codec内的流通路线是不一样的。<br> 4. 对音频信号做出相应的处理，例如音量控制，功率放大，EQ控制等等。</p> </li>
<li> <p>ASoC 对 Codec 的这些功能都定义好了一些列相应的接口，以方便地对Codec进行控制。<br> ASoC 对 Codec 驱动的一个基本要求是：驱动程序的代码必须要做到平台无关性，以方便同一个 Codec 的代码不经修改即可用在不同的平台上。</p> </li>
</ul> </li>
<li> <p>DAPM</p> 
  <ul>
<li> <p>DAPM是Dynamic Audio Power Management的缩写，直译过来就是动态音频电源管理的意思，</p> </li>
<li> <p>DAPM是为了使基于linux的移动设备上的音频子系统，在任何时候都工作在最小功耗状态下。<br> DAPM对用户空间的应用程序来说是透明的，所有与电源相关的开关都在ASoc core中完成。<br> 用户空间的应用程序无需对代码做出修改，也无需重新编译，DAPM根据当前激活的音频流（playback/capture）和声卡中的mixer等的配置来决定那些音频控件的电源开关被打开或关闭。</p> </li>
</ul> </li>
<li> <p>DPCM ：Dynamic PCM</p> </li>
</ul> 
<p><img src="https://images2.imgbox.com/45/70/AK9GrmlW_o.png" alt="在这里插入图片描述"></p> 
<p>ASoC对于Alsa来说，就是分别注册PCM/CONTROL类型的snd_device设备，并实现相应的操作方法集。<br> 图中DAI是数字音频接口，用于配置音频数据格式等。</p> 
<p>☁ Codec 驱动 向 ASoC 注册 snd_soc_codec 和 snd_soc_dai 设备。<br> ☁ Platform 驱动 向 ASoC 注册 snd_soc_platform 和 snd_soc_dai 设备。<br> ☁ Machine 驱动通过 snd_soc_dai_link 绑定 codec / dai / platform 。</p> 
<p>Widget是各个组件内部的小单元。处在活动通路上电，不在活动通路下电。ASoC的DAPM正是通过控制这些Widget的上下电达到动态电源管理的效果。</p> 
<p>☁ path描述与其它widget的连接关系。<br> ☁ event用于通知该widget的上下电状态。<br> ☁ power指示当前的上电状态。<br> ☁ control实现空间用户接口用于控制widget的音量/通路切换等。</p> 
<p>以上的内容可以对ALSA有个简单的了解，如果想要更深入的了解需要自行查找相关资料学习。那么我们知道了音频内核的组成，众所周知一台机器要想发出声音需要有声卡才行，声卡是我们音频中的核心，既然如此重要那么声卡和上面说的machine、platform和codec它们几者的关系如何呢？它们又是怎样开始工作的呢？接下来就来探究一下声卡的注册流程</p> 
<h2>
<a id="_101"></a>三、声卡的注册流程</h2> 
<p>ASoC 的一切都从 Machine 驱动开始，包括声卡的注册，绑定 Platform 和 Codec 驱动等等。先看下machine的注册：</p> 
<p>根据平台的不同machine代码存放的位置也有所差异，我们当前所看的machine所在位置在：vendor/qcom/opensource/audio-kernel/asoc/kona.c</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> kona_asoc_machine_of_match<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"qcom,kona-asoc-snd"</span><span class="token punctuation">,</span>
      <span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">"codec"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"qcom,kona-asoc-snd-stub"</span><span class="token punctuation">,</span>
      <span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">"stub_codec"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> kona_asoc_machine_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> DRV_NAME<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>pm <span class="token operator">=</span> <span class="token operator">&amp;</span>snd_soc_pm_ops<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> kona_asoc_machine_of_match<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>suppress_bind_attrs <span class="token operator">=</span> true<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>probe <span class="token operator">=</span> msm_asoc_machine_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> msm_asoc_machine_remove<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">module_platform_driver</span><span class="token punctuation">(</span>kona_asoc_machine_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>machine 在开机时被注册为platform_driver，当匹配到"qcom,kona-asoc-snd"的device会执行probe，我们直接看</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">msm_asoc_machine_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_soc_card</span> <span class="token operator">*</span>card <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msm_asoc_mach_data</span> <span class="token operator">*</span>pdata <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mbhc_audio_jack_type <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    uint index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span>lpass_audio_hw_vote <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
 
    <span class="token function">dev_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s : enter!n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: No platform supplied from device treen"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"msm_asoc_machine_proben"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pdata <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>
            <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msm_asoc_mach_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pdata<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
 
    <span class="token function">of_property_read_u32</span><span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">,</span>
                <span class="token string">"qcom,lito-is-v2-enabled"</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>pdata<span class="token operator">-&gt;</span>lito_v2_enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 找到所有的dailink，并把他们都保存到card中，这些dailink大部分是写死在当前文件中</span>
    card <span class="token operator">=</span> <span class="token function">populate_snd_card_dailinks</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>     
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>card<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: Card uninitializedn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_aw882xx_i2c_probe_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: aw pa never probe"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    card<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
    <span class="token function">platform_set_drvdata</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> card<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">snd_soc_card_set_drvdata</span><span class="token punctuation">(</span>card<span class="token punctuation">,</span> pdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    ret <span class="token operator">=</span> <span class="token function">snd_soc_of_parse_card_name</span><span class="token punctuation">(</span>card<span class="token punctuation">,</span> <span class="token string">"qcom,model"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: parse card name failed, err:%dn"</span><span class="token punctuation">,</span>
            <span class="token constant">__func__</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 解析设备树中的路由</span>
    ret <span class="token operator">=</span> <span class="token function">snd_soc_of_parse_audio_routing</span><span class="token punctuation">(</span>card<span class="token punctuation">,</span> <span class="token string">"qcom,audio-routing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: parse audio routing failed, err:%dn"</span><span class="token punctuation">,</span>
            <span class="token constant">__func__</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 解析每个dailink中，platform、cpu、codec相应的phandle</span>
    ret <span class="token operator">=</span> <span class="token function">msm_populate_dai_link_component_of_node</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    ret <span class="token operator">=</span> <span class="token function">msm_init_aux_dev</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> card<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token comment">// 注册声卡，这里调用到了soc-core.c中</span>
    ret <span class="token operator">=</span> <span class="token function">devm_snd_soc_register_card</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> card<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>codec_reg_done<span class="token punctuation">)</span>
            ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: snd_soc_register_card failed (%d)n"</span><span class="token punctuation">,</span>
            <span class="token constant">__func__</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">dev_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: Sound card %s registeredn"</span><span class="token punctuation">,</span>
         <span class="token constant">__func__</span><span class="token punctuation">,</span> card<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
err<span class="token operator">:</span>
    <span class="token function">devm_kfree</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> pdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在machine的probe中主要是在解析设备树，然后还有整合所有的dailink，这些dailink分别保存在多个dailink数组中，创建了snd_soc_card，还有将各个platform、cpu、codec的phandle解析出来，注册声卡的过程却没有体现，那么再到soc-core.c中去看看注册声卡的过程，在machine调用devm_snd_soc_register_card之后到了soc-devres.c中</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">devm_snd_soc_register_card</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">snd_soc_card</span> <span class="token operator">*</span>card<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_soc_card</span> <span class="token operator">*</span><span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
 
    ptr <span class="token operator">=</span> <span class="token function">devres_alloc</span><span class="token punctuation">(</span>devm_card_release<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptr<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
 
    ret <span class="token operator">=</span> <span class="token function">snd_soc_register_card</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>ptr <span class="token operator">=</span> card<span class="token punctuation">;</span>
        <span class="token function">devres_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">devres_free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接着直接调用了soc-core.c中的snd_soc_register_card，这个过程很长简单列举一下流程</p> 
<pre><code class="prism language-c">    声卡注册流程
    <span class="token function">devm_snd_soc_register_card</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">+</span> <span class="token function">snd_soc_register_card</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">+</span> <span class="token function">snd_soc_bind_card</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">+</span> <span class="token function">snd_soc_instantiate_card</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token function">for_each_card_links</span><span class="token punctuation">(</span>card<span class="token punctuation">,</span> dai_link<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token operator">|</span>   <span class="token function">soc_bind_dai_link</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 绑定dai link</span>
          <span class="token operator">|</span>     <span class="token operator">+</span> <span class="token function">snd_soc_find_dai</span><span class="token punctuation">(</span>dai_link<span class="token operator">-&gt;</span>cpus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// cpus dai匹配，</span>
          <span class="token operator">|</span>     <span class="token operator">|</span>   <span class="token operator">+</span> <span class="token function">snd_soc_is_matching_component</span><span class="token punctuation">(</span>dlc<span class="token punctuation">,</span> component<span class="token punctuation">)</span> <span class="token comment">// 先匹配of_node</span>
          <span class="token operator">|</span>     <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token comment">// 然后如果dai_name不为空，比较组件驱动名字和dai_link中cpu_dai_name</span>
          <span class="token operator">|</span>     <span class="token operator">|</span>   <span class="token operator">+</span> strcmp（<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> dlc<span class="token operator">-&gt;</span>dai_name<span class="token punctuation">)</span>
          <span class="token operator">|</span>     <span class="token operator">+</span> <span class="token function">for_each_link_codecs</span><span class="token punctuation">(</span>dai_link<span class="token punctuation">,</span> i<span class="token punctuation">,</span> codec<span class="token punctuation">)</span> <span class="token comment">// codec dai匹配</span>
          <span class="token operator">|</span>     <span class="token operator">+</span> <span class="token function">for_each_link_platforms</span><span class="token punctuation">(</span>dai_link<span class="token punctuation">,</span> i<span class="token punctuation">,</span> platform<span class="token punctuation">)</span> <span class="token comment">// platform dai匹配</span>
          <span class="token operator">|</span>     <span class="token operator">|</span>
          <span class="token operator">|</span>     <span class="token operator">+</span> <span class="token function">soc_add_pcm_runtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 将rtd-&gt;list加入到card-&gt;rtd_list里，</span>
          <span class="token operator">|</span>        <span class="token operator">+</span> rtd<span class="token operator">-&gt;</span>num <span class="token operator">=</span> card<span class="token operator">-&gt;</span>num_rtd<span class="token punctuation">;</span> <span class="token comment">// 设备号，该num即为我们例子里的54</span>
          <span class="token operator">|</span>        <span class="token operator">+</span> card<span class="token operator">-&gt;</span>num_rtd<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 声卡的运行时例+1</span>
          <span class="token operator">+</span> <span class="token punctuation">}</span>
          <span class="token operator">+</span> <span class="token function">snd_card_register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">|</span> <span class="token operator">+</span> <span class="token function">snd_device_register_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">|</span>   <span class="token operator">+</span> <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>card<span class="token operator">-&gt;</span>devices<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token function">__snd_device_register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">|</span>   <span class="token operator">|</span>     <span class="token operator">+</span> dev<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span><span class="token function">dev_register</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 遍历注册设备</span>
          <span class="token operator">+</span>   <span class="token operator">+</span> <span class="token punctuation">}</span>
</code></pre> 
<p>在声卡注册过程中会根据machine给过来的dailink信息，把相应的cpu_dai、codec_dai和platform绑定在一起储存在一个snd_soc_pcm_runtime中，然后以rtd_list形式存在card 中。snd_card_new时创建/dev/snd/controlX节点，snd_card_register遍历注册为/dev/snd/(pcmCXDXp/pcmCXDXc)</p> 
<p>声卡注册过程是从machine开始，然后建立各个节点结束，controlX主要是控制节点，而pcmCXDXp/pcmCXDXc这两个节点是数据节点，一般控制节点有且只有一个而数据节点会有多个，并且是p/c成对的，p代表是playback，c代表capture。声卡注册完之后，那么音频需要使用到的软件部分都基本就绪，就可以开始播放声音了</p> 
<h2>
<a id="HALkernel_273"></a>四、数据从HAL到kernel</h2> 
<p>以我们手机系统播放手机铃声为例，在播放手机铃声的过程体现在tinyalsa的步骤大概如下：</p> 
<blockquote> 
 <ol>
<li>pcm_open</li>
<li>pcm_prepare</li>
<li>pcm_start</li>
<li>pcm_write</li>
</ol> 
</blockquote> 
<p>pcm_open:打开/dev/snd/pcmCxDxp 节点，然后获取pcm信息，对应节点的file_operations如下，后面简称fops，代码在kernel 下面pcm_native.c:<br> 折叠源码</p> 
<pre><code class="prism language-c"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> snd_pcm_f_ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span>        THIS_MODULE<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>write <span class="token operator">=</span>        snd_pcm_write<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>write_iter <span class="token operator">=</span>       snd_pcm_writev<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>open <span class="token operator">=</span>         snd_pcm_playback_open<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>release <span class="token operator">=</span>      snd_pcm_release<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>llseek <span class="token operator">=</span>       no_llseek<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>poll <span class="token operator">=</span>         snd_pcm_poll<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span>   snd_pcm_ioctl<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>compat_ioctl <span class="token operator">=</span>     snd_pcm_ioctl_compat<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>mmap <span class="token operator">=</span>         snd_pcm_mmap<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>fasync <span class="token operator">=</span>       snd_pcm_fasync<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>get_unmapped_area <span class="token operator">=</span>    snd_pcm_get_unmapped_area<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>owner <span class="token operator">=</span>        THIS_MODULE<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>read <span class="token operator">=</span>         snd_pcm_read<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>read_iter <span class="token operator">=</span>        snd_pcm_readv<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>open <span class="token operator">=</span>         snd_pcm_capture_open<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>release <span class="token operator">=</span>      snd_pcm_release<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>llseek <span class="token operator">=</span>       no_llseek<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>poll <span class="token operator">=</span>         snd_pcm_poll<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span>   snd_pcm_ioctl<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>compat_ioctl <span class="token operator">=</span>     snd_pcm_ioctl_compat<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>mmap <span class="token operator">=</span>         snd_pcm_mmap<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>fasync <span class="token operator">=</span>       snd_pcm_fasync<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>get_unmapped_area <span class="token operator">=</span>    snd_pcm_get_unmapped_area<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>可以看到每个pcm节点对应了两套fops，一个是播放一个是录制，当节点被打开时触发open函数，整个过程比较长简单表示如下:</p> 
<pre><code class="prism language-c">snd_pcm_playback_open
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>snd_lookup_minor_data <span class="token comment">// 查找对应从设备号及类型的pcm</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>snd_pcm_open <span class="token comment">// 打开pcm</span>
     <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                snd_pcm_open_file
                <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>snd_pcm_open_substream <span class="token comment">// 打开pcm的子流</span>
                    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token function">dpcm_fe_dai_open</span><span class="token punctuation">(</span>substream<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span>open<span class="token punctuation">)</span>
                        <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>dpcm_path_get
                        <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>dpcm_process_paths
                            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>dpcm_add_paths
                            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token operator">-&gt;</span>num_widgets<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                                <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>dpcm_get_be <span class="token comment">// 获取be</span>
                                <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>dpcm_be_connect <span class="token comment">// fe 和 be链接</span>
                                <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
</code></pre> 
<p>在pcm节点被打开时，首先会在内存中搜寻之前建立pcm时保存的pcm实例，然后获取该pcm对应的be 和fe，这里涉及到的fe表示前端，be表示后端，这是在DPCM中提出的概念，获取了相应的fe 和be之后将其链接</p> 
<p>pcm_prepare:是向kernel中发送了SNDRV_PCM_IOCTL_PREPARE指令对应触发kernel中pcm_compat.c 函数snd_pcm_ooctl_compat:</p> 
<pre><code class="prism language-c">snd_pcm_ioctl_compat
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>snd_pcm_common_ioctl
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>snd_pcm_prepare
 
<span class="token comment">// 三个函数调用直接到snd_pcm_preppare</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">snd_pcm_prepare</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snd_pcm_substream</span> <span class="token operator">*</span>substream<span class="token punctuation">,</span>
               <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> f_flags<span class="token punctuation">;</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        f_flags <span class="token operator">=</span> file<span class="token operator">-&gt;</span>f_flags<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        f_flags <span class="token operator">=</span> substream<span class="token operator">-&gt;</span>f_flags<span class="token punctuation">;</span>
 
    <span class="token function">snd_pcm_stream_lock_irq</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这个地方会判断当时substream的状态如果是pause会执行pause动作，如果是suspended会执行stop动作</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>substream<span class="token operator">-&gt;</span>runtime<span class="token operator">-&gt;</span>status<span class="token operator">-&gt;</span>state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> SNDRV_PCM_STATE_PAUSED<span class="token operator">:</span>
        <span class="token function">snd_pcm_pause</span><span class="token punctuation">(</span>substream<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* fallthru */</span>
    <span class="token keyword">case</span> SNDRV_PCM_STATE_SUSPENDED<span class="token operator">:</span>
        <span class="token function">snd_pcm_stop</span><span class="token punctuation">(</span>substream<span class="token punctuation">,</span> SNDRV_PCM_STATE_SETUP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">snd_pcm_stream_unlock_irq</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这个地方执行的是prepare的一系列动作，执行的是struct action_ops snd_pcm_action_prepare的三个函数pre_ation、do_action、post_action，主要看下do_aciton</span>
    <span class="token keyword">return</span> <span class="token function">snd_pcm_action_nonatomic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>snd_pcm_action_prepare<span class="token punctuation">,</span>
                    substream<span class="token punctuation">,</span> f_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">action_ops</span> snd_pcm_action_prepare <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>pre_action <span class="token operator">=</span> snd_pcm_pre_prepare<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>do_action <span class="token operator">=</span> snd_pcm_do_prepare<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>post_action <span class="token operator">=</span> snd_pcm_post_prepare
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">snd_pcm_do_prepare</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snd_pcm_substream</span> <span class="token operator">*</span>substream<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
    err <span class="token operator">=</span> substream<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">snd_pcm_do_reset</span><span class="token punctuation">(</span>substream<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>pcm_prepare执行到内核层之后可以看出，最后是执行了substream-&gt;ops→prepare，那么这个substream 是什么呢，它又在哪里定义的呢？带着这些问题我们重新去查看代码会发现，原来substream是在soc-pcm.c 的snd_new_pcm中定义的，而snd_new_pcm是在soc_probe_link_dais调用：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">soc_probe_link_dais</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snd_soc_card</span> <span class="token operator">*</span>card<span class="token punctuation">,</span>
        <span class="token keyword">struct</span> <span class="token class-name">snd_soc_pcm_runtime</span> <span class="token operator">*</span>rtd<span class="token punctuation">,</span> <span class="token keyword">int</span> order<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cpu_dai<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span>compress_new<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*create compress_device"*/</span>
        ret <span class="token operator">=</span> cpu_dai<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span><span class="token function">compress_new</span><span class="token punctuation">(</span>rtd<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">dev_err</span><span class="token punctuation">(</span>card<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"ASoC: can't create compress %sn"</span><span class="token punctuation">,</span>
                     dai_link<span class="token operator">-&gt;</span>stream_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dai_link<span class="token operator">-&gt;</span>params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* create the pcm */</span>
            <span class="token comment">// 判断dailink的params参数为空时，代表该dailink没建立pcm则新建pcm</span>
            ret <span class="token operator">=</span> <span class="token function">soc_new_pcm</span><span class="token punctuation">(</span>rtd<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">dev_err</span><span class="token punctuation">(</span>card<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"ASoC: can't create pcm %s :%dn"</span><span class="token punctuation">,</span>
                       dai_link<span class="token operator">-&gt;</span>stream_name<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ret <span class="token operator">=</span> <span class="token function">soc_link_dai_pcm_new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cpu_dai<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> rtd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">soc_link_dai_pcm_new</span><span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>codec_dais<span class="token punctuation">,</span>
                           rtd<span class="token operator">-&gt;</span>num_codecs<span class="token punctuation">,</span> rtd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">INIT_DELAYED_WORK</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rtd<span class="token operator">-&gt;</span>delayed_work<span class="token punctuation">,</span>
                        codec2codec_close_delayed_work<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token comment">/* link the DAI widgets */</span>
            ret <span class="token operator">=</span> <span class="token function">soc_link_dai_widgets</span><span class="token punctuation">(</span>card<span class="token punctuation">,</span> dai_link<span class="token punctuation">,</span> rtd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/* create a new pcm */</span>
<span class="token keyword">int</span> <span class="token function">soc_new_pcm</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snd_soc_pcm_runtime</span> <span class="token operator">*</span>rtd<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_soc_dai</span> <span class="token operator">*</span>codec_dai<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_soc_dai</span> <span class="token operator">*</span>cpu_dai <span class="token operator">=</span> rtd<span class="token operator">-&gt;</span>cpu_dai<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_soc_component</span> <span class="token operator">*</span>component<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_soc_rtdcom_list</span> <span class="token operator">*</span>rtdcom<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_pcm</span> <span class="token operator">*</span>pcm<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_pcm_str</span> <span class="token operator">*</span>stream<span class="token punctuation">;</span>
    <span class="token keyword">char</span> new_name<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> playback <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> capture <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>dynamic <span class="token operator">||</span> rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>no_pcm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        playback <span class="token operator">=</span> rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>dpcm_playback<span class="token punctuation">;</span>
        capture <span class="token operator">=</span> rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>dpcm_capture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rtd<span class="token operator">-&gt;</span>num_codecs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            codec_dai <span class="token operator">=</span> rtd<span class="token operator">-&gt;</span>codec_dais<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>codec_dai<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span>playback<span class="token punctuation">.</span>channels_min<span class="token punctuation">)</span>
                playback <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>codec_dai<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span>capture<span class="token punctuation">.</span>channels_min<span class="token punctuation">)</span>
                capture <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        capture <span class="token operator">=</span> capture <span class="token operator">&amp;&amp;</span> cpu_dai<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span>capture<span class="token punctuation">.</span>channels_min<span class="token punctuation">;</span>
        playback <span class="token operator">=</span> playback <span class="token operator">&amp;&amp;</span> cpu_dai<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span>playback<span class="token punctuation">.</span>channels_min<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>playback_only<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        playback <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        capture <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>capture_only<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        playback <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        capture <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">/* create the PCM */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>no_pcm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>new_name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>new_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"(%s)"</span><span class="token punctuation">,</span>
            rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>stream_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建pcm文件节点pcmCxDxp/c,和下面的snd_pcm_new 相比只有new_name 不同</span>
        ret <span class="token operator">=</span> <span class="token function">snd_pcm_new_internal</span><span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>card<span class="token operator">-&gt;</span>snd_card<span class="token punctuation">,</span> new_name<span class="token punctuation">,</span> num<span class="token punctuation">,</span>
                playback<span class="token punctuation">,</span> capture<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pcm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>dynamic<span class="token punctuation">)</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>new_name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>new_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%s (*)"</span><span class="token punctuation">,</span>
                rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>stream_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>new_name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>new_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%s %s-%d"</span><span class="token punctuation">,</span>
                rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>stream_name<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>num_codecs <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                <span class="token string">"multicodec"</span> <span class="token operator">:</span> rtd<span class="token operator">-&gt;</span>codec_dai<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建pcm文件节点pcmCxDxp/c</span>
        ret <span class="token operator">=</span> <span class="token function">snd_pcm_new</span><span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>card<span class="token operator">-&gt;</span>snd_card<span class="token punctuation">,</span> new_name<span class="token punctuation">,</span> num<span class="token punctuation">,</span> playback<span class="token punctuation">,</span>
            capture<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pcm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>card<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"ASoC: can't create pcm for %sn"</span><span class="token punctuation">,</span>
            rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>card<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"ASoC: registered pcm #%d %sn"</span><span class="token punctuation">,</span>num<span class="token punctuation">,</span> new_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">/* DAPM dai link stream work */</span>
    <span class="token function">INIT_DELAYED_WORK</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rtd<span class="token operator">-&gt;</span>delayed_work<span class="token punctuation">,</span> close_delayed_work<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    pcm<span class="token operator">-&gt;</span>nonatomic <span class="token operator">=</span> rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>nonatomic<span class="token punctuation">;</span>
    rtd<span class="token operator">-&gt;</span>pcm <span class="token operator">=</span> pcm<span class="token punctuation">;</span>
    pcm<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> rtd<span class="token punctuation">;</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>no_pcm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 保存rtd</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>playback<span class="token punctuation">)</span>
            pcm<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>SNDRV_PCM_STREAM_PLAYBACK<span class="token punctuation">]</span><span class="token punctuation">.</span>substream<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> rtd<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>capture<span class="token punctuation">)</span>
            pcm<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>SNDRV_PCM_STREAM_CAPTURE<span class="token punctuation">]</span><span class="token punctuation">.</span>substream<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> rtd<span class="token punctuation">;</span>
        <span class="token function">for_each_rtdcom</span><span class="token punctuation">(</span>rtd<span class="token punctuation">,</span> rtdcom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            component <span class="token operator">=</span> rtdcom<span class="token operator">-&gt;</span>component<span class="token punctuation">;</span>
 
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span>pcm_new<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token comment">// 当前runtime所绑定的组件执行probe</span>
            ret <span class="token operator">=</span> component<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span><span class="token function">pcm_new</span><span class="token punctuation">(</span>rtd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">dev_err</span><span class="token punctuation">(</span>component<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>
                    <span class="token string">"ASoC: pcm constructor failed: %dn"</span><span class="token punctuation">,</span>
                    ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 设置默认的硬件参数，一般不同的硬件会有不同的硬件参数在其驱动初始化的时候会设置，这里暂时给默认值</span>
    <span class="token comment">/* setup any hostless PCMs - i.e. no host IO is performed */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>no_host_mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pcm<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>SNDRV_PCM_STREAM_PLAYBACK<span class="token punctuation">]</span><span class="token punctuation">.</span>substream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            stream <span class="token operator">=</span> <span class="token operator">&amp;</span>pcm<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>SNDRV_PCM_STREAM_PLAYBACK<span class="token punctuation">]</span><span class="token punctuation">;</span>
            stream<span class="token operator">-&gt;</span>substream<span class="token operator">-&gt;</span>hw_no_buffer <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">snd_soc_set_runtime_hwparams</span><span class="token punctuation">(</span>stream<span class="token operator">-&gt;</span>substream<span class="token punctuation">,</span>
                             <span class="token operator">&amp;</span>no_host_hardware<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pcm<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>SNDRV_PCM_STREAM_CAPTURE<span class="token punctuation">]</span><span class="token punctuation">.</span>substream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            stream <span class="token operator">=</span> <span class="token operator">&amp;</span>pcm<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>SNDRV_PCM_STREAM_CAPTURE<span class="token punctuation">]</span><span class="token punctuation">;</span>
            stream<span class="token operator">-&gt;</span>substream<span class="token operator">-&gt;</span>hw_no_buffer <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">snd_soc_set_runtime_hwparams</span><span class="token punctuation">(</span>stream<span class="token operator">-&gt;</span>substream<span class="token punctuation">,</span>
                             <span class="token operator">&amp;</span>no_host_hardware<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 设置相应的ops 函数，并且后面会设置给pcm 的substream</span>
    <span class="token comment">/* ASoC PCM operations */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>dynamic<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>open       <span class="token operator">=</span> dpcm_fe_dai_open<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>hw_params  <span class="token operator">=</span> dpcm_fe_dai_hw_params<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>prepare    <span class="token operator">=</span> dpcm_fe_dai_prepare<span class="token punctuation">;</span>             <span class="token comment">// substream-&gt;ops→prepare</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>trigger    <span class="token operator">=</span> dpcm_fe_dai_trigger<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>hw_free    <span class="token operator">=</span> dpcm_fe_dai_hw_free<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>close      <span class="token operator">=</span> dpcm_fe_dai_close<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>pointer    <span class="token operator">=</span> soc_pcm_pointer<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>delay_blk  <span class="token operator">=</span> soc_pcm_delay_blk<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>ioctl      <span class="token operator">=</span> soc_pcm_ioctl<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>compat_ioctl   <span class="token operator">=</span> soc_pcm_compat_ioctl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>open       <span class="token operator">=</span> soc_pcm_open<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>hw_params  <span class="token operator">=</span> soc_pcm_hw_params<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>prepare    <span class="token operator">=</span> soc_pcm_prepare<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>trigger    <span class="token operator">=</span> soc_pcm_trigger<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>hw_free    <span class="token operator">=</span> soc_pcm_hw_free<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>close      <span class="token operator">=</span> soc_pcm_close<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>pointer    <span class="token operator">=</span> soc_pcm_pointer<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>delay_blk  <span class="token operator">=</span> soc_pcm_delay_blk<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>ioctl      <span class="token operator">=</span> soc_pcm_ioctl<span class="token punctuation">;</span>
        rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>compat_ioctl   <span class="token operator">=</span> soc_pcm_compat_ioctl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token function">for_each_rtdcom</span><span class="token punctuation">(</span>rtd<span class="token punctuation">,</span> rtdcom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">snd_pcm_ops</span> <span class="token operator">*</span>ops <span class="token operator">=</span> rtdcom<span class="token operator">-&gt;</span>component<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span>ops<span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ops<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>ack<span class="token punctuation">)</span>
            rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>ack        <span class="token operator">=</span> soc_rtdcom_ack<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>copy_user<span class="token punctuation">)</span>
            rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>copy_user  <span class="token operator">=</span> soc_rtdcom_copy_user<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>copy_kernel<span class="token punctuation">)</span>
            rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>copy_kernel    <span class="token operator">=</span> soc_rtdcom_copy_kernel<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>fill_silence<span class="token punctuation">)</span>
            rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>fill_silence   <span class="token operator">=</span> soc_rtdcom_fill_silence<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>page<span class="token punctuation">)</span>
            rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>page       <span class="token operator">=</span> soc_rtdcom_page<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-&gt;</span>mmap<span class="token punctuation">)</span>
            rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">.</span>mmap       <span class="token operator">=</span> soc_rtdcom_mmap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 这里就把上面设置的ops同样赋值给pcm 的substream-&gt;ops</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>playback<span class="token punctuation">)</span>
        <span class="token function">snd_pcm_set_ops</span><span class="token punctuation">(</span>pcm<span class="token punctuation">,</span> SNDRV_PCM_STREAM_PLAYBACK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>capture<span class="token punctuation">)</span>
        <span class="token function">snd_pcm_set_ops</span><span class="token punctuation">(</span>pcm<span class="token punctuation">,</span> SNDRV_PCM_STREAM_CAPTURE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rtd<span class="token operator">-&gt;</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token function">for_each_rtdcom</span><span class="token punctuation">(</span>rtd<span class="token punctuation">,</span> rtdcom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        component <span class="token operator">=</span> rtdcom<span class="token operator">-&gt;</span>component<span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span>pcm_new<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
 
        ret <span class="token operator">=</span> component<span class="token operator">-&gt;</span>driver<span class="token operator">-&gt;</span><span class="token function">pcm_new</span><span class="token punctuation">(</span>rtd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">dev_err</span><span class="token punctuation">(</span>component<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>
                <span class="token string">"ASoC: pcm constructor failed: %dn"</span><span class="token punctuation">,</span>
                ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    pcm<span class="token operator">-&gt;</span>private_free <span class="token operator">=</span> soc_pcm_private_free<span class="token punctuation">;</span>
out<span class="token operator">:</span>
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>card<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s &lt;-&gt; %s mapping okn"</span><span class="token punctuation">,</span>
         <span class="token punctuation">(</span>rtd<span class="token operator">-&gt;</span>num_codecs <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"multicodec"</span> <span class="token operator">:</span> rtd<span class="token operator">-&gt;</span>codec_dai<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span>
         cpu_dai<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>看完了snd_new_pcm之后就找到了原来substream→ops→prepare对应的是函数dpcm_fe_dai_prepare，这里涉及到了一个新的概念DPCM，顾名思义Dynamic PCM动态的PCM，动态 PCM 允许 ALSA PCM 设备在 PCM 流运行时以数字方式将其 PCM 音频路由到各种数字端点。例如PCM0 可以将数字音频路由到 I2S DAI0、I2S DAI1 或 PDM DAI2。DPCM 运行时路由由 ALSA mixer配置确定，与模拟信号在 ASoC codec driver的路由方式相同。 DSP内部有DAPM的mixer配置图，由mixer来配置pcm路径。在DPCM中分为前端和后端，前端连接着音频数据后端连接着播放设备。substream→ops→prepare调用到了dpcm_fe_dai_prepare，这个函数最终是分别调用了该runtime中的dailink、component、codecdai、cpu_dai的prepare函数。</p> 
<p>回到刚开始我们播放的是手机铃声，手机铃声是数据低延迟播放模式，前往混音器的配置文件查看，位置在vendor下面，默认的mixer_paths.xml ，一般会使用其他的配置，如果没有其他配置才会使用当前默认，具体解析过程在HAL层platform.c中，我们看mixer_paths_lagoonqrd.xml，这是当前正在使用的，</p> 
<pre><code class="prism language-xml">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>low-latency-playback<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ctl</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PRI_MI2S_RX Audio Mixer MultiMedia5<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>path</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>path表示的是一条usecase，代表的是一条音频播放路径，从上面可以看出控制流的前端是MultiMedia5，连接的是pcm数据，后端是PRI_MI2S_RX，连接的是codec、外放，那么我们根据这两个名字分别找到对应的dailink<br> 折叠源码</p> 
<pre><code class="prism language-c"><span class="token comment">// fe dailink</span>
<span class="token punctuation">{<!-- --></span><span class="token comment">/* hw:x,9 */</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token function">MSM_DAILINK_NAME</span><span class="token punctuation">(</span>LowLatency<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>stream_name <span class="token operator">=</span> <span class="token string">"MultiMedia5"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>cpu_dai_name <span class="token operator">=</span> <span class="token string">"MultiMedia5"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>platform_name <span class="token operator">=</span> <span class="token string">"msm-pcm-dsp.1"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>dynamic <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>async_ops <span class="token operator">=</span> ASYNC_DPCM_SND_SOC_PREPARE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>dpcm_playback <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>dpcm_capture <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>codec_dai_name <span class="token operator">=</span> <span class="token string">"snd-soc-dummy-dai"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>codec_name <span class="token operator">=</span> <span class="token string">"snd-soc-dummy"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>trigger <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>SND_SOC_DPCM_TRIGGER_POST<span class="token punctuation">,</span>
            SND_SOC_DPCM_TRIGGER_POST<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ignore_suspend <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token comment">/* this dainlink has playback support */</span>
    <span class="token punctuation">.</span>ignore_pmdown_time <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>id <span class="token operator">=</span> MSM_FRONTEND_DAI_MULTIMEDIA5<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>msm_fe_qos_ops<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
 
<span class="token comment">// be dailink</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> LPASS_BE_PRI_MI2S_RX<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>stream_name <span class="token operator">=</span> <span class="token string">"Primary MI2S Playback"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>cpu_dai_name <span class="token operator">=</span> <span class="token string">"msm-dai-q6-mi2s.0"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>platform_name <span class="token operator">=</span> <span class="token string">"msm-pcm-routing"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>num_codecs <span class="token operator">=</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>awinic_codecs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>codecs <span class="token operator">=</span> awinic_codecs<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>no_pcm <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>dpcm_playback <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>id <span class="token operator">=</span> MSM_BACKEND_DAI_PRI_MI2S_RX<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>be_hw_params_fixup <span class="token operator">=</span> msm_be_hw_params_fixup<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>msm_mi2s_be_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ignore_suspend <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ignore_pmdown_time <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<p>找到了对应的dailink，然后再看下substream→ops→prepare分别调用了哪里，先看fe dailink，通过对应的名字分别能找到相应的dai，发现：cpu_dai，codec_dai没有prepare，dailink、platform 有prepare。platform prepare代码位于msm-pcm-q6-v2.c的msm_pcm_ops:</p> 
<pre><code class="prism language-c">msm_pcm_prepare
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>msm_pcm_playback_prepare
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">msm_pcm_playback_prepare</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snd_pcm_substream</span> <span class="token operator">*</span>substream<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_pcm_runtime</span> <span class="token operator">*</span>runtime <span class="token operator">=</span> substream<span class="token operator">-&gt;</span>runtime<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_soc_pcm_runtime</span> <span class="token operator">*</span>soc_prtd <span class="token operator">=</span> substream<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_soc_component</span> <span class="token operator">*</span>component <span class="token operator">=</span>
            <span class="token function">snd_soc_rtdcom_lookup</span><span class="token punctuation">(</span>soc_prtd<span class="token punctuation">,</span> DRV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msm_audio</span> <span class="token operator">*</span>prtd <span class="token operator">=</span> runtime<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msm_plat_data</span> <span class="token operator">*</span>pdata<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_pcm_hw_params</span> <span class="token operator">*</span>params<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> fmt_type <span class="token operator">=</span> FORMAT_LINEAR_PCM<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> bits_per_sample<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> sample_word_size<span class="token punctuation">;</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: component is NULLn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    pdata <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msm_plat_data</span> <span class="token operator">*</span><span class="token punctuation">)</span>
        <span class="token function">dev_get_drvdata</span><span class="token punctuation">(</span>component<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pdata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: platform data not populatedn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prtd <span class="token operator">||</span> <span class="token operator">!</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: private data null or audio client freedn"</span><span class="token punctuation">,</span>
            <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    params <span class="token operator">=</span> <span class="token operator">&amp;</span>soc_prtd<span class="token operator">-&gt;</span>dpcm<span class="token punctuation">[</span>substream<span class="token operator">-&gt;</span>stream<span class="token punctuation">]</span><span class="token punctuation">.</span>hw_params<span class="token punctuation">;</span>
 
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%sn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    prtd<span class="token operator">-&gt;</span>pcm_size <span class="token operator">=</span> <span class="token function">snd_pcm_lib_buffer_bytes</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    prtd<span class="token operator">-&gt;</span>pcm_count <span class="token operator">=</span> <span class="token function">snd_pcm_lib_period_bytes</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    prtd<span class="token operator">-&gt;</span>pcm_irq_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* rate and channels are sent to audio driver */</span>
    prtd<span class="token operator">-&gt;</span>samp_rate <span class="token operator">=</span> runtime<span class="token operator">-&gt;</span>rate<span class="token punctuation">;</span>
    prtd<span class="token operator">-&gt;</span>channel_mode <span class="token operator">=</span> runtime<span class="token operator">-&gt;</span>channels<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>enabled<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    prtd<span class="token operator">-&gt;</span>audio_client<span class="token operator">-&gt;</span>perf_mode <span class="token operator">=</span> pdata<span class="token operator">-&gt;</span>perf_mode<span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: perf: %xn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> pdata<span class="token operator">-&gt;</span>perf_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">params_format</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> SNDRV_PCM_FORMAT_S32_LE<span class="token operator">:</span>
        bits_per_sample <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
        sample_word_size <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SNDRV_PCM_FORMAT_S24_LE<span class="token operator">:</span>
        bits_per_sample <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
        sample_word_size <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SNDRV_PCM_FORMAT_S24_3LE<span class="token operator">:</span>
        bits_per_sample <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
        sample_word_size <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SNDRV_PCM_FORMAT_S16_LE<span class="token operator">:</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        bits_per_sample <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
        sample_word_size <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>compress_enable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        fmt_type <span class="token operator">=</span> FORMAT_GEN_COMPR<span class="token punctuation">;</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: Compressed enabled!n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">q6asm_open_write_compressed</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span> fmt_type<span class="token punctuation">,</span>
                COMPRESSED_PASSTHROUGH_GEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: q6asm_open_write_compressed failed (%d)n"</span><span class="token punctuation">,</span>
            <span class="token constant">__func__</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">q6asm_audio_client_free</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">)</span><span class="token punctuation">;</span>
            prtd<span class="token operator">-&gt;</span>audio_client <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断 adsp asm api的版本是否大于2</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">q6core_get_avcs_api_version_per_service</span><span class="token punctuation">(</span>
                APRV2_IDS_SERVICE_ID_ADSP_ASM_V<span class="token punctuation">)</span> <span class="token operator">&gt;=</span>
                ADSP_ASM_API_VERSION_V2<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 打开音频播放的session会与adsp通信</span>
            ret <span class="token operator">=</span> <span class="token function">q6asm_open_write_v5</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span>
                fmt_type<span class="token punctuation">,</span> bits_per_sample<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            ret <span class="token operator">=</span> <span class="token function">q6asm_open_write_v4</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span>
                fmt_type<span class="token punctuation">,</span> bits_per_sample<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: q6asm_open_write failed (%d)n"</span><span class="token punctuation">,</span>
            <span class="token constant">__func__</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">q6asm_audio_client_free</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">)</span><span class="token punctuation">;</span>
            prtd<span class="token operator">-&gt;</span>audio_client <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 发送校准数据</span>
        ret <span class="token operator">=</span> <span class="token function">q6asm_send_cal</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s : Send cal failed : %d"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: session ID %dn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span>
            prtd<span class="token operator">-&gt;</span>audio_client<span class="token operator">-&gt;</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    prtd<span class="token operator">-&gt;</span>session_id <span class="token operator">=</span> prtd<span class="token operator">-&gt;</span>audio_client<span class="token operator">-&gt;</span>session<span class="token punctuation">;</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>compress_enable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">msm_pcm_routing_reg_phy_compr_stream</span><span class="token punctuation">(</span>
                soc_prtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>id<span class="token punctuation">,</span>
                prtd<span class="token operator">-&gt;</span>audio_client<span class="token operator">-&gt;</span>perf_mode<span class="token punctuation">,</span>
                prtd<span class="token operator">-&gt;</span>session_id<span class="token punctuation">,</span>
                SNDRV_PCM_STREAM_PLAYBACK<span class="token punctuation">,</span>
                COMPRESSED_PASSTHROUGH_GEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 打开注册adm</span>
        ret <span class="token operator">=</span> <span class="token function">msm_pcm_routing_reg_phy_stream</span><span class="token punctuation">(</span>soc_prtd<span class="token operator">-&gt;</span>dai_link<span class="token operator">-&gt;</span>id<span class="token punctuation">,</span>
            prtd<span class="token operator">-&gt;</span>audio_client<span class="token operator">-&gt;</span>perf_mode<span class="token punctuation">,</span>
            prtd<span class="token operator">-&gt;</span>session_id<span class="token punctuation">,</span> substream<span class="token operator">-&gt;</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: stream reg failed ret:%dn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>compress_enable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">q6asm_media_format_block_gen_compr</span><span class="token punctuation">(</span>
            prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span> runtime<span class="token operator">-&gt;</span>rate<span class="token punctuation">,</span>
            runtime<span class="token operator">-&gt;</span>channels<span class="token punctuation">,</span> <span class="token operator">!</span>prtd<span class="token operator">-&gt;</span>set_channel_map<span class="token punctuation">,</span>
            prtd<span class="token operator">-&gt;</span>channel_map<span class="token punctuation">,</span> bits_per_sample<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
         
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">q6core_get_avcs_api_version_per_service</span><span class="token punctuation">(</span>
                APRV2_IDS_SERVICE_ID_ADSP_ASM_V<span class="token punctuation">)</span> <span class="token operator">&gt;=</span>
                ADSP_ASM_API_VERSION_V2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 设置格式参数发送至adsp</span>
            ret <span class="token operator">=</span> <span class="token function">q6asm_media_format_block_multi_ch_pcm_v5</span><span class="token punctuation">(</span>
                prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span> runtime<span class="token operator">-&gt;</span>rate<span class="token punctuation">,</span>
                runtime<span class="token operator">-&gt;</span>channels<span class="token punctuation">,</span> <span class="token operator">!</span>prtd<span class="token operator">-&gt;</span>set_channel_map<span class="token punctuation">,</span>
                prtd<span class="token operator">-&gt;</span>channel_map<span class="token punctuation">,</span> bits_per_sample<span class="token punctuation">,</span>
                sample_word_size<span class="token punctuation">,</span> ASM_LITTLE_ENDIAN<span class="token punctuation">,</span>
                DEFAULT_QF<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">q6asm_media_format_block_multi_ch_pcm_v4</span><span class="token punctuation">(</span>
                prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span> runtime<span class="token operator">-&gt;</span>rate<span class="token punctuation">,</span>
                runtime<span class="token operator">-&gt;</span>channels<span class="token punctuation">,</span> <span class="token operator">!</span>prtd<span class="token operator">-&gt;</span>set_channel_map<span class="token punctuation">,</span>
                prtd<span class="token operator">-&gt;</span>channel_map<span class="token punctuation">,</span> bits_per_sample<span class="token punctuation">,</span>
                sample_word_size<span class="token punctuation">,</span> ASM_LITTLE_ENDIAN<span class="token punctuation">,</span>
                DEFAULT_QF<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"%s: CMD Format block failedn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>out_count<span class="token punctuation">,</span> runtime<span class="token operator">-&gt;</span>periods<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    prtd<span class="token operator">-&gt;</span>enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    prtd<span class="token operator">-&gt;</span>cmd_pending <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    prtd<span class="token operator">-&gt;</span>cmd_interrupt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其次再看be 端的prepare，cpu_dai 在msm-dai-q6-v2.c，其prepare如下<br> 折叠源码</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">msm_dai_q6_mi2s_prepare</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snd_pcm_substream</span> <span class="token operator">*</span>substream<span class="token punctuation">,</span>
        <span class="token keyword">struct</span> <span class="token class-name">snd_soc_dai</span> <span class="token operator">*</span>dai<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">msm_dai_q6_mi2s_dai_data</span> <span class="token operator">*</span>mi2s_dai_data <span class="token operator">=</span>
        <span class="token function">dev_get_drvdata</span><span class="token punctuation">(</span>dai<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msm_dai_q6_dai_data</span> <span class="token operator">*</span>dai_data <span class="token operator">=</span>
        <span class="token punctuation">(</span>substream<span class="token operator">-&gt;</span>stream <span class="token operator">==</span> SNDRV_PCM_STREAM_PLAYBACK <span class="token operator">?</span>
         <span class="token operator">&amp;</span>mi2s_dai_data<span class="token operator">-&gt;</span>rx_dai<span class="token punctuation">.</span>mi2s_dai_data <span class="token operator">:</span>
         <span class="token operator">&amp;</span>mi2s_dai_data<span class="token operator">-&gt;</span>tx_dai<span class="token punctuation">.</span>mi2s_dai_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u16 port_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">msm_mi2s_get_port_id</span><span class="token punctuation">(</span>dai<span class="token operator">-&gt;</span>id<span class="token punctuation">,</span> substream<span class="token operator">-&gt;</span>stream<span class="token punctuation">,</span>
                 <span class="token operator">&amp;</span>port_id<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span>dai<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: Invalid Port ID 0x%xn"</span><span class="token punctuation">,</span>
                <span class="token constant">__func__</span><span class="token punctuation">,</span> port_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dai<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: dai id %d, afe port id = 0x%xn"</span>
        <span class="token string">"dai_data-&gt;channels = %u sample_rate = %un"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span>
        dai<span class="token operator">-&gt;</span>id<span class="token punctuation">,</span> port_id<span class="token punctuation">,</span> dai_data<span class="token operator">-&gt;</span>channels<span class="token punctuation">,</span> dai_data<span class="token operator">-&gt;</span>rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">test_bit</span><span class="token punctuation">(</span>STATUS_PORT_STARTED<span class="token punctuation">,</span> dai_data<span class="token operator">-&gt;</span>status_mask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* PORT START should be set if prepare called
         * in active state.
         */</span>
        <span class="token comment">// 使用指定的端口配置配置AFE会</span>
        rc <span class="token operator">=</span> <span class="token function">afe_port_start</span><span class="token punctuation">(</span>port_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dai_data<span class="token operator">-&gt;</span>port_config<span class="token punctuation">,</span>
                    dai_data<span class="token operator">-&gt;</span>rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">dev_err</span><span class="token punctuation">(</span>dai<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"fail to open AFE port 0x%xn"</span><span class="token punctuation">,</span>
                dai<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">set_bit</span><span class="token punctuation">(</span>STATUS_PORT_STARTED<span class="token punctuation">,</span>
                dai_data<span class="token operator">-&gt;</span>status_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">test_bit</span><span class="token punctuation">(</span>STATUS_PORT_STARTED<span class="token punctuation">,</span> dai_data<span class="token operator">-&gt;</span>hwfree_status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">set_bit</span><span class="token punctuation">(</span>STATUS_PORT_STARTED<span class="token punctuation">,</span> dai_data<span class="token operator">-&gt;</span>hwfree_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dev_dbg</span><span class="token punctuation">(</span>dai<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: set hwfree_status to startedn"</span><span class="token punctuation">,</span>
                <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>be dailink绑定的platform 在msm-pcm-routing-v2.c，其prepare比较长，也是类似打开一个adm，这里不贴代码，至此prepare的事情基本告一段落，然后是start。</p> 
<p>pcm_start ：alsa lib 会发送一个SNDRV_PCM_IOCTL_START的指令到kernel，对应于pcm_native.c中snd_pcm_ioctl<br> 折叠源码</p> 
<pre><code class="prism language-c">snd_pcm_ioctl_compat
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>snd_pcm_common_ioctl
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>snd_pcm_start_lock_irq
        <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>snd_pcm_action_lock_irq
            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>snd_pcm_action
                <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>action_ops<span class="token operator">-&gt;</span>pre_action
                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>action_ops<span class="token operator">-&gt;</span>do_action
                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>action_ops<span class="token operator">-&gt;</span>post_action
 
<span class="token comment">// 最终分别调用了snd_pcm_action_start的pre_action，do_action，post_action，同prepare类似后面会调各个dai的start</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">action_ops</span> snd_pcm_action_start <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>pre_action <span class="token operator">=</span> snd_pcm_pre_start<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>do_action <span class="token operator">=</span> snd_pcm_do_start<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>undo_action <span class="token operator">=</span> snd_pcm_undo_start<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>post_action <span class="token operator">=</span> snd_pcm_post_start
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token comment">//fe platform trigger,而且只有fe 的platform有trigger</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">msm_pcm_trigger</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snd_pcm_substream</span> <span class="token operator">*</span>substream<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">snd_pcm_runtime</span> <span class="token operator">*</span>runtime <span class="token operator">=</span> substream<span class="token operator">-&gt;</span>runtime<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msm_audio</span> <span class="token operator">*</span>prtd <span class="token operator">=</span> runtime<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
 
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> SNDRV_PCM_TRIGGER_START<span class="token operator">:</span>
    <span class="token keyword">case</span> SNDRV_PCM_TRIGGER_RESUME<span class="token operator">:</span>
    <span class="token keyword">case</span> SNDRV_PCM_TRIGGER_PAUSE_RELEASE<span class="token operator">:</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: Trigger startn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 命令将ASM设置为不等待ack的运行状态</span>
        ret <span class="token operator">=</span> <span class="token function">q6asm_run_nowait</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SNDRV_PCM_TRIGGER_STOP<span class="token operator">:</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"SNDRV_PCM_TRIGGER_STOPn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>substream<span class="token operator">-&gt;</span>stream <span class="token operator">!=</span> SNDRV_PCM_STREAM_PLAYBACK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            prtd<span class="token operator">-&gt;</span>enabled <span class="token operator">=</span> STOPPED<span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">q6asm_cmd_nowait</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span> CMD_PAUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* pending CMD_EOS isn't expected */</span>
        <span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span><span class="token function">test_bit</span><span class="token punctuation">(</span>CMD_EOS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>cmd_pending<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">set_bit</span><span class="token punctuation">(</span>CMD_EOS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>cmd_pending<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">q6asm_cmd_nowait</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span> CMD_EOS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token function">clear_bit</span><span class="token punctuation">(</span>CMD_EOS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>cmd_pending<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SNDRV_PCM_TRIGGER_SUSPEND<span class="token operator">:</span>
    <span class="token keyword">case</span> SNDRV_PCM_TRIGGER_PAUSE_PUSH<span class="token operator">:</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"SNDRV_PCM_TRIGGER_PAUSEn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">q6asm_cmd_nowait</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span> CMD_PAUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>pcm_write：前面都是做准备，这里才是真正的把数据送下来了，alsa lib pcm_write会将SNDRV_PCM_IOCTL_WRITEI_FRAMES指令发送到kernel，触发pcm_native.c 中snd_pcm_ioctl，如下</p> 
<pre><code class="prism language-c">snd_pcm_ioctl
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>snd_pcm_common_ioctl
   <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>snd_pcm_xferi_frames_ioctl
       <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>snd_pcm_lib_write
           <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span>__snd_pcm_lib_xfer
<span class="token class-name">snd_pcm_sframes_t</span> <span class="token function">__snd_pcm_lib_xfer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snd_pcm_substream</span> <span class="token operator">*</span>substream<span class="token punctuation">,</span>
                    <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> bool interleaved<span class="token punctuation">,</span>
                    <span class="token class-name">snd_pcm_uframes_t</span> size<span class="token punctuation">,</span> bool in_kernel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">struct</span> <span class="token class-name">snd_pcm_runtime</span> <span class="token operator">*</span>runtime <span class="token operator">=</span> substream<span class="token operator">-&gt;</span>runtime<span class="token punctuation">;</span>
   <span class="token class-name">snd_pcm_uframes_t</span> xfer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token class-name">snd_pcm_uframes_t</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token class-name">snd_pcm_uframes_t</span> avail<span class="token punctuation">;</span>
   pcm_copy_f writer<span class="token punctuation">;</span>
   pcm_transfer_f transfer<span class="token punctuation">;</span>
   bool nonblock<span class="token punctuation">;</span>
   bool is_playback<span class="token punctuation">;</span>
   <span class="token keyword">int</span> err<span class="token punctuation">;</span>

   err <span class="token operator">=</span> <span class="token function">pcm_sanity_check</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
       <span class="token keyword">return</span> err<span class="token punctuation">;</span>

   is_playback <span class="token operator">=</span> substream<span class="token operator">-&gt;</span>stream <span class="token operator">==</span> SNDRV_PCM_STREAM_PLAYBACK<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>interleaved<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 传过来参数为1</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>runtime<span class="token operator">-&gt;</span>access <span class="token operator">!=</span> SNDRV_PCM_ACCESS_RW_INTERLEAVED <span class="token operator">&amp;&amp;</span>
           runtime<span class="token operator">-&gt;</span>channels <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
           <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
       writer <span class="token operator">=</span> interleaved_copy<span class="token punctuation">;</span><span class="token comment">// 这里writer函数后面会调用</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>runtime<span class="token operator">-&gt;</span>access <span class="token operator">!=</span> SNDRV_PCM_ACCESS_RW_NONINTERLEAVED<span class="token punctuation">)</span>
           <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
       writer <span class="token operator">=</span> noninterleaved_copy<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>is_playback<span class="token punctuation">)</span>
           transfer <span class="token operator">=</span> fill_silence<span class="token punctuation">;</span>
       <span class="token keyword">else</span>
           <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>in_kernel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>substream<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span>copy_kernel<span class="token punctuation">)</span>
           transfer <span class="token operator">=</span> substream<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span>copy_kernel<span class="token punctuation">;</span>
       <span class="token keyword">else</span>
           transfer <span class="token operator">=</span> is_playback <span class="token operator">?</span>
               default_write_copy_kernel <span class="token operator">:</span> default_read_copy_kernel<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//第三种情况符合</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>substream<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span>copy_user<span class="token punctuation">)</span>
           transfer <span class="token operator">=</span> <span class="token punctuation">(</span>pcm_transfer_f<span class="token punctuation">)</span>substream<span class="token operator">-&gt;</span>ops<span class="token operator">-&gt;</span>copy_user<span class="token punctuation">;</span><span class="token comment">// 这里将soc_rtdcom_copy_user赋值给了transfer，后续调用</span>
       <span class="token keyword">else</span>
           transfer <span class="token operator">=</span> is_playback <span class="token operator">?</span>
               default_write_copy <span class="token operator">:</span> default_read_copy<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
       <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

   nonblock <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>substream<span class="token operator">-&gt;</span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token function">snd_pcm_stream_lock_irq</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
   err <span class="token operator">=</span> <span class="token function">pcm_accessible_state</span><span class="token punctuation">(</span>runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
       <span class="token keyword">goto</span> _end_unlock<span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_playback <span class="token operator">&amp;&amp;</span>
       runtime<span class="token operator">-&gt;</span>status<span class="token operator">-&gt;</span>state <span class="token operator">==</span> SNDRV_PCM_STATE_PREPARED <span class="token operator">&amp;&amp;</span>
       size <span class="token operator">&gt;=</span> runtime<span class="token operator">-&gt;</span>start_threshold<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       err <span class="token operator">=</span> <span class="token function">snd_pcm_start</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token keyword">goto</span> _end_unlock<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   runtime<span class="token operator">-&gt;</span>twake <span class="token operator">=</span> runtime<span class="token operator">-&gt;</span>control<span class="token operator">-&gt;</span>avail_min <span class="token operator">?</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>runtime<span class="token operator">-&gt;</span>status<span class="token operator">-&gt;</span>state <span class="token operator">==</span> SNDRV_PCM_STATE_RUNNING<span class="token punctuation">)</span>
       <span class="token function">snd_pcm_update_hw_ptr</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
   avail <span class="token operator">=</span> <span class="token function">snd_pcm_avail</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取播放时的可用空间</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token class-name">snd_pcm_uframes_t</span> frames<span class="token punctuation">,</span> appl_ptr<span class="token punctuation">,</span> appl_ofs<span class="token punctuation">;</span>
       <span class="token class-name">snd_pcm_uframes_t</span> cont<span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 如果可写空间不够了就会触发停止</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_playback <span class="token operator">&amp;&amp;</span>
               runtime<span class="token operator">-&gt;</span>status<span class="token operator">-&gt;</span>state <span class="token operator">==</span> SNDRV_PCM_STATE_DRAINING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token function">snd_pcm_stop</span><span class="token punctuation">(</span>substream<span class="token punctuation">,</span> SNDRV_PCM_STATE_SETUP<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">goto</span> _end_unlock<span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>nonblock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               err <span class="token operator">=</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
               <span class="token keyword">goto</span> _end_unlock<span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           runtime<span class="token operator">-&gt;</span>twake <span class="token operator">=</span> <span class="token class-name">min_t</span><span class="token punctuation">(</span><span class="token class-name">snd_pcm_uframes_t</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span>
                   runtime<span class="token operator">-&gt;</span>control<span class="token operator">-&gt;</span>avail_min <span class="token operator">?</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           err <span class="token operator">=</span> <span class="token function">wait_for_avail</span><span class="token punctuation">(</span>substream<span class="token punctuation">,</span> <span class="token operator">&amp;</span>avail<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
               <span class="token keyword">goto</span> _end_unlock<span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avail<span class="token punctuation">)</span>
               <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">/* draining */</span>
       <span class="token punctuation">}</span>
       frames <span class="token operator">=</span> size <span class="token operator">&gt;</span> avail <span class="token operator">?</span> avail <span class="token operator">:</span> size<span class="token punctuation">;</span>
       appl_ptr <span class="token operator">=</span> <span class="token function">READ_ONCE</span><span class="token punctuation">(</span>runtime<span class="token operator">-&gt;</span>control<span class="token operator">-&gt;</span>appl_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
       appl_ofs <span class="token operator">=</span> appl_ptr <span class="token operator">%</span> runtime<span class="token operator">-&gt;</span>buffer_size<span class="token punctuation">;</span>
       cont <span class="token operator">=</span> runtime<span class="token operator">-&gt;</span>buffer_size <span class="token operator">-</span> appl_ofs<span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>frames <span class="token operator">&gt;</span> cont<span class="token punctuation">)</span>
           frames <span class="token operator">=</span> cont<span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">snd_BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>frames<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           runtime<span class="token operator">-&gt;</span>twake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
           <span class="token function">snd_pcm_stream_unlock_irq</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token function">snd_pcm_stream_unlock_irq</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 这里最后是调用了上面赋值的copy_user，最后会调用到msm-pcm-q6-v2.c中的msm_pcm_playback_copy，将数据拷贝到dsp，直到没有数据可拷贝</span>
       err <span class="token operator">=</span> <span class="token function">writer</span><span class="token punctuation">(</span>substream<span class="token punctuation">,</span> appl_ofs<span class="token punctuation">,</span> data<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> frames<span class="token punctuation">,</span>
                transfer<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">snd_pcm_stream_lock_irq</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token keyword">goto</span> _end_unlock<span class="token punctuation">;</span>
       err <span class="token operator">=</span> <span class="token function">pcm_accessible_state</span><span class="token punctuation">(</span>runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token keyword">goto</span> _end_unlock<span class="token punctuation">;</span>
       appl_ptr <span class="token operator">+=</span> frames<span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>appl_ptr <span class="token operator">&gt;=</span> runtime<span class="token operator">-&gt;</span>boundary<span class="token punctuation">)</span>
           appl_ptr <span class="token operator">-=</span> runtime<span class="token operator">-&gt;</span>boundary<span class="token punctuation">;</span>
       err <span class="token operator">=</span> <span class="token function">pcm_lib_apply_appl_ptr</span><span class="token punctuation">(</span>substream<span class="token punctuation">,</span> appl_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token keyword">goto</span> _end_unlock<span class="token punctuation">;</span>

       offset <span class="token operator">+=</span> frames<span class="token punctuation">;</span>
       size <span class="token operator">-=</span> frames<span class="token punctuation">;</span>
       xfer <span class="token operator">+=</span> frames<span class="token punctuation">;</span>
       avail <span class="token operator">-=</span> frames<span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>is_playback <span class="token operator">&amp;&amp;</span>
           runtime<span class="token operator">-&gt;</span>status<span class="token operator">-&gt;</span>state <span class="token operator">==</span> SNDRV_PCM_STATE_PREPARED <span class="token operator">&amp;&amp;</span>
           <span class="token function">snd_pcm_playback_hw_avail</span><span class="token punctuation">(</span>runtime<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token class-name">snd_pcm_sframes_t</span><span class="token punctuation">)</span>runtime<span class="token operator">-&gt;</span>start_threshold<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           err <span class="token operator">=</span> <span class="token function">snd_pcm_start</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 再次触发start</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
               <span class="token keyword">goto</span> _end_unlock<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
_end_unlock<span class="token operator">:</span>
   runtime<span class="token operator">-&gt;</span>twake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>xfer <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
       <span class="token function">snd_pcm_update_state</span><span class="token punctuation">(</span>substream<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">snd_pcm_stream_unlock_irq</span><span class="token punctuation">(</span>substream<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> xfer <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">snd_pcm_sframes_t</span><span class="token punctuation">)</span>xfer <span class="token operator">:</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面函数之后会进入循环拷贝使用的是msm-pcm-q6-v2.c中的msm_pcm_playback_copy函数不停的向dsp拷贝数据</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">msm_pcm_playback_copy</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snd_pcm_substream</span> <span class="token operator">*</span>substream<span class="token punctuation">,</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> hwoff<span class="token punctuation">,</span> <span class="token keyword">void</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> fbytes<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> xfer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>bufptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> retries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    <span class="token keyword">struct</span> <span class="token class-name">snd_pcm_runtime</span> <span class="token operator">*</span>runtime <span class="token operator">=</span> substream<span class="token operator">-&gt;</span>runtime<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msm_audio</span> <span class="token operator">*</span>prtd <span class="token operator">=</span> runtime<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
 
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s: prtd-&gt;out_count = %dn"</span><span class="token punctuation">,</span>
                <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>out_count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fbytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>retries <span class="token operator">&lt;</span> MAX_PB_COPY_RETRIES<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>reset_event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: In SSR return ENETRESET before waitn"</span><span class="token punctuation">,</span>
                <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENETRESET<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        ret <span class="token operator">=</span> <span class="token function">wait_event_timeout</span><span class="token punctuation">(</span>the_locks<span class="token punctuation">.</span>write_wait<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>out_count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span>TIMEOUT_MS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: wait_event_timeout failedn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token operator">-</span>ETIMEDOUT<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>reset_event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: In SSR return ENETRESET after waitn"</span><span class="token punctuation">,</span>
                <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENETRESET<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>out_count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: pcm stopped out_count 0n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     
        <span class="token comment">// 检索下一个可用的 cpu buf</span>
        data <span class="token operator">=</span> <span class="token function">q6asm_is_cpu_buf_avail</span><span class="token punctuation">(</span>IN<span class="token punctuation">,</span> prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            retries<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            retries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fbytes <span class="token operator">&gt;</span> size<span class="token punctuation">)</span>
            xfer <span class="token operator">=</span> size<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            xfer <span class="token operator">=</span> fbytes<span class="token punctuation">;</span>
 
        bufptr <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bufptr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s:fbytes =%lu: xfer=%d size=%dn"</span><span class="token punctuation">,</span>
                 <span class="token constant">__func__</span><span class="token punctuation">,</span> fbytes<span class="token punctuation">,</span> xfer<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>bufptr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> xfer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
                <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: copy_from_user failedn"</span><span class="token punctuation">,</span>
                    <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">q6asm_cpu_buf_release</span><span class="token punctuation">(</span>IN<span class="token punctuation">,</span> prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            buf <span class="token operator">+=</span> xfer<span class="token punctuation">;</span>
            fbytes <span class="token operator">-=</span> xfer<span class="token punctuation">;</span>
            <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s:fbytes = %lu: xfer=%dn"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span>
                 fbytes<span class="token punctuation">,</span> xfer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s:writing %d bytes of buffer to dspn"</span><span class="token punctuation">,</span>
                        <span class="token constant">__func__</span><span class="token punctuation">,</span> xfer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 调用asm 将数据写入到dsp</span>
                ret <span class="token operator">=</span> <span class="token function">q6asm_write</span><span class="token punctuation">(</span>prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">,</span> xfer<span class="token punctuation">,</span>
                            <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NO_TIMESTAMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
                    <span class="token function">q6asm_cpu_buf_release</span><span class="token punctuation">(</span>IN<span class="token punctuation">,</span>
                        prtd<span class="token operator">-&gt;</span>audio_client<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span>
                <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>out_needed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">atomic_dec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prtd<span class="token operator">-&gt;</span>out_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
fail<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retries <span class="token operator">&gt;=</span> MAX_PB_COPY_RETRIES<span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
 
    <span class="token keyword">return</span>  ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面函数就是将数据写入到dsp进行下一步处理的，期间还涉及了几个新的概念：asm，adm，afe。还有将数据传送至dsp的apr</p> 
<blockquote> 
 <p>ASM（Audio Stream Manager）</p> 
 <pre><code>   用于与DSP ASM 模块通信的接口

   提供将 PCM 数据路由至 DSP 的机制，支持按数据流进行后期处理/预处理
</code></pre> 
 <p>ADM（Audio Device Manager）</p> 
 <pre><code>    允许在 DSP 中使用 ADM 服务

     配置 COPP 和路由矩阵

    与音频校准数据库 (ACDB) 进行通信，使用正确的校准数据配置 COPP

    将 ASM 会话 ID 路由至 ADM 会话
</code></pre> 
 <p>AFE（Audio Front-End）</p> 
 <pre><code>    允许在 DSP 中使用 AFE 服务

     激活/禁用音频硬件端口

     子系统管理器 – 发生 MDSP 复位事件时，通知音频和语音驱动程序关闭待处理会话、执行清理操作并等待一个指示 MDSP 已启动的事件
</code></pre> 
 <p>APR（Asynchronous Packet Router）</p> 
 <pre><code>    为处理器间通信提供异步框架

     用于与 Hexagon 和调制解调器处理器进行通信

     Image loader PIL – 载入 MDSP 图像
</code></pre> 
</blockquote> 
<p>整个内核过程，在音频流经过不同的usecase后输出给LPASS，在LPASS的DSP模块进行重采样、音效处理、混音的操作后经过SLIMbus/I2S给codec进行解码转换为模拟信号给喇叭进行信号放大。到这里你 数据就已经进入到了dsp，音频内核的过程基本就结束了，更多的过程还在持续探索中。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>