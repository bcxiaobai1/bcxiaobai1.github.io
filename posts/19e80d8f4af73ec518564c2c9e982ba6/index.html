<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>HAL: 将 HIDL 接口改造为 Stable AIDL - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HAL: 将 HIDL 接口改造为 Stable AIDL</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px"></p> 
<p id="1.%20%E5%AE%9A%E4%B9%89%E6%96%B0%E7%9A%84AIDL%E6%8E%A5%E5%8F%A3-toc" style="margin-left:0px"><a href="#1.%20%E5%AE%9A%E4%B9%89%E6%96%B0%E7%9A%84AIDL%E6%8E%A5%E5%8F%A3">1. 定义新的AIDL接口</a></p> 
<p id="1.1%20%E7%BC%96%E8%AF%91hidl2aidl%E5%B7%A5%E5%85%B7-toc" style="margin-left:40px"><a href="#1.1%20%E7%BC%96%E8%AF%91hidl2aidl%E5%B7%A5%E5%85%B7">1.1 编译hidl2aidl工具</a></p> 
<p id="1.2%20%E6%89%A7%E8%A1%8C%E8%BD%AC%E6%8D%A2-toc" style="margin-left:40px"><a href="#1.2%20%E6%89%A7%E8%A1%8C%E8%BD%AC%E6%8D%A2">1.2 执行转换</a></p> 
<p id="1.3%20%E8%B0%83%E6%95%B4%E7%BC%96%E8%AF%91%E8%A7%84%E5%88%99%EF%BC%88bp%E6%96%87%E4%BB%B6%EF%BC%89-toc" style="margin-left:40px"><a href="#1.3%20%E8%B0%83%E6%95%B4%E7%BC%96%E8%AF%91%E8%A7%84%E5%88%99%EF%BC%88bp%E6%96%87%E4%BB%B6%EF%BC%89">1.3 调整编译规则（bp文件）</a></p> 
<p id="2.%20%E5%90%91%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F%E6%B7%BB%E5%8A%A0AIDL%E6%8E%A5%E5%8F%A3-toc" style="margin-left:0px"><a href="#2.%20%E5%90%91%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F%E6%B7%BB%E5%8A%A0AIDL%E6%8E%A5%E5%8F%A3">2. 向vendor镜像添加AIDL接口</a></p> 
<p id="2.1%20%E4%BD%BF%E7%94%A8update-api%20freeze-api%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3%E7%89%88%E6%9C%AC-toc" style="margin-left:40px"><a href="#2.1%20%E4%BD%BF%E7%94%A8update-api%20freeze-api%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3%E7%89%88%E6%9C%AC">2.1 使用update-api freeze-api管理接口版本</a></p> 
<p id="2.2%20%E9%85%8D%E7%BD%AE%20Framework%20Compatibility%20Matrix%20(FCM%EF%BC%8C%E5%85%BC%E5%AE%B9%E6%80%A7%E7%9F%A9%E9%98%B5)-toc" style="margin-left:40px"><a href="#2.2%20%E9%85%8D%E7%BD%AE%20Framework%20Compatibility%20Matrix%20%28FCM%EF%BC%8C%E5%85%BC%E5%AE%B9%E6%80%A7%E7%9F%A9%E9%98%B5%29">2.2 配置 Framework Compatibility Matrix (FCM，兼容性矩阵)</a></p> 
<p id="2.3%20%E9%85%8D%E7%BD%AE%E4%BD%BFAIDL%E7%BC%96%E8%AF%91-toc" style="margin-left:40px"><a href="#2.3%20%E9%85%8D%E7%BD%AE%E4%BD%BFAIDL%E7%BC%96%E8%AF%91">2.3 配置使AIDL编译</a></p> 
<p id="2%E7%AB%A0%E6%8A%A5%E9%94%99%E9%80%9F%E6%9F%A5-toc" style="margin-left:40px"><a href="#2%E7%AB%A0%E6%8A%A5%E9%94%99%E9%80%9F%E6%9F%A5">2章报错速查</a></p> 
<p id="3.%20%E5%AE%9E%E7%8E%B0service-toc" style="margin-left:0px"><a href="#3.%20%E5%AE%9E%E7%8E%B0service">3. 实现service</a></p> 
<p id="3.1%20%E7%BC%96%E5%86%99service%E4%BB%A3%E7%A0%81-toc" style="margin-left:40px"><a href="#3.1%20%E7%BC%96%E5%86%99service%E4%BB%A3%E7%A0%81">3.1 编写service代码</a></p> 
<p id="3.2%20%E5%88%9B%E5%BB%BAservice%E7%BC%96%E8%AF%91%E8%A7%84%E5%88%99-toc" style="margin-left:40px"><a href="#3.2%20%E5%88%9B%E5%BB%BAservice%E7%BC%96%E8%AF%91%E8%A7%84%E5%88%99">3.2 创建service编译规则</a></p> 
<p id="3.3%20%E5%B0%86service%E6%B7%BB%E5%8A%A0%E8%BF%9B%E7%B3%BB%E7%BB%9F-toc" style="margin-left:40px"><a href="#3.3%20%E5%B0%86service%E6%B7%BB%E5%8A%A0%E8%BF%9B%E7%B3%BB%E7%BB%9F">3.3 将service添加进系统</a></p> 
<p id="3%E7%AB%A0%E6%8A%A5%E9%94%99%E9%80%9F%E6%9F%A5-toc" style="margin-left:40px"><a href="#3%E7%AB%A0%E6%8A%A5%E9%94%99%E9%80%9F%E6%9F%A5">3章报错速查</a></p> 
<p id="4.%20%E7%A1%AE%E4%BF%9Dservice%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8-toc" style="margin-left:0px"><a href="#4.%20%E7%A1%AE%E4%BF%9Dservice%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8">4. 确保service开机启动</a></p> 
<p id="4.0%20%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AESEpolicy-toc" style="margin-left:40px"><a href="#4.0%20%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AESEpolicy">4.0 开始配置SEpolicy</a></p> 
<p id="4.1%20%E6%B7%BB%E5%8A%A0%E6%96%B0feature%E7%9B%AE%E5%BD%95-toc" style="margin-left:40px"><a href="#4.1%20%E6%B7%BB%E5%8A%A0%E6%96%B0feature%E7%9B%AE%E5%BD%95">4.1 添加新feature目录</a></p> 
<p id="4.2%20%E5%88%9B%E5%BB%BA%20hal_sensorscalibrate_default.te-toc" style="margin-left:40px"><a href="#4.2%20%E5%88%9B%E5%BB%BA%20hal_sensorscalibrate_default.te">4.2 创建 hal_sensorscalibrate_default.te</a></p> 
<p id="4.3%20%E5%88%9B%E5%BB%BA%20file_contexts-toc" style="margin-left:40px"><a href="#4.3%20%E5%88%9B%E5%BB%BA%20file_contexts">4.3 创建 file_contexts</a></p> 
<p id="4.1%20%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E6%97%B6%E7%9A%84%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95-toc" style="margin-left:40px"><a href="#4.1%20%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E6%97%B6%E7%9A%84%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95">4.1 无法启动时的排查方法</a></p> 
<p id="5.%20java%E5%B1%82%E8%B0%83%E7%94%A8service%EF%BC%88%E5%90%ABsepolicy%E9%85%8D%E7%BD%AE%EF%BC%89-toc" style="margin-left:0px"><a href="#5.%20java%E5%B1%82%E8%B0%83%E7%94%A8service%EF%BC%88%E5%90%ABsepolicy%E9%85%8D%E7%BD%AE%EF%BC%89">5. java层调用service（含sepolicy配置）</a></p> 
<p id="-toc" style="margin-left:0px"></p> 
<hr id="hr-toc"> 
<p></p> 
<p>欢迎指正交流，谢谢！</p> 
<h1>
<a name="t1"></a><a id="1_AIDL_5"></a>
</h1> 
<h1 id="1.%20%E5%AE%9A%E4%B9%89%E6%96%B0%E7%9A%84AIDL%E6%8E%A5%E5%8F%A3" style="margin-left:0"><span style="color:#000000"><a name="h.3w54404iabbn"></a>1. 定义新的AIDL接口</span></h1> 
<p style="margin-left:0"><span style="color:#000000"><span style="color:#4a86e8">目标：将旧接口全部转换为新接口</span></span></p> 
<p style="margin-left:0"><span style="color:#000000"><span style="color:#4a86e8">验证目标：肉眼检查所有的接口文件已转换，即可</span></span></p> 
<p style="margin-left:0"></p> 
<p style="margin-left:0"><span style="color:#000000">我们使用AOSP自带的转换工具：<a href="https://source.android.com/docs/core/architecture/aidl/aidl-hals#converting-to-aidl" title="hidl">hidl</a><a href="https://source.android.com/docs/core/architecture/aidl/aidl-hals#converting-to-aidl" title="2">2</a><a href="https://source.android.com/docs/core/architecture/aidl/aidl-hals#converting-to-aidl" title="aidl">aidl</a>，将旧版hidl接口转换为aidl接口。</span></p> 
<h2 id="1.1%20%E7%BC%96%E8%AF%91hidl2aidl%E5%B7%A5%E5%85%B7" style="margin-left:0"><span style="color:#000000"><a name="h.sdnv1xs6oexk"></a>1.1 编译hidl2aidl工具</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        编译可以在任意位置执行，这里以vendor根目录为例</span></p> 
<blockquote> 
 <p style="margin-left:0">source /opt/conf/openjdk18.conf<br> source build/envsetup.sh<br> lunch 项目名-userdebug<br> m hidl2aidl</p> 
</blockquote> 
<h2 id="1.2%20%E6%89%A7%E8%A1%8C%E8%BD%AC%E6%8D%A2" style="margin-left:0"><span style="color:#000000"><a name="h.kf6lrvz4gscc"></a>1.2 执行转换</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        运行hidl2aidl工具。它会读取我们指定的hidl接口，并生成转换后的aidl。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        在命令里，我们需要指定hidl包的所在位置，不然工具会找不到对应的hidl包。</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#333333">hidl2aidl -o </span></span><span style="background-color:#f3f3f3"><span style="color:#008000">输出路径</span></span><span style="background-color:#f3f3f3"><span style="color:#333333"> -r </span></span><span style="background-color:#f3f3f3"><span style="color:#cc0000">hidl</span></span><span style="background-color:#f3f3f3"><span style="color:#cc0000">包名</span></span><span style="background-color:#f3f3f3"><span style="color:#333333">:</span></span><span style="background-color:#f3f3f3"><span style="color:#bf9000">hidl</span></span><span style="background-color:#f3f3f3"><span style="color:#bf9000">包根目录（即</span></span><span style="background-color:#f3f3f3"><span style="color:#bf9000">/1.0</span></span><span style="background-color:#f3f3f3"><span style="color:#bf9000">的上层目录）</span></span>  <span style="background-color:#f3f3f3"><span style="color:#cc0000">hidl</span></span><span style="background-color:#f3f3f3"><span style="color:#cc0000">包名</span></span><span style="background-color:#f3f3f3"><span style="color:#333333">@</span></span><span style="background-color:#f3f3f3"><span style="color:#333333">要转换的</span></span><span style="background-color:#f3f3f3"><span style="color:#333333">hidl</span></span><span style="background-color:#f3f3f3"><span style="color:#333333">版本</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000"><span style="background-color:#ffffff">        其中的输出路径，我们创建一个aidl</span><span style="background-color:#ffffff">文件夹，此文件夹与</span><span style="background-color:#ffffff">hidl</span><span style="background-color:#ffffff">接口（</span><span style="background-color:#ffffff">1.0</span><span style="background-color:#ffffff">、</span><span style="background-color:#ffffff">2.0</span><span style="background-color:#ffffff">等文件夹）同级。冒号两侧不能有空格。</span></span></p> 
<p style="margin-left:0"></p> 
<p style="margin-left:0"><span style="color:#000000"><span style="background-color:#ffffff">        例如：</span></span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#333333">hidl2aidl -o </span><span style="color:#008000">vendorabcd/hardware/interfaces/sensorscalibrate/aidl/</span><span style="color:#333333"> -r </span><span style="color:#cc0000">vendorabcd.hardware.sensorscalibrate</span><span style="color:#333333">:</span><span style="color:#bf9000">vendorabcd/hardware/int<span style="background-color:#f3f3f3">er</span>faces/sensorscalibrate</span> <span style="color:#cc0000">vendorabcd.hardware.sensorscalibrate</span><span style="color:#333333">@1.0</span></span></p> 
</blockquote> 
<p style="margin-left:0"></p> 
<h2 id="1.3%20%E8%B0%83%E6%95%B4%E7%BC%96%E8%AF%91%E8%A7%84%E5%88%99%EF%BC%88bp%E6%96%87%E4%BB%B6%EF%BC%89" style="margin-left:0"><span style="color:#000000"><a name="h.ygba7vspmpwb"></a>1.3 调整编译规则（bp文件）</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        首先检查转换生成的文件。转换会生成 <strong>.aidl </strong>和 <strong>Android.bp </strong>两种文件。</span></p> 
<p id=".aidl%E6%96%87%E4%BB%B6" style="margin-left:0px"><strong><span style="color:#434343"><a name="h.soueg8csrqdf"></a>.aidl文件</span></strong></p> 
<p style="margin-left:0"><span style="color:#000000">        检查所在路径，要与包名匹配。例如包名：<span style="background-color:#f3f3f3">vendorabcd.hardware.sensorscalibrate</span>，文件路径应为： </span><span style="color:#000000"><span style="background-color:#f3f3f3">aidl/vendorabcd/hardware/sensorscalibrate/ISensorsCalibrate.aidl</span></span></p> 
<p id="Android.bp%E6%96%87%E4%BB%B6" style="margin-left:0px"><strong><span style="color:#434343"><a name="h.5nskxtnkppja"></a>Android.bp文件</span></strong></p> 
<p style="margin-left:0"><span style="color:#000000">        生成的bp文件需要修改，示例如下：（红色部分为需要修改的部分）</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000">aidl_interface {<!-- --></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    name: "vendorabcd.hardware.sensorscalibrate",</span></p> 
 <p style="margin-left:0"><span style="color:#000000">    vendor_available: true, <span style="color:#008000">//</span><span style="color:#008000">这里设置为</span><span style="color:#008000">true</span><span style="color:#008000">，因为是</span><span style="color:#008000">vendor</span><span style="color:#008000">目录下的模块</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    <span style="color:#ff0000">owner: "vendorabcd",</span> <span style="color:#008000">//</span><span style="color:#008000">作为</span><span style="color:#008000">vendor</span><span style="color:#008000">模块，需要设定</span><span style="color:#008000">owner</span><span style="color:#008000">才可以通过编译</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    srcs: ["vendorabcd/hardware/sensorscalibrate/*.aidl"],</span></p> 
 <p style="margin-left:0"><span style="color:#000000">    stability: "vintf", <span style="color:#008000">//</span><span style="color:#008000">标示此接口为</span><span style="color:#008000">Stable AIDL</span><span style="color:#008000">，必需</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    backend: {<!-- --></span></p> 
 <p style="margin-left:0"><span style="color:#000000">        cpp: {<!-- --></span></p> 
 <p style="margin-left:0"><span style="color:#000000">            enabled: <span style="color:#ff0000">false</span>, <span style="color:#008000">//</span><span style="color:#008000">产生一个</span><span style="color:#008000">cpp backend</span><span style="color:#008000">，</span><span style="color:#008000">.cpp</span><span style="color:#008000">文件（</span><span style="color:#008000">unstable</span><span style="color:#008000">版）</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#008000">                           //</span><span style="color:#008000">如果想要使用旧版</span><span style="color:#008000">unstable AIDL</span><span style="color:#008000">，设置为</span><span style="color:#008000">true</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">        },</span></p> 
 <p style="margin-left:0"><span style="color:#000000">        java: {<!-- --></span></p> 
 <p style="margin-left:0"><span style="color:#000000">            sdk_version: "module_current", <span style="color:#008000">//</span><span style="color:#008000">产生一个</span><span style="color:#008000">java backend</span><span style="color:#008000">，</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#008000">                           //</span><span style="color:#008000">默认</span><span style="color:#008000">enabled</span><span style="color:#008000">，用来在</span><span style="color:#008000">framework</span><span style="color:#008000">层使用此接口</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">        },</span></p> 
 <p style="margin-left:0"><span style="color:#000000">       <span style="color:#ff0000"> ndk: {<!-- --></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#ff0000">            enabled: true, </span><span style="color:#008000">//</span><span style="color:#008000">产生一个</span><span style="color:#008000">ndk backend</span><span style="color:#008000">，</span><span style="color:#008000">.cpp</span><span style="color:#008000">文件（</span><span style="color:#008000">stable</span><span style="color:#008000">版）</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#008000">                           //</span><span style="color:#008000">要使用</span><span style="color:#008000">aidl</span><span style="color:#008000">通信，需要</span><span style="color:#008000">ndk</span><span style="color:#008000">后端</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#008000">                           //</span><span style="color:#008000">不允许使用</span><span style="color:#008000">vndk</span><span style="color:#008000">，因为它不是</span><span style="color:#008000">stable</span><span style="color:#008000">的</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">        <span style="color:#ff0000">},</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    },</span></p> 
 <p style="margin-left:0"><span style="color:#000000">}</span></p> 
</blockquote> 
<h1 id="2.%20%E5%90%91%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F%E6%B7%BB%E5%8A%A0AIDL%E6%8E%A5%E5%8F%A3" style="margin-left:0"><span style="color:#000000"><a name="h.y6n3hu5vntu4"></a>2. 向vendor镜像添加AIDL接口</span></h1> 
<p style="margin-left:0"><span style="color:#000000"><span style="color:#4a86e8">目标：通过编译，编译生成vendor镜像，其中包含</span><span style="color:#4a86e8">aidl</span><span style="color:#4a86e8">接口</span></span></p> 
<p style="margin-left:0"><span style="color:#000000"><span style="color:#4a86e8">验证目标：</span><span style="color:#4a86e8">out_hal/soong/.intermediates/system/tools/aidl/build/aidl_metadata_json/</span><span style="color:#4a86e8">此目录下生成了对应的</span><span style="color:#4a86e8">.aidl</span><span style="color:#4a86e8">文件，并成功全编译</span></span></p> 
<h2 id="2.1%20%E4%BD%BF%E7%94%A8update-api%20freeze-api%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3%E7%89%88%E6%9C%AC" style="margin-left:0"><span style="color:#000000"><a name="h.psf40mbiw9ar"></a>2.1 使用update-api freeze-api管理接口版本</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        AOSP要求我们使用此工具，用来管理接口版本。这个工具做的事情是：把我们写的接口复制一份，然后标上版本号，作为一个冻结的（stable的）版本。之后正式编译时，就自动使用它复制出来的版本。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        进入aidl目录（即我们为hidl2aidl指定的output目录），执行以下命令：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">source &lt;</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">项目位置</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">&gt;/build/envsetup.sh</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">lunch </span></span><span style="background-color:#f3f3f3"><span style="color:#434343">项目名</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">-userdebug</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">m vendorabcd.hardware.sensorscalibrate</span></span><span style="background-color:#f3f3f3"><span style="color:#85200c">-update-api </span></span><span style="background-color:#f3f3f3"><span style="color:#008000">//</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">复制现在的版本到aidl_api/current</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">m vendorabcd.hardware.sensorscalibrate</span></span><span style="background-color:#f3f3f3"><span style="color:#85200c">-freeze-api </span></span><span style="background-color:#f3f3f3"><span style="color:#008000">//从current</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">生成一个新的版本（号）</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        以上命令会生成一个叫aidl_api的目录，并在里面做各种修改。我们不要手动修改这个目录的内容。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        以上命令还会在Android.bp中生成一个新的字段：versions: [“1”], 代表版本号。这一字段由api工具管理&amp;修改，我们不要手动修改这个字段。</span></p> 
<p style="margin-left:0"></p> 
<h2 id="2.2%20%E9%85%8D%E7%BD%AE%20Framework%20Compatibility%20Matrix%20(FCM%EF%BC%8C%E5%85%BC%E5%AE%B9%E6%80%A7%E7%9F%A9%E9%98%B5)" style="margin-left:0"><span style="color:#000000"><a name="h.sn72dvcqi5ic"></a>2.2 配置 Framework Compatibility Matrix (FCM，兼容性矩阵)</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        FCM指定了msi与vendor间的兼容关系。因此，对我们新定义的接口，需要在msi和vendor两个目录中，都配置FCM兼容关系。</span></p> 
<p id="vendor%E7%9B%AE%E5%BD%95%E4%B8%AD" style="margin-left:0px"><strong><span style="color:#434343"><a name="h.igs0y74hrv98"></a>vendor目录中</span></strong></p> 
<p style="margin-left:0"><span style="color:#000000">        FCM文件位置：</span></p> 
<p style="margin-left:0"><span style="color:#000000">        </span><span style="color:#000000"><span style="background-color:#f3f3f3">vendor/device/vendorabcd/&lt;机型project名</span><span style="background-color:#f3f3f3">&gt;(/……)/</span><span style="background-color:#f3f3f3"><span style="color:#0000ff">framework_compatibility_matrix.xml</span></span></span></p> 
<p style="margin-left:0"><span style="color:#000000">        在FCM文件中，我们可能会找到如下的旧版hidl配置：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">   &lt;hal format="hidl" optional="true"&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">        &lt;name&gt;vendorabcd.hardware.sensorscalibrate&lt;/name&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">        &lt;version&gt;1.0&lt;/version&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">        &lt;interface&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">            &lt;name&gt;ISensorsCalibrate&lt;/name&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">            &lt;instance&gt;default&lt;/instance&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">        &lt;/interface&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">   &lt;/hal&gt;</span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        在新的vendor image中，我们的新接口将要取代旧接口。因此，我们将hidl更改为aidl：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    &lt;hal format="</span><span style="color:#ff0000">aidl</span><span style="color:#434343">" optional="true"&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">        &lt;name&gt;vendorabcd.hardware.sensorscalibrate&lt;/name&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">       <s><span style="color:#ff0000"> &lt;version&gt;1.0&lt;/version&gt;</span></s></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">        &lt;interface&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">            &lt;name&gt;ISensorsCalibrate&lt;/name&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">            &lt;instance&gt;default&lt;/instance&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">         &lt;/interface&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    &lt;/hal&gt;</span></span></p> 
</blockquote> 
<p id="msi%E7%9B%AE%E5%BD%95%E4%B8%AD" style="margin-left:0px"><strong><span style="color:#434343"><a name="h.pbo74tt986d9"></a>msi目录中</span></strong></p> 
<p style="margin-left:0"><span style="color:#000000">        FCM文件位置：</span></p> 
<p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3">        msi/device/vendorabcd/&lt;机型</span><span style="background-color:#f3f3f3">project</span><span style="background-color:#f3f3f3">名</span><span style="background-color:#f3f3f3">&gt;(/mssi)/framework_compatibility_matrix.xml</span></span></p> 
<p style="margin-left:0"><span style="color:#000000">        我们希望system image既具有对新版aidl的支持，又能够兼容原本的hidl接口。因此这里无需修改，直接添加新的aidl接口到文件中：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000">    <span style="color:#434343">&lt;hal format="aidl" optional="true"&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">        &lt;name&gt;vendorabcd.hardware.sensorscalibrate&lt;/name&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">        &lt;interface&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">            &lt;name&gt;ISensorsCalibrate&lt;/name&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">            &lt;instance&gt;default&lt;/instance&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">         &lt;/interface&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    &lt;/hal&gt;</span></span></p> 
</blockquote> 
<h2 id="2.3%20%E9%85%8D%E7%BD%AE%E4%BD%BFAIDL%E7%BC%96%E8%AF%91" style="margin-left:0"><span style="color:#000000"><a name="h.21bbjzxuemvf"></a>2.3 配置使AIDL编译</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        配置vendor镜像编译。我们用aidl取代原本的hidl接口，无需保留原有hidl接口。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        首先找到此前的hidl接口编译manifest。它在<span style="background-color:#f3f3f3">device/vendorabcd/&lt;project</span><span style="background-color:#f3f3f3">名或</span><span style="background-color:#f3f3f3">chipset</span><span style="background-color:#f3f3f3">名</span><span style="background-color:#f3f3f3">&gt;</span>目录下的某个.xml文件之中，其中会有类似这样的内容：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">&lt;</span></span><span style="color:#ff0000">manifest</span><span style="background-color:#f3f3f3"><span style="color:#434343"> version="1.0" type="device"&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">    &lt;hal format="hidl"&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">        &lt;name&gt;vendorabcd.hardware.sensorscalibrate&lt;/name&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">        &lt;transport&gt;hwbinder&lt;/transport&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">        &lt;version&gt;1.0&lt;/version&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">        &lt;interface&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">            &lt;name&gt;ISensorsCalibrate&lt;/name&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">            &lt;instance&gt;default&lt;/instance&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">        &lt;/interface&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">    &lt;/hal&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">&lt;/manifest&gt;</span></span></span></p> 
</blockquote> 
<p style="margin-left:0">        <span style="color:#000000">我们将其改为aidl：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">&lt;manifest version="1.0" type="device"&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">    &lt;hal format="</span></span><span style="color:#ff0000">aidl</span><span style="background-color:#f3f3f3"><span style="color:#434343">"&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">        &lt;name&gt;vendorabcd.hardware.sensorscalibrate&lt;/name&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">       <span style="background-color:#f3f3f3"><span style="color:#ff0000"> <s>&lt;transport&gt;hwbinder&lt;/transport&gt;</s></span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">        <span style="background-color:#f3f3f3"><span style="color:#333333">&lt;version&gt;</span></span><span style="background-color:#f3f3f3"><span style="color:#ff0000">1</span></span><span style="background-color:#f3f3f3"><span style="color:#333333">&lt;/version&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">        <span style="background-color:#f3f3f3"><span style="color:#1155cc">[</span></span><span style="background-color:#f3f3f3"><span style="color:#1155cc">可以保留原本的写法：</span></span><span style="background-color:#f3f3f3"><span style="color:#1155cc">]</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#1155cc">        &lt;interface&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#1155cc">            &lt;name&gt;ISensorsCalibrate&lt;/name&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#1155cc">            &lt;instance&gt;default&lt;/instance&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#1155cc">        &lt;/interface&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">      <span style="background-color:#f3f3f3"><span style="color:#1155cc">[</span></span><span style="background-color:#f3f3f3"><span style="color:#1155cc">或者使用</span></span><span style="background-color:#f3f3f3"><span style="color:#1155cc">fqname</span></span><span style="background-color:#f3f3f3"><span style="color:#1155cc">：</span></span><span style="background-color:#f3f3f3"><span style="color:#1155cc">]</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">      <span style="background-color:#f3f3f3"><span style="color:#1155cc">&lt;fqname&gt;ISensorsCalibrate/default&lt;/fqname&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#1155cc">        [</span></span><span style="background-color:#f3f3f3"><span style="color:#1155cc">两种任选一个即可</span></span><span style="background-color:#f3f3f3"><span style="color:#1155cc">]</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">    &lt;/hal&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">&lt;/manifest&gt;</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        现在，尝试进行先msi后vendor的全编译。应该能够正常完成整个编译。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        编译完成后，会在以下目录中，有生成对应的aidl文件：</span></p> 
<p style="margin-left:0"><span style="color:#000000">        <span style="background-color:#f3f3f3">out_hal/soong/.intermediates/system/tools/aidl/build/aidl_metadata_json/metadata_包名</span></span></p> 
<p style="margin-left:0"><span style="color:#000000">        以上我们配置的aidl manifest，其位置并不强制一定要放在此路径下面。之后我将会移动此manifest的位置，将其和service放在一起。您也可以选择之后不移动。</span></p> 
<p style="margin-left:0"></p> 
<h2 id="2%E7%AB%A0%E6%8A%A5%E9%94%99%E9%80%9F%E6%9F%A5" style="margin-left:0"><span style="color:#000000"><a name="h.va0o41s0ff4n"></a>2章报错速查</span></h2> 
<p id="module%20%22...%22%20already%20defined" style="margin-left:0px"><strong><span style="color:#434343"><a name="h.o9yi9fyeplna"></a><span style="background-color:#f4cccc">module "..." already defined</span></span></strong></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解释：</strong>包名称重复</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>错误原因：</strong>通常是因为原本的hidl接口带有如下结构：在接口根目录下的bp文件中，定义了如下package root：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">hidl_package_root {<!-- --></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    name: "vendorabcd.hardware.sensorscalibrate",</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">}</span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">因此导致了新的aidl接口与旧package root名字冲突。</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解决方法：</strong>修改新的aidl接口的名称。请注意之前的每一步骤中xml文件中的&lt;name&gt;都需要修改。也需要修改.aidl文件中的package名。也需要修改.aidl文件所存放的路径，与新接口名称相符合。还需要对应修改Android.bp中的srcs路径。</span></p> 
<p id="FAILED%3A%20out%2Fsoong%2F...%C2%A0%20echo%20%E5%8C%85%E5%90%8D-api%20missing%20dependencies" style="margin-left:0px"><strong><span style="color:#434343"><a name="h.242qcs3izjdt"></a><span style="background-color:#f4cccc">FAILED: out/soong/...  echo </span><span style="background-color:#f4cccc">包名</span><span style="background-color:#f4cccc">-api missing dependencies</span></span></strong></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解释：</strong>找不到对应版本的api</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>错误原因：</strong>可能是因为手动修改了Android.bp中的versions字段，导致编译工具去寻找一个不存在的版本。</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解决方法：</strong>将versions字段清空，并完全删除aidl_api目录。之后，再重新执行update-api和freeze-api。</span></p> 
<p id="module%20%22%E5%8C%85%E5%90%8D-api%22%20(created%20by%20module%20%22%E5%8C%85%E5%90%8D_interface%22)%3A%20srcs%3A%20No%20sources%20provided." style="margin-left:0px"><strong><span style="color:#434343"><a name="h.h6m39bs101sc"></a><span style="background-color:#f4cccc">module "</span><span style="background-color:#f4cccc">包名</span><span style="background-color:#f4cccc">-api" (created by module "</span><span style="background-color:#f4cccc">包名</span><span style="background-color:#f4cccc">_interface"): srcs: No sources provided.</span></span></strong></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解释：</strong>srcs目录下没有找到有效的源文件</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>错误原因：</strong>Android.bp中srcs配置有问题，可能是因为修改了aidl所在目录，导致找不到aidl文件。</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解决方法：</strong>修改srcs，aidl文件应该直接放在srcs目录内。</span></p> 
<p id="files%20are%20incompatible%3A%20The%20following%20instances%20are%20in%20the%20device%20manifest%20but%20not%20specified%20in%20framework%20compatibility%20matrix" style="margin-left:0px"><strong><span style="color:#434343"><a name="h.l20oahsog40b"></a><span style="background-color:#f4cccc">files are incompatible: The following instances are in the device manifest but not specified in framework compatibility matrix </span></span></strong></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解释：</strong>模块在device manifest中指定了，但是找不到对应的FCM</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>错误原因：</strong>FCM配置有问题，条目未添加，或添加了但写错了导致不匹配。</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解决方法：</strong>请检查两个FCM内是否有拼写错误等，同时检查manifest中的名字是否写对。</span></p> 
<p style="margin-left:0"></p> 
<h1 id="3.%20%E5%AE%9E%E7%8E%B0service" style="margin-left:0"><span style="color:#000000"><a name="h.ssdwd9h59zf0"></a>3. 实现service</span></h1> 
<p style="margin-left:0"><span style="color:#000000"><span style="color:#4a86e8">目标：成功编译</span><span style="color:#4a86e8">service</span></span></p> 
<p style="margin-left:0"><span style="color:#000000"><span style="color:#4a86e8">验证目标：检查手机中</span><span style="color:#4a86e8">/vendor/bin/hw/</span><span style="color:#4a86e8">目录下是否有</span><span style="color:#4a86e8">service</span><span style="color:#4a86e8">编译出的二进制文件，例如</span><span style="color:#4a86e8">/vendor/bin/hw/vendorabcd.hardware.sensorscalibrate-service</span></span></p> 
<p style="margin-left:0"><span style="color:#000000">        service为一个可执行文件。我们之前步骤中完成的AIDL接口，定义了一种信息结构，不承担功能。接下来要做的service，负责功能执行，service会接收AIDL接口发来的信息，并处理相关的功能运作。可以用Server-Client模型理解，此service即为server端，负责处理client端发来的请求，并和后台交互以执行功能。</span></p> 
<h2 id="3.1%20%E7%BC%96%E5%86%99service%E4%BB%A3%E7%A0%81" style="margin-left:0"><span style="color:#000000"><a name="h.tkc5h3apacph"></a>3.1 编写service代码</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        首先，请在aidl目录下，创建一个default目录。我们所有的service相关内容都会放在这个default目录下。</span></p> 
<p style="margin-left:0"><span style="color:#000000"><span style="color:#999999">        *理论上，</span><span style="color:#999999">service</span><span style="color:#999999">可以放在任何地方，但和</span><span style="color:#999999">aidl</span><span style="color:#999999">放在一处更好，便于管理。</span></span></p> 
<p style="margin-left:0"><span style="color:#000000">        进入default目录。我们将要创建三个文件：<strong>service.cpp，SensorsCalibrate.h，SensorsCalibrate.cpp</strong>。</span></p> 
<p id="service.cpp" style="margin-left:0px"><span style="color:#434343"><a name="h.p0bpe2t17wni"></a><strong><span style="background-color:#f3f3f3">service.cpp</span></strong></span></p> 
<p style="margin-left:0"><span style="color:#000000">        创建这个文件，只需修改标红的部分，其余照抄即可：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">#define LOG_TAG "</span><span style="color:#ff0000">vendorabcd.hardware.sensorscalibrate</span><span style="color:#434343">-service"</span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">#include "</span><span style="color:#ff0000">SensorsCalibrate</span><span style="color:#434343">.h"</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">#include &lt;android-base/logging.h&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">#include &lt;android/binder_manager.h&gt;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">#include &lt;android/binder_process.h&gt;</span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">using aidl::</span><span style="color:#ff0000">vendorabcd::hardware::sensorscalibrate::SensorsCalibrate</span><span style="color:#434343">;</span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">int main() {<!-- --></span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    ABinderProcess_setThreadPoolMaxThreadCount(0);</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    std::shared_ptr&lt;</span><span style="color:#ff0000">SensorsCalibrate</span><span style="color:#434343">&gt; </span><span style="color:#ff0000">senCal </span><span style="color:#434343">= ndk::SharedRefBase::make&lt;</span><span style="color:#ff0000">SensorsCalibrate</span><span style="color:#434343">&gt;();</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    if (!</span><span style="color:#ff0000">senCal</span><span style="color:#434343">) {<!-- --></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">        return EXIT_FAILURE;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    }</span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    const std::string instance = std::string() + </span><span style="color:#ff0000">SensorsCalibrate</span><span style="color:#434343">::descriptor + "/default";</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    binder_status_t status = AServiceManager_addService(</span><span style="color:#ff0000">senCal</span><span style="color:#434343">-&gt;asBinder().get(), instance.c_str());</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    CHECK(status == STATUS_OK);</span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    ABinderProcess_joinThreadPool();</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    return EXIT_FAILURE; </span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">}</span></span></p> 
</blockquote> 
<p id="SensorsCalibrate.h" style="margin-left:0px"><span style="color:#434343"><a name="h.wsi82qnadux"></a><strong><span style="background-color:#f3f3f3">SensorsCalibrate.h</span></strong></span></p> 
<p style="margin-left:0"><span style="color:#000000">        在这个文件中，我们将aidl接口所提供的Bn类，扩展为方便使用的类。具体来说，我们需要对aidl中的每一个接口，都进行一次“翻译”。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        例子如下：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000">#pragma once</span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000">#include &lt;aidl/<span style="color:#ff0000">vendorabcd/hardware/sensorscalibrate</span>/Bn<span style="color:#ff0000">SensorsCalibrate</span>.h&gt;</span></p> 
 <p style="margin-left:0"><span style="color:#000000">namespace aidl {<!-- --></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#ff0000">namespace vendorabcd {<!-- --></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#ff0000">namespace hardware {<!-- --></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#ff0000">namespace sensorscalibrate {<!-- --></span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000">class <span style="color:#ff0000">SensorsCalibrate </span>: public Bn<span style="color:#ff0000">SensorsCalibrate</span>{<!-- --></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#0000ff">    ndk::ScopedAStatus SensorsCal(int32_t sensor_type, </span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#0000ff">                                  int8_t operation_type, </span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#0000ff">                                  std::string* _aidl_return) override;</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">};</span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000">}  // namespace sensorscalibrate</span></p> 
 <p style="margin-left:0"><span style="color:#000000">}  // namespace hardware</span></p> 
 <p style="margin-left:0"><span style="color:#000000">}  // namespace vendorabcd</span></p> 
 <p style="margin-left:0"><span style="color:#000000">}  // namespace aidl</span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        标蓝部分和aidl文件中的接口一一对应。我的例子中只有一个方法，是因为我的aidl文件只定义了一个接口。对于多个aidl接口，我们对每一个都要写一条这样的ndk“翻译”。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        因为我们上一章已经成功编译了aidl，标蓝部分的写法可以直接复制。对应文件所在路径为：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000">out/soong/.intermediates/<span style="color:#4a86e8">vendorabcd/hardware/interfaces/sensorscalibrate</span>/<span style="color:#6aa84f">vendorabcd.hardware.sensorscalibrate</span>-V1-<span style="color:#ff0000">ndk_platform-source</span>/gen/include/aidl/<span style="color:#6aa84f">vendorabcd/hardware/sensorscalibrate</span>/<span style="color:#ff0000">Bp</span>SensorsCalibrate.h</span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        其中标红的部分容易混淆，请注意路径名。标蓝的部分与aidl文件所在的路径对应。标绿的部分与包名相对应。</span></p> 
<p style="margin-left:0"></p> 
<p style="margin-left:0"><span style="color:#000000">        在复制时，只需要复制其中的与aidl对应的方法即可。 <span style="background-color:#f3f3f3">getInterfaceVersion, getInterfaceHash</span> 、构造析构函数、以及成员变量等，都不需要复制。</span></p> 
<p style="margin-left:0"></p> 
<p style="margin-left:0"><span style="color:#000000">（可看可不看的）详细解释：</span></p> 
<p style="margin-left:0"><span style="color:#000000">对照来看：由.aidl </span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#cc0000">String </span>SensorsCal(<span style="color:#0000ff">in int</span> sensor_type, <span style="color:#008000">in byte</span> operation_type)</span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">改写到.h </span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#45818e">ndk::ScopedAStatus</span> SensorsCal(<span style="color:#0000ff">int32_t</span> sensor_type, </span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#008000">                              int8_t</span> operation_type,</span></p> 
 <p style="margin-left:0"><span style="color:#000000">                              <span style="color:#cc0000">std::string*</span> _aidl_return) override;</span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">在.h文件中，我们将aidl返回值作为最后的参数。.h文件中返回类型改为<span style="color:#45818e">ndk::ScopedAStatus</span><span style="color:#45818e">。</span></span></p> 
<p style="margin-left:0"></p> 
<p id="SensorsCalibrate.cpp" style="margin-left:0px"><span style="color:#434343"><a name="h.1wu9amnzdq2q"></a><strong><span style="background-color:#f3f3f3">SensorsCalibrate.cpp</span></strong></span></p> 
<p style="margin-left:0"><span style="color:#000000">        此文件直接复制旧版hidl中的对应cpp即可。旧cpp文件可能与hidl定义不在同一处，我们已知文件名，可以通过搜索找到。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        文件中需要修改以下地方：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#ff0000">namespace aidl {<!-- --></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">namespace vendorabcd {<!-- --></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">namespace hardware {<!-- --></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">namespace sensorscalibrate {<!-- --></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><s><span style="color:#434343">namespace V1_0 {<!-- --></span></s></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><s><span style="color:#434343">namespace implementation {<!-- --></span></s></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><s><span style="color:#434343">Return&lt;void&gt; </span></s><span style="color:#434343">SensorsCalibrate::SensorsCal(int32_t sensor_type, int8_t operation_type,<s> SensorsCal_cb _hidl_cb) {<!-- --></s></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#ff0000">ndk::ScopedAStatus </span><span style="color:#434343">SensorsCalibrate::SensorsCal(</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">                   <span style="color:#434343">            int32_t sensor_type, </span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">                               int8_t operation_type, </span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#ff0000">                               std::string* _aidl_return</span><span style="color:#434343">) {<!-- --></span><span style="color:#008000">//</span><span style="color:#008000">与</span><span style="color:#008000">.h</span><span style="color:#008000">声明的一致</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#008000">    // ……</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    <span style="color:#008000">// </span><span style="color:#008000">功能实现部分，已省略</span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000">    <s>_hidl_cb("Successfully cal prox");</s> </span></p> 
 <p style="margin-left:0"><span style="color:#000000">   <span style="color:#ff0000"> *_aidl_return = "Successfully cal prox"; </span><span style="color:#008000">//</span><span style="color:#008000">此为</span><span style="color:#008000">hidl/aidl</span><span style="color:#008000">接口返回信息</span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000">    <s>return Void();</s>                     </span></p> 
 <p style="margin-left:0"><span style="color:#000000">    <span style="color:#ff0000">return ndk::ScopedAStatus::ok();</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">}</span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><s>ISensorsCalibrate* HIDL_FETCH_ISensorsCalibrate(const char* /* name */) {<!-- --></s></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><s>    return new SensorsCalibrate();</s></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><s>}</s>   <span style="color:#008000">//hidl</span><span style="color:#008000">的</span><span style="color:#008000">FETCH</span><span style="color:#008000">方法现在不需要，删除</span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><s>}  // namespace implementation</s></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><s>}  // namespace V1_0</s></span></p> 
 <p style="margin-left:0"><span style="color:#000000">}  // namespace sensorscalibrate</span></p> 
 <p style="margin-left:0"><span style="color:#000000">}  // namespace hardware</span></p> 
 <p style="margin-left:0"><span style="color:#000000">}  // namespace vendorabcd</span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#ff0000">}  // namespace aidl</span></span></p> 
</blockquote> 
<h2 id="3.2%20%E5%88%9B%E5%BB%BAservice%E7%BC%96%E8%AF%91%E8%A7%84%E5%88%99" style="margin-left:0"><span style="color:#000000"><a name="h.bf7d696tc6za"></a>3.2 创建service编译规则</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        要配置编译规则，我们在default目录下，继续添加以下三个文件：</span><span style="color:#434343"><span style="background-color:#f3f3f3"><strong>Android.mk/bp </strong>  </span><strong><span style="background-color:#f3f3f3"> .rc    .xml  </span></strong></span></p> 
<p id="Android.mk%20%2F%20Android.bp" style="margin-left:0px"><span style="color:#434343"><a name="h.ugx1kd43ru61"></a><strong><span style="background-color:#f3f3f3">Android.mk / Android.bp</span></strong></span></p> 
<p style="margin-left:0"><span style="color:#000000">        指定service的编译规则。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        具体使用mk文件还是bp文件，可以和hidl service保持一致。bp是更现代的方式；但如果要引用mk定义的模块，则也必须使用mk。因此，和hidl版本保持一致是最方便的选择。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        例如，hidl版本此service的Android.mk文件如下。我们直接在其上进行修改，用作aidl版本service的mk文件：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000">LOCAL_PATH := $(call my-dir)</span></p> 
 <p style="margin-left:0"><span style="color:#000000">include $(CLEAR_VARS)</span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><s>LOCAL_MODULE := vendorabcd.hardware.sensorscalibrate@1.0-service</s></span></p> 
 <p style="margin-left:0"><span style="color:#000000">LOCAL_MODULE := <span style="color:#ff0000">vendorabcd.hardware.sensorscalibrate</span>-service</span></p> 
 <p style="margin-left:0"><span style="color:#000000">LOCAL_PROPRIETARY_MODULE := true</span></p> 
 <p style="margin-left:0"><span style="color:#000000">LOCAL_MODULE_CLASS := EXECUTABLES</span></p> 
 <p style="margin-left:0"><span style="color:#000000">LOCAL_MODULE_RELATIVE_PATH := hw</span></p> 
 <p style="margin-left:0"><span style="color:#000000"><s>LOCAL_INIT_RC := vendorabcd.hardware.sensorscalibrate@1.0-service.rc</s></span></p> 
 <p style="margin-left:0"><span style="color:#000000">LOCAL_INIT_RC := <span style="color:#ff0000">vendorabcd.hardware.sensorscalibrate</span>-service.rc</span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#008000">//</span><span style="color:#008000">声明此</span><span style="color:#008000">service</span><span style="color:#008000">对</span><span style="color:#008000">aidl</span><span style="color:#008000">接口的依赖。之后，我们将创建这个文件。</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#ff0000">LOCAL_VINTF_FRAGMENTS := vendorabcd.hardware.sensorscalibrate.xml</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">LOCAL_SRC_FILES := </span></p> 
 <p style="margin-left:0"><span style="color:#000000">    SensorsCalibrate.cpp </span></p> 
 <p style="margin-left:0"><span style="color:#000000">    service.cpp</span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000">LOCAL_SHARED_LIBRARIES := </span></p> 
 <p style="margin-left:0"><span style="color:#000000">    <s>libhidlbase </s></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    <s>libhidltransport </s></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    <span style="color:#ff0000">libbinder_ndk  </span><span style="color:#008000">//Stable aidl</span><span style="color:#008000">必需</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    libutils </span></p> 
 <p style="margin-left:0"><span style="color:#000000">    libdl </span></p> 
 <p style="margin-left:0"><span style="color:#000000">    liblog </span></p> 
 <p style="margin-left:0"><span style="color:#000000">    libcutils </span></p> 
 <p style="margin-left:0"><span style="color:#000000">    libhardware </span></p> 
 <p style="margin-left:0"><span style="color:#000000">    libbase </span></p> 
 <p style="margin-left:0"><span style="color:#000000">    <s>vendorabcd.hardware.sensorscalibrate@1.0 </s></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#008000">    // </span><span style="color:#008000">包名</span><span style="color:#008000">-V1-ndk_platform</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    <span style="color:#ff0000">vendorabcd.hardware.sensorscalibrate-V1-ndk_platform </span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    libhfmanager</span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000">include $(BUILD_EXECUTABLE)</span></p> 
</blockquote> 
<p id=".rc" style="margin-left:0px"><span style="color:#434343"><a name="h.kq4e7xw2cjnm"></a><strong><span style="background-color:#f3f3f3">.rc</span></strong></span></p> 
<p style="margin-left:0"><span style="color:#000000">        文件名：<span style="background-color:#f3f3f3">vendorabcd.hardware.sensorscalibrate-service.rc</span></span></p> 
<p style="margin-left:0"><span style="color:#000000">        配置开机启动。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        此rc文件将被init.rc链接。我们可以在此文件中，指定开机时启动aidl service。示例如下：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">service </span><span style="color:#ff0000">vendor.sensorscalibrate-hal</span><span style="color:#434343"> /vendor/bin/hw/</span><span style="color:#ff0000">vendorabcd.hardware.sensorscalibrate-service </span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#008000">//service + </span><span style="color:#008000">注册名（可随意起一个）</span><span style="color:#008000"> + </span><span style="color:#008000">编译后的模块所在路径</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000">    <span style="color:#434343">class hal</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    user system</span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="color:#434343">    group system</span></span></p> 
</blockquote> 
<p id=".xml%20(manifest)" style="margin-left:0px"><span style="color:#434343"><a name="h.nrdfk8dxl8md"></a><strong><span style="background-color:#f3f3f3">.xml (manifest)</span></strong></span></p> 
<p style="margin-left:0"><span style="color:#000000">        文件名：<span style="background-color:#f3f3f3">vendorabcd.hardware.sensorscalibrate.xml</span></span></p> 
<p style="margin-left:0"><span style="color:#000000">        我把aidl接口的manifest转移到此处，因为service依赖于aidl。如果未来不需此service，则aidl接口也不编译。这一依赖关系，我们已在Android.mk中的<span style="background-color:#f3f3f3">LOCAL_VINTF_FRAGMENTS</span>声明过，此项配置指向的xml文件即为我们现在创建的xml文件。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        把2.3步中的aidl manifest删除，将其中内容转移到default目录下的此文件中。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        内容原样复制即可：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">&lt;</span></span><span style="color:#434343">manifest<span style="background-color:#f3f3f3"> version="1.0" type="device"&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">    &lt;hal format="aidl"&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">        &lt;name&gt;vendorabcd.hardware.sensorscalibrate&lt;/name&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">        &lt;version&gt;1&lt;/version&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">        &lt;interface&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">            &lt;name&gt;ISensorsCalibrate&lt;/name&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">            &lt;instance&gt;default&lt;/instance&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">        &lt;/interface&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">    &lt;/hal&gt;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">&lt;/manifest&gt;</span></span></span></p> 
</blockquote> 
<p id="%E5%B0%9D%E8%AF%95%E7%BC%96%E8%AF%91" style="margin-left:0px"><strong><span style="color:#434343"><a name="h.cqkksi7zl36h"></a>尝试编译</span></strong></p> 
<p style="margin-left:0"><span style="color:#000000">        在default目录下运行mm进行编译。（请记得先在vendor根目录下执行source build/envsetup.sh 和 lunch）现在应该能够完成模块编译。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        编译成功后，在<span style="background-color:#f3f3f3">out/target/product/&lt;project</span><span style="background-color:#f3f3f3">名</span><span style="background-color:#f3f3f3">&gt;/vendor/bin/hw</span>能看到编译得到的service可执行文件。</span></p> 
<h2 id="3.3%20%E5%B0%86service%E6%B7%BB%E5%8A%A0%E8%BF%9B%E7%B3%BB%E7%BB%9F" style="margin-left:0"><span style="color:#000000"><a name="h.b1ysflxsee1"></a>3.3 将service添加进系统</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        修改device.mk文件，以包含此service。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        我们首先找到hidl版本的编译声明，通常位置为<span style="background-color:#f3f3f3">device/vendorabcd/&lt;project</span><span style="background-color:#f3f3f3">名或</span><span style="background-color:#f3f3f3">chipset</span><span style="background-color:#f3f3f3">名</span><span style="background-color:#f3f3f3">&gt;/device.mk</span></span></p> 
<p style="margin-left:0"><span style="color:#000000">        例如，我找到这样的hidl编译配置：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">PRODUCT_PACKAGES += vendorabcd.hardware.sensorscalibrate@1.0-service </span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">                    vendorabcd.hardware.sensorscalibrate@1.0-service.rc </span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">                    vendorabcd.hardware.sensorscalibrate@1.0 </span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">                    vendorabcd.hardware.sensorscalibrate-V1.0-java </span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">                     vendorabcd-hardware-sensorscalibrate.xml</span></span></span></p> 
 <p style="margin-left:0"></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">DEVICE_MANIFEST_FILE += device/vendorabcd/chipset/mgvi/manifest_sensorscalibrate.xml</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        升级到aidl以后，只需配置好service，对应的xml即会自动加入编译。</span></p> 
<p style="margin-left:0"></p> 
<p style="margin-left:0"><span style="color:#000000">        把以上的内容全部删除。替换为：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">PRODUCT_PACKAGES += vendorabcd.hardware.sensorscalibrate-service</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        （可选）现在可以全编译一下，确认能够正常完成整个系统的全编译。</span></p> 
<h2 id="3%E7%AB%A0%E6%8A%A5%E9%94%99%E9%80%9F%E6%9F%A5" style="margin-left:0"><span style="color:#000000"><a name="h.k03om9hi9hbh"></a>3章报错速查</span></h2> 
<p id="FAILED%3A%20ninja%3A%20'.xml'%2C%20needed%20by%20'out_hal%2F(...)%2F.xml'%2C%20missing%20and%20no%20known%20rule%20to%20make%20it" style="margin-left:0px"><strong><span style="color:#434343"><a name="h.txhi894pntvb"></a><span style="background-color:#f4cccc">FAILED: ninja: '.xml', needed by 'out_hal/(...)/.xml', missing and no known rule to make it</span></span></strong></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解释：</strong>ninja错误：第2个路径xml中，需求了第1个路径的xml，但是找不到对应的文件</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>错误原因：</strong>可能因为manifest中的旧版本没有删除干净，导致编译器寻找已被删除的xml。</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解决方法：</strong>检查 <span style="background-color:#f3f3f3"><span style="color:#434343">DEVICE_MANIFEST_FILE </span></span>中旧版的xml配置，并删除干净</span></p> 
<p id="ld.lld%3A%20error%3A%20undefined%20symbol%3A%20%3E%3E%3E%20the%20vtable%20symbol%20may%20be%20undefined%20because%20the%20class%20is%20missing%20its%20key%20function" style="margin-left:0px"><strong><span style="color:#434343"><a name="h.iib6u12u25yo"></a><span style="background-color:#f4cccc">ld.lld: error: undefined symbol: &gt;&gt;&gt; the vtable symbol may be undefined because the class is missing its key function </span></span></strong></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解释：</strong>clang错误：没有找到对应的类，因为没有实现对应的虚函数。</span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>错误原因：</strong>cpp编写有误，例如实现函数时未声明namespace ：<span style="color:#434343">SensorsCalibrate::SensorsCal() </span><span style="color:#434343">错写成</span><span style="color:#434343"> SensorsCal()</span></span></p> 
<p style="margin-left:0"><span style="color:#000000"><strong>解决方法：</strong>检查cpp文件并修改</span></p> 
<p style="margin-left:0"></p> 
<h1 id="4.%20%E7%A1%AE%E4%BF%9Dservice%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8" style="margin-left:0"><span style="color:#000000"><a name="h.ualdxqeaafcb"></a>4. 确保service开机启动</span></h1> 
<p style="margin-left:0"><span style="color:#000000"><span style="color:#4a86e8">目标：开机时</span><span style="color:#4a86e8">service</span><span style="color:#4a86e8">能够自启动</span></span></p> 
<p style="margin-left:0"><span style="color:#000000"><span style="color:#4a86e8">验证目标：开机后，执行</span><span style="color:#4a86e8">adb shell service list</span><span style="color:#4a86e8">，能看到新的</span><span style="color:#4a86e8">service</span></span></p> 
<p style="margin-left:0"><span style="color:#000000">        本章将要配置SEpolicy以确保service开机启动。SEpolicy是引入了SELinux（kernel）后所需求的一种安全策略。SELinux会默认阻止一些关键操作（例如文件操作，ioctl等），我们需要逐条声明后，才能合法进行这些操作。</span></p> 
<h2 id="4.0%20%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AESEpolicy" style="margin-left:0"><span style="color:#000000"><a name="h.ryahofegt8er"></a>4.0 开始配置SEpolicy</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        在第3章最后，我们能编译得到一个新的系统版本。但在这个版本中，service不会随开机启动，因为我们还没有配置SEpolicy。一种更具有演示性的做法是，我们收集log中的拒绝信息，再对应配置SEpolicy。然而，由于全编译一次的时间成本过高，在这里，我们先配置完所需的SEpolicy，再检查是否能自动启动。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        需要注意的是，在配置SEpolicy相关文件时，每个<span style="color:#ff0000">文件末尾必须另有一行空白行</span>，否则会在编译时遇到无法预知的错误。具体原因我也不太清楚。</span></p> 
<h2 id="4.1%20%E6%B7%BB%E5%8A%A0%E6%96%B0feature%E7%9B%AE%E5%BD%95" style="margin-left:0"><span style="color:#000000"><a name="h.zh3i5766290b"></a>4.1 添加新feature目录</span></h2> 
<p style="margin-left:0"><span style="color:#000000">        文件vendor/vendorabcd/security/sepolicy_vendor/features/sepolicy_features_vendor.mk 中定义了vendorabcd的vendor相关sepolicy。我们按格式增加一个feature。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        添加如下一行：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">BOARD_SEPOLICY_DIRS += $(LOCAL_PATH)/sensorscalibrate/vendor</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        并在此目录下创建<span style="background-color:#f3f3f3"><span style="color:#434343">/sensorscalibrate/vendor</span></span>目录。进入这个新创建的目录。</span></p> 
<h2 id="4.2%20%E5%88%9B%E5%BB%BA%20hal_sensorscalibrate_default.te" style="margin-left:0"><span style="color:#000000"><a name="h.ema4q96nhuau"></a>4.2 创建<strong><span style="background-color:#f3f3f3"><span style="color:#434343"> hal_sensorscalibrate_default.te</span></span></strong></span></h2> 
<p style="margin-left:0"><span style="color:#000000">        创建一个文件，名为hal_sensorscalibrate_default.te，内容如下：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">type hal_sensorscalibrate_default, domain;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">type hal_sensorscalibrate_default_exec, exec_type, vendor_file_type, file_type;</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">init_daemon_domain(hal_sensorscalibrate_default)</span></span></span></p> 
 <p style="margin-left:0"></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        其中的<span style="background-color:#f3f3f3"><span style="color:#434343">init_daemon_domain</span></span>是一段<a href="https://cs.android.com/android/platform/superproject/+/master:system/sepolicy/public/te_macros;drc=c69ad27186e0d25b6139db8d5e80ee975b3a847d;l=162" title="宏">宏</a>，可以自动帮助我们完成与init相关的policy声明。这段宏的括号中的输入x应为一个domain（即本文件，在第一行定义），并有名为x_exec的对象被定义为一个executable（在第二行定义）。第一行和第二行满足了init_daemon_domain对输入的需求。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        我们现在还没有把 <span style="background-color:#f3f3f3"><span style="color:#434343">hal_sensorscalibrate_default_exec </span></span>与实际文件相绑定。于是另创建一个文件，名为file_contexts。</span></p> 
<h2 id="4.3%20%E5%88%9B%E5%BB%BA%20file_contexts" style="margin-left:0"><span style="color:#000000"><a name="h.jflibx6e98ya"></a>4.3 创建<strong><span style="background-color:#f3f3f3"><span style="color:#434343"> file_contexts</span></span></strong></span></h2> 
<p style="margin-left:0"><span style="color:#000000">        file_contexts负责声明实际文件为某个SEpolicy中的对象。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        我们将手机中service可执行文件的路径，声明为<span style="background-color:#f3f3f3"><span style="color:#434343">hal_sensorscalibrate_default_exec</span></span>。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        创建一个文件，名为file_contexts，内容如下：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">/(vendor|system/vendor)/bin/hw/vendorabcd.hardware.sensorscalibrate-service                   u:object_r:hal_sensorscalibrate_default_exec:s0</span></span></span></p> 
 <p style="margin-left:0"></p> 
</blockquote> 
<h2 id="4.1%20%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E6%97%B6%E7%9A%84%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95" style="margin-left:0"><span style="color:#000000"><a name="h.qwyul38tj0v7"></a>4.1 无法启动时的排查方法</span></h2> 
<p style="margin-left:0"><strong><span style="color:#000000">1. 确认service本身可正常运行</span></strong></p> 
<p style="margin-left:0"><span style="color:#000000">        我们首先尝试手动启动服务，以收集相关log。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        在adb shell内，切换到su用户。将SEpolicy调整到宽容模式，放行未声明的操作。</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">su root</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">setenforce 0</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">getenforce  </span></span><span style="background-color:#f3f3f3"><span style="color:#008000">#</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">检查是否打开宽容模式（输出</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">Permissive</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">为宽容模式）</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        启动服务： </span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">/vendor/bin/hw/vendorabcd.hardware.sensorscalibrate-service </span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        检查服务是否正常启动。不要关闭前一个终端窗口，另开一个窗口，在adb shell中执行</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">service list | grep sensorscalibrate</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        有如下输出，说明启动成功：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">159     vendorabcd.hardware.sensorscalibrate.ISensorsCalibrate/default: [vendorabcd.hardware.sensorscalibrate.ISensorsCalibrate]</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        如果方括号[ ]内没有内容，可能是未成功打开宽容模式。</span></p> 
<p style="margin-left:0"><strong><span style="color:#000000">2. 检查启动阶段的log</span></strong></p> 
<p style="margin-left:0"><span style="color:#000000">        dmesg是linux提供的内核log工具，与系统启动相关的log在其中有记录。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        打开终端，进入sudo模式，收集本次启动的dmesg：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">adb root </span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">adb shell dmesg &gt; dmesg.txt</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        如果看到类似于以下的dmesg内容，说明系统启动时，由于SEpolicy阻拦，service启动失败：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">[   10.220035] init: init 27: [10038][0]Could not start service 'vendor.sensorscalibrate-hal' as part of class 'hal': File /vendor/bin/hw/vendorabcd.hardware.sensorscalibrate-service(labeled "u:object_r:vendor_file:s0") has </span></span><span style="background-color:#f3f3f3"><span style="color:#ff0000">incorrect label or no domain transition from u:r:init:s0 to another SELinux domain defined</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">. Have you configured your service correctly? </span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><strong><span style="color:#000000">3 查看系统运行阶段的log</span></strong></p> 
<p style="margin-left:0"><span style="color:#000000">        在宽容模式下，系统不会阻止未声明的操作，但仍记录这些操作的拒绝记录。我们可以通过拒绝记录来添加对应的声明。</span></p> 
<p style="margin-left:0"><span style="color:#000000">        在adb shell中执行</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">logcat | grep sensorscalibrate</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        若看到有如下log，记录了被拒绝的的操作：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">11-10 16:29:41.311   633   633 E SELinux : avc:  denied  { find } for pid=3223 uid=2000 name=vendorabcd.hardware.sensorscalibrate.ISensorsCalibrate/default scontext=u:r:shell:s0 tcontext=u:object_r:default_android_service:s0 tclass=service_manager permissive=1</span></span></span></p> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#008000">#</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">这个</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">log</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">的意思是我试图从</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">shell</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">启动</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">service</span></span><span style="background-color:#f3f3f3"><span style="color:#008000">但是失败了</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        log的格式解释如下：</span></p> 
<blockquote> 
 <p style="margin-left:0"><span style="color:#000000"><span style="background-color:#f3f3f3"><span style="color:#434343">avc: denied  { </span></span><span style="background-color:#f3f3f3"><span style="color:#434343">操作权限</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">  }  for pid=7201  comm=“</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">进程名</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">”  scontext=u:r:</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">源类型</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">:s0  tcontext=u:r:</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">目标类型</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">:s0  tclass=</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">访问类别</span></span><span style="background-color:#f3f3f3"><span style="color:#434343">  permissive=0</span></span></span></p> 
</blockquote> 
<p style="margin-left:0"><span style="color:#000000">        修改步骤：</span></p> 
<p style="margin-left:0"><span style="color:#000000">        找相应的“源类型.te ”文件</span></p> 
<p style="margin-left:0"><span style="color:#000000">        按如下格式在该文件中添加： </span></p> 
<p style="margin-left:0"><span style="color:#000000">        allow  源类型 目标类型:访问类别 {权限}；</span></p> 
<p style="margin-left:0"><span style="color:#000000">        allow vendorabcd_app hal_sensorscalibrate_default:binder {call};</span>​​​​​​​</p> 
<p style="margin-left:0"></p> 
<h1 id="5.%20java%E5%B1%82%E8%B0%83%E7%94%A8service%EF%BC%88%E5%90%ABsepolicy%E9%85%8D%E7%BD%AE%EF%BC%89" style="margin-left:0"><span style="color:#000000"><a name="h.vt5gndha5thx"></a>5. java层调用service（含sepolicy配置）</span></h1> 
<p style="margin-left:0">        后面写不动了，先到这里吧。</p> 
<p style="margin-left:0">        在msi镜像中，也要定义同样的aidl接口，这样才能进行aidl通信。文件内容使用和vendor中完全相同即可。</p> 
<p style="margin-left:0">推荐阅读：</p> 
<p><a href="https://blog.xzr.moe/archives/111/" title="sepolicy进阶小记 - LibXZR 的小本本">sepolicy进阶小记 - LibXZR 的小本本</a> 解释了许多关键的sepolicy宏，很有帮助</p> 
<p style="margin-left:0"><a href="https://www.codeinsideout.com/blog/android/hal/aidl/#define-selinux-policy-for-hal-service" title="AIDL for HALs - Code Inside Out">AIDL for HALs - Code Inside Out</a> 一个AIDL for HAL全流程的文档，比较细</p> 
<h1 style="margin-left:0"><span style="color:#000000"><a name="h.eytp92c5ehfw"></a></span></h1>
                </div>

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>