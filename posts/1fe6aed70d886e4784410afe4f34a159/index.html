<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Kotlin:深入理解StateFlow与SharedFlow，StateFlow和LiveData使用差异区分，SharedFlow实现源码解析。 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kotlin:深入理解StateFlow与SharedFlow，StateFlow和LiveData使用差异区分，SharedFlow实现源码解析。</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <p>本文接上一篇博文：<a href="https://blog.csdn.net/weixin_44235109/article/details/121322134?spm=1001.2014.3001.5502">Kotlin：Flow 全面详细指南，附带源码解析。</a><br> </p>
<div class="toc">
 <h3>文章目录</h3>
 <ul><li>
<ul>
<li><a href="#StateFlowSharedFlow_3">StateFlow、SharedFlow</a></li>
<li><a href="#StateFlow_16">StateFlow使用</a></li>
<li>
<ul>
<li><a href="#StateFlow_18">StateFlow简介</a></li>
<li><a href="#StateFlow_29">StateFlow的用法</a></li>
<li><a href="#LiveDataStateFlow_76">LiveData与StateFlow差异对比</a></li>
<li><a href="#StateFlow_96">StateFlow特别说明</a></li>
<li><a href="#AndroidStateFlow_184">Android中使用StateFlow实践</a></li>
</ul>
   </li>
<li><a href="#SharedFlow_211">SharedFlow使用</a></li>
<li>
<ul>
<li><a href="#SharedFlow_213">SharedFlow简介</a></li>
<li><a href="#SharedFlow_223">SharedFlow的使用</a></li>
<li><a href="#SharedFlow_504">SharedFlow使用实战?‍♀️</a></li>
</ul>
   </li>
<li><a href="#SharedFlowStateFlow_572">SharedFlow、StateFlow的使用区别，换句话说，事件和状态的区别？</a></li>
<li><a href="#StateFlowSharedFlow_581">StateFlow、SharedFlow源码解析</a></li>
<li>
<ul>
<li><a href="#_587">认识几个变量</a></li>
<li><a href="#buffer_624">官方`buffer`缓存池，逻辑结构</a></li>
<li><a href="#_653">熟悉一下涉及到的几个其他类</a></li>
<li><a href="#_797">主流程实现分析</a></li>
<li><a href="#_970">总结?</a></li>
</ul>
   </li>
<li><a href="#_976">下一篇预告：深入理解协程的挂起和恢复?</a></li>
</ul>
 </li></ul>
</div>
<p></p> 
<h2>
<a id="StateFlowSharedFlow_3"></a>StateFlow、SharedFlow</h2> 
<p>先看一下Google对于StateFlow和SharedFlow的介绍?‍♀️:</p> 
<blockquote> 
 <p><code>StateFlow</code> and <code>SharedFlow</code> are Flow APIs that enable flows to optimally emit state updates and emit values to multiple consumers.</p> 
 <p>StateFlow 和 SharedFlow 是 Flow API，它们使流能够以最佳方式发出状态更新并向多个消费者发出值</p> 
</blockquote> 
<p>StateFlow和SharedFlow是一种很特殊的Flow，它们是<strong>热流</strong>。介绍Flow的时候有说过，它是冷流，再不调用终端操作符的情况下，Flow构建块的代码是不会执行的，每一个消费者调用一次Flow，则构建块的代码会从头到尾执行一次。而<strong>热流可以不依赖消费者而存活，可以在流之外生成数据，然后传递给流</strong>。</p> 
<p>真所谓，由简入繁，繁尽至简?。</p> 
<p>我们先从StateFlow和SharedFlow的使用讲起（会稍带涉及到StateFlow和LiveData的区别），而后对其核心实现进行源码分析。</p> 
<h2>
<a id="StateFlow_16"></a>StateFlow使用</h2> 
<h3>
<a id="StateFlow_18"></a>StateFlow简介</h3> 
<p>StateFlow 是一个状态持有者可观察流，它向其收集器发出当前和新状态更新。 当前状态值也可以通过其 value 属性读取。 要更新状态并将其发送到流。</p> 
<p>StateFlow提供<code>可读可写</code>和<code>仅可读</code>两个版本，这一点和<code>LiveData</code>相似，如下表格?‍♀️。</p> 
<table>
<thead><tr>
<th align="center"></th>
<th align="center">仅可读</th>
<th align="center">可读可写</th>
</tr></thead>
<tbody>
<tr>
<td align="center">LiveData</td>
<td align="center">LiveData</td>
<td align="center">MutableLiveData</td>
</tr>
<tr>
<td align="center">StateFlow</td>
<td align="center">StateFlow</td>
<td align="center">SharedFlow</td>
</tr>
</tbody>
</table>
<h3>
<a id="StateFlow_29"></a>StateFlow的用法</h3> 
<p>StateFlow 非常适合需要维护可观察的可变状态的类。</p> 
<p>简单使用举例?</p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">val</span> value <span class="token operator">=</span> <span class="token function">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> stateFlow <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//+1</span>
    stateFlow<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// +1</span>
    runBlocking <span class="token punctuation">{<!-- --></span>
        GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            stateFlow<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver value <span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
            stateFlow<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver2 value <span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> sendValue <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"sendValue<span class="token interpolation variable">$sendValue</span>"</span><span class="token punctuation">)</span>
            stateFlow<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>sendValue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//输出</span>
<span class="token number">21</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">789</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> receiver value <span class="token number">2</span>
<span class="token number">21</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">781</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> sendValue3
<span class="token number">21</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">781</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> receiver value <span class="token number">3</span>
<span class="token number">21</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">784</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> sendValue4
<span class="token number">21</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">784</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> receiver value <span class="token number">4</span>
<span class="token number">21</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">784</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> receiver2 value <span class="token number">4</span>
<span class="token number">21</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">786</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> sendValue5
<span class="token number">21</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">786</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> receiver value <span class="token number">5</span>
<span class="token number">21</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">786</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver2 value <span class="token number">5</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
</code></pre> 
<p>下面来解释一下?‍♀️：</p> 
<ul>
<li>我们创建了AtomicInteger初始值为0，我们调用incrementAndGet获取值，然后传入MutableStateFlow构造方法，构建StateFlow。之后设置StateFlow的属性<code>value = incrementAndGet</code>。注意：上面说的一系列操作都是没有消费者订阅的情况下进行的，之后启动第一个协程进行collect，打印出来的第一个值是2。说明：在没有订阅者的情况下，流依旧进行了执行。</li>
<li>再看代码最下面写了死循环，每隔1秒钟emit一个值给到StateFlow，所以第一个协程手机是没有问题的，也是每隔一秒钟打印一次。看第二个协程，实在延迟两秒中之后，才进行收集，我们看到第二个收集器，是从4开始打印的，且和第一个同步。说明：StateFlow只保留一个值且是最新值；可以允许有多个订阅者，会将此时最新的值，发送给此时订阅的所有存活的订阅者。</li>
</ul> 
<h3>
<a id="LiveDataStateFlow_76"></a>LiveData与StateFlow差异对比</h3> 
<p>liveData可参考：<a href="https://blog.csdn.net/weixin_44235109/article/details/120116205?spm=1001.2014.3001.5502">Jetpack：LiveData使用指南，实现原理详细解析！</a></p> 
<p>可以发现基本和LiveData基本一样?‍♀️，但是还是有不同的，下面<strong>总结一下StateFlow和LiveData的差异性</strong>。</p> 
<p><strong>相同点</strong>：?</p> 
<ol>
<li>提供<code>可读可写</code>和<code>仅可读</code>两个版本</li>
<li>值是唯一的</li>
<li>允许被多个观察者观察</li>
<li>永远会把最新的值给到观察者，即使没有观察者，也会更新自己的值</li>
<li><strong>都会产生粘性事件问题</strong></li>
<li><strong>都可能产生丢失值的问题</strong></li>
</ol> 
<p><strong>不同点</strong>：?</p> 
<ol>
<li>StateFlow必须在构建的时候传入初始值，LiveData不需要</li>
<li>StateFlow默认是防抖的，LiveData默认不防抖</li>
<li>对于Android来说StateFlow默认没有和生命周期绑定，直接使用会有问题，请继续向下看?‍♀️</li>
</ol> 
<h3>
<a id="StateFlow_96"></a>StateFlow特别说明</h3> 
<p><strong>下面就上方的几点特别的做一下说明</strong>：?</p> 
<p><strong>StateFlow会产生粘性事件</strong>：这个其实在上面的例子就可以说明了，StateFlow是必有值的，只要有订阅者订阅，这个值立马就会发送过去。具体可以理解为，在ViewModel中放了一个StateFlow之后在Activity中对值进行了调用弹出一个SnackBar，在屏幕旋转之后会再次弹出SnackBar。</p> 
<p><strong>StateFlow丢失值问题</strong>：当上游发射的速度，大于订阅者处理的速度的时候，中间值就会丢失了，下面具体看一个例子?：</p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">val</span> stateFlow <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    runBlocking <span class="token punctuation">{<!-- --></span>
        stateFlow<span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//模拟处理耗时</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver:<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">launchIn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> v <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"send:<span class="token interpolation variable">$v</span>"</span><span class="token punctuation">)</span>
            stateFlow<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//结果</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">004</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">031</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">990</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver<span class="token operator">:</span><span class="token number">0</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">038</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">054</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">057</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">5</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">996</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">070</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">6</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">32</span><span class="token operator">:</span><span class="token number">073</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">7</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">076</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">8</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">004</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver<span class="token operator">:</span><span class="token number">5</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
</code></pre> 
<p>上方模拟处理耗时是3秒，发送则是每隔一秒钟发一次。处理耗时是发送的三倍，那么中间的值就丢失了。</p> 
<p>至于之前讲Flow时说到的三种背压处理策略，这里只能使用collectLatest，发送新值时取消之前的操作，可以参考之前Flow里面的详细介绍。</p> 
<p><strong>StateFlow默认是防抖的</strong></p> 
<p>这一点可以看一下源码：?‍♀️</p> 
<pre><code class="prism language-kotlin">	<span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>调用了setValue
    setValue 调用了 updateState
    看一下 updateState
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">updateState</span><span class="token punctuation">(</span>expectedState<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> newState<span class="token operator">:</span> Any<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> curSequence <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">var</span> curSlots<span class="token operator">:</span> Array<span class="token operator">&lt;</span>StateFlowSlot<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>slots <span class="token comment">// benign race, we will not use it</span>
        <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> oldState <span class="token operator">=</span> _state<span class="token punctuation">.</span>value
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expectedState <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> oldState <span class="token operator">!=</span> expectedState<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token comment">// CAS support</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldState <span class="token operator">==</span> newState<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment">// Don't do anything if value is not changing, but CAS -&gt; true</span>
            _state<span class="token punctuation">.</span>value <span class="token operator">=</span> newState
            curSequence <span class="token operator">=</span> sequence
            <span class="token keyword">if</span> <span class="token punctuation">(</span>curSequence <span class="token operator">and</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// even sequence means quiescent state flow (no ongoing update)</span>
                curSequence<span class="token operator">++</span> <span class="token comment">// make it odd</span>
                sequence <span class="token operator">=</span> curSequence
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// update is already in process, notify it, and return</span>
                sequence <span class="token operator">=</span> curSequence <span class="token operator">+</span> <span class="token number">2</span> <span class="token comment">// change sequence to notify, keep it odd</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment">// updated</span>
            <span class="token punctuation">}</span>
            curSlots <span class="token operator">=</span> slots <span class="token comment">// read current reference to collectors under lock</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>关注一下这一行代码<code>if (oldState == newState) return true</code>，更新数据时，会判断当前值与新值是否相同，如果相同则不更新数据。</p> 
<p><strong>关于<code>可读可写</code>和<code>仅可读</code>的使用官方给出一下的例子，可以参考</strong>：?‍♀️</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> CounterModel <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> _counter <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// private mutable state flow</span>
    <span class="token keyword">val</span> counter <span class="token operator">=</span> _counter<span class="token punctuation">.</span><span class="token function">asStateFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// publicly exposed as read-only state flow</span>

    <span class="token keyword">fun</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _counter<span class="token punctuation">.</span>value<span class="token operator">++</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>另外注意一点</strong>：StateFlow 是一个热流。所以只要流被收集或从垃圾收集根存在对它的任何其他引用，它就会保留在内存中。</p> 
<h3>
<a id="AndroidStateFlow_184"></a>Android中使用StateFlow实践</h3> 
<p>我们知道直接在UI中对收集流时不安全的，所以需要判断判断UI的生命周期，来决定是否开启或者取消流的收集，对应于Flow就是是否启动或者取消收集的协程。我们知道LiveData自身有一个<code>LifecycleBoundObserver</code>需要传入当前的LifecycleOwner用于绑定声明周期，在onStop之后就会停止收集，那么StateFlow有没有呢？没有！?</p> 
<p>但是Google官方在有一个扩展函数，对生命周期进行了管理，方便使用。就是<code>repeatOnLifecycle</code>，它会在传入的生命周期开始启动一个协程，然后在与之对应的另一个状态取消携程，它是一个挂起函数，在onDestroy之后才会恢复下方的执行，举个例子如下所示?</p> 
<pre><code class="prism language-kotlin">	<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
        <span class="token comment">// 使用lifecycleScope启动协程</span>
        lifecycleScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 每次生命周期处于 STARTED 状态（或更高状态）时，repeatOnLifecycle 在新的协程中启动块，并在它停止时取消它。</span>
            lifecycle<span class="token punctuation">.</span><span class="token function">repeatOnLifecycle</span><span class="token punctuation">(</span>Lifecycle<span class="token punctuation">.</span>State<span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// </span>
                ViewModel<span class="token punctuation">.</span>uiState<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> uiState <span class="token operator">-&gt;</span>
                    <span class="token comment">// todo</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果这里被执行，则代表生命周期已经走到了onDestroy，因为repeatOnLifecycle是挂起函数，在生命周期为onDestroy的时候进行了恢复。</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>注意</strong>：repeatOnLifecycle API 仅在 androidx.lifecycle:lifecycle-runtime-ktx:2.4.0-alpha01 库及更高版本中可用。后续会有文章会对<code>repeatOnLifecycle</code>做源码分析，敬请期待！</p> 
<h2>
<a id="SharedFlow_211"></a>SharedFlow使用</h2> 
<h3>
<a id="SharedFlow_213"></a>SharedFlow简介</h3> 
<p>SharedFlow也是一个热流。它是StateFlow 的高度可配置的泛化，提供了更多的能力。换句话说，StateFlow是一个特殊的SharedFlow。</p> 
<p>SharedFlow同样有两个版本，<code>SharedFlow</code>和<code>MutableSharedFlow</code>。</p> 
<p>那为什么说StateFlow是一个特殊的SharedFlow呢?？我们来看一下继承关系就知道了</p> 
<p><code>StateFlow 继承自 SharedFlow MutableStateFlow 继承自 MutableSharedFlow</code></p> 
<h3>
<a id="SharedFlow_223"></a>SharedFlow的使用</h3> 
<p>在这之前，我们先看一下StateFlow与SharedFlow有什么不同</p> 
<ul>
<li>SharedFlow没有默认值</li>
<li>SharedFlow可以保存旧的数据，根据配置可以将旧的数据回播给新的订阅者</li>
<li>SharedFlow使用<code>emit/tryEmit</code>发射数据，StateFlow内部其实都是调用的<code>setValue</code>。</li>
<li>SharedFlow会挂起直到所有的订阅者处理完成。</li>
</ul> 
<p>看一下MutableSharedFlow的构建函数</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">MutableSharedFlow</span><span class="token punctuation">(</span>
    replay<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    extraBufferCapacity<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    onBufferOverflow<span class="token operator">:</span> BufferOverflow <span class="token operator">=</span> BufferOverflow<span class="token punctuation">.</span>SUSPEND
<span class="token punctuation">)</span>
</code></pre> 
<p>可以看得出，MutableSharedFlow不需要传入默认值。</p> 
<p>解析一下构建MutableSharedFlow的三个参数的含义</p> 
<ul>
<li>replay：重播给新订阅者的值的数量（不能为负，默认为零）</li>
<li>extraBufferCapacity：除重播外缓冲的值的数量。 当有剩余缓冲区空间时，emit 不会挂起（可选，不能为负，默认为零）。</li>
<li>onBufferOverflow：配置缓冲区溢出的操作（可选，默认BufferOverflow.SUSPEND，缓存溢出时挂起；另外还有DROP_OLDEST与DROP_LATEST，分别是溢出时删除缓冲区中最旧的值，将新值添加到缓冲区，不要挂起。与在缓冲区溢出时删除当前添加到缓冲区的最新值（以便缓冲区内容保持不变），不要挂起。）</li>
</ul> 
<p>下面看几个使用的例子?‍♀️</p> 
<ul>
<li> <p><strong>默认情况下，SharedFlow没有粘性事件</strong>。如下所示：?‍♀️</p> <pre><code>    var v = 0
    val sharedFlow = MutableSharedFlow&lt;Int&gt;()
    runBlocking {
        sharedFlow.emit(++v)
        val job = sharedFlow.onEach {
            log("receiver$it")
        }.launchIn(this)
        delay(5000)
        job.cancel()
        log("end")
    }
    //输出
    20:38:19:818 [main] end
</code></pre> <p>因为默认情况下，replay的值为0，也就是说在订阅的时候，将会有0个值回播给订阅者，所以就没有粘性事件了！</p> </li>
<li> <p><strong>再看一下正常使用的情况</strong></p> <pre><code class="prism language-kotlin">    <span class="token keyword">val</span> sharedFlow <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> value <span class="token operator">=</span> <span class="token function">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    runBlocking <span class="token punctuation">{<!-- --></span>
        GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
            sharedFlow<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver value <span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
            sharedFlow<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver2 value <span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
            sharedFlow<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//结果</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">565</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver value <span class="token number">1</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">552</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver value <span class="token number">2</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">560</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver value <span class="token number">3</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">560</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> receiver2 value <span class="token number">3</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">570</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> receiver value <span class="token number">4</span>
<span class="token number">20</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">570</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver2 value <span class="token number">4</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
</code></pre> <p>默认的使用除了粘性事件之外，其他的和StateFlow就没有什么区别了。所以如果为了解决粘性事件的问题，可以使用SharedFlow。但是注意一点：<strong>SharedFlow是不防抖的</strong>。</p> </li>
<li> <p><strong>SharedFlow默认是要等到订阅者全部接收到并且处理完成之后，才会进行下一次发送，否则就是挂起</strong>。</p> <pre><code class="prism language-kotlin"><span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">val</span> sharedFlow <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    runBlocking <span class="token punctuation">{<!-- --></span>
        sharedFlow<span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver1:<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">launchIn</span><span class="token punctuation">(</span>GlobalScope<span class="token punctuation">)</span>
        sharedFlow<span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver2:<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">launchIn</span><span class="token punctuation">(</span>GlobalScope<span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> v <span class="token operator">=</span> <span class="token operator">++</span>value
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"send:<span class="token interpolation variable">$v</span>"</span><span class="token punctuation">)</span>
            sharedFlow<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//输出</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">787</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">822</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">822</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">833</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">823</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver1<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">829</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">834</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">51</span><span class="token operator">:</span><span class="token number">825</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver1<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">837</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">843</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">832</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver1<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">22</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">838</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">5</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
</code></pre> <p>可以看得出，我们仅仅设置send的延迟为1秒钟，但是因为第二个订阅者模拟处理时间为3秒钟，所以emit会等最后一个处理完成才会进行下一次的发射，可以看到从<code>send：2</code>以后，每次发射都间隔三秒钟了，保证所有的订阅者全部接收到数据。<strong>如果是StateFlow的话，是不管订阅者是否处理完成的，依旧会保持值的替换</strong>。</p> </li>
<li> <p><strong>其中一个订阅者出现异常怎么办呢</strong>？</p> <p>这个就不放代码了，异常的传播机制和协程的异常传播机制还是一样的。如果订阅者和发送的在同一个作用域则异常传播机制同协程作用域。如果和发送者分别在不同的作用域则订阅者出现异常，影响不到别的订阅者和发送的协程。</p> </li>
<li> <p><strong>SharedFlow同一个作用域下丢失值的问题，和启动协程有关</strong>，这里简单介绍一下什么情况下会出现值丢失的情况，<strong>下一篇会详细分析协程的恢复与挂起实现原理，会讲到具体的原因，可以关注博主</strong>。</p> <pre><code class="prism language-kotlin">    <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">val</span> sharedFlow <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    runBlocking <span class="token punctuation">{<!-- --></span>
        sharedFlow<span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver1:<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">launchIn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> v <span class="token operator">=</span> <span class="token operator">++</span>value
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"send:<span class="token interpolation variable">$v</span>"</span><span class="token punctuation">)</span>
            sharedFlow<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//结果</span>
<span class="token number">09</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">434</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">09</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">471</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">09</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">471</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver1<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">09</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">477</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">09</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">477</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver1<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">09</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">493</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">09</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">493</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver1<span class="token operator">:</span><span class="token number">4</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
</code></pre> <p>显而易见，第一个值没有被接受到，这是为什么呢？我查看了一下源码，按照顺序执行下来的话，<strong>在相同的作用域下启动协程，如果下面不挂起的话，上面的协程是不会启动的</strong>，所以第一个值就没有被发送了（<strong>SharedFlow在无订阅者的时候会丢失值</strong>）；如果launchIn的作用域不是当前的作用域的话，也就是可以单独设置一个GlobalScope的话，此时就是没有问题的，所以上面的情况需要注意下一下。</p> </li>
<li> <p><strong>如果需要回播就值给新的订阅者，可以设置replay</strong></p> <pre><code class="prism language-kotlin">    <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">val</span> sharedFlow <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span>replay <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span>
    runBlocking <span class="token punctuation">{<!-- --></span>
        launch <span class="token punctuation">{<!-- --></span>
            sharedFlow<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver1:<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        launch <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
            sharedFlow<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver2:<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        launch <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
            sharedFlow<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver3:<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> v <span class="token operator">=</span> <span class="token operator">++</span>value
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"send:<span class="token interpolation variable">$v</span>"</span><span class="token punctuation">)</span>
            sharedFlow<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//结果</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">977</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">002</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver1<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">009</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">009</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver1<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">019</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">019</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">019</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">019</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver1<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">019</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">024</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">024</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver1<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">024</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">017</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver3<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">017</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver3<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">017</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver3<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">017</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> receiver3<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">11</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">033</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send<span class="token operator">:</span><span class="token number">5</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
</code></pre> <p>看得出，设置replay之后，如果当前发射缓存的值不够的话，会将当前已发射的值全部回播给新的订阅者。否则，就回播replay数量的值。</p> </li>
<li> <p><strong>extraBufferCapacity 可以在去除重播的数量之外进行额外的缓存</strong>。上面的例子我们看到，如果有一个订阅者执行的很慢的话，那么emit就会挂起等待最慢的订阅者执行完，但是如果配置了额外缓存且缓存有剩余空间的话，此时就不会挂起。看如下一个例子。</p> <pre><code class="prism language-kotlin">    <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">val</span> sharedFlow <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span>replay <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> extraBufferCapacity <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
    runBlocking <span class="token punctuation">{<!-- --></span>
        sharedFlow<span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//模拟处理耗时</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">launchIn</span><span class="token punctuation">(</span>GlobalScope<span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> v <span class="token operator">=</span> <span class="token operator">++</span>value
            sharedFlow<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"send<span class="token interpolation variable">$v</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//结果</span>
<span class="token number">12</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">347</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send1
<span class="token number">12</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">372</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send2
<span class="token number">12</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">374</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send3
<span class="token number">12</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">377</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send4
<span class="token number">12</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">350</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> receiver1
<span class="token number">12</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">350</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send5
<span class="token number">12</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">353</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> receiver2
<span class="token number">12</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">353</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send6
</code></pre> <p>可以看得到replay为0，模拟耗时是3秒，理论上来说send需要挂起等到订阅者处理完。但是因为额外的缓存配置了3，所以在订阅者没有处理完的时候，又连续发射了3个值，直到第四个才挂起等待订阅者处理完成。</p> <p>所以，总的缓存数量应该等于：replay+extraBufferCapacity；</p> </li>
<li> <p><strong>如果在replay和extraBufferCapacity都存在的情况下，新的订阅者取值的策略是什么呢</strong>？看一下如下的逻辑?‍♀️</p> <pre><code class="prism language-kotlin">    <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">val</span> sharedFlow <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span>replay <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> extraBufferCapacity <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
    runBlocking <span class="token punctuation">{<!-- --></span>
        sharedFlow<span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//模拟处理耗时</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">launchIn</span><span class="token punctuation">(</span>GlobalScope<span class="token punctuation">)</span>
        GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
            sharedFlow<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"receiver2:<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> v <span class="token operator">=</span> <span class="token operator">++</span>value
            sharedFlow<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"send<span class="token interpolation variable">$v</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//结果</span>
<span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">167</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send1
<span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">192</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send2
<span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">195</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send3
<span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">197</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send4
<span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">157</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">157</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">200</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send5
<span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">200</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver2<span class="token operator">:</span><span class="token number">5</span>
<span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">170</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> receiver1
<span class="token number">13</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">203</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> send6
<span class="token operator">..</span><span class="token punctuation">.</span>
</code></pre> <p>看receiver2，显而易见，会按照当前<strong>已发送的最近的replay个进行回播给新的订阅者</strong>。</p> </li>
</ul> 
<h3>
<a id="SharedFlow_504"></a>SharedFlow使用实战?‍♀️</h3> 
<ul>
<li> <p>可以封装为事件总线</p> <p>SharedFlow 可用于将应用程序内部发生的事件广播给可以来来去去的订阅者。 例如，以下类封装了一个事件总线，该总线以集合方式将事件分发给所有订阅者，挂起直到所有订阅者处理每个事件：</p> <pre><code class="prism language-kotlin"><span class="token keyword">class</span> EventBus <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> _events <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Event<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// private mutable shared flow</span>
    <span class="token keyword">val</span> events <span class="token operator">=</span> _events<span class="token punctuation">.</span><span class="token function">asSharedFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// publicly exposed as read-only shared flow</span>

    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">produceEvent</span><span class="token punctuation">(</span>event<span class="token operator">:</span> Event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _events<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token comment">// suspends until all subscribers receive it</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li>
<li> <p>Android中使用，比如定时刷新新闻：</p> <pre><code class="prism language-kotlin"><span class="token comment">// 当应用程序中所有需要集中刷新的类，都可以订阅tickFlow来获取同一时间的刷新</span>
<span class="token keyword">class</span> <span class="token function">TickHandler</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> externalScope<span class="token operator">:</span> CoroutineScope<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> tickIntervalMs<span class="token operator">:</span> Long <span class="token operator">=</span> <span class="token number">5000</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> _tickFlow <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span><span class="token punctuation">(</span>replay <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> tickFlow<span class="token operator">:</span> SharedFlow<span class="token operator">&lt;</span>Event<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token operator">=</span> _tickFlow

    <span class="token keyword">init</span> <span class="token punctuation">{<!-- --></span>
        externalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                _tickFlow<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span>
                <span class="token function">delay</span><span class="token punctuation">(</span>tickIntervalMs<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">NewsRepository</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> tickHandler<span class="token operator">:</span> TickHandler<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> externalScope<span class="token operator">:</span> CoroutineScope
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">init</span> <span class="token punctuation">{<!-- --></span>
        externalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 监听更新   collect会挂起  所以该协程一直不会取消</span>
            tickHandler<span class="token punctuation">.</span>tickFlow<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//todo 刷新 新闻</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> </li>
<li> <p>MutableSharedFlow 还有一个 subscriptionCount 属性，其中包含活动收集器的数量，可以用来协助处理很多事情，比如判断当前SharedFlow是否被激活</p> <pre><code class="prism language-kotlin">sharedFlow<span class="token punctuation">.</span>subscriptionCount
    <span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{<!-- --></span> count <span class="token operator">-&gt;</span> count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token comment">// map count into active/inactive flag</span>
    <span class="token punctuation">.</span><span class="token function">distinctUntilChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// only react to true&lt;-&gt;false changes</span>
    <span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span> isActive <span class="token operator">-&gt;</span> <span class="token comment">// configure an action</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isActive<span class="token punctuation">)</span> <span class="token function">onActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token function">onInactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">launchIn</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span> <span class="token comment">// launch it</span>
</code></pre> </li>
</ul> 
<p>另外补充一点：MutableSharedFlow 还包含一个 resetReplayCache 函数，可以用来重置回播的数量。可以自行了解一下，这里不再举例。</p> 
<h2>
<a id="SharedFlowStateFlow_572"></a>SharedFlow、StateFlow的使用区别，换句话说，事件和状态的区别？</h2> 
<ul>
<li>
<strong>事件</strong>：并不全是希望将最新一条之前的事件全部丢弃。绝大部分情况是希望<strong>每条事件都能被执行</strong>。</li>
<li>
<strong>状态</strong>：可以允许丢弃，展示最新的状态给UI展示即可，比如通知更新进度。</li>
</ul> 
<p><strong>StateFlow</strong>可以更新值，不会关心当前消费者是否消费完毕上一个值（丢失中间值）。适用于状态。</p> 
<p><strong>SharedFlow</strong>会挂起直到，最后一个订阅者处理完成事件，才会发射下一个值。适用于事件消费。</p> 
<h2>
<a id="StateFlowSharedFlow_581"></a>StateFlow、SharedFlow源码解析</h2> 
<p>又到了激动人心的时刻了，源码分析它来了！！！?‍♀️</p> 
<p>StateFlow实现和SharedFlow实现相对来说大差不大，相对来说SharedFlow会更复杂一点，篇幅有限，所以这里就只对SharedFlow做一波实现分析，StateFlow大家可以根据SharedFlow的源码自行跟一波?。</p> 
<h3>
<a id="_587"></a>认识几个变量</h3> 
<p>先看一下<code>MutableSharedFlow</code>函数吧，可以构建一个<code>SharedFlow</code>。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">MutableSharedFlow</span><span class="token punctuation">(</span>
    replay<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    extraBufferCapacity<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    onBufferOverflow<span class="token operator">:</span> BufferOverflow <span class="token operator">=</span> BufferOverflow<span class="token punctuation">.</span>SUSPEND
<span class="token punctuation">)</span><span class="token operator">:</span> MutableSharedFlow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">val</span> bufferCapacity0 <span class="token operator">=</span> replay <span class="token operator">+</span> extraBufferCapacity
    <span class="token keyword">val</span> bufferCapacity <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferCapacity0 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> Int<span class="token punctuation">.</span>MAX_VALUE <span class="token keyword">else</span> bufferCapacity0 
    <span class="token comment">//传进去 replay ， bufferCapacity = replay + extraBufferCapacity  ， onBufferOverflow</span>
    <span class="token keyword">return</span> <span class="token function">SharedFlowImpl</span><span class="token punctuation">(</span>replay<span class="token punctuation">,</span> bufferCapacity<span class="token punctuation">,</span> onBufferOverflow<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此时会有几个变量，传到<code>SharedFlowImpl</code>构建了SharedFlow，这几个变量通过上面的介绍应该比较熟悉了，下面简单列一下。</p> 
<ul>
<li>replay 回播给新订阅者数量</li>
<li>bufferCapacity 真正缓存容量 = replay + extraBufferCapacity</li>
<li>onBufferOverflow 当缓存池满了之后的处理策略</li>
</ul> 
<p>接下来，需要看<code>SharedFlowImpl</code>里面涉及到的变量，由于<code>SharedFlowImpl</code>里面涉及到的代码量过多，这里就不贴代码，只列一下变量的名字以及含义。</p> 
<ul>
<li>buffer: Array&lt;Any?&gt;? 缓存发射的值（有两种，一种是直接是发射的值，另外是值的包装类Emitters），按需分配，分配的大小总是二的幂</li>
<li>replayIndex :Int 对于新的收集器来说，最小的回播序号。默认值为0</li>
<li>minCollectorIndex :Int 对于已经激活的收集器来说，最小的索引。如果没有等于replayIndex</li>
<li>bufferSize :Int 缓存的值 的size</li>
<li>queueSize :Int 挂起排队发射 的size</li>
<li>head : Long = minOf(minCollectorIndex, replayIndex) 缓存队列的头</li>
<li>replaySize :Int 需要回播的size</li>
<li>totalSize : Int 缓存的值数量和排队挂起发射值数量总和</li>
<li>bufferEndIndex :Long 缓存值的最后一个的序号索引</li>
<li>queueEndIndex :Long 排队发射器队列最后一个的序号索引</li>
</ul> 
<h3>
<a id="buffer_624"></a>官方<code>buffer</code>缓存池，逻辑结构</h3> 
<pre><code class="prism language-kotlin">                  buffered values
             <span class="token operator">/</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
                          replayCache      queued emitters
                          <span class="token operator">/</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">/</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
         <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
         |   | <span class="token number">1</span> | <span class="token number">2</span> | <span class="token number">3</span> | <span class="token number">4</span> | <span class="token number">5</span> | <span class="token number">6</span> | E | E | E | E | E | E |   |   |   |
         <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
               ^           ^           ^                      ^
               |           |           |                      |
              head         |      head <span class="token operator">+</span> bufferSize     head <span class="token operator">+</span> totalSize
               |           |           |
     index of the slowest  |    index of the fastest
      possible collector   |     possible collector
               |           |
               |     replayIndex <span class="token operator">==</span> new collector's index
               <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">/</span>
          range of possible minCollectorIndex

          head <span class="token operator">==</span> <span class="token function">minOf</span><span class="token punctuation">(</span>minCollectorIndex<span class="token punctuation">,</span> replayIndex<span class="token punctuation">)</span> <span class="token comment">// by definition</span>
          totalSize <span class="token operator">==</span> bufferSize <span class="token operator">+</span> queueSize <span class="token comment">// by definition</span>

       INVARIANTS<span class="token operator">:</span>
          minCollectorIndex <span class="token operator">=</span> activeSlots<span class="token punctuation">.</span><span class="token function">minOf</span> <span class="token punctuation">{<!-- --></span> it<span class="token punctuation">.</span>index <span class="token punctuation">}</span> <span class="token operator">?:</span> <span class="token punctuation">(</span>head <span class="token operator">+</span> bufferSize<span class="token punctuation">)</span>
          replayIndex <span class="token operator">&lt;=</span> head <span class="token operator">+</span> bufferSize
</code></pre> 
<h3>
<a id="_653"></a>熟悉一下涉及到的几个其他类</h3> 
<p>在阅读主流程代码之前还要分析几个<code>类</code>以及<code>方法</code>，辅助主流程代码的进行。?‍♀️</p> 
<p>在上面的代码中，我们知道SharedFlow具体实现类是<code>SharedFlowImpl</code>，所以我们先分析<code>SharedFlowImpl</code>的父类和接口。</p> 
<p><strong>先看一下<code>MutableSharedFlow</code>接口</strong>?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">public</span> <span class="token keyword">interface</span> MutableSharedFlow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">:</span> SharedFlow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span> FlowCollector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">emit</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token function">tryEmit</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span><span class="token operator">:</span> Boolean
    <span class="token keyword">public</span> <span class="token keyword">val</span> subscriptionCount<span class="token operator">:</span> StateFlow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span>
    <span class="token annotation builtin">@ExperimentalCoroutinesApi</span>
    <span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token function">resetReplayCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> SharedFlow<span class="token operator">&lt;</span><span class="token keyword">out</span> T<span class="token operator">&gt;</span> <span class="token operator">:</span> Flow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">val</span> replayCache<span class="token operator">:</span> List<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> Flow<span class="token operator">&lt;</span><span class="token keyword">out</span> T<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation builtin">@InternalCoroutinesApi</span>
    <span class="token keyword">public</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">collect</span><span class="token punctuation">(</span>collector<span class="token operator">:</span> FlowCollector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>看得出提供了一些方法或者常量的实现接口方法。</p> 
<p><strong>在看一下<code>AbstractSharedFlow</code>抽象类</strong>?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> AbstractSharedFlow<span class="token operator">&lt;</span>S <span class="token operator">:</span> AbstractSharedFlowSlot<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token operator">:</span> <span class="token function">SynchronizedObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先看到需要一个<code>AbstractSharedFlowSlot</code>的泛型参数，<code>SharedFlowImpl</code>继承<code>AbstractSharedFlow</code>时传递的是，<code>SharedFlowSlot</code>所以我们先看一下，这是什么东西。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">class</span> SharedFlowSlot <span class="token operator">:</span> AbstractSharedFlowSlot<span class="token operator">&lt;</span>SharedFlowImpl<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation builtin">@JvmField</span>
    <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token comment">//当前收集器发射的索引</span>

    <span class="token annotation builtin">@JvmField</span>
    <span class="token keyword">var</span> cont<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// collector waiting for new value</span>
	<span class="token comment">//首次调用collect 会调用该函数 分配index</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">allocateLocked</span><span class="token punctuation">(</span>flow<span class="token operator">:</span> SharedFlowImpl<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token comment">// not free</span>
        <span class="token comment">//将当前索引初始化为，新收集器需要回播的最初的序号replayIndex和minCollectorIndex的最小值  具体在SharedFlowImpl实现</span>
        index <span class="token operator">=</span> flow<span class="token punctuation">.</span><span class="token function">updateNewCollectorIndexLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//清除卡槽  当前订阅者 协程被取消或者终止时会调用到</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">freeLocked</span><span class="token punctuation">(</span>flow<span class="token operator">:</span> SharedFlowImpl<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Continuation<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        assert <span class="token punctuation">{<!-- --></span> index <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">}</span>
        <span class="token keyword">val</span> oldIndex <span class="token operator">=</span> index
        index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span>
        cont <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// cleanup continuation reference</span>
        <span class="token comment">//当收集器消失或更改索引时调用，返回锁定后要恢复的延续列表(返回可以进行恢复的emit列表)  具体在SharedFlowImpl实现</span>
        <span class="token keyword">return</span> flow<span class="token punctuation">.</span><span class="token function">updateCollectorIndexLocked</span><span class="token punctuation">(</span>oldIndex<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主要是订阅者的卡槽，每个订阅者都有一个属于自己的<code>SharedFlowSlot</code>对象，记录当前的自身所需值的index以及<code>Continuation</code></p> 
<p><strong>那我们继续看AbstractSharedFlow类</strong>?</p> 
<pre><code class="prism language-kotlin">    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token keyword">var</span> slots<span class="token operator">:</span> Array<span class="token operator">&lt;</span>S<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 记录当前被分配的卡槽，按需分配，以2的幂次方增长</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>
    <span class="token keyword">protected</span> <span class="token keyword">var</span> nCollectors <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 订阅者的数量</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> nextIndex <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 下一个空闲卡槽的索引</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> _subscriptionCount<span class="token operator">:</span> MutableStateFlow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// init on first need</span>
	<span class="token comment">//订阅者的数量 其实时用StateFlow来进行管理的  </span>
    <span class="token keyword">val</span> subscriptionCount<span class="token operator">:</span> StateFlow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span>
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// allocate under lock in sync with nCollectors variable</span>
            _subscriptionCount <span class="token operator">?:</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span>nCollectors<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
                _subscriptionCount <span class="token operator">=</span> it
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
	<span class="token comment">//创建卡槽  在SharedFlowImpl中实现，具体返回了一个SharedFlowSlot</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">fun</span> <span class="token function">createSlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> S
	<span class="token comment">//创建卡槽数组  在SharedFlowImpl中实现，具体返回了一个空ArrayList</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">fun</span> <span class="token function">createSlotArray</span><span class="token punctuation">(</span>size<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>S<span class="token operator">?</span><span class="token operator">&gt;</span>

	<span class="token comment">//主要是分配了卡槽，相关状态进行了增减，代码比较简单，就是比较长，这里就不放了</span>
    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token keyword">fun</span> <span class="token function">allocateSlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> S <span class="token punctuation">{<!-- --></span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//释放卡槽，同样，代码不难，比较长篇幅考虑，这里不放出</span>
    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token keyword">fun</span> <span class="token function">freeSlot</span><span class="token punctuation">(</span>slot<span class="token operator">:</span> S<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//封装的工具方法，迭代卡槽执行block</span>
    <span class="token keyword">protected</span> <span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token function">forEachSlotLocked</span><span class="token punctuation">(</span>block<span class="token operator">:</span> <span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nCollectors <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
        slots<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{<!-- --></span> slot <span class="token operator">-&gt;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slot <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token function">block</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>看得出，AbstractSharedFlow主要是对slot进行了一波管理。</p> 
<p><strong>在看一个类Emitter，用于发射挂起，记录发射的continuation等相关信息。</strong></p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token function">Emitter</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@JvmField</span> <span class="token keyword">val</span> flow<span class="token operator">:</span> SharedFlowImpl<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token annotation builtin">@JvmField</span> <span class="token keyword">var</span> index<span class="token operator">:</span> Long<span class="token punctuation">,</span>
        <span class="token annotation builtin">@JvmField</span> <span class="token keyword">val</span> value<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span>
        <span class="token annotation builtin">@JvmField</span> <span class="token keyword">val</span> cont<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span> <span class="token operator">:</span> DisposableHandle <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//发射取消，一些操作</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> flow<span class="token punctuation">.</span><span class="token function">cancelEmitter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>记录了值的序号，值，continuation。另外它继承了DisposableHandle，所以可以直接加入当前协程的dispose的回调。可以在取消是触发dispose()。</p> 
<p><strong>下面再看个方法，用于对buffer值的添加和获取</strong>?</p> 
<pre><code class="prism language-kotlin">    <span class="token comment">// 将值放进buffer数组里面，若为null，则创建，会议2的倍数进行增长</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">enqueueLocked</span><span class="token punctuation">(</span>item<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> curSize <span class="token operator">=</span> totalSize
        <span class="token keyword">val</span> buffer <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token keyword">val</span> curBuffer <span class="token operator">=</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">null</span> <span class="token operator">-&gt;</span> <span class="token function">growBuffer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curSize <span class="token operator">&gt;=</span> curBuffer<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token function">growBuffer</span><span class="token punctuation">(</span>curBuffer<span class="token punctuation">,</span> curSize<span class="token punctuation">,</span>curBuffer<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">else</span> curBuffer
        <span class="token punctuation">}</span>
        buffer<span class="token punctuation">.</span><span class="token function">setBufferAt</span><span class="token punctuation">(</span>head <span class="token operator">+</span> curSize<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token comment">//获取值</span>
<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">getPeekedValueLockedAt</span><span class="token punctuation">(</span>index<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Any<span class="token operator">?</span> <span class="token operator">=</span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token keyword">val</span> item <span class="token operator">=</span> buffer<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">getBufferAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">is</span> Emitter <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span>value
            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> item
        <span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="_797"></a>主流程实现分析</h3> 
<p>上面的知识了解之后，下面进行主流程的分析。</p> 
<p><strong>我们先看一下发射<code>emit</code></strong></p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">emit</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryEmit</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// fast-path</span>
        <span class="token function">emitSuspend</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>好的看得出，会先进行<code>tryEmit</code>这个过程没有挂起，如果可以这时候发射的话，就return了，所以我们看一下<code>tryEmit</code></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">tryEmit</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> resumes<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Continuation<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token operator">=</span> EMPTY_RESUMES
        <span class="token keyword">val</span> emitted <span class="token operator">=</span> <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryEmitLocked</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//返回了 需要恢复的订阅者 主要便利了所有的卡槽，将需要恢复的订阅者continuation拉出来</span>
                resumes <span class="token operator">=</span> <span class="token function">findSlotsToResumeLocked</span><span class="token punctuation">(</span>resumes<span class="token punctuation">)</span>
                <span class="token boolean">true</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    	<span class="token comment">//恢复需要恢复的订阅者列表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>cont <span class="token keyword">in</span> resumes<span class="token punctuation">)</span> cont<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span>
        <span class="token keyword">return</span> emitted
    <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">tryEmitLocked</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Fast path without collectors -&gt; no buffering</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nCollectors <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">tryEmitNoCollectorsLocked</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// always returns true</span>
        <span class="token comment">// 看的出只有当前缓存容量有剩余空间的话或者DROP_OLDEST策略，才会继续后面的流程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferSize <span class="token operator">&gt;=</span> bufferCapacity <span class="token operator">&amp;&amp;</span> minCollectorIndex <span class="token operator">&lt;=</span> replayIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">when</span> <span class="token punctuation">(</span>onBufferOverflow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                BufferOverflow<span class="token punctuation">.</span>SUSPEND <span class="token operator">-&gt;</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token comment">// will suspend</span>
                BufferOverflow<span class="token punctuation">.</span>DROP_LATEST <span class="token operator">-&gt;</span> <span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment">// just drop incoming</span>
                BufferOverflow<span class="token punctuation">.</span>DROP_OLDEST <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token comment">// force enqueue &amp; drop oldest instead</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
       <span class="token comment">//缓存控件有剩余或者DROP_OLDEST策略，允许发射值，发送进入buffer队列</span>
        <span class="token function">enqueueLocked</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
       <span class="token comment">//其他状态调整，包括buffersize等相关状态</span>
        <span class="token operator">..</span><span class="token operator">..</span>
       <span class="token comment">//返回true，代码发生成功</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>可以发现在缓存区有空闲剩余的时候，允许不挂起直接发射值。</p> 
<p>这里注意一点?，<strong>比如设置了replay和extraBufferCapacity均为0时，即直接构造的SharedFlow，此时<code>bufferSize &gt;= bufferCapacity &amp;&amp; minCollectorIndex &lt;= replayIndex == true</code>所以使用tryEmit的话，永远发射不了值</strong>。</p> 
<p>如果缓存区不满足，比如上面的情况，此时就必须要挂起了，所以继续看<code>emitSuspend</code>函数。</p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">private</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">emitSuspend</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token operator">=</span> suspendCancellableCoroutine<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token label symbol">sc@</span><span class="token punctuation">{<!-- --></span> cont <span class="token operator">-&gt;</span>
        <span class="token keyword">var</span> resumes<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Continuation<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token operator">=</span> EMPTY_RESUMES
        <span class="token comment">//加了锁  所以是线程安全的</span>
        <span class="token keyword">val</span> emitter <span class="token operator">=</span> <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token label symbol">lock@</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 这一步重试的之前的tryEmit</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryEmitLocked</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cont<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span>
                resumes <span class="token operator">=</span> <span class="token function">findSlotsToResumeLocked</span><span class="token punctuation">(</span>resumes<span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token label symbol">@lock</span> <span class="token keyword">null</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 发现还不行 创建Emitter对象，记录相关信息</span>
            <span class="token function">Emitter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> head <span class="token operator">+</span> totalSize<span class="token punctuation">,</span> value<span class="token punctuation">,</span> cont<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">enqueueLocked</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
                queueSize<span class="token operator">++</span> <span class="token comment">// 发射器队列++</span>
                <span class="token comment">// 查找可以恢复的订阅者</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferCapacity <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> resumes <span class="token operator">=</span> <span class="token function">findSlotsToResumeLocked</span><span class="token punctuation">(</span>resumes<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将Emitter加入取消回调，在当前协程取消时会触发onDispose函数</span>
        emitter<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span> cont<span class="token punctuation">.</span><span class="token function">disposeOnCancellation</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token comment">// 恢复通知订阅者</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>cont <span class="token keyword">in</span> resumes<span class="token punctuation">)</span> cont<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>如果前面的东西都理解的话，其实也比较简单的吧。主要是将当前的值封装存到数组里面，然后恢复通知订阅者，自身挂起。等待订阅者调用恢复。</p> 
<p><strong>接下来看一下订阅者<code>collect</code>的实现</strong></p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">collect</span><span class="token punctuation">(</span>collector<span class="token operator">:</span> FlowCollector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//调用父类（AbstractSharedFlow）allocateSlot()  分配卡槽</span>
        <span class="token keyword">val</span> slot <span class="token operator">=</span> <span class="token function">allocateSlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>collector <span class="token keyword">is</span> SubscribedFlowCollector<span class="token punctuation">)</span> collector<span class="token punctuation">.</span><span class="token function">onSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> collectorJob <span class="token operator">=</span> <span class="token function">currentCoroutineContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>Job<span class="token punctuation">]</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> newValue<span class="token operator">:</span> Any<span class="token operator">?</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//查找值</span>
                    newValue <span class="token operator">=</span> <span class="token function">tryTakeValue</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span>
                    <span class="token comment">//如果查找到值 break当前循环</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> NO_VALUE<span class="token punctuation">)</span> <span class="token keyword">break</span>
                    <span class="token comment">//没有找到值可供发射，则挂起</span>
                    <span class="token function">awaitValue</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span> 
                <span class="token punctuation">}</span>
                collectorJob<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">ensureActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//当上一个循环退出时，代表找到了值，调用collector的emit进行真正的发射，此时就会调用到外部的collect程序体了。如果这一块不清楚，可以看博主之前对于flow篇的详解。</span>
                collector<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>newValue <span class="token keyword">as</span> T<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//卡槽释放</span>
            <span class="token function">freeSlot</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>看的出，其实就是一个循环的过程。如果缓存区一直有值，就一直会发射值出去。如果没有值则挂起等待恢复。所以有两个关键的方法<code>tryTakeValue</code>查找值以及<code>awaitValue</code>挂起。</p> 
<p>下面我们分析一下这两个方法的实现?。</p> 
<p><strong>tryTakeValue</strong></p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">tryTakeValue</span><span class="token punctuation">(</span>slot<span class="token operator">:</span> SharedFlowSlot<span class="token punctuation">)</span><span class="token operator">:</span> Any<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> resumes<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Continuation<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token operator">=</span> EMPTY_RESUMES
        <span class="token keyword">val</span> value <span class="token operator">=</span> <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//获取当前卡槽的索引index，如果index非法则返回-1，代表没有找到值</span>
            <span class="token keyword">val</span> index <span class="token operator">=</span> <span class="token function">tryPeekLocked</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                NO_VALUE
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//走这个分支，可以找到正常的index</span>
                <span class="token keyword">val</span> oldIndex <span class="token operator">=</span> slot<span class="token punctuation">.</span>index
                <span class="token comment">//根据索引，在buffer中获取值</span>
                <span class="token keyword">val</span> newValue <span class="token operator">=</span> <span class="token function">getPeekedValueLockedAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
                slot<span class="token punctuation">.</span>index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment">// 指向下一个值</span>
                <span class="token comment">//该方法里面各种逻辑太多，就不展开分析了。</span>
                <span class="token comment">//主要是获取了可以恢复的发射器，根据缓存的size和目前的值的数量，判断可以恢复恢复的发射器的数量。</span>
                <span class="token comment">//根据排队挂起的发射器，获取对应的数量，进行恢复。另外在该方法后面还调用了updateBufferLocked方法，进行buffer数组各种状态的重新设置，比如head等相关状态。</span>
                resumes <span class="token operator">=</span> <span class="token function">updateCollectorIndexLocked</span><span class="token punctuation">(</span>oldIndex<span class="token punctuation">)</span>
                newValue
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//恢复相应的发射器</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>resume <span class="token keyword">in</span> resumes<span class="token punctuation">)</span> resume<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span>
        <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
</code></pre> 
<p>主要是对获取卡槽，通过索引获取值，另外判断此时有多少发射器可以恢复，然后进行通知发射器的恢复。</p> 
<p><strong>awaitValue</strong></p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">private</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">awaitValue</span><span class="token punctuation">(</span>slot<span class="token operator">:</span> SharedFlowSlot<span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> suspendCancellableCoroutine <span class="token punctuation">{<!-- --></span> cont <span class="token operator">-&gt;</span>
        <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token label symbol">lock@</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> index <span class="token operator">=</span> <span class="token function">tryPeekLocked</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span> <span class="token comment">// 重新使用tryPeekLocked判断是否存在可用的值</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                slot<span class="token punctuation">.</span>cont <span class="token operator">=</span> cont <span class="token comment">// 没有值挂起</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                cont<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span> <span class="token comment">// 有值不需要挂起</span>
                <span class="token keyword">return</span><span class="token label symbol">@lock</span>
            <span class="token punctuation">}</span>
            slot<span class="token punctuation">.</span>cont <span class="token operator">=</span> cont <span class="token comment">// 挂起等待</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这个比较简单，判断可以挂起的话，直接将continuation赋值给卡槽。挂起了，等待发射器的恢复。</p> 
<h3>
<a id="_970"></a>总结?</h3> 
<p>以上就是SharedFlow基本的流程了，可能比较绕吧，各种状态的，博主也是花了一些时间才完全理清楚。各位再看的时候，可以结合源码进行分析，有些博主没有列举出来的方法，建议需要点进去看一看。</p> 
<p>另外，有不理解的地方随时欢迎，私信博主。如有错误也欢迎指正。?‍♀️</p> 
<h2>
<a id="_976"></a>下一篇预告：深入理解协程的挂起和恢复?</h2>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>