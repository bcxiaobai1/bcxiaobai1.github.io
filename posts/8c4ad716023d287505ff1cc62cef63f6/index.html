<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>图像分割之U-Net、U2-Net及其Pytorch代码构建 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">图像分割之U-Net、U2-Net及其Pytorch代码构建</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <h1>
<a id="UNetU2_NetPytorch_0"></a>图像分割之U-Net、U<sup>2</sup> -Net及其Pytorch代码构建</h1> 
<h2>
<a id="1_2"></a>1、图像分割</h2> 
<p>图像分割就是把图像分成若干个特定的、具有独特性质的区域并提出感兴趣目标的技术和过程。</p> 
<p>做法便是对图片中的每一个像素进行分类。</p> 
<p>在自动驾驶、自动抠图、医疗影像等领域有着比较广泛的应用。</p> 
<p>图像分割大致可分为以下三类：</p> 
<ul>
<li>普通分割：将不同分属不同物体的像素区域分开。比如前景和背景分割开，狗的区域和猫的区域与背景分割开。</li>
<li>语义分割：在普通分割的基础上，分类出每一块区域的语义（即这块区域是什么物体）。如把画面中的所有物体都指出他们各自的类别。</li>
<li>实例分割：在语义分割的基础上，给每一个物体编号。如这个是该画面中的狗A，那个是画面中的狗B。</li>
</ul> 
<table>
<thead><tr>
<th>普通分割</th>
<th><img src="https://images2.imgbox.com/a5/a8/njoWjdPV_o.png" alt="在这里插入图片描述"></th>
</tr></thead>
<tbody>
<tr>
<td>语义分割</td>
<td><img src="https://images2.imgbox.com/b8/5c/IyyvY2aj_o.png" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td>实例分割</td>
<td><img src="https://images2.imgbox.com/9e/70/bXg4yXhi_o.png" alt="在这里插入图片描述"></td>
</tr>
</tbody>
</table>
<p>可以看出，图像分割是由一张图片到另一张图片。因此，神经网络的输入是图片，输出也是同样的图片，Encoder-Decoder的结构是合适的。U-Net、U<sup>2</sup> -Net可作为语义分割使用，可以按照生成图像的方式，生成分割图。也可以按通道划分类，每一个通道就是一个类别，使用sigmoid激活。</p> 
<h2>
<a id="2UNet_25"></a>2、U-Net</h2> 
<p><img src="https://images2.imgbox.com/6d/94/ZX6hT4Do_o.png" alt="在这里插入图片描述"></p> 
<p>U-Net即使用Encoder-Decoder的结构，首先下采样，然后上采样，中间每一级由残差组成。</p> 
<p>则可构建网络的代码如下：</p> 
<p><img src="https://images2.imgbox.com/ed/90/PSaHNJWE_o.png" alt="在这里插入图片描述"></p> 
<p>首先是卷积层，可以看出，网络在每一级，均有两层卷积组成。因此构建卷积层如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">import</span> torch


<span class="token keyword">class</span> <span class="token class-name">ConvolutionLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        卷积层
        :param in_channels: 输入通道
        :param out_channels: 输出通道
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ConvolutionLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            <span class="token comment"># 卷积层</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># BN层</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 激活</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> 
<p>同时与图示不同的地方在于，使用了Padding，以免图片在卷积中的尺寸缩小。这样，横向的灰色箭头可以直接使用cat进行两个特征图的拼接。</p> 
<p>模型图中，红色箭头的max pool 2×2，使用的是池化窗口为2×2的最大值池化。这里的目的是进行下采样，因此可以定义一个下采样如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DownSample</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        最大池化层构成的下采样，池化窗口为2×2
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DownSample<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> 
<p>模型图中，绿色箭头的up-conv 2×2，使用的是反卷积。这里的目的是进行上采样，因此可以定义一个上采样如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">UpSample</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        反卷积，上采样，通道数将会减半，
        :param in_channels: 输入通道数
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UpSample<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> in_channels <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> 
<p>首先定义各个网络层：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">UNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>  <span class="token comment"># 三通道拓展至64通道</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 下采样至1/2</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>  <span class="token comment"># 64通道==&gt;128通道</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 下采样至1/4</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 128通道==&gt;256通道</span>
        self<span class="token punctuation">.</span>down3 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 下采样至1/8</span>
        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>  <span class="token comment"># 256通道==&gt;512通道</span>
        self<span class="token punctuation">.</span>down4 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 下采样至1/16</span>
        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment"># 512通道==&gt;1024通道</span>
        self<span class="token punctuation">.</span>up1 <span class="token operator">=</span> UpSample<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment"># 上采样至1/8</span>
        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>  <span class="token comment"># 1024通道==&gt;512通道</span>
        self<span class="token punctuation">.</span>up2 <span class="token operator">=</span> UpSample<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span>  <span class="token comment"># 上采样至1/4</span>
        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 512通道==&gt;256通道</span>
        self<span class="token punctuation">.</span>up3 <span class="token operator">=</span> UpSample<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>  <span class="token comment"># 上采样至1/2</span>
        self<span class="token punctuation">.</span>conv8 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>  <span class="token comment"># 256通道==&gt;128通道</span>
        self<span class="token punctuation">.</span>up4 <span class="token operator">=</span> UpSample<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span>  <span class="token comment"># 上采样至1/1</span>
        self<span class="token punctuation">.</span>conv9 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>  <span class="token comment"># 128通道==&gt;64通道</span>
        self<span class="token punctuation">.</span>predict <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>  <span class="token comment"># 输出层，由sigmoid函数激活</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image_tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">pass</span>
</code></pre> 
<p>对应于模型图如下：</p> 
<p><img src="https://images2.imgbox.com/81/47/NGnn2CZR_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">UNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">"""
        ......
        """</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""下采样"""</span>
        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/1 64</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/2 64</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/2 128</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/4 128</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/4 256</span>
        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>down3<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/8 256</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>d3<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/8 512</span>
        d4 <span class="token operator">=</span> self<span class="token punctuation">.</span>down4<span class="token punctuation">(</span>x4<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/16 512</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>d4<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/16 1024</span>
        <span class="token triple-quoted-string string">"""上采样"""</span>
        up1 <span class="token operator">=</span> self<span class="token punctuation">.</span>up1<span class="token punctuation">(</span>x5<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/8 512</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x4<span class="token punctuation">,</span> up1<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/8 512</span>
        up2 <span class="token operator">=</span> self<span class="token punctuation">.</span>up2<span class="token punctuation">(</span>x6  <span class="token comment"># ===&gt; 1/4 256</span>

        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x3<span class="token punctuation">,</span> up2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/4 256</span>
        up3 <span class="token operator">=</span> self<span class="token punctuation">.</span>up3<span class="token punctuation">(</span>x7<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/2 128</span>

        x8 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv8<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span> up3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/2 128</span>
        up4 <span class="token operator">=</span> self<span class="token punctuation">.</span>up4<span class="token punctuation">(</span>x8<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/1 64</span>

        x9 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv9<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> up4<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/1 64</span>
        mask <span class="token operator">=</span> self<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>x9<span class="token punctuation">)</span>  <span class="token comment"># ===&gt; 1/1 out_channels </span>
        <span class="token keyword">return</span> mask
</code></pre> 
<p>以一张512×512的3通道图片为例，其张量的形状为（1,3,512,512），经过conv1得到x1 （1, 64, 512, 512），下采样至（1, 64, 256, 256）；经过conv2得到x2 （1, 128, 256, 256），下采样至（1, 128, 128, 128）；经过conv3得到x3 （1, 256, 128, 128），下采样至（1, 256, 64, 64）；经过conv4得到x4 （1, 512, 64, 64），下采样至（1, 512, 32, 32）；经过conv5得到x5 （1, 1024, 32, 32）。下采样过程完成，开始上采样还原至原始图片大小。</p> 
<p>x5经过up1得到up1 （1, 512, 64, 64）,同x4 拼接（cat）在一起 组成（1, 1024, 64, 64）的张量，经过conv6得到x6（1, 512, 64, 64）;</p> 
<p>x6经过up2得到up2 （1, 256, 128, 128）,同x3 拼接在一起 组成（1, 512, 128, 128）的张量，经过conv7得到x7（1, 256, 128, 128）;</p> 
<p>x7经过up3得到up3 （1, 128, 256, 256）,同x2 拼接在一起 组成（1, 256, 256, 256）的张量，经过conv8得到x8（1, 128, 256, 256）;</p> 
<p>x8经过up4得到up4 （1, 64, 512, 512）,同x1 拼接在一起 组成（1, 128, 512, 512）的张量，经过conv6得到x9（1, 64, 512, 512）;</p> 
<p>最后，x9经过预测层predict输出，得到分割图mask。</p> 
<p>以drive数据集为例训练网络，数据示例如下。</p> 
<p><img src="https://images2.imgbox.com/4b/46/RkhChHzW_o.png" alt="在这里插入图片描述"></p> 
<p>标签如下：</p> 
<p><img src="https://images2.imgbox.com/77/6f/4YFHFsOI_o.png" alt="在这里插入图片描述"></p> 
<p>输入数据为3通道的图片，而输出数据为1通道的二值图。一张图片的原始尺寸是565×584</p> 
<p>可以在原始图像中随机裁剪256×256大小的图片，进行训练，而在使用时，图像尺寸只要是16的倍数即可。</p> 
<p>定义数据加载函数如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> random
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset


<span class="token keyword">class</span> <span class="token class-name">DriveDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>root<span class="token operator">=</span><span class="token string">'data/training'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DriveDataset<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dataset <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        start <span class="token operator">=</span> <span class="token number">20</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 按照一一对应的原则，加载图像和标签的路径</span>
            image_path <span class="token operator">=</span> f<span class="token string">'{root}/images/{i+start}_training.tif'</span>
            label_path <span class="token operator">=</span> f<span class="token string">'{root}/1st_manual/{i + start}_manual1.gif'</span>
            self<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> label_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image_path<span class="token punctuation">,</span> label_path <span class="token operator">=</span> self<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span>item<span class="token punctuation">]</span>  <span class="token comment"># 获取图像路径</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>  <span class="token comment"># 图片</span>
        video <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>label_path<span class="token punctuation">)</span>
        _<span class="token punctuation">,</span> mask_label <span class="token operator">=</span> video<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 读取标签掩码图</span>
        
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
        mask_label <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>mask_label<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>  <span class="token comment"># 转换至单通道图</span>
        
        <span class="token triple-quoted-string string">"""随即裁剪256×256的图幅，图片和标签裁剪相同的位置"""</span>
        h<span class="token punctuation">,</span> w <span class="token operator">=</span> mask_label<span class="token punctuation">.</span>shape
        w <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w<span class="token operator">-</span><span class="token number">256</span><span class="token punctuation">)</span>
        h <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token operator">-</span><span class="token number">256</span><span class="token punctuation">)</span>
        image <span class="token operator">=</span> image<span class="token punctuation">[</span>h<span class="token punctuation">:</span>h<span class="token operator">+</span><span class="token number">256</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span>w<span class="token operator">+</span><span class="token number">256</span><span class="token punctuation">]</span>
        mask_label <span class="token operator">=</span> mask_label<span class="token punctuation">[</span>h<span class="token punctuation">:</span>h <span class="token operator">+</span> <span class="token number">256</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span>w <span class="token operator">+</span> <span class="token number">256</span><span class="token punctuation">]</span>
        
        <span class="token triple-quoted-string string">"""转换至tensor"""</span>
        image <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span>
        mask_label <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>mask_label<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span>
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> mask_label
</code></pre> 
<p>读取相对应的图片和标签，转换为张量，供网络学习。其中，标签的读取使用了OpenCV的视频捕获（VideoCapture）读取首帧完成标签的数据加载。</p> 
<p>定义训练器如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>utils <span class="token keyword">import</span> save_image
<span class="token keyword">from</span> u_net <span class="token keyword">import</span> UNet
<span class="token keyword">from</span> dataset <span class="token keyword">import</span> DriveDataset
<span class="token keyword">import</span> os


<span class="token keyword">class</span> <span class="token class-name">Trainer</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda:0'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>  <span class="token comment"># 设置设备</span>
        self<span class="token punctuation">.</span>net <span class="token operator">=</span> UNet<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># 实例U-Net</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'unet.pth'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 加载权重，如果存在的话</span>
            self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'unet.pth'</span><span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dataset <span class="token operator">=</span> DriveDataset<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例数据集</span>
        self<span class="token punctuation">.</span>data_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>self<span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> drop_last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 实例数据加载器</span>
        self<span class="token punctuation">.</span>loss_func <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例二值交叉熵</span>
        self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 实例adam优化器</span>

    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 训练</span>
        <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 迭代epoch</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>image<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
                image <span class="token operator">=</span> image<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
                target <span class="token operator">=</span> target<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>

                out <span class="token operator">=</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>image<span class="token punctuation">)</span>  <span class="token comment"># 预测</span>
                loss <span class="token operator">=</span> self<span class="token punctuation">.</span>loss_func<span class="token punctuation">(</span>out<span class="token punctuation">,</span> target<span class="token punctuation">)</span>  <span class="token comment"># 计算损失</span>

                self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 清空梯度</span>
                loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 反向传播</span>
                self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 优化</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> epoch <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'unet.pth'</span><span class="token punctuation">)</span>
                save_image<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> out<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token string">'{epoch}.jpg'</span><span class="token punctuation">,</span>normalize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token builtin">range</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>二值交叉熵做损失，adam优化器优化网络。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Trainer</span><span class="token punctuation">:</span>

   	<span class="token triple-quoted-string string">"""
   	......
   	"""</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    trainer <span class="token operator">=</span> Trainer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>训练过程见下图。左边为原图，中间为标签，右边为网络预测值</p> 
<table>
<thead><tr>
<th align="center">epoch</th>
<th align="center">images</th>
</tr></thead>
<tbody>
<tr>
<td align="center">0</td>
<td align="center"><img src="https://images2.imgbox.com/7c/9d/VYKZNNZf_o.jpg" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td align="center">1</td>
<td align="center"><img src="https://images2.imgbox.com/12/2c/fAIHYR4i_o.jpg" alt="在这里插入图片描述"></td>
</tr>
<tr>
<td align="center">2</td>
<td align="center"><img src="https://images2.imgbox.com/b5/4a/xme2neY5_o.jpg" alt="在这里插入图片描述"></td>
</tr>
</tbody>
</table>
<p>完整代码：https://github.com/HibikiJie/UNetAndU2Net</p> 
<h2>
<a id="3U2Net_347"></a>3、U<sup>2</sup>-Net</h2> 
<p>而U<sup>2</sup>-Net，就是U-Net的堆叠，类似于，将U-Net中的conv块，替换成完整的U-Net网络。</p> 
<p><img src="https://images2.imgbox.com/10/17/zMHukYPx_o.png" alt="在这里插入图片描述"></p> 
<p>其网络图如下：</p> 
<p><img src="https://images2.imgbox.com/cc/19/2tC6M9wS_o.png" alt="在这里插入图片描述"></p> 
<p>其中EN_1与De_1一致，EN_2与De_2一致，EN_3与De_3一致，EN_4与De_4一致，EN_5、En6和De_5一致。</p> 
<p>先分别定义，EN_1、EN_2、EN_3、EN_4、EN_5为UNet1、UNet2、UNet3、UNet4、UNet5.</p> 
<p>首先定义UNet1：</p> 
<p>注意到，图中的白色的方块示意的，卷积使用到了dilation参数，因此，定义ConvolutionLayer为：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F


<span class="token keyword">class</span> <span class="token class-name">ConvolutionLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ConvolutionLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">*</span> dilation<span class="token punctuation">,</span>
                      dilation<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> dilation<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> dilation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 卷积</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># BN</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 激活函数</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> 
<p>卷积层由Conv、BN、ReLU构成。</p> 
<p>上采样使用机器学习算法，由双线性插值法完成上采样：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">upsample_like</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> tar<span class="token punctuation">)</span><span class="token punctuation">:</span>
    src <span class="token operator">=</span> F<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>src<span class="token punctuation">,</span> size<span class="token operator">=</span>tar<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> src
</code></pre> 
<p>该方法，将使src上采样至tar相同的尺寸大小。</p> 
<p>而下采样同样使用最大池化完成，这里可以使用与U-Net相同的代码。</p> 
<p>因此，UNet1：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">UNet1</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet1<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down3 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down4 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down5 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv8 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv9 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv10 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv11 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv12 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv13 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""下采样，编码encode的过程"""</span>
        x0 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv0<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>
        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>down3<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>d3<span class="token punctuation">)</span>
        d4 <span class="token operator">=</span> self<span class="token punctuation">.</span>down4<span class="token punctuation">(</span>x4<span class="token punctuation">)</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>d4<span class="token punctuation">)</span>
        d5 <span class="token operator">=</span> self<span class="token punctuation">.</span>down5<span class="token punctuation">(</span>x5<span class="token punctuation">)</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>d5<span class="token punctuation">)</span>

        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>x6<span class="token punctuation">)</span>
		<span class="token triple-quoted-string string">"""上采样，解码decode的过程"""</span>
        x8 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv8<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x7<span class="token punctuation">,</span> x6<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x8<span class="token punctuation">,</span> x5<span class="token punctuation">)</span>

        x9 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv9<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x5<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x9<span class="token punctuation">,</span> x4<span class="token punctuation">)</span>

        x10 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv10<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x4<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x10<span class="token punctuation">,</span> x3<span class="token punctuation">)</span>

        x11 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv11<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up3<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up4 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x11<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x12 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv12<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up4<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up5 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x12<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x13 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv13<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up5<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x13 <span class="token operator">+</span> x0
</code></pre> 
<p><img src="https://images2.imgbox.com/e7/46/tMZmSXxv_o.png" alt="在这里插入图片描述"></p> 
<p>按照上图所示的方式编码，可见，与写UNet的代码是非常类似的。可以对比着看。可见，U<sup>2</sup>-Net是U-Net的堆叠。</p> 
<p>于是类似的，UNet2的代码为:</p> 
<p><img src="https://images2.imgbox.com/91/48/1JFAPHSK_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">UNet2</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet2<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down3 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down4 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv8 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv9 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv10 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv11 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""encode"""</span>
        x0 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv0<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>
        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>down3<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>d3<span class="token punctuation">)</span>
        d4 <span class="token operator">=</span> self<span class="token punctuation">.</span>down4<span class="token punctuation">(</span>x4<span class="token punctuation">)</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>d4<span class="token punctuation">)</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>x5<span class="token punctuation">)</span>
		<span class="token triple-quoted-string string">"""decode"""</span>
        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x5<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x7<span class="token punctuation">,</span> x4<span class="token punctuation">)</span>

        x8 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv8<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x4<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x8<span class="token punctuation">,</span> x3<span class="token punctuation">)</span>

        x9 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv9<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x9<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x10 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv10<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up3<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up4 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x10<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x11 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv11<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up4<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x11 <span class="token operator">+</span> x0
</code></pre> 
<p>UNet3为：</p> 
<p><img src="https://images2.imgbox.com/08/77/mgp1u2hT_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">UNet3</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet3<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down3 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv8 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv9 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""encode"""</span>
        x0 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv0<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>
        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>down3<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>d3<span class="token punctuation">)</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>x4<span class="token punctuation">)</span>
		<span class="token triple-quoted-string string">"""decode"""</span>
        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x5<span class="token punctuation">,</span> x4<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x3<span class="token punctuation">)</span>

        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x7<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x8 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv8<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x8<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x9 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv9<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up3<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x9 <span class="token operator">+</span> x0
</code></pre> 
<p>UNet4为:</p> 
<p><img src="https://images2.imgbox.com/7d/84/5VrjsEwy_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">UNet4</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet4<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""encode"""</span>
        x0 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv0<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">"""decode"""</span>
        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x4<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x5<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x7 <span class="token operator">+</span> x0
</code></pre> 
<p>UNet5为:</p> 
<p><img src="https://images2.imgbox.com/82/24/kK7isCCW_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">UNet5</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet5<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x0 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv0<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>
        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>
        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x4<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x5<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x7 <span class="token operator">+</span> x0
</code></pre> 
<p>于是将</p> 
<p>UNet1、UNet2、UNet3、UNet4、UNet5.组装成为U<sup>2</sup>-Net</p> 
<p>再看一下网络结构图：</p> 
<p><img src="https://images2.imgbox.com/f4/a2/BP1m4xJ0_o.png" alt="在这里插入图片描述"></p> 
<p>其中EN_1与De_1一致，EN_2与De_2一致，EN_3与De_3一致，EN_4与De_4一致，EN_5、En6和De_5一致。</p> 
<p>先分别定义，EN_1、EN_2、EN_3、EN_4、EN_5为UNet1、UNet2、UNet3、UNet4、UNet5.</p> 
<p>于是EN_1与De_1使用UNet1；</p> 
<p>EN_2与De_2使用UNet2；</p> 
<p>EN_3与De_3使用UNet3；</p> 
<p>EN_4与De_4使用UNet4；</p> 
<p>EN_5、EN_6、De_5使用UNet1。</p> 
<p>故，构建网络U<sup>2</sup>-Net：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">U2Net</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>U2Net<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_1 <span class="token operator">=</span> UNet1<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_2 <span class="token operator">=</span> UNet2<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_3 <span class="token operator">=</span> UNet3<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down3 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_4 <span class="token operator">=</span> UNet4<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down4 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_5 <span class="token operator">=</span> UNet5<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down5 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_6 <span class="token operator">=</span> UNet5<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>

        <span class="token comment"># decoder</span>
        self<span class="token punctuation">.</span>de_5 <span class="token operator">=</span> UNet5<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>de_4 <span class="token operator">=</span> UNet4<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>de_3 <span class="token operator">=</span> UNet3<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>de_2 <span class="token operator">=</span> UNet2<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>de_1 <span class="token operator">=</span> UNet1<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>side1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side6 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>out_conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ------encode ------</span>
        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>
        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>down3<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_4<span class="token punctuation">(</span>d3<span class="token punctuation">)</span>
        d4 <span class="token operator">=</span> self<span class="token punctuation">.</span>down4<span class="token punctuation">(</span>x4<span class="token punctuation">)</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_5<span class="token punctuation">(</span>d4<span class="token punctuation">)</span>
        d5 <span class="token operator">=</span> self<span class="token punctuation">.</span>down5<span class="token punctuation">(</span>x5<span class="token punctuation">)</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_6<span class="token punctuation">(</span>d5<span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x5<span class="token punctuation">)</span>

        <span class="token comment"># ------decode ------</span>
        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_5<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x5<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x7<span class="token punctuation">,</span> x4<span class="token punctuation">)</span>

        x8 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_4<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x4<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x8<span class="token punctuation">,</span> x3<span class="token punctuation">)</span>

        x9 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_3<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up3<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up4 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x9<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x10 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_2<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up4<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up5 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x10<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x11 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_1<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up5<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># side output</span>
        sup1 <span class="token operator">=</span> self<span class="token punctuation">.</span>side1<span class="token punctuation">(</span>x11<span class="token punctuation">)</span>

        sup2 <span class="token operator">=</span> self<span class="token punctuation">.</span>side2<span class="token punctuation">(</span>x10<span class="token punctuation">)</span>
        sup2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup2<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup3 <span class="token operator">=</span> self<span class="token punctuation">.</span>side3<span class="token punctuation">(</span>x9<span class="token punctuation">)</span>
        sup3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup3<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup4 <span class="token operator">=</span> self<span class="token punctuation">.</span>side4<span class="token punctuation">(</span>x8<span class="token punctuation">)</span>
        sup4 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup4<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup5 <span class="token operator">=</span> self<span class="token punctuation">.</span>side5<span class="token punctuation">(</span>x7<span class="token punctuation">)</span>
        sup5 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup5<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup6 <span class="token operator">=</span> self<span class="token punctuation">.</span>side6<span class="token punctuation">(</span>x6<span class="token punctuation">)</span>
        sup6 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup6<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup0 <span class="token operator">=</span> self<span class="token punctuation">.</span>out_conv<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>sup1<span class="token punctuation">,</span> sup2<span class="token punctuation">,</span> sup3<span class="token punctuation">,</span> sup4<span class="token punctuation">,</span> sup5<span class="token punctuation">,</span> sup6<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>sup0<span class="token punctuation">)</span>
</code></pre> 
<p>U<sup>2</sup>-Net完整代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F


<span class="token keyword">class</span> <span class="token class-name">ConvolutionLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ConvolutionLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">*</span> dilation<span class="token punctuation">,</span>
                      dilation<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> dilation<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> dilation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv_s1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">*</span> dilation<span class="token punctuation">,</span>
                                 dilation<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> dilation<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> dilation<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn_s1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu_s1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">upsample_like</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> tar<span class="token punctuation">)</span><span class="token punctuation">:</span>
    src <span class="token operator">=</span> F<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>src<span class="token punctuation">,</span> size<span class="token operator">=</span>tar<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> src


<span class="token keyword">class</span> <span class="token class-name">DownSample</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DownSample<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">UNet1</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet1<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down3 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down4 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down5 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv8 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv9 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv10 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv11 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv12 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv13 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x0 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv0<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>
        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>down3<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>d3<span class="token punctuation">)</span>
        d4 <span class="token operator">=</span> self<span class="token punctuation">.</span>down4<span class="token punctuation">(</span>x4<span class="token punctuation">)</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>d4<span class="token punctuation">)</span>
        d5 <span class="token operator">=</span> self<span class="token punctuation">.</span>down5<span class="token punctuation">(</span>x5<span class="token punctuation">)</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>d5<span class="token punctuation">)</span>

        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>x6<span class="token punctuation">)</span>

        x8 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv8<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x7<span class="token punctuation">,</span> x6<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x8<span class="token punctuation">,</span> x5<span class="token punctuation">)</span>

        x9 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv9<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x5<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x9<span class="token punctuation">,</span> x4<span class="token punctuation">)</span>

        x10 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv10<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x10<span class="token punctuation">,</span> x3<span class="token punctuation">)</span>

        x11 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv11<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up3<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up4 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x11<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x12 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv12<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up4<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up5 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x12<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x13 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv13<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up5<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x13 <span class="token operator">+</span> x0


<span class="token keyword">class</span> <span class="token class-name">UNet2</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet2<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down3 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down4 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv8 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv9 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv10 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv11 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x0 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv0<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>
        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>down3<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>d3<span class="token punctuation">)</span>
        d4 <span class="token operator">=</span> self<span class="token punctuation">.</span>down4<span class="token punctuation">(</span>x4<span class="token punctuation">)</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>d4<span class="token punctuation">)</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>x5<span class="token punctuation">)</span>

        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x5<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x7<span class="token punctuation">,</span> x4<span class="token punctuation">)</span>

        x8 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv8<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x4<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x8<span class="token punctuation">,</span> x3<span class="token punctuation">)</span>

        x9 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv9<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x9<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x10 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv10<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up3<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up4 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x10<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x11 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv11<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up4<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x11 <span class="token operator">+</span> x0


<span class="token keyword">class</span> <span class="token class-name">UNet3</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet3<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down3 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv8 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv9 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x0 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv0<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>
        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>down3<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>d3<span class="token punctuation">)</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>x4<span class="token punctuation">)</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x5<span class="token punctuation">,</span> x4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x3<span class="token punctuation">)</span>

        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x7<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x8 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv8<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x8<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x9 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv9<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up3<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x9 <span class="token operator">+</span> x0


<span class="token keyword">class</span> <span class="token class-name">UNet4</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> mid_channels<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet4<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""encode"""</span>
        x0 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv0<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">"""decode"""</span>
        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x4<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x5<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x7 <span class="token operator">+</span> x0


<span class="token keyword">class</span> <span class="token class-name">UNet5</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UNet5<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv0 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv4 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv5 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv6 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv7 <span class="token operator">=</span> ConvolutionLayer<span class="token punctuation">(</span>mid_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x0 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv0<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x0<span class="token punctuation">)</span>
        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>
        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv4<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv5<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x4<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv6<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x5<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv7<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> x7 <span class="token operator">+</span> x0


<span class="token keyword">class</span> <span class="token class-name">U2Net</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>U2Net<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_1 <span class="token operator">=</span> UNet1<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down1 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_2 <span class="token operator">=</span> UNet2<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down2 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_3 <span class="token operator">=</span> UNet3<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down3 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_4 <span class="token operator">=</span> UNet4<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down4 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_5 <span class="token operator">=</span> UNet5<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>down5 <span class="token operator">=</span> DownSample<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>en_6 <span class="token operator">=</span> UNet5<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>

        <span class="token comment"># decoder</span>
        self<span class="token punctuation">.</span>de_5 <span class="token operator">=</span> UNet5<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>de_4 <span class="token operator">=</span> UNet4<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>de_3 <span class="token operator">=</span> UNet3<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>de_2 <span class="token operator">=</span> UNet2<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>de_1 <span class="token operator">=</span> UNet1<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>side1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side6 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>out_conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ------encode ------</span>
        x1 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>down1<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>

        x2 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_2<span class="token punctuation">(</span>d1<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>down2<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>

        x3 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_3<span class="token punctuation">(</span>d2<span class="token punctuation">)</span>
        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>down3<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>

        x4 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_4<span class="token punctuation">(</span>d3<span class="token punctuation">)</span>
        d4 <span class="token operator">=</span> self<span class="token punctuation">.</span>down4<span class="token punctuation">(</span>x4<span class="token punctuation">)</span>

        x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_5<span class="token punctuation">(</span>d4<span class="token punctuation">)</span>
        d5 <span class="token operator">=</span> self<span class="token punctuation">.</span>down5<span class="token punctuation">(</span>x5<span class="token punctuation">)</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_6<span class="token punctuation">(</span>d5<span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x5<span class="token punctuation">)</span>

        <span class="token comment"># ------decode ------</span>
        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_5<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x5<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x7<span class="token punctuation">,</span> x4<span class="token punctuation">)</span>

        x8 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_4<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x4<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x8<span class="token punctuation">,</span> x3<span class="token punctuation">)</span>

        x9 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_3<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up3<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up4 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x9<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x10 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_2<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up4<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up5 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x10<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x11 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_1<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up5<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># side output</span>
        sup1 <span class="token operator">=</span> self<span class="token punctuation">.</span>side1<span class="token punctuation">(</span>x11<span class="token punctuation">)</span>

        sup2 <span class="token operator">=</span> self<span class="token punctuation">.</span>side2<span class="token punctuation">(</span>x10<span class="token punctuation">)</span>
        sup2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup2<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup3 <span class="token operator">=</span> self<span class="token punctuation">.</span>side3<span class="token punctuation">(</span>x9<span class="token punctuation">)</span>
        sup3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup3<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup4 <span class="token operator">=</span> self<span class="token punctuation">.</span>side4<span class="token punctuation">(</span>x8<span class="token punctuation">)</span>
        sup4 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup4<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup5 <span class="token operator">=</span> self<span class="token punctuation">.</span>side5<span class="token punctuation">(</span>x7<span class="token punctuation">)</span>
        sup5 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup5<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup6 <span class="token operator">=</span> self<span class="token punctuation">.</span>side6<span class="token punctuation">(</span>x6<span class="token punctuation">)</span>
        sup6 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup6<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup0 <span class="token operator">=</span> self<span class="token punctuation">.</span>out_conv<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>sup1<span class="token punctuation">,</span> sup2<span class="token punctuation">,</span> sup3<span class="token punctuation">,</span> sup4<span class="token punctuation">,</span> sup5<span class="token punctuation">,</span> sup6<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>sup0<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    u2net <span class="token operator">=</span> U2Net<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>u2net<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
 x5 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_5<span class="token punctuation">(</span>d4<span class="token punctuation">)</span>
        d5 <span class="token operator">=</span> self<span class="token punctuation">.</span>down5<span class="token punctuation">(</span>x5<span class="token punctuation">)</span>

        x6 <span class="token operator">=</span> self<span class="token punctuation">.</span>en_6<span class="token punctuation">(</span>d5<span class="token punctuation">)</span>
        up1 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x6<span class="token punctuation">,</span> x5<span class="token punctuation">)</span>

        <span class="token comment"># ------decode ------</span>
        x7 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_5<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up1<span class="token punctuation">,</span> x5<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x7<span class="token punctuation">,</span> x4<span class="token punctuation">)</span>

        x8 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_4<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up2<span class="token punctuation">,</span> x4<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x8<span class="token punctuation">,</span> x3<span class="token punctuation">)</span>

        x9 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_3<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up3<span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up4 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x9<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>

        x10 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_2<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up4<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        up5 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>x10<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

        x11 <span class="token operator">=</span> self<span class="token punctuation">.</span>de_1<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>up5<span class="token punctuation">,</span> x1<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># side output</span>
        sup1 <span class="token operator">=</span> self<span class="token punctuation">.</span>side1<span class="token punctuation">(</span>x11<span class="token punctuation">)</span>

        sup2 <span class="token operator">=</span> self<span class="token punctuation">.</span>side2<span class="token punctuation">(</span>x10<span class="token punctuation">)</span>
        sup2 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup2<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup3 <span class="token operator">=</span> self<span class="token punctuation">.</span>side3<span class="token punctuation">(</span>x9<span class="token punctuation">)</span>
        sup3 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup3<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup4 <span class="token operator">=</span> self<span class="token punctuation">.</span>side4<span class="token punctuation">(</span>x8<span class="token punctuation">)</span>
        sup4 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup4<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup5 <span class="token operator">=</span> self<span class="token punctuation">.</span>side5<span class="token punctuation">(</span>x7<span class="token punctuation">)</span>
        sup5 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup5<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup6 <span class="token operator">=</span> self<span class="token punctuation">.</span>side6<span class="token punctuation">(</span>x6<span class="token punctuation">)</span>
        sup6 <span class="token operator">=</span> upsample_like<span class="token punctuation">(</span>sup6<span class="token punctuation">,</span> sup1<span class="token punctuation">)</span>

        sup0 <span class="token operator">=</span> self<span class="token punctuation">.</span>out_conv<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>sup1<span class="token punctuation">,</span> sup2<span class="token punctuation">,</span> sup3<span class="token punctuation">,</span> sup4<span class="token punctuation">,</span> sup5<span class="token punctuation">,</span> sup6<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>sup0<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    u2net <span class="token operator">=</span> U2Net<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>u2net<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>