<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>睿智的目标检测56——Pytorch搭建YoloV5目标检测平台 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">睿智的目标检测56——Pytorch搭建YoloV5目标检测平台</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    
                        
                    
                    <p></p>
<div class="toc">
 <h3>睿智的目标检测56——Pytorch搭建YoloV5目标检测平台</h3>
 <ul>
<li><a href="#_2">学习前言</a></li>
<li><a href="#_5">源码下载</a></li>
<li><a href="#YoloV5_8">YoloV5改进的部分（不完全）</a></li>
<li><a href="#YoloV5_16">YoloV5实现思路</a></li>
<li>
<ul>
<li><a href="#_17">一、整体结构解析</a></li>
<li><a href="#_31">二、网络结构解析</a></li>
<li>
<ul>
<li><a href="#1Backbone_32">1、主干网络Backbone介绍</a></li>
<li><a href="#2FPN_251">2、构建FPN特征金字塔进行加强特征提取</a></li>
<li><a href="#3Yolo_Head_353">3、利用Yolo Head获得预测结果</a></li>
</ul>
   </li>
<li><a href="#_462">三、预测结果的解码</a></li>
<li>
<ul>
<li><a href="#1_463">1、获得预测框与得分</a></li>
<li><a href="#2_577">2、得分筛选与非极大抑制</a></li>
</ul>
   </li>
<li><a href="#_686">四、训练部分</a></li>
<li>
<ul>
<li><a href="#1loss_687">1、计算loss所需内容</a></li>
<li><a href="#2_690">2、正样本的匹配过程</a></li>
<li>
<ul>
<li><a href="#a_696">a、匹配先验框</a></li>
<li><a href="#b_730">b、匹配特征点</a></li>
</ul>
    </li>
<li><a href="#3Loss_740">3、计算Loss</a></li>
</ul>
  </li>
</ul>
  </li>
<li><a href="#YoloV5_1099">训练自己的YoloV5模型</a></li>
<li>
<ul>
<li><a href="#_1104">一、数据集的准备</a></li>
<li><a href="#_1111">二、数据集的处理</a></li>
<li><a href="#_1148">三、开始网络训练</a></li>
<li><a href="#_1247">四、训练结果预测</a></li>
</ul>
 </li>
</ul>
</div>
<p></p> 
<h1>
<a id="_2"></a>学习前言</h1> 
<p>这个很久都没有学，最终还是决定看看，复现的是YoloV5的第5版，V5有好多版本在，作者也一直在更新，我选了这个时间的倒数第二个版本。<br> <img src="https://images2.imgbox.com/a3/5d/AuzsJs0U_o.jpg" alt="在这里插入图片描述"></p> 
<h1>
<a id="_5"></a>源码下载</h1> 
<p>https://github.com/bubbliiiing/yolov5-pytorch<br> 喜欢的可以点个star噢。</p> 
<h1>
<a id="YoloV5_8"></a>YoloV5改进的部分（不完全）</h1> 
<p><strong>1、主干部分：使用了Focus网络结构，具体操作是在一张图片中每隔一个像素拿到一个值，这个时候获得了四个独立的特征层，然后将四个独立的特征层进行堆叠，此时宽高信息就集中到了通道信息，输入通道扩充了四倍</strong>。<strong>该结构在YoloV5第5版之前有所应用，最新版本中未使用。</strong></p> 
<p><strong>2、数据增强：Mosaic数据增强、Mosaic利用了四张图片进行拼接实现数据中增强，根据论文所说其拥有一个巨大的优点是丰富检测物体的背景！且在BN计算的时候一下子会计算四张图片的数据！</strong></p> 
<p><strong>3、多正样本匹配：在之前的Yolo系列里面，在训练时每一个真实框对应一个正样本，即在训练时，每一个真实框仅由一个先验框负责预测。YoloV5中为了加快模型的训练效率，增加了正样本的数量，在训练时，每一个真实框可以由多个先验框负责预测。</strong></p> 
<p><strong>以上并非全部的改进部分，还存在一些其它的改进，这里只列出来了一些我比较感兴趣，而且非常有效的改进。</strong></p> 
<h1>
<a id="YoloV5_16"></a>YoloV5实现思路</h1> 
<h2>
<a id="_17"></a>一、整体结构解析</h2> 
<p><img src="https://images2.imgbox.com/b2/32/prgTvbOH_o.png" alt="在这里插入图片描述"></p> 
<p>在学习YoloV5之前，我们需要对YoloV5所作的工作有一定的了解，这有助于我们后面去了解网络的细节。</p> 
<p><strong>和之前版本的Yolo类似，整个YoloV5可以依然可以分为三个部分，分别是Backbone，FPN以及Yolo Head</strong>。</p> 
<p><strong>Backbone可以被称作YoloV5的主干特征提取网络</strong>，<strong>根据它的结构以及之前Yolo主干的叫法，我一般叫它CSPDarknet</strong>，输入的图片首先会在CSPDarknet里面进行<strong>特征提取</strong>，提取到的特征可以被称作特征层，<strong>是输入图片的特征集合</strong>。在主干部分，我们<strong>获取了三个特征层</strong>进行下一步网络的构建，这三个特征层我称它为<strong>有效特征层</strong>。</p> 
<p><strong>FPN可以被称作YoloV5的加强特征提取网络</strong>，在主干部分获得的三个<strong>有效特征层</strong>会在这一部分进行特征融合，特征融合的目的是结合不同尺度的特征信息。在FPN部分，已经获得的<strong>有效特征层</strong>被用于继续提取特征。<strong>在YoloV5里依然使用到了Panet的结构，我们不仅会对特征进行上采样实现特征融合，还会对特征再次进行下采样实现特征融合。</strong></p> 
<p><strong>Yolo Head是YoloV5的分类器与回归器</strong>，通过CSPDarknet和FPN，我们已经可以获得三个加强过的有效特征层。每一个特征层都有宽、高和通道数，此时我们可以将<strong>特征图看作一个又一个特征点的集合</strong>，<strong>每一个特征点都有通道数个特征</strong>。Yolo Head实际上所做的工作就是<strong>对特征点进行判断</strong>，判断<strong>特征点是否有物体与其对应</strong>。与以前版本的Yolo一样，YoloV5所用的解耦头是一起的，也就是分类和回归在一个1X1卷积里实现。</p> 
<p>因此，整个YoloV5网络所作的工作就是 <strong>特征提取-特征加强-预测特征点对应的物体情况</strong>。</p> 
<h2>
<a id="_31"></a>二、网络结构解析</h2> 
<h3>
<a id="1Backbone_32"></a>1、主干网络Backbone介绍</h3> 
<p><img src="https://images2.imgbox.com/b2/32/prgTvbOH_o.png" alt="在这里插入图片描述"><br> YoloV5所使用的主干特征提取网络为CSPDarknet，它具有五个重要特点：<br> 1、使用了<strong>残差网络Residual</strong>，CSPDarknet中的残差卷积可以分为两个部分，主干部分是一次1X1的卷积和一次3X3的卷积；残差边部分不做任何处理，直接将主干的输入与输出结合。<strong>整个YoloV3的主干部分都由残差卷积构成</strong>：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Bottleneck</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Standard bottleneck</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ch_in, ch_out, shortcut, groups, expansion</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Bottleneck<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        c_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>c2 <span class="token operator">*</span> e<span class="token punctuation">)</span>  <span class="token comment"># hidden channels</span>
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> g<span class="token operator">=</span>g<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>add <span class="token operator">=</span> shortcut <span class="token keyword">and</span> c1 <span class="token operator">==</span> c2

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>add <span class="token keyword">else</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/58/bd/QJh0PoY0_o.png" alt="在这里插入图片描述"><br> 残差网络的特点是<strong>容易优化</strong>，并且能够通过增加相当的<strong>深度来提高准确率</strong>。其内部的<strong>残差块使用了跳跃连接，缓解了在深度神经网络中增加深度带来的梯度消失问题。</strong></p> 
<p>2、使用<strong>CSPnet</strong>网络结构，CSPnet结构并不算复杂，就是将原来的残差块的堆叠进行了一个拆分，拆成左右两部分：<strong>主干部分继续进行原来的残差块的堆叠</strong>；<strong>另一部分则像一个残差边一样，经过少量处理直接连接到最后。<strong>因此可以认为</strong>CSP中存在一个大的残差边。</strong><img src="https://images2.imgbox.com/fb/a0/MN6bZcUg_o.png" alt="在这里插入图片描述" width="500"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">C3</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># CSP Bottleneck with 3 convolutions</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ch_in, ch_out, number, shortcut, groups, expansion</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>C3<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        c_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>c2 <span class="token operator">*</span> e<span class="token punctuation">)</span>  <span class="token comment"># hidden channels</span>
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv3 <span class="token operator">=</span> Conv<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> c_<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># act=FReLU(c2)</span>
        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span>Bottleneck<span class="token punctuation">(</span>c_<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> shortcut<span class="token punctuation">,</span> g<span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># self.m = nn.Sequential(*[CrossConv(c_, c_, 3, 1, g, 1.0, shortcut) for _ in range(n)])</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>cv3<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>m<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>3、使用了Focus网络结构，这个网络结构是在YoloV5里面使用到比较有趣的网络结构，具体操作是在一张图片中每隔一个像素拿到一个值，这个时候获得了四个独立的特征层，然后将四个独立的特征层进行堆叠，此时宽高信息就集中到了通道信息，输入通道扩充了四倍。拼接起来的特征层相对于原先的三通道变成了十二个通道，下图很好的展示了Focus结构，一看就能明白。<br> <img src="https://images2.imgbox.com/02/8c/4QExRCIX_o.png" alt="在这里插入图片描述" width="300"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Focus</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ch_in, ch_out, kernel, stride, padding, groups</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Focus<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1 <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token punctuation">,</span> s<span class="token punctuation">,</span> p<span class="token punctuation">,</span> g<span class="token punctuation">,</span> act<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>4、使用了SiLU激活函数，SiLU是Sigmoid和ReLU的改进版。SiLU具备无上界有下界、平滑、非单调的特性。SiLU在深层模型上的效果优于 ReLU。可以看做是平滑的ReLU激活函数。<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         f
        
        
         (
        
        
         x
        
        
         )
        
        
         =
        
        
         x
        
        
         ⋅
        
        
         sigmoid
        
        
         (
        
        
         x
        
        
         )
        
       
       
         f(x) = x · text{sigmoid}(x) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.10764em">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">x</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord text"><span class="mord">sigmoid</span></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span></span></span><br> <img src="https://images2.imgbox.com/a9/86/MckmQXSa_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SiLU</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre> 
<p>5、使用了SPP结构，通过不同池化核大小的最大池化进行特征提取，提高网络的感受野。在YoloV4中，SPP是用在FPN里面的，在YoloV5中，SPP模块被用在了主干特征提取网络中。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SPP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Spatial pyramid pooling layer used in YOLOv3-SPP</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SPP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        c_ <span class="token operator">=</span> c1 <span class="token operator">//</span> <span class="token number">2</span>  <span class="token comment"># hidden channels</span>
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_ <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span>x<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span>x <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> k<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>m<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>m<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>整个主干实现代码为：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn


<span class="token keyword">class</span> <span class="token class-name">SiLU</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">autopad</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> p <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> k <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">[</span>x <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> k<span class="token punctuation">]</span> 
    <span class="token keyword">return</span> p

<span class="token keyword">class</span> <span class="token class-name">Focus</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ch_in, ch_out, kernel, stride, padding, groups</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Focus<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1 <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token punctuation">,</span> s<span class="token punctuation">,</span> p<span class="token punctuation">,</span> g<span class="token punctuation">,</span> act<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Conv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Conv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token punctuation">,</span> s<span class="token punctuation">,</span> autopad<span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>g<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>c2<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.03</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act <span class="token operator">=</span> SiLU<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> act <span class="token keyword">is</span> <span class="token boolean">True</span> <span class="token keyword">else</span> <span class="token punctuation">(</span>act <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>act<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span> <span class="token keyword">else</span> nn<span class="token punctuation">.</span>Identity<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">fuseforward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Bottleneck</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Standard bottleneck</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ch_in, ch_out, shortcut, groups, expansion</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Bottleneck<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        c_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>c2 <span class="token operator">*</span> e<span class="token punctuation">)</span>  <span class="token comment"># hidden channels</span>
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> g<span class="token operator">=</span>g<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>add <span class="token operator">=</span> shortcut <span class="token keyword">and</span> c1 <span class="token operator">==</span> c2

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>add <span class="token keyword">else</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">C3</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># CSP Bottleneck with 3 convolutions</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ch_in, ch_out, number, shortcut, groups, expansion</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>C3<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        c_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>c2 <span class="token operator">*</span> e<span class="token punctuation">)</span>  <span class="token comment"># hidden channels</span>
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv3 <span class="token operator">=</span> Conv<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> c_<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># act=FReLU(c2)</span>
        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span>Bottleneck<span class="token punctuation">(</span>c_<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> shortcut<span class="token punctuation">,</span> g<span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># self.m = nn.Sequential(*[CrossConv(c_, c_, 3, 1, g, 1.0, shortcut) for _ in range(n)])</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>cv3<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>m<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">SPP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Spatial pyramid pooling layer used in YOLOv3-SPP</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SPP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        c_ <span class="token operator">=</span> c1 <span class="token operator">//</span> <span class="token number">2</span>  <span class="token comment"># hidden channels</span>
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_ <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span>x<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span>x <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> k<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>m<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>m<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
<span class="token keyword">class</span> <span class="token class-name">CSPDarknet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> base_channels<span class="token punctuation">,</span> base_depth<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入图片是640, 640, 3</span>
        <span class="token comment">#   初始的基本通道是64</span>
        <span class="token comment">#-----------------------------------------------#</span>

        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   利用focus网络结构进行特征提取</span>
        <span class="token comment">#   640, 640, 3 -&gt; 320, 320, 12 -&gt; 320, 320, 64</span>
        <span class="token comment">#-----------------------------------------------#</span>
        self<span class="token punctuation">.</span>stem       <span class="token operator">=</span> Focus<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> base_channels<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   完成卷积之后，320, 320, 64 -&gt; 160, 160, 128</span>
        <span class="token comment">#   完成CSPlayer之后，160, 160, 128 -&gt; 160, 160, 128</span>
        <span class="token comment">#-----------------------------------------------#</span>
        self<span class="token punctuation">.</span>dark2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Conv<span class="token punctuation">(</span>base_channels<span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   完成卷积之后，160, 160, 128 -&gt; 80, 80, 256</span>
        <span class="token comment">#   完成CSPlayer之后，80, 80, 256 -&gt; 80, 80, 256</span>
        <span class="token comment">#-----------------------------------------------#</span>
        self<span class="token punctuation">.</span>dark3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> base_depth <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   完成卷积之后，80, 80, 256 -&gt; 40, 40, 512</span>
        <span class="token comment">#   完成CSPlayer之后，40, 40, 512 -&gt; 40, 40, 512</span>
        <span class="token comment">#-----------------------------------------------#</span>
        self<span class="token punctuation">.</span>dark4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_depth <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   完成卷积之后，40, 40, 512 -&gt; 20, 20, 1024</span>
        <span class="token comment">#   完成SPP之后，20, 20, 1024 -&gt; 20, 20, 1024</span>
        <span class="token comment">#   完成CSPlayer之后，20, 20, 1024 -&gt; 20, 20, 1024</span>
        <span class="token comment">#-----------------------------------------------#</span>
        self<span class="token punctuation">.</span>dark5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            SPP<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>stem<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dark2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   dark3的输出为80, 80, 256，是一个有效特征层</span>
        <span class="token comment">#-----------------------------------------------#</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dark3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        feat1 <span class="token operator">=</span> x
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   dark4的输出为40, 40, 512，是一个有效特征层</span>
        <span class="token comment">#-----------------------------------------------#</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dark4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        feat2 <span class="token operator">=</span> x
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   dark5的输出为20, 20, 1024，是一个有效特征层</span>
        <span class="token comment">#-----------------------------------------------#</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dark5<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        feat3 <span class="token operator">=</span> x
        <span class="token keyword">return</span> feat1<span class="token punctuation">,</span> feat2<span class="token punctuation">,</span> feat3
</code></pre> 
<h3>
<a id="2FPN_251"></a>2、构建FPN特征金字塔进行加强特征提取</h3> 
<p><img src="https://images2.imgbox.com/b2/32/prgTvbOH_o.png" alt="在这里插入图片描述"><br> 在特征利用部分，YoloV5提取<strong>多特征层进行目标检测</strong>，一共<strong>提取三个特征层</strong>。<br> 三个特征层位于主干部分CSPdarknet的不同位置，分别位于<strong>中间层，中下层，底层</strong>，当输入为(640,640,3)的时候，三个特征层的<strong>shape分别为feat1=(80,80,256)、feat2=(40,40,512)、feat3=(20,20,1024)。</strong></p> 
<p>在获得三个有效特征层后，我们利用这三个有效特征层进行FPN层的构建，构建方式为：</p> 
<ol>
<li>feat3=(20,20,1024)的特征层进行1次1X1卷积调整通道后获得P5，<strong>P5进行上采样UmSampling2d后与feat2=(40,40,512)特征层进行结合</strong>，然后使用CSPLayer进行特征提取获得P5_upsample，此时获得的特征层为(40,40,512)。</li>
<li>P5_upsample=(40,40,512)的特征层进行1次1X1卷积调整通道后获得P4，<strong>P4进行上采样UmSampling2d后与feat1=(80,80,256)特征层进行结合</strong>，然后使用CSPLayer进行特征提取P3_out，此时获得的特征层为(80,80,256)。</li>
<li>P3_out=(80,80,256)的特征层进行一次3x3卷积进行下采样，<strong>下采样后与P4堆叠</strong>，然后使用CSPLayer进行特征提取P4_out，此时获得的特征层为(40,40,512)。</li>
<li>P4_out=(40,40,512)的特征层进行一次3x3卷积进行下采样，<strong>下采样后与P5堆叠</strong>，然后使用CSPLayer进行特征提取P5_out，此时获得的特征层为(20,20,1024)。</li>
</ol> 
<p>特征金字塔可以将<strong>不同shape的特征层进行特征融合</strong>，有利于<strong>提取出更好的特征</strong>。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">from</span> nets<span class="token punctuation">.</span>CSPdarknet <span class="token keyword">import</span> CSPDarknet<span class="token punctuation">,</span> C3<span class="token punctuation">,</span> Conv

<span class="token comment">#---------------------------------------------------#</span>
<span class="token comment">#   yolo_body</span>
<span class="token comment">#---------------------------------------------------#</span>
<span class="token keyword">class</span> <span class="token class-name">YoloBody</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors_mask<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> phi<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>YoloBody<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        depth_dict          <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'s'</span> <span class="token punctuation">:</span> <span class="token number">0.33</span><span class="token punctuation">,</span> <span class="token string">'m'</span> <span class="token punctuation">:</span> <span class="token number">0.67</span><span class="token punctuation">,</span> <span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">1.00</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">1.33</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
        width_dict          <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'s'</span> <span class="token punctuation">:</span> <span class="token number">0.50</span><span class="token punctuation">,</span> <span class="token string">'m'</span> <span class="token punctuation">:</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">1.00</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">1.25</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
        dep_mul<span class="token punctuation">,</span> wid_mul    <span class="token operator">=</span> depth_dict<span class="token punctuation">[</span>phi<span class="token punctuation">]</span><span class="token punctuation">,</span> width_dict<span class="token punctuation">[</span>phi<span class="token punctuation">]</span>

        base_channels       <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>wid_mul <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>  <span class="token comment"># 64</span>
        base_depth          <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dep_mul <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 3</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入图片是640, 640, 3</span>
        <span class="token comment">#   初始的基本通道是64</span>
        <span class="token comment">#-----------------------------------------------#</span>

        <span class="token comment">#---------------------------------------------------#   </span>
        <span class="token comment">#   生成CSPdarknet53的主干模型</span>
        <span class="token comment">#   获得三个有效特征层，他们的shape分别是：</span>
        <span class="token comment">#   80,80,256</span>
        <span class="token comment">#   40,40,512</span>
        <span class="token comment">#   20,20,1024</span>
        <span class="token comment">#---------------------------------------------------#</span>
        self<span class="token punctuation">.</span>backbone   <span class="token operator">=</span> CSPDarknet<span class="token punctuation">(</span>base_channels<span class="token punctuation">,</span> base_depth<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>upsample   <span class="token operator">=</span> nn<span class="token punctuation">.</span>Upsample<span class="token punctuation">(</span>scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"nearest"</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv_for_feat3         <span class="token operator">=</span> Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_upsample1    <span class="token operator">=</span> C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv_for_feat2         <span class="token operator">=</span> Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_upsample2    <span class="token operator">=</span> C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>down_sample1           <span class="token operator">=</span> Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_downsample1  <span class="token operator">=</span> C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>down_sample2           <span class="token operator">=</span> Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_downsample2  <span class="token operator">=</span> C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>yolo_head_P3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>yolo_head_P4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>yolo_head_P5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#  backbone</span>
        feat1<span class="token punctuation">,</span> feat2<span class="token punctuation">,</span> feat3 <span class="token operator">=</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        P5          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_for_feat3<span class="token punctuation">(</span>feat3<span class="token punctuation">)</span>
        P5_upsample <span class="token operator">=</span> self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        P4          <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P5_upsample<span class="token punctuation">,</span> feat2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P4          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_upsample1<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>

        P4          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_for_feat2<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P4_upsample <span class="token operator">=</span> self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P3          <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P4_upsample<span class="token punctuation">,</span> feat1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P3          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_upsample2<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>

        P3_downsample <span class="token operator">=</span> self<span class="token punctuation">.</span>down_sample1<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P3_downsample<span class="token punctuation">,</span> P4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_downsample1<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>

        P4_downsample <span class="token operator">=</span> self<span class="token punctuation">.</span>down_sample2<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P4_downsample<span class="token punctuation">,</span> P5<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_downsample2<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>

        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第三个特征层</span>
        <span class="token comment">#   y3=(batch_size,75,80,80)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out2 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P3<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第二个特征层</span>
        <span class="token comment">#   y2=(batch_size,75,40,40)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out1 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P4<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第一个特征层</span>
        <span class="token comment">#   y1=(batch_size,75,20,20)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out0 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P5<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out0<span class="token punctuation">,</span> out1<span class="token punctuation">,</span> out2
</code></pre> 
<h3>
<a id="3Yolo_Head_353"></a>3、利用Yolo Head获得预测结果</h3> 
<p><img src="https://images2.imgbox.com/b2/32/prgTvbOH_o.png" alt="在这里插入图片描述"><br> 利用FPN特征金字塔，<strong>我们可以获得三个加强特征，这三个加强特征的shape分别为(20,20,1024)、(40,40,512)、(80,80,256)，然后我们利用这三个shape的特征层传入Yolo Head获得预测结果。</strong></p> 
<p>对于每一个特征层，我们可以获得利用一个卷积调整通道数，最终的通道数和需要区分的种类个数相关，在YoloV5里，每一个特征层上每一个特征点存在3个先验框。</p> 
<p><strong>如果使用的是voc训练集，类则为20种，最后的维度应该为75 = 3x25</strong>，三个特征层的shape为(<strong>20,20,75</strong>)，(<strong>40,40,75</strong>)，(<strong>80,80,75</strong>)。<br> 最后的75可以拆分成3个25，对应3个先验框的25个参数，25可以拆分成4+1+20。<br> 前4个参数用于判断每一个特征点的回归参数，回归参数调整后可以获得预测框；<br> 第5个参数用于判断每一个特征点是否包含物体；<br> 最后20个参数用于判断每一个特征点所包含的物体种类。</p> 
<p><strong>如果使用的是coco训练集，类则为80种，最后的维度应该为255 = 3x85</strong>，三个特征层的shape为(<strong>13,13,255</strong>)，(<strong>26,26,255</strong>)，(<strong>52,52,255</strong>)<br> 最后的255可以拆分成3个85，对应3个先验框的85个参数，85可以拆分成4+1+80。<br> 前4个参数用于判断每一个特征点的回归参数，回归参数调整后可以获得预测框；<br> 第5个参数用于判断每一个特征点是否包含物体；<br> 最后80个参数用于判断每一个特征点所包含的物体种类。</p> 
<p>实现代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">from</span> nets<span class="token punctuation">.</span>CSPdarknet <span class="token keyword">import</span> CSPDarknet<span class="token punctuation">,</span> C3<span class="token punctuation">,</span> Conv

<span class="token comment">#---------------------------------------------------#</span>
<span class="token comment">#   yolo_body</span>
<span class="token comment">#---------------------------------------------------#</span>
<span class="token keyword">class</span> <span class="token class-name">YoloBody</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors_mask<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> phi<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>YoloBody<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        depth_dict          <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'s'</span> <span class="token punctuation">:</span> <span class="token number">0.33</span><span class="token punctuation">,</span> <span class="token string">'m'</span> <span class="token punctuation">:</span> <span class="token number">0.67</span><span class="token punctuation">,</span> <span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">1.00</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">1.33</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
        width_dict          <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'s'</span> <span class="token punctuation">:</span> <span class="token number">0.50</span><span class="token punctuation">,</span> <span class="token string">'m'</span> <span class="token punctuation">:</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">1.00</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">1.25</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
        dep_mul<span class="token punctuation">,</span> wid_mul    <span class="token operator">=</span> depth_dict<span class="token punctuation">[</span>phi<span class="token punctuation">]</span><span class="token punctuation">,</span> width_dict<span class="token punctuation">[</span>phi<span class="token punctuation">]</span>

        base_channels       <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>wid_mul <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>  <span class="token comment"># 64</span>
        base_depth          <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dep_mul <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 3</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入图片是640, 640, 3</span>
        <span class="token comment">#   初始的基本通道是64</span>
        <span class="token comment">#-----------------------------------------------#</span>

        <span class="token comment">#---------------------------------------------------#   </span>
        <span class="token comment">#   生成CSPdarknet53的主干模型</span>
        <span class="token comment">#   获得三个有效特征层，他们的shape分别是：</span>
        <span class="token comment">#   80,80,256</span>
        <span class="token comment">#   40,40,512</span>
        <span class="token comment">#   20,20,1024</span>
        <span class="token comment">#---------------------------------------------------#</span>
        self<span class="token punctuation">.</span>backbone   <span class="token operator">=</span> CSPDarknet<span class="token punctuation">(</span>base_channels<span class="token punctuation">,</span> base_depth<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>upsample   <span class="token operator">=</span> nn<span class="token punctuation">.</span>Upsample<span class="token punctuation">(</span>scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"nearest"</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv_for_feat3         <span class="token operator">=</span> Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_upsample1    <span class="token operator">=</span> C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv_for_feat2         <span class="token operator">=</span> Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_upsample2    <span class="token operator">=</span> C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>down_sample1           <span class="token operator">=</span> Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_downsample1  <span class="token operator">=</span> C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>down_sample2           <span class="token operator">=</span> Conv<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3_for_downsample2  <span class="token operator">=</span> C3<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>yolo_head_P3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>yolo_head_P4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>yolo_head_P5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#  backbone</span>
        feat1<span class="token punctuation">,</span> feat2<span class="token punctuation">,</span> feat3 <span class="token operator">=</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        P5          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_for_feat3<span class="token punctuation">(</span>feat3<span class="token punctuation">)</span>
        P5_upsample <span class="token operator">=</span> self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        P4          <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P5_upsample<span class="token punctuation">,</span> feat2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P4          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_upsample1<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>

        P4          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_for_feat2<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P4_upsample <span class="token operator">=</span> self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P3          <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P4_upsample<span class="token punctuation">,</span> feat1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P3          <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_upsample2<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>

        P3_downsample <span class="token operator">=</span> self<span class="token punctuation">.</span>down_sample1<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P3_downsample<span class="token punctuation">,</span> P4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P4 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_downsample1<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>

        P4_downsample <span class="token operator">=</span> self<span class="token punctuation">.</span>down_sample2<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>P4_downsample<span class="token punctuation">,</span> P5<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        P5 <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3_for_downsample2<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>

        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第三个特征层</span>
        <span class="token comment">#   y3=(batch_size,75,80,80)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out2 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P3<span class="token punctuation">(</span>P3<span class="token punctuation">)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第二个特征层</span>
        <span class="token comment">#   y2=(batch_size,75,40,40)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out1 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P4<span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        <span class="token comment">#   第一个特征层</span>
        <span class="token comment">#   y1=(batch_size,75,20,20)</span>
        <span class="token comment">#---------------------------------------------------#</span>
        out0 <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_head_P5<span class="token punctuation">(</span>P5<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out0<span class="token punctuation">,</span> out1<span class="token punctuation">,</span> out2
</code></pre> 
<h2>
<a id="_462"></a>三、预测结果的解码</h2> 
<h3>
<a id="1_463"></a>1、获得预测框与得分</h3> 
<p>由第二步我们可以获得三个特征层的预测结果，shape分别为(<strong>N,20,20,255</strong>)，(<strong>N,40,40,255</strong>)，(<strong>N,80,80,255</strong>)的数据。</p> 
<p>但是这个预测结果并不对应着最终的预测框在图片上的位置，还需要解码才可以完成。在YoloV5里，每一个特征层上每一个特征点存在3个先验框。</p> 
<p><strong>每个特征层最后的255可以拆分成3个85，对应3个先验框的85个参数</strong>，我们先将其reshape一下，其结果为(<strong>N,20,20,3,85</strong>)，(<strong>N,40.40,3,85</strong>)，(<strong>N,80,80,3,85</strong>)。</p> 
<p><strong>其中的85可以拆分成4+1+80。</strong><br> <strong>前4个参数用于判断每一个特征点的回归参数，回归参数调整后可以获得预测框；<br> 第5个参数用于判断每一个特征点是否包含物体；<br> 最后80个参数用于判断每一个特征点所包含的物体种类。</strong></p> 
<p>以(<strong>N,20,20,3,85</strong>)这个特征层为例，<strong>该特征层相当于将图像划分成20x20个特征点，如果某个特征点落在物体的对应框内，就用于预测该物体。</strong></p> 
<p>如图所示，蓝色的点为20x20的特征点，此时我们对左图黑色点的三个先验框进行解码操作演示：<br> 1、进行中心预测点的计算，<strong>利用Regression预测结果前两个序号的内容对特征点的三个先验框中心坐标进行偏移，偏移后是右图红色的三个点；</strong><br> 2、进行预测框宽高的计算，<strong>利用Regression预测结果后两个序号的内容求指数后获得预测框的宽高；</strong><br> 3、此时获得的预测框就可以绘制在图片上了。<br> <img src="https://images2.imgbox.com/90/09/jQiChInR_o.png" alt="在这里插入图片描述"><br> 除去这样的解码操作，还有非极大抑制的操作需要进行，防止同一种类的框的堆积。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">decode_box</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token builtin">input</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入的input一共有三个，他们的shape分别是</span>
        <span class="token comment">#   batch_size, 255, 20, 20</span>
        <span class="token comment">#   batch_size, 255, 40, 40</span>
        <span class="token comment">#   batch_size, 255, 80, 80</span>
        <span class="token comment">#-----------------------------------------------#</span>
        batch_size      <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        input_height    <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        input_width     <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入为416x416时</span>
        <span class="token comment">#   stride_h = stride_w = 32、16、8</span>
        <span class="token comment">#-----------------------------------------------#</span>
        stride_h <span class="token operator">=</span> self<span class="token punctuation">.</span>input_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> input_height
        stride_w <span class="token operator">=</span> self<span class="token punctuation">.</span>input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> input_width
        <span class="token comment">#-------------------------------------------------#</span>
        <span class="token comment">#   此时获得的scaled_anchors大小是相对于特征层的</span>
        <span class="token comment">#-------------------------------------------------#</span>
        scaled_anchors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>anchor_width <span class="token operator">/</span> stride_w<span class="token punctuation">,</span> anchor_height <span class="token operator">/</span> stride_h<span class="token punctuation">)</span> <span class="token keyword">for</span> anchor_width<span class="token punctuation">,</span> anchor_height <span class="token keyword">in</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入的input一共有三个，他们的shape分别是</span>
        <span class="token comment">#   batch_size, 3, 20, 20, 85</span>
        <span class="token comment">#   batch_size, 3, 40, 40, 85</span>
        <span class="token comment">#   batch_size, 3, 80, 80, 85</span>
        <span class="token comment">#-----------------------------------------------#</span>
        prediction <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                self<span class="token punctuation">.</span>bbox_attrs<span class="token punctuation">,</span> input_height<span class="token punctuation">,</span> input_width<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   先验框的中心位置的调整参数</span>
        <span class="token comment">#-----------------------------------------------#</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
        y <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   先验框的宽高调整参数</span>
        <span class="token comment">#-----------------------------------------------#</span>
        w <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
        h <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   获得置信度，是否有物体</span>
        <span class="token comment">#-----------------------------------------------#</span>
        conf        <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   种类置信度</span>
        <span class="token comment">#-----------------------------------------------#</span>
        pred_cls    <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        FloatTensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>FloatTensor <span class="token keyword">if</span> x<span class="token punctuation">.</span>is_cuda <span class="token keyword">else</span> torch<span class="token punctuation">.</span>FloatTensor
        LongTensor  <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>LongTensor <span class="token keyword">if</span> x<span class="token punctuation">.</span>is_cuda <span class="token keyword">else</span> torch<span class="token punctuation">.</span>LongTensor

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   生成网格，先验框中心，网格左上角 </span>
        <span class="token comment">#   batch_size,3,20,20</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        grid_x <span class="token operator">=</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> input_width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> input_width<span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>input_height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>
            batch_size <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>FloatTensor<span class="token punctuation">)</span>
        grid_y <span class="token operator">=</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> input_height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> input_height<span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>input_width<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>
            batch_size <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>y<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>FloatTensor<span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   按照网格格式生成先验框的宽高</span>
        <span class="token comment">#   batch_size,3,20,20</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        anchor_w <span class="token operator">=</span> FloatTensor<span class="token punctuation">(</span>scaled_anchors<span class="token punctuation">)</span><span class="token punctuation">.</span>index_select<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> LongTensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        anchor_h <span class="token operator">=</span> FloatTensor<span class="token punctuation">(</span>scaled_anchors<span class="token punctuation">)</span><span class="token punctuation">.</span>index_select<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> LongTensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        anchor_w <span class="token operator">=</span> anchor_w<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> input_height <span class="token operator">*</span> input_width<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>w<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        anchor_h <span class="token operator">=</span> anchor_h<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> input_height <span class="token operator">*</span> input_width<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>h<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   利用预测结果对先验框进行调整</span>
        <span class="token comment">#   首先调整先验框的中心，从先验框中心向右下角偏移</span>
        <span class="token comment">#   再调整先验框的宽高。</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        pred_boxes          <span class="token operator">=</span> FloatTensor<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        pred_boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>  <span class="token operator">=</span> x<span class="token punctuation">.</span>data <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid_x
        pred_boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>  <span class="token operator">=</span> y<span class="token punctuation">.</span>data <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid_y
        pred_boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span>w<span class="token punctuation">.</span>data <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchor_w
        pred_boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">(</span>h<span class="token punctuation">.</span>data <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchor_h

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   将输出结果归一化成小数的形式</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        _scale <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>input_width<span class="token punctuation">,</span> input_height<span class="token punctuation">,</span> input_width<span class="token punctuation">,</span> input_height<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>FloatTensor<span class="token punctuation">)</span>
        output <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>pred_boxes<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">/</span> _scale<span class="token punctuation">,</span>
                            conf<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pred_cls<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> outputs
</code></pre> 
<h3>
<a id="2_577"></a>2、得分筛选与非极大抑制</h3> 
<p>得到最终的预测结果后还要进行<strong>得分排序与非极大抑制筛选</strong>。</p> 
<p><strong>得分筛选</strong>就是<strong>筛选出得分满足confidence置信度的预测框。</strong><br> <strong>非极大抑制</strong>就是<strong>筛选出一定区域内属于同一种类得分最大的框。</strong></p> 
<p>得分筛选与非极大抑制的过程可以概括如下：<br> 1、找出该图片中<strong>得分大于门限函数的框</strong>。在进行<strong>重合框筛选前就进行得分的筛选可以大幅度减少框的数量。</strong><br> 2、对<strong>种类进行循环</strong>，非极大抑制的作用是<strong>筛选出一定区域内属于同一种类得分最大的框</strong>，对种类进行循环可以<strong>帮助我们对每一个类分别进行非极大抑制。</strong><br> 3、根据得分对该种类进行从大到小排序。<br> 4、每次取出得分最大的框，计算<strong>其与其它所有预测框的重合程度，重合程度过大的则剔除。</strong></p> 
<p>得分筛选与非极大抑制后的结果就可以用于绘制预测框了。</p> 
<p>下图是经过非极大抑制的。<br> <img src="https://images2.imgbox.com/a4/fc/BIv0FD4I_o.png" alt="在这里插入图片描述" width="400"><br> 下图是未经过非极大抑制的。<br> <img src="https://images2.imgbox.com/f0/7c/0dhRUtyu_o.png" alt="在这里插入图片描述" width="400"><br> 实现代码为：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">non_max_suppression</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> prediction<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span> image_shape<span class="token punctuation">,</span> letterbox_image<span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> nms_thres<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    <span class="token comment">#   将预测结果的格式转换成左上角右下角的格式。</span>
    <span class="token comment">#   prediction  [batch_size, num_anchors, 85]</span>
    <span class="token comment">#----------------------------------------------------------#</span>
    box_corner          <span class="token operator">=</span> prediction<span class="token punctuation">.</span>new<span class="token punctuation">(</span>prediction<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    box_corner<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
    box_corner<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
    box_corner<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
    box_corner<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">2</span>
    prediction<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> box_corner<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>

    output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>prediction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> image_pred <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>prediction<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   对种类预测部分取max。</span>
        <span class="token comment">#   class_conf  [num_anchors, 1]    种类置信度</span>
        <span class="token comment">#   class_pred  [num_anchors, 1]    种类</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        class_conf<span class="token punctuation">,</span> class_pred <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>image_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   利用置信度进行第一轮筛选</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        conf_mask <span class="token operator">=</span> <span class="token punctuation">(</span>image_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> class_conf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> conf_thres<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">#----------------------------------------------------------#</span>
        <span class="token comment">#   根据置信度进行预测结果的筛选</span>
        <span class="token comment">#----------------------------------------------------------#</span>
        image_pred <span class="token operator">=</span> image_pred<span class="token punctuation">[</span>conf_mask<span class="token punctuation">]</span>
        class_conf <span class="token operator">=</span> class_conf<span class="token punctuation">[</span>conf_mask<span class="token punctuation">]</span>
        class_pred <span class="token operator">=</span> class_pred<span class="token punctuation">[</span>conf_mask<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> image_pred<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token comment">#-------------------------------------------------------------------------#</span>
        <span class="token comment">#   detections  [num_anchors, 7]</span>
        <span class="token comment">#   7的内容为：x1, y1, x2, y2, obj_conf, class_conf, class_pred</span>
        <span class="token comment">#-------------------------------------------------------------------------#</span>
        detections <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>image_pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> class_conf<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> class_pred<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment">#------------------------------------------#</span>
        <span class="token comment">#   获得预测结果中包含的所有种类</span>
        <span class="token comment">#------------------------------------------#</span>
        unique_labels <span class="token operator">=</span> detections<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> prediction<span class="token punctuation">.</span>is_cuda<span class="token punctuation">:</span>
            unique_labels <span class="token operator">=</span> unique_labels<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            detections <span class="token operator">=</span> detections<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> c <span class="token keyword">in</span> unique_labels<span class="token punctuation">:</span>
            <span class="token comment">#------------------------------------------#</span>
            <span class="token comment">#   获得某一类得分筛选后全部的预测结果</span>
            <span class="token comment">#------------------------------------------#</span>
            detections_class <span class="token operator">=</span> detections<span class="token punctuation">[</span>detections<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> c<span class="token punctuation">]</span>

            <span class="token comment">#------------------------------------------#</span>
            <span class="token comment">#   使用官方自带的非极大抑制会速度更快一些！</span>
            <span class="token comment">#------------------------------------------#</span>
            keep <span class="token operator">=</span> nms<span class="token punctuation">(</span>
                detections_class<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                detections_class<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> detections_class<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                nms_thres
            <span class="token punctuation">)</span>
            max_detections <span class="token operator">=</span> detections_class<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>
            
            <span class="token comment"># # 按照存在物体的置信度排序</span>
            <span class="token comment"># _, conf_sort_index = torch.sort(detections_class[:, 4]*detections_class[:, 5], descending=True)</span>
            <span class="token comment"># detections_class = detections_class[conf_sort_index]</span>
            <span class="token comment"># # 进行非极大抑制</span>
            <span class="token comment"># max_detections = []</span>
            <span class="token comment"># while detections_class.size(0):</span>
            <span class="token comment">#     # 取出这一类置信度最高的，一步一步往下判断，判断重合程度是否大于nms_thres，如果是则去除掉</span>
            <span class="token comment">#     max_detections.append(detections_class[0].unsqueeze(0))</span>
            <span class="token comment">#     if len(detections_class) == 1:</span>
            <span class="token comment">#         break</span>
            <span class="token comment">#     ious = bbox_iou(max_detections[-1], detections_class[1:])</span>
            <span class="token comment">#     detections_class = detections_class[1:][ious &lt; nms_thres]</span>
            <span class="token comment"># # 堆叠</span>
            <span class="token comment"># max_detections = torch.cat(max_detections).data</span>
            
            <span class="token comment"># Add max detections to outputs</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> max_detections <span class="token keyword">if</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> max_detections<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span>           <span class="token operator">=</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            box_xy<span class="token punctuation">,</span> box_wh      <span class="token operator">=</span> <span class="token punctuation">(</span>output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">-</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>    <span class="token operator">=</span> self<span class="token punctuation">.</span>yolo_correct_boxes<span class="token punctuation">(</span>box_xy<span class="token punctuation">,</span> box_wh<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span> image_shape<span class="token punctuation">,</span> letterbox_image<span class="token punctuation">)</span>
    <span class="token keyword">return</span> output
</code></pre> 
<h2>
<a id="_686"></a>四、训练部分</h2> 
<h3>
<a id="1loss_687"></a>1、计算loss所需内容</h3> 
<p>计算loss实际上是网络的预测结果和网络的真实结果的对比。<br> 和网络的预测结果一样，网络的损失也由三个部分组成，分别是Reg部分、Obj部分、Cls部分。Reg部分是特征点的回归参数判断、Obj部分是特征点是否包含物体判断、Cls部分是特征点包含的物体的种类。</p> 
<h3>
<a id="2_690"></a>2、正样本的匹配过程</h3> 
<p>在YoloV5中，训练时正样本的匹配过程可以分为两部分。<br> a、匹配先验框。<br> b、匹配特征点。</p> 
<p>所谓<strong>正样本匹配</strong>，就是<strong>寻找哪些先验框被认为有对应的真实框，并且负责这个真实框的预测</strong>。</p> 
<h4>
<a id="a_696"></a>a、匹配先验框</h4> 
<p>在YoloV5网络中，一共设计了9个不同大小的先验框。每个输出的特征层对应3个先验框。</p> 
<p><strong>对于任何一个真实框gt，YoloV5不再使用iou进行正样本的匹配，而是直接采用高宽比进行匹配，即使用真实框和9个不同大小的先验框计算宽高比。</strong></p> 
<p><strong>如果真实框与某个先验框的宽高比例大于设定阈值，则说明该真实框和该先验框匹配度不够，将该先验框认为是负样本。</strong></p> 
<p>比如<strong>此时有一个真实框，它的宽高为[200, 200]，是一个正方形</strong>。YoloV5默认设置的<strong>9个先验框为[10,13], [16,30], [33,23], [30,61], [62,45], [59,119], [116,90], [156,198], [373,326]</strong>。设定<strong>阈值门限为4</strong>。</p> 
<p><strong>此时我们需要计算该真实框和9个先验框的宽高比例</strong>。比较宽高时存在两个情况，<strong>一个是真实框的宽高比先验框大，一个是先验框的宽高比真实框大</strong>。因此我们需要同时计算：真实框的宽高/先验框的宽高；先验框的宽高/真实框的宽高。然后在这其中选取最大值。</p> 
<p>下个列表就是比较结果，这是一个shape为[9, 4]的矩阵，9代表9个先验框，4代表真实框的宽高/先验框的宽高；先验框的宽高/真实框的宽高。</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">.</span>         <span class="token number">15.38461538</span>  <span class="token number">0.05</span>        <span class="token number">0.065</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">12.5</span>         <span class="token number">6.66666667</span>  <span class="token number">0.08</span>        <span class="token number">0.15</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">6.06060606</span>  <span class="token number">8.69565217</span>  <span class="token number">0.165</span>       <span class="token number">0.115</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">6.66666667</span>  <span class="token number">3.27868852</span>  <span class="token number">0.15</span>        <span class="token number">0.305</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">3.22580645</span>  <span class="token number">4.44444444</span>  <span class="token number">0.31</span>        <span class="token number">0.225</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">3.38983051</span>  <span class="token number">1.68067227</span>  <span class="token number">0.295</span>       <span class="token number">0.595</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">1.72413793</span>  <span class="token number">2.22222222</span>  <span class="token number">0.58</span>        <span class="token number">0.45</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">1.28205128</span>  <span class="token number">1.01010101</span>  <span class="token number">0.78</span>        <span class="token number">0.99</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">0.53619303</span>  <span class="token number">0.61349693</span>  <span class="token number">1.865</span>       <span class="token number">1.63</span>      <span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>然后对每个先验框的比较结果取最大值。获得下述矩阵：</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">.</span>         <span class="token number">12.5</span>         <span class="token number">8.69565217</span>  <span class="token number">6.66666667</span>  <span class="token number">4.44444444</span>  <span class="token number">3.38983051</span>
   <span class="token number">2.22222222</span>  <span class="token number">1.28205128</span>  <span class="token number">1.865</span>     <span class="token punctuation">]</span>
</code></pre> 
<p><strong>之后我们判断，哪些先验框的比较结果的值小于门限</strong>。可以知道[59,119], [116,90], [156,198], [373,326]四个先验框均满足需求。</p> 
<p><strong>[116,90], [156,198], [373,326]属于20,20的特征层。<br> [59,119]属于40,40的特征层。</strong></p> 
<p><strong>此时我们已经可以判断哪些大小的先验框可用于该真实框的预测。</strong></p> 
<h4>
<a id="b_730"></a>b、匹配特征点</h4> 
<p>在过去的Yolo系列中，每个真实框由其中心点所在的网格内的左上角特征点来负责预测。</p> 
<p>对于被选中的特征层，首先计算真实框落在哪个网格内，此时<strong>该网格左上角特征点便是一个负责预测的特征点。</strong></p> 
<p><strong>同时利用四舍五入规则，找出最近的两个网格，将这三个网格</strong>都认为是负责预测该真实框的。<br> <img src="https://images2.imgbox.com/cf/4c/1BTiTw6S_o.png" alt="在这里插入图片描述"><br> <strong>红色点表示该真实框的中心</strong>，除了当前所处的网格外，其2个最近的邻域网格也被选中。从这里就可以发现预测框的XY轴偏移部分的取值范围不再是0-1，而是0.5-1.5。</p> 
<p><strong>找到对应特征点后，对应特征点在a中被选中的先验框负责该真实框的预测。</strong></p> 
<h3>
<a id="3Loss_740"></a>3、计算Loss</h3> 
<p>由第一部分可知，YoloV5的损失由三个部分组成：<br> <strong>1、Reg部分，由第2部分可知道每个真实框对应的先验框，获取到每个框对应的先验框后，取出该先验框对应的预测框，利用真实框和预测框计算CIOU损失，作为Reg部分的Loss组成。<br> 2、Obj部分，由第2部分可知道每个真实框对应的先验框，所有真实框对应的先验框都是正样本，剩余的先验框均为负样本，根据正负样本和特征点的是否包含物体的预测结果计算交叉熵损失，作为Obj部分的Loss组成。<br> 3、Cls部分，由第三部分可知道每个真实框对应的先验框，获取到每个框对应的先验框后，取出该先验框的种类预测结果，根据真实框的种类和先验框的种类预测结果计算交叉熵损失，作为Cls部分的Loss组成。</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> math
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">class</span> <span class="token class-name">YOLOLoss</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span> cuda<span class="token punctuation">,</span> anchors_mask <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label_smoothing <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>YOLOLoss<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   13x13的特征层对应的anchor是[142, 110],[192, 243],[459, 401]</span>
        <span class="token comment">#   26x26的特征层对应的anchor是[36, 75],[76, 55],[72, 146]</span>
        <span class="token comment">#   52x52的特征层对应的anchor是[12, 16],[19, 36],[40, 28]</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        self<span class="token punctuation">.</span>anchors        <span class="token operator">=</span> anchors
        self<span class="token punctuation">.</span>num_classes    <span class="token operator">=</span> num_classes
        self<span class="token punctuation">.</span>bbox_attrs     <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">+</span> num_classes
        self<span class="token punctuation">.</span>input_shape    <span class="token operator">=</span> input_shape
        self<span class="token punctuation">.</span>anchors_mask   <span class="token operator">=</span> anchors_mask
        self<span class="token punctuation">.</span>label_smoothing <span class="token operator">=</span> label_smoothing

        self<span class="token punctuation">.</span>threshold      <span class="token operator">=</span> <span class="token number">4</span>

        self<span class="token punctuation">.</span>balance        <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>box_ratio      <span class="token operator">=</span> <span class="token number">5</span>
        self<span class="token punctuation">.</span>cls_ratio      <span class="token operator">=</span> <span class="token number">0.5</span>
        self<span class="token punctuation">.</span>obj_ratio      <span class="token operator">=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>cuda <span class="token operator">=</span> cuda

    <span class="token keyword">def</span> <span class="token function">clip_by_tensor</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> t<span class="token punctuation">,</span> t_min<span class="token punctuation">,</span> t_max<span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> <span class="token punctuation">(</span>t <span class="token operator">&gt;=</span> t_min<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> t <span class="token operator">+</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> t_min<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> t_min
        result <span class="token operator">=</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;=</span> t_max<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> result <span class="token operator">+</span> <span class="token punctuation">(</span>result <span class="token operator">&gt;</span> t_max<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> t_max
        <span class="token keyword">return</span> result

    <span class="token keyword">def</span> <span class="token function">MSELoss</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pred<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>pred <span class="token operator">-</span> target<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">BCELoss</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pred<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
        epsilon <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">7</span>
        pred    <span class="token operator">=</span> self<span class="token punctuation">.</span>clip_by_tensor<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> epsilon<span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">-</span> epsilon<span class="token punctuation">)</span>
        output  <span class="token operator">=</span> <span class="token operator">-</span> target <span class="token operator">*</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>pred<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> target<span class="token punctuation">)</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> pred<span class="token punctuation">)</span>
        <span class="token keyword">return</span> output
        
    <span class="token keyword">def</span> <span class="token function">box_giou</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        输入为：
        ----------
        b1: tensor, shape=(batch, feat_w, feat_h, anchor_num, 4), xywh
        b2: tensor, shape=(batch, feat_w, feat_h, anchor_num, 4), xywh

        返回为：
        -------
        giou: tensor, shape=(batch, feat_w, feat_h, anchor_num, 1)
        """</span>
        <span class="token comment">#----------------------------------------------------#</span>
        <span class="token comment">#   求出预测框左上角右下角</span>
        <span class="token comment">#----------------------------------------------------#</span>
        b1_xy       <span class="token operator">=</span> b1<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        b1_wh       <span class="token operator">=</span> b1<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        b1_wh_half  <span class="token operator">=</span> b1_wh<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">.</span>
        b1_mins     <span class="token operator">=</span> b1_xy <span class="token operator">-</span> b1_wh_half
        b1_maxes    <span class="token operator">=</span> b1_xy <span class="token operator">+</span> b1_wh_half
        <span class="token comment">#----------------------------------------------------#</span>
        <span class="token comment">#   求出真实框左上角右下角</span>
        <span class="token comment">#----------------------------------------------------#</span>
        b2_xy       <span class="token operator">=</span> b2<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        b2_wh       <span class="token operator">=</span> b2<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        b2_wh_half  <span class="token operator">=</span> b2_wh<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">.</span>
        b2_mins     <span class="token operator">=</span> b2_xy <span class="token operator">-</span> b2_wh_half
        b2_maxes    <span class="token operator">=</span> b2_xy <span class="token operator">+</span> b2_wh_half

        <span class="token comment">#----------------------------------------------------#</span>
        <span class="token comment">#   求真实框和预测框所有的iou</span>
        <span class="token comment">#----------------------------------------------------#</span>
        intersect_mins  <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>b1_mins<span class="token punctuation">,</span> b2_mins<span class="token punctuation">)</span>
        intersect_maxes <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>b1_maxes<span class="token punctuation">,</span> b2_maxes<span class="token punctuation">)</span>
        intersect_wh    <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>intersect_maxes <span class="token operator">-</span> intersect_mins<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>intersect_maxes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        intersect_area  <span class="token operator">=</span> intersect_wh<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> intersect_wh<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        b1_area         <span class="token operator">=</span> b1_wh<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> b1_wh<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        b2_area         <span class="token operator">=</span> b2_wh<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> b2_wh<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        union_area      <span class="token operator">=</span> b1_area <span class="token operator">+</span> b2_area <span class="token operator">-</span> intersect_area
        iou             <span class="token operator">=</span> intersect_area <span class="token operator">/</span> union_area

        <span class="token comment">#----------------------------------------------------#</span>
        <span class="token comment">#   找到包裹两个框的最小框的左上角和右下角</span>
        <span class="token comment">#----------------------------------------------------#</span>
        enclose_mins    <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>b1_mins<span class="token punctuation">,</span> b2_mins<span class="token punctuation">)</span>
        enclose_maxes   <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>b1_maxes<span class="token punctuation">,</span> b2_maxes<span class="token punctuation">)</span>
        enclose_wh      <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>enclose_maxes <span class="token operator">-</span> enclose_mins<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>intersect_maxes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">#----------------------------------------------------#</span>
        <span class="token comment">#   计算对角线距离</span>
        <span class="token comment">#----------------------------------------------------#</span>
        enclose_area    <span class="token operator">=</span> enclose_wh<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> enclose_wh<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        giou            <span class="token operator">=</span> iou <span class="token operator">-</span> <span class="token punctuation">(</span>enclose_area <span class="token operator">-</span> union_area<span class="token punctuation">)</span> <span class="token operator">/</span> enclose_area
        
        <span class="token keyword">return</span> giou

    <span class="token comment">#---------------------------------------------------#</span>
    <span class="token comment">#   平滑标签</span>
    <span class="token comment">#---------------------------------------------------#</span>
    <span class="token keyword">def</span> <span class="token function">smooth_labels</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> y_true<span class="token punctuation">,</span> label_smoothing<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> y_true <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> label_smoothing<span class="token punctuation">)</span> <span class="token operator">+</span> label_smoothing <span class="token operator">/</span> num_classes

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> l<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">,</span> targets<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#----------------------------------------------------#</span>
        <span class="token comment">#   l 代表使用的是第几个有效特征层</span>
        <span class="token comment">#   input的shape为  bs, 3*(5+num_classes), 13, 13</span>
        <span class="token comment">#                   bs, 3*(5+num_classes), 26, 26</span>
        <span class="token comment">#                   bs, 3*(5+num_classes), 52, 52</span>
        <span class="token comment">#   targets 真实框的标签情况 [batch_size, num_gt, 5]</span>
        <span class="token comment">#----------------------------------------------------#</span>
        <span class="token comment">#--------------------------------#</span>
        <span class="token comment">#   获得图片数量，特征层的高和宽</span>
        <span class="token comment">#--------------------------------#</span>
        bs      <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        in_h    <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        in_w    <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------------------------------#</span>
        <span class="token comment">#   计算步长</span>
        <span class="token comment">#   每一个特征点对应原来的图片上多少个像素点</span>
        <span class="token comment">#   </span>
        <span class="token comment">#   如果特征层为13x13的话，一个特征点就对应原来的图片上的32个像素点</span>
        <span class="token comment">#   如果特征层为26x26的话，一个特征点就对应原来的图片上的16个像素点</span>
        <span class="token comment">#   如果特征层为52x52的话，一个特征点就对应原来的图片上的8个像素点</span>
        <span class="token comment">#   stride_h = stride_w = 32、16、8</span>
        <span class="token comment">#-----------------------------------------------------------------------#</span>
        stride_h <span class="token operator">=</span> self<span class="token punctuation">.</span>input_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> in_h
        stride_w <span class="token operator">=</span> self<span class="token punctuation">.</span>input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> in_w
        <span class="token comment">#-------------------------------------------------#</span>
        <span class="token comment">#   此时获得的scaled_anchors大小是相对于特征层的</span>
        <span class="token comment">#-------------------------------------------------#</span>
        scaled_anchors  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>a_w <span class="token operator">/</span> stride_w<span class="token punctuation">,</span> a_h <span class="token operator">/</span> stride_h<span class="token punctuation">)</span> <span class="token keyword">for</span> a_w<span class="token punctuation">,</span> a_h <span class="token keyword">in</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">]</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   输入的input一共有三个，他们的shape分别是</span>
        <span class="token comment">#   bs, 3 * (5+num_classes), 13, 13 =&gt; bs, 3, 5 + num_classes, 13, 13 =&gt; batch_size, 3, 13, 13, 5 + num_classes</span>

        <span class="token comment">#   batch_size, 3, 13, 13, 5 + num_classes</span>
        <span class="token comment">#   batch_size, 3, 26, 26, 5 + num_classes</span>
        <span class="token comment">#   batch_size, 3, 52, 52, 5 + num_classes</span>
        <span class="token comment">#-----------------------------------------------#</span>
        prediction <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>bbox_attrs<span class="token punctuation">,</span> in_h<span class="token punctuation">,</span> in_w<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   先验框的中心位置的调整参数</span>
        <span class="token comment">#-----------------------------------------------#</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        y <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   先验框的宽高调整参数</span>
        <span class="token comment">#-----------------------------------------------#</span>
        w <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
        h <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   获得置信度，是否有物体</span>
        <span class="token comment">#-----------------------------------------------#</span>
        conf <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   种类置信度</span>
        <span class="token comment">#-----------------------------------------------#</span>
        pred_cls <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prediction<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------#</span>
        <span class="token comment">#   获得网络应该有的预测结果</span>
        <span class="token comment">#-----------------------------------------------#</span>
        y_true<span class="token punctuation">,</span> noobj_mask<span class="token punctuation">,</span> box_loss_scale <span class="token operator">=</span> self<span class="token punctuation">.</span>get_target<span class="token punctuation">(</span>l<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> scaled_anchors<span class="token punctuation">,</span> in_h<span class="token punctuation">,</span> in_w<span class="token punctuation">)</span>

        <span class="token comment">#---------------------------------------------------------------#</span>
        <span class="token comment">#   将预测结果进行解码，判断预测结果和真实值的重合程度</span>
        <span class="token comment">#   如果重合程度过大则忽略，因为这些特征点属于预测比较准确的特征点</span>
        <span class="token comment">#   作为负样本不合适</span>
        <span class="token comment">#----------------------------------------------------------------#</span>
        pred_boxes <span class="token operator">=</span> self<span class="token punctuation">.</span>get_pred_boxes<span class="token punctuation">(</span>l<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> scaled_anchors<span class="token punctuation">,</span> in_h<span class="token punctuation">,</span> in_w<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>cuda<span class="token punctuation">:</span>
            y_true          <span class="token operator">=</span> y_true<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            noobj_mask      <span class="token operator">=</span> noobj_mask<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
            box_loss_scale  <span class="token operator">=</span> box_loss_scale<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   reshape_y_true[...,2:3]和reshape_y_true[...,3:4]</span>
        <span class="token comment">#   表示真实框的宽高，二者均在0-1之间</span>
        <span class="token comment">#   真实框越大，比重越小，小框的比重更大。</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        box_loss_scale <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">-</span> box_loss_scale

        <span class="token comment">#---------------------------------------------------------------#</span>
        <span class="token comment">#   计算预测结果和真实结果的giou</span>
        <span class="token comment">#----------------------------------------------------------------#</span>
        giou        <span class="token operator">=</span> self<span class="token punctuation">.</span>box_giou<span class="token punctuation">(</span>pred_boxes<span class="token punctuation">[</span>y_true<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y_true<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>y_true<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        loss_loc    <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> giou<span class="token punctuation">)</span> <span class="token operator">*</span> box_loss_scale<span class="token punctuation">[</span>y_true<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   计算置信度的loss</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        loss_conf   <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span>conf<span class="token punctuation">[</span>y_true<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> giou<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
                      torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> y_true<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> noobj_mask<span class="token punctuation">)</span>
        loss_cls    <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span>pred_cls<span class="token punctuation">[</span>y_true<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>smooth_labels<span class="token punctuation">(</span>y_true<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">[</span>y_true<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>label_smoothing<span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        loss        <span class="token operator">=</span> loss_loc <span class="token operator">*</span> self<span class="token punctuation">.</span>box_ratio <span class="token operator">+</span> loss_conf <span class="token operator">*</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>l<span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>obj_ratio <span class="token operator">+</span> loss_cls <span class="token operator">*</span> self<span class="token punctuation">.</span>cls_ratio
        num_pos <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>y_true<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        num_pos <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>num_pos<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>num_pos<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> loss<span class="token punctuation">,</span> num_pos
    
    <span class="token keyword">def</span> <span class="token function">get_near_points</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sub_x <span class="token operator">=</span> x <span class="token operator">-</span> i
        sub_y <span class="token operator">=</span> y <span class="token operator">-</span> j
        <span class="token keyword">if</span> sub_x <span class="token operator">&gt;</span> <span class="token number">0.5</span> <span class="token keyword">and</span> sub_y <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span> sub_x <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token keyword">and</span> sub_y <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span> sub_x <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token keyword">and</span> sub_y <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">get_target</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> l<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> in_h<span class="token punctuation">,</span> in_w<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        <span class="token comment">#   计算一共有多少张图片</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        bs              <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        <span class="token comment">#   用于选取哪些先验框不包含物体</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        noobj_mask      <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_h<span class="token punctuation">,</span> in_w<span class="token punctuation">,</span> requires_grad <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        <span class="token comment">#   让网络更加去关注小目标</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        box_loss_scale  <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_h<span class="token punctuation">,</span> in_w<span class="token punctuation">,</span> requires_grad <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        <span class="token comment">#   anchors_best_ratio</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        box_best_ratio <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_h<span class="token punctuation">,</span> in_w<span class="token punctuation">,</span> requires_grad <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        <span class="token comment">#   batch_size, 3, 13, 13, 5 + num_classes</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        y_true          <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_h<span class="token punctuation">,</span> in_w<span class="token punctuation">,</span> self<span class="token punctuation">.</span>bbox_attrs<span class="token punctuation">,</span> requires_grad <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> b <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">:</span>            
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>targets<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            batch_target <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>targets<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment">#-------------------------------------------------------#</span>
            <span class="token comment">#   计算出正样本在特征层上的中心点</span>
            <span class="token comment">#-------------------------------------------------------#</span>
            batch_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> targets<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> in_w
            batch_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> targets<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> in_h
            batch_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> targets<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
            batch_target <span class="token operator">=</span> batch_target<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment">#-------------------------------------------------------#</span>
            <span class="token comment">#   batch_target            : num_true_box, 4</span>
            <span class="token comment">#   anchors                 : 9, 2</span>
            <span class="token comment">#</span>
            <span class="token comment">#   ratios_of_gt_anchors    : num_true_box, 9, 2</span>
            <span class="token comment">#   ratios_of_anchors_gt    : num_true_box, 9, 2</span>
            <span class="token comment">#</span>
            <span class="token comment">#   ratios                  : num_true_box, 9, 4</span>
            <span class="token comment">#   max_ratios              : num_true_box, 9</span>
            <span class="token comment">#-------------------------------------------------------#</span>
            ratios_of_gt_anchors <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>batch_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>anchors<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            ratios_of_anchors_gt <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>anchors<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span>  torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>batch_target<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            ratios               <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>ratios_of_gt_anchors<span class="token punctuation">,</span> ratios_of_anchors_gt<span class="token punctuation">]</span><span class="token punctuation">,</span> dim <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            max_ratios<span class="token punctuation">,</span> _        <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>ratios<span class="token punctuation">,</span> dim <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

            <span class="token keyword">for</span> t<span class="token punctuation">,</span> ratio <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>max_ratios<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment">#-------------------------------------------------------#</span>
                <span class="token comment">#   ratio : 9</span>
                <span class="token comment">#-------------------------------------------------------#</span>
                over_threshold <span class="token operator">=</span> ratio <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>threshold
                over_threshold<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>argmin<span class="token punctuation">(</span>ratio<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
                <span class="token keyword">for</span> k<span class="token punctuation">,</span> mask <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> over_threshold<span class="token punctuation">[</span>mask<span class="token punctuation">]</span><span class="token punctuation">:</span>
                        <span class="token keyword">continue</span>
                    <span class="token comment">#----------------------------------------#</span>
                    <span class="token comment">#   获得真实框属于哪个网格点</span>
                    <span class="token comment">#----------------------------------------#</span>
                    i <span class="token operator">=</span> torch<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    j <span class="token operator">=</span> torch<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    
                    offsets <span class="token operator">=</span> self<span class="token punctuation">.</span>get_near_points<span class="token punctuation">(</span>batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>
                    <span class="token keyword">for</span> offset <span class="token keyword">in</span> offsets<span class="token punctuation">:</span>
                        local_i <span class="token operator">=</span> i <span class="token operator">+</span> offset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                        local_j <span class="token operator">=</span> j <span class="token operator">+</span> offset<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

                        <span class="token keyword">if</span> local_i <span class="token operator">&gt;=</span> in_w <span class="token keyword">or</span> local_i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> local_j <span class="token operator">&gt;=</span> in_h <span class="token keyword">or</span> local_j <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                            <span class="token keyword">continue</span>

                        <span class="token keyword">if</span> box_best_ratio<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                            <span class="token keyword">if</span> box_best_ratio<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> ratio<span class="token punctuation">[</span>mask<span class="token punctuation">]</span><span class="token punctuation">:</span>
                                y_true<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
                            <span class="token keyword">else</span><span class="token punctuation">:</span>
                                <span class="token keyword">continue</span>
                            
                        <span class="token comment">#----------------------------------------#</span>
                        <span class="token comment">#   取出真实框的种类</span>
                        <span class="token comment">#----------------------------------------#</span>
                        c <span class="token operator">=</span> batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                        <span class="token comment">#----------------------------------------#</span>
                        <span class="token comment">#   noobj_mask代表无目标的特征点</span>
                        <span class="token comment">#----------------------------------------#</span>
                        noobj_mask<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
                        <span class="token comment">#----------------------------------------#</span>
                        <span class="token comment">#   tx、ty代表中心调整参数的真实值</span>
                        <span class="token comment">#----------------------------------------#</span>
                        y_true<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
                        y_true<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
                        y_true<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
                        y_true<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
                        y_true<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
                        y_true<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">,</span> c <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
                        <span class="token comment">#----------------------------------------#</span>
                        <span class="token comment">#   用于获得xywh的比例</span>
                        <span class="token comment">#   大目标loss权重小，小目标loss权重大</span>
                        <span class="token comment">#----------------------------------------#</span>
                        box_loss_scale<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">]</span> <span class="token operator">=</span> batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> batch_target<span class="token punctuation">[</span>t<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> in_w <span class="token operator">/</span> in_h
                        <span class="token comment">#----------------------------------------#</span>
                        <span class="token comment">#   获得当前先验框最好的比例</span>
                        <span class="token comment">#----------------------------------------#</span>
                        box_best_ratio<span class="token punctuation">[</span>b<span class="token punctuation">,</span> k<span class="token punctuation">,</span> local_j<span class="token punctuation">,</span> local_i<span class="token punctuation">]</span> <span class="token operator">=</span> ratio<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
                        
        <span class="token keyword">return</span> y_true<span class="token punctuation">,</span> noobj_mask<span class="token punctuation">,</span> box_loss_scale

    <span class="token keyword">def</span> <span class="token function">get_pred_boxes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> l<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> scaled_anchors<span class="token punctuation">,</span> in_h<span class="token punctuation">,</span> in_w<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        <span class="token comment">#   计算一共有多少张图片</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        bs <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span>

        FloatTensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>FloatTensor <span class="token keyword">if</span> x<span class="token punctuation">.</span>is_cuda <span class="token keyword">else</span> torch<span class="token punctuation">.</span>FloatTensor
        LongTensor  <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>LongTensor <span class="token keyword">if</span> x<span class="token punctuation">.</span>is_cuda <span class="token keyword">else</span> torch<span class="token punctuation">.</span>LongTensor
        <span class="token comment">#-----------------------------------------------------#</span>
        <span class="token comment">#   生成网格，先验框中心，网格左上角</span>
        <span class="token comment">#-----------------------------------------------------#</span>
        grid_x <span class="token operator">=</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> in_w <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> in_w<span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>in_h<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>
            <span class="token builtin">int</span><span class="token punctuation">(</span>bs <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>FloatTensor<span class="token punctuation">)</span>
        grid_y <span class="token operator">=</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> in_h <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> in_h<span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>in_w<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>
            <span class="token builtin">int</span><span class="token punctuation">(</span>bs <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>y<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>FloatTensor<span class="token punctuation">)</span>

        <span class="token comment"># 生成先验框的宽高</span>
        scaled_anchors_l <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>scaled_anchors<span class="token punctuation">)</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>anchors_mask<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">]</span>
        anchor_w <span class="token operator">=</span> FloatTensor<span class="token punctuation">(</span>scaled_anchors_l<span class="token punctuation">)</span><span class="token punctuation">.</span>index_select<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> LongTensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        anchor_h <span class="token operator">=</span> FloatTensor<span class="token punctuation">(</span>scaled_anchors_l<span class="token punctuation">)</span><span class="token punctuation">.</span>index_select<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> LongTensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        anchor_w <span class="token operator">=</span> anchor_w<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> in_h <span class="token operator">*</span> in_w<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>w<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        anchor_h <span class="token operator">=</span> anchor_h<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> in_h <span class="token operator">*</span> in_w<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>h<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        <span class="token comment">#-------------------------------------------------------#</span>
        <span class="token comment">#   计算调整后的先验框中心与宽高</span>
        <span class="token comment">#-------------------------------------------------------#</span>
        pred_boxes_x    <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid_x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        pred_boxes_y    <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>y <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">.</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid_y<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        pred_boxes_w    <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token punctuation">(</span>w <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchor_w<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        pred_boxes_h    <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchor_h<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        pred_boxes      <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>pred_boxes_x<span class="token punctuation">,</span> pred_boxes_y<span class="token punctuation">,</span> pred_boxes_w<span class="token punctuation">,</span> pred_boxes_h<span class="token punctuation">]</span><span class="token punctuation">,</span> dim <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> pred_boxes
</code></pre> 
<h1>
<a id="YoloV5_1099"></a>训练自己的YoloV5模型</h1> 
<p><strong>首先前往Github下载对应的仓库，下载完后利用解压软件解压，之后用编程软件打开文件夹。<br> 注意打开的根目录必须正确，否则相对目录不正确的情况下，代码将无法运行。</strong><br> 一定要注意打开后的根目录是文件存放的目录。<br> <img src="https://images2.imgbox.com/13/f7/mJ7IWolr_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="_1104"></a>一、数据集的准备</h2> 
<p><strong>本文使用VOC格式进行训练，训练前需要自己制作好数据集，如果没有自己的数据集，可以通过Github连接下载VOC12+07的数据集尝试下。</strong><br> 训练前将标签文件放在VOCdevkit文件夹下的VOC2007文件夹下的Annotation中。<br> <img src="https://images2.imgbox.com/3a/6e/As7x7SmT_o.png" alt="在这里插入图片描述"><br> 训练前将图片文件放在VOCdevkit文件夹下的VOC2007文件夹下的JPEGImages中。<br> <img src="https://images2.imgbox.com/cb/4b/UADhpvMJ_o.png" alt="在这里插入图片描述"><br> 此时数据集的摆放已经结束。</p> 
<h2>
<a id="_1111"></a>二、数据集的处理</h2> 
<p>在完成数据集的摆放之后，我们需要对数据集进行下一步的处理，目的是获得训练用的2007_train.txt以及2007_val.txt，需要用到根目录下的voc_annotation.py。</p> 
<p>voc_annotation.py里面有一些参数需要设置。<br> 分别是annotation_mode、classes_path、trainval_percent、train_percent、VOCdevkit_path，第一次训练可以仅修改classes_path</p> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''
annotation_mode用于指定该文件运行时计算的内容
annotation_mode为0代表整个标签处理过程，包括获得VOCdevkit/VOC2007/ImageSets里面的txt以及训练用的2007_train.txt、2007_val.txt
annotation_mode为1代表获得VOCdevkit/VOC2007/ImageSets里面的txt
annotation_mode为2代表获得训练用的2007_train.txt、2007_val.txt
'''</span>
annotation_mode     <span class="token operator">=</span> <span class="token number">0</span>
<span class="token triple-quoted-string string">'''
必须要修改，用于生成2007_train.txt、2007_val.txt的目标信息
与训练和预测所用的classes_path一致即可
如果生成的2007_train.txt里面没有目标信息
那么就是因为classes没有设定正确
仅在annotation_mode为0和2的时候有效
'''</span>
classes_path        <span class="token operator">=</span> <span class="token string">'model_data/voc_classes.txt'</span>
<span class="token triple-quoted-string string">'''
trainval_percent用于指定(训练集+验证集)与测试集的比例，默认情况下 (训练集+验证集):测试集 = 9:1
train_percent用于指定(训练集+验证集)中训练集与验证集的比例，默认情况下 训练集:验证集 = 9:1
仅在annotation_mode为0和1的时候有效
'''</span>
trainval_percent    <span class="token operator">=</span> <span class="token number">0.9</span>
train_percent       <span class="token operator">=</span> <span class="token number">0.9</span>
<span class="token triple-quoted-string string">'''
指向VOC数据集所在的文件夹
默认指向根目录下的VOC数据集
'''</span>
VOCdevkit_path  <span class="token operator">=</span> <span class="token string">'VOCdevkit'</span>
</code></pre> 
<p>classes_path用于指向检测类别所对应的txt，以voc数据集为例，我们用的txt为：<br> <img src="https://images2.imgbox.com/8f/3b/qCQqeW53_o.png" alt="在这里插入图片描述"><br> 训练自己的数据集时，可以自己建立一个cls_classes.txt，里面写自己所需要区分的类别。</p> 
<h2>
<a id="_1148"></a>三、开始网络训练</h2> 
<p><strong>通过voc_annotation.py我们已经生成了2007_train.txt以及2007_val.txt，此时我们可以开始训练了。<br> 训练的参数较多，大家可以在下载库后仔细看注释，其中最重要的部分依然是train.py里的classes_path。</strong></p> 
<p><strong>classes_path用于指向检测类别所对应的txt，这个txt和voc_annotation.py里面的txt一样！训练自己的数据集必须要修改！</strong><br> <img src="https://images2.imgbox.com/e7/c8/13LawXsv_o.png" alt="在这里插入图片描述"><br> 修改完classes_path后就可以运行train.py开始训练了，在训练多个epoch后，权值会生成在logs文件夹中。<br> 其它参数的作用如下：</p> 
<pre><code class="prism language-python"><span class="token comment">#-------------------------------#</span>
<span class="token comment">#   是否使用Cuda</span>
<span class="token comment">#   没有GPU可以设置成False</span>
<span class="token comment">#-------------------------------#</span>
Cuda <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token comment">#--------------------------------------------------------#</span>
<span class="token comment">#   训练前一定要修改classes_path，使其对应自己的数据集</span>
<span class="token comment">#--------------------------------------------------------#</span>
classes_path    <span class="token operator">=</span> <span class="token string">'model_data/voc_classes.txt'</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
<span class="token comment">#   anchors_path代表先验框对应的txt文件，一般不修改。</span>
<span class="token comment">#   anchors_mask用于帮助代码找到对应的先验框，一般不修改。</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
anchors_path    <span class="token operator">=</span> <span class="token string">'model_data/yolo_anchors.txt'</span>
anchors_mask    <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
<span class="token comment">#   权值文件的下载请看README，可以通过网盘下载。模型的 预训练权重 对不同数据集是通用的，因为特征是通用的。</span>
<span class="token comment">#   模型的 预训练权重 比较重要的部分是 主干特征提取网络的权值部分，用于进行特征提取。</span>
<span class="token comment">#   预训练权重对于99%的情况都必须要用，不用的话主干部分的权值太过随机，特征提取效果不明显，网络训练的结果也不会好</span>
<span class="token comment">#</span>
<span class="token comment">#   如果训练过程中存在中断训练的操作，可以将model_path设置成logs文件夹下的权值文件，将已经训练了一部分的权值再次载入。</span>
<span class="token comment">#   同时修改下方的 冻结阶段 或者 解冻阶段 的参数，来保证模型epoch的连续性。</span>
<span class="token comment">#   </span>
<span class="token comment">#   当model_path = ''的时候不加载整个模型的权值。</span>
<span class="token comment">#</span>
<span class="token comment">#   此处使用的是整个模型的权重，因此是在train.py进行加载的。</span>
<span class="token comment">#   如果想要让模型从0开始训练，则设置model_path = ''，下面的Freeze_Train = Fasle，此时从0开始训练，且没有冻结主干的过程。</span>
<span class="token comment">#   一般来讲，从0开始训练效果会很差，因为权值太过随机，特征提取效果不明显。</span>
<span class="token comment">#</span>
<span class="token comment">#   网络一般不从0开始训练，至少会使用主干部分的权值，有些论文提到可以不用预训练，主要原因是他们 数据集较大 且 调参能力优秀。</span>
<span class="token comment">#   如果一定要训练网络的主干部分，可以了解imagenet数据集，首先训练分类模型，分类模型的 主干部分 和该模型通用，基于此进行训练。</span>
<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
model_path      <span class="token operator">=</span> <span class="token string">'model_data/yolov5_s.pth'</span>
<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   输入的shape大小，一定要是32的倍数</span>
<span class="token comment">#------------------------------------------------------#</span>
input_shape     <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">]</span>
<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   所使用的YoloV5的版本。s、m、l、x</span>
<span class="token comment">#------------------------------------------------------#</span>
phi             <span class="token operator">=</span> <span class="token string">'s'</span>
<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   Yolov4的tricks应用</span>
<span class="token comment">#   mosaic 马赛克数据增强 True or False </span>
<span class="token comment">#   实际测试时mosaic数据增强并不稳定，所以默认为False</span>
<span class="token comment">#   Cosine_lr 余弦退火学习率 True or False</span>
<span class="token comment">#   label_smoothing 标签平滑 0.01以下一般 如0.01、0.005</span>
<span class="token comment">#------------------------------------------------------#</span>
mosaic              <span class="token operator">=</span> <span class="token boolean">False</span>
Cosine_lr           <span class="token operator">=</span> <span class="token boolean">False</span>
label_smoothing     <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment">#----------------------------------------------------#</span>
<span class="token comment">#   训练分为两个阶段，分别是冻结阶段和解冻阶段。</span>
<span class="token comment">#   显存不足与数据集大小无关，提示显存不足请调小batch_size。</span>
<span class="token comment">#   受到BatchNorm层影响，batch_size最小为2，不能为1。</span>
<span class="token comment">#----------------------------------------------------#</span>
<span class="token comment">#----------------------------------------------------#</span>
<span class="token comment">#   冻结阶段训练参数</span>
<span class="token comment">#   此时模型的主干被冻结了，特征提取网络不发生改变</span>
<span class="token comment">#   占用的显存较小，仅对网络进行微调</span>
<span class="token comment">#----------------------------------------------------#</span>
Init_Epoch          <span class="token operator">=</span> <span class="token number">0</span>
Freeze_Epoch        <span class="token operator">=</span> <span class="token number">50</span>
Freeze_batch_size   <span class="token operator">=</span> <span class="token number">16</span>
Freeze_lr           <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span>
<span class="token comment">#----------------------------------------------------#</span>
<span class="token comment">#   解冻阶段训练参数</span>
<span class="token comment">#   此时模型的主干不被冻结了，特征提取网络会发生改变</span>
<span class="token comment">#   占用的显存较大，网络所有的参数都会发生改变</span>
<span class="token comment">#----------------------------------------------------#</span>
UnFreeze_Epoch      <span class="token operator">=</span> <span class="token number">100</span>
Unfreeze_batch_size <span class="token operator">=</span> <span class="token number">8</span>
Unfreeze_lr         <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span>
<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   是否进行冻结训练，默认先冻结主干训练后解冻训练。</span>
<span class="token comment">#------------------------------------------------------#</span>
Freeze_Train        <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   用于设置是否使用多线程读取数据</span>
<span class="token comment">#   开启后会加快数据读取速度，但是会占用更多内存</span>
<span class="token comment">#   内存较小的电脑可以设置为2或者0  </span>
<span class="token comment">#------------------------------------------------------#</span>
num_workers         <span class="token operator">=</span> <span class="token number">4</span>
<span class="token comment">#----------------------------------------------------#</span>
<span class="token comment">#   获得图片路径和标签</span>
<span class="token comment">#----------------------------------------------------#</span>
train_annotation_path   <span class="token operator">=</span> <span class="token string">'2007_train.txt'</span>
val_annotation_path     <span class="token operator">=</span> <span class="token string">'2007_val.txt'</span>
</code></pre> 
<h2>
<a id="_1247"></a>四、训练结果预测</h2> 
<p>训练结果预测需要用到两个文件，分别是yolo.py和predict.py。<br> 我们首先需要去yolo.py里面修改model_path以及classes_path，这两个参数必须要修改。</p> 
<p><strong>model_path指向训练好的权值文件，在logs文件夹里。<br> classes_path指向检测类别所对应的txt。</strong><br> <img src="https://images2.imgbox.com/21/90/72IX3pC3_o.png" alt="在这里插入图片描述"><br> 完成修改后就可以运行predict.py进行检测了。运行后输入图片路径即可检测。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>