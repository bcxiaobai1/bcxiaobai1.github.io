<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>基于涂鸦智能开发的墨水屏座位管理器——2.嵌入式功能实现篇 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于涂鸦智能开发的墨水屏座位管理器——2.嵌入式功能实现篇</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <p>随着互联网连接技术的日益普及，以及大众环保意识增强，电子纸显示市场不断发展，墨水屏的应用场景也越来越多。墨水屏座位管理器方案具体功耗低，多节点管控，信息实时同步等特点，可应用于智慧办公，智慧零售，智慧商超等众多场景。</p> 
<p>上篇给大家介绍硬件方案搭建<a href="https://blog.csdn.net/sandwich_iot/article/details/121247840?spm=1001.2014.3001.5501"><strong>墨水屏座位管理器-电路设计篇</strong></a>本篇将会从方案设计及功能实现等维度带大家了解墨水屏座位管理器嵌入式方案。</p> 
<h2>
<a id="_5"></a>一、平台产品创建</h2> 
<h3>
<a id="1_7"></a>1.创建产品</h3> 
<p>硬件部分搭建完成后可登录<a href="https://iot.tuya.com/?_source=775d871a6075fbb6de723a34ffeed00b"><strong>涂鸦IoT平台</strong></a>创建产品，下面是创建墨水屏demo的流程步骤。</p> 
<ul>
<li> <p>登录<a href="https://iot.tuya.com/?_source=775d871a6075fbb6de723a34ffeed00b"><strong>涂鸦IoT平台</strong></a>,单击<strong>创建产品</strong></p> </li>
<li> <p>在标准类目导航栏中，选择<strong>电工</strong> &gt;<strong>智能开关</strong> &gt;<strong>开关</strong></p> </li>
</ul> 
<img src="https://images2.imgbox.com/8f/02/0GxnWUKw_o.jpg" alt="9F71.tmp.jpg"> 
<ul><li>选择<strong>自定义方案</strong>，<strong>输入产品名称</strong>如墨水屏demo，可选择zigbee或蓝牙通讯协议，本方案以zigbee方案，单击<strong>创建产品</strong>
</li></ul> 
<p><img src="https://images2.imgbox.com/f5/8d/ikD071yO_o.png" alt="9F72.tmp.jpg"></p> 
<img src="https://images2.imgbox.com/33/f0/92lmta7q_o.jpg" alt="9F73.tmp.jpg"> 
<ul>
<li> <p>（可选）在功能定义选项中，可以先选择一项标准功能开关，方便后续调试。<br> <img src="https://images2.imgbox.com/4e/be/QikTFu9Q_o.png" alt="9F74.tmp.jpg"></p> </li>
<li> <p>（必选）在自定义功能区域单击添加功能，<br> 例如本次方案需要添加五个 DP 点，按照如下类别依次新建5个自定义功能点。</p> </li>
</ul> 
<p><img src="https://images2.imgbox.com/54/9c/f6VXb1hU_o.png" alt="9F75.tmp.jpg"></p> 
<ul>
<li> <p>在设备面板页面中选择想要的面板，开始调试时可选择开发调试面板，后面可根据自身需要自由配置面板。<br> <img src="https://images2.imgbox.com/51/14/Vj9rJ20t_o.png" alt="9F76.tmp.jpg"></p> </li>
<li> <p>在硬件开发页面中，开发者根据需求选择对应zigbee模组或蓝牙模组， 需注意的是要选择低功耗固件，否则会对设备功耗有很大影响。</p> </li>
</ul> 
<img src="https://images2.imgbox.com/10/eb/BeGxYa27_o.png" alt="ZTU"> 
<ul><li>上述操作完成之后，单击<strong>下载全部</strong>下载所有开发需要用到的资料，如MCU SDK、模组调试助手和和功能点调试文件等，接下来就可以开始嵌入式程序的开发。</li></ul> 
<p><img src="https://images2.imgbox.com/3e/76/4MGjiHW9_o.png" alt="9F78.tmp.jpg"></p> 
<h3>
<a id="2_45"></a>2.环境搭建</h3> 
<p>本次方案采用涂鸦MCU SDK+Zigbee模组的设计来进行开发，下面是搭建开发环境的流程步骤。</p> 
<ul>
<li> <p>ST开发环境安装</p> <p>官方下载并安装keil，完成后开始搭建开发工程。</p> </li>
<li> <p>MCU SDK获取</p> <p>在<a href="https://iot.tuya.com/?_source=775d871a6075fbb6de723a34ffeed00b">IoT平台</a>创建完产品后就可以获取到MCU SDK软件包了，将MCU SDK添加到开发工程中，单击 Build 并根据软件提示修改相关错误或者警告信息。</p> <p>移植了MCU-SDK后，再搭配一块烧录并授权了通用对接低功耗固件的zigbee或蓝牙模组，此时 MCU 就具备了连接涂鸦云和上报下发DP点的功能。</p> <p>待程序编译通过之后，就可以下载到开发板中进行调试和测试。开发者可以先使用开发包中的串口调试助手分别模拟MCU和模拟模组来验证二者是否正常工作或通信。调试模组助手使用方法可以参考下面文档。</p> <p><a href="https://developer.tuya.com/cn/docs/iot/module-debugging-assistant-instruction?id=K9hs0cj3lf0au">调试模组助手</a></p> <p>STM32 支持 ST-Link ，J-Link 等工具下载，这里推荐 ST-Link，引脚连接方式如下：<br> <img src="https://images2.imgbox.com/8d/a9/TnzsCVXU_o.png" alt="9F89.tmp.jpg"></p> </li>
</ul> 
<h2>
<a id="_66"></a>二、固件开发</h2> 
<p>完成上述步骤后正式开始墨水屏demo的应用功能开发。</p> 
<h3>
<a id="1_70"></a>1.方案设计</h3> 
<ul><li> <h4>
<a id="_72"></a>功能需求</h4> </li></ul> 
<table>
<thead><tr>
<th align="center">功能描述</th>
<th align="center">详细说明</th>
</tr></thead>
<tbody>
<tr>
<td align="center">屏幕显示</td>
<td align="center">1.座位号 2.座位状态 3.提醒信息 4.二维码</td>
</tr>
<tr>
<td align="center">复位按键</td>
<td align="center">长按3秒，设备重新配网</td>
</tr>
<tr>
<td align="center">信息下发</td>
<td align="center">正常：预定/无预定 异常：“暂不开放”</td>
</tr>
<tr>
<td align="center">预约信息记录</td>
<td align="center">后台记录近30天座位占用信息</td>
</tr>
<tr>
<td align="center">低电量报警</td>
<td align="center">设备电池电量低于10%上报至管理端（云端）</td>
</tr>
</tbody>
</table>
<ul><li> <h4>
<a id="_82"></a>流程逻辑</h4> </li></ul> 
<p><img src="https://images2.imgbox.com/f5/87/o5EK7uHM_o.png" alt="lc"></p> 
<ul><li> <h4>
<a id="_86"></a>工程目录结构</h4> </li></ul> 
<pre><code>├── User
│   ├── main.c                                             /* 主程序入口文件 */
│   └── MY_ST_config.h                                     /* 硬件配置文件 */
├── system                                                 /* 系统文件目录 */
│   ├── delay.c                                            /* 延时函数 */
│   ├── delay.h
│   ├── EPAPER.c                                           /* 电子屏幕初始化 */
│   ├── EPAPER.h
│   ├── GT5SLAD3BFA_stm32l431_keil5.lib                    /* 字库芯片静态库文件 */
│   ├── GT5SLAD3B-GTA6401.h                                /* 字库芯片头文件 */
│   ├── IO.c                                               /* GPIO口初始化 */
│   ├── IO.h
│   ├── key.c                                              /* 按键初始化 */
│   ├── key.h
│   ├── picture.h                                          /* 图片像素数据存储 */
│   ├── RCC.c                                              /* 系统时钟配置 */
│   ├── RCC.h
│   ├── SPI.c                                              /* SPI初始化 */
│   ├── SPI.h
│   ├── sys.c                                              /* 系统任务文件 */                 
│   ├── sys.h
│   ├── qrcode_create.c                                    /* 二维码组件 */
│   ├── qrcode_create.h
│   ├── tuya_qrcode_create.c                               
│   ├── tuya_qrcode_create.h
│   ├── USART.c                                            /* 串口初始化 */
│   ├── USART.h
│   ├── utf8ToUnicode.c                                    /* UTF8转UNICODE */
│   └── utf8ToUnicode.h
├── CJSON
│   ├── cJSON.c                                            /* JSON配置文件 */
│   └── cJSON.h
├── mcu_sdk
│   ├── mcu_api.c                                          /* dp功能数据文件 */
│   ├── mcu_api.h
│   ├── protocol.c                                         /* 协议分析和接收模块发送消息时的响应 */
│   ├── protocol.h
│   ├── system.c                                           /* 单片机与zigbee通信的框架分析 */
│   ├── system.h
│   └── zigbee.h                                           /* SDK中使用的宏定义 */


</code></pre> 
<h3>
<a id="2_133"></a>2.硬件外设</h3> 
<p>首先是硬件部分的配置，本次硬件部分主要在于墨水屏幕的显示和字库芯片的读取，字库芯片与屏使用同一块SPI驱动，所以首先将SPI进行初始化配置，另外MCU与zigbee模组通过串口进行通信，所以也要将串口进行初始化；</p> 
<pre><code class="prism language-c"><span class="token comment">//SPI</span>
<span class="token keyword">void</span> <span class="token function">SPI_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SPI_SCK_OUT<span class="token punctuation">;</span>
	SPI_MOSI_OUT<span class="token punctuation">;</span>
	SPI_MISO_IN<span class="token punctuation">;</span>
	LIB_CS_OUT<span class="token punctuation">;</span>
	EPD_CS_OUT<span class="token punctuation">;</span>
	EPD_DC_OUT<span class="token punctuation">;</span>
	EPD_RST_OUT<span class="token punctuation">;</span>
	EPD_BUSY_IN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">//UART2  通信串口</span>
<span class="token keyword">void</span> <span class="token function">Configure_USART_ZIGBEE</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> bound<span class="token punctuation">)</span> <span class="token comment">//PA2 MTX , PA3 MRX</span>
<span class="token punctuation">{<!-- --></span>
	RCC<span class="token operator">-&gt;</span>APB1RSTR1 <span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	RCC<span class="token operator">-&gt;</span>AHB2ENR <span class="token operator">|=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>
	GPIOA<span class="token operator">-&gt;</span>MODER <span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token operator">|</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
	GPIOA<span class="token operator">-&gt;</span>MODER <span class="token operator">|=</span><span class="token number">2</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token operator">|</span><span class="token number">2</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span>  
	GPIOA<span class="token operator">-&gt;</span>AFR<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0xf</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token operator">|</span><span class="token number">0xf</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOA<span class="token operator">-&gt;</span>AFR<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">|=</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token operator">|</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">;</span>
	RCC<span class="token operator">-&gt;</span>APB1ENR1 <span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">17</span><span class="token punctuation">;</span>
	USART_ZIGBEE<span class="token operator">-&gt;</span>BRR <span class="token operator">=</span> <span class="token number">16000000</span> <span class="token operator">/</span> bound<span class="token punctuation">;</span> 
	USART_ZIGBEE<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>
	<span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>USART2_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART2_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">//USART3   log串口</span>
<span class="token keyword">void</span> <span class="token function">Configure_USART_LOG</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> bound<span class="token punctuation">)</span>    <span class="token comment">//PB10 TXD   PB11 RXD   </span>
<span class="token punctuation">{<!-- --></span>
	RCC<span class="token operator">-&gt;</span>APB1RSTR1 <span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//恢复串口3</span>
	RCC<span class="token operator">-&gt;</span>AHB2ENR <span class="token operator">|=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>                   <span class="token comment">//使能GPIOB时钟</span>
	GPIOB<span class="token operator">-&gt;</span>MODER <span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token operator">|</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
	GPIOB<span class="token operator">-&gt;</span>MODER <span class="token operator">|=</span><span class="token number">2</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token operator">|</span><span class="token number">2</span><span class="token operator">&lt;&lt;</span><span class="token number">22</span><span class="token punctuation">;</span>       
	GPIOB<span class="token operator">-&gt;</span>AFR<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0xf</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token operator">|</span><span class="token number">0xf</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	GPIOB<span class="token operator">-&gt;</span>AFR<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">|=</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token operator">|</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">;</span>
	RCC<span class="token operator">-&gt;</span>APB1ENR1 <span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">18</span><span class="token punctuation">;</span>                     <span class="token comment">//使能串口3时钟</span>
	USART_LOG<span class="token operator">-&gt;</span>BRR <span class="token operator">=</span> <span class="token number">16000000</span> <span class="token operator">/</span> bound<span class="token punctuation">;</span> 
	USART_LOG<span class="token operator">-&gt;</span>CR1 <span class="token operator">|=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token operator">|</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>  
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART_LOG<span class="token operator">-&gt;</span>ISR <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span> 
		<span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">/* add time out here for a robust application */</span>
	<span class="token punctuation">}</span>	
	<span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>USART3_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART3_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="3_192"></a>3.墨水屏部分</h3> 
<p>下面是电子屏的显示部分，屏幕初始化完成后可以直接在主程序中调用显示函数，另外如果SPI初始化有问题可以将模拟SPI改为硬件SPI再进行驱动 ；</p> 
<p>屏幕显示也可以显示图片，采用取模软件将图片里的像素点数据放进picture.h文件中就可以显示图片了，要注意输出图片大小不能超过屏幕的尺寸大小，屏幕显示完成后调用局刷与全刷函数可以实现屏幕的局部刷新与全局刷新；需要注意屏幕每次刷新完后需要进入休眠模式，否则会对设备的整机功耗有很大影响；</p> 
<ul><li> <p><strong>屏幕刷新函数（全刷/局刷）</strong></p> <p><strong>全屏刷新</strong>：整个页面全部刷新一次，整个屏幕要闪几次。 优势是没有残影，缺点是要多刷几下屏。<br> <strong>局部刷新</strong>：每一次刷新显示内容时，不会整个屏幕都刷新，仅刷新那些有画面和字的地方。优势是屏幕不会闪烁，但会有残影。（残影问题多刷几次白屏就能清除掉或者执行一次全刷也可以清掉）</p> <p>在实现墨水屏的全局刷新与局部刷新功能时， 从局刷转到全刷时休眠后一定要先进入初始化再刷新。</p> </li></ul> 
<pre><code class="prism language-c"><span class="token comment">// refresh_mode = Full      全屏刷新</span>
<span class="token comment">// refresh_mode = Partial   局部刷新</span>
<span class="token keyword">void</span> <span class="token function">EPD_HW_Init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> refresh_mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">EPD_W21_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>						
	<span class="token function">Epaper_READBUSY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x12</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">Epaper_READBUSY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x2B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   	
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x2B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x3C</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
    <span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	  
    <span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x22</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token keyword">if</span><span class="token punctuation">(</span>refresh_mode<span class="token operator">==</span>Full<span class="token punctuation">)</span>
			<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0xB1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">if</span><span class="token punctuation">(</span>refresh_mode<span class="token operator">==</span>Partial<span class="token punctuation">)</span>
			<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0xB9</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">Epaper_READBUSY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x4E</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x4F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_READBUSY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>屏幕显示函数</strong></li></ul> 
<pre><code class="prism language-c"><span class="token comment">//mode==POS , 正显</span>
<span class="token comment">//mode==NEG , 负显</span>
<span class="token comment">//mode==OFF , 清除</span>
<span class="token keyword">void</span> <span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xstart<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> ystart<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> datas<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> PART_LINE<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> PART_COLUMN<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>  
	<span class="token keyword">int</span> xend<span class="token punctuation">,</span>ystart_H<span class="token punctuation">,</span>ystart_L<span class="token punctuation">,</span>yend<span class="token punctuation">,</span>yend_H<span class="token punctuation">,</span>yend_L<span class="token punctuation">;</span>
	xstart<span class="token operator">=</span>xstart<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span>                   <span class="token comment">//转换为字节</span>
	xend<span class="token operator">=</span>xstart<span class="token operator">+</span>PART_LINE<span class="token operator">/</span><span class="token number">8</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
	ystart_H<span class="token operator">=</span>ystart<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span>
	ystart_L<span class="token operator">=</span>ystart<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span>
	yend<span class="token operator">=</span>ystart<span class="token operator">+</span>PART_COLUMN<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		yend_H<span class="token operator">=</span>yend<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">;</span>
		yend_L<span class="token operator">=</span>yend<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">;</span>		
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// set RAM x address start/end</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span>xstart<span class="token punctuation">)</span><span class="token punctuation">;</span>    	  <span class="token comment">// RAM x address start;</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span>xend<span class="token punctuation">)</span><span class="token punctuation">;</span>    	  <span class="token comment">// RAM x address end</span>
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// set RAM y address start/end</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span>ystart_L<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// RAM y address start Low</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span>ystart_H<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// RAM y address start High</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span>yend_L<span class="token punctuation">)</span><span class="token punctuation">;</span>    	  <span class="token comment">// RAM y address end Low</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span>yend_H<span class="token punctuation">)</span><span class="token punctuation">;</span>    	  <span class="token comment">// RAM y address end High</span>
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x4E</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   	  <span class="token comment">// set RAM x address count</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span>xstart<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x4F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   	  <span class="token comment">// set RAM y address count</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span>ystart_L<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span>ystart_H<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//Write Black and White image to RAM</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>PART_COLUMN<span class="token operator">*</span>PART_LINE<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>                         
				<span class="token keyword">if</span> <span class="token punctuation">(</span>mode<span class="token operator">==</span>POS<span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token operator">*</span>datas<span class="token punctuation">)</span><span class="token punctuation">;</span>
						datas<span class="token operator">++</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>mode<span class="token operator">==</span>NEG<span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token operator">*</span>datas<span class="token punctuation">)</span><span class="token punctuation">;</span>
						datas<span class="token operator">++</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>	
			  <span class="token keyword">if</span> <span class="token punctuation">(</span>mode<span class="token operator">==</span>OFF<span class="token punctuation">)</span>
				  <span class="token punctuation">{<!-- --></span>
						<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>		
			<span class="token punctuation">}</span> 	
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>屏幕刷白屏函数</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">EPD_WhiteScreen_White</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>

<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">unsigned</span> <span class="token keyword">int</span> k<span class="token punctuation">;</span>
    <span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//write RAM for black(0)/white (1)   36</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">&lt;</span>ALLSCREEN_GRAGHBYTES<span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	
    <span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//write RAM for black(0)/white (1)</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">&lt;</span>ALLSCREEN_GRAGHBYTES<span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>	
		<span class="token function">EPD_Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>硬件复位函数</strong></li></ul> 
<p>当需要清掉局部信息并重新显示新的信息时就可以用硬件复位函数来实现；</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">EPD_W21_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	EPD_W21_RST_0<span class="token punctuation">;</span>     
	<span class="token function">driver_delay_xms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	EPD_W21_RST_1<span class="token punctuation">;</span> 			<span class="token comment">//hard reset  </span>
	<span class="token function">driver_delay_xms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>屏幕休眠函数</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">EPD_DeepSleep</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  	
  <span class="token function">Epaper_Write_Command</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//enter deep sleep</span>
  <span class="token function">Epaper_Write_Data</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token function">driver_delay_xms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意屏幕刷新完后必须进入休眠模式。</p> 
<h3>
<a id="4_348"></a>4.字库芯片</h3> 
<p>在使用字库芯片时，用户只要知道字符的内码，就可以计算出该字符点阵在芯片中的地址，然后就可从该地址连续读出点阵信息用于显示。本次屏幕显示信息主要通过从字库芯片中读取数据从而显示在屏幕上，从字库中读到的数据一个字符就是一个数组数据，然后电子屏再将每一位数组数据显示在屏幕上。</p> 
<ul><li><strong>字库芯片初始化</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">zk_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   Rom_csH<span class="token punctuation">;</span>
   MOSIH<span class="token punctuation">;</span>
   Rom_sckH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>字库芯片休眠</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">GT5S_DeepSleep</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
    Rom_csL<span class="token punctuation">;</span> 	
	<span class="token function">Send_Byte</span><span class="token punctuation">(</span><span class="token number">0xB9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Rom_csH<span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li> <p><strong>字库芯片唤醒</strong></p> <p>以低电平作为起始位，高电平作为停止位；</p> </li></ul> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">GT5S_Wakeup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
    Rom_csL<span class="token punctuation">;</span> 	
	<span class="token function">Send_Byte</span><span class="token punctuation">(</span><span class="token number">0xAB</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Rom_csH<span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li> <p><strong>矢量文字读取函数</strong></p> <p>调用方式：通过指定参数进行调用，获取点阵数据到pBits[]数组中</p> </li></ul> 
<pre><code class="prism language-c"><span class="token comment">/*
	 *函数名	get_font()
	 *功能		矢量文字读取函数
	 *参数：pBits		数据存储
	 *		sty		  文字字体选择 @矢量公用部分
	 *		fontCode	字符编码中文:GB18030, ASCII/外文: unicode
	 *		width		文字宽度
	 *		height		文字高度
	 *		thick		文字粗细
	 *返回值：文字显示高度
**/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">get_font</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pBits<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> sty<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> fontCode<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> width<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> height<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> thick<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>如果有需要固定显示的文字部分，可在程序中将固定文字信息写在数组中从而直接显示固定信息，一个ASCII码对应2位GBK内码占一个字节，一个中文字符对应4位GBK内码占两个字节；</p> 
<pre><code class="prism language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> jtwb<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"共享空间，预定优先"</span><span class="token punctuation">;</span>	        
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> state<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"暂不开放"</span><span class="token punctuation">;</span>	
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> pBits<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
</code></pre> 
<p>将固定信息通过文字读取函数get_font()与屏幕显示函数EPD_Dis_Part()进一步显示在墨水屏上；</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">SEAT_SET</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">EPD_HW_Init</span><span class="token punctuation">(</span>Partial<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zk_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GT5S_Wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//共</span>
    <span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">196</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//享</span>
    <span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">220</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//空</span>
    <span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">244</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//间</span>
    <span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">268</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EPD_Part_Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GT5S_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="5_441"></a>5.设备配网</h3> 
<h4>
<a id="1_443"></a>1）网关配网</h4> 
<p>由于墨水屏需要连接到涂鸦智能平台，依靠平台来实现自动化、App端操控、以及设备之间的相互联动，所以需要有一个zigbee网关来帮助设备连接上智能平台。zigbee网关的作用就是负责连接智能平台，间接的把zigbee设备接入我们的智能平台，确保手机和zigbee网关处于同一个Wi-Fi网络，以保证手机与智能网关之间的有效连接。</p> 
<ul>
<li> <p>将网关与电源连接，并通过网线与家庭2.4GHz频段路由器相连；</p> </li>
<li> <p>确认配网指示灯（绿灯）常亮（若指示灯处于其他状态，长按"复位键"，至绿灯常亮）；</p> </li>
<li> <p>确保手机连接家庭2.4GHz频段路由器，此时手机、网关处于同一个局域网；</p> </li>
<li> <p>打开涂鸦智能App首页，点击页面右上角添加按钮“+”;</p> </li>
<li> <p>选择网关中控/有线网关(zigbee)，依照提示操作设备入网；</p> </li>
<li> <p>添加成功后，即可在列表中找到网关设备；</p> </li>
</ul> 
<h4>
<a id="2zigbee_455"></a>2）zigbee模组配网</h4> 
<p>zigbee网关配网成功后，就可以在网关里添加子设备了，依据涂鸦智能App首页配网提示操作子设备配网，配网成功后就可以在涂鸦智能App上进行调试了；</p> 
<p>除了在程序里写入配网指令实现配网还可以通过涂鸦调试助手发送配网指令来操作设备入网，详细说明可以从zigbee串口协议文档中深入了解；</p> 
<p><a href="https://developer.tuya.com/cn/docs/iot/tuya-zigbee-module-uart-communication-protocol?id=K9ear5khsqoty">zigbee串口协议</a></p> 
<p>注意配网之前必须先在IoT平台将dp添加完成，否则配网会一直失败；</p> 
<h3>
<a id="6dp_465"></a>6.dp数据链路处理</h3> 
<p>定义一个结构体数组来存放MCU接收到网关下发或上报的dp value，</p> 
<pre><code class="prism language-c">TYPE_BUFFER_S FlashBuffer<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint8_t</span> seat_set<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">//座位信息</span>
  <span class="token class-name">uint8_t</span> st_qrcode<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//座位二维码链接地址</span>
  <span class="token class-name">uint8_t</span> st_qrcode1<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//第一条座位二维码链接地址</span>
  <span class="token class-name">uint8_t</span> st_qrcode2<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//第二条座位二维码链接地址</span>
  <span class="token class-name">uint8_t</span> st_add<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">//增量预约信息起始时间</span>
  <span class="token class-name">uint8_t</span> et_add<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">//增量预约信息终止时间</span>
  <span class="token class-name">uint8_t</span> n_add<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">//增量预约者姓名</span>
  <span class="token class-name">uint8_t</span> st_all<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">//全量预约信息起始时间</span>
  <span class="token class-name">uint8_t</span> et_all<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">//全量预约信息终止时间</span>
  <span class="token class-name">uint8_t</span> n_all<span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">//全量预约者姓名</span>
  <span class="token class-name">uint8_t</span> low_power<span class="token punctuation">;</span>         <span class="token comment">//低电量数值</span>
<span class="token punctuation">}</span> TYPE_BUFFER_S<span class="token punctuation">;</span>
</code></pre> 
<h4>
<a id="1_486"></a>1）座位信息更新</h4> 
<p>调试过程可使用调试面板来下发dp，MCU收到指令后回复并执行对应的操作。</p> 
<ul><li><strong>座位信息设置</strong></li></ul> 
<p>首先下发dp101 ，dp数据格式为{“n”:“seat number”,“st”:“state”}</p> 
<table>
<thead><tr>
<th>dpid</th>
<th align="center">内容</th>
<th align="center">备注</th>
</tr></thead>
<tbody>
<tr>
<td>101</td>
<td align="center">“query”</td>
<td align="center">设备发送，同步座位号信息</td>
</tr>
<tr>
<td>格式</td>
<td align="center">{“n”:“seat number”,“st”:“state”}</td>
<td align="center">n：座位编码字段； seat number：编码内容 st:座位状态字段 ；state:座位真实状态 enable disable repairing</td>
</tr>
</tbody>
</table>
<p>下发dp后MCU接收并解析出座位编码、座位状态等字段信息，然后驱动屏幕将座位编号信息显示在墨水屏上；</p> 
<p>定义一个结构体，用来表示墨水屏的三种工作状态：</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>
    enable<span class="token punctuation">,</span>     <span class="token comment">//使用中</span>
    disable<span class="token punctuation">,</span>    <span class="token comment">//未开放</span>
    reparing    <span class="token comment">//维修中</span>
<span class="token punctuation">}</span>state<span class="token punctuation">;</span>
</code></pre> 
<p><strong>dp解析及处理函数：</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/*****************************************************************************
函数名称 : dp_download_seat_set_handle
功能描述 : 针对DPID_SEAT_SET的处理函数
输入参数 : value:数据源数据
        : length:数据长度
返回参数 : 成功返回:SUCCESS/失败返回:ERROR
使用说明 : 可下发可上报类型,需要在处理完数据后上报处理结果至app
*****************************************************************************/</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">dp_download_seat_set_handle</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//示例:当前DP类型为STRING</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> dp_download_seat_set_handle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> 
	cJSON <span class="token operator">*</span>root <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item1 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>number <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>state <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> 
	<span class="token keyword">char</span> <span class="token operator">*</span>pstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	pstr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> pstr<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc errrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token function">my_memset</span><span class="token punctuation">(</span>pstr<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_memcpy</span><span class="token punctuation">(</span>pstr<span class="token punctuation">,</span> value<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"value: %srn"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	root <span class="token operator">=</span> <span class="token function">cJSON_Parse</span><span class="token punctuation">(</span>pstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>pstr<span class="token punctuation">)</span><span class="token punctuation">,</span> pstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> root<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>							
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"root ERRORrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    item <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//获取座位编码字段</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>			 				
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"item ERRORrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	number <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> number<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc number errrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">free</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">,</span> number <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	number <span class="token operator">=</span> item<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"number: %srn"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>seat_set<span class="token punctuation">,</span>number<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	item1 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"st"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//获取座位实际状态</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item1<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>						    	
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"item1 ERRORrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>item1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> state<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc state errrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">free</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> state <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	 state <span class="token operator">=</span> item1<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>	
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"state: %srn"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>      
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">"enable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>				    <span class="token comment">//使用中	</span>
		<span class="token function">SEAT_SET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                     <span class="token comment">//显示座位详细信息</span>
	<span class="token punctuation">}</span>	
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">"disable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>				 <span class="token comment">//未开放</span>
        <span class="token function">SEAT_CLOSE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment">//显示“暂不开放”</span>
	<span class="token punctuation">}</span>	
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">"repairing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>		 <span class="token comment">//维修中 </span>
        <span class="token function">SEAT_CLOSE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment">//显示“暂不开放”</span>
	<span class="token punctuation">}</span>	
    <span class="token function">cJSON_Delete</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//处理完DP数据后应有反馈</span>
    ret <span class="token operator">=</span> <span class="token function">mcu_dp_string_update</span><span class="token punctuation">(</span>DPID_SEAT_SET<span class="token punctuation">,</span>value<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> SUCCESS<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">Enter_stop_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//处理完dp后设备需进入休眠模式</span>
        <span class="token keyword">return</span> SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以座位S-1234为例，当座位状态为enable时才可以执行预约的动作，如果是disable 和 repairing 则显示该座位暂不开放（可根据自己需求修改）；</p> 
<table>
<thead><tr>
<th align="center">座位状态</th>
<th align="center">dp格式</th>
<th align="center">显示内容</th>
</tr></thead>
<tbody>
<tr>
<td align="center">enable</td>
<td align="center">{“n”:“S-1234”,“st”:"enable "}</td>
<td align="center">显示座位编号，若有预约信息则显示预约信息，无预约信息显示空白</td>
</tr>
<tr>
<td align="center">disable</td>
<td align="center">{“n”:“S-1234”,“st”:"disable "}</td>
<td align="center">显示座位编号以及“暂不开放”</td>
</tr>
<tr>
<td align="center">repairing</td>
<td align="center">{“n”:“S-1234”,“st”:"repairing "}</td>
<td align="center">显示座位编号以及“暂不开放”</td>
</tr>
</tbody>
</table>
<p>MCU接收到value后将解析出的信息存放在 FlashBuffer.seat_set[]中并通过修改显示函数EPD_Dis_Part()中的横纵坐标来调整在屏幕中的位置，注意显示函数完成后屏幕和字库芯片都需要进入休眠；</p> 
<p><strong>座位编号显示函数：</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">SEAT_SET</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">EPD_HW_Init</span><span class="token punctuation">(</span>Partial<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//屏幕局刷初始化</span>
	<span class="token function">zk_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">//字库芯片初始化</span>
	<span class="token function">GT5S_Wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//字库芯片唤醒</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span> FlashBuffer<span class="token punctuation">.</span>seat_set<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//下发信息</span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>seat_set<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>seat_set<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>		           
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>seat_set<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	 
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>seat_set<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	            
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>seat_set<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">136</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	            
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>seat_set<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">160</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	            	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//固定信息</span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">196</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">220</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">244</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">268</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">292</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">310</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">330</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">354</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span><span class="token punctuation">(</span>jtwb<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>jtwb<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">380</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_Part_Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//屏幕休眠</span>
	<span class="token function">GT5S_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">//字库芯片睡眠</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>座位二维码链接</strong></li></ul> 
<p>可通过调试面板下发dp102生成对应座位二维码信息，dp存放字节长度最大为62字节，若url超过了最大限长，可将二维码链接分为两段dp来下发；这里以长度为80的url为例，单条dp可以不固定长度，但不能超过限长，开发者可以按照自身的长度自行分配分两段还是三段。</p> 
<table>
<thead><tr>
<th align="center">dpid</th>
<th align="center">内容</th>
<th align="center">备注</th>
</tr></thead>
<tbody>
<tr>
<td align="center">102</td>
<td align="center">“query”</td>
<td align="center">设备发送，同步座位链接信息</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">{“qr”:“url”,“d”:“th”,“a”:“all”}</td>
<td align="center">qr:二维码链接字段;url:座位链接长度不超过255 设备通过url本地生成二维码 d:二维码条目字段 th:第几段二维码链接信息 a:二维码字段总量 all：共有几段二维码</td>
</tr>
</tbody>
</table>
<p>示例：座位1111 url地址为https://seat-reservation-mobile.tuyacn.com/weapp?a=1&amp;seat_id=1435857125099298816</p> 
<p>故dp格式为 <em>{“qr”:“https://seat-reservation-mobile.tuyacn.com”,“d”:“1”,“a”:“2”}</em></p> 
<p>​ {“qr”:"/weapp?a=1&amp;seat_id=1435857125099298816",“d”:“2”,“a”:“2”}</p> 
<p>下发dp102后MCU接收并解析出url并存放在FlashBuffer.st_qrcode中，进一步调用二维码生成函数将座位二维码显示在墨水屏上；</p> 
<p><strong>dp解析及处理函数：</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/*****************************************************************************
函数名称 : dp_download_st_qrcode_handle
功能描述 : 针对DPID_ST_QRCODE的处理函数
输入参数 : value:数据源数据
        : length:数据长度
返回参数 : 成功返回:SUCCESS/失败返回:ERROR
使用说明 : 可下发可上报类型,需要在处理完数据后上报处理结果至app
*****************************************************************************/</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">dp_download_st_qrcode_handle</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//示例:当前DP类型为STRING</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> dp_download_st_qrcode_handle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
	cJSON <span class="token operator">*</span>root <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item_1 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item_2 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item_3 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>qrcode <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>pstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	pstr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> pstr<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc errorrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">my_memset</span><span class="token punctuation">(</span>pstr<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_memcpy</span><span class="token punctuation">(</span>pstr<span class="token punctuation">,</span> value<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"value: %srn"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	root <span class="token operator">=</span> <span class="token function">cJSON_Parse</span><span class="token punctuation">(</span>pstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>pstr<span class="token punctuation">)</span><span class="token punctuation">,</span> pstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> root<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>							
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"root ERROR!!!!!!!!!!!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//qr      URL字段</span>
    item_1 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"qr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item_1<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>			 				
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"item_1 ERRORrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    qrcode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>item_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> qrcode<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc qrcode errrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">free</span><span class="token punctuation">(</span>qrcode<span class="token punctuation">)</span><span class="token punctuation">,</span> qrcode <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	 qrcode <span class="token operator">=</span> item_1<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"qrcode: %srn"</span><span class="token punctuation">,</span> qrcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//d       url次序</span>
	 item_2 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item_2<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>						    	
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	d <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>item_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> d<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc d errrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">free</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	 d <span class="token operator">=</span> item_2<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"d: %srn"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>		                  <span class="token comment">//第一段url				 </span>
		 <span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_qrcode1<span class="token punctuation">,</span>qrcode<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>qrcode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"FlashBuffer.st_qrcode1: %srn"</span><span class="token punctuation">,</span> FlashBuffer<span class="token punctuation">.</span>st_qrcode1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>				 	  <span class="token comment">//第二段url		 </span>
         <span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_qrcode2<span class="token punctuation">,</span>qrcode<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>qrcode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"FlashBuffer.st_qrcode2: %srn"</span><span class="token punctuation">,</span> FlashBuffer<span class="token punctuation">.</span>st_qrcode2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token function">strcat</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_qrcode1<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_qrcode2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"FlashBuffer.st_qrcode1: %srn"</span><span class="token punctuation">,</span> FlashBuffer<span class="token punctuation">.</span>st_qrcode1<span class="token punctuation">)</span><span class="token punctuation">;</span>	  
	     <span class="token function">memset</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_qrcode<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	     <span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_qrcode<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_qrcode1<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_qrcode1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">qrcod_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		                          <span class="token comment">//二维码显示函数	   </span>
	<span class="token punctuation">}</span>
    <span class="token comment">//a</span>
	item_3 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item_3<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	a <span class="token operator">=</span> item_3<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
    <span class="token function">cJSON_Delete</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
	root <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//处理完DP数据后应有反馈</span>
    ret <span class="token operator">=</span> <span class="token function">mcu_dp_string_update</span><span class="token punctuation">(</span>DPID_ST_QRCODE<span class="token punctuation">,</span>value<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> SUCCESS<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">Enter_stop_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">//处理完后设备进入低功耗模式   </span>
        <span class="token keyword">return</span> SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>二维码显示函数：</strong></p> 
<pre><code class="prism language-c">TY_CREATE_IN_T Qrcod_CREATE_IN<span class="token punctuation">;</span>
TY_CREATE_OUT_T <span class="token operator">*</span>Qrcod_CREATE_OUT<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">qrcod_test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	Qrcod_CREATE_IN<span class="token punctuation">.</span>ecc_level<span class="token operator">=</span>QRCODE_ECC_MEDIUM<span class="token punctuation">;</span>
	Qrcod_CREATE_IN<span class="token punctuation">.</span>version<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span>                            <span class="token comment">//版本为9   53*53</span>
	Qrcod_CREATE_IN<span class="token punctuation">.</span>magnifications<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>                     <span class="token comment">//放大倍数2</span>
	Qrcod_CREATE_IN<span class="token punctuation">.</span>mode<span class="token operator">=</span>STORAGE_MODE_BIT<span class="token punctuation">;</span>
	Qrcod_CREATE_IN<span class="token punctuation">.</span>information<span class="token operator">=</span>FlashBuffer<span class="token punctuation">.</span>st_qrcode<span class="token punctuation">;</span>                        <span class="token comment">//url存放位置</span>
	<span class="token function">tuya_svc_image_generate_qrcode_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Qrcod_CREATE_IN<span class="token punctuation">,</span><span class="token operator">&amp;</span>Qrcod_CREATE_OUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_HW_Init</span><span class="token punctuation">(</span>Partial<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_Dis_Part2</span><span class="token punctuation">(</span><span class="token number">288</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>Qrcod_CREATE_OUT<span class="token operator">-&gt;</span>dst_data<span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">106</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//显示坐标位置</span>
	<span class="token function">EPD_Part_Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">tuya_svc_image_generate_qrcode_create_free</span><span class="token punctuation">(</span>Qrcod_CREATE_OUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>开发者可以根据自己需求修改url信息，另外如果url前半部分固定不变的话可以将其写在程序中，通过dp只下发后半部分url，可以简化很多步骤；</p> 
<h4>
<a id="2_786"></a>2）预约信息更新</h4> 
<table>
<thead><tr>
<th>dpid</th>
<th>内容</th>
<th>备注</th>
</tr></thead>
<tbody><tr>
<td>103</td>
<td>{“st”:time,“et”:time,“n”:“name”,“t”:“type”,“d”:“th”}</td>
<td>st：预约起始时间字段 et：预约结束时间字段 time:时间 n：预约者名字字段 name：名字内容 t：类型字段 type：add:增加 del:删除 d：第几条预约信息</td>
</tr></tbody>
</table>
<p>dp103是预约信息的更新，更新类型包括新增与删除，更新的前提是设备已经从服务端同步过才有更新；</p> 
<p>例如当前显示两条预约信息，当需要更新第一条预约信息时先下发更新dp，并且第一条更新完成的同时需将第二条信息删除，下面为更新与删除的举例；</p> 
<table>
<thead><tr>
<th align="center">类型</th>
<th align="center">举例</th>
</tr></thead>
<tbody>
<tr>
<td align="center">新增</td>
<td align="center">{“st”:“10:00”,“et”:“12:00”,“n”:“无施”,“t”:“add”,“d”:“1”}</td>
</tr>
<tr>
<td align="center">删除</td>
<td align="center">{“st”:“10:00”,“et”:“12:00”,“n”:“无施”,“t”:“del”,“d”:“2”}</td>
</tr>
</tbody>
</table>
<p><strong>dp解析及处理函数：</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/*****************************************************************************
函数名称 : dp_download_st_add_handle
功能描述 : 针对DPID_ST_ADD的处理函数
输入参数 : value:数据源数据
        : length:数据长度
返回参数 : 成功返回:SUCCESS/失败返回:ERROR
使用说明 : 只下发类型,需要在处理完数据后上报处理结果至app
*****************************************************************************/</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">dp_download_st_add_handle</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//示例:当前DP类型为STRING</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> dp_download_st_add_handle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
	<span class="token function">my_memset</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">,</span> value<span class="token punctuation">,</span>length<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cJSON <span class="token operator">*</span>root <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item1 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item2 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item3 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">*</span>item4 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span><span class="token operator">*</span> st <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>            <span class="token comment">//预约起始时间</span>
	<span class="token keyword">char</span><span class="token operator">*</span> et <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>            <span class="token comment">//预约终止时间</span>
	<span class="token keyword">char</span><span class="token operator">*</span> n <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>             <span class="token comment">//预约者姓名</span>
    <span class="token keyword">char</span><span class="token operator">*</span> t <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>             <span class="token comment">//预约类型 : add/del</span>
	<span class="token keyword">char</span><span class="token operator">*</span> d <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>             <span class="token comment">//预约信息次序</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>pstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	pstr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pstr: %srn"</span><span class="token punctuation">,</span> pstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> pstr<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc errrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token function">my_memset</span><span class="token punctuation">(</span>pstr<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_memcpy</span><span class="token punctuation">(</span>pstr<span class="token punctuation">,</span> value<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	root <span class="token operator">=</span> <span class="token function">cJSON_Parse</span><span class="token punctuation">(</span>pstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>pstr<span class="token punctuation">)</span><span class="token punctuation">,</span> pstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> root<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>								
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ERROR!!!!!!!!!!!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//st  预约起始时间</span>
    item <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"st"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>			 				
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"item ERRORrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	 st <span class="token operator">=</span> item<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"st: %srn"</span><span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">,</span>st<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//et  预约终止时间</span>
    item1 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"et"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item1<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>			 			
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"item1 ERRORrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	 et <span class="token operator">=</span> item1<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"et: %srn"</span><span class="token punctuation">,</span> et<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">,</span>et<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>et<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
	<span class="token comment">//n    预约者姓名</span>
	 item2 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item2<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>			 				
    <span class="token punctuation">}</span>
	 n <span class="token operator">=</span> item2<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"n: %srn"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>n_add<span class="token punctuation">,</span>n<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token comment">//t   预约类型 : add/del</span>
	 item3 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item3<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>						    
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	 t <span class="token operator">=</span> item3<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>	
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"t: %srn"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token comment">//d   预约信息次序</span>
	 item4 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item4<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>						    	
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	 d <span class="token operator">=</span> item4<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"d: %srn"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
	 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment">//新增</span>
    <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">//新增第一条信息</span>
            <span class="token function">ST_ADD1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//新增第二条信息</span>
            <span class="token function">ST_ADD2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">else</span>  
            <span class="token function">ST_ADD3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//新增第三条信息</span>
    <span class="token punctuation">}</span>  
    <span class="token keyword">else</span>  
    <span class="token punctuation">{<!-- --></span>   
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"del"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">//删除</span>
	       <span class="token punctuation">{<!-- --></span>
			   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                  <span class="token function">ST_DEL1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//删除第一条信息</span>
               <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                  <span class="token function">ST_DEL2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//删除第二条信息</span>
               <span class="token keyword">else</span>  
                  <span class="token function">ST_DEL3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//删除第三条信息</span>
          <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span> 
    <span class="token function">cJSON_Delete</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	
    <span class="token comment">//处理完DP数据后应有反馈</span>
    ret <span class="token operator">=</span> <span class="token function">mcu_dp_string_update</span><span class="token punctuation">(</span>DPID_ST_ADD<span class="token punctuation">,</span>value<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> SUCCESS<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">Enter_stop_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//处理完后设备进入低功耗模式</span>
        <span class="token keyword">return</span> SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>MCU接收到value后将解析出的起始时间存放在 FlashBuffer.st_add，将终止时间存放在 FlashBuffer.et_add，姓名字段存放在gbk_n中，并通过修改显示函数EPD_Dis_Part()中的横纵坐标来调整在屏幕中的位置。</p> 
<ul><li><strong>更新函数：</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">ST_ADD1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">EPD_SetRAMValue_BaseMap</span><span class="token punctuation">(</span>pBits<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//保留背景信息</span>
	<span class="token function">EPD_HW_Init</span><span class="token punctuation">(</span>Partial<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zk_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GT5S_Wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pBits<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span> pBits<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pBits<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> gbk_n<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">utf8ToGBK</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>n_add<span class="token punctuation">,</span> gbk_n<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">//GBK转换</span>
	<span class="token comment">//time    </span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span> FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//st  </span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>		           
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	 
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	            
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span><span class="token number">0X2D</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//et  </span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	            
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">140</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">153</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	
   <span class="token comment">//name</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span>gbk_n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">176</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span>gbk_n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">EPD_Part_Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GT5S_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>删除函数：</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">ST_DEL1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">EPD_SetRAMValue_BaseMap</span><span class="token punctuation">(</span>pBits<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">EPD_HW_Init</span><span class="token punctuation">(</span>Partial<span class="token punctuation">)</span><span class="token punctuation">;</span> 	         
	<span class="token function">zk_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GT5S_Wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span> pBits<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pBits<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> gbk_n<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">utf8ToGBK</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>n_add<span class="token punctuation">,</span> gbk_n<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span> FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//st</span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_add<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span><span class="token number">0x2D</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//-</span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//et</span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">140</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_add<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">153</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span>gbk_n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">176</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span>gbk_n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_Part_Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GT5S_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="3_1007"></a>3）预约信息同步</h4> 
<table>
<thead><tr>
<th>dpid</th>
<th align="center">内容</th>
<th>备注</th>
</tr></thead>
<tbody>
<tr>
<td>104</td>
<td align="center">“query”</td>
<td>设备发送，同步预约信息（全量）</td>
</tr>
<tr>
<td></td>
<td align="center">{“st”:time,“et”:time,“n”:“name”,“d”:“th”,“a”:“all”}</td>
<td>st:预约起始时间字段 et:预约结束时间字段 time:时间 n:预约者姓名字段 name:姓名 d:单条预约信息 a:预约信息总量</td>
</tr>
</tbody>
</table>
<p>dp104是预约信息的同步，设备上电后同步所有数据，若查询到几条预约信息就对应显示几条预约信息，如查询到有三条信息则依次三条预约信息，下发格式</p> 
<table>
<thead><tr>
<th align="center">预约信息全量</th>
<th align="center">举例</th>
</tr></thead>
<tbody>
<tr>
<td align="center">第一条</td>
<td align="center">{“st”:“10:00”,“et”:“12:30”,“n”:“一一”,”d”:”1”,”a”:”3”}</td>
</tr>
<tr>
<td align="center">第二条</td>
<td align="center">{“st”:“14:10”,“et”:“16:30”,“n”:“一二”,”d”:”2”,”a”:”3”}</td>
</tr>
<tr>
<td align="center">第三条</td>
<td align="center">{“st”:“18:30”,“et”:“20:00”,“n”:“一三”,”d”:”3”,”a”:”3”}</td>
</tr>
</tbody>
</table>
<ul><li><strong>dp解析及处理函数：</strong></li></ul> 
<pre><code class="prism language-c"><span class="token comment">/*****************************************************************************
函数名称 : dp_download_st_all_handle
功能描述 : 针对DPID_ST_ALL的处理函数
输入参数 : value:数据源数据
        : length:数据长度
返回参数 : 成功返回:SUCCESS/失败返回:ERROR
使用说明 : 可下发可上报类型,需要在处理完数据后上报处理结果至app
*****************************************************************************/</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">dp_download_st_all_handle</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//示例:当前DP类型为STRING</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> dp_download_st_all_handle <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_all<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_all<span class="token punctuation">,</span> value<span class="token punctuation">,</span>length<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cJSON <span class="token operator">*</span>root <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item_1 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item_2 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item_3 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item_4 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>item_5 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>st <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>et <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> 
	<span class="token keyword">char</span> <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>pstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	pstr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pstr: %srn"</span><span class="token punctuation">,</span> pstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> pstr<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"malloc errorrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">my_memset</span><span class="token punctuation">(</span>pstr<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_memcpy</span><span class="token punctuation">(</span>pstr<span class="token punctuation">,</span> value<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pstr: %srn"</span><span class="token punctuation">,</span> pstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">my_memset</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_all<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">my_memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_all<span class="token punctuation">,</span> value<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	root <span class="token operator">=</span> <span class="token function">cJSON_Parse</span><span class="token punctuation">(</span>pstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>pstr<span class="token punctuation">)</span><span class="token punctuation">,</span> pstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> root<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>								
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"root ERROR!!!!!!!!!!!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//st</span>
    item_1 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"st"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item_1<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>			 				
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"item_1 ERRORrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	 st <span class="token operator">=</span> item_1<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"st: %srn"</span><span class="token punctuation">,</span> st<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>st_all<span class="token punctuation">,</span>st<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
     <span class="token comment">//et</span>
    item_2 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"et"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item_2<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>			 				
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"item_2 ERRORrn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	    et <span class="token operator">=</span> item_2<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"et: %srn"</span><span class="token punctuation">,</span> et<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>et_all<span class="token punctuation">,</span>et<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>et<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//n</span>
	 item_3 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item_3<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>			 				
       <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	 n <span class="token operator">=</span> item_3<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"n: %srn"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>n_all<span class="token punctuation">,</span>n<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//d</span>
	 item_4 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item_4<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>						    	
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	 d <span class="token operator">=</span> item_4<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"d: %srn"</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>	
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>		      <span class="token comment">//第一条预约信息全量				 </span>
		<span class="token function">ST_ALL1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   
	<span class="token punctuation">}</span>	
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>		  <span class="token comment">//第二条预约信息全量			 	 </span>
        <span class="token function">ST_ALL2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>         <span class="token comment">//第三条预约信息全量	</span>
         <span class="token function">ST_ALL3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			
	<span class="token punctuation">}</span>	
	<span class="token comment">//a</span>
	item_5 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> item_5<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	a <span class="token operator">=</span> item_5<span class="token operator">-&gt;</span>valuestring<span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"a: %srn"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cJSON_Delete</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">,</span> root <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//处理完DP数据后应有反馈</span>
    ret <span class="token operator">=</span> <span class="token function">mcu_dp_string_update</span><span class="token punctuation">(</span>DPID_ST_ALL<span class="token punctuation">,</span>value<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> SUCCESS<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">Enter_stop_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">//进入低功耗模式</span>
        <span class="token keyword">return</span> SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>MCU接收到value后将解析出的起始时间存放在 FlashBuffer.st_all，将终止时间存放在 FlashBuffer.et_all，姓名字段存放在gbk_1中，并通过修改显示函数EPD_Dis_Part()中的横纵坐标来调整在屏幕中的位置。</p> 
<ul><li><strong>显示函数：</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">ST_ALL1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">EPD_HW_Init</span><span class="token punctuation">(</span>Partial<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zk_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GT5S_Wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> gbk_1<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">utf8ToGBK</span><span class="token punctuation">(</span>FlashBuffer<span class="token punctuation">.</span>n_all<span class="token punctuation">,</span> gbk_1<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//time</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span> FlashBuffer<span class="token punctuation">.</span>st_all<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_all<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_all<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>		      
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_all<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	 
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>st_all<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	            
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span><span class="token number">0X2D</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	            
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_all<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	            
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_all<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_all<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_all<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">140</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_FT_ASCII_STY<span class="token punctuation">,</span>FlashBuffer<span class="token punctuation">.</span>et_all<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">153</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token comment">//name</span>
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span>gbk_1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">176</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">get_font</span><span class="token punctuation">(</span>pBits<span class="token punctuation">,</span>VEC_SONG_STY<span class="token punctuation">,</span>gbk_1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">EPD_Dis_Part</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>pBits<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span>NEG<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">EPD_Part_Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EPD_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GT5S_DeepSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="4_1171"></a>4）电量报警</h4> 
<p>当设备电池电量低于10%时将低电量状态上报至后台端，由于电池的电量和电压不是线性关系，若要通过电压来做电量指示的话需要多做几组充电放电的曲线测试，程序中也需要分三种情况处理：空载时、负载时、以及充电时将三种情况分别表示出来，用电压做电量指示才会更准确一些。</p> 
<p>本次设计在计量电池电量时采用设备功耗来计算电池电量，如设备休眠状态（80ms）电流10uA，接收状态（600us）5mA，则可以算出平均电流，已知电池总电量，就可以计算出设备可工作时间。当电池电量低于10%，上报至后台端。</p> 
<h3>
<a id="7_1177"></a>7.功耗调试</h3> 
<p>MCU与模组唤醒逻辑如下：</p> 
<p><img src="https://images2.imgbox.com/c6/55/2jFmzs9F_o.png" alt="mcu-zigbee"></p> 
<p><strong>TX/RX</strong>：通讯串口</p> 
<p><strong>IO1</strong>:zigbee唤醒MCU引脚，拉低唤醒，电平持续时间10ms以上。</p> 
<p><strong>IO2</strong>:MCU唤醒Zigbee引脚，拉低唤醒，电平持续时间10ms以上。</p> 
<p>MCU与模组唤醒的引脚为PB4 PB5,对应MCU的PB0,PC13</p> 
<p><img src="https://images2.imgbox.com/94/c0/winIgq9q_o.png" alt="16341117852119.png"></p> 
<h4>
<a id="1_1193"></a>1）模组功耗调试</h4> 
<p>zigebee模组烧录的固件为低功耗固件，可通过配置zigbee网络策略参数来调节模组的功耗，以下为zigbee模组的常用参数</p> 
<table>
<thead><tr>
<th align="center">zigbee网络策略参数</th>
<th align="center">默认值</th>
</tr></thead>
<tbody>
<tr>
<td align="center">心跳时间</td>
<td align="center">17000</td>
</tr>
<tr>
<td align="center">配网时间</td>
<td align="center">180</td>
</tr>
<tr>
<td align="center">poll时间</td>
<td align="center">5000</td>
</tr>
<tr>
<td align="center">上电持续poll</td>
<td align="center">30</td>
</tr>
<tr>
<td align="center">poll失败次数</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center">应用触发rejion</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">rejion间隔</td>
<td align="center">180</td>
</tr>
<tr>
<td align="center">rejion次数</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">发送功率</td>
<td align="center">11</td>
</tr>
</tbody>
</table>
<p>下面是对各个参数的详细描述，</p> 
<ul>
<li> <p><strong>心跳时间</strong>：是用来维护设备和网关之间的数据链路是否正常的手段，强电设备的心跳时间默认为150+random（30）秒，低功耗设备的心跳时间默认为 4 小时，设置范围为10~5*3600秒，且网关判定 12 小时内没有收到心跳则认为设备离线。</p> </li>
<li> <p><strong>配网时间</strong>：当MCU发送配网指令之后，模组会执行一段时间的配网操作，并发送当前网络状态为配网状态。在一段时间内由于某些原因（例如附近没有开启配网的网络或者距离较远）导致模组没有加入到合适网络，则配网超时。配网超时之后，模组将处于未配网状态，同时也会将此状态发送给 MCU。配网超时时间默认为180秒，设置范围为30~600秒。</p> </li>
<li> <p><strong>poll时间（唤醒周期）</strong>：poll 时间是指已经加入到网络的低功耗模组会在周期内唤醒，唤醒之后低功耗模组会发送数据请求（Data request）至其父节点，用于告知父节点，其当前处于唤醒状态，父节点是否为其缓存数据。如果存在缓存数据，则父节点可以将数据发送给低功耗模组。</p> <p><strong>注：Poll 值主要是影响功耗。唤醒周期越短，功耗越大。Poll 最小值为 200ms，小于最小值按照最小值处理。建议取值小于等于 8s，这里poll时间默认为5000ms，设置范围为200~10000ms。</strong></p> </li>
<li> <p><strong>上电持续poll</strong>：通常上电之后，设置一段时间的快速 Poll，可以在这个时间窗内将网关的配置命令下发。上电之后的快速 Poll 的时间默认为 30 秒，设置范围为30~600s。</p> </li>
<li> <p><strong>poll失败次数</strong>：低功耗模块发送Data request之后，父节点首先是需要回复 ack，该ack是对Data request的应答。如果有缓存数据则将数据发送给模块，如果没有数据发送，则仅需回复ack。如果模块发送了Data request，但由于环境、距离、父节点断电等因素导致模块没有收到ack，则模块的poll失败次数会加1，如果在累加的过程中重新收到父节点的ack，则累加清零，当累加到的一定的值时（Poll失败次数），认为模块丢失父节点，需要触发rejion。默认值为4次，设置范围为3~40次。</p> </li>
<li> <p><strong>rejoin（重连）</strong>：即重新加入到网络，但无须网关开启配网模式，是一种专门用于低功耗设备在父节点丢失时，重新加入网络的一种机制。</p> </li>
<li> <p><strong>rejoin间隔</strong>： 周期触发rejion的间隔时间。低功耗模块触发rejion之后，发送beacon request的周期间隔。默认值为180s，即当设备丢失父节点时，会间隔180秒尝试rejion。</p> </li>
<li> <p><strong>rejoin次数</strong>：低功耗模块触发rejion之后，发送beacon request的次数，默认值为1，可设置范围为1~10次。</p> </li>
<li> <p><strong>发送功率</strong>：发送功率越大，功耗越高，默认值为11dB，可设置范围为3~19dB。</p> <p>以上几个参数为模组较常用的几个参数，模组网络参数调节完之后测出模组休眠状态功耗约为2.4uA，以上参数满足低功耗要求故开发者无须再次修改调节。</p> </li>
</ul> 
<h4>
<a id="2MCU_1233"></a>2）MCU功耗调试</h4> 
<p>MCU有多种低功耗模式：睡眠模式、低功耗运行模式、低功耗睡眠模式、停止模式、待机模式。</p> 
<p>待机模式电流最低，但是待机模式时的MCU处于不受控制的状态，所有的IO口都工作在高阻抗的状态下，只有专门的几个引脚能将MCU唤醒，而每次唤醒后相当于系统复位，RAM中的数据全部丢失，在外部器件连接的情况下，器件的引脚可能会吸收大量的电流，反而达不到低功耗的要求。</p> 
<p>停止模式的功耗仅次于待机模式。在STOP模式下，PLL,HSL,HSE都被停止，RAM和寄存器的值保留。</p> 
<p>本次方案采用STOP2模式为功耗最低的睡眠模式，且STOP2模式只能从运行模式进入，开发者可根据自身应用场景选择相应的模式，下面是MCU在几种模式下的功耗大小，</p> 
<table>
<thead><tr>
<th align="center">低功耗模式</th>
<th align="center">电流消耗</th>
<th align="center">唤醒时间</th>
</tr></thead>
<tbody>
<tr>
<td align="center">STOP0</td>
<td align="center">100 µA</td>
<td align="center">0.7 µs</td>
</tr>
<tr>
<td align="center">STOP1</td>
<td align="center">4.6 µA</td>
<td align="center">4 µs</td>
</tr>
<tr>
<td align="center">STOP2</td>
<td align="center">2.7µA</td>
<td align="center">5 µs</td>
</tr>
</tbody>
</table>
<p>下面为MCU进入低功耗模式的流程步骤</p> 
<ul><li><strong>进入低功耗前的配置：</strong></li></ul> 
<p>1）把所有开启的外设先失能，再把引脚设为模拟模式，最后关闭外设时钟；</p> 
<p>2）进入STOP2模式，调用低功耗函数；可配置为中断唤醒或事件唤醒，通过__WFI()或__**WFE()**选择唤醒模式；</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Enter_stop_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	RCC<span class="token operator">-&gt;</span>APB1ENR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">28</span><span class="token punctuation">;</span>     <span class="token comment">//PWR电源接口使能</span>
	RCC<span class="token operator">-&gt;</span>APB1RSTR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">17</span><span class="token punctuation">;</span>    <span class="token comment">//复位所以IO口</span>
	RCC<span class="token operator">-&gt;</span>APB1RSTR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">18</span><span class="token punctuation">;</span> 
	RCC<span class="token operator">-&gt;</span>AHB2ENR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">//禁止GPIO B</span>
    RCC<span class="token operator">-&gt;</span>AHB2ENR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>       <span class="token comment">//禁止GPIO C</span>
	RCC<span class="token operator">-&gt;</span>APB1ENR1<span class="token operator">|=</span> <span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">;</span> 
	SPI_MISO_SLEEP<span class="token punctuation">;</span>
	EPD_BUSY_SLEEP<span class="token punctuation">;</span>
    <span class="token comment">//PB0作为外部中断</span>
    <span class="token function">Exit_IO4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token comment">//进入STOP2模式</span>
	<span class="token function">__WFI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	             <span class="token comment">//Wait For Interrupt</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>出低功耗后的配置：</strong></li></ul> 
<p>1）先恢复时钟配置</p> 
<p>2）恢复外设状态，如GPIO、串口、SPI等</p> 
<p>3）在需要进入STOP模式的地方直接调用函数</p> 
<pre><code class="prism language-c"><span class="token comment">//退出STOP2后设置</span>
<span class="token keyword">void</span> <span class="token function">Exit_stop_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	<span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	RCC<span class="token operator">-&gt;</span>AHB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>      
    RCC<span class="token operator">-&gt;</span>AHB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span> 
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"exit stoprn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<ul><li><strong>中断唤醒</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Exit_IO4</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	PA4_IN<span class="token punctuation">;</span>               <span class="token comment">//PA4唤醒引脚</span>
	EXTI<span class="token operator">-&gt;</span>IMR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>     <span class="token comment">//中断请求未屏蔽</span>
	EXTI<span class="token operator">-&gt;</span>RTSR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>    <span class="token comment">//line4 上升沿 </span>
	<span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>EXTI4_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>EXTI4_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	EXTI<span class="token operator">-&gt;</span>PR1 <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>    <span class="token comment">//清除中断标志位</span>
	
<span class="token punctuation">}</span>
</code></pre> 
<p>注意在调试低功耗时芯片有时会进入休眠自锁状态出现无法下载的情况，可按住开发板的复位键不放开再点下载程序，过1~2秒后放开按键即可烧写成功；</p> 
<h2>
<a id="_1313"></a>三、整机演示</h2> 
<p>设备整机搭建如下图：</p> 
<img src="https://images2.imgbox.com/47/4b/Jq1HASG1_o.png" alt="zidj"> 
<p>OP模式下，PLL,HSL,HSE都被停止，RAM和寄存器的值保留。</p> 
<p>本次方案采用STOP2模式为功耗最低的睡眠模式，且STOP2模式只能从运行模式进入，开发者可根据自身应用场景选择相应的模式，下面是MCU在几种模式下的功耗大小，</p> 
<table>
<thead><tr>
<th align="center">低功耗模式</th>
<th align="center">电流消耗</th>
<th align="center">唤醒时间</th>
</tr></thead>
<tbody>
<tr>
<td align="center">STOP0</td>
<td align="center">100 µA</td>
<td align="center">0.7 µs</td>
</tr>
<tr>
<td align="center">STOP1</td>
<td align="center">4.6 µA</td>
<td align="center">4 µs</td>
</tr>
<tr>
<td align="center">STOP2</td>
<td align="center">2.7µA</td>
<td align="center">5 µs</td>
</tr>
</tbody>
</table>
<p>下面为MCU进入低功耗模式的流程步骤</p> 
<ul><li><strong>进入低功耗前的配置：</strong></li></ul> 
<p>1）把所有开启的外设先失能，再把引脚设为模拟模式，最后关闭外设时钟；</p> 
<p>2）进入STOP2模式，调用低功耗函数；可配置为中断唤醒或事件唤醒，通过__WFI()或__**WFE()**选择唤醒模式；</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Enter_stop_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	RCC<span class="token operator">-&gt;</span>APB1ENR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">28</span><span class="token punctuation">;</span>     <span class="token comment">//PWR电源接口使能</span>
	RCC<span class="token operator">-&gt;</span>APB1RSTR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">17</span><span class="token punctuation">;</span>    <span class="token comment">//复位所以IO口</span>
	RCC<span class="token operator">-&gt;</span>APB1RSTR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">18</span><span class="token punctuation">;</span> 
	RCC<span class="token operator">-&gt;</span>AHB2ENR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">//禁止GPIO B</span>
    RCC<span class="token operator">-&gt;</span>AHB2ENR<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>       <span class="token comment">//禁止GPIO C</span>
	RCC<span class="token operator">-&gt;</span>APB1ENR1<span class="token operator">|=</span> <span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">;</span> 
	SPI_MISO_SLEEP<span class="token punctuation">;</span>
	EPD_BUSY_SLEEP<span class="token punctuation">;</span>
    <span class="token comment">//PB0作为外部中断</span>
    <span class="token function">Exit_IO4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token comment">//进入STOP2模式</span>
	<span class="token function">__WFI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	             <span class="token comment">//Wait For Interrupt</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>出低功耗后的配置：</strong></li></ul> 
<p>1）先恢复时钟配置</p> 
<p>2）恢复外设状态，如GPIO、串口、SPI等</p> 
<p>3）在需要进入STOP模式的地方直接调用函数</p> 
<pre><code class="prism language-c"><span class="token comment">//退出STOP2后设置</span>
<span class="token keyword">void</span> <span class="token function">Exit_stop_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	<span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	RCC<span class="token operator">-&gt;</span>AHB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>      
    RCC<span class="token operator">-&gt;</span>AHB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span> 
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"exit stoprn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<ul><li><strong>中断唤醒</strong></li></ul> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Exit_IO4</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	PA4_IN<span class="token punctuation">;</span>               <span class="token comment">//PA4唤醒引脚</span>
	EXTI<span class="token operator">-&gt;</span>IMR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>     <span class="token comment">//中断请求未屏蔽</span>
	EXTI<span class="token operator">-&gt;</span>RTSR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>    <span class="token comment">//line4 上升沿 </span>
	<span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>EXTI4_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>EXTI4_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	EXTI<span class="token operator">-&gt;</span>PR1 <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>    <span class="token comment">//清除中断标志位</span>
	
<span class="token punctuation">}</span>
</code></pre> 
<p>注意在调试低功耗时芯片有时会进入休眠自锁状态出现无法下载的情况，可按住开发板的复位键不放开再点下载程序，过1~2秒后放开按键即可烧写成功。</p> 
<p>以上就是墨水屏座位管理器嵌入式功能实现的所有内容，如果你这对墨水屏相关应用场景实践感兴趣，或者在开发过程中遇到任何问题，欢迎留言交流。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>