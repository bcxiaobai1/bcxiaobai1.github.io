<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Kotlin：Flow 全面详细指南，附带源码解析。 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kotlin：Flow 全面详细指南，附带源码解析。</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <p></p>
<div class="toc">
 <h3>文章目录</h3>
 <ul><li>
<ul>
<li><a href="#Flow_2">Flow</a></li>
<li><a href="#Flow_4">Flow简介</a></li>
<li><a href="#_12">如何返回多个值？</a></li>
<li>
<ul>
<li><a href="#For_example_1__list_14">For example 1 : list</a></li>
<li><a href="#For_example_2__Sequences_34">For example 2 : Sequences</a></li>
<li><a href="#For_example_3__flow_67">For example 3 : 异步计算并返回？引入flow</a></li>
</ul>
   </li>
<li><a href="#Flow_104">Flow使用</a></li>
<li>
<ul>
<li><a href="#Flow__106">Flow 简单使用</a></li>
<li><a href="#Flow__153">Flow 构建</a></li>
<li><a href="#Flow__170">Flow 冷流</a></li>
<li><a href="#Flow__214">Flow 取消</a></li>
<li><a href="#Flow__326">Flow 相关操作符</a></li>
<li>
<ul>
<li><a href="#_330">中间流操作符</a></li>
<li>
<ul>
<li><a href="#map_332">map</a></li>
<li><a href="#filter_358">filter</a></li>
</ul>
     </li>
<li><a href="#_382">变换操作符</a></li>
<li><a href="#size_408">size限制操作符</a></li>
<li><a href="#_441">终端操作符</a></li>
<li>
<ul>
<li><a href="#_toList__toSet_445">转换为各种集合， toList 和 toSet。</a></li>
<li><a href="#first___454">first , 确保获取且进获取第一个值</a></li>
<li><a href="#_reduce__fold__463">使用 reduce 和 fold 将流合并到一个值。</a></li>
<li><a href="#onEach_476">onEach</a></li>
</ul>
     </li>
<li><a href="#_496">操作符的顺序</a></li>
</ul>
    </li>
<li><a href="#Flow__526">Flow 调度器切换</a></li>
<li><a href="#Flow__611">Flow 背压处理</a></li>
<li>
<ul>
<li><a href="#buffer_621">buffer</a></li>
<li><a href="#conflate_659">conflate</a></li>
<li><a href="#collectLatest_687">collectLatest</a></li>
</ul>
    </li>
<li><a href="#Flow__721">Flow 异常处理</a></li>
<li>
<ul>
<li><a href="#trycatch_725">try...catch</a></li>
<li><a href="#catch__806">catch 相关运算符</a></li>
</ul>
    </li>
<li><a href="#Flow__948">Flow 启动</a></li>
</ul>
   </li>
<li><a href="#Flow_1014">Flow原理解析</a></li>
</ul>
 </li></ul>
</div>
<p></p> 
<h2>
<a id="Flow_2"></a>Flow</h2> 
<p>来了来了它终于来了，这篇本应在好几个个月前就需要发布的文章?。一拖再拖?，毕竟对于flow还是的有敬畏之心的，不好好研究一下真心不敢乱写，有什么问题，欢迎指出，欢迎私信技术交流?。那么现在就正式进入<code>Flow</code>的世界吧！</p> 
<h2>
<a id="Flow_4"></a>Flow简介</h2> 
<p><code>Flow</code>是什么❓</p> 
<blockquote> 
 <p>A suspending function asynchronously returns a single value, but how can we return multiple asynchronously computed values? This is where Kotlin Flows come in.</p> 
</blockquote> 
<p>简单来说：挂起函数可以异步处理并且返回单个值，但是如果要返回多个异步计算的值呢?这就是<code>flow</code>的用处了。下面从<code>如何返回多个值</code>开始一步一步深入了解<code>flow</code>。</p> 
<h2>
<a id="_12"></a>如何返回多个值？</h2> 
<h3>
<a id="For_example_1__list_14"></a>For example 1 : list</h3> 
<p>我们可以有一个简单的函数，它返回一个包含三个数字的列表，然后使用 forEach 将它们全部打印出来：</p> 
<pre><code class="prism language-kotin">fun simple(): List&lt;Int&gt; = listOf(1, 2, 3)
 
fun main() {
    simple().forEach { value -&gt; println(value) } 
}
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-kotlin"><span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
</code></pre> 
<h3>
<a id="For_example_2__Sequences_34"></a>For example 2 : Sequences</h3> 
<p>如果我们需要阻塞代码来计算数字（每次计算需要 100 毫秒），那么我们可以使用序列来表示数字：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Sequence<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> sequence <span class="token punctuation">{<!-- --></span> <span class="token comment">// sequence 构建</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//模拟计算耗时</span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"send<span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
        <span class="token comment">// yield 下一个值</span>
        <span class="token function">yield</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"receiver<span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-kotlin">send1
receiver1
send2
receiver2
send3
receiver3
end
</code></pre> 
<h3>
<a id="For_example_3__flow_67"></a>For example 3 : 异步计算并返回？引入flow</h3> 
<p>有什么办法可以异步计算多个值并且返回的吗？当然可以，我们可以使用挂起函数，使计算过程在异步线程执行，最终以list的形式返回。</p> 
<p>举个?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//模拟耗时操作</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">listOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span> runBlocking <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> job <span class="token operator">=</span> launch <span class="token punctuation">{<!-- --></span>
        <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    launch <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"other operate"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    job<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果：从结果来看，耗时操作并没有影响主线程的运行?</p> 
<pre><code>other operate
1
2
3
</code></pre> 
<p>但是，这样就够了吗？no no no ！?‍♀️</p> 
<p>使用<code>list</code>意味着我们只能一次性的返回所有的值。所以为了表示流的计算，引入了<code>flow</code>。就像可以使用<code>Sequence</code>类型用于同步计算值一样。</p> 
<h2>
<a id="Flow_104"></a>Flow使用</h2> 
<h3>
<a id="Flow__106"></a>Flow 简单使用</h3> 
<p>上面介绍了<code>flow</code>要解决什么问题，那么我们就开始使用起来吧。</p> 
<p>先看一个简单的?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> flow <span class="token punctuation">{<!-- --></span> <span class="token comment">// flow 构建</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//模拟异步耗时计算</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token comment">//发射值</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// launch 一个协程 同时延时100毫秒打印 校验主线程是否阻塞</span>
    launch <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"I'm not blocked <span class="token interpolation variable">$k</span>"</span><span class="token punctuation">)</span>
            <span class="token comment">//主线程在这个时间段可以干别的事情</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// collect flow value</span>
    <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> <span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果：通过线程打印 <code>I'm not blocked</code>证明异步计算不会阻塞主线程，计算成功之后会resume到collect里面继续执行。</p> 
<pre><code class="prism language-kotlin">I'm not blocked <span class="token number">1</span>
<span class="token number">1</span>
I'm not blocked <span class="token number">2</span>
<span class="token number">2</span>
I'm not blocked <span class="token number">3</span>
<span class="token number">3</span>
</code></pre> 
<p>通过上述代码，需要注意一下几点：?‍♀️</p> 
<ul>
<li>使用<code>flow</code>代码块构建出来的类型为<code>Flow</code>
</li>
<li>
<code>flow</code>代码块里面允许写挂起函数。比如上面的，<code>delay</code> <code>emit</code>。</li>
<li>使用<code>emit</code>进行值的发射，使用<code>collect</code>进行值的收集</li>
</ul> 
<h3>
<a id="Flow__153"></a>Flow 构建</h3> 
<p>除了上面使用的<code>flow{}</code>进行构建之外，还可以使用其他的方式进行构建。</p> 
<ol>
<li> <p>使用<code>flowOf</code>可以定义一组固定的值</p> <pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> </li>
<li> <p>可以使用 <code>asFlow()</code> 扩展函数将各种集合和序列转换为流。</p> <pre><code class="prism language-kotlin"><span class="token comment">// 将list转换为flow</span>
<span class="token function">listOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre> </li>
</ol> 
<h3>
<a id="Flow__170"></a>Flow 冷流</h3> 
<p>Flow是冷流，构建器代码在调用collect之前是不会进行调用的，对于多个调用者，都会重新走一遍构建器的代码。</p> 
<p>废话不多说，上?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> flow <span class="token punctuation">{<!-- --></span> 
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Flow started"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Calling simple function..."</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> flow <span class="token operator">=</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Calling collect..."</span><span class="token punctuation">)</span>
    flow<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">}</span> 
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Calling collect again..."</span><span class="token punctuation">)</span>
    flow<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-kotlin">Calling simple function<span class="token operator">..</span><span class="token punctuation">.</span>
Calling collect<span class="token operator">..</span><span class="token punctuation">.</span>
Flow started
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
Calling collect again<span class="token operator">..</span><span class="token punctuation">.</span>
Flow started
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>

</code></pre> 
<p>每次收集流时都会开始，这就是为什么我们再次调用 collect 时会看到“Flow started”的原因。</p> 
<h3>
<a id="Flow__214"></a>Flow 取消</h3> 
<p>如何取消一个Flow呢？</p> 
<p>Kotlin官方并没有提供flow取消的函数。啊 这？？？?听到这个是不是还满疑惑。且听我细细道来。</p> 
<p>Flow需要在协程里面使用，因为<code>collect</code>是挂起函数，另外基于冷流的特性，不调用<code>collect</code>构建器的代码压根不会走。所以只能是协程。那 我取消协程不就行了吗？?。好像之前有看到过有开发者提出过，是否要给flow单独加一个取消的函数，被Jetbrains无情的拒绝了，哈哈哈哈很搞笑。下面引用Kotlin官方的一段话。</p> 
<blockquote> 
 <p>Flow adheres to the general cooperative cancellation of coroutines. As usual, flow collection can be cancelled when the flow is suspended in a cancellable suspending function (like delay).</p> 
 <p>adheres 坚持</p> 
 <p>Flow 坚持协程的一般协作取消。 像往常一样，当流在可取消的挂起函数（如延迟）中被挂起时，可以取消流收集。</p> 
</blockquote> 
<p>这个<code>adheres</code>好像就像是在回复广大的开发者，你取消协程就行了???。</p> 
<p>好了，下面看取消的?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> flow <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"emit <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> job <span class="token operator">=</span> launch <span class="token punctuation">{<!-- --></span>
        <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> <span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span>
    job<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token function">CancellationException</span><span class="token punctuation">(</span><span class="token string">"timeout 250"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"done"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果：看我们只需要取消对应的协程即可，对应的flow也会被取消收集。</p> 
<pre><code class="prism language-kotlin">emit <span class="token number">1</span>
<span class="token number">1</span>
emit <span class="token number">2</span>
<span class="token number">2</span>
done
</code></pre> 
<p>这里引申一点，对于timeout，官方有提供专用的操作函数,withTimeout系列。不需要我们手动delay然后继续调用取消，毕竟不是很优雅。</p> 
<p>上述代码也可以写成如下的形式</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> flow <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"emit <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">withTimeoutOrNull</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"done"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>看到了吗？直接将launch替换为<code>withTimeoutOrNull</code>就可以做到延时取消效果了，这里简单做一下源码分析。</p> 
<pre><code class="prism language-kotlin">源码
<span class="token keyword">public</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">withTimeoutOrNull</span><span class="token punctuation">(</span>timeMillis<span class="token operator">:</span> Long<span class="token punctuation">,</span> block<span class="token operator">:</span> <span class="token keyword">suspend</span> CoroutineScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> T<span class="token punctuation">)</span><span class="token operator">:</span> T<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> suspendCoroutineUninterceptedOrReturn <span class="token punctuation">{<!-- --></span> uCont <span class="token operator">-&gt;</span>
            <span class="token keyword">val</span> timeoutCoroutine <span class="token operator">=</span> <span class="token function">TimeoutCoroutine</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">,</span> uCont<span class="token punctuation">)</span>
            coroutine <span class="token operator">=</span> timeoutCoroutine
            setupTimeout<span class="token operator">&lt;</span>T<span class="token operator">?</span><span class="token punctuation">,</span> T<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>timeoutCoroutine<span class="token punctuation">,</span> block<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> TimeoutCancellationException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> TimeoutCoroutine<span class="token operator">&lt;</span>U<span class="token punctuation">,</span> <span class="token keyword">in</span> T<span class="token operator">:</span> U<span class="token operator">&gt;</span><span class="token punctuation">(</span>
    <span class="token annotation builtin">@JvmField</span> <span class="token keyword">val</span> time<span class="token operator">:</span> Long<span class="token punctuation">,</span>
    uCont<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>U<span class="token operator">&gt;</span> <span class="token comment">// unintercepted continuation</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> ScopeCoroutine<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">(</span>uCont<span class="token punctuation">.</span>context<span class="token punctuation">,</span> uCont<span class="token punctuation">)</span><span class="token punctuation">,</span> Runnable <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">cancelCoroutine</span><span class="token punctuation">(</span><span class="token function">TimeoutCancellationException</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
	<span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>U<span class="token punctuation">,</span> T<span class="token operator">:</span> U<span class="token operator">&gt;</span> <span class="token function">setupTimeout</span><span class="token punctuation">(</span>
    coroutine<span class="token operator">:</span> TimeoutCoroutine<span class="token operator">&lt;</span>U<span class="token punctuation">,</span> T<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    block<span class="token operator">:</span> <span class="token keyword">suspend</span> CoroutineScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> T
<span class="token punctuation">)</span><span class="token operator">:</span> Any<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// schedule cancellation of this coroutine on time</span>
    coroutine<span class="token punctuation">.</span><span class="token function">disposeOnCompletion</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>delay<span class="token punctuation">.</span><span class="token function">invokeOnTimeout</span><span class="token punctuation">(</span>coroutine<span class="token punctuation">.</span>time<span class="token punctuation">,</span> coroutine<span class="token punctuation">,</span> coroutine<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
    
<span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token function">invokeOnTimeout</span><span class="token punctuation">(</span>timeMillis<span class="token operator">:</span> Long<span class="token punctuation">,</span> block<span class="token operator">:</span> Runnable<span class="token punctuation">,</span> context<span class="token operator">:</span> CoroutineContext<span class="token punctuation">)</span><span class="token operator">:</span> DisposableHandle <span class="token operator">=</span>
        DefaultDelay<span class="token punctuation">.</span><span class="token function">invokeOnTimeout</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">,</span> block<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
</code></pre> 
<p>省略了一大堆非核心的代码，我们直接看延时取消的操作，这里简单分析一下：</p> 
<ul>
<li>创建TimeoutCoroutine对象，它同时实现了Runnable，在run里面调用了取消函数，抛出TimeoutCancellationException。</li>
<li>调用当前context的invokeOnTimeout函数，该函数需要一个Runnable，传入了timeoutCoroutine。此实现使用内置的单线程调度执行器服务。会在延时对应的事件后调用Runnable的run函数，然后就会取消当前的协程。</li>
<li>在取消协程之后，会取消掉当前上下文的所有将在完成时调用的回调，disposeOnCompletion函数被调用。</li>
</ul> 
<h3>
<a id="Flow__326"></a>Flow 相关操作符</h3> 
<p>这一块的操作符，其实是比较多的。但是如果您熟悉RxJava的话，其实都是差不多的。这一块这里就不做源码分析了，只是看一下怎么使用即可。内部其实是创建了新的流返回出来了，有兴趣的话可以自行查看一下源码。</p> 
<h4>
<a id="_330"></a>中间流操作符</h4> 
<h5>
<a id="map_332"></a>map</h5> 
<p>映射。看?(传入请求流可以使用 map 操作符映射到结果，即使执行请求是由挂起函数实现的长时间运行的操作)</p> 
<pre><code class="prism language-kotlin">          
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">performRequest</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{<!-- --></span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">// 模拟长时间的异步工作</span>
    <span class="token keyword">return</span> <span class="token string">"response <span class="token interpolation variable">$request</span>"</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 转换为flow</span>
        <span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{<!-- --></span> request <span class="token operator">-&gt;</span> <span class="token function">performRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> response <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-kotlin">response <span class="token number">1</span>
response <span class="token number">2</span>
response <span class="token number">3</span>
</code></pre> 
<h5>
<a id="filter_358"></a>filter</h5> 
<p>过滤操作,看?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">performRequest</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{<!-- --></span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">// 模拟长时间的异步工作</span>
    <span class="token keyword">return</span> <span class="token string">"response <span class="token interpolation variable">$request</span>"</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 转换为flow</span>
        <span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{<!-- --></span> request <span class="token operator">-&gt;</span> <span class="token function">performRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">{<!-- --></span> it <span class="token operator">==</span> <span class="token string">"response 1"</span> <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> response <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果：仅返回匹配到的值</p> 
<pre><code>response 1
</code></pre> 
<h4>
<a id="_382"></a>变换操作符</h4> 
<p>在流变换算子中，最通用的一种叫做变换。 它可以用来模仿简单的转换，比如 map 和 filter，也可以实现更复杂的转换。 使用<code>transform</code>，我们可以发出任意次数的任意值。</p> 
<p>例如?，使用<code>transform</code>，我们可以在执行长时间运行的异步请求之前发出一个字符串，并在其后响应：</p> 
<pre><code class="prism language-kotlin"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// a flow of requests</span>
        <span class="token punctuation">.</span><span class="token function">transform</span> <span class="token punctuation">{<!-- --></span> request <span class="token operator">-&gt;</span>
            <span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"Making request <span class="token interpolation variable">$request</span>"</span><span class="token punctuation">)</span>
            <span class="token function">emit</span><span class="token punctuation">(</span><span class="token function">performRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> response <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-kotlin">Making request <span class="token number">1</span>
response <span class="token number">1</span>
Making request <span class="token number">2</span>
response <span class="token number">2</span>
Making request <span class="token number">3</span>
response <span class="token number">3</span>
</code></pre> 
<h4>
<a id="size_408"></a>size限制操作符</h4> 
<p>顾名思义，限制收集的数量。使用运算符<code>take</code></p> 
<p>它会在判断当发射的值在达到相应限制时取消流程的执行。 <strong>因为协程中的取消总是通过抛出异常来执行。所以需要考虑进行相应的异常捕获来保证后续的流畅正常进行不被取消掉</strong>。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">numbers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> flow <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>                          
        <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"not execute"</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"finally in numbers"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">numbers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// take 两个值</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>            
</code></pre> 
<p>结果</p> 
<pre><code>1
2
finally in numbers
</code></pre> 
<h4>
<a id="_441"></a>终端操作符</h4> 
<p>终端操作符可以启动一个流，最基础的就是上述常提到的<code>collect</code>。但是还有一些其他的终端操作符，它可能会让一些操作变得更简单：</p> 
<h5>
<a id="_toList__toSet_445"></a>转换为各种集合， toList 和 toSet。</h5> 
<pre><code class="prism language-kotlin">    <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token operator">::</span>println<span class="token punctuation">)</span>
</code></pre> 
<h5>
<a id="first___454"></a>first , 确保获取且进获取第一个值</h5> 
<p>返回流发出的第一个元素然后取消流的集合的终端运算符。 如果流为空，则抛出 NoSuchElementException。</p> 
<pre><code class="prism language-kotlin">    <span class="token keyword">val</span> value <span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
</code></pre> 
<h5>
<a id="_reduce__fold__463"></a>使用 reduce 和 fold 将流合并到一个值。</h5> 
<pre><code class="prism language-kotlin">    <span class="token keyword">val</span> sum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{<!-- --></span> it <span class="token operator">*</span> it <span class="token punctuation">}</span> <span class="token comment">//平方</span>
        <span class="token punctuation">.</span><span class="token function">reduce</span> <span class="token punctuation">{<!-- --></span> a<span class="token punctuation">,</span> b <span class="token operator">-&gt;</span> a <span class="token operator">+</span> b <span class="token punctuation">}</span> <span class="token comment">// 进行累加</span>
    <span class="token function">println</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
    <span class="token comment">//结果</span>
    <span class="token number">55</span>
</code></pre> 
<p>fold和reduce使用起来差不多，区别就是fold可以定义初始化，其实很简单，reduce传入的lambda前一个参数是每次计算的结果累计，后一个参数是当前需要传入的值，不明白可以去瞅一眼源码，这里不在引申。</p> 
<h5>
<a id="onEach_476"></a>onEach</h5> 
<p>这个操作符也较为常用，这里也介绍一下，返回在上游流的每个值向下游发出之前调用给定操作的流。</p> 
<p>?</p> 
<pre><code class="prism language-kotlin"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"onEach<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//结果</span>
onEach1
onEach2
onEach3
onEach4
onEach5
</code></pre> 
<h4>
<a id="_496"></a>操作符的顺序</h4> 
<p>除非使用对多个流进行操作的特殊运算符，否则流的每个单独集合都按顺序执行。 该集合直接在调用终端运算符的协程中工作。 默认情况下不会启动新的协程。 每个发出的值都由从上游到下游的所有中间操作符处理，然后交付给终端操作符。</p> 
<p>?</p> 
<pre><code class="prism language-kotlin"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Filter <span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
        it <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>              
    <span class="token punctuation">}</span>              
    <span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Map <span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
        <span class="token string">"string <span class="token interpolation variable">$it</span>"</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Collect <span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>    
<span class="token comment">//结果  按照顺序没有值依次向下发射</span>
Filter <span class="token number">1</span>
Filter <span class="token number">2</span>
Map <span class="token number">2</span>
Collect string <span class="token number">2</span>
Filter <span class="token number">3</span>
Filter <span class="token number">4</span>
Map <span class="token number">4</span>
Collect string <span class="token number">4</span>
Filter <span class="token number">5</span>
</code></pre> 
<h3>
<a id="Flow__526"></a>Flow 调度器切换</h3> 
<p>对于UI驱动型的程序来说，需要将长时间计算的任务放在异步线程处理，UI展示工作需要放在主线程处理。也就是说需要将构建器的代码放到异步线程执行，但是终端操作符，比如<code>collect</code>需要在主线程获取，那么怎么做呢？</p> 
<p>使用<code>flowOn</code>操作符</p> 
<p>在这之前您可能的了解一下，协程的调度器。可以简单参考之前写的一篇文章，有对调度器做简单介绍：https://blog.csdn.net/weixin_44235109/article/details/119981210</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{<!-- --></span>
    flow <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//模拟异步处理</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Emitting <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
            <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// emit next value</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">flowOn</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span><span class="token comment">//使用flowOn传入Default的调度器</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Collected <span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-kotlin"><span class="token number">16</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">954</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">1</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">969</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">1</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">071</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">2</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">071</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">2</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">178</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">3</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">178</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">3</span>
</code></pre> 
<p>可以很明显的看出，构建模块被调度到异步线程处理了。而收集的工作还在主线程进行。</p> 
<p><code>flowOn</code>负责构建的模块调度，那么收集的谁负责呢？</p> 
<p>其实和异常处理类似，collect受调用它的协程上下文限制，所以最后的执行线程和当前协程上下文的调度器有关，目前我使用的是<code>idea</code>测试的，默认<code>runBlocking</code>的调度器就是主线程。如果是android上面的话，<code>runBlocking</code>可能就需要传入<code>Dispatchers.Main</code>了。</p> 
<p>其实和RxJava还是非常相似的?。</p> 
<p><strong>注意一点，此时其实已经改变流执行的顺序了</strong>。</p> 
<p>官方的解释如下：</p> 
<blockquote> 
 <p>Another thing to observe here is that the flowOn operator has changed the default sequential nature of the flow. Now collection happens in one coroutine (“coroutine#1”) and emission happens in another coroutine (“coroutine#2”) that is running in another thread concurrently with the collecting coroutine. The flowOn operator creates another coroutine for an upstream flow when it has to change the CoroutineDispatcher in its context.</p> 
 <p>这里要注意的另一件事是 flowOn 运算符更改了流的默认顺序性质。 现在收集发生在一个协程（“coroutine#1”）中，发射发生在另一个协程（“coroutine#2”）中，该协程与收集协程同时运行在另一个线程中。 当必须在其上下文中更改 CoroutineDispatcher 时， flowOn 运算符为上游流创建另一个协程。</p> 
</blockquote> 
<p>这一块我简单看了一下源码，这里面不同的调度器会遇到多线程的问题，最里面使用了channel进行了调度处理。具体的核心类是<code>ChannelFlow</code>。后面会对<code>flow</code>进行简单源码分析，但篇幅有限不对这一块过深入分析，感兴趣可以自行查看，或找博主私下探讨。</p> 
<p>其实上面的看不出来会改变流执行的顺序，下面改变一下代码，验证一下看看?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{<!-- --></span>
    flow <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//模拟异步处理</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Emitting <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
            <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// emit next value</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">flowOn</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Collected <span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-kotlin"><span class="token number">16</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">258</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">1</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">386</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">2</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">482</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">1</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">493</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">3</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">684</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">2</span>
<span class="token number">16</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">887</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">3</span>
</code></pre> 
<p>我们只需要将，collect里面增加一个delay即可，发现其实这时候就是发射归发射，收集归收集了。不似上面我们写的程序，发射一个值只有到终端操作符之后才会发射第二个。这里面肯定就会对值进行缓存。<strong>那么就会牵扯到一个问题。老生常谈?‍♀️，背压处理</strong>！</p> 
<h3>
<a id="Flow__611"></a>Flow 背压处理</h3> 
<p>对于背压处理，Kotlin 提供三种解决方案：</p> 
<table>
<thead><tr>
<th>操作符</th>
<th>含义</th>
</tr></thead>
<tbody>
<tr>
<td>buffer</td>
<td>指定固定容量缓存</td>
</tr>
<tr>
<td>conflate</td>
<td>保留最新的值</td>
</tr>
<tr>
<td>collectLatest</td>
<td>新值发送时取消之前的</td>
</tr>
</tbody>
</table>
<h4>
<a id="buffer_621"></a>buffer</h4> 
<p>这里有必要看一下buffer函数的源码定义</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> Flow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>capacity<span class="token operator">:</span> Int <span class="token operator">=</span> BUFFERED<span class="token punctuation">,</span> onBufferOverflow<span class="token operator">:</span> BufferOverflow <span class="token operator">=</span> BufferOverflow<span class="token punctuation">.</span>SUSPEND<span class="token punctuation">)</span>
</code></pre> 
<p>可以看出需要两个参数，都有默认值。</p> 
<ul>
<li>第一个好理解容量，默认等于BUFFERED，这个值其实时64，可以按照使用时需要自己指定具体的数字。</li>
<li>第二个是指定，当buffer溢出时的操作，默认的操作是挂起。还要两个操作分别是删除最旧的值不要挂起或者删除当前最新的值不要挂起，可以自行查看源码，这里不再引申。</li>
</ul> 
<p>使用?</p> 
<pre><code class="prism language-kotlin">    flow <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//模拟异步处理</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Emitting <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
            <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// emit next value</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">flowOn</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Collected <span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token comment">//结果       </span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">420</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">1</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">536</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">2</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">646</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">1</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">646</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">3</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">846</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">2</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">049</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">3</span>
</code></pre> 
<h4>
<a id="conflate_659"></a>conflate</h4> 
<p>这个只获取最新值也比较好理解，应用场景，比如说获取下载进度，对于用户来说其实每次只需要获取当前最新的进度就好了，不需要把之前的值再去获取一遍，下面也举一个例子?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{<!-- --></span>
    flow <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//模拟异步处理</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Emitting <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
            <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// emit next value</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">flowOn</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">conflate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token comment">//模拟下游处理比较慢</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Collected <span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
<span class="token comment">//结果   第一个值肯定可以拿到 当地一个值处理完成之后  最新的值就是3了 所以丢弃了2</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">916</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">1</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">034</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">2</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">140</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">3</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">236</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">1</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">546</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">3</span>
</code></pre> 
<h4>
<a id="collectLatest_687"></a>collectLatest</h4> 
<p>说明一点：<strong>这玩意其实也是一个终端操作符</strong></p> 
<p>前两个可能都比较好理解，那<code>新值发送时取消之前的</code>是什么意思呢？为了便于理解，直接上例子，按照结果说明：</p> 
<p>?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{<!-- --></span>
    flow <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//模拟异步处理</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Emitting <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
            <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// emit next value</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">flowOn</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collectLatest</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Collected <span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//结果</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">916</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">1</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">038</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">2</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">150</span> <span class="token punctuation">[</span>DefaultDispatcher<span class="token operator">-</span>worker<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> Emitting <span class="token number">3</span>
<span class="token number">17</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">453</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Collected <span class="token number">3</span>
</code></pre> 
<p>对比上面的例子，这里只是将<code>collect</code>替换成了<code>collectLatest</code>而已。为什么<code>1</code>没有了呢？</p> 
<p>显而易见了，<strong>这玩意会在最新的到来会直接取消下游上一个消费的处理，因为有delay所以<code>1</code>还没有来得及打印，就因为下一个值发射了，然后就被取消了！！！您可真霸道呢</strong>??‍♀️</p> 
<h3>
<a id="Flow__721"></a>Flow 异常处理</h3> 
<p>当操作符内的发射器或代码抛出异常时，流收集可以以异常结束。 有几种方法可以处理这些异常。</p> 
<h4>
<a id="trycatch_725"></a>try…catch</h4> 
<p>较为简单，上?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> flow <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Emitting <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// emit next value</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span>         
            <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token function">check</span><span class="token punctuation">(</span>value <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"Collected <span class="token interpolation variable">$value</span>"</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Caught <span class="token interpolation variable">$e</span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token comment">//结果  </span>
<span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> flow <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Emitting <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// emit next value</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span>
            <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"exception value is <span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Caught <span class="token interpolation variable">$e</span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>显而易见，抛出异常之后，收集结束，如果是UI驱动程序比如：Android还是推荐主从作用域，异常不会向上传播。</p> 
<p>思考一个问题，刚刚异常是发生在收集端，如果在构建的时候发生异常呢？</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span>
    flow <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Emitting <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
            <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// emit next value</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"exception value is <span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token string">"string <span class="token interpolation variable">$value</span>"</span>
        <span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Caught <span class="token interpolation variable">$e</span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//结果</span>
Emitting <span class="token number">1</span>
string <span class="token number">1</span>
Emitting <span class="token number">2</span>
Caught java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IllegalStateException<span class="token operator">:</span> exception value <span class="token keyword">is</span> <span class="token number">2</span>
</code></pre> 
<p>完美：异常仍被捕获并停止收集</p> 
<p>上述代码的问题就是不够优雅，还有异常对于流来说必须是透明的，使用try … catch 显然违反了透明性,所以Kotlin 封装了try catch.</p> 
<h4>
<a id="catch__806"></a>catch 相关运算符</h4> 
<p>catch 运算符的主体可以分析异常并根据捕获的异常以不同的方式对其做出反应：</p> 
<ul>
<li>可以使用 throw 重新抛出异常。</li>
<li>可以使用 catch 主体中的发射将异常转换为值的发射。</li>
<li>异常可以被其他代码忽略、记录或处理。</li>
</ul> 
<p>看?</p> 
<pre><code class="prism language-kotlin"><span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span> <span class="token punctuation">{<!-- --></span> e <span class="token operator">-&gt;</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"Caught <span class="token interpolation variable">$e</span>"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment">// 我不仅捕获到了异常，我还能继续发射！！！！</span>
    <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-kotlin">Emitting <span class="token number">1</span>
string <span class="token number">1</span>
Emitting <span class="token number">2</span>
Caught java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IllegalStateException<span class="token operator">:</span> exception value <span class="token keyword">is</span> <span class="token number">2</span>
</code></pre> 
<p>当然因为抛出了异常，协程还是会终止，但是此时异常是以发生的形式传递下去的。</p> 
<p><strong>注意</strong>：catch 中间运算符，尊重异常透明性，<strong>只捕获上游异常（即来自 catch 之上的所有运算符的异常，但不在其之下）。 如果 collect { … } 中的块（位于 catch 下方）抛出异常</strong>，则它不会捕获：</p> 
<p>?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> flow <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Emitting <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span> <span class="token punctuation">{<!-- --></span> e <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Caught <span class="token interpolation variable">$e</span>"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment">// 不会捕获到下游的异常</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Collected <span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span>
            <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//</span>
Emitting <span class="token number">1</span>
<span class="token number">1</span>
Emitting <span class="token number">2</span>
Exception <span class="token keyword">in</span> thread <span class="token string">"main"</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IllegalStateException<span class="token operator">:</span> Collected <span class="token number">2</span>
	at org<span class="token punctuation">.</span>example<span class="token punctuation">.</span>zxf<span class="token punctuation">.</span>kotlin11<span class="token punctuation">.</span>flow<span class="token punctuation">.</span>TestFlowKt$main$<span class="token number">1</span>$invokeSuspend$$inlined$collect$<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>Collect<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">133</span><span class="token punctuation">)</span>
</code></pre> 
<p>这个时候可以利用onEach将需要可能捕获异常的地方前置，如下所示。</p> 
<pre><code class="prism language-kotlin"><span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span>
        <span class="token function">check</span><span class="token punctuation">(</span>value <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"Collected <span class="token interpolation variable">$value</span>"</span> <span class="token punctuation">}</span>                 
        <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">catch</span> <span class="token punctuation">{<!-- --></span> e <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Caught <span class="token interpolation variable">$e</span>"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>onCompletion 相关操作</p> 
<p>我们知道和try … catch 搭配的 还有一个finally。所以 flow当然也有一个差不多的了，叫<code>onCompletion</code></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> flow <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Emitting <span class="token interpolation variable">$i</span>"</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onCompletion</span> <span class="token punctuation">{<!-- --></span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//结果</span>
Emitting <span class="token number">1</span>
<span class="token number">1</span>
Emitting <span class="token number">2</span>
<span class="token number">2</span>
Emitting <span class="token number">3</span>
<span class="token number">3</span>
Done
</code></pre> 
<p>抛个异常试试,onCompletion可以通过cause进行判断是否是正常结束.</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> flow <span class="token punctuation">{<!-- --></span>
    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token function">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onCompletion</span> <span class="token punctuation">{<!-- --></span> cause <span class="token operator">-&gt;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Flow completed exceptionally"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">catch</span> <span class="token punctuation">{<!-- --></span> cause <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Caught exception"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//结果</span>
<span class="token number">1</span>
Flow completed exceptionally
Caught exception
</code></pre> 
<p>与 catch 运算符的另一个区别是 onCompletion 会看到所有异常，并且仅在成功完成上游流（没有取消或失败）时才会收到空异常。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onCompletion</span> <span class="token punctuation">{<!-- --></span> cause <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Flow completed with <span class="token interpolation variable">$cause</span>"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">-&gt;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"exception value is <span class="token interpolation variable">$value</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//结果</span>
<span class="token number">1</span>
Flow completed with java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IllegalStateException<span class="token operator">:</span> exception value <span class="token keyword">is</span> <span class="token number">2</span>
Exception <span class="token keyword">in</span> thread <span class="token string">"main"</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IllegalStateException<span class="token operator">:</span> exception value <span class="token keyword">is</span> <span class="token number">2</span>
</code></pre> 
<p>注意一点：<strong>虽然看到了，但是并没有进行捕获。异常还是抛出了</strong>。</p> 
<h3>
<a id="Flow__948"></a>Flow 启动</h3> 
<p>最后提一点和启动相关的，先看下面两个例子：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span> event <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Event: <span class="token interpolation variable">$event</span>"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// &lt;--- collect 挂起函数阻塞</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>   
<span class="token comment">//结果</span>
Event<span class="token operator">:</span> <span class="token number">1</span>
Event<span class="token operator">:</span> <span class="token number">2</span>
Event<span class="token operator">:</span> <span class="token number">3</span>
Done
</code></pre> 
<p>对于上述，没有异议吧，<code>Done</code>的打印需要等待<code>collect</code>恢复，因为在一个协程内。如果需要不等待呢？那就需要另起一个协程了</p> 
<p>?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    launch <span class="token punctuation">{<!-- --></span>
        <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span> event <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Event: <span class="token interpolation variable">$event</span>"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// &lt;--- collect 挂起函数阻塞</span>
    <span class="token punctuation">}</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//结果</span>
Done
Event<span class="token operator">:</span> <span class="token number">1</span>
Event<span class="token operator">:</span> <span class="token number">2</span>
Event<span class="token operator">:</span> <span class="token number">3</span>
</code></pre> 
<p>但是上述写法可以等价于，下面的写法，flow这玩意封装了另一种启动方式</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{<!-- --></span> event <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Event: <span class="token interpolation variable">$event</span>"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">launchIn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//结果</span>
Done
Event<span class="token operator">:</span> <span class="token number">1</span>
Event<span class="token operator">:</span> <span class="token number">2</span>
Event<span class="token operator">:</span> <span class="token number">3</span>
</code></pre> 
<p>看一下launchIn源码！</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> Flow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">launchIn</span><span class="token punctuation">(</span>scope<span class="token operator">:</span> CoroutineScope<span class="token punctuation">)</span><span class="token operator">:</span> Job <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// tail-call</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>好吧，其实不就是封装了一下嘛。主要是源码好多地方使用<code>launchIn</code>来着，所以这里提一下?‍♀️。</p> 
<h2>
<a id="Flow_1014"></a>Flow原理解析</h2> 
<p>好吧，激动人心的时刻终于来了，做一些源码分析。</p> 
<p>先写一个小?</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{<!-- --></span>
    flow <span class="token punctuation">{<!-- --></span>
        <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>好了，我们就分析这玩意怎么实现的！往深篇幅有限写不下了?。如果您想深入交流，欢迎私信交流。</p> 
<p>所以，我先列出来<code>flow</code>函数构建的源码，只贴出核心代码：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">flow</span><span class="token punctuation">(</span><span class="token annotation builtin">@BuilderInference</span> block<span class="token operator">:</span> <span class="token keyword">suspend</span> FlowCollector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span><span class="token operator">:</span> Flow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">SafeFlow</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span>
<span class="token comment">// Named anonymous object</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> SafeFlow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> block<span class="token operator">:</span> <span class="token keyword">suspend</span> FlowCollector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token operator">:</span> AbstractFlow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">collectSafely</span><span class="token punctuation">(</span>collector<span class="token operator">:</span> FlowCollector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        collector<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看出<code>flow</code>构建了一个<code>SafeFlow</code>将<code>block</code>传入。并且重写了<code>collectSafely</code>方法，调用了<code>block()</code>。这里需要注意一点<code>SafeFlow</code>继承自<code>AbstractFlow</code>.</p> 
<p>好，我们在看一调用<code>collect</code>之后发生了什么。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">public</span> <span class="token keyword">suspend</span> <span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> Flow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">crossinline</span> action<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span>
    <span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> FlowCollector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">emit</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> AbstractFlow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">:</span> Flow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span> CancellableFlow<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">collect</span><span class="token punctuation">(</span>collector<span class="token operator">:</span> FlowCollector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> safeCollector <span class="token operator">=</span> <span class="token function">SafeCollector</span><span class="token punctuation">(</span>collector<span class="token punctuation">,</span> coroutineContext<span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">collectSafely</span><span class="token punctuation">(</span>safeCollector<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            safeCollector<span class="token punctuation">.</span><span class="token function">releaseIntercepted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>	
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">collectSafely</span><span class="token punctuation">(</span>collector<span class="token operator">:</span> FlowCollector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>看的出，这时将collect的<code>block</code>封装成了<code>FlowCollector</code>类型（重写emit方法用于执行<code>block</code>），此时会调用到<code>SafeFlow</code>的<code>collect</code>方法，具体在<code>AbstractFlow</code>里面实现。这里面干了什么呢？看的出，创建了<code>SafeCollector</code>类型的东西，然后将<code>SafeCollector</code>传递给了<code>collectSafely</code>。而在上面的分析中，我们知道<code>collectSafely</code>在构建<code>flow</code>时进行了实现，<code>SafeCollector</code>作为receiver以扩展函数的形式调用了，flow构建器的<code>block</code>(这里面执行了，我们手动的emit操作)。这么一看是不是有点联系起来了?</p> 
<p>好的，接下来我们继续分析一下，<code>SafeCollector</code>，那这玩意的源码其实也是有点多的，我们应该看哪一个函数呢？通过上面的分析可知，调用<code>collect</code>之后，会调用到<code>SafeFlow</code>的<code>collect</code>方法，进而会以扩展函数的形式调用到<code>flow</code>的block，而在block里面就是我们自己写的emit了，所以receiver既然是<code>SafeCollector</code>,那肯定就是调用<code>SafeCollector</code>的emit了，我们去瞅一瞅<code>SafeCollector</code>的emit函数相关的调用链:?</p> 
<pre><code class="prism language-kotlin">	<span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">emit</span><span class="token punctuation">(</span>value<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token operator">..</span><span class="token punctuation">.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">emit</span><span class="token punctuation">(</span>uCont<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">..</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">emit</span><span class="token punctuation">(</span>uCont<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> T<span class="token punctuation">)</span><span class="token operator">:</span> Any<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token function">emitFun</span><span class="token punctuation">(</span>collector <span class="token keyword">as</span> FlowCollector<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">this</span> <span class="token keyword">as</span> Continuation<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> emitFun <span class="token operator">=</span>
    FlowCollector<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">::</span>emit <span class="token keyword">as</span> Function3<span class="token operator">&lt;</span>FlowCollector<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> Continuation<span class="token operator">&lt;</span>Unit<span class="token operator">&gt;</span><span class="token punctuation">,</span> Any<span class="token operator">?</span><span class="token operator">&gt;</span>
    
</code></pre> 
<p>好了，经过简化之后，就是上面这些玩意儿了。</p> 
<p>首先，需要分清几个东西。</p> 
<p><code>collector</code>和<code>this</code>的区别</p> 
<ul>
<li>collector：还记得上面的源码吗？我们调用<code>collect</code>的block封装到了一个<code>FlowCollector</code>，然后传递给了<code>SafeCollector</code>，collector就指<code>FlowCollector</code>。这里面重写了emit，emit里面调用了<code>block</code>，这个<code>block</code>就是我们自己写的了，这个时间简单理解调用collector的emit就可以调用到collect的<code>block</code>了。</li>
<li>this：理解了collector，this就指代当前的<code>SafeCollector</code>了。</li>
</ul> 
<p>现在我们继续看上面的代码：额 此时好像还需要理解一个东西emitFun</p> 
<p>我们把它翻译成java看一下</p> 
<pre><code class="prism language-java">   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Function3</span> emitFun <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Function3</span><span class="token punctuation">)</span><span class="token class-name">TypeIntrinsics</span><span class="token punctuation">.</span><span class="token function">beforeCheckcastToFunctionOfArity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// $FF: synthetic method</span>
      <span class="token comment">// $FF: bridge method</span>
      <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">,</span> <span class="token class-name">Object</span> var2<span class="token punctuation">,</span> <span class="token class-name">Object</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FlowCollector</span><span class="token punctuation">)</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Continuation</span><span class="token punctuation">)</span>var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Nullable</span>
      <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">FlowCollector</span> p1<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> p2<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">Continuation</span> continuation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">return</span> p1<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> continuation<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>简单明了，就是调用了collector的emit函数，但是你可能会说，emit不是支持一个参数吗？上面传进去俩啊，但是你别忘了，emit是挂起函数，默认有一个参数的传递就是continuation，这一块Kotlin替我们做了，但是对于Java来说必须要传递continuation进去。通过这种方式传入一样的continuation。保证了continuation的统一。</p> 
<p><strong>好了，总结一下：</strong></p> 
<p>分析下来，简单就是，利用扩展函数的性质，调用到<code>flow</code>的block进而调用了<code>SafeCollector</code>的emit，而这里的emit会调用到传进来的FlowCollector的emit，而传进来的emit函数被重写调用block，所以就会调用到collect的block了。</p> 
<p>另外因为，只有调用collect之后，进而才会调用到<code>SafeFlow</code>的collect函数，进而才会调用到<code>collectSafely</code>函数去执行flow的代码。<strong>所以不调用collect的话，flow的代码构建块的代码是不会执行的，最多就是返回一个<code>SafeFlow</code>的对象而已</strong>。</p> 
<p>对于各种操作符的源码，这里不带着大家看了，不是很难，里面就是饶了一圈，又返回了流而已。可以自己查看。</p> 
<p>另外对于flowOn或者其他操作符，导致调度器不一致时，此时底层将不再上上面这一套的逻辑，内部是使用<code>ChannelFlow</code>实现。这一块感兴趣的也可以瞅瞅源码，也可以与博主私信交流，里面还是比较绕。。。</p> 
<p>还有还有补充一点，对于<code>ShareFlow</code>和<code>StateFlow</code>，博主目前也在积极的筹划中，想了解的可以关注一波哈。如果您看到这里的话，觉得不错，希望您可以毫不吝啬手中的赞?，鼓励一下博主，感谢！<br> <img src="https://images2.imgbox.com/50/99/1FCyYVee_o.png" alt="在这里插入图片描述"></p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>