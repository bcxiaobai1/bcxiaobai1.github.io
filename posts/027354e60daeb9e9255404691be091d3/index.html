<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Kubernetes中Pod的扩缩容介绍 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kubernetes中Pod的扩缩容介绍</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-github-gist">
                    
                        
                    
                    <h2>
<a id="KubernetesPod_0"></a>Kubernetes中Pod的扩缩容介绍</h2> 
<p>在实际生产系统中，我们经常会遇到某个服务需要扩容的场景，也可能会遇到由于资源紧张或者工作负载降低而需</p> 
<p>要减少服务实例数量的场景。此时可以利用 Deployment/RC 的 Scale 机制来完成这些工作。</p> 
<p>Kubernetes 对 Pod 的扩缩容操作提供了手动和自动两种模式，手动模式通过执行 <code>kubectl scale</code> 命令或通过</p> 
<p>RESTful API 对一个 Deployment/RC 进行 Pod 副本数量的设置，即可一键完成。自动模式则需要用户根据某个性</p> 
<p>能指标或者自定义业务指标，并指定 Pod 副本数量的范围，系统将自动在这个范围内根据性能指标的变化进行调</p> 
<p>整。</p> 
<h3>
<a id="1_14"></a>1、手动扩缩容</h3> 
<p>下面以 Deployment nginx 为例进行手动扩缩容的演示。</p> 
<p>配置文件 <code>037-nginx-deployment.yaml</code> 的内容为：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.7.9
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 037-nginx-deployment.yaml</span>
deployment.apps/nginx-deployment created
</code></pre> 
<p>已运行的 Pod 副本数量为3个：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get pod</span>
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-5c5f6c4496-br6jv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          56s
nginx-deployment-5c5f6c4496-mr24j   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          56s
nginx-deployment-5c5f6c4496-z8jh2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          56s
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment</span>
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           76s
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get rs</span>
NAME                          DESIRED   CURRENT   READY   AGE
nginx-deployment-5c5f6c4496   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       79s
</code></pre> 
<p>通过 <code>kubectl scale</code> 命令可以将 Pod 副本数量从初始的 3 个更新为 5 个：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl scale deployment nginx-deployment --replicas 5</span>
deployment.apps/nginx-deployment scaled
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get pod</span>
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-5c5f6c4496-2565s   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          40s
nginx-deployment-5c5f6c4496-b4d87   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          40s
nginx-deployment-5c5f6c4496-br6jv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m34s
nginx-deployment-5c5f6c4496-mr24j   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m34s
nginx-deployment-5c5f6c4496-z8jh2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m34s
</code></pre> 
<p>将 --replicas 设置为比当前 Pod 副本数量更小的数字，系统将会杀掉一些运行中的 Pod，以实现应用集群缩容：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl scale deployment nginx-deployment --replicas=1</span>
deployment.apps/nginx-deployment scaled
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get pod</span>
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-5c5f6c4496-br6jv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m18s
</code></pre> 
<h3>
<a id="2_99"></a>2、自动扩缩容机制</h3> 
<p>Kubernetes 从 1.1 版本开始，新增了名为 <code>Horizontal Pod Autoscaler(HPA)</code> 的控制器，用于实现基于 CPU使</p> 
<p>用率进行自动 Pod 扩缩容的功能。HPA 控制器基于 Master 的 kube-controller-manager 服务启动参数</p> 
<p><code>--horizontal-pod-autoscaler-sync-period </code>定义的探测周期(默认值为<code>15s</code>)，周期性地监测目标 Pod 的资源</p> 
<p>性能指标，并与 HPA 资源对象中的扩缩容条件进行对比，在满足条件时对 Pod 副本数量进行调整。</p> 
<p>Kubernetes 在早期版本中，只能基于 Pod 的 CPU 使用率进行自动扩缩容操作，关于 CPU 使用率的数据来源于</p> 
<p>Heapster 组件。Kubernetes 从 1.6 版本开始，引入了基于应用自定义性能指标的 HPA 机制，并在 1.9 版本之后</p> 
<p>逐步成熟。本节对 Kubernetes 的 HPA 的原理和实践进行详细说明。</p> 
<h4>
<a id="21_HPA_115"></a>2.1 HPA的工作原理</h4> 
<p>Kubernetes 中的某个 <code>Metrics Server</code>( Heapster 或自定义 Metrics Server )持续采集所有 Pod 副本的指标数</p> 
<p>据。HPA 控制器通过 Metrics Server 的 API ( Heapster 的 API 或聚合 API ) 获取这些数据，基于用户定义的扩缩</p> 
<p>容规则进行计算，得到目标 Pod 副本数量。当目标 Pod 副本数量与当前副本数量不同时，HPA 控制器就向 Pod</p> 
<p>的副本控制器( Deployment、RC 或 ReplicaSet )发起 scale 操作，调整 Pod 的副本数量，完成扩缩容操作。下图</p> 
<p>描述了 HPA 体系中的关键组件和工作流程。</p> 
<p><img src="https://images2.imgbox.com/90/43/uSnxlX2R_o.png" alt="在这里插入图片描述"></p> 
<p>接下来首先对HPA能够管理的指标类型、扩缩容算法、HPA 对象的配置进行详细说明，然后通过一个完整的示例</p> 
<p>对如何搭建和使用基于自定义指标的 HPA 体系进行说明。</p> 
<h4>
<a id="22__134"></a>2.2 指标的类型</h4> 
<p>Master 的 kube-controller-manager 服务持续监测目标 Pod 的某种性能指标，以计算是否需要调整副本数量。</p> 
<p>目前 Kubernetes 支持的指标类型如下：</p> 
<ul>
<li> <p>Pod 资源使用率：Pod 级别的性能指标，通常是一个比率值，例如 CPU 使用率。</p> </li>
<li> <p>Pod 自定义指标：Pod 级别的性能指标，通常是一个数值，例如接收的请求数量。</p> </li>
<li> <p>Object 自定义指标或外部自定义指标：通常是一个数值，需要容器应用以某种方式提供，例如通过</p> <p><code>HTTP URL "/metrics"</code> 提供，或者使用外部服务提供的指标采集 URL。</p> </li>
</ul> 
<p>Kubernetes 从 1.11 版本开始，弃用基于 Heapster 组件完成 Pod 的 CPU 使用率采集的机制，全面转向基于</p> 
<p>Metrics Server 完成数据采集。Metrics Server 将采集到的 Pod 性能指标数据通过聚合API(Aggregated API) 如</p> 
<p><code>metrics.k8s.io</code>、<code>custom.metrics.k8s.io</code> 和 <code>external.metrics.k8s.io</code>提供给HPA控制器进行查询。</p> 
<h4>
<a id="23__154"></a>2.3 扩缩容算法详解</h4> 
<p>Autoscaler 控制器从聚合 API 获取到 Pod 性能指标数据之后，基于下面的算法计算出目标 Pod 副本数量，与当前</p> 
<p>运行的 Pod 副本数量进行对比，决定是否需要进行扩缩容操作：</p> 
<pre><code class="prism language-shell"><span class="token assign-left variable">desiredReplicas</span><span class="token operator">=</span>ceil<span class="token punctuation">[</span>currentReplicas*<span class="token punctuation">(</span>currentMetricValue/desiredMetricValue <span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<p>即当前副本数×(当前指标值/期望的指标值)，将结果向上取整。</p> 
<p>以 CPU 请求数量为例，如果用户设置的期望指标值为 100m，当前实际使用的指标值为 200m，则计算得到期望</p> 
<p>的 Pod 副本数量应为两个( 200/100=2 )。如果设置的期望指标值为 50m，计算结果为 0.5，则向上取整值为 1，</p> 
<p>得到目标 Pod 副本数量应为 1 个。</p> 
<p>当计算结果与 1 非常接近时，可以设置一个容忍度让系统不做扩缩容操作。容忍度通过</p> 
<p><code>kube-controller-manager</code> 服务的启动参数 <code>--horizontal-pod-autoscaler-tolerance</code> 进行设置，默认值</p> 
<p>为 0.1(即10%)，表示基于上述算法得到的结果在 [-10%-+10%] 区间内，即 [0.9-1.1]，控制器都不会进行扩缩容操</p> 
<p>作。</p> 
<p>也可以将期望指标值( <code>desiredMetricValue</code> )设置为指标的平均值类型，例如 <code>targetAverageValue</code> 或</p> 
<p><code>targetAverageUtilization</code>，此时当前指标值(<code>currentMetricValue</code>)的算法为所有 Pod 副本当前指标值的总</p> 
<p>和除以 Pod 副本数量得到的平均值。</p> 
<p>此外，存在几种 Pod 异常的情况，如下所述：</p> 
<ul>
<li> <p>Pod 正在被删除(设置了删除时间戳)：将不会计入目标 Pod 副本数量。</p> </li>
<li> <p>Pod 的当前指标值无法获得：本次探测不会将这个 Pod 纳入目标 Pod 副本数量，后续的探测会被重新纳入计</p> <p>算范围。</p> </li>
<li> <p>如果指标类型是 CPU 使用率，则对于正在启动但是还未达到 Ready 状态的 Pod，也暂时不会纳入目标副本数</p> <p>量范围。可以通过 <code>kube-controller-manager</code> 服务的启动参数</p> <p><code>--horizontal-pod-autoscaler-initial-readiness-delay</code> 设置首次探测 Pod 是否 Ready 的延时时间，</p> <p>默认值为 <code>30s</code> 。另一个启动参数 <code>--horizontal-pod-autoscaler-cpuinitialization-period</code> 设置首次</p> <p>采集 Pod 的 CPU 使用率的延时时间。</p> </li>
</ul> 
<p>在计算当前指标值/期望的指标值 (<code>currentMetricValue / desiredMetricValue</code>) 时将不会包括上述这些异常</p> 
<p>Pod。</p> 
<p>当存在缺失指标的 Pod 时，系统将更保守地重新计算平均值。系统会假设这些 Pod 在需要缩容(Scale Down)时消</p> 
<p>耗了期望指标值的100%，在需要扩容(Scale Up)时消耗了期望指标值的0%，这样可以抑制潜在的扩缩容操作。</p> 
<p>此外，如果存在未达到 Ready 状态的 Pod，并且系统原本会在不考虑缺失指标或 NotReady 的 Pod 情况下进行扩</p> 
<p>展，则系统仍然会保守地假设这些 Pod 消耗期望指标值的0%，从而进一步抑制扩容操作。</p> 
<p>如果在 <code>HorizontalPodAutoscaler</code> 中设置了多个指标，系统就会对每个指标都执行上面的算法，在全部结果中</p> 
<p>以期望副本数的最大值为最终结果。如果这些指标中的任意一个都无法转换为期望的副本数(例如无法获取指标的</p> 
<p>值)，系统就会跳过扩缩容操作。</p> 
<p>最后，在 HPA 控制器执行扩缩容操作之前，系统会记录扩缩容建议信息(<code>Scale Recommendation</code>)。控制器会在</p> 
<p>操作时间窗口(时间范围可以配置)中考虑所有的建议信息，并从中选择得分最高的建议。这个值可通过</p> 
<p><code>kube-controller-manager </code>服务的启动参数</p> 
<p><code>--horizontal-pod-autoscaler-downscale-stabilization-window</code> 进行配置，默</p> 
<p>认值为<code>5min</code>。这个配置可以让系统更为平滑地进行缩容操作，从而消除短时间内指标值快速波动产生的影响。</p> 
<h4>
<a id="24_HorizontalPodAutoscaler_232"></a>2.4 HorizontalPodAutoscaler配置详解</h4> 
<p>Kubernetes 将 HorizontalPodAutoscaler 资源对象提供给用户来定义扩缩容的规则。</p> 
<p>HorizontalPodAutoscaler 资源对象处于 Kubernetes 的 API 组 autoscaling 中，目前包括 v1 和 v2 两个版本。</p> 
<p>其中 <code>autoscaling/v1</code> 仅支持基于 CPU 使用率的自动扩缩容，<code>autoscaling/v2</code> 则用于支持基于任意指标的自</p> 
<p>动扩缩容配置，包括基于资源使用率、Pod 指标、其他指标等类型的指标数据，当前版本为</p> 
<p><code>autoscaling/v2beta2</code>。</p> 
<p>下面对 HorizontalPodAutoscaler 的配置和用法进行说明。</p> 
<p>（1）基于 <code>autoscaling/v1</code> 版本的 HorizontalPodAutoscaler 配置，仅可以设置 CPU 使用率。</p> 
<p>配置文件 <code>038-php-apache.yaml</code> 的内容为：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre> 
<p>主要参数如下：</p> 
<ul>
<li> <p><code>scaleTargetRef</code>：目标作用对象，可以是 Deployment、ReplicationController 或 ReplicaSet。</p> </li>
<li> <p><code>targetCPUUtilizationPercentage</code>：期望每个 Pod 的 CPU 使用率都为 50%，该使用率基于 Pod 设置的</p> <p>CPU Request 值进行计算，例如该值为 200m，那么系统将维持 Pod 的实际 CPU 使用值为 100m。</p> </li>
<li> <p><code>minReplicas</code> 和 <code>maxReplicas</code>：Pod 副本数量的最小值和最大值，系统将在这个范围内进行自动扩缩容操</p> <p>作，并维持每个 Pod 的 CPU 使用率为 50%。</p> </li>
</ul> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 038-php-apache.yaml</span>
horizontalpodautoscaler.autoscaling/php-apache created
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa</span>
NAME         REFERENCE               TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/50%   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">0</span>          17s
</code></pre> 
<p>为了使用 <code>autoscaling/v1</code> 版本的 HorizontalPodAutoscaler，需要预先安装 <code>Heapster</code> 组件或 <code>Metrics </code></p> 
<p><code>Server</code>，用于采集 Pod 的 CPU 使用率。Heapster 从 Kubernetes 1.11 版本开始进入弃用阶段，本节不再对</p> 
<p>Heapster 进行详细说明，本节主要对基于自定义指标进行自动扩缩容的设置进行说明。</p> 
<p>（2）基于 <code>autoscaling/v2beta2</code> 的 HorizontalPodAutoscaler 配置。</p> 
<p>配置文件 <code>039-php-apache.yaml</code> 的内容为：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
      <span class="token key atrule">resource</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu
        <span class="token key atrule">target</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> Utilization
          <span class="token key atrule">averageUtilization</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre> 
<p>主要参数如下。</p> 
<ul>
<li> <p><code>scaleTargetRef</code>：目标作用对象，可以是 Deployment、ReplicationController 或 ReplicaSet。</p> </li>
<li> <p><code>minReplicas</code> 和 <code>maxReplicas</code>：Pod 副本数量的最小值和最大值，系统将在这个范围内进行自动扩缩容操</p> <p>作，并维持每个 Pod 的 CPU 使用率为 50%。</p> </li>
<li> <p><code>metrics</code>：目标指标值，在 metrics 中通过参数 type 定义指标的类型。通过参数 target 定义相应的指标目标</p> <p>值，系统将在指标数据达到目标值时(考虑容忍度的区间)触发扩缩容操作。</p> </li>
</ul> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 039-php-apache.yaml</span>
horizontalpodautoscaler.autoscaling/php-apache created
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa</span>
NAME         REFERENCE               TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/50%   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">0</span>          5s
</code></pre> 
<p>等价写法，配置文件 <code>040-php-apache.yaml</code> 的内容为：</p> 
<pre><code class="prism language-yaml"><span class="token comment"># 版本要修改</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
      <span class="token key atrule">resource</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu
        <span class="token comment"># 整合在一起的写法</span>
        <span class="token key atrule">targetAverageUtilization</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 040-php-apache.yaml</span>
horizontalpodautoscaler.autoscaling/php-apache created
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa</span>
NAME         REFERENCE               TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/50%   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">0</span>          12s
</code></pre> 
<p>可以将 metrics 中的 type(指标类型)设置为以下三种，可以设置一个或多个组合，如下所述。</p> 
<p>（1）<code>Resource</code>：基于资源的指标值，可以设置的资源为 CPU 和内存。</p> 
<p>（2）<code>Pods</code>：基于 Pod 的指标，系统将对全部 Pod 副本的指标值进行平均值计算。</p> 
<p>（3）<code>Object</code>：基于某种资源对象(如Ingress)的指标或应用系统的任意自定义指标。</p> 
<p>Resource 类型的指标可以设置 CPU 和内存。对于 CPU 使用率，在 target 参数中设置 averageUtilization 定义目</p> 
<p>标平均 CPU 使用率。对于内存资源，在 target 参数中设置 AverageValue 定义目标平均内存使用值。指标数据可</p> 
<p>以通过 <code>API "metrics.k8s.io" </code>进行查询，要求预先启动 <code>Metrics Server</code> 服务。</p> 
<p>target.type 的取值为：Utilization、AverageValue</p> 
<p>target 对应的取值为：averageUtilization、averageValue</p> 
<p>关于内存的配置，配置文件 <code>041-php-apache.yaml</code> 的内容为：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
      <span class="token key atrule">resource</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> memory
        <span class="token key atrule">target</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> AverageValue
          <span class="token key atrule">averageValue</span><span class="token punctuation">:</span> 100Mi
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 041-php-apache.yaml</span>
horizontalpodautoscaler.autoscaling/php-apache created
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa</span>
NAME         REFERENCE               TARGETS           MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/100Mi   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">0</span>          6s
</code></pre> 
<p>等价写法，配置文件 `` 的内容为：</p> 
<pre><code class="prism language-yaml"><span class="token comment"># 版本要修改</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
      <span class="token key atrule">resource</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu
        <span class="token comment"># 整合在一起的写法</span>
        <span class="token key atrule">targetAverageValue</span><span class="token punctuation">:</span> 100Mi
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 042-php-apache.yaml</span>
horizontalpodautoscaler.autoscaling/php-apache created
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa</span>
NAME         REFERENCE               TARGETS           MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/100Mi   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">0</span>          13s
</code></pre> 
<p>Pods 类型和 Object 类型都属于自定义指标类型，指标的数据通常需要搭建自定义 Metrics Server 和监控工具进</p> 
<p>行采集和处理。指标数据可以通过 <code>API "custom.metrics.k8s.io"</code> 进行查询，要求预先启动自定义 <code>Metrics </code></p> 
<p><code>Server</code> 服务。</p> 
<p>类型为 Pods 的指标数据来源于 Pod 对象本身，其 target 指标类型只能使用 AverageValue。</p> 
<p>配置文件 <code>043-php-apache.yaml</code> 的内容为：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>          
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Pods
      <span class="token key atrule">pods</span><span class="token punctuation">:</span>
        <span class="token key atrule">metric</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> packets<span class="token punctuation">-</span>per<span class="token punctuation">-</span>second
        <span class="token key atrule">target</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> AverageValue
          <span class="token key atrule">averageValue</span><span class="token punctuation">:</span> 1k
</code></pre> 
<p>其中，设置 Pod 的指标名为 packets-per-second，在目标指标平均值为 1000 时触发扩缩容操作。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 043-php-apache.yaml</span>
horizontalpodautoscaler.autoscaling/php-apache created
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa</span>
NAME         REFERENCE               TARGETS        MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/1k   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">0</span>          4s
</code></pre> 
<p>类型为 Object 的指标数据来源于其他资源对象或任意自定义指标，其 target 指标类型可以使用 Value 或</p> 
<p>AverageValue (根据Pod副本数计算平均值)进行设置。</p> 
<p>下面对几种常见的自定义指标给出示例和说明：</p> 
<p>例1，设置指标的名称为 <code>requests-per-second</code>，其值来源于 <code>Ingress "main-route"</code>，将目标值(<code>value</code>)设置</p> 
<p>为<code>2000</code>，即在<code>Ingress</code>的每秒请求数量达到<code>2000</code>个时触发扩缩容操作。</p> 
<p>配置文件 <code>044-php-apache.yaml</code> 的文件内容为：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>          
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Object
      <span class="token key atrule">object</span><span class="token punctuation">:</span>
        <span class="token key atrule">metric</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> requests<span class="token punctuation">-</span>per<span class="token punctuation">-</span>second
        <span class="token key atrule">describedObject</span><span class="token punctuation">:</span>
          <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
          <span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
          <span class="token key atrule">name</span><span class="token punctuation">:</span> main<span class="token punctuation">-</span>route
        <span class="token key atrule">target</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> Value
          <span class="token key atrule">value</span><span class="token punctuation">:</span> 2k
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 044-php-apache.yaml</span>
horizontalpodautoscaler.autoscaling/php-apache created
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa</span>
NAME         REFERENCE               TARGETS        MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/2k   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">0</span>          4s
</code></pre> 
<p>例2，设置指标的名称为 <code>http_requests</code>，并且该资源对象具有标签 <code>verb=GET</code>，在指标平均值达到<code>500</code>时触发</p> 
<p>扩缩容操作。</p> 
<p>配置文件 <code>045-php-apache.yaml</code> 的内容为：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>          
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Object
      <span class="token key atrule">object</span><span class="token punctuation">:</span>
        <span class="token key atrule">metric</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> http_requests
          <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">verb</span><span class="token punctuation">:</span> GET<span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">describedObject</span><span class="token punctuation">:</span>
          <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
          <span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
          <span class="token key atrule">name</span><span class="token punctuation">:</span> main<span class="token punctuation">-</span>route
        <span class="token key atrule">target</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> AverageValue
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">500</span>
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 045-php-apache.yaml</span>
horizontalpodautoscaler.autoscaling/php-apache created
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa</span>
NAME         REFERENCE               TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/500   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">0</span>          5s
</code></pre> 
<p>还可以在同一个 HorizontalPodAutoscaler 资源对象中定义多个类型的指标，系统将针对每种类型的指标都计算</p> 
<p>Pod 副本的目标数量，以最大值为准进行扩缩容操作。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
      <span class="token key atrule">resource</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu
        <span class="token key atrule">target</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> Utilization
          <span class="token key atrule">averageUtilization</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
      <span class="token key atrule">resource</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> memory
        <span class="token key atrule">target</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> AverageValue
          <span class="token key atrule">averageValue</span><span class="token punctuation">:</span> 100Mi
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Pods
      <span class="token key atrule">pods</span><span class="token punctuation">:</span>
        <span class="token key atrule">metric</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> packets<span class="token punctuation">-</span>per<span class="token punctuation">-</span>second
        <span class="token key atrule">target</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> AverageValue
          <span class="token key atrule">averageValue</span><span class="token punctuation">:</span> 1k
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Object
      <span class="token key atrule">object</span><span class="token punctuation">:</span>
        <span class="token key atrule">metric</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> requests<span class="token punctuation">-</span>per<span class="token punctuation">-</span>second
        <span class="token key atrule">describedObject</span><span class="token punctuation">:</span>
          <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
          <span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
          <span class="token key atrule">name</span><span class="token punctuation">:</span> main<span class="token punctuation">-</span>route
        <span class="token key atrule">target</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> Value
          <span class="token key atrule">value</span><span class="token punctuation">:</span> 10k
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 046-php-apache.yaml</span>
horizontalpodautoscaler.autoscaling/php-apache created
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa</span>
NAME         REFERENCE               TARGETS                                     MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/100Mi, <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/1k + <span class="token number">2</span> more<span class="token punctuation">..</span>.   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">0</span>          4s
</code></pre> 
<p>从 1.10 版本开始，Kubernetes 引入了对外部系统指标的支持。例如，用户使用了公有云服务商提供的消息服务</p> 
<p>或外部负载均衡器，希望基于这些外部服务的性能指标(如消息服务的队列长度、负载均衡器的QPS)对自己部署在</p> 
<p>Kubernetes 中的服务进行自动扩缩容操作。这时，就可以在 <code>metrics</code> 参数部分设置 <code>type</code> 为 <code>External</code> 来设置</p> 
<p>自定义指标，然后就可以通过 <code>API "external.metrics.k8s.io"</code> 查询指标数据了。当然，这同样要求自定义</p> 
<p><code>Metrics Server</code> 服务已正常工作。</p> 
<p>例3，设置指标的名称为 <code>queue_messages_ready</code>，具有 <code>queue=worker_tasks</code> 标签在目标指标平均值为<code>30</code>时</p> 
<p>触发自动扩缩容操作。</p> 
<p>配置文件 <code>047-php-apache.yaml</code> 的文件内容为：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>apache
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span>          
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> External
      <span class="token key atrule">external</span><span class="token punctuation">:</span>
        <span class="token key atrule">metric</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> queue_messages_ready
          <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">queue</span><span class="token punctuation">:</span> worker_tasks<span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">target</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> AverageValue
          <span class="token key atrule">averageValue</span><span class="token punctuation">:</span> <span class="token number">30</span>
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl create -f 047-php-apache.yaml</span>
horizontalpodautoscaler.autoscaling/php-apache created
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master cha3<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa</span>
NAME         REFERENCE               TARGETS              MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/30 <span class="token punctuation">(</span>avg<span class="token punctuation">)</span>   <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">0</span>          4s
</code></pre> 
<p>在使用外部服务的指标时，要安装、部署能够对接到 Kubernetes HPA 模型的监控系统，并且完全了解监控系统</p> 
<p>采集这些指标的机制，后续的自动扩缩容操作才能完成。</p> 
<p>Kubernetes 推荐尽量使用 type 为 Object 的 HPA 配置方式，这可以通过使用 Operator 模式，将外部指标通过</p> 
<p>CRD(自定义资源)定义为API资源对象来实现。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>