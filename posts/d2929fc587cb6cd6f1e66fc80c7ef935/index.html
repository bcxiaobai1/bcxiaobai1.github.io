<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>量化投资之多因子选股（一）：数据准备与单因子检验 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">量化投资之多因子选股（一）：数据准备与单因子检验</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <p></p>
<div class="toc">
 <h3>文章目录</h3>
 <ul><li>
<ul>
<li><a href="#_1">前言</a></li>
<li><a href="#_7">系列文章</a></li>
<li><a href="#_11">矢量化选股回测概述</a></li>
<li>
<ul>
<li><a href="#1_14">要点1：数据格式</a></li>
<li><a href="#2_24">要点2：股票池</a></li>
<li><a href="#3ST_38">要点3：剔除ST股、停盘股、涨跌停书评</a></li>
<li><a href="#4__46">要点4: 仓位构建</a></li>
<li><a href="#5_57">要点5：回测</a></li>
</ul>
   </li>
<li><a href="#_62">数据准备</a></li>
<li><a href="#_383">单因子检测</a></li>
<li><a href="#_604">样例</a></li>
</ul>
 </li></ul>
</div>
<p></p> 
<h2>
<a id="_1"></a>前言</h2> 
<p>本菜狗现在是哈工大威海校区计算机学院的大四本科生，也是量化投资的初学者。因为本科学校中做量化的前辈喝同伴极少，缺少与业界的交流，在很长一段时间，本菜狗一直认为量化就是MACD等技术指标的或者是用一些炫酷的DL模型来预测（因为国内很多量化书籍都是“Python基础语法+技术指标+机器学习”）。<br> 好在没有放弃尝试，终于在经过相当一段时间的焦虑和摸索中，开始对量化行业有了比较符合客观但并不全面的认识。于是开启量化方法论系列博客的创作，把自己的学习总结、分享出来，以和需要的同伴交流。<br> 因为本人能力和精力有限，所创作的内容难免有瑕疵乃至纰漏，欢迎批评指正。<br> 若您对我所做的工作感兴趣，欢迎联系我：cai_jinhang@foxmail.com</p> 
<h2>
<a id="_7"></a>系列文章</h2> 
<p>本文是<strong>量化投资方法论之多因子选股系列</strong>文章的第一篇，分享数据准备（基于Tushare)和单因子检验模块。</p> 
<h2>
<a id="_11"></a>矢量化选股回测概述</h2> 
<p>提示：若看不太懂，可结合后面的代码理解</p> 
<h3>
<a id="1_14"></a>要点1：数据格式</h3> 
<p>把数据处理成特定的DataFrame格式:（di,ii)格式，即columns为股票代码、index为日期，value为数据（如收盘价、成交量、各种因子等），每一个指标是单独的一个df。<br> 但也不是所有数据都要DataFrame，一些只有一维的数据使用Series即可，如特定指数收益率序列。<br> 如下图，是10年到21年A股复权后的close数据。</p> 
<p><img src="https://images2.imgbox.com/44/b4/gUmw9a3C_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="2_24"></a>要点2：股票池</h3> 
<p>股票池一般取常用指数的成分股矩阵（或者其组合，如沪深300+中证500），一般命名为univ_auniv_data。univ_a的列名只有现在或历史上曾经是该指数成分股的股票代码。<br> univ_a[stk_code][trade_date]=1即股票stk_code在trade_date这一天是该指数的成分股。否则univ_a[stk_code][trade_date]=NaN<br> 我们一般在计算因子时计算全部的A股数据，在做选股回测时再考虑股票池。方法为：<br> factor_df = factor_df.reindex_like(univ_a)*univ_a<br> 其中factor_df为因子数据。reindex_like把factor_df的行、列与univ_a统一。</p> 
<p>沪深300的股票池数据示例</p> 
<p><img src="https://images2.imgbox.com/b6/4c/NBPkHCpt_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="3ST_38"></a>要点3：剔除ST股、停盘股、涨跌停书评</h3> 
<p>构造矩阵ST_valid,ST_valid[stk_code][trade_date]==1即stk_code在trade_date这一天不是ST股，通过了ST股筛选，否则是NaN<br> 构造矩阵suspend_valid、limit_valid,同ST。<br> forbid_days = suspend_valid*limit_valid 只有股票在当天同时通过三种筛选，其数值才为1</p> 
<p>在做剔除操作时，只需要将仓位矩阵*forbid_days,没有通过筛选的股票的数据就成了NaN</p> 
<h3>
<a id="4__46"></a>要点4: 仓位构建</h3> 
<p>step1:横截面排序，按照比例筛选股票，再进行仓位权重归一化，得到初始仓位pos_1<br> step2:若考虑调仓周期,假设是月频率调仓，就是隔20个交易日调仓。<br> pos_2 = pos_1.reindex(pos_1.index[::20]).fillna(0).reindex(pos_1.index).ffill()<br> 即截取调仓日的仓位，扩充其他日期的仓位先设置为nan，再ffill().<br> 这里有一个fillna(0)，因为如果不在扩展之前fillna，则可能会出现 某一期一只股票被选上，后面这只股票的仓位原本都应该是NaN，但经过ffill之后却都继承了这个仓位、<br> step3:考虑调仓日不可交易股票（见to_final_position)</p> 
<p>这里有一点要强调，即我们的是factor_df转换成仓位pos_df时，需要shift(1).因为factor是当天收盘后；利用了当天和之前的数据计算的，而交易最早发生在后一个交易日。</p> 
<h3>
<a id="5_57"></a>要点5：回测</h3> 
<p>处理好的仓位fin_pos.shift(1)*rtn_df再横向求和就是仓位的日收益,其中rtn_df是股票收益矩阵.<br> shift()的原因是：rtn_df是当天收盘价（开盘价）比上前一天的收盘价（开盘价），而我们是当天非前一天下的单，所以我们吃不到下单第一天的rtn。</p> 
<h2>
<a id="_62"></a>数据准备</h2> 
<p>本人尝试基于tushare（需要积分）获取研究所需要的常用数据（如股票行情数据、指数成分股数据、st股、涨跌停等）并处理成前文所示的（di，ii)格式。</p> 
<p>与数据下载、存储、读取相关的代码如下。<br> 但tushare的接口对调取频率、单次调取数据量有限制。因精力有限，并没有对代码进行完全的优化，故部分代码比较啰嗦，运行效率低。<br> <strong>另，因为部分方法使用了多进程并行下载，故无法在jupyter notebook等交互式环境下运行，请在pycharm等IDE下执行main（）函数。</strong></p> 
<p>数据准备部分主要有三个类。<br> 数据下载的DataDownloader,从tushare接口获取数据并整理成特定格式。<br> 数据更新存储的DataWriter，调用DataDownloader将数据下载、更新、存储到本地。<br> 数据读取的DataReader，读取数据。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tushare <span class="token keyword">as</span> ts
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Manager<span class="token punctuation">,</span> Pool
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> os
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> warnings
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>


ts<span class="token punctuation">.</span>set_token<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
pro <span class="token operator">=</span> ts<span class="token punctuation">.</span>pro_api<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">global</span> dataBase
curPath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
rootPath <span class="token operator">=</span> curPath<span class="token punctuation">[</span><span class="token punctuation">:</span>curPath<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"多因子框架\"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">"多因子框架\"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
dataBase <span class="token operator">=</span> rootPath<span class="token operator">+</span><span class="token string">'\data\'</span>


<span class="token keyword">def</span> <span class="token function">read_pickle</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> handle<span class="token punctuation">:</span>
        <span class="token keyword">return</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>handle<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">update_pickle</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> handle<span class="token punctuation">:</span>
        pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>text<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">DataDownloader</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>start_date<span class="token operator">=</span><span class="token string">'20100101'</span><span class="token punctuation">,</span>end_date <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>start_date <span class="token operator">=</span> start_date
        self<span class="token punctuation">.</span>end_date <span class="token operator">=</span> end_date
        self<span class="token punctuation">.</span>trade_dates <span class="token operator">=</span> self<span class="token punctuation">.</span>get_trade_dates<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>stk_codes <span class="token operator">=</span> self<span class="token punctuation">.</span>get_stks<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#self.template_df = pd.DataFrame(index=self.trade_dates,columns=self.stk_codes)</span>

    <span class="token keyword">def</span> <span class="token function">get_trade_dates</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>start_date <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>end_date <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> start_date <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            start_date <span class="token operator">=</span> self<span class="token punctuation">.</span>start_date
        end_date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> end_date <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">else</span> self<span class="token punctuation">.</span>end_date
        df <span class="token operator">=</span> pro<span class="token punctuation">.</span>trade_cal<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">'SSE'</span><span class="token punctuation">,</span> start_date<span class="token operator">=</span>start_date<span class="token punctuation">,</span>end_date<span class="token operator">=</span>end_date<span class="token punctuation">)</span>
        df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'is_open'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'cal_date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'is_open'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'cal_date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_stks</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        stk_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> list_status <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'L'</span><span class="token punctuation">,</span><span class="token string">'D'</span><span class="token punctuation">,</span><span class="token string">'P'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            stk_set <span class="token operator">|</span><span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>pro<span class="token punctuation">.</span>stock_basic<span class="token punctuation">(</span>list_status<span class="token operator">=</span>list_status<span class="token punctuation">,</span>fileds<span class="token operator">=</span><span class="token string">'ts_code'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'ts_code'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>stk_set<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_IdxWeight</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>idx_code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        指数成分股
        '''</span>
        start_date <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>self<span class="token punctuation">.</span>trade_dates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
        start_date <span class="token operator">=</span> start_date<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span>
        trade_dates <span class="token operator">=</span> self<span class="token punctuation">.</span>get_trade_dates<span class="token punctuation">(</span>start_date<span class="token punctuation">)</span>
        df_ls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">while</span> start_date <span class="token operator">&lt;</span> trade_dates<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            end_date <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>start_date<span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
            end_date <span class="token operator">=</span> end_date<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span>
            raw_df <span class="token operator">=</span> pro<span class="token punctuation">.</span>index_weight<span class="token punctuation">(</span>index_code<span class="token operator">=</span>idx_code<span class="token punctuation">,</span> start_date<span class="token operator">=</span>start_date<span class="token punctuation">,</span>end_date<span class="token operator">=</span>end_date<span class="token punctuation">)</span>
            df_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>raw_df<span class="token punctuation">.</span>pivot<span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token string">'trade_date'</span><span class="token punctuation">,</span>columns <span class="token operator">=</span> <span class="token string">'con_code'</span><span class="token punctuation">,</span>values<span class="token operator">=</span><span class="token string">'weight'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            start_date <span class="token operator">=</span> end_date

        res_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>df_ls<span class="token punctuation">)</span>
        res_df <span class="token operator">=</span> res_df<span class="token punctuation">[</span><span class="token operator">~</span>res_df<span class="token punctuation">.</span>index<span class="token punctuation">.</span>duplicated<span class="token punctuation">(</span>keep<span class="token operator">=</span><span class="token string">'first'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        res_df <span class="token operator">=</span> res_df<span class="token punctuation">.</span>reindex<span class="token punctuation">(</span>trade_dates<span class="token punctuation">)</span>
        res_df <span class="token operator">=</span> res_df<span class="token punctuation">.</span>ffill<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reindex<span class="token punctuation">(</span>self<span class="token punctuation">.</span>trade_dates<span class="token punctuation">)</span>
        <span class="token keyword">return</span> res_df<span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_ST_valid</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        ST股
        '''</span>
        res_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>index<span class="token operator">=</span>self<span class="token punctuation">.</span>trade_dates<span class="token punctuation">,</span>columns<span class="token operator">=</span>self<span class="token punctuation">.</span>stk_codes<span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        df <span class="token operator">=</span> pro<span class="token punctuation">.</span>namechange<span class="token punctuation">(</span>fields<span class="token operator">=</span><span class="token string">'ts_code,name,start_date,end_date'</span><span class="token punctuation">)</span>
        df <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">'ST'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            ts_code <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> ts_code <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>stk_codes<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            s_date <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
            e_date <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> e_date <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                res_df<span class="token punctuation">[</span>ts_code<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>s_date<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">=</span>np<span class="token punctuation">.</span>nan
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                res_df<span class="token punctuation">[</span>ts_code<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>s_date<span class="token punctuation">:</span>e_date<span class="token punctuation">]</span><span class="token operator">=</span>np<span class="token punctuation">.</span>nan
        <span class="token keyword">return</span> res_df<span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_suspend_oneDate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>trade_date<span class="token punctuation">,</span>m_ls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        tushare的接口一次最多返回5000条数据，所以按天调取。用并行加速。
        '''</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            df <span class="token operator">=</span> pro<span class="token punctuation">.</span>suspend_d<span class="token punctuation">(</span>suspend_type<span class="token operator">=</span><span class="token string">'S'</span><span class="token punctuation">,</span>trade_date<span class="token operator">=</span>trade_date<span class="token punctuation">)</span>
            m_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>trade_date<span class="token punctuation">,</span>df<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            df <span class="token operator">=</span> pro<span class="token punctuation">.</span>suspend_d<span class="token punctuation">(</span>suspend_type<span class="token operator">=</span><span class="token string">'S'</span><span class="token punctuation">,</span>trade_date<span class="token operator">=</span>trade_date<span class="token punctuation">)</span>
            m_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>trade_date<span class="token punctuation">,</span>df<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_suspend_valid</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        停牌股
        '''</span>
        res_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>index<span class="token operator">=</span>self<span class="token punctuation">.</span>trade_dates<span class="token punctuation">,</span>columns<span class="token operator">=</span>self<span class="token punctuation">.</span>stk_codes<span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        m_ls <span class="token operator">=</span> Manager<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        pools <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> date <span class="token keyword">in</span> self<span class="token punctuation">.</span>trade_dates<span class="token punctuation">:</span>
            pools<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>self<span class="token punctuation">.</span>get_suspend_oneDate<span class="token punctuation">,</span>
                              args<span class="token operator">=</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span>m_ls<span class="token punctuation">)</span>
                             <span class="token punctuation">)</span>
        pools<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pools<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
        m_ls <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>m_ls<span class="token punctuation">)</span>
        <span class="token keyword">for</span> date<span class="token punctuation">,</span>df <span class="token keyword">in</span> m_ls<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span>df<span class="token punctuation">)</span>
            res_df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>date<span class="token punctuation">,</span>df<span class="token punctuation">[</span><span class="token string">'ts_code'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>nan
        <span class="token keyword">return</span> res_df<span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">get_limit_oneDate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>trade_date<span class="token punctuation">,</span>m_ls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        tushare的接口一次最多返回5000条数据，所以按天调取。用并行加速。
        '''</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            df <span class="token operator">=</span> pro<span class="token punctuation">.</span>limit_list<span class="token punctuation">(</span>trade_date<span class="token operator">=</span>trade_date<span class="token punctuation">)</span>
            m_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>trade_date<span class="token punctuation">,</span>df<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            df <span class="token operator">=</span> pro<span class="token punctuation">.</span>suspend_d<span class="token punctuation">(</span>trade_date<span class="token operator">=</span>trade_date<span class="token punctuation">)</span>
            m_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>trade_date<span class="token punctuation">,</span>df<span class="token punctuation">]</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">get_limit_valid</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        停牌股
        '''</span>
        res_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>index<span class="token operator">=</span>self<span class="token punctuation">.</span>trade_dates<span class="token punctuation">,</span>columns<span class="token operator">=</span>self<span class="token punctuation">.</span>stk_codes<span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        m_ls <span class="token operator">=</span> Manager<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        pools <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> date <span class="token keyword">in</span> self<span class="token punctuation">.</span>trade_dates<span class="token punctuation">:</span>
            pools<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>self<span class="token punctuation">.</span>get_limit_oneDate<span class="token punctuation">,</span>
                              args<span class="token operator">=</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span>m_ls<span class="token punctuation">)</span>
                              <span class="token punctuation">)</span>
        pools<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pools<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
        m_ls <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>m_ls<span class="token punctuation">)</span>
        <span class="token keyword">for</span> date<span class="token punctuation">,</span>df <span class="token keyword">in</span> m_ls<span class="token punctuation">:</span>
            res_df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>date<span class="token punctuation">,</span>df<span class="token punctuation">[</span><span class="token string">'ts_code'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span>np<span class="token punctuation">.</span>nan
        <span class="token keyword">return</span> res_df<span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">get_dailyMkt_oneStock</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>ts_code<span class="token punctuation">,</span>m_ls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        前复权的行情数据

        因为tushare下载复权行情接口一次只能获取一只股票
        所以使用多进行并行
        '''</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment">#偶尔会因为网络问题请求失败，报错重新请求</span>
            df <span class="token operator">=</span> ts<span class="token punctuation">.</span>pro_bar<span class="token punctuation">(</span>ts_code<span class="token operator">=</span>ts_code<span class="token punctuation">,</span> adj<span class="token operator">=</span><span class="token string">'qfq'</span><span class="token punctuation">,</span> start_date<span class="token operator">=</span>self<span class="token punctuation">.</span>start_date<span class="token punctuation">,</span>end_date<span class="token operator">=</span>self<span class="token punctuation">.</span>end_date<span class="token punctuation">)</span>
            m_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            df <span class="token operator">=</span> ts<span class="token punctuation">.</span>pro_bar<span class="token punctuation">(</span>ts_code<span class="token operator">=</span>ts_code<span class="token punctuation">,</span> adj<span class="token operator">=</span><span class="token string">'qfq'</span><span class="token punctuation">,</span> start_date<span class="token operator">=</span>self<span class="token punctuation">.</span>start_date<span class="token punctuation">,</span>end_date<span class="token operator">=</span>self<span class="token punctuation">.</span>end_date<span class="token punctuation">)</span>
            m_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>df<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_dailyMkt_mulP</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        m_ls <span class="token operator">=</span> Manager<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        pools <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#开太多会有访问频率限制</span>
        <span class="token keyword">for</span> ts_code <span class="token keyword">in</span> self<span class="token punctuation">.</span>stk_codes<span class="token punctuation">:</span>
            pools<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>self<span class="token punctuation">.</span>get_dailyMkt_oneStock<span class="token punctuation">,</span>
                              args<span class="token operator">=</span><span class="token punctuation">(</span>ts_code<span class="token punctuation">,</span>m_ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pools<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pools<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
        m_ls <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>m_ls<span class="token punctuation">)</span>
        raw_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>m_ls<span class="token punctuation">)</span>
        res_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> data_name <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">,</span><span class="token string">'close'</span><span class="token punctuation">,</span><span class="token string">'high'</span><span class="token punctuation">,</span><span class="token string">'low'</span><span class="token punctuation">,</span><span class="token string">'vol'</span><span class="token punctuation">,</span><span class="token string">'amount'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            res_df <span class="token operator">=</span> raw_df<span class="token punctuation">.</span>pivot<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token string">'trade_date'</span><span class="token punctuation">,</span>columns<span class="token operator">=</span><span class="token string">'ts_code'</span><span class="token punctuation">,</span>values<span class="token operator">=</span>data_name<span class="token punctuation">)</span>
            res_dict<span class="token punctuation">[</span>data_name<span class="token punctuation">]</span> <span class="token operator">=</span> res_df<span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> res_dict

<span class="token keyword">class</span> <span class="token class-name">DataWriter</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">commonFunc</span><span class="token punctuation">(</span>data_path<span class="token punctuation">,</span>getFunc<span class="token punctuation">,</span>cover<span class="token punctuation">,</span><span class="token operator">*</span>args<span class="token punctuation">,</span><span class="token operator">**</span>kwds<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span> <span class="token keyword">or</span> cover<span class="token punctuation">:</span>
            t1 <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'--------</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_path<span class="token punctuation">}</span></span><span class="token string">,第一次下载该数据，可能耗时较长'</span></span><span class="token punctuation">)</span>
            newData_df <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'DataDownloader().</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>getFunc<span class="token punctuation">}</span></span><span class="token string">(*args,**kwds)'</span></span><span class="token punctuation">)</span>
            newData_df<span class="token punctuation">.</span>to_pickle<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>
            t2 <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'--------下载完成,耗时</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>t2<span class="token operator">-</span>t1<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            savedData_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_pickle<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>
            savedLastDate <span class="token operator">=</span> savedData_df<span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'---------</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_path<span class="token punctuation">}</span></span><span class="token string">上次更新至</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>savedLastDate<span class="token punctuation">}</span></span><span class="token string">，正在更新至最新交易日'</span></span><span class="token punctuation">)</span>

            lastData_df <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'DataDownloader(savedLastDate).</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>getFunc<span class="token punctuation">}</span></span><span class="token string">(*args,**kwds)'</span></span><span class="token punctuation">)</span>
            newData_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>savedData_df<span class="token punctuation">,</span>lastData_df<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
            newData_df <span class="token operator">=</span> newData_df<span class="token punctuation">[</span><span class="token operator">~</span>newData_df<span class="token punctuation">.</span>index<span class="token punctuation">.</span>duplicated<span class="token punctuation">(</span>keep<span class="token operator">=</span><span class="token string">'first'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            newData_df<span class="token punctuation">.</span>to_pickle<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'---------已更新至最新日期</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>newData_df<span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        newData_df<span class="token punctuation">.</span>index <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>newData_df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
        <span class="token keyword">return</span> newData_df

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">update_IdxWeight</span><span class="token punctuation">(</span>stk_code<span class="token punctuation">,</span>cover<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_path <span class="token operator">=</span> dataBase<span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f'daily/idx_cons/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stk_code<span class="token punctuation">}</span></span><span class="token string">.pkl'</span></span>
        <span class="token keyword">return</span> DataWriter<span class="token punctuation">.</span>commonFunc<span class="token punctuation">(</span>data_path<span class="token punctuation">,</span><span class="token string">'get_IdxWeight'</span><span class="token punctuation">,</span>cover<span class="token punctuation">,</span>stk_code<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">update_ST_valid</span><span class="token punctuation">(</span>cover<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_path <span class="token operator">=</span> dataBase<span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f'daily/valid/ST_valid.pkl'</span></span>
        <span class="token keyword">return</span> DataWriter<span class="token punctuation">.</span>commonFunc<span class="token punctuation">(</span>data_path<span class="token punctuation">,</span><span class="token string">'get_ST_valid'</span><span class="token punctuation">,</span>cover<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">update_suspend_valid</span><span class="token punctuation">(</span>cover<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_path <span class="token operator">=</span> dataBase<span class="token operator">+</span><span class="token string">'daily/valid/suspend_valid.pkl'</span>
        <span class="token keyword">return</span> DataWriter<span class="token punctuation">.</span>commonFunc<span class="token punctuation">(</span>data_path<span class="token punctuation">,</span><span class="token string">'get_suspend_valid'</span><span class="token punctuation">,</span>cover<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">update_limit_valid</span><span class="token punctuation">(</span>cover<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_path <span class="token operator">=</span> dataBase<span class="token operator">+</span><span class="token string">'daily/valid/limit_valid.pkl'</span>
        <span class="token keyword">return</span> DataWriter<span class="token punctuation">.</span>commonFunc<span class="token punctuation">(</span>data_path<span class="token punctuation">,</span><span class="token string">'get_limit_valid'</span><span class="token punctuation">,</span>cover<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">update_dailyMkt</span><span class="token punctuation">(</span>cover<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
            需要保证已存储的ochlv数据的日期一致
        '''</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>dataBase<span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f'daily/mkt/open.pkl'</span></span><span class="token punctuation">)</span> <span class="token keyword">or</span> cover<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'--------Mkt,第一次下载该数据，可能耗时较长'</span></span><span class="token punctuation">)</span>
            res_dict <span class="token operator">=</span> DataDownloader<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_dailyMkt_mulP<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> data_name<span class="token punctuation">,</span>df <span class="token keyword">in</span> res_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                data_path <span class="token operator">=</span> dataBase<span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f'daily/mkt//</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_name<span class="token punctuation">}</span></span><span class="token string">.pkl'</span></span>
                df<span class="token punctuation">.</span>to_pickle<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            savedData_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_pickle<span class="token punctuation">(</span>dataBase<span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f'daily/mkt/open.pkl'</span></span><span class="token punctuation">)</span>
            savedLastDate <span class="token operator">=</span> savedData_df<span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'---------Mkt,上次更新至</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>savedLastDate<span class="token punctuation">}</span></span><span class="token string">，正在更新至最新交易日'</span></span><span class="token punctuation">)</span>

            res_dict <span class="token operator">=</span> DataDownloader<span class="token punctuation">(</span>savedLastDate<span class="token punctuation">)</span><span class="token punctuation">.</span>get_dailyMkt_mulP<span class="token punctuation">(</span><span class="token punctuation">)</span>
            new_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> data_name<span class="token punctuation">,</span>last_df <span class="token keyword">in</span> res_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                data_path <span class="token operator">=</span> dataBase<span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f'daily/mkt//</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_name<span class="token punctuation">}</span></span><span class="token string">.pkl'</span></span>
                new_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>savedData_df<span class="token punctuation">,</span>last_df<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
                new_df <span class="token operator">=</span> new_df<span class="token punctuation">[</span><span class="token operator">~</span>new_df<span class="token punctuation">.</span>index<span class="token punctuation">.</span>duplicated<span class="token punctuation">(</span>keep<span class="token operator">=</span><span class="token string">'first'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                new_df<span class="token punctuation">.</span>to_pickle<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'---------已更新至最新日期</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>new_df<span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">DataReader</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">commonFunc</span><span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_path<span class="token punctuation">}</span></span><span class="token string">不存在，请先调用DataWriter().update_xx'</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_pickle<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>
        df<span class="token punctuation">.</span>index <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
        <span class="token keyword">return</span> df

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">read_IdxWeight</span><span class="token punctuation">(</span>stk_code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_path <span class="token operator">=</span> dataBase<span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f'daily/idx_cons/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stk_code<span class="token punctuation">}</span></span><span class="token string">.pkl'</span></span>
        <span class="token keyword">return</span> DataReader<span class="token punctuation">.</span>commonFunc<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">read_ST_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_path <span class="token operator">=</span> dataBase<span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f'daily/valid/ST_valid.pkl'</span></span>
        <span class="token keyword">return</span> DataReader<span class="token punctuation">.</span>commonFunc<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">read_suspend_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_path <span class="token operator">=</span> dataBase<span class="token operator">+</span><span class="token string">'daily/valid/suspend_valid.pkl'</span>
        <span class="token keyword">return</span> DataReader<span class="token punctuation">.</span>commonFunc<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">read_limit_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_path <span class="token operator">=</span> dataBase <span class="token operator">+</span> <span class="token string">'daily/valid/limit_valid.pkl'</span>
        <span class="token keyword">return</span> DataReader<span class="token punctuation">.</span>commonFunc<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">read_dailyMkt</span><span class="token punctuation">(</span>data_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_path <span class="token operator">=</span> dataBase<span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f'daily/mkt/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_name<span class="token punctuation">}</span></span><span class="token string">.pkl'</span></span>
        <span class="token keyword">return</span> DataReader<span class="token punctuation">.</span>commonFunc<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">read_index_dailyRtn</span><span class="token punctuation">(</span>index_code<span class="token punctuation">,</span>start_date <span class="token operator">=</span> <span class="token string">'20100101'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        df <span class="token operator">=</span> pro<span class="token punctuation">.</span>index_daily<span class="token punctuation">(</span>ts_code<span class="token operator">=</span>index_code<span class="token punctuation">,</span> start_date<span class="token operator">=</span> start_date<span class="token punctuation">)</span><span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token string">'trade_date'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
        df<span class="token punctuation">.</span>index <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
        <span class="token keyword">return</span> df<span class="token punctuation">[</span><span class="token string">'pct_chg'</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">100</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">read_dailyRtn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        df <span class="token operator">=</span> DataReader<span class="token punctuation">.</span>read_dailyMkt<span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> df<span class="token punctuation">.</span>pct_change<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    DataWriter<span class="token punctuation">.</span>update_ST_valid<span class="token punctuation">(</span>cover<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    DataWriter<span class="token punctuation">.</span>update_suspend_valid<span class="token punctuation">(</span>cover<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    DataWriter<span class="token punctuation">.</span>update_IdxWeight<span class="token punctuation">(</span><span class="token string">'399300.SZ'</span><span class="token punctuation">,</span>cover<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    DataWriter<span class="token punctuation">.</span>update_dailyMkt<span class="token punctuation">(</span>cover<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    DataWriter<span class="token punctuation">.</span>update_limit_valid<span class="token punctuation">(</span>cover<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="_383"></a>单因子检测</h2> 
<p>主要有<br> 1.夏普、年化、最大回撤等指标的实现。<br> 2.to_finnal_position函数，将选出的股票进行股票池、st股、limit等处理，见注释。<br> 3.factor_group分组回测，默认进行十等分，画出净值图和收益率柱状图。<br> 4.ICIR相关，计算IC、IR，画出累计IC图。<br> 5.calc_daily_pnl计算仓位收益。<br> 6.factor_stats综合，最终直接调用该函数。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token keyword">def</span> <span class="token function">Col_zscore</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> n<span class="token punctuation">,</span> cap<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> min_periods<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> check_std<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df_mean <span class="token operator">=</span> df<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>n<span class="token punctuation">,</span>min_periods<span class="token operator">=</span>min_periods<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    df_std <span class="token operator">=</span> df<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>n<span class="token punctuation">,</span> min_periods<span class="token operator">=</span>min_periods<span class="token punctuation">)</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> check_std<span class="token punctuation">:</span>
        df_std <span class="token operator">=</span> df_std<span class="token punctuation">[</span>df_std <span class="token operator">&gt;=</span> <span class="token number">0.00001</span><span class="token punctuation">]</span>
    target <span class="token operator">=</span> <span class="token punctuation">(</span>df <span class="token operator">-</span> df_mean<span class="token punctuation">)</span> <span class="token operator">/</span> df_std
    <span class="token keyword">if</span> cap <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        target<span class="token punctuation">[</span>target <span class="token operator">&gt;</span> cap<span class="token punctuation">]</span> <span class="token operator">=</span> cap
        target<span class="token punctuation">[</span>target <span class="token operator">&lt;</span> <span class="token operator">-</span>cap<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>cap
    <span class="token keyword">return</span> target

<span class="token keyword">def</span> <span class="token function">Row_zscore</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> cap<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> check_std<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df_mean <span class="token operator">=</span> df<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    df_std <span class="token operator">=</span> df<span class="token punctuation">.</span>std<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> check_std<span class="token punctuation">:</span>
        df_std <span class="token operator">=</span> df_std<span class="token punctuation">[</span>df_std <span class="token operator">&gt;=</span> <span class="token number">0.00001</span><span class="token punctuation">]</span>
    target <span class="token operator">=</span> df<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>df_mean<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>div<span class="token punctuation">(</span>df_std<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> cap <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        target<span class="token punctuation">[</span>target <span class="token operator">&gt;</span> cap<span class="token punctuation">]</span> <span class="token operator">=</span> cap
        target<span class="token punctuation">[</span>target <span class="token operator">&lt;</span> <span class="token operator">-</span>cap<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>cap
    <span class="token keyword">return</span> target

<span class="token keyword">def</span> <span class="token function">MaxDrawdown</span><span class="token punctuation">(</span>asset_series<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> asset_series <span class="token operator">-</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">.</span>accumulate<span class="token punctuation">(</span>asset_series<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">Sharpe_yearly</span><span class="token punctuation">(</span>pnl_series<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span> <span class="token operator">*</span> pnl_series<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> pnl_series<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">AnnualReturn</span><span class="token punctuation">(</span>pos_df<span class="token punctuation">,</span> pnl_series<span class="token punctuation">,</span> alpha_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
    temp_pnl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>pnl_series<span class="token punctuation">)</span><span class="token punctuation">.</span>prod<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> alpha_type <span class="token operator">==</span> <span class="token string">'ls_alpha'</span><span class="token punctuation">:</span>
        temp_pos <span class="token operator">=</span> pos_df<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        temp_pos <span class="token operator">=</span> pos_df<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> temp_pos <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">.0</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">round</span><span class="token punctuation">(</span>temp_pnl <span class="token operator">**</span> <span class="token punctuation">(</span><span class="token number">250</span> <span class="token operator">/</span> temp_pos<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">IC</span><span class="token punctuation">(</span>signal<span class="token punctuation">,</span> pct_n<span class="token punctuation">,</span> min_valids<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> lag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    signal <span class="token operator">=</span> signal<span class="token punctuation">.</span>shift<span class="token punctuation">(</span>lag<span class="token punctuation">)</span>
    corr_df <span class="token operator">=</span> signal<span class="token punctuation">.</span>corrwith<span class="token punctuation">(</span>pct_n<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">'spearman'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dropna<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> min_valids <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        signal_valid <span class="token operator">=</span> signal<span class="token punctuation">.</span>count<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        signal_valid<span class="token punctuation">[</span>signal_valid <span class="token operator">&lt;</span> min_valids<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>nan
        signal_valid<span class="token punctuation">[</span>signal_valid <span class="token operator">&gt;=</span> min_valids<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
        corr_signal <span class="token operator">=</span> corr_df <span class="token operator">*</span> signal_valid
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        corr_signal <span class="token operator">=</span> corr_df
    <span class="token keyword">return</span> corr_signal

<span class="token keyword">def</span> <span class="token function">IR</span><span class="token punctuation">(</span>signal<span class="token punctuation">,</span> pct_n<span class="token punctuation">,</span> min_valids<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> lag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    corr_signal <span class="token operator">=</span> IC<span class="token punctuation">(</span>signal<span class="token punctuation">,</span> pct_n<span class="token punctuation">,</span> min_valids<span class="token punctuation">,</span> lag<span class="token punctuation">)</span>
    ic_mean <span class="token operator">=</span> corr_signal<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ic_std <span class="token operator">=</span> corr_signal<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ir <span class="token operator">=</span> ic_mean <span class="token operator">/</span> ic_std
    <span class="token keyword">return</span> ir<span class="token punctuation">,</span> corr_signal

<span class="token comment"># def to_weighted_position(selected_df,weights_df = None):</span>
<span class="token comment">#     if weights_df is None:</span>
<span class="token comment">#         weights_df = pd.DataFrame().reindex_like(selected_df).fillna(1)</span>
<span class="token comment">#</span>
<span class="token comment">#     weights_df = weights_df.reindex_like(selected_df)</span>
<span class="token comment">#     selected_weights_df = selected_df * weights_df</span>
<span class="token comment">#     weighted_position_df = selected_weights_df.div(selected_weights_df.sum(axis=1), axis=0)</span>
<span class="token comment">#     return weighted_position_df</span>

<span class="token keyword">def</span> <span class="token function">to_final_position</span><span class="token punctuation">(</span>factor_score<span class="token punctuation">,</span> forbid_day<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    factor_score:DataFrame,可以是因子值，也可以是根据因子值排序选出来的初始仓位矩阵
    forbid_day:DataFrame,是否可交易（由ST股、停盘相乘得到），1代表该股票该日可以交易，不可交易则是NaN

    return:
        pos_fin：DataFrame,最终仓位
    '''</span>

    <span class="token comment">#因为因子df中，index为x的数值是用x日收盘后更新的数据计算的，所以x日不能交易，需要等到下一天交易，所以要shift（1）</span>
    pos_fin <span class="token operator">=</span> factor_score<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> forbid_day
    <span class="token comment">#这里的ffill的效果是，若某只需要交易的股票在调仓日无法交易，那么经过上一个步骤后，其对应位置是nan，而ffill就是让其先继承前一个交易日的仓位</span>
    pos_fin <span class="token operator">=</span> pos_fin<span class="token punctuation">.</span>ffill<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pos_fin

<span class="token keyword">def</span> <span class="token function">calc_daily_pnl</span><span class="token punctuation">(</span>factor_df<span class="token punctuation">,</span> univ_data<span class="token punctuation">,</span> rtn_df<span class="token punctuation">,</span> idx_rtn<span class="token punctuation">,</span>forbid_days<span class="token punctuation">,</span>method<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    :param factor_df:   因子/仓位矩阵
    :param univ_data:   股票池矩阵（如沪深300成分股、中证500成分股等等)
    :param idx_rtn:  指数rtn序列
    :param forbid_days:  合法交易矩阵
    :param rtn_df:    股票rtn矩阵
    :param method_func:   feature/factor/ls_alpha/hg_alpha

    :return:  仓位矩阵+每日仓位收益率序列
    '''</span>
    factor_sel <span class="token operator">=</span> factor_df<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    factor_sel <span class="token operator">=</span> factor_sel<span class="token punctuation">.</span>reindex_like<span class="token punctuation">(</span>univ_data<span class="token punctuation">)</span><span class="token operator">*</span>univ_data
    forbid_days <span class="token operator">=</span> forbid_days<span class="token punctuation">.</span>reindex_like<span class="token punctuation">(</span>factor_sel<span class="token punctuation">)</span>
    return_df <span class="token operator">=</span> rtn_df<span class="token punctuation">.</span>reindex_like<span class="token punctuation">(</span>factor_sel<span class="token punctuation">)</span>
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">'feature'</span> <span class="token keyword">or</span> method <span class="token operator">==</span> <span class="token string">'factor'</span><span class="token punctuation">:</span>
        factor_z <span class="token operator">=</span> Row_zscore<span class="token punctuation">(</span>factor_sel<span class="token punctuation">,</span> cap<span class="token operator">=</span><span class="token number">4.5</span><span class="token punctuation">)</span>
        pos_final <span class="token operator">=</span> to_final_position<span class="token punctuation">(</span>factor_z<span class="token punctuation">,</span> forbid_days<span class="token punctuation">)</span>
        daily_pnl_final <span class="token operator">=</span> <span class="token punctuation">(</span>pos_final<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> return_df<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> pos_final<span class="token punctuation">,</span>daily_pnl_final
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">'ls_alpha'</span><span class="token punctuation">:</span>
        pos_final <span class="token operator">=</span> to_final_position<span class="token punctuation">(</span>factor_sel<span class="token punctuation">,</span> forbid_days<span class="token punctuation">)</span>
        daily_pnl_final <span class="token operator">=</span> <span class="token punctuation">(</span>pos_final<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> return_df<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> pos_final<span class="token punctuation">,</span>daily_pnl_final
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">'hg_alpha'</span><span class="token punctuation">:</span>
        pos_final <span class="token operator">=</span> to_final_position<span class="token punctuation">(</span>factor_sel<span class="token punctuation">,</span> forbid_days<span class="token punctuation">)</span>
        daily_pnl_final <span class="token operator">=</span> <span class="token punctuation">(</span>pos_final<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> return_df<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> idx_rtn
        <span class="token keyword">return</span> pos_final<span class="token punctuation">,</span>daily_pnl_final

<span class="token keyword">def</span> <span class="token function">factor_group</span><span class="token punctuation">(</span>factor_df<span class="token punctuation">,</span>forb_day<span class="token punctuation">,</span>rtn_df<span class="token punctuation">,</span>idx_rtn<span class="token punctuation">,</span>univ_data<span class="token punctuation">,</span>split_pct_ls<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    分组回测
    '''</span>
    factor_df <span class="token operator">=</span> factor_df<span class="token punctuation">.</span>reindex_like<span class="token punctuation">(</span>univ_data<span class="token punctuation">)</span><span class="token operator">*</span>univ_data
    factor_score <span class="token operator">=</span> factor_df
    factor_rank_pct <span class="token operator">=</span> factor_score<span class="token punctuation">.</span>rank<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> pct<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    annual_rtn_ls <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> split_pct <span class="token keyword">in</span> split_pct_ls<span class="token punctuation">:</span>
        pos_selected <span class="token operator">=</span> factor_score<span class="token punctuation">[</span><span class="token punctuation">(</span>factor_rank_pct <span class="token operator">&gt;</span> split_pct<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>factor_rank_pct <span class="token operator">&lt;=</span> split_pct<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        pos_selected <span class="token operator">=</span> pos_selected<span class="token punctuation">.</span>where<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>pos_selected<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        pos <span class="token operator">=</span> pos_selected<span class="token punctuation">.</span>div<span class="token punctuation">(</span>pos_selected<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        pos <span class="token operator">=</span> to_final_position<span class="token punctuation">(</span>pos<span class="token punctuation">,</span> forb_day<span class="token punctuation">)</span><span class="token punctuation">.</span>reindex<span class="token punctuation">(</span>factor_df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
        daily_rtn <span class="token operator">=</span> <span class="token punctuation">(</span>pos<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> rtn_df<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reindex<span class="token punctuation">(</span>factor_df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
        annual_rtn <span class="token operator">=</span> AnnualReturn<span class="token punctuation">(</span>pos<span class="token punctuation">,</span>daily_rtn<span class="token punctuation">,</span><span class="token string">'factor'</span><span class="token punctuation">)</span>
        annual_rtn_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>annual_rtn<span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">(</span>daily_rtn<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cumprod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>split_pct<span class="token punctuation">)</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'all factor group backtest return'</span><span class="token punctuation">,</span>fontsize <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

    xticks <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>split_pct_ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>x <span class="token operator">=</span> xticks<span class="token punctuation">,</span>height <span class="token operator">=</span> annual_rtn_ls<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>set_xticks<span class="token punctuation">(</span>xticks<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>set_xticklabels<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">10</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> split_pct_ls<span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'factor group annual return'</span><span class="token punctuation">,</span>fontsize <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>



<span class="token keyword">def</span> <span class="token function">factor_stats</span><span class="token punctuation">(</span>
        factor_df<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        chg_n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">#调仓时间间隔</span>
        univ_data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        rtn_df<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        idx_rtn<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        forbid_days <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        method<span class="token operator">=</span><span class="token string">'factor'</span><span class="token punctuation">,</span><span class="token comment">#factorls_alphahg_alpha</span>
        group_split_ls<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.6</span><span class="token punctuation">,</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>


    <span class="token keyword">if</span> method<span class="token operator">==</span><span class="token string">'factor'</span><span class="token punctuation">:</span>
        <span class="token comment">#         plt.figure(figsize=(16, 12))</span>
        plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


        pos_final<span class="token punctuation">,</span>daily_pnl <span class="token operator">=</span> calc_daily_pnl<span class="token punctuation">(</span>factor_df<span class="token punctuation">,</span> univ_data<span class="token punctuation">,</span> rtn_df<span class="token punctuation">,</span> idx_rtn<span class="token punctuation">,</span>forbid_days<span class="token punctuation">,</span>method<span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>daily_pnl<span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'all factor row_Zscore position return'</span><span class="token punctuation">,</span>fontsize <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

        factor_group<span class="token punctuation">(</span>
            factor_df<span class="token punctuation">,</span>
            forbid_days<span class="token punctuation">,</span>
            rtn_df<span class="token punctuation">,</span>
            idx_rtn<span class="token punctuation">,</span>
            univ_data<span class="token punctuation">,</span>
            split_pct_ls<span class="token operator">=</span>group_split_ls
        <span class="token punctuation">)</span>

        pct_n <span class="token operator">=</span> rtn_df<span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>chg_n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ir<span class="token punctuation">,</span>IC_series <span class="token operator">=</span> IR<span class="token punctuation">(</span>factor_df<span class="token punctuation">,</span> pct_n<span class="token punctuation">,</span> lag<span class="token operator">=</span>chg_n<span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>IC_series<span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'IR:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">round</span><span class="token punctuation">(</span>ir<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">,IC_mean:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">round</span><span class="token punctuation">(</span>IC_series<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'IC cumsum'</span><span class="token punctuation">,</span>fontsize <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword">else</span><span class="token punctuation">:</span>
        plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p1 <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span>
        pos <span class="token operator">=</span> factor_df<span class="token punctuation">.</span>reindex<span class="token punctuation">(</span>factor_df<span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span>chg_n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#初步仓位，没有剔除St股票 也没有shift</span>
        pos <span class="token operator">=</span> pos<span class="token punctuation">.</span>reindex<span class="token punctuation">(</span>factor_df<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>ffill<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pos_final<span class="token punctuation">,</span>daily_pnl <span class="token operator">=</span> calc_daily_pnl<span class="token punctuation">(</span>pos<span class="token punctuation">,</span> univ_data<span class="token punctuation">,</span> rtn_df<span class="token punctuation">,</span> idx_rtn<span class="token punctuation">,</span>forbid_days<span class="token punctuation">,</span>method<span class="token punctuation">)</span>
        sharpe <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>Sharpe_yearly<span class="token punctuation">(</span>daily_pnl<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
        max_drawdown <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>MaxDrawdown<span class="token punctuation">(</span><span class="token punctuation">(</span>daily_pnl<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cumprod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
        annual_return <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>AnnualReturn<span class="token punctuation">(</span>pos_final<span class="token punctuation">,</span>daily_pnl<span class="token punctuation">,</span>method<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
        p1<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>daily_pnl<span class="token punctuation">.</span>cumsum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'SP:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>sharpe<span class="token punctuation">}</span></span><span class="token string">,MD:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>max_drawdown<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">,AR:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>annual_return<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        p1<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'selected position return'</span><span class="token punctuation">)</span>
        p1<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        p1<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="_604"></a>样例</h2> 
<p>以<strong>20日收益率因子</strong>为例，展示单因子检测内容。<br> 本人本地的目录如下图所示。<br> <img src="https://images2.imgbox.com/08/37/hDLPyJm8_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> my_lib<span class="token punctuation">.</span>data_download<span class="token punctuation">.</span>data_io <span class="token keyword">import</span> DataReader
<span class="token keyword">from</span> my_lib<span class="token punctuation">.</span>factor_evaluate<span class="token punctuation">.</span>factor_evaluate <span class="token keyword">import</span> factor_stats
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">calc_factor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment">#这里是计算因子的，把因子处理成特定的（di,ii)格式。</span>
    close_df <span class="token operator">=</span> DataReader<span class="token punctuation">.</span>read_dailyMkt<span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> close_df<span class="token punctuation">.</span>pct_change<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>计算因子</strong></p> 
<pre><code class="prism language-python">factor_df <span class="token operator">=</span> calc_factor<span class="token punctuation">(</span><span class="token punctuation">)</span>
factor_df<span class="token punctuation">.</span>tail<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d2/c3/YmnXWxZL_o.png" alt="在这里插入图片描述"><br> <strong>股票池</strong></p> 
<pre><code class="prism language-python">univ_a <span class="token operator">=</span> DataReader<span class="token punctuation">.</span>read_IdxWeight<span class="token punctuation">(</span><span class="token string">'399300.SZ'</span><span class="token punctuation">)</span><span class="token comment">#沪深300</span>
univ_a <span class="token operator">=</span> univ_a<span class="token punctuation">.</span>where<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>univ_a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
univ_a
</code></pre> 
<p><img src="https://images2.imgbox.com/aa/d3/VkwriMVp_o.png" alt="在这里插入图片描述"></p> 
<p><strong>st股、停牌、涨跌停</strong></p> 
<pre><code class="prism language-python">ST_valid <span class="token operator">=</span> DataReader<span class="token punctuation">.</span>read_ST_valid<span class="token punctuation">(</span><span class="token punctuation">)</span>
suspend_valid <span class="token operator">=</span> DataReader<span class="token punctuation">.</span>read_suspend_valid<span class="token punctuation">(</span><span class="token punctuation">)</span>
limit_valid <span class="token operator">=</span> DataReader<span class="token punctuation">.</span>read_limit_valid<span class="token punctuation">(</span><span class="token punctuation">)</span>
forb_days <span class="token operator">=</span> ST_valid<span class="token operator">*</span>suspend_valid<span class="token operator">*</span>limit_valid
forb_days<span class="token punctuation">.</span>tail<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4a/26/wh7zd0Xf_o.png" alt="在这里插入图片描述"></p> 
<p><strong>每日收益率矩阵</strong></p> 
<pre><code class="prism language-python">rtn_df <span class="token operator">=</span> DataReader<span class="token punctuation">.</span>read_dailyRtn<span class="token punctuation">(</span><span class="token punctuation">)</span>
rtn_df<span class="token punctuation">.</span>tail<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>因子测试与回测</strong><br> 原始因子</p> 
<pre><code class="prism language-python">idx_rtn <span class="token operator">=</span> DataReader<span class="token punctuation">.</span>read_index_dailyRtn<span class="token punctuation">(</span><span class="token string">'399300.SZ'</span><span class="token punctuation">)</span><span class="token comment">#指数收益序列</span>
factor_stats<span class="token punctuation">(</span>
    factor_df<span class="token operator">=</span>factor_df<span class="token punctuation">,</span><span class="token comment">#因子或者仓位矩阵</span>
    chg_n<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token comment">#调仓周期</span>
    univ_data<span class="token operator">=</span>univ_a<span class="token punctuation">,</span><span class="token comment">#股票池</span>
    rtn_df<span class="token operator">=</span>rtn_df<span class="token punctuation">,</span><span class="token comment">#股票每日收益矩阵</span>
    idx_rtn<span class="token operator">=</span>idx_rtn<span class="token punctuation">,</span><span class="token comment">#因子收益序列（用来hg对冲）</span>
    forbid_days<span class="token operator">=</span>forb_days<span class="token punctuation">,</span><span class="token comment">#st*suspend*limit</span>
    method<span class="token operator">=</span><span class="token string">'factor'</span><span class="token punctuation">,</span><span class="token comment">#factorls_alphahg_alpha（原始因子、指数对冲、多空对冲）</span>
    group_split_ls<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.6</span><span class="token punctuation">,</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment">#分组回测参数</span>
<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a4/b5/hY0zTu7J_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/02/03/yQiQak3z_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/27/05/63tg8asw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a1/d1/s6nWOpOq_o.png" alt="在这里插入图片描述"></p> 
<p>指数对冲</p> 
<pre><code class="prism language-python"><span class="token comment">#排序选股，构建仓位</span>
factor_rank_pct <span class="token operator">=</span> factor_df<span class="token punctuation">.</span>rank<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> pct<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
factor_selected <span class="token operator">=</span> factor_df<span class="token punctuation">[</span>factor_rank_pct<span class="token operator">&gt;</span><span class="token number">0.8</span><span class="token punctuation">]</span>
factor_selected <span class="token operator">=</span> factor_selected<span class="token punctuation">.</span>where<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>factor_selected<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
pos <span class="token operator">=</span> factor_selected<span class="token punctuation">.</span>div<span class="token punctuation">(</span>factor_selected<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
pos <span class="token operator">=</span> pos<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">#重要，否则ffill会出错</span>


factor_stats<span class="token punctuation">(</span>
    factor_df <span class="token operator">=</span> pos<span class="token punctuation">,</span>
    chg_n<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
    univ_data<span class="token operator">=</span>univ_a<span class="token punctuation">,</span>
    rtn_df<span class="token operator">=</span>rtn_df<span class="token punctuation">,</span>
    idx_rtn<span class="token operator">=</span>idx_rtn<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>np<span class="token punctuation">.</span>inf<span class="token punctuation">,</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token operator">-</span>np<span class="token punctuation">.</span>inf<span class="token punctuation">,</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">)</span><span class="token punctuation">,</span>
    forbid_days<span class="token operator">=</span>forb_days<span class="token punctuation">,</span>
    method<span class="token operator">=</span><span class="token string">'hg_alpha'</span><span class="token punctuation">,</span><span class="token comment">#factorls_alphahg_alpha</span>
<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a0/60/fbcPmWGY_o.png" alt="在这里插入图片描述"></p> 
<p>多空对冲</p> 
<pre><code class="prism language-python">factor_df <span class="token operator">=</span> factor_df<span class="token punctuation">.</span>reindex_like<span class="token punctuation">(</span>univ_a<span class="token punctuation">)</span><span class="token operator">*</span>univ_a
factor_rank_pct <span class="token operator">=</span> factor_df<span class="token punctuation">.</span>rank<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> pct<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment">#多头仓位</span>
factor_selected <span class="token operator">=</span> factor_df<span class="token punctuation">[</span>factor_rank_pct<span class="token operator">&gt;</span><span class="token number">0.8</span><span class="token punctuation">]</span>
factor_selected <span class="token operator">=</span> factor_selected<span class="token punctuation">.</span>where<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>factor_selected<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
pos_long <span class="token operator">=</span> factor_selected<span class="token punctuation">.</span>div<span class="token punctuation">(</span>factor_selected<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">#空头仓位</span>
factor_selected <span class="token operator">=</span> factor_df<span class="token punctuation">[</span>factor_rank_pct<span class="token operator">&lt;</span><span class="token number">0.2</span><span class="token punctuation">]</span>
factor_selected <span class="token operator">=</span> factor_selected<span class="token punctuation">.</span>where<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>factor_selected<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
pos_short <span class="token operator">=</span> factor_selected<span class="token punctuation">.</span>div<span class="token punctuation">(</span>factor_selected<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

factor_stats<span class="token punctuation">(</span>
    factor_df <span class="token operator">=</span> pos_long<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> pos_short<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    chg_n<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
    univ_data<span class="token operator">=</span>univ_a<span class="token punctuation">,</span>
    rtn_df<span class="token operator">=</span>rtn_df<span class="token punctuation">,</span>
    idx_rtn<span class="token operator">=</span>idx_rtn<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>np<span class="token punctuation">.</span>inf<span class="token punctuation">,</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token operator">-</span>np<span class="token punctuation">.</span>inf<span class="token punctuation">,</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">)</span><span class="token punctuation">,</span>
    forbid_days<span class="token operator">=</span>forb_days<span class="token punctuation">,</span>
    method<span class="token operator">=</span><span class="token string">'ls_alpha'</span><span class="token punctuation">,</span><span class="token comment">#factorls_alphahg_alpha</span>
<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b7/e2/cAK2TtuP_o.png" alt="在这里插入图片描述"></p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>