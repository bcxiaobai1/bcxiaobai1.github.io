<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>CSAPP Shell Lab 实验报告 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CSAPP Shell Lab 实验报告</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <p><mark>前言：强烈建议先看完csapp第八章再做此实验，完整的tsh.c代码贴在文章末尾了</mark></p> 
<h1>
<a id="1_1"></a>1.准备知识</h1> 
<ol>
<li>进程的概念、状态以及控制进程的几个函数（fork,waitpid,execve）。</li>
<li>信号的概念，会编写正确安全的信号处理程序。</li>
<li>shell的概念，理解shell程序是如何利用进程管理和信号去执行一个命令行语句。</li>
</ol> 
<h1>
<a id="2_7"></a>2.实验目的</h1> 
<p>shell lab主要目的是为了熟悉进程控制和信号。具体来说需要比对16个test和rtest文件的输出，实现七个函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">)</span>：分析命令，并派生子进程执行 主要功能是解析cmdline并运行
<span class="token keyword">int</span> <span class="token function">builtin_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>：解析和执行bulidin命令，包括 quit<span class="token punctuation">,</span> fg<span class="token punctuation">,</span> bg<span class="token punctuation">,</span> and jobs
<span class="token keyword">void</span> <span class="token function">do_bgfg</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> 执行bg和fg命令
<span class="token keyword">void</span> <span class="token function">waitfg</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span>：实现阻塞等待前台程序运行结束
<span class="token keyword">void</span> <span class="token function">sigchld_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>：SIGCHID信号处理函数
<span class="token keyword">void</span> <span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>：信号处理函数，响应 <span class="token function">SIGINT</span> <span class="token punctuation">(</span>ctrl<span class="token operator">-</span>c<span class="token punctuation">)</span> 信号 
<span class="token keyword">void</span> <span class="token function">sigtstp_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>：信号处理函数，响应 <span class="token function">SIGTSTP</span> <span class="token punctuation">(</span>ctrl<span class="token operator">-</span>z<span class="token punctuation">)</span> 信号
</code></pre> 
<h1>
<a id="3_21"></a>3.实验环境</h1> 
<p>ubuntu12.04 (32位)环境</p> 
<h1>
<a id="4_25"></a>4.实验内容及操作步骤</h1> 
<p>通过阅读实验指导书我们知道此实验要求我们完成tsh.c中的七个函数从而实现一个简单的shell，能够处理前后台运行程序、能够处理ctrl+z、ctrl+c等信号。</p> 
<p>首先我们来看一下tsh.c具体内容。</p> 
<p>首先定义了一些宏</p> 
<pre><code class="prism language-c"><span class="token comment">/* 定义了一些宏 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXLINE</span>    <span class="token expression"><span class="token number">1024</span>   </span><span class="token comment">/* max line size */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXARGS</span>     <span class="token expression"><span class="token number">128</span>   </span><span class="token comment">/* max args on a command line */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXJOBS</span>      <span class="token expression"><span class="token number">16</span>   </span><span class="token comment">/* max jobs at any point in time */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXJID</span>    <span class="token expression"><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span>   </span><span class="token comment">/* max job ID */</span></span>
</code></pre> 
<p>定义了四种进程状态</p> 
<pre><code class="prism language-c"><span class="token comment">/* 工作状态 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UNDEF</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">/* undefined */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FG</span> <span class="token expression"><span class="token number">1</span>    </span><span class="token comment">/* 前台状态 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BG</span> <span class="token expression"><span class="token number">2</span>    </span><span class="token comment">/* 后台状态 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST</span> <span class="token expression"><span class="token number">3</span>    </span><span class="token comment">/* 挂起状态 */</span></span>
</code></pre> 
<p>然后定义了job_t的任务的类，并且创建了jobs[]数组</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token punctuation">{<!-- --></span>              <span class="token comment">/* The job struct */</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>              <span class="token comment">/* job PID */</span>
    <span class="token keyword">int</span> jid<span class="token punctuation">;</span>                <span class="token comment">/* job ID [1, 2, ...] */</span>
    <span class="token keyword">int</span> state<span class="token punctuation">;</span>              <span class="token comment">/* UNDEF, BG, FG, or ST */</span>
    <span class="token keyword">char</span> cmdline<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* command line */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">job_t</span> jobs<span class="token punctuation">[</span>MAXJOBS<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* The job list */</span>
</code></pre> 
<p>接着是需要我们完成的七个函数定义</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">)</span>：分析命令，并派生子进程执行 主要功能是解析cmdline并运行
<span class="token keyword">int</span> <span class="token function">builtin_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>：解析和执行bulidin命令，包括 quit<span class="token punctuation">,</span> fg<span class="token punctuation">,</span> bg<span class="token punctuation">,</span> and jobs
<span class="token keyword">void</span> <span class="token function">do_bgfg</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> 执行bg和fg命令
<span class="token keyword">void</span> <span class="token function">waitfg</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span>：实现阻塞等待前台程序运行结束
<span class="token keyword">void</span> <span class="token function">sigchld_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>：SIGCHID信号处理函数
<span class="token keyword">void</span> <span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>：信号处理函数，响应 <span class="token function">SIGINT</span> <span class="token punctuation">(</span>ctrl<span class="token operator">-</span>c<span class="token punctuation">)</span> 信号 
<span class="token keyword">void</span> <span class="token function">sigtstp_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>：信号处理函数，响应 <span class="token function">SIGTSTP</span> <span class="token punctuation">(</span>ctrl<span class="token operator">-</span>z<span class="token punctuation">)</span> 信号
</code></pre> 
<p>下面就是一些辅助的函数</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">parseline</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//获取参数列表，返回是否为后台运行命令</span>
<span class="token keyword">void</span> <span class="token function">sigquit_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//处理SIGQUIT信号</span>
<span class="token keyword">void</span> <span class="token function">clearjob</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//清除job结构体 </span>
<span class="token keyword">void</span> <span class="token function">initjobs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//初始化任务jobs[]</span>
<span class="token keyword">int</span> <span class="token function">maxjid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回jobs链表中最大的jid号。</span>
<span class="token keyword">int</span> <span class="token function">addjob</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//向jobs[]添加一个任务</span>
<span class="token keyword">int</span> <span class="token function">deletejob</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//在jobs[]中删除pid的job</span>
<span class="token class-name">pid_t</span> <span class="token function">fgpid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//返回当前前台运行job的pid号</span>
<span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span><span class="token function">getjobpid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//根据pid找到对应的job </span>
<span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span><span class="token function">getjobjid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token keyword">int</span> jid<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//根据jid找到对应的job </span>
<span class="token keyword">int</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//根据pid找到jid </span>
<span class="token keyword">void</span> <span class="token function">listjobs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//打印jobs </span>
</code></pre> 
<p>接着就是mian函数，作用是在文件中逐行获取命令，并且判断是不是文件结束（EOF），将命令cmdline送入eval函数进行解析。我们需要做的就是逐步完善这个过程</p> 
<p>接下来开始实验：</p> 
<ol><li>使用make命令编译tsh.c文件（文件有所改变的话需要先使用make clean指令清空）</li></ol> 
<pre><code class="prism language-c">bo@bo<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>shlab<span class="token operator">-</span>handout$ make
gcc <span class="token operator">-</span>Wall <span class="token operator">-</span>O2    tsh<span class="token punctuation">.</span>c   <span class="token operator">-</span>o tsh
gcc <span class="token operator">-</span>Wall <span class="token operator">-</span>O2    myspin<span class="token punctuation">.</span>c   <span class="token operator">-</span>o myspin
gcc <span class="token operator">-</span>Wall <span class="token operator">-</span>O2    mysplit<span class="token punctuation">.</span>c   <span class="token operator">-</span>o mysplit
gcc <span class="token operator">-</span>Wall <span class="token operator">-</span>O2    mystop<span class="token punctuation">.</span>c   <span class="token operator">-</span>o mystop
gcc <span class="token operator">-</span>Wall <span class="token operator">-</span>O2    myint<span class="token punctuation">.</span>c   <span class="token operator">-</span>o myint
</code></pre> 
<ol start="2">
<li> <p>使用make testXX指令比较traceXX.txt文件在编写的shell和reference shell的运行结果；或者也可以使用”./sdriver.pl -t traceXX.txt -s ./tsh -a “-p”</p> </li>
<li> <p>如果在文件名前面加上r，则是执行标准的tshref，或者将tsh变为tshref。通过比对标准tshref和自制tsh的执行结果结果，可以观察tsh的功能是否正确。如果tsh的执行结果和tshref结果一致，说明结果是正确的</p> </li>
</ol> 
<p>接下来我们开始补充函数</p> 
<h2>
<a id="eval_106"></a>eval（）函数</h2> 
<p><strong>函数功能</strong>：eval函数用于解析和解释命令行。eval首先解析命令行，如果用户请求一个内置命令quit、jobs、bg或fg（即内置命令）那么就立即执行。否则，fork子进程和在子进程的上下文中运行作业。如果作业正在运行前台，等待它终止，然后返回。</p> 
<p><strong>函数原型</strong>：<code>void eval(char *cmdline)</code>，传入的参数为cmdline，即命令行字符串</p> 
<p><strong>实现思路</strong>：仿照书上的eval函数写法和所需的功能来完成函数</p> 
<ol>
<li>首先调用parseline函数解析命令行，如果为空直接返回，接着使用builtin_cmd函数判断是否为内置命令，返回0说明不是内置命令，如果是内置命令直接执行。</li>
<li>如果不是内置命令，那么先阻塞信号（具体在第四点分析），再调用fork创建子进程。在子进程中，首先解除阻塞，设置自己的id号，然后调用execve函数来执行job。</li>
<li>父进程判断作业是否后台运行，是的话调用addjob函数将子进程job加入job链表中，解除阻塞，然后调用waifg函数等待前台运行完成。如果不在后台工作则打印进程组jid和子进程pid以及命令行字符串。</li>
<li>因为子进程继承了他们父进程的阻塞向量，所以在执行新程序之前，子程序必须确保解除对SIGCHLD信号的阻塞。父进程必须使用sigprocmask在它派生子进程之前也就是调用fork函数之前阻塞SIGCHLD信号，之后解除阻塞；在通过调用addjob将子进程添加到作业列表之后，再次使用sigprocmask，解除阻塞。</li>
</ol> 
<p>完整代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span>MAXARGS<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//execve()函数的参数</span>
    <span class="token keyword">int</span> state <span class="token operator">=</span> UNDEF<span class="token punctuation">;</span>  <span class="token comment">//工作状态，FG或BG </span>
    <span class="token class-name">sigset_t</span> set<span class="token punctuation">;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>  <span class="token comment">//进程id</span>
    <span class="token comment">// 处理输入的数据</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">parseline</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">,</span> argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//解析命令行，返回给argv数组</span>
        state <span class="token operator">=</span> BG<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        state <span class="token operator">=</span> FG<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  <span class="token comment">//命令行为空直接返回</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果不是内置命令</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">builtin_cmd</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"sigemptyset error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGTSTP<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGCHLD<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"sigaddset error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在它派生子进程之前阻塞SIGCHLD信号，防止竞争 </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"sigprocmask error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//fork创建子进程失败 </span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//fork创建子进程</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 子进程的控制流开始</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//解除阻塞</span>
                <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"sigprocmask error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//设置子进程id </span>
                <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"setpgid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">execve</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> environ<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: command not foundn"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将当前进程添加进job中，无论是前台进程还是后台进程</span>
        <span class="token function">addjob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> state<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 恢复受阻塞的信号 SIGINT SIGTSTP SIGCHLD</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"sigprocmask error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 判断子进程类型并做处理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>state <span class="token operator">==</span> FG<span class="token punctuation">)</span>
            <span class="token function">waitfg</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//前台作业等待</span>
        <span class="token keyword">else</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] (%d) %s"</span><span class="token punctuation">,</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将进程id映射到job id   </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意：</p> 
<ol>
<li>每个子进程必须有自己独一无二的进程组id，通过在fork()之后的子进程中Setpgid(0,0)实现，这样当向前台程序发送ctrl+c或ctrl+z命令时，才不会影响到后台程序。如果没有这一步，则所有的子进程与当前的tsh shell进程为同一个进程组，发送信号时，前后台的子进程均会收到。</li>
<li>在fork()新进程前要阻塞SIGCHLD信号，防止出现竞争，这是经典的同步错误，如果不阻塞会出现子进程先结束从jobs中删除，然后再执行到主进程addjob的竞争问题。</li>
</ol> 
<h2>
<a id="builtin_cmd_180"></a>builtin_cmd函数</h2> 
<p><strong>函数功能</strong>：识别并执行内置命令: quit, fg, bg, 和 jobs。</p> 
<p><strong>函数原型</strong>：<code>int builtin_cmd(char **argv)</code>，参数为argv 参数列表</p> 
<p><strong>实现思路</strong>：</p> 
<ol>
<li> <p>当命令行参数为quit时，直接终止shell</p> </li>
<li> <p>当命令行参数为jobs时，调用listjobs函数，显示job列表</p> </li>
<li> <p>当命令行参数为bg或fg时，调用do_bgfg函数，执行内置的bg和fg命令</p> </li>
<li> <p>不是内置命令时返回0</p> </li>
</ol> 
<p>完整代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">builtin_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"quit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//如果命令是quit，退出</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"bg"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"fg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//如果是bg或者fg命令，执行do_fgbg函数 </span>
        <span class="token function">do_bgfg</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"jobs"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//如果命令是jobs，列出正在运行和停止的后台作业</span>
        <span class="token function">listjobs</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">/* not a builtin command */</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="do_bgfg_210"></a>do_bgfg函数</h2> 
<p><strong>函数功能</strong>：实现内置命令bg 和 fg</p> 
<p>首先要明确的是bg和bg的作用</p> 
<blockquote> 
 <p><code>bg &lt;job&gt;</code>:将停止的后台作业更改为正在运行的后台作业。通过发送SIGCONT信号重新启动<code>&lt;job&gt;</code>，然后在后台运行它。<code>&lt;job&gt;</code>参数可以是PID，也可以是JID。ST -&gt; BG</p> 
 <p><code>fg &lt;job&gt;</code>:将已停止或正在运行的后台作业更改为前台正在运行的作业。通过发送SIGCONT信号重新启<code>&lt;job&gt;</code>，然后在前台运行它。<code>&lt;job&gt;</code>参数可以是PID，也可以是JID。ST -&gt; FG，BG -&gt; FG</p> 
</blockquote> 
<p><strong>函数原型</strong>：<code>void do_bgfg(char **argv)</code>，参数为argv 参数列表</p> 
<p><strong>实现思路</strong>：</p> 
<ol>
<li>判断argv[]是否带%，若为整数则传入pid，若带%则传入jid。接着调用getjobjid函数来获得对应的job结构体，如果返回为空，说明列表中并不存在jid的job，要输出提示。</li>
<li>使用strcmp函数判断是bg命令还是fg命令</li>
<li>若是bg，使目标进程重新开始工作，设置状态为BG(后台)，打印进程信息</li>
<li>若是fg，使目标进程重新开始工作，设置状态为FG(前台)，等待进程结束</li>
</ol> 
<p>完整代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">do_bgfg</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> num<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job<span class="token punctuation">;</span>
    <span class="token comment">// 没有参数的fg/bg应该被丢弃</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//命令行为空</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s command requires PID or %%jobid argumentn"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 检测fg/bg参数，其中%开头的数字是JobID，纯数字的是PID</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'%'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//解析jid</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: argument must be a PID or %%jobidn"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//失败,打印错误消息</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>job <span class="token operator">=</span> <span class="token function">getjobjid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%%%d: No such jobn"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//没找到对应的job </span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: argument must be a PID or %%jobidn"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//失败,打印错误消息</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>job <span class="token operator">=</span> <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"(%d): No such processn"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//没找到对应的进程 </span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"bg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// bg会启动子进程，并将其放置于后台执行</span>
        job<span class="token operator">-&gt;</span>state <span class="token operator">=</span> BG<span class="token punctuation">;</span>  <span class="token comment">//设置状态 </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>job<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> SIGCONT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//采用负数发送信号到进程组 </span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"kill error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] (%d) %s"</span><span class="token punctuation">,</span> job<span class="token operator">-&gt;</span>jid<span class="token punctuation">,</span> job<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> job<span class="token operator">-&gt;</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"fg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        job<span class="token operator">-&gt;</span>state <span class="token operator">=</span> FG<span class="token punctuation">;</span>  <span class="token comment">//设置状态 </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>job<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> SIGCONT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//采用负数发送信号到进程组 </span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"kill error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 当一个进程被设置为前台执行时，当前tsh应该等待该子进程结束</span>
        <span class="token function">waitfg</span><span class="token punctuation">(</span>job<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"do_bgfg: Internal error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="waitfg_283"></a>waitfg（）函数</h2> 
<p><strong>函数功能</strong>：等待一个前台作业结束，或者说是阻塞一个前台的进程直到这个进程变为后台进程</p> 
<p><strong>函数原型</strong>：<code>void waitfg(pid_t pid) </code>，参数为进程ID</p> 
<p><strong>实现思路</strong>：判断当前的前台的进程组pid是否和当前进程的pid是否相等，如果相等则sleep直到前台进程结束。</p> 
<p>完整代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">waitfg</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job <span class="token operator">=</span> <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>job<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果当前子进程的状态没有发生改变，则tsh继续休眠</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>job<span class="token operator">-&gt;</span>state <span class="token operator">==</span> FG<span class="token punctuation">)</span>
        <span class="token comment">// 使用sleep的这段代码会比较慢，最好使用sigsuspend</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="sigchld_handler_307"></a>sigchld_handler函数</h2> 
<p><strong>函数功能</strong>：处理SIGCHILD信号</p> 
<p><strong>函数原型</strong>：<code>void sigchld_handler(int sig)</code>，参数为信号类型</p> 
<p>首先了解一下父进程回收子进程的过程：当一个子进程终止或者停止时，内核会发送一个SIGCHLD信号给父进程。因此父进程必须回收子进程，以避免在系统中留下僵死进程。父进程捕获这个SIGCHLD信号，回收一个子进程。一个进程可以通过调用 waitpid 函数来等待它的子进程终止或者停止。如果回收成功，则返回为子进程的 PID, 如果 WNOHANG, 则返回为 0, 如果其他错误，则为 -1。</p> 
<p><strong>实现思路</strong>：</p> 
<ul>
<li>用while循环调用waitpid直到它所有的子进程终止。</li>
<li>检查己回收子进程的退出状态 
  <ul>
<li>WIFSTOPPED：：引起返回的子进程当前是被停止的</li>
<li>WIFSIGNALED：子进程是因为一个未被捕获的信号终止</li>
<li>WIFEXITED：子进程通过调用exit 或者return正常终止</li>
</ul> </li>
<li>然后分别用WSTOPSIG，WTERMSIG，WEXITSTATUS提取以上三个退出状态。注意如果引起返回的子进程当前是被停止的进程，那么要将其状态设置为ST</li>
</ul> 
<p>完整代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">sigchld_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> status<span class="token punctuation">,</span> jid<span class="token punctuation">;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigchld_handler: entering"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
    以非阻塞方式等待所有子进程
    waitpid 参数3：
        1.     0     ： 执行waitpid时， 只有在子进程 **终止** 时才会返回。
        2. WNOHANG   : 若子进程仍然在运行，则返回0 。
                注意只有设置了这个标志，waitpid才有可能返回0
        3. WUNTRACED : 如果子进程由于传递信号而停止，则马上返回。
                只有设置了这个标志，waitpid返回时，其WIFSTOPPED(status)才有可能返回true
    */</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> WNOHANG <span class="token operator">|</span> WUNTRACED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

        <span class="token comment">// 如果当前这个子进程的job已经删除了，则表示有错误发生</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>job <span class="token operator">=</span> <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Lost track of (%d)n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        jid <span class="token operator">=</span> job<span class="token operator">-&gt;</span>jid<span class="token punctuation">;</span>
        <span class="token comment">//接下来判断三种状态 </span>
        <span class="token comment">// 如果这个子进程收到了一个暂停信号（还没退出） </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSTOPPED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Job [%d] (%d) stopped by signal %dn"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> job<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> <span class="token function">WSTOPSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            job<span class="token operator">-&gt;</span>state <span class="token operator">=</span> ST<span class="token punctuation">;</span>  <span class="token comment">//状态设为挂起 </span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果子进程通过调用 exit 或者一个返回 (return) 正常终止</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">deletejob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigchld_handler: Job [%d] (%d) deletedn"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigchld_handler: Job [%d] (%d) terminates OK (status %d)n"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果子进程是因为一个未被捕获的信号终止的，例如SIGKILL</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">deletejob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//清除进程</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigchld_handler: Job [%d] (%d) deletedn"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Job [%d] (%d) terminated by signal %dn"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//返回导致子进程终止的信号的数量</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigchld_handler: exiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="sigint_handler_386"></a>sigint_handler函数</h2> 
<p><strong>函数功能</strong>：捕获SIGINT信号</p> 
<p><strong>函数原型</strong>：<code>void sigchld_handler(int sig)</code>，参数为信号类型</p> 
<p><strong>实现思路</strong>：</p> 
<ol>
<li>调用函数fgpid返回前台进程pid</li>
<li>如果当前进程pid不为0，那么调用kill函数发送SIGINT信号给前台进程组</li>
<li>在2中调用kill函数如果返回值为-1表示进程不存在。输出error</li>
</ol> 
<p>完整代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigint_handler: entering"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 发送SIGINT给前台进程组里的所有进程</span>
        <span class="token comment">// 需要注意的是，前台进程组内的进程除了当前前台进程以外，还包括前台进程的子进程。</span>
        <span class="token comment">// 最多只能存在一个前台进程，但前台进程组内可以存在多个进程</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>pid<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"kill (sigint) error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigint_handler: Job (%d) killedn"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigint_handler: exiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="sigtstp_handler_424"></a>sigtstp_handler函数</h2> 
<p><strong>函数功能</strong>：同sigint_handler差不多，捕获SIGTSTP信号</p> 
<p><strong>函数原型</strong>：<code>void sigtstp_handler(int sig) </code>，参数为信号类型</p> 
<p>首先了解一下SIGTSTP的作用：SIGTSPT信号默认行为是停止直到下一个 SIGCONT，是来自终端的停止信号，在键盘上输入 CTR+Z会导致一个 SIGTSPT信号被发送到外壳。外壳捕获该信号，然后发送SIGTSPT信号到这个前台进程组中的每个进程。在默认情况下，结果是停止或挂起前台作业。</p> 
<p><strong>实现思路</strong>：</p> 
<ol>
<li>用fgpid(jobs)获取前台进程pid，判断当前是否有前台进程，如果没有直接返回。</li>
<li>用kill(-pid,sig)函数发送SIGTSPT信号给前台进程组。</li>
</ol> 
<p>完整代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">sigtstp_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigstp_handler: entering"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job <span class="token operator">=</span> <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>pid<span class="token punctuation">,</span> SIGTSTP<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"kill (tstp) error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigstp_handler: Job [%d] (%d) stoppedn"</span><span class="token punctuation">,</span> job<span class="token operator">-&gt;</span>jid<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigstp_handler: exiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意：使用kill函数，如果 pid 小于零才会发送信号sig 给进程组中的每个进程，因此这里使用-pid。</p> 
<p>至此tsh.c文件完成。</p> 
<p>接下来我们分析以下测试文件的内容并看下我们的函数能否完成测试</p> 
<p>首先了解一下一些测试文件的符号和命令的定义：</p> 
<p><strong>符号</strong>：</p> 
<ul>
<li>空格：分隔指令作用</li>
<li>&amp;：如果命令以&amp;结尾，表示标该作业在后台运行</li>
<li>#：直接打印#后一行的文本内容</li>
<li>%：后接一个整数，表示job的ID号。</li>
</ul> 
<p><strong>命令</strong>：</p> 
<ul>
<li>jobs: 列出正在运行和停止的后台作业</li>
<li>
<code>bg &lt;job&gt;</code>: 将停止的后台作业更改为正在运行的后台作业</li>
<li>
<code>fg &lt;job&gt;</code>:将已停止或正在运行的后台作业更改为前台正在运行的作业</li>
<li>kill : 终止一个作业</li>
</ul> 
<p><strong>用户程序</strong>：</p> 
<ul>
<li>myint程序：函数睡眠，使程序睡眠n秒，运行结束后不会自动退出，并会检测系统错误；</li>
<li>myspin程序：函数睡眠，使程序睡眠n秒，在睡眠结束后就自动退出，不检测系统错误；</li>
<li>mysplit程序：函数睡眠，使程序睡眠n秒，创建一个子进程进行睡眠，然后父进程等待子进程正常睡眠n秒后，继续运行；</li>
<li>mystop程序：让进程暂定n秒，并发送信号。</li>
</ul> 
<h2>
<a id="EOF_488"></a>第一关-正确地终止EOF</h2> 
<p>首先打开 trace01.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">01.</span>txt <span class="token operator">-</span> Properly terminate on <span class="token constant">EOF</span><span class="token punctuation">.</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>
<span class="token expression">CLOSE</span></span>
WAIT
</code></pre> 
<p>#可以理解为//，不需要我们解析。第一关调用了linux命令close关闭文件并wait等待，在EOF上正常终止，所以不需要我们做任何事</p> 
<p>输入<code>make test01</code>和<code>make rtest01</code>查看运行结果<br> <img src="https://images2.imgbox.com/f7/b7/ZqR0dDiD_o.png" alt="在这里插入图片描述"></p> 
<p>tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="quit_505"></a>第二关-进程内置quit命令</h2> 
<p>打开 trace02.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">02.</span>txt <span class="token operator">-</span> Process builtin quit command<span class="token punctuation">.</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>
<span class="token directive keyword">quit</span></span>
WAIT
</code></pre> 
<p>第二关需要我们针对输入的命令quit退出shell进程，我们需要解析cmdline（输入的命令），判断是不是“quit”字符串，是就退出。</p> 
<p>输入<code>make test02</code>和<code>make rtest02</code>查看运行结果<br> <img src="https://images2.imgbox.com/e2/ae/zTINlbqY_o.png" alt="在这里插入图片描述"></p> 
<p>tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="job_522"></a>第三关-运行一个前台job</h2> 
<p>打开 trace03.txt查看文件内容</p> 
<pre><code class="prism language-c">#

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">03.</span>txt <span class="token operator">-</span> Run a foreground job<span class="token punctuation">.</span></span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> quit
quit
</code></pre> 
<p>这里解释一下/bin/echo：</p> 
<p>eval函数先通过builtin_cmd查询cmdline是不是内置命令如quit，如果是则当前进程执行命令</p> 
<p>如果不是则创建一个子进程，在子进程中调用 execve()函数通过 argv[0]来寻找路径，并在子进程中运行路径中的可执行文件，如果找不到则说明命令为无效命令，输出命令无效，并用 exit(0)结束该子进程</p> 
<p>/bin/echo就是打开bin目录下的echo文件，echo可以理解为将其后面的内容当作字符串输出</p> 
<p>所以第三关的任务是：</p> 
<ul>
<li>首先是/bin/echo tsh&gt; quit 意思是打开 bin 目录下的 echo 可执行文件，在 foregound 开启一个子进程运行它（因为末尾没有&amp;符号，如果有，就是在 backgound 运行）</li>
<li>运行 echo 这个进程的过程中，通过 tsh&gt;quit 命令，调用 tsh并执行内置命令 quit，退出 echo 这个子进程</li>
<li>最后在 tsh 中执行内置命令 quit，退出 tsh 进程，回到我们的终端。</li>
</ul> 
<p>输入<code>make test03</code>和<code>make rtest03</code>查看运行结果</p> 
<p><img src="https://images2.imgbox.com/6b/b6/CixaE40T_o.png" alt="在这里插入图片描述"></p> 
<p>tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="job_555"></a>第四关-运行后台job</h2> 
<p>打开 trace04.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">04.</span>txt <span class="token operator">-</span> Run a background job<span class="token punctuation">.</span></span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">1</span> <span class="token number">046</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">1</span> <span class="token operator">&amp;</span>
</code></pre> 
<p>先在前台执行echo命令，等待程序执行完毕回收子进程。&amp;代表是一个后台程序，myspin睡眠1秒，然后停止。因为在后台，所以显示下面一句，如果在前台则无。</p> 
<p>输入<code>make test04</code>和<code>make rtest04</code>查看运行结果<br> <img src="https://images2.imgbox.com/f4/ba/NdYXFGnr_o.png" alt="在这里插入图片描述"><br> tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="jobs_572"></a>第五关-处理jobs内置命令</h2> 
<p>打开 trace05.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">05.</span>txt <span class="token operator">-</span> Process jobs builtin command<span class="token punctuation">.</span></span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">2</span> <span class="token number">046</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">2</span> <span class="token operator">&amp;</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">3</span> <span class="token number">046</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">3</span> <span class="token operator">&amp;</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs
</code></pre> 
<p>分别运行了前台echo、后台myspin、前台echo、后台myspin，然后需要实现一个内置命令job，功能是显示目前任务列表中的所有任务的所有属性</p> 
<p>输入<code>make test05</code>和<code>make rtest05</code>查看运行结果<br> <img src="https://images2.imgbox.com/e5/7a/RXKJhIbf_o.png" alt="在这里插入图片描述"><br> tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="SIGINT_593"></a>第六关-将SIGINT转发到前台作业</h2> 
<p>打开 trace06.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">06.</span>txt <span class="token operator">-</span> Forward SIGINT to foreground job<span class="token punctuation">.</span></span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> 

SLEEP <span class="token number">2</span>
INT
</code></pre> 
<p>接收到了中断信号SIGINT（即CTRL_C)那么结束前台进程</p> 
<p>输入<code>make test06</code>和<code>make rtest06</code>查看运行结果<br> <img src="https://images2.imgbox.com/cf/ce/2I20qa9G_o.png" alt="在这里插入图片描述"><br> tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="SIGINT_611"></a>第七关-仅将SIGINT转发给前台作业</h2> 
<p>打开 trace07.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">07.</span>txt <span class="token operator">-</span> Forward SIGINT only to foreground job<span class="token punctuation">.</span></span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token number">046</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token operator">&amp;</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">5</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">5</span> 

SLEEP <span class="token number">2</span>
INT

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs
</code></pre> 
<p>根据注释，我们可以知道第七关测试的是只将SIGINT转发给前台作业。这里的命令行其实根据前面的就很好理解了，就是给出两个作业，一个在前台工作，另一个在后台工作，接下来传递SIGINT指令，然后调用内置指令jobs来查看此时的工作信息，来对比出是不是只将SIGINT转发给前台作业。</p> 
<p>输入<code>make test07</code>和<code>make rtest07</code>查看运行结果<br> <img src="https://images2.imgbox.com/5d/b3/SQQFRmDd_o.png" alt="在这里插入图片描述"><br> tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="SIGTSTP_636"></a>第八关-仅将SIGTSTP转发到前台作业</h2> 
<p>打开 trace08.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">08.</span>txt <span class="token operator">-</span> Forward SIGTSTP only to foreground job<span class="token punctuation">.</span></span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token number">046</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token operator">&amp;</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">5</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">5</span> 

SLEEP <span class="token number">2</span>
TSTP

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs
</code></pre> 
<p>根据注释我们是需要将SIGTSTP转发给前台作业。根据这个信号的作用，也就是该进程会停止直到下一个SIGCONT也就是挂起，让别的程序继续运行。这里也就是运行了后台程序，然后使用jobs来打印出进程的信息。</p> 
<p>输入<code>make test08</code>和<code>make rtest08</code>查看运行结果<br> <img src="https://images2.imgbox.com/e7/f5/0zhRTlgf_o.png" alt="在这里插入图片描述"><br> tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="bg_660"></a>第九关-进程bg内置命令</h2> 
<p>打开 trace09.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">09.</span>txt <span class="token operator">-</span> Process bg builtin command</span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token number">046</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token operator">&amp;</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">5</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">5</span> 

SLEEP <span class="token number">2</span>
TSTP

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> bg <span class="token operator">%</span><span class="token number">2</span>
bg <span class="token operator">%</span><span class="token number">2</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs
</code></pre> 
<p>这里是在第八关的测试文件之上的一个更加完整的测试，这里也就是在停止后，输出进程信息之后，使用bg命令来唤醒进程2，也就是刚才被挂起的程序，接下来继续使用Jobs命令来输出结果。</p> 
<p>输入<code>make test09</code>和<code>make rtest09</code>查看运行结果<br> <img src="https://images2.imgbox.com/bf/5e/vLutsGd3_o.png" alt="在这里插入图片描述"><br> tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="fg_690"></a>第十关-进程fg内置命令</h2> 
<p>打开 trace10.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">10.</span>txt <span class="token operator">-</span> Process fg builtin command<span class="token punctuation">.</span> </span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token number">046</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token operator">&amp;</span>

SLEEP <span class="token number">1</span>
<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> fg <span class="token operator">%</span><span class="token number">1</span>
fg <span class="token operator">%</span><span class="token number">1</span>

SLEEP <span class="token number">1</span>
TSTP

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> fg <span class="token operator">%</span><span class="token number">1</span>
fg <span class="token operator">%</span><span class="token number">1</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs
</code></pre> 
<p>这里是将后台的进程更改为前台正在运行的程序。测试文中进程1根据&amp;可以知道，进程1是一个后台进程。先使用fg命令将其转化为前台的一个程序，接下来停止进程1，然后打印出进程信息，这时候进程1应该是前台程序同时被挂起了，接下来使用fg命令使其继续运行，使用jobs来打印出进程信息</p> 
<p>输入<code>make test10</code>和<code>make rtest10</code>查看运行结果<br> <img src="https://images2.imgbox.com/8e/ca/rTZ6ClT8_o.png" alt="在这里插入图片描述"><br> tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="SIGINT_722"></a>第十一关-将SIGINT转发给前台进程组中的每个进程</h2> 
<p>打开 trace11.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">11.</span>txt <span class="token operator">-</span> Forward SIGINT to every process in foreground process group</span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>mysplit <span class="token number">4</span>
<span class="token punctuation">.</span><span class="token operator">/</span>mysplit <span class="token number">4</span> 

SLEEP <span class="token number">2</span>
INT

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> <span class="token operator">/</span>bin<span class="token operator">/</span>ps a
<span class="token operator">/</span>bin<span class="token operator">/</span>ps a
</code></pre> 
<p>根据注释我们可以知道这里需要将SIGINT发给前台进程组中的每个进程。ps –a 显示所有进程，这里是有两个进程的，mysplit创建了一个子进程，接下来发送指令SIGINT，所以进程组中的所有进程都应该停止，接下来调用pl来查看该进程组中的每个进程是否都停止了。</p> 
<p>输入<code>make test11</code>和<code>make rtest11</code>查看运行结果<br> <img src="https://images2.imgbox.com/5e/6f/bKVCxh4B_o.png" alt="在这里插入图片描述"><br> tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="SIGTSTP_744"></a>第十二关-将SIGTSTP转发到前台进程组中的每个进程</h2> 
<p>打开 trace12.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">12.</span>txt <span class="token operator">-</span> Forward SIGTSTP to every process in foreground process group</span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>mysplit <span class="token number">4</span>
<span class="token punctuation">.</span><span class="token operator">/</span>mysplit <span class="token number">4</span> 

SLEEP <span class="token number">2</span>
TSTP

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> <span class="token operator">/</span>bin<span class="token operator">/</span>ps a
<span class="token operator">/</span>bin<span class="token operator">/</span>ps a
</code></pre> 
<p>根据注释可知该测试程序是为了测试将SIGTSTP转发给前台进程组中的每个进程。与上一关相同，只需要相应的进程被挂起即可。</p> 
<p>输入<code>make test12</code>和<code>make rtest12</code>查看运行结果</p> 
<p><img src="https://images2.imgbox.com/a4/28/fIn79y5E_o.png" alt="在这里插入图片描述"><br> tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="_770"></a>第十三关-重新启动进程组中的每个已停止的进程</h2> 
<p>打开 trace13.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">13.</span>txt <span class="token operator">-</span> Restart every stopped process in process group</span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>mysplit <span class="token number">4</span>
<span class="token punctuation">.</span><span class="token operator">/</span>mysplit <span class="token number">4</span> 

SLEEP <span class="token number">2</span>
TSTP

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> <span class="token operator">/</span>bin<span class="token operator">/</span>ps a
<span class="token operator">/</span>bin<span class="token operator">/</span>ps a

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> fg <span class="token operator">%</span><span class="token number">1</span>
fg <span class="token operator">%</span><span class="token number">1</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> <span class="token operator">/</span>bin<span class="token operator">/</span>ps a
<span class="token operator">/</span>bin<span class="token operator">/</span>ps a
</code></pre> 
<p>根据注释我们可以知道该程序是为了测试重新启动进程组中的每个停止的进程。这里也就是使用fg来唤醒整个工作，中间使用ps -a来查看停止整个工作和唤醒整个工作的区别。</p> 
<p>输入<code>make test13</code>和<code>make rtest13</code>查看运行结果<br> <img src="https://images2.imgbox.com/52/f1/oPpX1NcS_o.png" alt="在这里插入图片描述"></p> 
<p>tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="_801"></a>第十四关-简单的错误处理</h2> 
<p>打开 trace14.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">14.</span>txt <span class="token operator">-</span> Simple error handling</span></span>
#
<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>bogus
<span class="token punctuation">.</span><span class="token operator">/</span>bogus

<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token number">046</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token operator">&amp;</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> fg
fg

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> bg
bg

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> fg a
fg a

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> bg a
bg a

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> fg <span class="token number">9999999</span>
fg <span class="token number">9999999</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> bg <span class="token number">9999999</span>
bg <span class="token number">9999999</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> fg <span class="token operator">%</span><span class="token number">2</span>
fg <span class="token operator">%</span><span class="token number">2</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> fg <span class="token operator">%</span><span class="token number">1</span>
fg <span class="token operator">%</span><span class="token number">1</span>

SLEEP <span class="token number">2</span>
TSTP

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> bg <span class="token operator">%</span><span class="token number">2</span>
bg <span class="token operator">%</span><span class="token number">2</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> bg <span class="token operator">%</span><span class="token number">1</span>
bg <span class="token operator">%</span><span class="token number">1</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs
</code></pre> 
<p>根据注释可以知道这个文件是为了测试简单的错误处理。这里的测试文件，也就是测试fg和bg后面的参数，我们知道fg和bg后面需要一个JID或者是PID，其中JID是加上%的整型数。其余参数都应该报错，或是没有参数也应该报错。接下来测试的功能，都在上面的关卡测试过了</p> 
<p>输入<code>make test14</code>和<code>make rtest14</code>查看运行结果<br> <img src="https://images2.imgbox.com/47/60/UkRO6Zlu_o.png" alt="在这里插入图片描述"></p> 
<p>tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="_856"></a>第十五关-把它们放在一起</h2> 
<p>打开 trace15.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">15.</span>txt <span class="token operator">-</span> Putting it all together</span></span>
#

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>bogus
<span class="token punctuation">.</span><span class="token operator">/</span>bogus

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">10</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">10</span>

SLEEP <span class="token number">2</span>
INT

<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">3</span> <span class="token number">046</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">3</span> <span class="token operator">&amp;</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo <span class="token operator">-</span>e tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token number">046</span>
<span class="token punctuation">.</span><span class="token operator">/</span>myspin <span class="token number">4</span> <span class="token operator">&amp;</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> fg <span class="token operator">%</span><span class="token number">1</span>
fg <span class="token operator">%</span><span class="token number">1</span>

SLEEP <span class="token number">2</span>
TSTP

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> bg <span class="token operator">%</span><span class="token number">3</span>
bg <span class="token operator">%</span><span class="token number">3</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> bg <span class="token operator">%</span><span class="token number">1</span>
bg <span class="token operator">%</span><span class="token number">1</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> fg <span class="token operator">%</span><span class="token number">1</span>
fg <span class="token operator">%</span><span class="token number">1</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> quit
quit

</code></pre> 
<p>根据注释这个测试文件测试的是把它们放在一起。本来还纳闷放在一起是什么意思呢？仔细阅读测试文件，可以知道他是测试了上述所有命令，如jobs,fg,bg,quit。</p> 
<p>输入<code>make test15</code>和<code>make rtest15</code>查看运行结果<br> <img src="https://images2.imgbox.com/65/9e/z704yTva_o.png" alt="在这里插入图片描述"></p> 
<p>tsh实验现象和tshref一致，结果正确</p> 
<h2>
<a id="shellSIGTSTPSIGINT_913"></a>第十六关-测试shell是否能够处理来自其他进程而不是终端的SIGTSTP和SIGINT信号</h2> 
<p>打开 trace16.txt查看文件内容</p> 
<pre><code class="prism language-c">#
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">trace</span><span class="token expression"><span class="token number">16.</span>txt <span class="token operator">-</span> Tests whether the shell can handle SIGTSTP and SIGINT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>     <span class="token directive keyword">signals</span> <span class="token expression">that come from other processes instead of the terminal<span class="token punctuation">.</span></span></span>
#

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>mystop <span class="token number">2</span> 
<span class="token punctuation">.</span><span class="token operator">/</span>mystop <span class="token number">2</span>

SLEEP <span class="token number">3</span>

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> jobs
jobs

<span class="token operator">/</span>bin<span class="token operator">/</span>echo tsh<span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token operator">/</span>myint <span class="token number">2</span> 
<span class="token punctuation">.</span><span class="token operator">/</span>myint <span class="token number">2</span>
</code></pre> 
<p>这个测试文件的具体含义就是，用户程序向job 2传送了中止信号，所以最后会输出进程2被中止的信息。同时，mystop需要自己停止才能给别的进程发送信号，所以中间也会出现进程1被中止的信息</p> 
<p>输入<code>make test16</code>和<code>make rtest16</code>查看运行结果<br> <img src="https://images2.imgbox.com/c2/6a/ZCYvppgx_o.png" alt="在这里插入图片描述"></p> 
<p>tsh实验现象和tshref一致，结果正确</p> 
<p>十六关全部测试正确。</p> 
<h2>
<a id="tshc_943"></a>完整的tsh.c代码如下：</h2> 
<pre><code class="prism language-c"><span class="token comment">/* 
 * tsh - A tiny shell program with job control
 * 
 * &lt;Put your name and login ID here&gt;
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctype.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token comment">/* fdddd */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXLINE</span>    <span class="token expression"><span class="token number">1024</span>   </span><span class="token comment">/* max line size */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXARGS</span>     <span class="token expression"><span class="token number">128</span>   </span><span class="token comment">/* max args on a command line */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXJOBS</span>      <span class="token expression"><span class="token number">16</span>   </span><span class="token comment">/* max jobs at any point in time */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXJID</span>    <span class="token expression"><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span>   </span><span class="token comment">/* max job ID */</span></span>

<span class="token comment">/* Job states */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UNDEF</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">/* undefined */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FG</span> <span class="token expression"><span class="token number">1</span>    </span><span class="token comment">/* running in foreground */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BG</span> <span class="token expression"><span class="token number">2</span>    </span><span class="token comment">/* running in background */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST</span> <span class="token expression"><span class="token number">3</span>    </span><span class="token comment">/* stopped */</span></span>

<span class="token comment">/* 
 * Jobs states: FG (foreground), BG (background), ST (stopped)
 * Job state transitions and enabling actions:
 *     FG -&gt; ST  : ctrl-z
 *     ST -&gt; FG  : fg command
 *     ST -&gt; BG  : bg command
 *     BG -&gt; FG  : fg command
 * At most 1 job can be in the FG state.
 */</span>

<span class="token comment">/* Global variables */</span>
<span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>environ<span class="token punctuation">;</span>      <span class="token comment">/* defined in libc */</span>
<span class="token keyword">char</span> prompt<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"tsh&gt; "</span><span class="token punctuation">;</span>    <span class="token comment">/* command line prompt (DO NOT CHANGE) */</span>
<span class="token keyword">int</span> verbose <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment">/* if true, print additional output */</span>
<span class="token keyword">int</span> nextjid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token comment">/* next job ID to allocate */</span>
<span class="token keyword">char</span> sbuf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment">/* for composing sprintf messages */</span>

<span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token punctuation">{<!-- --></span>              <span class="token comment">/* The job struct */</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>              <span class="token comment">/* job PID */</span>
    <span class="token keyword">int</span> jid<span class="token punctuation">;</span>                <span class="token comment">/* job ID [1, 2, ...] */</span>
    <span class="token keyword">int</span> state<span class="token punctuation">;</span>              <span class="token comment">/* UNDEF, BG, FG, or ST */</span>
    <span class="token keyword">char</span> cmdline<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* command line */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">job_t</span> jobs<span class="token punctuation">[</span>MAXJOBS<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* The job list */</span>
<span class="token comment">/* End global variables */</span>


<span class="token comment">/* Function prototypes */</span>

<span class="token comment">/* Here are the functions that you will implement */</span>
<span class="token keyword">void</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">builtin_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">do_bgfg</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">waitfg</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">sigchld_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sigtstp_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Here are helper routines that we've provided for you */</span>
<span class="token keyword">int</span> <span class="token function">parseline</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">void</span> <span class="token function">sigquit_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">clearjob</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">initjobs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">maxjid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">int</span> <span class="token function">addjob</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">deletejob</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token class-name">pid_t</span> <span class="token function">fgpid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span><span class="token function">getjobpid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span><span class="token function">getjobjid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token keyword">int</span> jid<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">int</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">void</span> <span class="token function">listjobs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">app_error</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token class-name">handler_t</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">handler_t</span> <span class="token operator">*</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span> <span class="token class-name">handler_t</span> <span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * main - The shell's main routine 
 */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> c<span class="token punctuation">;</span>
    <span class="token keyword">char</span> cmdline<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> emit_prompt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">/* emit prompt (default) */</span>

    <span class="token comment">/* Redirect stderr to stdout (so that driver will get all output
     * on the pipe connected to stdout) */</span>
    <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Parse the command line */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"hvp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token char">'h'</span><span class="token operator">:</span>             <span class="token comment">/* print help message */</span>
            <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token char">'v'</span><span class="token operator">:</span>             <span class="token comment">/* emit additional diagnostic info */</span>
            verbose <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	    <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token char">'p'</span><span class="token operator">:</span>             <span class="token comment">/* don't print a prompt */</span>
            emit_prompt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">/* handy for automatic testing */</span>
	    <span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Install the signal handlers */</span>

    <span class="token comment">/* These are the ones you will need to implement */</span>
    <span class="token function">Signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>  sigint_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* ctrl-c */</span>
    <span class="token function">Signal</span><span class="token punctuation">(</span>SIGTSTP<span class="token punctuation">,</span> sigtstp_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* ctrl-z */</span>
    <span class="token function">Signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> sigchld_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Terminated or stopped child */</span>

    <span class="token comment">/* This one provides a clean way to kill the shell */</span>
    <span class="token function">Signal</span><span class="token punctuation">(</span>SIGQUIT<span class="token punctuation">,</span> sigquit_handler<span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token comment">/* Initialize the job list */</span>
    <span class="token function">initjobs</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Execute the shell's read/eval loop */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/* Read command line */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>emit_prompt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ferror</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token function">app_error</span><span class="token punctuation">(</span><span class="token string">"fgets error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">feof</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* End of file (ctrl-d) */</span>
	    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* Evaluate the command line */</span>
	<span class="token function">eval</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 

    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* control never reaches here */</span>
<span class="token punctuation">}</span>
  
<span class="token comment">/* 
 * eval - Evaluate the command line that the user has just typed in
 * 
 * If the user has requested a built-in command (quit, jobs, bg or fg)
 * then execute it immediately. Otherwise, fork a child process and
 * run the job in the context of the child. If the job is running in
 * the foreground, wait for it to terminate and then return.  Note:
 * each child process must have a unique process group ID so that our
 * background children don't receive SIGINT (SIGTSTP) from the kernel
 * when we type ctrl-c (ctrl-z) at the keyboard.  
*/</span>

<span class="token keyword">void</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span>MAXARGS<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//execve()函数的参数</span>
    <span class="token keyword">int</span> state <span class="token operator">=</span> UNDEF<span class="token punctuation">;</span>  <span class="token comment">//工作状态，FG或BG </span>
    <span class="token class-name">sigset_t</span> set<span class="token punctuation">;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>  <span class="token comment">//进程id</span>
    <span class="token comment">// 处理输入的数据</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">parseline</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">,</span> argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//解析命令行，返回给argv数组</span>
        state <span class="token operator">=</span> BG<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        state <span class="token operator">=</span> FG<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  <span class="token comment">//命令行为空直接返回</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果不是内置命令</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">builtin_cmd</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"sigemptyset error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGTSTP<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGCHLD<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"sigaddset error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在它派生子进程之前阻塞SIGCHLD信号，防止竞争 </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"sigprocmask error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//fork创建子进程失败 </span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//fork创建子进程</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 子进程的控制流开始</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//解除阻塞</span>
                <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"sigprocmask error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//设置子进程id </span>
                <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"setpgid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">execve</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> environ<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: command not foundn"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将当前进程添加进job中，无论是前台进程还是后台进程</span>
        <span class="token function">addjob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> state<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 恢复受阻塞的信号 SIGINT SIGTSTP SIGCHLD</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"sigprocmask error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 判断子进程类型并做处理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>state <span class="token operator">==</span> FG<span class="token punctuation">)</span>
            <span class="token function">waitfg</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//前台作业等待</span>
        <span class="token keyword">else</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] (%d) %s"</span><span class="token punctuation">,</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将进程id映射到job id   </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
 * parseline - Parse the command line and build the argv array.
 * 
 * Characters enclosed in single quotes are treated as a single
 * argument.  Return true if the user has requested a BG job, false if
 * the user has requested a FG job.  
 */</span>
<span class="token keyword">int</span> <span class="token function">parseline</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">char</span> array<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* holds local copy of command line */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>buf <span class="token operator">=</span> array<span class="token punctuation">;</span>          <span class="token comment">/* ptr that traverses command line */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>delim<span class="token punctuation">;</span>                <span class="token comment">/* points to first space delimiter */</span>
    <span class="token keyword">int</span> argc<span class="token punctuation">;</span>                   <span class="token comment">/* number of args */</span>
    <span class="token keyword">int</span> bg<span class="token punctuation">;</span>                     <span class="token comment">/* background job? */</span>

    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>  <span class="token comment">/* replace trailing 'n' with space */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>buf <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>buf <span class="token operator">==</span> <span class="token char">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">/* ignore leading spaces */</span>
	buf<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment">/* Build the argv list */</span>
    argc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>buf <span class="token operator">==</span> <span class="token char">'''</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	buf<span class="token operator">++</span><span class="token punctuation">;</span>
	delim <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">'''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	delim <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>delim<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	argv<span class="token punctuation">[</span>argc<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>
	<span class="token operator">*</span>delim <span class="token operator">=</span> <span class="token char">''</span><span class="token punctuation">;</span>
	buf <span class="token operator">=</span> delim <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>buf <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>buf <span class="token operator">==</span> <span class="token char">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">/* ignore spaces */</span>
	       buf<span class="token operator">++</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>buf <span class="token operator">==</span> <span class="token char">'''</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    buf<span class="token operator">++</span><span class="token punctuation">;</span>
	    delim <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">'''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	    delim <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">/* ignore blank line */</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">/* should the job run in the background? */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>argv<span class="token punctuation">[</span>argc<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	argv<span class="token punctuation">[</span><span class="token operator">--</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
 * builtin_cmd - If the user has typed a built-in command then execute
 *    it immediately.  
 */</span>
<span class="token keyword">int</span> <span class="token function">builtin_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"quit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//如果命令是quit，退出</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"bg"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"fg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//如果是bg或者fg命令，执行do_fgbg函数 </span>
        <span class="token function">do_bgfg</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"jobs"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//如果命令是jobs，列出正在运行和停止的后台作业</span>
        <span class="token function">listjobs</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">/* not a builtin command */</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
 * do_bgfg - Execute the builtin bg and fg commands
 */</span>
<span class="token keyword">void</span> <span class="token function">do_bgfg</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> num<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job<span class="token punctuation">;</span>
    <span class="token comment">// 没有参数的fg/bg应该被丢弃</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//命令行为空</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s command requires PID or %%jobid argumentn"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 检测fg/bg参数，其中%开头的数字是JobID，纯数字的是PID</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'%'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//解析jid</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: argument must be a PID or %%jobidn"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//失败,打印错误消息</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>job <span class="token operator">=</span> <span class="token function">getjobjid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%%%d: No such jobn"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//没找到对应的job </span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: argument must be a PID or %%jobidn"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//失败,打印错误消息</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>job <span class="token operator">=</span> <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"(%d): No such processn"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//没找到对应的进程 </span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"bg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// bg会启动子进程，并将其放置于后台执行</span>
        job<span class="token operator">-&gt;</span>state <span class="token operator">=</span> BG<span class="token punctuation">;</span>  <span class="token comment">//设置状态 </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>job<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> SIGCONT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//采用负数发送信号到进程组 </span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"kill error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] (%d) %s"</span><span class="token punctuation">,</span> job<span class="token operator">-&gt;</span>jid<span class="token punctuation">,</span> job<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> job<span class="token operator">-&gt;</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"fg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        job<span class="token operator">-&gt;</span>state <span class="token operator">=</span> FG<span class="token punctuation">;</span>  <span class="token comment">//设置状态 </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>job<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> SIGCONT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//采用负数发送信号到进程组 </span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"kill error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 当一个进程被设置为前台执行时，当前tsh应该等待该子进程结束</span>
        <span class="token function">waitfg</span><span class="token punctuation">(</span>job<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"do_bgfg: Internal error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
 * waitfg - Block until process pid is no longer the foreground process
 */</span>
<span class="token keyword">void</span> <span class="token function">waitfg</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job <span class="token operator">=</span> <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>job<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果当前子进程的状态没有发生改变，则tsh继续休眠</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>job<span class="token operator">-&gt;</span>state <span class="token operator">==</span> FG<span class="token punctuation">)</span>
        <span class="token comment">// 使用sleep的这段代码会比较慢，最好使用sigsuspend</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*****************
 * Signal handlers
 *****************/</span>

<span class="token comment">/* 
 * sigchld_handler - The kernel sends a SIGCHLD to the shell whenever
 *     a child job terminates (becomes a zombie), or stops because it
 *     received a SIGSTOP or SIGTSTP signal. The handler reaps all
 *     available zombie children, but doesn't wait for any other
 *     currently running children to terminate.  
 */</span>
<span class="token keyword">void</span> <span class="token function">sigchld_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> status<span class="token punctuation">,</span> jid<span class="token punctuation">;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigchld_handler: entering"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
    以非阻塞方式等待所有子进程
    waitpid 参数3：
        1.     0     ： 执行waitpid时， 只有在子进程 **终止** 时才会返回。
        2. WNOHANG   : 若子进程仍然在运行，则返回0 。
                注意只有设置了这个标志，waitpid才有可能返回0
        3. WUNTRACED : 如果子进程由于传递信号而停止，则马上返回。
                只有设置了这个标志，waitpid返回时，其WIFSTOPPED(status)才有可能返回true
    */</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> WNOHANG <span class="token operator">|</span> WUNTRACED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

        <span class="token comment">// 如果当前这个子进程的job已经删除了，则表示有错误发生</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>job <span class="token operator">=</span> <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Lost track of (%d)n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        jid <span class="token operator">=</span> job<span class="token operator">-&gt;</span>jid<span class="token punctuation">;</span>
        <span class="token comment">//接下来判断三种状态 </span>
        <span class="token comment">// 如果这个子进程收到了一个暂停信号（还没退出） </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFSTOPPED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Job [%d] (%d) stopped by signal %dn"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> job<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> <span class="token function">WSTOPSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            job<span class="token operator">-&gt;</span>state <span class="token operator">=</span> ST<span class="token punctuation">;</span>  <span class="token comment">//状态设为挂起 </span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果子进程通过调用 exit 或者一个返回 (return) 正常终止</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">deletejob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigchld_handler: Job [%d] (%d) deletedn"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigchld_handler: Job [%d] (%d) terminates OK (status %d)n"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果子进程是因为一个未被捕获的信号终止的，例如SIGKILL</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">deletejob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//清除进程</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigchld_handler: Job [%d] (%d) deletedn"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Job [%d] (%d) terminated by signal %dn"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//返回导致子进程终止的信号的数量</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigchld_handler: exiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
 * sigint_handler - The kernel sends a SIGINT to the shell whenver the
 *    user types ctrl-c at the keyboard.  Catch it and send it along
 *    to the foreground job.  
 */</span>
<span class="token keyword">void</span> <span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigint_handler: entering"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 发送SIGINT给前台进程组里的所有进程</span>
        <span class="token comment">// 需要注意的是，前台进程组内的进程除了当前前台进程以外，还包括前台进程的子进程。</span>
        <span class="token comment">// 最多只能存在一个前台进程，但前台进程组内可以存在多个进程</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>pid<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"kill (sigint) error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigint_handler: Job (%d) killedn"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigint_handler: exiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever
 *     the user types ctrl-z at the keyboard. Catch it and suspend the
 *     foreground job by sending it a SIGTSTP.  
 */</span>
<span class="token keyword">void</span> <span class="token function">sigtstp_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigstp_handler: entering"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job <span class="token operator">=</span> <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>pid<span class="token punctuation">,</span> SIGTSTP<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"kill (tstp) error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sigstp_handler: Job [%d] (%d) stoppedn"</span><span class="token punctuation">,</span> job<span class="token operator">-&gt;</span>jid<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"sigstp_handler: exiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*********************
 * End signal handlers
 *********************/</span>

<span class="token comment">/***********************************************
 * Helper routines that manipulate the job list
 **********************************************/</span>

<span class="token comment">/* clearjob - Clear the entries in a job struct */</span>
<span class="token keyword">void</span> <span class="token function">clearjob</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>job<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    job<span class="token operator">-&gt;</span>pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    job<span class="token operator">-&gt;</span>jid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    job<span class="token operator">-&gt;</span>state <span class="token operator">=</span> UNDEF<span class="token punctuation">;</span>
    job<span class="token operator">-&gt;</span>cmdline<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">''</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* initjobs - Initialize the job list */</span>
<span class="token keyword">void</span> <span class="token function">initjobs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAXJOBS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token function">clearjob</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* maxjid - Returns largest allocated job ID */</span>
<span class="token keyword">int</span> <span class="token function">maxjid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> max<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAXJOBS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>jid <span class="token operator">&gt;</span> max<span class="token punctuation">)</span>
	    max <span class="token operator">=</span> jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>jid<span class="token punctuation">;</span>
    <span class="token keyword">return</span> max<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* addjob - Add a job to the job list */</span>
<span class="token keyword">int</span> <span class="token function">addjob</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAXJOBS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pid <span class="token operator">=</span> pid<span class="token punctuation">;</span>
	    jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
	    jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>jid <span class="token operator">=</span> nextjid<span class="token operator">++</span><span class="token punctuation">;</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextjid <span class="token operator">&gt;</span> MAXJOBS<span class="token punctuation">)</span>
		nextjid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	    <span class="token function">strcpy</span><span class="token punctuation">(</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cmdline<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	    <span class="token keyword">if</span><span class="token punctuation">(</span>verbose<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Added job [%d] %d %sn"</span><span class="token punctuation">,</span> jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>jid<span class="token punctuation">,</span> jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pid<span class="token punctuation">,</span> jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Tried to create too many jobsn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* deletejob - Delete a job whose PID=pid from the job list */</span>
<span class="token keyword">int</span> <span class="token function">deletejob</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAXJOBS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pid <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token function">clearjob</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    nextjid <span class="token operator">=</span> <span class="token function">maxjid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
	    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* fgpid - Return PID of current foreground job, 0 if no such job */</span>
<span class="token class-name">pid_t</span> <span class="token function">fgpid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAXJOBS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> FG<span class="token punctuation">)</span>
	    <span class="token keyword">return</span> jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* getjobpid  - Find a job (by PID) on the job list */</span>
<span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span><span class="token function">getjobpid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAXJOBS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pid <span class="token operator">==</span> pid<span class="token punctuation">)</span>
	    <span class="token keyword">return</span> <span class="token operator">&amp;</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* getjobjid  - Find a job (by JID) on the job list */</span>
<span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span><span class="token function">getjobjid</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">,</span> <span class="token keyword">int</span> jid<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>jid <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAXJOBS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>jid <span class="token operator">==</span> jid<span class="token punctuation">)</span>
	    <span class="token keyword">return</span> <span class="token operator">&amp;</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* pid2jid - Map process ID to job ID */</span>
<span class="token keyword">int</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAXJOBS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pid <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>jid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* listjobs - Print the job list */</span>
<span class="token keyword">void</span> <span class="token function">listjobs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">job_t</span> <span class="token operator">*</span>jobs<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAXJOBS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] (%d) "</span><span class="token punctuation">,</span> jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>jid<span class="token punctuation">,</span> jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">switch</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> BG<span class="token operator">:</span> 
		    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Running "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> FG<span class="token operator">:</span> 
		    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Foreground "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> ST<span class="token operator">:</span> 
		    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stopped "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token keyword">break</span><span class="token punctuation">;</span>
	    <span class="token keyword">default</span><span class="token operator">:</span>
		    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"listjobs: Internal error: job[%d].state=%d "</span><span class="token punctuation">,</span> 
			   i<span class="token punctuation">,</span> jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> jobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/******************************
 * end job list helper routines
 ******************************/</span>


<span class="token comment">/***********************
 * Other helper routines
 ***********************/</span>

<span class="token comment">/*
 * usage - print a help message
 */</span>
<span class="token keyword">void</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage: shell [-hvp]n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"   -h   print this messagen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"   -v   print additional diagnostic informationn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"   -p   do not emit a command promptn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * unix_error - unix-style error routine
 */</span>
<span class="token keyword">void</span> <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token string">"%s: %sn"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * app_error - application-style error routine
 */</span>
<span class="token keyword">void</span> <span class="token function">app_error</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token string">"%sn"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Signal - wrapper for the sigaction function
 */</span>
<span class="token class-name">handler_t</span> <span class="token operator">*</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span> <span class="token class-name">handler_t</span> <span class="token operator">*</span>handler<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> action<span class="token punctuation">,</span> old_action<span class="token punctuation">;</span>

    action<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>  
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>action<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* block sigs of type being handled */</span>
    action<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> SA_RESTART<span class="token punctuation">;</span> <span class="token comment">/* restart syscalls if possible */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>signum<span class="token punctuation">,</span> <span class="token operator">&amp;</span>action<span class="token punctuation">,</span> <span class="token operator">&amp;</span>old_action<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"Signal error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>old_action<span class="token punctuation">.</span>sa_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * sigquit_handler - The driver program can gracefully terminate the
 *    child shell by sending it a SIGQUIT signal.
 */</span>
<span class="token keyword">void</span> <span class="token function">sigquit_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Terminating after receipt of SIGQUIT signaln"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



</code></pre>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>