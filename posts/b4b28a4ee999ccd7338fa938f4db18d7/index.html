<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>图像恢复 SWinIR : 彻底理解论文和源代码 (注释详尽） - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">图像恢复 SWinIR : 彻底理解论文和源代码 (注释详尽）</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <p></p>
<div class="toc">
 <h3>文章目录</h3>
 <ul><li>
<ul>
<li><a href="#SwinIR__1">SwinIR 论文</a></li>
<li><a href="#SWinIR__6">SWinIR 网络结构</a></li>
<li>
<ul>
<li><a href="#_7">整体框架</a></li>
<li><a href="#_10">浅层特征提取</a></li>
<li><a href="#_12">深层特征提取</a></li>
<li><a href="#_30">图像重建模块</a></li>
</ul>
   </li>
<li><a href="#_37">主要代码理解</a></li>
<li>
<ul>
<li><a href="#SwinIR_42">SwinIR</a></li>
<li><a href="#MLP_274">MLP</a></li>
<li><a href="#Patch_Embedding_297">Patch Embedding</a></li>
<li><a href="#Window_Attention_371">Window Attention</a></li>
<li><a href="#_Swin_Transformer__RSTB_504">残差 Swin Transformer 块 (RSTB)</a></li>
<li><a href="#HQ_Image_Reconstruction_770">HQ Image Reconstruction</a></li>
<li><a href="#_822">一个测试实例</a></li>
</ul>
   </li>
<li><a href="#_840">参考文献</a></li>
<li><a href="#_843">结语</a></li>
</ul>
 </li></ul>
</div>
<p></p> 
<h2>
<a id="SwinIR__1"></a>SwinIR 论文</h2> 
<p><img src="https://images2.imgbox.com/e4/f9/FsqoHVIZ_o.png" alt="在这里插入图片描述"><br> <strong>主要工作</strong>：将 Swin Transformer 在图像恢复中应用，降低参数量的同时取得很好的效果。<br> <strong>论文地址</strong>：<a href="https://arxiv.org/pdf/2108.10257.pdf">https://arxiv.org/pdf/2108.10257.pdf</a><br> <strong>源代码</strong>：<a href="https://github.com/JingyunLiang/SwinIR">https://github.com/JingyunLiang/SwinIR</a></p> 
<h2>
<a id="SWinIR__6"></a>SWinIR 网络结构</h2> 
<h3>
<a id="_7"></a>整体框架</h3> 
<p>SwinIR 的网络结构主要分为 3 个部分，分别是浅层特征提取模块，深层特征提取模块和高质量图像重建模块。其中前后两个模块都是基于 CNN 的，中间模块则主要使用 SwInTransformer。<br> <img src="https://images2.imgbox.com/c9/5d/IYXiFt9Q_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="_10"></a>浅层特征提取</h3> 
<p>浅层特征提取只使用一层卷积进行提取。（<strong>注</strong>：这是一个容易改进的地方）</p> 
<h3>
<a id="_12"></a>深层特征提取</h3> 
<p>深层特征提取模块由若干个残差 SwInTransformer 块 (RSTB) 和卷积块构成，具体结构如下图。</p> 
<p>(1) 首先将来自浅层特征提取模块的特征图分割成多个不重叠的 patch embeddings；<br> (2) 再通过多个串联的残差 SWin Transformer 块 (RSTB);<br> (3) 将多个不重叠的 patch embeddings 重新组合成与输入特征图分辨率一样；<br> (4) 最后通过一个卷积层 (1 层或3 层卷积) 输出；<br> (5) 在每个 RSTB 中都引入残差连接。<br> <img src="https://images2.imgbox.com/ba/e9/8Eev5gWy_o.png" alt="在这里插入图片描述"><br> 残差 SwInTransformer 块 (RSTB) 中的 STL 就是 SwIn Transformer Layer 的意思，具体结构如下图。</p> 
<p>(1) 首先通过一个归一化层 LayerNorm；<br> (2) 再通过多头自注意力 (Multi-head Self Attention) 模块；<br> (3) 在多头自注意力结尾引入残差；<br> (4) 再通过一个归一化层 LayerNorm；<br> (5) 最后通过一个多层感知机 MLP；<br> (6) 结尾同样引入残差。<br> <img src="https://images2.imgbox.com/d4/8b/ASfUtGP7_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="_30"></a>图像重建模块</h3> 
<p>图像重建模块其实就是卷积+上采样的组合，在这块论文提出 4 种结构。（<strong>注</strong>：这是一个容易改进的地方）</p> 
<p>(1) 经典超分 (卷积 + pixelshuffle 上采样 + 卷积)；<br> (2) 轻量超分 (卷积 + pixelshuffle 上采样)；<br> (3) 真实图像超分 (卷积 + 卷积插值上采样 + 卷积插值上采样 + 卷积)；<br> (4) 像去噪和 JPEG 压缩去伪影 （卷积 + 引入残差）。</p> 
<h2>
<a id="_37"></a>主要代码理解</h2> 
<p>关于 SwinIR 中涉及 CNN 的部分代码非常简单，就不在此单独列出，这里主要注释一下其中有关 Swin Transformer 的实现代码。另外针对不构成主要网络结构的部分代码进行了删减，完整代码请移步：<br> (1) GitHub 链接：<a href="https://github.com/JingyunLiang/SwinIR">https://github.com/JingyunLiang/SwinIR</a><br> (2) CSDN 链接：<a href="https://download.csdn.net/download/Wenyuanbo/40284900">https://download.csdn.net/download/Wenyuanbo/40284900</a><br> (3) 详尽注释代码：<a href="https://download.csdn.net/download/Wenyuanbo/40284085">https://download.csdn.net/download/Wenyuanbo/40284085</a></p> 
<h3>
<a id="SwinIR_42"></a>SwinIR</h3> 
<p>SwinIR 主要由浅层特征提取，深层特征提取和高质量图像重建模块组成，具体原理如前所说，直接欣赏代码吧。</p> 
<pre><code class="prism language-python"><span class="token comment"># SWinIR</span>
<span class="token keyword">class</span> <span class="token class-name">SwinIR</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">r""" SwinIR
        基于 Swin Transformer 的图像恢复网络.

    输入:
        img_size (int | tuple(int)): 输入图像的大小，默认为 64*64.
        patch_size (int | tuple(int)): patch 的大小，默认为 1.
        in_chans (int): 输入图像的通道数，默认为 3.
        embed_dim (int): Patch embedding 的维度，默认为 96.
        depths (tuple(int)): Swin Transformer 层的深度.
        num_heads (tuple(int)): 在不同层注意力头的个数.
        window_size (int): 窗口大小，默认为 7.
        mlp_ratio (float): MLP隐藏层特征图通道与嵌入层特征图通道的比，默认为 4.
        qkv_bias (bool): 给 query, key, value 添加可学习的偏置，默认为 True.
        qk_scale (float): 重写默认的缩放因子，默认为 None.
        drop_rate (float): 随机丢弃神经元，丢弃率默认为 0.
        attn_drop_rate (float): 注意力权重的丢弃率，默认为 0.
        drop_path_rate (float): 深度随机丢弃率，默认为 0.1.
        norm_layer (nn.Module): 归一化操作，默认为 nn.LayerNorm.
        ape (bool): patch embedding 添加绝对位置 embedding，默认为 False.
        patch_norm (bool): 在 patch embedding 后添加归一化操作，默认为 True.
        use_checkpoint (bool): 是否使用 checkpointing 来节省显存，默认为 False.
        upscale: 放大因子， 2/3/4/8 适合图像超分, 1 适合图像去噪和 JPEG 压缩去伪影
        img_range: 灰度值范围， 1 或者 255.
        upsampler: 图像重建方法的选择模块，可选择 pixelshuffle, pixelshuffledirect, nearest+conv 或 None.
        resi_connection: 残差连接之前的卷积块， 可选择 1conv 或 3conv.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> patch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> in_chans<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
                 embed_dim<span class="token operator">=</span><span class="token number">96</span><span class="token punctuation">,</span> depths<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_heads<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 window_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> mlp_ratio<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">,</span> qkv_bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> qk_scale<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 drop_rate<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> attn_drop_rate<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> drop_path_rate<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
                 norm_layer<span class="token operator">=</span>nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">,</span> ape<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> patch_norm<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                 use_checkpoint<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> upscale<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> img_range<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> upsampler<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> resi_connection<span class="token operator">=</span><span class="token string">'1conv'</span><span class="token punctuation">,</span>
                 <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SwinIR<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        num_in_ch <span class="token operator">=</span> in_chans  <span class="token comment"># 输入图片通道数</span>
        num_out_ch <span class="token operator">=</span> in_chans  <span class="token comment"># 输出图片通道数</span>
        num_feat <span class="token operator">=</span> <span class="token number">64</span>  <span class="token comment"># 特征图通道数</span>
        self<span class="token punctuation">.</span>img_range <span class="token operator">=</span> img_range  <span class="token comment"># 灰度值范围:[0, 1] or [0, 255]</span>
        <span class="token keyword">if</span> in_chans <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>  <span class="token comment"># 如果输入是RGB图像</span>
            rgb_mean <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.4488</span><span class="token punctuation">,</span> <span class="token number">0.4371</span><span class="token punctuation">,</span> <span class="token number">0.4040</span><span class="token punctuation">)</span>  <span class="token comment"># 数据集RGB均值</span>
            self<span class="token punctuation">.</span>mean <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>rgb_mean<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 转为[1, 3, 1, 1]的张量</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 否则灰度图</span>
            self<span class="token punctuation">.</span>mean <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 构造[1, 1, 1, 1]的张量</span>
        self<span class="token punctuation">.</span>upscale <span class="token operator">=</span> upscale  <span class="token comment"># 图像放大倍数，超分(2/3/4/8),去噪(1)</span>
        self<span class="token punctuation">.</span>upsampler <span class="token operator">=</span> upsampler <span class="token comment"># 上采样方法</span>
        self<span class="token punctuation">.</span>window_size <span class="token operator">=</span> window_size  <span class="token comment"># 注意力窗口的大小</span>

        <span class="token comment">#######################################################################################</span>
        <span class="token comment">################################### 1, 浅层特征提取 ###################################</span>
        self<span class="token punctuation">.</span>conv_first <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_in_ch<span class="token punctuation">,</span> embed_dim<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 输入卷积层</span>

        <span class="token comment">##########################################################################################</span>
        <span class="token comment">################################### 2, 深层特征提取 ######################################</span>
        self<span class="token punctuation">.</span>num_layers <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>depths<span class="token punctuation">)</span>  <span class="token comment"># Swin Transformer 层的个数</span>
        self<span class="token punctuation">.</span>embed_dim <span class="token operator">=</span> embed_dim  <span class="token comment"># 嵌入层特征图的通道数</span>
        self<span class="token punctuation">.</span>ape <span class="token operator">=</span> ape  <span class="token comment"># patch embedding 添加绝对位置 embedding，默认为 False.</span>
        self<span class="token punctuation">.</span>patch_norm <span class="token operator">=</span> patch_norm  <span class="token comment"># 在 patch embedding 后添加归一化操作，默认为 True.</span>
        self<span class="token punctuation">.</span>num_features <span class="token operator">=</span> embed_dim  <span class="token comment"># 特征图的通道数</span>
        self<span class="token punctuation">.</span>mlp_ratio <span class="token operator">=</span> mlp_ratio  <span class="token comment"># MLP隐藏层特征图通道与嵌入层特征图通道的比</span>

        <span class="token comment"># 将图像分割成多个不重叠的patch</span>
        self<span class="token punctuation">.</span>patch_embed <span class="token operator">=</span> PatchEmbed<span class="token punctuation">(</span>
            img_size<span class="token operator">=</span>img_size<span class="token punctuation">,</span> patch_size<span class="token operator">=</span>patch_size<span class="token punctuation">,</span> in_chans<span class="token operator">=</span>embed_dim<span class="token punctuation">,</span> embed_dim<span class="token operator">=</span>embed_dim<span class="token punctuation">,</span>
            norm_layer<span class="token operator">=</span>norm_layer <span class="token keyword">if</span> self<span class="token punctuation">.</span>patch_norm <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        num_patches <span class="token operator">=</span> self<span class="token punctuation">.</span>patch_embed<span class="token punctuation">.</span>num_patches  <span class="token comment"># 分割得到patch的个数</span>
        patches_resolution <span class="token operator">=</span> self<span class="token punctuation">.</span>patch_embed<span class="token punctuation">.</span>patches_resolution  <span class="token comment"># 分割得到patch的分辨率</span>
        self<span class="token punctuation">.</span>patches_resolution <span class="token operator">=</span> patches_resolution

        <span class="token comment"># 将多个不重叠的patch合并成图像</span>
        self<span class="token punctuation">.</span>patch_unembed <span class="token operator">=</span> PatchUnEmbed<span class="token punctuation">(</span>
            img_size<span class="token operator">=</span>img_size<span class="token punctuation">,</span> patch_size<span class="token operator">=</span>patch_size<span class="token punctuation">,</span> in_chans<span class="token operator">=</span>embed_dim<span class="token punctuation">,</span> embed_dim<span class="token operator">=</span>embed_dim<span class="token punctuation">,</span>
            norm_layer<span class="token operator">=</span>norm_layer <span class="token keyword">if</span> self<span class="token punctuation">.</span>patch_norm <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

        <span class="token comment"># 绝对位置嵌入</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>ape<span class="token punctuation">:</span>
            <span class="token comment"># 结构为 [1，patch个数， 嵌入层特征图的通道数] 的参数</span>
            self<span class="token punctuation">.</span>absolute_pos_embed <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_patches<span class="token punctuation">,</span> embed_dim<span class="token punctuation">)</span><span class="token punctuation">)</span>
            trunc_normal_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>absolute_pos_embed<span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">.02</span><span class="token punctuation">)</span>  <span class="token comment"># 截断正态分布，限制标准差为0.02</span>

        self<span class="token punctuation">.</span>pos_drop <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span>drop_rate<span class="token punctuation">)</span>  <span class="token comment"># 以drop_rate为丢弃率随机丢弃神经元，默认不丢弃</span>

        <span class="token comment"># 随机深度衰减规律，默认为 [0, 0.1] 进行24等分后的列表</span>
        dpr <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> drop_path_rate<span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>depths<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># Residual Swin Transformer blocks (RSTB)</span>
        <span class="token comment"># 残差 Swin Transformer 块 (RSTB)</span>
        self<span class="token punctuation">.</span>layers <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建一个ModuleList实例对象，也就是多个 RSTB</span>
        <span class="token keyword">for</span> i_layer <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_layers<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 循环 Swin Transformer 层的个数次</span>
            <span class="token comment"># 实例化 RSTB</span>
            layer <span class="token operator">=</span> RSTB<span class="token punctuation">(</span>dim<span class="token operator">=</span>embed_dim<span class="token punctuation">,</span>
                         input_resolution<span class="token operator">=</span><span class="token punctuation">(</span>patches_resolution<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                           patches_resolution<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         depth<span class="token operator">=</span>depths<span class="token punctuation">[</span>i_layer<span class="token punctuation">]</span><span class="token punctuation">,</span>
                         num_heads<span class="token operator">=</span>num_heads<span class="token punctuation">[</span>i_layer<span class="token punctuation">]</span><span class="token punctuation">,</span>
                         window_size<span class="token operator">=</span>window_size<span class="token punctuation">,</span>
                         mlp_ratio<span class="token operator">=</span>self<span class="token punctuation">.</span>mlp_ratio<span class="token punctuation">,</span>
                         qkv_bias<span class="token operator">=</span>qkv_bias<span class="token punctuation">,</span> qk_scale<span class="token operator">=</span>qk_scale<span class="token punctuation">,</span>
                         drop<span class="token operator">=</span>drop_rate<span class="token punctuation">,</span> attn_drop<span class="token operator">=</span>attn_drop_rate<span class="token punctuation">,</span>
                         drop_path<span class="token operator">=</span>dpr<span class="token punctuation">[</span><span class="token builtin">sum</span><span class="token punctuation">(</span>depths<span class="token punctuation">[</span><span class="token punctuation">:</span>i_layer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token builtin">sum</span><span class="token punctuation">(</span>depths<span class="token punctuation">[</span><span class="token punctuation">:</span>i_layer <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># no impact on SR results</span>
                         norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">,</span>
                         downsample<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                         use_checkpoint<span class="token operator">=</span>use_checkpoint<span class="token punctuation">,</span>
                         img_size<span class="token operator">=</span>img_size<span class="token punctuation">,</span>
                         patch_size<span class="token operator">=</span>patch_size<span class="token punctuation">,</span>
                         resi_connection<span class="token operator">=</span>resi_connection
                         <span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>layer<span class="token punctuation">)</span>  <span class="token comment"># 将 RSTB 对象插入 ModuleList 中</span>
        self<span class="token punctuation">.</span>norm <span class="token operator">=</span> norm_layer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_features<span class="token punctuation">)</span>  <span class="token comment"># 归一化操作，默认 LayerNorm</span>

        <span class="token comment"># 在深层特征提取网络中加入卷积块，保持特征图通道数不变</span>
        <span class="token keyword">if</span> resi_connection <span class="token operator">==</span> <span class="token string">'1conv'</span><span class="token punctuation">:</span>  <span class="token comment"># 1层卷积</span>
            self<span class="token punctuation">.</span>conv_after_body <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>embed_dim<span class="token punctuation">,</span> embed_dim<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> resi_connection <span class="token operator">==</span> <span class="token string">'3conv'</span><span class="token punctuation">:</span>  <span class="token comment"># 3层卷积</span>
            <span class="token comment"># 为了减少参数使用和节约显存，采用瓶颈结构</span>
            self<span class="token punctuation">.</span>conv_after_body <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>embed_dim<span class="token punctuation">,</span> embed_dim <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 降维</span>
                                                 nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span>negative_slope<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                 nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>embed_dim <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> embed_dim <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                 nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span>negative_slope<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                 nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>embed_dim <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> embed_dim<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 升维</span>

        <span class="token comment"># 高质量图像重建模块</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>upsampler <span class="token operator">==</span> <span class="token string">'pixelshuffle'</span><span class="token punctuation">:</span>  <span class="token comment"># pixelshuffle 上采样</span>
            <span class="token comment"># 适合经典超分</span>
            self<span class="token punctuation">.</span>conv_before_upsample <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>embed_dim<span class="token punctuation">,</span> num_feat<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                      nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>upsample <span class="token operator">=</span> Upsample<span class="token punctuation">(</span>upscale<span class="token punctuation">,</span> num_feat<span class="token punctuation">)</span>  <span class="token comment"># 上采样</span>
            self<span class="token punctuation">.</span>conv_last <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_feat<span class="token punctuation">,</span> num_out_ch<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 输出卷积层</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>upsampler <span class="token operator">==</span> <span class="token string">'pixelshuffledirect'</span><span class="token punctuation">:</span>  <span class="token comment"># 一步是实现既上采样也降维</span>
            <span class="token comment"># 适合轻量级充分，可以减少参数量(一步是实现既上采样也降维)</span>
            self<span class="token punctuation">.</span>upsample <span class="token operator">=</span> UpsampleOneStep<span class="token punctuation">(</span>upscale<span class="token punctuation">,</span> embed_dim<span class="token punctuation">,</span> num_out_ch<span class="token punctuation">,</span>
                                            <span class="token punctuation">(</span>patches_resolution<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> patches_resolution<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>upsampler <span class="token operator">==</span> <span class="token string">'nearest+conv'</span><span class="token punctuation">:</span>  <span class="token comment"># 最近邻插值上采样</span>
            <span class="token comment"># 适合真实图像超分</span>
            <span class="token keyword">assert</span> self<span class="token punctuation">.</span>upscale <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'only support x4 now.'</span>  <span class="token comment"># 声明目前仅支持4倍超分重建</span>
            <span class="token comment"># 上采样之前的卷积层</span>
            self<span class="token punctuation">.</span>conv_before_upsample <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>embed_dim<span class="token punctuation">,</span> num_feat<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                      nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># 第一次上采样卷积(直接对输入做最近邻插值变为2倍图像)                                          </span>
            self<span class="token punctuation">.</span>conv_up1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_feat<span class="token punctuation">,</span> num_feat<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token comment"># 第二次上采样卷积(直接对输入做最近邻插值变为2倍图像)</span>
            self<span class="token punctuation">.</span>conv_up2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_feat<span class="token punctuation">,</span> num_feat<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>conv_hr <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_feat<span class="token punctuation">,</span> num_feat<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 对上采样完成的图像再做卷积</span>
            self<span class="token punctuation">.</span>lrelu <span class="token operator">=</span> nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span>negative_slope<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 激活层</span>
            self<span class="token punctuation">.</span>conv_last <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_feat<span class="token punctuation">,</span> num_out_ch<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 输出卷积层</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 适合图像去噪和 JPEG 压缩去伪影</span>
            self<span class="token punctuation">.</span>conv_last <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>embed_dim<span class="token punctuation">,</span> num_out_ch<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_init_weights<span class="token punctuation">)</span>  <span class="token comment"># 初始化网络参数</span>

    <span class="token comment"># 初始化网络参数</span>
    <span class="token keyword">def</span> <span class="token function">_init_weights</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断是否为线性 Linear 层</span>
            trunc_normal_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">.02</span><span class="token punctuation">)</span>  <span class="token comment"># 截断正态分布，限制标准差为 0.02</span>
            <span class="token keyword">if</span> m<span class="token punctuation">.</span>bias <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># 如果设置了偏置</span>
                nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化偏置为 0</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断是否为归一化 LayerNorm 层</span>
            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化偏置为 0</span>
            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化权重系数为 1</span>
    
    <span class="token comment"># 检查图片(准确说是张量)的大小</span>
    <span class="token keyword">def</span> <span class="token function">check_image_size</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 张量 x 的高和宽</span>
        <span class="token comment"># h 维度要填充的个数</span>
        mod_pad_h <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>window_size <span class="token operator">-</span> h <span class="token operator">%</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">)</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>window_size
        <span class="token comment"># w 维度要填充的个数</span>
        mod_pad_w <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>window_size <span class="token operator">-</span> w <span class="token operator">%</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">)</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>window_size
        <span class="token comment"># 右填充 mod_pad_w 个值，下填充 mod_pad_h 个值，模式为反射(可以理解为以 x 的维度末尾为轴对折)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> mod_pad_w<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mod_pad_h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'reflect'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x

    <span class="token comment"># 深层特征提取网络的前向传播</span>
    <span class="token keyword">def</span> <span class="token function">forward_features</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_size <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 张量 x 的高和宽</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>patch_embed<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 分割 x 为多个不重叠的 patch embeddings</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>ape<span class="token punctuation">:</span>  <span class="token comment"># 绝对位置 embedding</span>
            x <span class="token operator">=</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>absolute_pos_embed  <span class="token comment"># x 加上对应的绝对位置 embedding</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pos_drop<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 随机将x中的部分元素置 0</span>

        <span class="token keyword">for</span> layer <span class="token keyword">in</span> self<span class="token punctuation">.</span>layers<span class="token punctuation">:</span>
            x <span class="token operator">=</span> layer<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x_size<span class="token punctuation">)</span>  <span class="token comment"># x 通过多个串联的 RSTB</span>

        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 对 RSTB 的输出进行归一化</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>patch_unembed<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x_size<span class="token punctuation">)</span>  <span class="token comment"># 将多个不重叠的 patch 合并成图像</span>

        <span class="token keyword">return</span> x
    
    <span class="token comment"># SWinIR 的前向传播</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        H<span class="token punctuation">,</span> W <span class="token operator">=</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 输入图片的高和宽</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>check_image_size<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 检查图片的大小，使高宽满足 window_size 的整数倍</span>
        
        self<span class="token punctuation">.</span>mean <span class="token operator">=</span> self<span class="token punctuation">.</span>mean<span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment"># RGB 均值的类型同 x 一致</span>
        x <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> self<span class="token punctuation">.</span>mean<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>img_range  <span class="token comment"># x 减去 RGB 均值再乘以输入的最大灰度值</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>upsampler <span class="token operator">==</span> <span class="token string">'pixelshuffle'</span><span class="token punctuation">:</span>  <span class="token comment"># pixelshuffle 上采样方法</span>
            <span class="token comment"># 适合经典超分</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_first<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 输入卷积层</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_after_body<span class="token punctuation">(</span>self<span class="token punctuation">.</span>forward_features<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> x  <span class="token comment"># 深度特征提取网络，引入残差</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_before_upsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 上采样前进行卷积</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_last<span class="token punctuation">(</span>self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 上采样后再通过输出卷积层</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>upsampler <span class="token operator">==</span> <span class="token string">'pixelshuffledirect'</span><span class="token punctuation">:</span>  <span class="token comment"># 一步是实现既上采样也降维</span>
            <span class="token comment"># 适合轻量级超分</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_first<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 输入卷积层</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_after_body<span class="token punctuation">(</span>self<span class="token punctuation">.</span>forward_features<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> x  <span class="token comment"># 深度特征提取网络，引入残差</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 上采样并降维后输出</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>upsampler <span class="token operator">==</span> <span class="token string">'nearest+conv'</span><span class="token punctuation">:</span>  <span class="token comment"># 最近邻插值上采样方法</span>
            <span class="token comment"># 适合真实图像超分，只适合 4 倍超分</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_first<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 输入卷积层</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_after_body<span class="token punctuation">(</span>self<span class="token punctuation">.</span>forward_features<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> x  <span class="token comment"># 深度特征提取网络，引入残差</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_before_upsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 上采样前进行卷积</span>
            <span class="token comment"># 第一次上采样 2 倍</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>lrelu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv_up1<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>x<span class="token punctuation">,</span> scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'nearest'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># 第二次上采样 2 倍</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>lrelu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv_up2<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>x<span class="token punctuation">,</span> scale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'nearest'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_last<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lrelu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv_hr<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#  输出卷积层</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 适合图像去噪和 JPEG 压缩去伪影</span>
            x_first <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_first<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 输入卷积层</span>
            res <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_after_body<span class="token punctuation">(</span>self<span class="token punctuation">.</span>forward_features<span class="token punctuation">(</span>x_first<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> x_first  <span class="token comment"># 深度特征提取网络，引入残差</span>
            x <span class="token operator">=</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>conv_last<span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">#  输出卷积层，引入残差</span>

        x <span class="token operator">=</span> x <span class="token operator">/</span> self<span class="token punctuation">.</span>img_range <span class="token operator">+</span> self<span class="token punctuation">.</span>mean  <span class="token comment"># 最后的 x 除以灰度值范围再加上 RGB 均值</span>

        <span class="token keyword">return</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>H<span class="token operator">*</span>self<span class="token punctuation">.</span>upscale<span class="token punctuation">,</span> <span class="token punctuation">:</span>W<span class="token operator">*</span>self<span class="token punctuation">.</span>upscale<span class="token punctuation">]</span>  <span class="token comment"># 返回输出 x</span>
</code></pre> 
<h3>
<a id="MLP_274"></a>MLP</h3> 
<p>多层感知机 MLP 是 transformer 比较基础的部分，具体原理也很简单。</p> 
<pre><code class="prism language-python"><span class="token comment"># 多层感知机</span>
<span class="token keyword">class</span> <span class="token class-name">Mlp</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_features<span class="token punctuation">,</span> hidden_features<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> act_layer<span class="token operator">=</span>nn<span class="token punctuation">.</span>GELU<span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        out_features <span class="token operator">=</span> out_features <span class="token keyword">or</span> in_features  <span class="token comment"># 输入特征的维度</span>
        hidden_features <span class="token operator">=</span> hidden_features <span class="token keyword">or</span> in_features  <span class="token comment"># 隐藏特征维度</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token punctuation">,</span> hidden_features<span class="token punctuation">)</span>  <span class="token comment"># 线性层</span>
        self<span class="token punctuation">.</span>act <span class="token operator">=</span> act_layer<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 激活函数</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_features<span class="token punctuation">,</span> out_features<span class="token punctuation">)</span>  <span class="token comment"># 线性层</span>
        self<span class="token punctuation">.</span>drop <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>drop<span class="token punctuation">)</span>  <span class="token comment"># 随机丢弃神经元，丢弃率默认为 0</span>
    
    <span class="token comment"># 定义前向传播</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
</code></pre> 
<h3>
<a id="Patch_Embedding_297"></a>Patch Embedding</h3> 
<p>主要的操作就是将原始 2 维图像 (特征图的一个 plane 或者说一个 channel) 转变为 1 维的 patch embeddings，通过 Swin Transformer 学习处理之后再重新组合成与原来特征图结构一致的新特征图。</p> 
<p>(1) 将 2 维图像转变成 1 维 patch embeddings。</p> 
<pre><code class="prism language-python"><span class="token comment"># 图像转成 Patch Embeddings</span>
<span class="token keyword">class</span> <span class="token class-name">PatchEmbed</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">r""" Image to Patch Embedding

    输入:
        img_size (int): 图像的大小，默认为 224*224.
        patch_size (int): Patch token 的大小，默认为 4*4.
        in_chans (int): 输入图像的通道数，默认为 3.
        embed_dim (int): 线性 projection 输出的通道数，默认为 96.
        norm_layer (nn.Module, optional): 归一化层， 默认为N None.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img_size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">,</span> patch_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> in_chans<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> embed_dim<span class="token operator">=</span><span class="token number">96</span><span class="token punctuation">,</span> norm_layer<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        img_size <span class="token operator">=</span> to_2tuple<span class="token punctuation">(</span>img_size<span class="token punctuation">)</span>  <span class="token comment"># 图像的大小，默认为 224*224</span>
        patch_size <span class="token operator">=</span> to_2tuple<span class="token punctuation">(</span>patch_size<span class="token punctuation">)</span>  <span class="token comment"># Patch token 的大小，默认为 4*4</span>
        patches_resolution <span class="token operator">=</span> <span class="token punctuation">[</span>img_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> patch_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> patch_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># patch 的分辨率</span>
        self<span class="token punctuation">.</span>img_size <span class="token operator">=</span> img_size
        self<span class="token punctuation">.</span>patch_size <span class="token operator">=</span> patch_size
        self<span class="token punctuation">.</span>patches_resolution <span class="token operator">=</span> patches_resolution
        self<span class="token punctuation">.</span>num_patches <span class="token operator">=</span> patches_resolution<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> patches_resolution<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># patch 的个数，num_patches</span>

        self<span class="token punctuation">.</span>in_chans <span class="token operator">=</span> in_chans  <span class="token comment"># 输入图像的通道数</span>
        self<span class="token punctuation">.</span>embed_dim <span class="token operator">=</span> embed_dim  <span class="token comment"># 线性 projection 输出的通道数</span>

        <span class="token keyword">if</span> norm_layer <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>norm <span class="token operator">=</span> norm_layer<span class="token punctuation">(</span>embed_dim<span class="token punctuation">)</span>  <span class="token comment"># 归一化</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>norm <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token comment"># 定义前向传播</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 结构为 [B, num_patches, C]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>norm <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 归一化</span>
        <span class="token keyword">return</span> x
</code></pre> 
<p>(2) 将 1 维 patch embeddings 转变为 2 维图像。</p> 
<pre><code class="prism language-python"><span class="token comment"># 从 Patch Embeddings 组合图像</span>
<span class="token keyword">class</span> <span class="token class-name">PatchUnEmbed</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">r""" Image to Patch Unembedding

    输入:
        img_size (int): 图像的大小，默认为 224*224.
        patch_size (int): Patch token 的大小，默认为 4*4.
        in_chans (int): 输入图像的通道数，默认为 3.
        embed_dim (int): 线性 projection 输出的通道数，默认为 96.
        norm_layer (nn.Module, optional): 归一化层， 默认为N None.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img_size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">,</span> patch_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> in_chans<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> embed_dim<span class="token operator">=</span><span class="token number">96</span><span class="token punctuation">,</span> norm_layer<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        img_size <span class="token operator">=</span> to_2tuple<span class="token punctuation">(</span>img_size<span class="token punctuation">)</span>  <span class="token comment"># 图像的大小，默认为 224*224</span>
        patch_size <span class="token operator">=</span> to_2tuple<span class="token punctuation">(</span>patch_size<span class="token punctuation">)</span>  <span class="token comment"># Patch token 的大小，默认为 4*4</span>
        patches_resolution <span class="token operator">=</span> <span class="token punctuation">[</span>img_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> patch_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> patch_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># patch 的分辨率</span>
        self<span class="token punctuation">.</span>img_size <span class="token operator">=</span> img_size
        self<span class="token punctuation">.</span>patch_size <span class="token operator">=</span> patch_size
        self<span class="token punctuation">.</span>patches_resolution <span class="token operator">=</span> patches_resolution
        self<span class="token punctuation">.</span>num_patches <span class="token operator">=</span> patches_resolution<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> patches_resolution<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># patch 的个数，num_patches</span>

        self<span class="token punctuation">.</span>in_chans <span class="token operator">=</span> in_chans  <span class="token comment"># 输入图像的通道数</span>
        self<span class="token punctuation">.</span>embed_dim <span class="token operator">=</span> embed_dim  <span class="token comment"># 线性 projection 输出的通道数</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        B<span class="token punctuation">,</span> HW<span class="token punctuation">,</span> C <span class="token operator">=</span> x<span class="token punctuation">.</span>shape  <span class="token comment"># 输入 x 的结构</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>B<span class="token punctuation">,</span> self<span class="token punctuation">.</span>embed_dim<span class="token punctuation">,</span> x_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 输出结构为 [B, Ph*Pw, C]</span>
        <span class="token keyword">return</span> x
</code></pre> 
<h3>
<a id="Window_Attention_371"></a>Window Attention</h3> 
<p>采用窗口注意力来减轻传统 Transformer 的全局注意力带来的计算负担，将注意力的计算限制在每一个窗口里，在每个窗口里其实还是原始的多头自注意力。（<strong>注</strong>：这个窗口注意力我之前也有过类似想法，主要是考虑到由于网络测试阶段的输入图像大小是不定的，如果在其中加入注意力机制得到的注意力图也是不定的，这一定程度上限制网络的泛化性能，将窗口注意力的思想迁移到 CNN 相信也能有不错的表现）</p> 
<p>(1) 窗口分割</p> 
<pre><code class="prism language-python"><span class="token comment"># 将输入分割为多个不重叠窗口</span>
<span class="token keyword">def</span> <span class="token function">window_partition</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> window_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    输入:
        x: (B, H, W, C)
        window_size (int): window size  # 窗口的大小
    返回:
        windows: (num_windows*B, window_size, window_size, C)  # 每一个 batch 有单独的 windows
    """</span>
    B<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> C <span class="token operator">=</span> x<span class="token punctuation">.</span>shape  <span class="token comment"># 输入的 batch 个数，高，宽，通道数</span>
    <span class="token comment"># 将输入 x 重构为结构 [batch 个数，高方向的窗口个数，窗口大小，宽方向的窗口个数，窗口大小，通道数] 的张量</span>
    x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>B<span class="token punctuation">,</span> H <span class="token operator">//</span> window_size<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> W <span class="token operator">//</span> window_size<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> C<span class="token punctuation">)</span>
    <span class="token comment"># 交换重构后 x 的第 3和4 维度， 5和6 维度，再次重构为结构 [高和宽方向的窗口个数乘以 batch 个数，窗口大小，窗口大小，通道数] 的张量</span>
    windows <span class="token operator">=</span> x<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> C<span class="token punctuation">)</span>
    <span class="token keyword">return</span> windows
    <span class="token comment"># 这里比较有意思，不太理解的可以给个初始值，比如 x = torch.randn([1, 14, 28, 3])</span>
</code></pre> 
<p>(2) 窗口注意力<br> 这里的相对位置索引比较有意思，有不明白的可以参考：<a href="https://zhuanlan.zhihu.com/p/367111046">图解Swin Transformer</a>。</p> 
<pre><code class="prism language-python"><span class="token comment"># 窗口注意力</span>
<span class="token keyword">class</span> <span class="token class-name">WindowAttention</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">r""" 基于有相对位置偏差的多头自注意力窗口，支持移位的(shifted)或者不移位的(non-shifted)窗口.

    输入:
        dim (int): 输入特征的维度.
        window_size (tuple[int]): 窗口的大小.
        num_heads (int): 注意力头的个数.
        qkv_bias (bool, optional): 给 query, key, value 添加可学习的偏置，默认为 True.
        qk_scale (float | None, optional): 重写默认的缩放因子 scale.
        attn_drop (float, optional): 注意力权重的丢弃率，默认为 0.0.
        proj_drop (float, optional): 输出的丢弃率，默认为 0.0.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dim<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> num_heads<span class="token punctuation">,</span> qkv_bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> qk_scale<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> attn_drop<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> proj_drop<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dim <span class="token operator">=</span> dim <span class="token comment"># 输入特征的维度</span>
        self<span class="token punctuation">.</span>window_size <span class="token operator">=</span> window_size  <span class="token comment"># 窗口的高 Wh,宽 Ww</span>
        self<span class="token punctuation">.</span>num_heads <span class="token operator">=</span> num_heads  <span class="token comment"># 注意力头的个数</span>
        head_dim <span class="token operator">=</span> dim <span class="token operator">//</span> num_heads  <span class="token comment"># 注意力头的维度</span>
        self<span class="token punctuation">.</span>scale <span class="token operator">=</span> qk_scale <span class="token keyword">or</span> head_dim <span class="token operator">**</span> <span class="token operator">-</span><span class="token number">0.5</span>  <span class="token comment"># 缩放因子 scale</span>

        <span class="token comment"># 定义相对位置偏移的参数表，结构为 [2*Wh-1 * 2*Ww-1, num_heads]</span>
        self<span class="token punctuation">.</span>relative_position_bias_table <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>
            torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> window_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> window_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num_heads<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取窗口内每个 token 的成对的相对位置索引</span>
        coords_h <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>self<span class="token punctuation">.</span>window_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 高维度上的坐标 (0, 7)</span>
        coords_w <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>self<span class="token punctuation">.</span>window_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 宽维度上的坐标 (0, 7)</span>
        coords <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span><span class="token punctuation">[</span>coords_h<span class="token punctuation">,</span> coords_w<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 坐标，结构为 [2, Wh, Ww]</span>
        coords_flatten <span class="token operator">=</span> torch<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>coords<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 重构张量结构为 [2, Wh*Ww]</span>
        relative_coords <span class="token operator">=</span> coords_flatten<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">-</span> coords_flatten<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 相对坐标，结构为 [2, Wh*Ww, Wh*Ww]</span>
        relative_coords <span class="token operator">=</span> relative_coords<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 交换维度，结构为 [Wh*Ww, Wh*Ww, 2]</span>
        relative_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span>  <span class="token comment"># 第1个维度移位</span>
        relative_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span>  <span class="token comment"># 第1个维度移位</span>
        relative_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span>  <span class="token comment"># 第1个维度的值乘以 2倍的 Ww，再减 1</span>
        relative_position_index <span class="token operator">=</span> relative_coords<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 相对位置索引，结构为 [Wh*Ww, Wh*Ww]</span>
        self<span class="token punctuation">.</span>register_buffer<span class="token punctuation">(</span><span class="token string">"relative_position_index"</span><span class="token punctuation">,</span> relative_position_index<span class="token punctuation">)</span>  <span class="token comment"># 保存数据，不再更新</span>

        self<span class="token punctuation">.</span>qkv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>dim<span class="token punctuation">,</span> dim <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> bias<span class="token operator">=</span>qkv_bias<span class="token punctuation">)</span>  <span class="token comment"># 线性层，特征维度变为原来的 3倍</span>
        self<span class="token punctuation">.</span>attn_drop <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>attn_drop<span class="token punctuation">)</span>  <span class="token comment"># 随机丢弃神经元，丢弃率默认为 0.0</span>
        self<span class="token punctuation">.</span>proj <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>dim<span class="token punctuation">,</span> dim<span class="token punctuation">)</span>  <span class="token comment"># 线性层，特征维度不变</span>

        self<span class="token punctuation">.</span>proj_drop <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>proj_drop<span class="token punctuation">)</span>  <span class="token comment"># 随机丢弃神经元，丢弃率默认为 0.0</span>

        trunc_normal_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>relative_position_bias_table<span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">.02</span><span class="token punctuation">)</span>  <span class="token comment"># 截断正态分布，限制标准差为 0.02</span>
        self<span class="token punctuation">.</span>softmax <span class="token operator">=</span> nn<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 激活函数 softmax</span>
    
    <span class="token comment"># 定义前向传播</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> mask<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        输入:
            x: 输入特征图，结构为 [num_windows*B, N, C]
            mask: (0/-inf) mask, 结构为 [num_windows, Wh*Ww, Wh*Ww] 或者没有 mask
        """</span>
        B_<span class="token punctuation">,</span> N<span class="token punctuation">,</span> C <span class="token operator">=</span> x<span class="token punctuation">.</span>shape  <span class="token comment"># 输入特征图的结构</span>
        <span class="token comment"># 将特征图的通道维度按照注意力头的个数重新划分，并再做交换维度操作</span>
        qkv <span class="token operator">=</span> self<span class="token punctuation">.</span>qkv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>B_<span class="token punctuation">,</span> N<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_heads<span class="token punctuation">,</span> C <span class="token operator">//</span> self<span class="token punctuation">.</span>num_heads<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        q<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v <span class="token operator">=</span> qkv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> qkv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> qkv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># 方便后续写代码，重新赋值</span>
        
        <span class="token comment"># q 乘以缩放因子</span>
        q <span class="token operator">=</span> q <span class="token operator">*</span> self<span class="token punctuation">.</span>scale
        <span class="token comment"># @ 代表常规意义上的矩阵相乘</span>
        attn <span class="token operator">=</span> <span class="token punctuation">(</span>q @ k<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># q 和 k 相乘后并交换最后两个维度</span>
        
        <span class="token comment"># 相对位置偏移，结构为 [Wh*Ww, Wh*Ww, num_heads]</span>
        relative_position_bias <span class="token operator">=</span> self<span class="token punctuation">.</span>relative_position_bias_table<span class="token punctuation">[</span>self<span class="token punctuation">.</span>relative_position_index<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>window_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 相对位置偏移交换维度，结构为 [num_heads, Wh*Ww, Wh*Ww]</span>
        relative_position_bias <span class="token operator">=</span> relative_position_bias<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
        attn <span class="token operator">=</span> attn <span class="token operator">+</span> relative_position_bias<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 带相对位置偏移的注意力图</span>

        <span class="token keyword">if</span> mask <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># 判断是否有 mask</span>
            nW <span class="token operator">=</span> mask<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># mask 的宽</span>
            <span class="token comment"># 注意力图与 mask 相加</span>
            attn <span class="token operator">=</span> attn<span class="token punctuation">.</span>view<span class="token punctuation">(</span>B_ <span class="token operator">//</span> nW<span class="token punctuation">,</span> nW<span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_heads<span class="token punctuation">,</span> N<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token operator">+</span> mask<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            attn <span class="token operator">=</span> attn<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_heads<span class="token punctuation">,</span> N<span class="token punctuation">,</span> N<span class="token punctuation">)</span>  <span class="token comment"># 恢复注意力图原来的结构</span>
            attn <span class="token operator">=</span> self<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>attn<span class="token punctuation">)</span>  <span class="token comment"># 激活注意力图 [0, 1] 之间</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            attn <span class="token operator">=</span> self<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>attn<span class="token punctuation">)</span>

        attn <span class="token operator">=</span> self<span class="token punctuation">.</span>attn_drop<span class="token punctuation">(</span>attn<span class="token punctuation">)</span>  <span class="token comment"># 随机设置注意力图中的部分值为 0</span>
        <span class="token comment"># 注意力图与 v 相乘得到新的注意力图</span>
        x <span class="token operator">=</span> <span class="token punctuation">(</span>attn @ v<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>B_<span class="token punctuation">,</span> N<span class="token punctuation">,</span> C<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>proj<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 通过线性层</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>proj_drop<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 随机设置新注意力图中的部分值为 0</span>
        <span class="token keyword">return</span> x
</code></pre> 
<p>(3) 窗口合并</p> 
<pre><code class="prism language-python"><span class="token comment"># 将多个不重叠窗口重新合并</span>
<span class="token keyword">def</span> <span class="token function">window_reverse</span><span class="token punctuation">(</span>windows<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    输入:
        windows: (num_windows*B, window_size, window_size, C)  # 分割得到的窗口(已处理)
        window_size (int): Window size  # 窗口大小
        H (int): Height of image  # 原分割窗口前特征图的高
        W (int): Width of image  # 原分割窗口前特征图的宽
    返回:
        x: (B, H, W, C)  # 返回与分割前特征图结构一样的结果
    """</span>
    <span class="token comment"># 以下就是分割窗口的逆向操作，不多解释</span>
    B <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>windows<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>H <span class="token operator">*</span> W <span class="token operator">/</span> window_size <span class="token operator">/</span> window_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> windows<span class="token punctuation">.</span>view<span class="token punctuation">(</span>B<span class="token punctuation">,</span> H <span class="token operator">//</span> window_size<span class="token punctuation">,</span> W <span class="token operator">//</span> window_size<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> x<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>B<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> x
</code></pre> 
<h3>
<a id="_Swin_Transformer__RSTB_504"></a>残差 Swin Transformer 块 (RSTB)</h3> 
<p>SwinIR 主要是使用 Swin Transformer 的思想来实现，残差 Swin Transformer 块 (RSTB) 可以理解为：</p> 
<p>(1) Swin Transformer 块是 RSTB 的基础组件；<br> (2) 多个 Swin Transformer 块构成基础网络；<br> (3) 基础网络结尾处加上卷积操作后再引入残差构成 RSTB。</p> 
<p>(1) Swin Transformer 块</p> 
<pre><code class="prism language-python"><span class="token comment"># Swin Transformer 块</span>
<span class="token keyword">class</span> <span class="token class-name">SwinTransformerBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    输入:
        dim (int): 输入特征的维度.
        input_resolution (tuple[int]): 输入特征图的分辨率.
        num_heads (int): 注意力头的个数.
        window_size (int): 窗口的大小.
        shift_size (int): SW-MSA 的移位值.
        mlp_ratio (float): 多层感知机隐藏层的维度和嵌入层的比.
        qkv_bias (bool, optional): 给 query, key, value 添加一个可学习偏置，默认为 True.
        qk_scale (float | None, optional): 重写默认的缩放因子 scale.
        drop (float, optional): 随机神经元丢弃率，默认为 0.0.
        attn_drop (float, optional): 注意力图随机丢弃率，默认为 0.0.
        drop_path (float, optional): 深度随机丢弃率，默认为 0.0.
        act_layer (nn.Module, optional): 激活函数，默认为 nn.GELU.
        norm_layer (nn.Module, optional): 归一化操作，默认为 nn.LayerNorm.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dim<span class="token punctuation">,</span> input_resolution<span class="token punctuation">,</span> num_heads<span class="token punctuation">,</span> window_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> shift_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
                 mlp_ratio<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">,</span> qkv_bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> qk_scale<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> attn_drop<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> drop_path<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
                 act_layer<span class="token operator">=</span>nn<span class="token punctuation">.</span>GELU<span class="token punctuation">,</span> norm_layer<span class="token operator">=</span>nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dim <span class="token operator">=</span> dim  <span class="token comment"># 输入特征的维度</span>
        self<span class="token punctuation">.</span>input_resolution <span class="token operator">=</span> input_resolution  <span class="token comment"># 输入特征图的分辨率</span>
        self<span class="token punctuation">.</span>num_heads <span class="token operator">=</span> num_heads  <span class="token comment"># 注意力头的个数</span>
        self<span class="token punctuation">.</span>window_size <span class="token operator">=</span> window_size  <span class="token comment"># 窗口的大小</span>
        self<span class="token punctuation">.</span>shift_size <span class="token operator">=</span> shift_size  <span class="token comment"># SW-MSA 的移位大小</span>
        self<span class="token punctuation">.</span>mlp_ratio <span class="token operator">=</span> mlp_ratio  <span class="token comment"># 多层感知机隐藏层的维度和嵌入层的比</span>
        <span class="token keyword">if</span> <span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_resolution<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">:</span>  <span class="token comment"># 如果输入分辨率小于等于窗口大小</span>
            self<span class="token punctuation">.</span>shift_size <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 移位大小为 0</span>
            self<span class="token punctuation">.</span>window_size <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_resolution<span class="token punctuation">)</span>  <span class="token comment"># 窗口大小等于输入分辨率大小</span>
        <span class="token comment"># 断言移位值必须小于等于窗口的大小</span>
        <span class="token keyword">assert</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>shift_size <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">,</span> <span class="token string">"shift_size must in 0-window_size"</span>

        self<span class="token punctuation">.</span>norm1 <span class="token operator">=</span> norm_layer<span class="token punctuation">(</span>dim<span class="token punctuation">)</span>  <span class="token comment"># 归一化层</span>
        <span class="token comment"># 窗口注意力</span>
        self<span class="token punctuation">.</span>attn <span class="token operator">=</span> WindowAttention<span class="token punctuation">(</span>
            dim<span class="token punctuation">,</span> window_size<span class="token operator">=</span>to_2tuple<span class="token punctuation">(</span>self<span class="token punctuation">.</span>window_size<span class="token punctuation">)</span><span class="token punctuation">,</span> num_heads<span class="token operator">=</span>num_heads<span class="token punctuation">,</span>
            qkv_bias<span class="token operator">=</span>qkv_bias<span class="token punctuation">,</span> qk_scale<span class="token operator">=</span>qk_scale<span class="token punctuation">,</span> attn_drop<span class="token operator">=</span>attn_drop<span class="token punctuation">,</span> proj_drop<span class="token operator">=</span>drop<span class="token punctuation">)</span>
        
        <span class="token comment"># 如果丢弃率大于 0 则进行随机丢弃，否则进行占位(不做任何操作)</span>
        self<span class="token punctuation">.</span>drop_path <span class="token operator">=</span> DropPath<span class="token punctuation">(</span>drop_path<span class="token punctuation">)</span> <span class="token keyword">if</span> drop_path <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">.</span> <span class="token keyword">else</span> nn<span class="token punctuation">.</span>Identity<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>norm2 <span class="token operator">=</span> norm_layer<span class="token punctuation">(</span>dim<span class="token punctuation">)</span>  <span class="token comment"># 归一化层</span>
        mlp_hidden_dim <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>dim <span class="token operator">*</span> mlp_ratio<span class="token punctuation">)</span>  <span class="token comment"># 多层感知机隐藏层维度</span>
        <span class="token comment"># 多层感知机</span>
        self<span class="token punctuation">.</span>mlp <span class="token operator">=</span> Mlp<span class="token punctuation">(</span>in_features<span class="token operator">=</span>dim<span class="token punctuation">,</span> hidden_features<span class="token operator">=</span>mlp_hidden_dim<span class="token punctuation">,</span> act_layer<span class="token operator">=</span>act_layer<span class="token punctuation">,</span> drop<span class="token operator">=</span>drop<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>shift_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 如果移位值大于 0</span>
            attn_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>calculate_mask<span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_resolution<span class="token punctuation">)</span>  <span class="token comment"># 计算注意力 mask</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            attn_mask <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 注意力 mask 赋空</span>

        self<span class="token punctuation">.</span>register_buffer<span class="token punctuation">(</span><span class="token string">"attn_mask"</span><span class="token punctuation">,</span> attn_mask<span class="token punctuation">)</span>  <span class="token comment"># 保存注意力 mask，不参与更新</span>
    
    <span class="token comment"># 计算注意力 mask</span>
    <span class="token keyword">def</span> <span class="token function">calculate_mask</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        H<span class="token punctuation">,</span> W <span class="token operator">=</span> x_size  <span class="token comment"># 特征图的高宽</span>
        img_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 新建张量，结构为 [1, H, W, 1]</span>
        <span class="token comment"># 以下两 slices 中的数据是索引，具体缘由尚未搞懂</span>
        h_slices <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>window_size<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 索引 0 到索引倒数第 window_size</span>
                    <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token operator">-</span>self<span class="token punctuation">.</span>window_size<span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>shift_size<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 索引倒数第 window_size 到索引倒数第 shift_size</span>
                    <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token operator">-</span>self<span class="token punctuation">.</span>shift_size<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 索引倒数第 shift_size 后所有索引</span>
        w_slices <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>window_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token operator">-</span>self<span class="token punctuation">.</span>window_size<span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>shift_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token operator">-</span>self<span class="token punctuation">.</span>shift_size<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        cnt <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> h <span class="token keyword">in</span> h_slices<span class="token punctuation">:</span>
            <span class="token keyword">for</span> w <span class="token keyword">in</span> w_slices<span class="token punctuation">:</span>
                img_mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> cnt  <span class="token comment"># 将 img_mask 中 h, w 对应索引范围的值置为 cnt</span>
                cnt <span class="token operator">+=</span> <span class="token number">1</span>  <span class="token comment"># 加 1</span>

        mask_windows <span class="token operator">=</span> window_partition<span class="token punctuation">(</span>img_mask<span class="token punctuation">,</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">)</span>  <span class="token comment"># 窗口分割，返回值结构为 [nW, window_size, window_size, 1]</span>
        mask_windows <span class="token operator">=</span> mask_windows<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>window_size <span class="token operator">*</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">)</span>  <span class="token comment"># 重构结构为二维张量，列数为 [window_size*window_size]</span>
        attn_mask <span class="token operator">=</span> mask_windows<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> mask_windows<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 增加第 2 维度减去增加第 3 维度的注意力 mask</span>
        <span class="token comment"># 用浮点数 -100. 填充注意力 mask 中值不为 0 的元素，再用浮点数 0. 填充注意力 mask 中值为 0 的元素</span>
        attn_mask <span class="token operator">=</span> attn_mask<span class="token punctuation">.</span>masked_fill<span class="token punctuation">(</span>attn_mask <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>masked_fill<span class="token punctuation">(</span>attn_mask <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> attn_mask

    <span class="token comment"># 定义前向传播</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        H<span class="token punctuation">,</span> W <span class="token operator">=</span> x_size  <span class="token comment"># 输入特征图的分辨率</span>
        B<span class="token punctuation">,</span> L<span class="token punctuation">,</span> C <span class="token operator">=</span> x<span class="token punctuation">.</span>shape  <span class="token comment"># 输入特征的 batch 个数，长度和维度</span>
        <span class="token comment"># assert L == H * W, "input feature has wrong size"</span>

        shortcut <span class="token operator">=</span> x
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 归一化</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>B<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> C<span class="token punctuation">)</span>  <span class="token comment"># 重构 x 为结构 [B, H, W, C]</span>

        <span class="token comment"># 循环移位</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>shift_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 如果移位值大于 0</span>
            <span class="token comment"># 第 0 维度上移 shift_size 位，第 1 维度左移 shift_size 位</span>
            shifted_x <span class="token operator">=</span> torch<span class="token punctuation">.</span>roll<span class="token punctuation">(</span>x<span class="token punctuation">,</span> shifts<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">-</span>self<span class="token punctuation">.</span>shift_size<span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>shift_size<span class="token punctuation">)</span><span class="token punctuation">,</span> dims<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            shifted_x <span class="token operator">=</span> x  <span class="token comment"># 不移位</span>

        <span class="token comment"># 对移位操作得到的特征图分割窗口, nW 是窗口的个数</span>
        x_windows <span class="token operator">=</span> window_partition<span class="token punctuation">(</span>shifted_x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">)</span>  <span class="token comment"># 结构为 [nW*B, window_size, window_size, C]</span>
        x_windows <span class="token operator">=</span> x_windows<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>window_size <span class="token operator">*</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">,</span> C<span class="token punctuation">)</span>  <span class="token comment"># 结构为 [nW*B, window_size*window_size, C]</span>

        <span class="token comment"># W-MSA/SW-MSA, 用在分辨率是窗口大小的整数倍的图像上进行测试</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>input_resolution <span class="token operator">==</span> x_size<span class="token punctuation">:</span>  <span class="token comment"># 输入分辨率与设定一致，不需要重新计算注意力 mask</span>
            attn_windows <span class="token operator">=</span> self<span class="token punctuation">.</span>attn<span class="token punctuation">(</span>x_windows<span class="token punctuation">,</span> mask<span class="token operator">=</span>self<span class="token punctuation">.</span>attn_mask<span class="token punctuation">)</span>  <span class="token comment"># 注意力窗口，结构为 [nW*B, window_size*window_size, C]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 输入分辨率与设定不一致，需要重新计算注意力 mask</span>
            attn_windows <span class="token operator">=</span> self<span class="token punctuation">.</span>attn<span class="token punctuation">(</span>x_windows<span class="token punctuation">,</span> mask<span class="token operator">=</span>self<span class="token punctuation">.</span>calculate_mask<span class="token punctuation">(</span>x_size<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>x<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 合并窗口</span>
        attn_windows <span class="token operator">=</span> attn_windows<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">,</span> C<span class="token punctuation">)</span>  <span class="token comment"># 结构为 [-1, window_size, window_size, C]</span>
        shifted_x <span class="token operator">=</span> window_reverse<span class="token punctuation">(</span>attn_windows<span class="token punctuation">,</span> self<span class="token punctuation">.</span>window_size<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">)</span>  <span class="token comment"># 结构为 [B, H', W', C]</span>

        <span class="token comment"># 逆向循环移位</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>shift_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># 第 0 维度下移 shift_size 位，第 1 维度右移 shift_size 位</span>
            x <span class="token operator">=</span> torch<span class="token punctuation">.</span>roll<span class="token punctuation">(</span>shifted_x<span class="token punctuation">,</span> shifts<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>shift_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>shift_size<span class="token punctuation">)</span><span class="token punctuation">,</span> dims<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> shifted_x  <span class="token comment"># 不逆向移位</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>B<span class="token punctuation">,</span> H <span class="token operator">*</span> W<span class="token punctuation">,</span> C<span class="token punctuation">)</span>  <span class="token comment"># 结构为 [B, H*W， C]</span>

        <span class="token comment"># FFN</span>
        x <span class="token operator">=</span> shortcut <span class="token operator">+</span> self<span class="token punctuation">.</span>drop_path<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 对 x 做 dropout，引入残差</span>
        x <span class="token operator">=</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>drop_path<span class="token punctuation">(</span>self<span class="token punctuation">.</span>mlp<span class="token punctuation">(</span>self<span class="token punctuation">.</span>norm2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 归一化后通过 MLP，再做 dropout，引入残差</span>

        <span class="token keyword">return</span> x
</code></pre> 
<p>(2) 基础网络</p> 
<pre><code class="prism language-python"><span class="token comment"># 单阶段的 SWin Transformer 基础层</span>
<span class="token keyword">class</span> <span class="token class-name">BasicLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 
    输入:
        dim (int): 输入特征的维度.
        input_resolution (tuple[int]): 输入分辨率.
        depth (int): SWin Transformer 块的个数.
        num_heads (int): 注意力头的个数.
        window_size (int): 本地(当前块中)窗口的大小.
        mlp_ratio (float): MLP隐藏层特征维度与嵌入层特征维度的比.
        qkv_bias (bool, optional): 给 query, key, value 添加一个可学习偏置，默认为 True.
        qk_scale (float | None, optional): 重写默认的缩放因子 scale.
        drop (float, optional): 随机丢弃神经元，丢弃率默认为 0.0.
        attn_drop (float, optional): 注意力图随机丢弃率，默认为 0.0.
        drop_path (float | tuple[float], optional): 深度随机丢弃率，默认为 0.0.
        norm_layer (nn.Module, optional): 归一化操作，默认为 nn.LayerNorm.
        downsample (nn.Module | None, optional): 结尾处的下采样层，默认没有.
        use_checkpoint (bool): 是否使用 checkpointing 来节省显存，默认为 False.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dim<span class="token punctuation">,</span> input_resolution<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> num_heads<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span>
                 mlp_ratio<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">,</span> qkv_bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> qk_scale<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> attn_drop<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
                 drop_path<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> norm_layer<span class="token operator">=</span>nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">,</span> downsample<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> use_checkpoint<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dim <span class="token operator">=</span> dim  <span class="token comment"># 输入特征的维度</span>
        self<span class="token punctuation">.</span>input_resolution <span class="token operator">=</span> input_resolution  <span class="token comment"># 输入分辨率</span>
        self<span class="token punctuation">.</span>depth <span class="token operator">=</span> depth  <span class="token comment"># SWin Transformer 块的个数</span>
        self<span class="token punctuation">.</span>use_checkpoint <span class="token operator">=</span> use_checkpoint  <span class="token comment"># 是否使用 checkpointing 来节省显存，默认为 False</span>

        <span class="token comment"># 创建 Swin Transformer 网络</span>
        self<span class="token punctuation">.</span>blocks <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>
            SwinTransformerBlock<span class="token punctuation">(</span>dim<span class="token operator">=</span>dim<span class="token punctuation">,</span> input_resolution<span class="token operator">=</span>input_resolution<span class="token punctuation">,</span>
                                 num_heads<span class="token operator">=</span>num_heads<span class="token punctuation">,</span> window_size<span class="token operator">=</span>window_size<span class="token punctuation">,</span>
                                 shift_size<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">else</span> window_size <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span>
                                 mlp_ratio<span class="token operator">=</span>mlp_ratio<span class="token punctuation">,</span>
                                 qkv_bias<span class="token operator">=</span>qkv_bias<span class="token punctuation">,</span> qk_scale<span class="token operator">=</span>qk_scale<span class="token punctuation">,</span>
                                 drop<span class="token operator">=</span>drop<span class="token punctuation">,</span> attn_drop<span class="token operator">=</span>attn_drop<span class="token punctuation">,</span>
                                 drop_path<span class="token operator">=</span>drop_path<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>drop_path<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token keyword">else</span> drop_path<span class="token punctuation">,</span>
                                 norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>depth<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># patch 合并层</span>
        <span class="token keyword">if</span> downsample <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># 如果有下采样</span>
            self<span class="token punctuation">.</span>downsample <span class="token operator">=</span> downsample<span class="token punctuation">(</span>input_resolution<span class="token punctuation">,</span> dim<span class="token operator">=</span>dim<span class="token punctuation">,</span> norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">)</span>  <span class="token comment"># 下采样</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>downsample <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 不做下采样</span>

    <span class="token comment">#定义前向传播</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> blk <span class="token keyword">in</span> self<span class="token punctuation">.</span>blocks<span class="token punctuation">:</span>  <span class="token comment"># x 输入串联的 Swin Transformer 块</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>use_checkpoint<span class="token punctuation">:</span>
                x <span class="token operator">=</span> checkpoint<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span>blk<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x_size<span class="token punctuation">)</span>  <span class="token comment"># 使用 checkpoint</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                x <span class="token operator">=</span> blk<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x_size<span class="token punctuation">)</span>  <span class="token comment"># 直接输入网络</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>downsample <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>downsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 下采样</span>
        <span class="token keyword">return</span> x
</code></pre> 
<p>(3) 残差 Swin Transformer 块 (RSTB)</p> 
<pre><code class="prism language-python"><span class="token comment"># 残差 Swin Transforme 块 (RSTB)</span>
<span class="token keyword">class</span> <span class="token class-name">RSTB</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    输入:
        dim (int): 输入特征的维度.
        input_resolution (tuple[int]): 输入分辨率.
        depth (int): SWin Transformer 块的个数.
        num_heads (int): 注意力头的个数.
        window_size (int): 本地(当前块中)窗口的大小.
        mlp_ratio (float): MLP隐藏层特征维度与嵌入层特征维度的比.
        qkv_bias (bool, optional): 给 query, key, value 添加一个可学习偏置，默认为 True.
        qk_scale (float | None, optional): 重写默认的缩放因子 scale.
        drop (float, optional): D 随机丢弃神经元，丢弃率默认为 0.0.
        attn_drop (float, optional): 注意力图随机丢弃率，默认为 0.0.
        drop_path (float | tuple[float], optional): 深度随机丢弃率，默认为 0.0.
        norm_layer (nn.Module, optional): 归一化操作，默认为 nn.LayerNorm.
        downsample (nn.Module | None, optional): 结尾处的下采样层，默认没有.
        use_checkpoint (bool): 是否使用 checkpointing 来节省显存，默认为 False.
        img_size: 输入图片的大小.
        patch_size: Patch 的大小.
        resi_connection: 残差连接之前的卷积块.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dim<span class="token punctuation">,</span> input_resolution<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> num_heads<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span>
                 mlp_ratio<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">.</span><span class="token punctuation">,</span> qkv_bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> qk_scale<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> attn_drop<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
                 drop_path<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> norm_layer<span class="token operator">=</span>nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">,</span> downsample<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> use_checkpoint<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 img_size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">,</span> patch_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> resi_connection<span class="token operator">=</span><span class="token string">'1conv'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RSTB<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>dim <span class="token operator">=</span> dim  <span class="token comment"># 输入特征的维度</span>
        self<span class="token punctuation">.</span>input_resolution <span class="token operator">=</span> input_resolution  <span class="token comment"># 输入分辨率</span>
        
        <span class="token comment"># SWin Transformer 基础层</span>
        self<span class="token punctuation">.</span>residual_group <span class="token operator">=</span> BasicLayer<span class="token punctuation">(</span>dim<span class="token operator">=</span>dim<span class="token punctuation">,</span>
                                         input_resolution<span class="token operator">=</span>input_resolution<span class="token punctuation">,</span>
                                         depth<span class="token operator">=</span>depth<span class="token punctuation">,</span>
                                         num_heads<span class="token operator">=</span>num_heads<span class="token punctuation">,</span>
                                         window_size<span class="token operator">=</span>window_size<span class="token punctuation">,</span>
                                         mlp_ratio<span class="token operator">=</span>mlp_ratio<span class="token punctuation">,</span>
                                         qkv_bias<span class="token operator">=</span>qkv_bias<span class="token punctuation">,</span> qk_scale<span class="token operator">=</span>qk_scale<span class="token punctuation">,</span>
                                         drop<span class="token operator">=</span>drop<span class="token punctuation">,</span> attn_drop<span class="token operator">=</span>attn_drop<span class="token punctuation">,</span>
                                         drop_path<span class="token operator">=</span>drop_path<span class="token punctuation">,</span>
                                         norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">,</span>
                                         downsample<span class="token operator">=</span>downsample<span class="token punctuation">,</span>
                                         use_checkpoint<span class="token operator">=</span>use_checkpoint<span class="token punctuation">)</span>

        <span class="token keyword">if</span> resi_connection <span class="token operator">==</span> <span class="token string">'1conv'</span><span class="token punctuation">:</span>  <span class="token comment"># 结尾用 1 个卷积层</span>
            self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>dim<span class="token punctuation">,</span> dim<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> resi_connection <span class="token operator">==</span> <span class="token string">'3conv'</span><span class="token punctuation">:</span>  <span class="token comment"># 结尾用 3 个卷积层</span>
            <span class="token comment"># 为了减少参数使用和节约显存，采用瓶颈结构</span>
            self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>dim<span class="token punctuation">,</span> dim <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span>negative_slope<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>dim <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> dim <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span>negative_slope<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>dim <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span> dim<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 图像转成 Patch Embeddings</span>
        self<span class="token punctuation">.</span>patch_embed <span class="token operator">=</span> PatchEmbed<span class="token punctuation">(</span>
            img_size<span class="token operator">=</span>img_size<span class="token punctuation">,</span> patch_size<span class="token operator">=</span>patch_size<span class="token punctuation">,</span> in_chans<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> embed_dim<span class="token operator">=</span>dim<span class="token punctuation">,</span>
            norm_layer<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 从 Patch Embeddings 组合图像</span>
        self<span class="token punctuation">.</span>patch_unembed <span class="token operator">=</span> PatchUnEmbed<span class="token punctuation">(</span>
            img_size<span class="token operator">=</span>img_size<span class="token punctuation">,</span> patch_size<span class="token operator">=</span>patch_size<span class="token punctuation">,</span> in_chans<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> embed_dim<span class="token operator">=</span>dim<span class="token punctuation">,</span>
            norm_layer<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token comment"># 定义前向传播</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>patch_embed<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>self<span class="token punctuation">.</span>patch_unembed<span class="token punctuation">(</span>self<span class="token punctuation">.</span>residual_group<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x_size<span class="token punctuation">)</span><span class="token punctuation">,</span> x_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> x  <span class="token comment"># 引入残差</span>
</code></pre> 
<h3>
<a id="HQ_Image_Reconstruction_770"></a>HQ Image Reconstruction</h3> 
<p>高质量图像重建模块其实就是卷积和上采样操作的组合，在这块论文提出 4 种结构。</p> 
<p>(1) 经典超分 (卷积 + pixelshuffle 上采样 + 卷积)；<br> (2) 轻量超分 (卷积 + pixelshuffle 上采样)；<br> (3) 真实图像超分 (卷积 + 卷积插值上采样 + 卷积插值上采样 + 卷积)；<br> (4) 像去噪和 JPEG 压缩去伪影 （卷积 + 引入残差）。</p> 
<p>在这里主要看一下两种上采样操作：<br> (1) 先卷积再使用 pixelshuffle 上采样，特征图维度不是 3</p> 
<pre><code class="prism language-python"><span class="token comment"># 上采样</span>
<span class="token keyword">class</span> <span class="token class-name">Upsample</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    输入:
        scale (int): 缩放因子，支持 2^n and 3.
        num_feat (int): 中间特征的通道数.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> num_feat<span class="token punctuation">)</span><span class="token punctuation">:</span>
        m <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&amp;</span> <span class="token punctuation">(</span>scale <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 缩放因子等于 2^n</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>scale<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">#  循环 n 次</span>
                m<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_feat<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> num_feat<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 卷积层</span>
                m<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>PixelShuffle<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># pixelshuffle 上采样 2 倍</span>
        <span class="token keyword">elif</span> scale <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>  <span class="token comment"># 缩放因子等于 3</span>
            m<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_feat<span class="token punctuation">,</span> <span class="token number">9</span> <span class="token operator">*</span> num_feat<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 卷积层</span>
            m<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>PixelShuffle<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># pixelshuffle 上采样 3 倍</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 报错，缩放因子不对</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'scale </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>scale<span class="token punctuation">}</span></span><span class="token string"> is not supported. '</span></span> <span class="token string">'Supported scales: 2^n and 3.'</span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Upsample<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span>
</code></pre> 
<p>(2) 一步既上采样也实现输出降维，特征图维度是 3，即最后的恢复图像</p> 
<pre><code class="prism language-python"><span class="token comment"># 一步实现既上采样也降维</span>
<span class="token keyword">class</span> <span class="token class-name">UpsampleOneStep</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""一步上采样与前边上采样模块不同之处在于该模块只有一个卷积层和一个 pixelshuffle 层

    输入:
        scale (int): 缩放因子，支持 2^n and 3.
        num_feat (int): 中间特征的通道数.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> num_feat<span class="token punctuation">,</span> num_out_ch<span class="token punctuation">,</span> input_resolution<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>num_feat <span class="token operator">=</span> num_feat  <span class="token comment"># 中间特征的通道数</span>
        self<span class="token punctuation">.</span>input_resolution <span class="token operator">=</span> input_resolution  <span class="token comment"># 输入分辨率</span>
        m <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        m<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>num_feat<span class="token punctuation">,</span> <span class="token punctuation">(</span>scale <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> num_out_ch<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 卷积层</span>
        m<span class="token punctuation">.</span>append<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>PixelShuffle<span class="token punctuation">(</span>scale<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># pixelshuffle 上采样 scale 倍</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>UpsampleOneStep<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span>
</code></pre> 
<h3>
<a id="_822"></a>一个测试实例</h3> 
<p>虽然 SwinIR 的整体参数不大，但是计算负担比较大。</p> 
<pre><code class="prism language-python">upscale <span class="token operator">=</span> <span class="token number">4</span>  <span class="token comment"># 图像放大因子</span>
window_size <span class="token operator">=</span> <span class="token number">8</span>  <span class="token comment"># 窗口大小</span>
height <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">//</span> upscale <span class="token operator">//</span> window_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> window_size  <span class="token comment"># 输入图像的高</span>
width <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">720</span> <span class="token operator">//</span> upscale <span class="token operator">//</span> window_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> window_size  <span class="token comment"># 输入图像的宽</span>
<span class="token comment"># 实例化 SWinIR</span>
model <span class="token operator">=</span> SwinIR<span class="token punctuation">(</span>upscale<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> img_size<span class="token operator">=</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">,</span>
               window_size<span class="token operator">=</span>window_size<span class="token punctuation">,</span> img_range<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> depths<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               embed_dim<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">,</span> num_heads<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mlp_ratio<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> upsampler<span class="token operator">=</span><span class="token string">'pixelshuffledirect'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>  <span class="token comment"># 打印网络结构</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> width<span class="token punctuation">)</span>  <span class="token comment"># 打印输入图像的高和宽</span>

x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">#随机生成输入图像</span>
x <span class="token operator">=</span> model<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># 送入网络</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token comment"># 打印网络输入的图像结构</span>
</code></pre> 
<h2>
<a id="_840"></a>参考文献</h2> 
<p>[1] Liang J, Cao J, Sun G, et al. SwinIR: Image restoration using swin transformer[C]//Proceedings of the IEEE/CVF International Conference on Computer Vision. 2021: 1833-1844.<br> [2] Liu Z, Lin Y, Cao Y, et al. Swin transformer: Hierarchical vision transformer using shifted windows[J]. arXiv preprint arXiv:2103.14030, 2021.</p> 
<h2>
<a id="_843"></a>结语</h2> 
<p><strong>转载请注明出处</strong>。SwinIR 本身没有太多创新，主要还是 Swin Transformer 在图像恢复领域进行应用，但是整体网络对显卡的要求已经很接近纯 CNN 的网络。完整的 SwinIR 的注释代码可以移步链接：<a href="https://download.csdn.net/download/Wenyuanbo/40284085">https://download.csdn.net/download/Wenyuanbo/40284085</a>。既然现在 Swin Transfomer 已经公开，那相信不久就会如同当初的 ResNet 一样有许多改进方案不断出现，先到先得。如果我的这篇文章对你有所帮助，希望能不吝点赞关注一波。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>