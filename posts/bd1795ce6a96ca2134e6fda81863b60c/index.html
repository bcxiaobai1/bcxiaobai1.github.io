<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Prometheus 的应用服务发现及黑河部署等 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Prometheus 的应用服务发现及黑河部署等</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="htmledit_views">
                    <p></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="%C2%A0%C2%A0promtool%E6%A3%80%E6%9F%A5%E8%AF%AD%E6%B3%95-toc" style="margin-left:80px"><a href="#%C2%A0%C2%A0promtool%E6%A3%80%E6%9F%A5%E8%AF%AD%E6%B3%95">  promtool检查语法</a></p> 
<p id="%E9%83%A8%E7%BD%B2Prometheus%20Server-toc" style="margin-left:0px"><a href="#%E9%83%A8%E7%BD%B2Prometheus%20Server">部署Prometheus Server</a></p> 
<p id="%C2%A0%E6%A3%80%E6%9F%A5%E8%AF%AD%E6%B3%95%E6%98%AF%E5%90%A6%E8%A7%84%E8%8C%83-toc" style="margin-left:80px"><a href="#%C2%A0%E6%A3%80%E6%9F%A5%E8%AF%AD%E6%B3%95%E6%98%AF%E5%90%A6%E8%A7%84%E8%8C%83"> 检查语法是否规范</a></p> 
<p id="%E9%83%A8%E7%BD%B2node-exporter-toc" style="margin-left:40px"><a href="#%E9%83%A8%E7%BD%B2node-exporter">部署node-exporter</a></p> 
<p id="%E9%83%A8%E7%BD%B2Consul-toc" style="margin-left:40px"><a href="#%E9%83%A8%E7%BD%B2Consul">部署Consul</a></p> 
<p id="%E7%9B%B4%E6%8E%A5%E8%AF%B7%E6%B1%82API%E8%BF%9B%E8%A1%8C%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C-toc" style="margin-left:40px"><a href="#%E7%9B%B4%E6%8E%A5%E8%AF%B7%E6%B1%82API%E8%BF%9B%E8%A1%8C%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C">直接请求API进行服务注册</a></p> 
<p id="%E4%BD%BF%E7%94%A8register%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%EF%BC%88%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8%EF%BC%89%20%E5%8D%95%E4%B8%AA%E5%92%8C%E5%A4%9A%E4%B8%AA%E6%B3%A8%E5%86%8C%EF%BC%8C%E5%A4%9A%E4%B8%AA%E5%90%8E%E9%9D%A2%E5%A4%9A%E5%8A%A0%E4%BA%86s-toc" style="margin-left:80px"><a href="#%E4%BD%BF%E7%94%A8register%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%EF%BC%88%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8%EF%BC%89%20%E5%8D%95%E4%B8%AA%E5%92%8C%E5%A4%9A%E4%B8%AA%E6%B3%A8%E5%86%8C%EF%BC%8C%E5%A4%9A%E4%B8%AA%E5%90%8E%E9%9D%A2%E5%A4%9A%E5%8A%A0%E4%BA%86s">使用register命令注册服务（建议使用） 单个和多个注册，多个后面多加了s</a></p> 
<p id="%C2%A0%20%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9Aconsul%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-toc" style="margin-left:40px"><a href="#%C2%A0%20%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9Aconsul%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">在Prometheus上做consul的服务发现</a></p> 
<p id="%E9%83%A8%E7%BD%B2Consul%20Exporter-toc" style="margin-left:40px"><a href="#%E9%83%A8%E7%BD%B2Consul%20Exporter">部署Consul Exporter</a></p> 
<p id="%C2%A0%C2%A0%20%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9AConsul%20Exporter%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%20%E5%9B%A0%E4%B8%BAPrometheus%E6%98%AF%E5%AF%B9Consul%E5%81%9A%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%89%80%E4%BB%A5-toc" style="margin-left:80px"><a href="#%C2%A0%C2%A0%20%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9AConsul%20Exporter%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%20%E5%9B%A0%E4%B8%BAPrometheus%E6%98%AF%E5%AF%B9Consul%E5%81%9A%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%89%80%E4%BB%A5">在Prometheus上做Consul Exporter的服务发现 因为Prometheus是对Consul做的服务发现所以</a></p> 
<p id="%E9%83%A8%E7%BD%B2MySQL%20Exporter-toc" style="margin-left:40px"><a href="#%E9%83%A8%E7%BD%B2MySQL%20Exporter">部署MySQL Exporter</a></p> 
<p id="%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9AConsul%20Exporter%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-toc" style="margin-left:80px"><a href="#%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9AConsul%20Exporter%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">在Prometheus上做Consul Exporter的服务发现</a></p> 
<p id="%E9%83%A8%E7%BD%B2nginx%20Exporter-toc" style="margin-left:40px"><a href="#%E9%83%A8%E7%BD%B2nginx%20Exporter">部署nginx Exporter</a></p> 
<p id="%C2%A0%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9AConsul%20Exporter%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-toc" style="margin-left:80px"><a href="#%C2%A0%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9AConsul%20Exporter%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"> 在Prometheus上做Consul Exporter的服务发现</a></p> 
<p id="%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9Atomcat-toc" style="margin-left:40px"><a href="#%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9Atomcat">在Prometheus上做tomcat</a></p> 
<p id="tomcat%E5%85%81%E8%AE%B8%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95-toc" style="margin-left:80px"><a href="#tomcat%E5%85%81%E8%AE%B8%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95">tomcat允许远程登录</a></p> 
<p id="%C2%A0tomcat%E4%B8%8B%E8%BD%BD%E5%8F%8A%E6%89%A9%E5%85%85%E6%94%AF%E6%8C%81%E7%9B%B8%E5%BA%94%E7%9A%84%E5%8A%9F%E8%83%BD-toc" style="margin-left:120px"><a href="#%C2%A0tomcat%E4%B8%8B%E8%BD%BD%E5%8F%8A%E6%89%A9%E5%85%85%E6%94%AF%E6%8C%81%E7%9B%B8%E5%BA%94%E7%9A%84%E5%8A%9F%E8%83%BD"> tomcat下载及扩充支持相应的功能</a></p> 
<p id="%C2%A0%E6%B3%A8%E5%86%8C%E5%88%B0consul%E4%B8%8A%E9%9D%A2%E5%8E%BB%E5%8F%8APrometheus%E4%B8%8A%E5%81%9A%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-toc" style="margin-left:120px"><a href="#%C2%A0%E6%B3%A8%E5%86%8C%E5%88%B0consul%E4%B8%8A%E9%9D%A2%E5%8E%BB%E5%8F%8APrometheus%E4%B8%8A%E5%81%9A%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"> 注册到consul上面去及Prometheus上做服务发现</a></p> 
<p id="%E7%BD%B2Blackbox%20Exporter%C2%A0%E5%8F%96%E5%86%B3%E4%BA%8E%E9%BB%91%E7%9B%92%E7%9B%91%E6%8E%A7-toc" style="margin-left:40px"><a href="#%E7%BD%B2Blackbox%20Exporter%C2%A0%E5%8F%96%E5%86%B3%E4%BA%8E%E9%BB%91%E7%9B%92%E7%9B%91%E6%8E%A7">署Blackbox Exporter 取决于黑盒监控</a></p> 
<p id="%E5%9C%A8Prometheus%E9%87%8C%E9%9D%A2%E5%81%9A%E9%BB%91%E6%B2%B3%E5%8F%91%E7%8E%B0%C2%A0-toc" style="margin-left:120px"><a href="#%E5%9C%A8Prometheus%E9%87%8C%E9%9D%A2%E5%81%9A%E9%BB%91%E6%B2%B3%E5%8F%91%E7%8E%B0%C2%A0">在Prometheus里面做黑河发现 </a></p> 
<hr id="hr-toc"> 
<p></p> 
<p><img alt="" height="748" src="https://images2.imgbox.com/68/d0/JwmJsoAC_o.png" width="1200"></p> 
<p></p> 
<ol>
<li>Record Rule: 保存在配置文件中，由Prometheus Server周期去评估，结果会生成一个时序数据，回存至TSDB，并支持查询</li>
<li>  Alert Rule: 布尔型告警表达式，保存在配置文件中，由Prometheus Server周期去评估，结果会生成一个时序数据，服务状态转换时，即会生成告警；</li>
</ol> 
<ul><li>布尔型告警表达式：监控指标的值或其他相关条件来判断系统是否处于异常状态，并触发相应的告警。</li></ul> 
<p><strong>record 记录规则，</strong></p> 
<ul><li>当Prometheus里面用promQL写的规则执行文件，执行完成时，如果恰巧是grafana所需要的文件，就会直接在这里读取，而不是再从TSDB里面重新读取，从而省去大量IO</li></ul> 
<p> 查询持久化：<br>     把查询语句的执行结果长期保存； </p> 
<p>  记录规则：保存于配置文件，由Server自动在后台周期性执行； <br>     evaluation_interval: 15s </p> 
<h3 id="%C2%A0%C2%A0promtool%E6%A3%80%E6%9F%A5%E8%AF%AD%E6%B3%95">  promtool检查语法</h3> 
<blockquote> 
 <p> ./promtool check config prometheus.yml    #  promtool 可以用这命令检查语法</p> 
</blockquote> 
<p> /usr/local/consul services register server02.json   注册consul的发现表</p> 
<p>/usr/local/consul services dederegister -id server02.json  注销consul的发现表</p> 
<p></p> 
<pre><code>https://prometheus.io/download/  官网
</code></pre> 
<h1 id="%E9%83%A8%E7%BD%B2Prometheus%20Server">部署Prometheus Server</h1> 
<p>下载程序包，以2.40.2版为例：</p> 
<pre><code>curl -LO https://github.com/prometheus/prometheus/releases/download/v2.40.2/prometheus-2.40.2.linux-amd64.tar.gz</code></pre> 
<p>展开程序包：</p> 
<pre><code>tar xf prometheus-2.40.2.linux-amd64.tar.gz -C /usr/local/
ln -sv /usr/local/prometheus-2.40.2.linux-amd64 /usr/local/prometheus</code></pre> 
<p>创建用户，并设定目录权限：</p> 
<pre><code>useradd -r prometheus
mkdir /usr/local/prometheus/data
chown -R prometheus.prometheus /usr/local/prometheus/data</code></pre> 
<p>创建Systemd Unitfile，保存于/usr/lib/systemd/system/prometheus.service文件中:</p> 
<pre><code>[Unit]
Description=Monitoring system and time series database
Documentation=https://prometheus.io/docs/introduction/overview/

[Service]
Restart=always
User=prometheus
EnvironmentFile=-/etc/default/prometheus
ExecStart=/usr/local/prometheus/prometheus 
            --config.file=/usr/local/prometheus/prometheus.yml 
            --storage.tsdb.path=/usr/local/prometheus/data 
            --web.console.libraries=/usr/share/prometheus/console_libraries 
            --web.enable-lifecycle 
            $ARGS
ExecReload=/bin/kill -HUP $MAINPID
TimeoutStopSec=20s
SendSIGKILL=no
LimitNOFILE=8192

[Install]
WantedBy=multi-user.target
</code></pre> 
<p>如有必要，可创建环境配置文件/etc/default/prometheus，通过变量ARGS为prometheus指定启动参数</p> 
<p>启动服务：</p> 
<pre><code>systemctl daemon-reload
systemctl start prometheus.service
systemctl enable prometheus.service</code></pre> 
<p>验证监听的端口，并测试访问其暴露的指标</p> 
<pre><code>ss -tnlp | grep '9090'
curl localhost:9090/metrics</code></pre> 
<p>修改配置后的重载命令：</p> 
<pre><code>curl -XPOST http://localhost:9090/-/reload</code></pre> 
<p>基于文件的服务发现</p> 
<pre><code>[root@rocky8 prometheus]#mkdir targets 
[root@rocky8 targets]#vim nodes-linux.yml    #以yml结尾就行，后续容易在Prometheus里面指定
- targets:     #可以名字
  - 10.0.0.18:9100     
  - 10.0.0.8:9100
  labels:   #标签。可以多个
    app: nede-exporter



[root@rocky8 prometheus]#vim prometheus.yml
  - job_name: "node_exporter"
    metrics_path: '/metrics'  #默认定义的输出路径
    scheme: 'http'
    file_sd_configs:          #基于文件发现
      - files:
          - targets/nodes-*.yml   #可以通配符
        refresh_interval: 2m
curl -XPOST http://localhost:9090/-/reload   定义完成之后可以重启
 </code></pre> 
<h3 id="%C2%A0%E6%A3%80%E6%9F%A5%E8%AF%AD%E6%B3%95%E6%98%AF%E5%90%A6%E8%A7%84%E8%8C%83"> 检查语法是否规范</h3> 
<p>[root@rocky8 prometheus]#./promtool check config ./prometheus.yml   可以检查语法是否规范</p> 
<h2 id="%E9%83%A8%E7%BD%B2node-exporter">部署node-exporter</h2> 
<p>提示：每个主机节点上均应该部署node-exporter；</p> 
<p>下载程序包，以1.4.0版本为例：</p> 
<pre><code>curl -LO https://github.com/prometheus/node_exporter/releases/download/v1.4.0/node_exporter-1.4.0.linux-amd64.tar.gz</code></pre> 
<p>展开程序包：</p> 
<pre><code>tar xf node_exporter-1.4.0.linux-amd64.tar.gz -C /usr/local/
ln -sv /usr/local/node_exporter-1.4.0.linux-amd64 /usr/local/node_exporter</code></pre> 
<p>创建用户，若prometheus用户已经存在，可略过该步骤：</p> 
<pre><code>useradd -r prometheus</code></pre> 
<p>创建Systemd Unitfile，保存于/usr/lib/systemd/system/node_exporter.service文件中:</p> 
<pre><code>[Unit]
Description=node_exporter
Documentation=https://prometheus.io/docs/introduction/overview/
After=network.target

[Service]
Type=simple
User=prometheus
ExecStart=/usr/local/node_exporter/node_exporter 
  --collector.ntp 
  --collector.mountstats 
  --collector.systemd 
  --collector.ethtool 
  --collector.tcpstat
ExecReload=/bin/kill -HUP $MAINPID
TimeoutStopSec=20s
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre> 
<p>启动服务：</p> 
<pre><code>systemctl daemon-reload
systemctl start node_exporter.service
systemctl enable node_exporter.service</code></pre> 
<p>验证监听的端口，并测试访问其暴露的指标</p> 
<pre><code>ss -tnlp | grep '9100'
curl localhost:9100/metrics</code></pre> 
<h2 id="%E9%83%A8%E7%BD%B2Consul">部署Consul</h2> 
<p>组件功能：用于为Prometheus提供基于Consul进行服务发现的测试环境。</p> 
<p id="%E9%83%A8%E7%BD%B2">部署</p> 
<p>下载Consul，以1.14.1版本为例：</p> 
<pre><code>curl -LO https://releases.hashicorp.com/consul/1.14.1/consul_1.14.1_linux_amd64.zip</code></pre> 
<p>展开程序包：</p> 
<pre><code>mkdir -p /usr/local/consul/{data,config}  #给consul 保存配置文件和数据的目录
unzip consul_1.14.1_linux_amd64.zip -d /usr/local/consul</code></pre> 
<p>创建用户，若consul用户已经存在，可略过该步骤：</p> 
<pre><code>useradd -r consul
chown consul.consul /usr/local/consul/{data,config}</code></pre> 
<p>创建Systemd Unitfile，保存于/usr/lib/systemd/system/consul.service文件中:</p> 
<pre><code>[Unit]
Description="HashiCorp Consul - A service mesh solution"
Documentation=https://www.consul.io/
Requires=network-online.target
After=network-online.target

[Service]
EnvironmentFile=-/etc/consul.d/consul.env
User=consul
Group=consul
ExecStart=/usr/local/consul/consul agent -dev -bootstrap 
            -config-dir /usr/local/consul/config 
            -data-dir /usr/local/consul/data 
            -ui 
            -log-level INFO 
            -bind 127.0.0.1 
            -client 0.0.0.0
ExecReload=/bin/kill --signal HUP $MAINPID
KillMode=process
KillSignal=SIGTERM
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
</code></pre> 
<p>启动服务：</p> 
<pre><code>systemctl daemon-reload
systemctl start consul.service
systemctl enable consul.service  #开机自动</code></pre> 
<h2 id="%E7%9B%B4%E6%8E%A5%E8%AF%B7%E6%B1%82API%E8%BF%9B%E8%A1%8C%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C">直接请求API进行服务注册</h2> 
<p>列出已经注册的服务：</p> 
<pre><code class="language-vbnet">curl -XGET http://localhost:8500/v1/agent/services
</code></pre> 
<p>获取某个特定服务的配置信息：</p> 
<pre><code>curl -XGET http://localhost:8500/v1/agent/service/&lt;SERVICE_ID&gt;
</code></pre> 
<p>例如，下面定义了一个要注册的tomcat服务示例，它保存于tomcat.json文件中</p> 
<pre><code>{
      "id": "tomcat",
      "name": "tomcat",
      "address": "tomcat",
      "port": 8080,
      "tags": ["tomcat"],
      "checks": [{
        "http": "http://tomcat:8080/metrics",
        "interval": "5s"
      }]
}
</code></pre> 
<p>我们可以使用类似如下命令完成服务注册。</p> 
<pre><code class="language-vbnet">curl -XPUT --data @tomcat.json http://localhost:8500/v1/agent/service/register
</code></pre> 
<p>注销某个服务：</p> 
<pre><code>curl -XPUT http://localhost:8500/v1/agent/service/deregister/&lt;SERVICE_ID&gt;
</code></pre> 
<h3 id="%E4%BD%BF%E7%94%A8register%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%EF%BC%88%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8%EF%BC%89%20%E5%8D%95%E4%B8%AA%E5%92%8C%E5%A4%9A%E4%B8%AA%E6%B3%A8%E5%86%8C%EF%BC%8C%E5%A4%9A%E4%B8%AA%E5%90%8E%E9%9D%A2%E5%A4%9A%E5%8A%A0%E4%BA%86s">使用register命令注册服务（建议使用） 单个和多个注册，多个后面多加了s</h3> 
<p>consul services register命令也可用于进行服务注册，只是其使用的配置格式与直接请求HTTP API有所不同。</p> 
<p>-address=XXX 指明服务器地址，不指默认本地</p> 
<p>-port=xx   指定服务的端口号</p> 
<pre><code>consul services register /path/to/pyload_file.json
</code></pre> 
<p>注册单个服务时，使用service进行定义，注册多个服务时，使用services以列表格式进行定义。下面的示例定义了单个要注册的服务。</p> 
<pre><code>{
  "service": {
      "id": "tomcat",
      "name": "tomcat",
      "address": "tomcat",
      "port": 8080,
      "tags": ["tomcat"],
      "checks": [{
        "http": "http://tomcat:8080/metrics",
        "interval": "5s"
      }]
  }
}
</code></pre> 
<p>下面的示例，以多个的服务的格式给出了定义。</p> 
<pre><code>{
  "services": [{
      "id": "tomcat",
      "name": "tomcat",
      "address": "tomcat",
      "port": 8080,
      "tags": ["tomcat"],
      "checks": [{
        "http": "http://tomcat:8080/metrics",
        "interval": "5s"
      }]
    }
  ]
}
</code></pre> 
<p>注销服务，也可以使用consul services deregister命令进行。</p> 
<pre><code> consul services deregister -id &lt;SERVICE_ID&gt;</code></pre> 
<h2 id="%C2%A0%20%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9Aconsul%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">在Prometheus上做consul的服务发现</h2> 
<p>在consul上可以正常查到相关节点后，在Prometheus.yml上增加相关配置</p> 
<pre><code class="language-vbnet">  - job_name: "node_exporter"
    consul_sd_configs:
       - server: '10.0.0.8:8500'
         tags:
           - "node_exporter"     #只有consul里带有该标签的服务才会被 Prometheus 发现和监控
         refresh_interval: 1m

[root@rocky8 prometheus]#curl -XPOST localhost:9090/-/reload  #重启
</code></pre> 
<p><img alt="" height="462" src="https://images2.imgbox.com/31/47/LoI292Yl_o.png" width="1200"></p> 
<p></p> 
<p></p> 
<h2 id="%E9%83%A8%E7%BD%B2Consul%20Exporter">部署Consul Exporter</h2> 
<p>提示：仅需要为每个Consul实例部署consul-exporter，它负责将Consul的状态信息转为Prometheus兼容的指标格式并予以暴露。</p> 
<p>下载程序包，以0.8.0版本为例：</p> 
<pre><code class="language-vbnet">curl -LO https://github.com/prometheus/consul_exporter/releases/download/v0.8.0/consul_exporter-0.8.0.linux-amd64.tar.gz</code></pre> 
<p>展开程序包：</p> 
<pre><code class="language-vbnet">tar xf consul_exporter-0.8.0.linux-amd64.tar.gz -C /usr/local/
ln -sv /usr/local/consul_exporter-0.8.0.linux-amd64 /usr/local/consul_exporter</code></pre> 
<p>创建用户，若consul用户已经存在，可略过该步骤：</p> 
<pre><code class="language-vbnet">useradd -r consul</code></pre> 
<p>创建Systemd Unitfile，保存于/usr/lib/systemd/system/consul_exporter.service文件中:</p> 
<pre><code>[Unit]
Description=consul_exporter
Documentation=https://prometheus.io/docs/introduction/overview/
After=network.target

[Service]
Type=simple
User=consul
EnvironmentFile=-/etc/default/consul_exporter
# 具体使用时，若consul_exporter与consul server不在同一主机时，consul server要指向实际的地址；
ExecStart=/usr/local/consul_exporter/consul_exporter 
            --consul.server="http://localhost:8500" 
            --web.listen-address=":9107" 
            --web.telemetry-path="/metrics" 
            --log.level=info 
            $ARGS
ExecReload=/bin/kill -HUP $MAINPID
TimeoutStopSec=20s
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre> 
<p>启动服务：</p> 
<pre><code class="language-vbnet">systemctl daemon-reload
systemctl start consul_exporter.service
systemctl enable consul_exporter.service</code></pre> 
<h3 id="%C2%A0%C2%A0%20%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9AConsul%20Exporter%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%20%E5%9B%A0%E4%B8%BAPrometheus%E6%98%AF%E5%AF%B9Consul%E5%81%9A%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%89%80%E4%BB%A5">在Prometheus上做Consul Exporter的服务发现 因为Prometheus是对Consul做的服务发现所以</h3> 
<p>Consul Exporter用于监控Consul万一consul崩了呢</p> 
<pre><code class="language-vbnet">[root@rocky8 services]#cat consul-exporter.json 
{
      "id": "consul_exporter",
      "name": "consul_exporter.magedu.com",
      "address": "prometheus.magedu.com",
      "port": 9107,
      "tags": ["consul_exporter"],
      "checks": [{
        "http":"http://prometheus.magedu.com：9107/metrics",
        "interval": "5s"
      }]
}


[root@rocky8 prometheus]#vim prometheus.yml
  - job_name: "consul_exporter"
    consul_sd_configs:
       - server: '10.0.0.8'
         tags:
           - "consul_exporter"
         refresh_interval: 1m
</code></pre> 
<p><strong> 加入服务注册</strong></p> 
<pre><code class="language-vbnet">curl -XPUT --data @consul-exporter.json http://localhost:8500/v1/agent/service/register

curl -XGET http://localhost:8500/v1/agent/services   查看
</code></pre> 
<h2 id="%E9%83%A8%E7%BD%B2MySQL%20Exporter">部署MySQL Exporter</h2> 
<p>提示：仅需要为每个MySQL Server实例部署mysql-exporter，它负责将MySQL Server的状态信息转为Prometheus兼容的指标格式并予以暴露。</p> 
<p>下载程序包，以0.14.0版本为例：</p> 
<pre><code class="language-vbnet">curl -LO https://github.com/prometheus/mysqld_exporter/releases/download/v0.14.0/mysqld_exporter-0.14.0.linux-amd64.tar.gz</code></pre> 
<p>展开程序包：</p> 
<pre><code class="language-vbnet">tar xf mysqld_exporter-0.14.0.linux-amd64.tar.gz -C /usr/local/
ln -sv /usr/local/mysqld_exporter-0.14.0.linux-amd64 /usr/local/mysqld_exporter</code></pre> 
<p>创建用户，或mysql用户已经存在，可略过该步骤：</p> 
<pre><code class="language-vbnet">useradd -r mysql</code></pre> 
<p>创建Systemd Unitfile，保存于/usr/lib/systemd/system/mysqld_exporter.service文件中:</p> 
<pre><code>[Unit]
Description=consul_exporter
Documentation=https://prometheus.io/docs/introduction/overview/
After=network.target

[Service]
Type=simple
User=mysql
EnvironmentFile=-/etc/default/mysqld_exporter
# 具体使用时，若mysql_exporter与mysql server不在同一主机时，mysql server要指向实际的地址；
# mysql_exporter连接mysql server使用的用户名和密码均为exporter，该用户要获得正确的授权；
Environment='DATA_SOURCE_NAME=exporter:exporter@(localhost:3306)'
ExecStart=/usr/local/mysqld_exporter/mysqld_exporter 
            --web.listen-address=":9104" 
            --web.telemetry-path="/metrics" 
            --collect.info_schema.innodb_tablespaces 
            --collect.info_schema.innodb_metrics 
            --collect.global_status 
            --collect.global_variables 
            --collect.slave_status 
            --collect.engine_innodb_status 
            $ARGS
ExecReload=/bin/kill -HUP $MAINPID
TimeoutStopSec=20s
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre> 
<p>在mysqld server上添加用户，并授权其能够加载mysql的信息并转换为指标输出。需要注意的是用户账号授权时使用的主机范围。</p> 
<pre><code>mysql&gt; CREATE USER 'exporter'@'localhost' IDENTIFIED BY 'exporter';
mysql&gt; GRANT PROCESS, REPLICATION CLIENT ON *.* TO 'exporter'@'localhost';
mysql&gt; GRANT SELECT ON performance_schema.* TO 'exporter'@'localhost';
mysql&gt; FLUSH PRIVILEGES;
</code></pre> 
<p>启动服务：</p> 
<pre><code class="language-vbnet">systemctl daemon-reload
systemctl start mysqld_exporter.service
systemctl enable mysqld_exporter.service</code></pre> 
<h3 id="%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9AConsul%20Exporter%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">在Prometheus上做Consul Exporter的服务发现</h3> 
<pre><code class="language-vbnet">[root@rocky8 services]#cat mysqld_exporter.json 
{
      "id": "mysqld_exporter",
      "name": "mysqld_exporter.magedu.com",
      "address": "prometheus.magedu.com",
      "port": 9107,
      "tags": ["mysqld_exporter"],
      "checks": [{
        "http":"http://prometheus.magedu.com/metrics",
        "interval": "5s"
      }]
}

[root@rocky8 prometheus]#vim prometheus.yml
  - job_name: "mysqld_exporter"
    consul_sd_configs:
       - server: "10.0.0.8"
         tags:
           - "mysqld_exporter"
         refresh_interval: 1m
</code></pre> 
<p><strong> 加入服务注册</strong></p> 
<pre><code class="language-vbnet">curl -XPUT --data @mysqld_exporter.json http://localhost:8500/v1/agent/service/register

curl -XGET http://localhost:8500/v1/agent/services   查看
</code></pre> 
<p><img alt="" height="397" src="https://images2.imgbox.com/9b/51/BXHgouSO_o.png" width="439"></p> 
<h2 id="%E9%83%A8%E7%BD%B2nginx%20Exporter">部署nginx Exporter</h2> 
<p>基于镜像</p> 
<pre><code>
version: '3.6'
  
networks:
  monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.107.0/24

services:
  nginx:
    image: nginx:1.22.1
    volumes:   
      - ./nginx/stub_status-server.conf:/etc/nginx/conf.d/stub_status-server.conf:ro   #定义·文件夹
    networks:
      - monitoring
    expose:
      - 8080
      - 80
    ports:
      - 80:80

  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:0.11
    command:
      - '-nginx.scrape-uri=http://nginx:8080/stub_status'
    networks:
      - monitoring
    ports:
      - '9113:9113'
    depends_on:
      - nginx
~              </code></pre> 
<pre><code>[root@rocky8 nginx-and-exporter]#ls
docker-compose.yml  nginx
[root@rocky8 nginx-and-exporter]#vim docker-compose.yml 
[root@rocky8 nginx-and-exporter]#tree nginx/
nginx/
└── stub_status-server.conf

0 directories, 1 file


[root@rocky8 nginx-and-exporter]#cat nginx/stub_status-server.conf 
server {
    listen 8080;
    server_name localhost;
文件·
    location /stub_status {
        stub_status;

        access_log off;
        #allow 172.31.0.0/16;
        #deny all;
    }
}
</code></pre> 
<p>启动</p> 
<blockquote> 
 <p>[root@rocky8 nginx-and-exporter]#docker-compose up</p> 
 <p></p> 
 <p>/usr/local/lib/python3.6/site-packages/paramiko/transport.py:32: CryptographyDeprecationWarning: Python 3.6 is no longer supported by the Python core </p> 
</blockquote> 
<h3 id="%C2%A0%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9AConsul%20Exporter%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"> 在Prometheus上做Consul Exporter的服务发现</h3> 
<p>[root@rocky8 services]#/usr/local/consul/consul services register nginx-exporter.json  </p> 
<p>curl -XGET http://localhost:8500/v1/agent/services   查看</p> 
<pre><code class="language-vbnet">[root@rocky8 services]#cat nginx-exporter.json 
{
  "service":{
      "id": "nginx_exporter",
      "name": "nginx_exporter.magedu.com",
      "address": "server02.magedu.com",
      "port": 9113,
      "tags": ["nginx_exporter"],
      "checks": [{
        "http": "http://server02.magedu.com:9113/metrics",
        "interval": "5s"
      }]
 }
}

[root@rocky8 services]#cat prometheus.yml
  - job_name: "nginx_exporter"
    consul_sd_configs:
       - server: "10.0.0.8:8500"
         tags:
           - "nginx_exporter"
         refresh_interval: 1m
</code></pre> 
<p> [root@rocky8 prometheus]#curl -XPOST localhost:9090/-/reload  刷新在Prometheus上面查看</p> 
<p><img alt="" height="937" src="https://images2.imgbox.com/23/97/4WXi6Ket_o.png" width="1200"></p> 
<h2 id="%E5%9C%A8Prometheus%E4%B8%8A%E5%81%9Atomcat">在Prometheus上做tomcat</h2> 
<pre><code>[root@rocky8 tomcat-and-metrics]#ls
docker-compose.yml  tomcat
[root@rocky8 tomcat-and-metrics]#cat docker-compose.yml    #安装
version: '3.6'

volumes:
    tomcat_webapps: {}

networks:
  monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.130.0/24

services:
  tomcat:
    #image: tomcat:jdk11
    build:
      context: tomcat
      dockerfile: Dockerfile 
    hostname: tomcat.magedu.com
    expose:
      - 8080
    ports:
      - 8080:8080
    volumes:
      - tomcat_webapps:/usr/local/tomcat/webapps
      - ./tomcat/tomcat-users.xml:/usr/local/tomcat/conf/tomcat-users.xml
    networks:
      - monitoring
    environment:
      TZ: Asia/Shanghai
[root@rocky8 tomcat-and-metrics]#cd tomcat/

[root@rocky8 tomcat]#ls
context.xml  Dockerfile  sources.list  tomcat-users.xml

[root@rocky8 tomcat]#cat tomcat-users.xml     #tomcat账户配置
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--&gt;
&lt;tomcat-users xmlns="http://tomcat.apache.org/xml"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://tomcat.apache.org/xml tomcat-users.xsd"
              version="1.0"&gt;
&lt;!--
  By default, no user is included in the "manager-gui" role required
  to operate the "/manager/html" web application.  If you wish to use this app,
  you must define such a user - the username and password are arbitrary.

  Built-in Tomcat manager roles:
    - manager-gui    - allows access to the HTML GUI and the status pages
    - manager-script - allows access to the HTTP API and the status pages
    - manager-jmx    - allows access to the JMX proxy and the status pages
    - manager-status - allows access to the status pages only

  The users below are wrapped in a comment and are therefore ignored. If you
  wish to configure one or more of these users for use with the manager web
  application, do not forget to remove the &lt;!.. ..&gt; that surrounds them. You
  will also need to set the passwords to something appropriate.
--&gt;
&lt;!--
  &lt;user username="admin" password="&lt;must-be-changed&gt;" roles="manager-gui"/&gt;
  &lt;user username="robot" password="&lt;must-be-changed&gt;" roles="manager-script"/&gt;
--&gt;
&lt;!--
  The sample user and role entries below are intended for use with the
  examples web application. They are wrapped in a comment and thus are ignored
  when reading this file. If you wish to configure these users for use with the
  examples web application, do not forget to remove the &lt;!.. ..&gt; that surrounds
  them. You will also need to set the passwords to something appropriate.
--&gt;
&lt;!--
  &lt;role rolename="tomcat"/&gt;
  &lt;role rolename="role1"/&gt;
  &lt;user username="tomcat" password="&lt;must-be-changed&gt;" roles="tomcat"/&gt;
  &lt;user username="both" password="&lt;must-be-changed&gt;" roles="tomcat,role1"/&gt;
  &lt;user username="role1" password="&lt;must-be-changed&gt;" roles="role1"/&gt;
--&gt;
  &lt;role rolename="manager-gui"/&gt;
  &lt;role rolename="manager-script"/&gt;
  &lt;user username="tomcat" password="magedu.com" roles="manager-gui,manager-script"/&gt;
&lt;/tomcat-users&gt;

</code></pre> 
<h3 id="tomcat%E5%85%81%E8%AE%B8%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95">tomcat允许远程登录</h3> 
<pre><code>[root@rocky8 tomcat]#cat context.xml   允许远程登录
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--&gt;
&lt;Context antiResourceLocking="false" privileged="true" &gt;
  &lt;CookieProcessor className="org.apache.tomcat.util.http.Rfc6265CookieProcessor"
                   sameSiteCookies="strict" /&gt;
&lt;!--
  &lt;Valve className="org.apache.catalina.valves.RemoteAddrValve"
         allow="127.d+.d+.d+|::1|0:0:0:0:0:0:0:1" /&gt;
--&gt;
  &lt;Manager sessionAttributeValueClassNameFilter="java.lang.(?:Boolean|Integer|Long|Number|String)|org.apache.catalina.filters.CsrfPreventionFilter$LruCache(?:$1)?|java.util.(?:Linked)?HashMap"/&gt;
&lt;/Context&gt;
</code></pre> 
<p> tomcat的镜像仓库地址</p> 
<pre><code>[root@rocky8 tomcat]#cat sources.list 
deb https://repo.huaweicloud.com/debian/ bullseye main non-free contrib
deb-src https://repo.huaweicloud.com/debian/ bullseye main non-free contrib
deb https://repo.huaweicloud.com/debian-security/ bullseye-security main
deb-src https://repo.huaweicloud.com/debian-security/ bullseye-security main
deb https://repo.huaweicloud.com/debian/ bullseye-updates main non-free contrib
deb-src https://repo.huaweicloud.com/debian/ bullseye-updates main non-free contrib
deb https://repo.huaweicloud.com/debian/ bullseye-backports main non-free contrib
deb-src https://repo.huaweicloud.com/debian/ bullseye-backports main non-free contrib
</code></pre> 
<h4 id="%C2%A0tomcat%E4%B8%8B%E8%BD%BD%E5%8F%8A%E6%89%A9%E5%85%85%E6%94%AF%E6%8C%81%E7%9B%B8%E5%BA%94%E7%9A%84%E5%8A%9F%E8%83%BD"> tomcat下载及扩充支持相应的功能</h4> 
<pre><code>[root@rocky8 tomcat]#cat Dockerfile 
FROM tomcat:9.0-jdk17-openjdk-slim

ADD ./sources.list /etc/apt/sources.list

ENV TOMCAT_SIMPLECLIENT_VERSION=0.12.0
ENV TOMCAT_EXPORTER_VERSION=0.0.15

RUN apt-get update &amp;&amp; apt-get install -y curl &amp;&amp; 
    curl -v --fail --location https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient/${TOMCAT_SIMPLECLIENT_VERSION}/simpleclient-${TOMCAT_SIMPLECLIENT_VERSION}.jar --output /usr/local/tomcat/lib/simpleclient-${TOMCAT_SIMPLECLIENT_VERSION}.jar &amp;&amp; 
    curl -v --fail --location https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_common/${TOMCAT_SIMPLECLIENT_VERSION}/simpleclient_common-${TOMCAT_SIMPLECLIENT_VERSION}.jar --output /usr/local/tomcat/lib/simpleclient_common-${TOMCAT_SIMPLECLIENT_VERSION}.jar &amp;&amp; 
    curl -v --fail --location https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_hotspot/${TOMCAT_SIMPLECLIENT_VERSION}/simpleclient_hotspot-${TOMCAT_SIMPLECLIENT_VERSION}.jar --output /usr/local/tomcat/lib/simpleclient_hotspot-${TOMCAT_SIMPLECLIENT_VERSION}.jar &amp;&amp; 
    curl -v --fail --location https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_servlet/${TOMCAT_SIMPLECLIENT_VERSION}/simpleclient_servlet-${TOMCAT_SIMPLECLIENT_VERSION}.jar --output /usr/local/tomcat/lib/simpleclient_servlet-${TOMCAT_SIMPLECLIENT_VERSION}.jar &amp;&amp; 
    curl -v --fail --location https://search.maven.org/remotecontent?filepath=io/prometheus/simpleclient_servlet_common/${TOMCAT_SIMPLECLIENT_VERSION}/simpleclient_servlet_common-${TOMCAT_SIMPLECLIENT_VERSION}.jar --output /usr/local/tomcat/lib/simpleclient_servlet_common-${TOMCAT_SIMPLECLIENT_VERSION}.jar &amp;&amp; 
    curl -v --fail --location https://search.maven.org/remotecontent?filepath=nl/nlighten/tomcat_exporter_client/${TOMCAT_EXPORTER_VERSION}/tomcat_exporter_client-${TOMCAT_EXPORTER_VERSION}.jar --output /usr/local/tomcat/lib/tomcat_exporter_client-${TOMCAT_EXPORTER_VERSION}.jar &amp;&amp; 
    curl -v --fail --location https://search.maven.org/remotecontent?filepath=nl/nlighten/tomcat_exporter_servlet/${TOMCAT_EXPORTER_VERSION}/tomcat_exporter_servlet-${TOMCAT_EXPORTER_VERSION}.war --output /usr/local/tomcat/webapps/metrics.war

RUN mv /usr/local/tomcat/webapps.dist/* /usr/local/tomcat/webapps/
ADD ./context.xml /usr/local/tomcat/webapps/manager/META-INF/context.xml
</code></pre> 
<h4 id="%C2%A0%E6%B3%A8%E5%86%8C%E5%88%B0consul%E4%B8%8A%E9%9D%A2%E5%8E%BB%E5%8F%8APrometheus%E4%B8%8A%E5%81%9A%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"> 注册到consul上面去及Prometheus上做服务发现</h4> 
<pre><code>[root@rocky8 services]#/usr/local/consul/consul services register tomcat.json 
Node name "rocky8.wang.org" will not be discoverable via DNS due to invalid characters. Valid characters include all alpha-numerics and dashes.
Registered service: tomcat.magedu.com

[root@rocky8 services]#cat tomcat.json 
{
  "service":{
      "id": "tomcat",
      "name": "tomcat.magedu.com",
      "address": "server02.magedu.com",
      "port": 8080,
      "tags": ["tomcat"],
      "checks": [{
        "http": "http://server02.magedu.com:8080/metrics",
        "interval": "5s"
      }]
 }
}



[root@rocky8 prometheus]#cat prometheus.yml
  - job_name: "tomcat"
    consul_sd_configs:
       - server: "10.0.0.8:8500"
         tags:
           - "tomcat"
         refresh_interval: 1m

[root@rocky8 prometheus]#curl -XPOST localhost:9090/-/reload   重新加载</code></pre> 
<h2 id="%E7%BD%B2Blackbox%20Exporter%C2%A0%E5%8F%96%E5%86%B3%E4%BA%8E%E9%BB%91%E7%9B%92%E7%9B%91%E6%8E%A7">署Blackbox Exporter 取决于黑盒监控</h2> 
<p>提示：仅需要部署的Blackbox Exporter实例数据，取决于黑盒监控的任务量及节点的可用资源。</p> 
<pre><code>[root@rocky8 blackbox-exporter]#cat configs/blackbox.yml 
modules:
  # https://github.com/prometheus/blackbox_exporter/blob/master/example.yml
  http_2xx:
    prober: http
    timeout: 5s
    http:
      valid_http_versions: 
      - "HTTP/1.1"
      - "HTTP/2"
      valid_status_codes: []  # Defaults to 2xx
      enable_http2: false
      method: GET
      no_follow_redirects: false
      # fail_if_ssl为true时，表示如果站点启用了SSL则探针失败，反之成功; 
      # fail_if_not_ssl刚好相反;
      fail_if_ssl: false
      fail_if_not_ssl: false
      #  fail_if_body_matches_regexp, fail_if_body_not_matches_regexp, fail_if_header_matches, fail_if_header_not_matches
      #  可以定义一组正则表达式，用于验证HTTP返回内容是否符合或者不符合正则表达式的内容
      fail_if_body_matches_regexp:
        - "Could not connect to database"
      tls_config:
        insecure_skip_verify: false
      preferred_ip_protocol: "ip4" # defaults to "ip6"
  http_with_proxy:
    prober: http
    http:
      proxy_url: "http://127.0.0.1:3128"
      skip_resolve_phase_with_proxy: true
  http_post_2xx:
    prober: http
    timeout: 5s
    http:
      method: POST
      headers:
        Content-Type: application/json
      body: '{}'
  http_basic_auth_example:
    prober: http
    timeout: 5s
    http:
      method: POST
      headers:
        Host: "login.example.com"
      basic_auth:
        username: "username"
        password: "mysecret"
  http_custom_ca_example:
    prober: http
    http:
      method: GET
      tls_config:
        ca_file: "/certs/my_cert.crt"
  http_gzip:
    prober: http
    http:
      method: GET
      compression: gzip
  http_gzip_with_accept_encoding:
    prober: http
    http:
      method: GET
      compression: gzip
      headers:
        Accept-Encoding: gzip
  tls_connect:
    prober: tcp
    timeout: 5s
    tcp:
      tls: true
  dns_udp_example:
    prober: dns
    timeout: 5s
    dns:
      query_name: "www.prometheus.io"
      query_type: "A"
      valid_rcodes:
        - NOERROR
      validate_answer_rrs:
        fail_if_matches_regexp:
          - ".*127.0.0.1"
        fail_if_all_match_regexp:
          - ".*127.0.0.1"
        fail_if_not_matches_regexp:
          - "www.magedu.com.t300tINtAt127.0.0.1"
        fail_if_none_matches_regexp:
          - "127.0.0.1"
      validate_authority_rrs:
        fail_if_matches_regexp:
          - ".*127.0.0.1"
      validate_additional_rrs:
        fail_if_matches_regexp:
          - ".*127.0.0.1"
[root@rocky8 blackbox-exporter]#ls
configs  docker-compose.yml
[root@rocky8 blackbox-exporter]#cat docker-compose.yml 
version: '3.6'

networks:
  monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.136.0/24

services:
  blackbox_exporter:
    image: prom/blackbox-exporter:v0.24.0
    volumes:
      - ./configs/:/etc/blackboxexporter/
    command:
      - '--config.file=/etc/blackboxexporter/blackbox.yml'
    networks:
      - monitoring
    ports:
      - 9115:9115
</code></pre> 
<h4 id="%E5%9C%A8Prometheus%E9%87%8C%E9%9D%A2%E5%81%9A%E9%BB%91%E6%B2%B3%E5%8F%91%E7%8E%B0%C2%A0">在Prometheus里面做黑河发现 </h4> 
<pre><code>[root@rocky8 prometheus]#cat prometheus.yml

  # Blackbox Exporter
  - job_name: 'blackbox'
    metrics_path: /probe
    params:
      module: [http_2xx]  # Look for a HTTP 200 response.
    static_configs:
    - targets:
      - www.magedu.com
      - www.google.com
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: "10.0.0.18:9115"  # Blackbox exporter.
      - target_label: region
        replacement: "remote"


[root@rocky8 prometheus]#curl -XPOST localhost:9090/-/reload  #加载

 </code></pre> 
<p><img alt="" height="480" src="https://images2.imgbox.com/20/56/0GXOWi61_o.png" width="1200"></p> 
<p></p>
                </div>

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>