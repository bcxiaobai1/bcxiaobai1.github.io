<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>【从零开始游戏开发】Unity 前后端网络通信该如何搭建？注释解答 | 全面总结 |建议收藏 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【从零开始游戏开发】Unity 前后端网络通信该如何搭建？注释解答 | 全面总结 |建议收藏</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <blockquote> 
 <p>你知道的越多，你不知道的越多 ??????<br> 点赞再看，养成习惯，别忘了一键三连哦 ???<br> 文章持续更新中 ???</p> 
</blockquote> 
<hr> 
<hr> 
<h2>
<a id="_8"></a>通信该如何搭建？</h2> 
<h3>
<a id="_10"></a>服务器端：</h3> 
<h4>
<a id="1_Program_12"></a>1. 入口类（Program）：</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. 构造网络服务类： </span>
    <span class="token class-name">NetServer</span> net <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2. 调用初始化方法： </span>
    net<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3. 调用开始方法：</span>
    net<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4. 死循环处理指令的输入</span>
    <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//5. 当循环跳出关闭服务器 调用停止服务方法</span>
    net<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">bool</span></span> run <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1. 处理输入的指令 输入 Exit 指令会关闭服务器</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="2_Net_Server_43"></a>2. 网络服务器类（Net Server）：</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. 绑定一个IP与端口号：</span>
    <span class="token class-name">IPEndPoint</span> ipPoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPEndPoint</span><span class="token punctuation">(</span>IP<span class="token punctuation">,</span> Port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2. 构造一个监听类：</span>
    ServerListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TcpSocketListener</span><span class="token punctuation">(</span>ipPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3. 给监听类绑定一个Socket连接事件：</span>
    ServerListener<span class="token punctuation">.</span>SocketConnected <span class="token operator">+=</span> OnSocketConnected<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. 调用监听类开始方法：</span>
    Log<span class="token punctuation">.</span><span class="token function">Warning</span><span class="token punctuation">(</span><span class="token string">"Starting Listener..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ServerListener<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//2. 调用消息分发器类开始函数</span>
    MessageDistributer<span class="token operator">&lt;</span>NetConnection<span class="token operator">&lt;</span>NetSession<span class="token operator">&gt;&gt;</span><span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Log<span class="token punctuation">.</span><span class="token function">Warning</span><span class="token punctuation">(</span><span class="token string">"NetService Started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. 调用监听类停止方法</span>
    ServerListener<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//监听类监听到了对象连接，最后执行此方法</span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnSocketConnected</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">Socket</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. 获取连接的IP端地址 </span>
    <span class="token class-name">IPEndPoint</span> clientIP <span class="token operator">=</span> <span class="token punctuation">(</span>IPEndPoint<span class="token punctuation">)</span>e<span class="token punctuation">.</span>RemoteEndPoint<span class="token punctuation">;</span>
    <span class="token comment">//2. 构造一个 连接模型</span>
    <span class="token class-name">SocketAsyncEventArgs</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SocketAsyncEventArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3. 构造一个 NetSession</span>
    <span class="token class-name">NetSession</span> session <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4. 构造一个 连接类 NetConnection&lt;T&gt;</span>
     <span class="token class-name">NetConnection<span class="token punctuation">&lt;</span>NetSession<span class="token punctuation">&gt;</span></span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetConnection<span class="token punctuation">&lt;</span>NetSession<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//传递给连接类的接收数据事件</span>
<span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DataReceived</span><span class="token punctuation">(</span><span class="token class-name">NetConnection<span class="token punctuation">&lt;</span>NetSession<span class="token punctuation">&gt;</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">DataEventArgs</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//打印一条信息</span>
    Log<span class="token punctuation">.</span><span class="token function">WarningFormat</span><span class="token punctuation">(</span><span class="token string">"Client[{0}] DataReceived Len:{1}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>RemoteEndPoint<span class="token punctuation">,</span> e<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1. 处理接收到的数据</span>
    <span class="token keyword">lock</span> <span class="token punctuation">(</span>sender<span class="token punctuation">.</span>packageHandler<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 调用消息处理类的 接收数据方法</span>
        sender<span class="token punctuation">.</span>packageHandler<span class="token punctuation">.</span><span class="token function">ReceiveData</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//传递给连接类的断开连接事件</span>
<span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Disconnected</span><span class="token punctuation">(</span><span class="token class-name">NetConnection<span class="token punctuation">&lt;</span>NetSession<span class="token punctuation">&gt;</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">SocketAsyncEventArgs</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//打印一条信息</span>
    Log<span class="token punctuation">.</span><span class="token function">WarningFormat</span><span class="token punctuation">(</span><span class="token string">"Client[{0}] Disconnected"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>RemoteEndPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="3_TCP_Socket_Listener_111"></a>3. 监听类（TCP Socket Listener）</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">private</span> <span class="token class-name">Socket</span> m_ListenSocket<span class="token punctuation">;</span>		<span class="token comment">//监听Socket</span>
<span class="token keyword">private</span> <span class="token class-name">SocketAsyncEventArgs</span> args<span class="token punctuation">;</span>  <span class="token comment">//连接的一种模型</span>

<span class="token comment">//构造函数</span>
<span class="token keyword">public</span> <span class="token function">TcpSocketListener</span><span class="token punctuation">(</span><span class="token class-name">IPEndPoint</span> endPoint<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. 实例化连接模型</span>
    args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SocketAsyncEventArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2. 加上监听事件，到监听到有对象连接会执行</span>
    args<span class="token punctuation">.</span>Completed <span class="token operator">+=</span> OnSocketAccepted<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">lock</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>	<span class="token comment">//加 Lock 是以为 此类会有多个客户端同时发起连接 </span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1. 初始化Socket 绑定终端 然后 开始监听：</span>
        m_ListenSocket<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 监听到有连接执行：</span>
        <span class="token function">BeginAccept</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>        
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">lock</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerSocket <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            retutn；
        <span class="token comment">//1. 关闭监听套接字</span>
        listenerSocket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        listenerSocket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BeginAccept</span><span class="token punctuation">(</span><span class="token class-name">SocketAsyncEventArgs</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. 制空 否则会报错 </span>
    args<span class="token punctuation">.</span>AcceptSocket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>			
    <span class="token comment">//2. 得到监听到的对象</span>
    m_ListenSocket<span class="token punctuation">.</span><span class="token function">AcceptAsync</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token comment">//监听事件</span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnSocketAccepted</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">SocketAsyncEventArgs</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. 获取或设置异步套接字操作的结果。</span>
    <span class="token class-name">SocketError</span> error <span class="token operator">=</span> e<span class="token punctuation">.</span>SocketError<span class="token punctuation">;</span> 
    <span class="token comment">//容错处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>SocketError <span class="token operator">==</span> SocketError<span class="token punctuation">.</span>OperationAborted<span class="token punctuation">)</span> 
        retutn；
    <span class="token comment">//2. 连接成功</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>SocketError <span class="token operator">==</span> SocketError<span class="token punctuation">.</span>Success<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1. 获取到连接的套接字：</span>
        <span class="token class-name">Socket</span> handler <span class="token operator">=</span> e<span class="token punctuation">.</span>AcceptSocket<span class="token punctuation">;</span>
        <span class="token comment">//2. 执行连接事件：</span>
        <span class="token function">OnSocketConnected</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">lock</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">BeginAccept</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//达到循环监听</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//连接事件</span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnSocketConnected</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> client<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. 执行连接事件： </span>
    SocketConnected<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//定义连接事件 网络服务器类初始化时 将此事件进行了赋值</span>
<span class="token keyword">public</span> <span class="token keyword">event</span> <span class="token class-name">EventHandler<span class="token punctuation">&lt;</span>Socket<span class="token punctuation">&gt;</span></span> SocketConnected<span class="token punctuation">;</span>

<span class="token comment">//析构函数 结束时</span>
<span class="token operator">~</span><span class="token function">TcpSocketListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//此类继承了 IDisposable 实现接口</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//请求公共语言运行时不要调用指定对象的终结器。手动调用了Dispose释放资源，那么析构函数就是不必要的了，这里阻止GC调用析构函数</span>
    GC<span class="token punctuation">.</span><span class="token function">SuppressFinalize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//处理结束函数 bool 参数，防止 析构函数清理资源一次 之后 Dispose 又一次清理</span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">bool</span></span> disposing<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>disposed<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>disposing<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                args<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        disposed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>       
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="4_Net_Connection__T___224"></a>4. 连接类（Net Connection &lt;泛型类 T &gt; ）</h4> 
<pre><code class="prism language-csharp"><span class="token comment">/* 1. 对此类的介绍
每当监听类监听到有对象连接，执行了对应的事件，会构造一个当前类。
当前为泛型类 泛型 T 为 NetSession 类，此类缓存了连接对象的数据。
可以说是，每个连接的客户端都 对应了一个当前类，之后当前类会为客户端所服务。
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NetConnection<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 定义 接收数据的回调 （委托）</span>
    <span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DataReceivedCallback</span><span class="token punctuation">(</span><span class="token class-name">NetConnection<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">DataEventArgs</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 定义 断开连接的回调 （委托）</span>
    <span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DisconnectedCallback</span><span class="token punctuation">(</span><span class="token class-name">NetConnection<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">SocketAsyncEventArgs</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">State</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token class-name">DataReceivedCallback</span> dataReceived<span class="token punctuation">;</span>			<span class="token comment">//接收数据委托变量</span>
        <span class="token keyword">public</span> <span class="token class-name">DisconnectedCallback</span> disconnectedCallback<span class="token punctuation">;</span>	<span class="token comment">//断开连接委托变量</span>
        <span class="token keyword">public</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 异步套接字操作</span>
    <span class="token keyword">private</span> <span class="token class-name">SocketAsyncEventArgs</span> eventArgs<span class="token punctuation">;</span>
    
    <span class="token comment">// 消息处理类对象</span>
    <span class="token keyword">public</span> <span class="token class-name">PackageHandler<span class="token punctuation">&lt;</span>NetConnection<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> packageHandler<span class="token punctuation">;</span>
    
    <span class="token comment">// 存储玩家数据类的变量</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> session<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">T</span> Session <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> session<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    
    <span class="token comment">//构造函数</span>
    <span class="token keyword">public</span> <span class="token function">NetConnection</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">,</span> <span class="token class-name">SocketAsyncEventArgs</span> args<span class="token punctuation">,</span> <span class="token class-name">DataReceivedCallback</span> dataReceived<span class="token punctuation">,</span><span class="token class-name">DisconnectedCallback</span> disconnectedCallback<span class="token punctuation">,</span> <span class="token class-name">T</span> session<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">lock</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>	<span class="token comment">// 因为类对 SocketAsyncEventArgs 此类进行操作时候 必须要加Lock 否则会出现报错</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//构造一个 消息处理器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>packageHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PackageHandler<span class="token punctuation">&lt;</span>NetConnection<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">State</span> state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">State</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//1. 持有对构造方传递过来的值</span>
                socket <span class="token operator">=</span> socket<span class="token punctuation">,</span>
                dataReceived <span class="token operator">=</span> dataReceived<span class="token punctuation">,</span>
                disconnectedCallback <span class="token operator">=</span> disconnectedCallback
            <span class="token punctuation">}</span>
            <span class="token comment">//1. 初始化</span>
            eventArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SocketAsyncEventArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2. 对 eventArgs 进行赋值</span>
            eventArgs<span class="token punctuation">.</span>AcceptSocket <span class="token operator">=</span> socket<span class="token punctuation">;</span>			<span class="token comment">//连接的Socket</span>
            eventArgs<span class="token punctuation">.</span>Completed <span class="token operator">+=</span> ReceivedCompleted<span class="token punctuation">;</span>	<span class="token comment">//添加接收数据事件</span>
            eventArgs<span class="token punctuation">.</span>UserToken <span class="token operator">=</span> state<span class="token punctuation">;</span>				<span class="token comment">//将 对象 缓存</span>
            eventArgs<span class="token punctuation">.</span><span class="token function">SetBuffer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置 接收字节缓冲区</span>
            
            <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> session<span class="token punctuation">;</span>		<span class="token comment">//将类缓存</span>
            <span class="token comment">//执行消息接收</span>
            <span class="token function">BeginReceive</span><span class="token punctuation">(</span>eventArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>	
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//接收消息方法</span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BeginReceive</span><span class="token punctuation">(</span><span class="token class-name">SocketAsyncEventArgs</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">lock</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//取得socket</span>
            <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>UserToken <span class="token keyword">as</span> <span class="token class-name">State</span><span class="token punctuation">)</span><span class="token punctuation">.</span>socket<span class="token punctuation">;</span>
            <span class="token comment">//判断socket的连接状态</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span>Connected<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//开启异步请求，接收来自连接的数据</span>
                args<span class="token punctuation">.</span>AcceptSocket<span class="token punctuation">.</span><span class="token function">ReceiveAsync</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//当接收到了数据就会执行，此类构造时，赋值的接收数据事件</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
	<span class="token comment">//接收数据事件    </span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ReceivedCompleted</span><span class="token punctuation">(</span><span class="token class-name">Object</span> sender<span class="token punctuation">,</span> <span class="token class-name">SocketAsyncEventArgs</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断接收到的字节数</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>BytesTransferred <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">CloseConnection</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Graceful disconnect</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断造成结果，是否成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>SocketError <span class="token operator">!=</span> SocketError<span class="token punctuation">.</span>Success<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">CloseConnection</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//NOT graceful disconnect</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//1. 取得 对象  【这里又是对 UserToken 的应用】</span>
        <span class="token class-name">State</span> state <span class="token operator">=</span> args<span class="token punctuation">.</span>UserToken <span class="token keyword">as</span> <span class="token class-name">State</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 构建一个接收到的字节数长度的字节数组</span>
        <span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Byte</span><span class="token punctuation">[</span>args<span class="token punctuation">.</span>BytesTransferred<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//3. 将 args 对象的字节数组内的数据 复制到 data</span>
        Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Buffer<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4. 执行接收到数据的事件</span>
        <span class="token function">OnDataReceived</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> args<span class="token punctuation">.</span>RemoteEndPoint <span class="token keyword">as</span> <span class="token class-name">IPEndPoint</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>dataReceived<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5. 达到循环接收</span>
        <span class="token function">BeginReceive</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//调用接收数据事件的方法  事件是网络服务器类 构造此类是 传递来的</span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnDataReceived</span><span class="token punctuation">(</span><span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> data<span class="token punctuation">,</span> <span class="token class-name">IPEndPoint</span> remoteEndPoint<span class="token punctuation">,</span> <span class="token class-name">DataReceivedCallback</span> callback<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DataEventArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> RemoteEndPoint <span class="token operator">=</span> remoteEndPoint<span class="token punctuation">,</span> Data <span class="token operator">=</span> data<span class="token punctuation">,</span> Offset <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> Length <span class="token operator">=</span> data<span class="token punctuation">.</span>Length  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">//断开连接的方法</span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CloseConnection</span><span class="token punctuation">(</span><span class="token class-name">SocketAsyncEventArgs</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1. 从对象中获取到 Socket的对象	【这里就体现出 UserToken 这个属性的作用，当然不止这些】</span>
        <span class="token class-name">State</span> state <span class="token operator">=</span> args<span class="token punctuation">.</span>UserToken <span class="token keyword">as</span> <span class="token class-name">State</span><span class="token punctuation">;</span>
        <span class="token class-name">Socket</span> socket <span class="token operator">=</span> state<span class="token punctuation">.</span>socket<span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            socket<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>SocketShutdown<span class="token punctuation">.</span>Both<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//禁止掉 Socket 的接收和发送</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span> <span class="token comment">// throws if client process has already closed</span>
        <span class="token comment">//2. 关闭socket</span>
        socket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//3. 去掉接收数据的事件，没有这步会出现报错</span>
        args<span class="token punctuation">.</span>Completed <span class="token operator">-=</span> ReceivedCompleted<span class="token punctuation">;</span> <span class="token comment">//MUST Remember This!</span>
        <span class="token comment">//4. 执行断开连接的事件</span>
        <span class="token function">OnDisconnected</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> state<span class="token punctuation">.</span>disconnectedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//断开连接的事件，第二个参数 在网络服务器类构造此类时传递的事件方法</span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnDisconnected</span><span class="token punctuation">(</span><span class="token class-name">SocketAsyncEventArgs</span> args<span class="token punctuation">,</span> <span class="token class-name">DisconnectedCallback</span> callback<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="5_Data_Event_ARGs_366"></a>5. 字节数组类（Data Event ARGs）</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataEventArgs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EventArgs</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IPEndPoint</span> RemoteEndPoint <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> Data <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> Offset <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Int32</span> Length <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="6_Package_Handler_382"></a>6. 消息包处理类（Package Handler）</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageHandler<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 字节数据缓冲区</span>
    <span class="token keyword">private</span> <span class="token class-name">MemoryStream</span> stream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//字节读取索引</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">int</span></span> readOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">//接收 数据方法，调用者：网络服务器类</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ReceiveData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> data<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">int</span></span> offset<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//判断缓存区加上一定长度的数据会不会超过缓存的容量</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span>Position <span class="token operator">+</span> count <span class="token operator">&gt;</span> stream<span class="token punctuation">.</span>Capacity<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"PackageHandler write buffer overflow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//1. 将数据写入到 缓冲区</span>
        stream<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 解析消息包方法</span>
        <span class="token function">ParsePackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//数据包解析方法</span>
    <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ParsePackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*这里为什么要加 4，这个判断很关键
        因为第一次接收 读取索引为0，加4可以判断，数据最基本的长度，如果这个都没有，那么这个包就没必要解析
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>readOffset <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">&lt;</span> stream<span class="token punctuation">.</span>Position<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//1. 获取包内容的大小</span>
            <span class="token class-name"><span class="token keyword">int</span></span> packageSize <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span><span class="token function">GetBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> readOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2. 这里的 读取索引readOffset，感觉加没加都一样，根据整个方法代码，这个变量在这的作用为0</span>
            <span class="token comment">//但是这步判断很重要，包大小 加 4 如果小于等于成立，说明消息包是完整的，可解</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>packageSize <span class="token operator">+</span> readOffset <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">&lt;=</span> stream<span class="token punctuation">.</span>Position<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//3. 调用通过字节提取消息类</span>
                <span class="token class-name">Message<span class="token punctuation">.</span>NetMessage</span> message <span class="token operator">=</span> <span class="token function">UnpackMessage</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span><span class="token function">GetBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readOffset <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> packageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"PackageHandler ParsePackage faild,invalid package"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//容错处理</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//4. 得到了 类，调用消息分发器传递该类，进行处理</span>
                MessageDistributer<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">ReceiveMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sender<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//5. 将读取索引加上 整条完整数据长度</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>readOffset <span class="token operator">+=</span> <span class="token punctuation">(</span>packageSize <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//6. 返回这个类，是为了再次判断是否，有粘包，分包处理</span>
                <span class="token keyword">return</span> <span class="token function">ParsePackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//当消息接收处理过一次，读取索引必定大于0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readOffset <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//1. 这里是获取可能存在没有其他不完整的数据</span>
            <span class="token class-name"><span class="token keyword">long</span></span> size <span class="token operator">=</span> stream<span class="token punctuation">.</span>Position <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readOffset<span class="token punctuation">;</span>
            <span class="token comment">//2. 如果这个小于，说明缓冲区还有数据</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readOffset <span class="token operator">&lt;</span> stream<span class="token punctuation">.</span>Position<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span><span class="token function">GetBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readOffset<span class="token punctuation">,</span> stream<span class="token punctuation">.</span><span class="token function">GetBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> stream<span class="token punctuation">.</span>Position <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//3. Reset Stream</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>readOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            stream<span class="token punctuation">.</span>Position <span class="token operator">=</span> size<span class="token punctuation">;</span>
            stream<span class="token punctuation">.</span><span class="token function">SetLength</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//结束</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//提取消息类</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Message<span class="token punctuation">.</span>NetMessage</span> <span class="token function">UnpackMessage</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> packet<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">int</span></span> offset<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">int</span></span> length<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Message<span class="token punctuation">.</span>NetMessage</span> message <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">MemoryStream</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            message <span class="token operator">=</span> ProtoBuf<span class="token punctuation">.</span>Serializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Message<span class="token punctuation">.</span>NetMessage<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">// -------- 客户端专用构造方式 --------</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">PackageHandler<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token function">PackageHandler</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="7_MessageDistributer_479"></a>7. 消息分发器类（MessageDistributer）单例类</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageDistributer<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Singleton<span class="token punctuation">&lt;</span>MessageDistributer<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 队列的消息类对象</span>
    <span class="token keyword">class</span> <span class="token class-name">MessageArgs</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token class-name">T</span> sender<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">Message<span class="token punctuation">.</span>NetMessage</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 消息类队列</span>
    <span class="token keyword">private</span> <span class="token class-name">Queue<span class="token punctuation">&lt;</span>MessageArgs<span class="token punctuation">&gt;</span></span> messageQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Queue<span class="token punctuation">&lt;</span>MessageArgs<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 自动重置事件，终止状态</span>
    <span class="token keyword">private</span> <span class="token class-name">AutoResetEvent</span> threadEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoResetEvent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 线程执行状态</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> Running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 开启的线程数量</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> ThreadCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 激活状态的线程数</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> ActiveThreadCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 处理消息包处理类传递的类  sender 是消息包处理类被构造时候，存放是 NetConnection&lt;NetSeession&gt; 对象，</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ReceiveMessage</span><span class="token punctuation">(</span><span class="token class-name">T</span> sender <span class="token punctuation">,</span><span class="token class-name">Message<span class="token punctuation">.</span>NetMessage</span> message<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将消息添加到消息队列	MessageArgs</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">.</span><span class="token function">Enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">MessageArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> sender <span class="token operator">=</span> sender<span class="token punctuation">,</span> message <span class="token operator">=</span> message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将事件状态设置为有信号，从而允许一个或多个等待线程继续执行。</span>
        threadEvent<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 多线程模式消息处理开始函数，参数为 工作线程的数量</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> ThreadNum<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ThreadCount <span class="token operator">=</span> ThreadNum<span class="token punctuation">;</span>
        <span class="token comment">// 进行限制</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ThreadCount <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ThreadCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ThreadCount <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ThreadCount <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token comment">// 激活线程执行状态</span>
        Running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ThreadCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 调用 QueueUserWorkItem 方法以将方法排队以便在线程池线程上执行。 为此，可将方法传递给 WaitCallback 委托。 委托具有签名</span>
            ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitCallback</span><span class="token punctuation">(</span>MessageDistribute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ActiveThreadCount <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ThreadCount<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 工作状态的线程 小于 总线程，进入休眠	具体作用不得而知 =-=  可能只是为了减轻CPU压力哦~</span>
            Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 消息处理线程</span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MessageDistribute</span><span class="token punctuation">(</span><span class="token class-name">Object</span> stateInfo<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">Warning</span><span class="token punctuation">(</span><span class="token string">"MessageDistribute thread start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果不使用 Increment 和，则在 Decrement 执行前两个步骤后，线程可以被抢占</span>
            ActiveThreadCount <span class="token operator">=</span> Interlocked<span class="token punctuation">.</span><span class="token function">Increment</span><span class="token punctuation">(</span><span class="token keyword">ref</span> ActiveThreadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>Running<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">.</span>Count  <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 消息队列没有消息时 阻止当前线程，直到当前 WaitHandle 收到信号。</span>
                    threadEvent<span class="token punctuation">.</span><span class="token function">WaitOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 取出队列消息</span>
                <span class="token class-name">MessageArgs</span> package <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">.</span><span class="token function">Dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>package<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Request <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 请求消息不为空，执行请求事件消息发送	用于客户端~</span>
                    MessageDispatch<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">Dispatch</span><span class="token punctuation">(</span>package<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> package<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>package<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Response <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 响应消息不为空，执行请求事件消息发送	用于服务端~</span>
                    MessageDispatch<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">Dispatch</span><span class="token punctuation">(</span>package<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> package<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token keyword">finally</span>	<span class="token comment">//必会执行的代码块 0.0  Increment Decrement，就和有生就有死一个道理</span>
            <span class="token punctuation">{<!-- --></span>
                ActiveThreadCount <span class="token operator">=</span> Interlocked<span class="token punctuation">.</span><span class="token function">Decrement</span><span class="token punctuation">(</span><span class="token keyword">ref</span> ActiveThreadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Log<span class="token punctuation">.</span><span class="token function">Warning</span><span class="token punctuation">(</span><span class="token string">"MessageDistribute thread end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 停止多线程模式消息处理器</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ActiveThreadCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            threadEvent<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 定义的委托</span>
    <span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">MessageHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Tm<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> sender<span class="token punctuation">,</span> <span class="token class-name">Tm</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 委托字典</span>
    <span class="token keyword">private</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> System<span class="token punctuation">.</span>Delegate<span class="token punctuation">&gt;</span></span> messageHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> System<span class="token punctuation">.</span>Delegate<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 就一个false 变量</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">bool</span></span> ThrowException <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 消息派发类调用此方法，此方法也是每条通信数据最后的一处理，会执行谁订阅的方法</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">RaiseEvent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Tm<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> sender<span class="token punctuation">,</span><span class="token class-name">Tm</span> msg<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">string</span></span> key <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageHandlers<span class="token punctuation">.</span><span class="token function">ContainsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 在委托字典通过key 取得对应的委托</span>
            <span class="token class-name">MessageHandler<span class="token punctuation">&lt;</span>Tm<span class="token punctuation">&gt;</span></span> handler <span class="token operator">=</span> <span class="token punctuation">(</span>MessageHandler<span class="token operator">&lt;</span>Tm<span class="token operator">&gt;</span><span class="token punctuation">)</span>messageHandlers<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">handler</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>Exception</span> ex<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    Log<span class="token punctuation">.</span><span class="token function">ErrorFormat</span><span class="token punctuation">(</span><span class="token string">"Message handler Fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 也不知道这里要干嘛 =-=， 感觉没啥大作用</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ThrowException<span class="token punctuation">)</span>
                        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                Log<span class="token punctuation">.</span><span class="token function">Warning</span><span class="token punctuation">(</span><span class="token string">"No handler subscribed for {0}"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 订阅事件</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">Subscribe</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Tm<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">MessageHandler<span class="token punctuation">&lt;</span>Tm<span class="token punctuation">&gt;</span></span> messageHandler<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">string</span></span> type <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Tm</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">;</span>
        <span class="token comment">// 如果有相同的，则把之前的制空，重新赋值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageHandlers<span class="token punctuation">.</span><span class="token function">ContainsKey</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            messageHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        messageHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>MessageHandler<span class="token operator">&lt;</span>Tm<span class="token operator">&gt;</span><span class="token punctuation">)</span>messageHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">+</span> messageHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 有订阅 当然有注销</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">Unsubscribe</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Tm<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">MessageHandler<span class="token punctuation">&lt;</span>Tm<span class="token punctuation">&gt;</span></span> messageHandler<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">string</span></span> type <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Tm</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageHandlers<span class="token punctuation">.</span><span class="token function">ContainsKey</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            messageHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        messageHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>MessageHandler<span class="token operator">&lt;</span>Tm<span class="token operator">&gt;</span><span class="token punctuation">)</span>messageHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">-</span> messageHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">//------- 下面区域是只有客户端才会用到的方法-------</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 清空接收消息存储的容器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="8_MessageDispatch_658"></a>8. 消息派发器类（MessageDispatch）单例类</h4> 
<pre><code class="prism language-csharp"><span class="token comment">// 在消息分发器类中，有订阅事件，此类只充当一个中介</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageDispatch<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Singleton<span class="token punctuation">&lt;</span>MessageDispatch<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 响应派发	RaiseEvent 消息分发器类中处理</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispatch</span><span class="token punctuation">(</span><span class="token class-name">T</span> sender<span class="token punctuation">,</span> <span class="token class-name">Message<span class="token punctuation">.</span>NetMessageResponse</span> message<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>userRegister <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> MessageDistributer<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">RaiseEvent</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> message<span class="token punctuation">.</span>userRegister<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 请求派发</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispatch</span><span class="token punctuation">(</span><span class="token class-name">T</span> sender<span class="token punctuation">,</span> <span class="token class-name">SkillBridge<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>NetMessageRequest</span> message<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>userRegister <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> MessageDistributer<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">RaiseEvent</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span>message<span class="token punctuation">.</span>userRegister<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4>
<a id="_680"></a>至此服务器端会用到的注释完毕</h4> 
<h3>
<a id="_684"></a>客户端：</h3> 
<h4>
<a id="NetClientMono_686"></a>网络类（NetClient）Mono单例类</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">class</span> <span class="token class-name">NetClient</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoSingleton<span class="token punctuation">&lt;</span>NetClient<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">IPEndPoint</span> address<span class="token punctuation">;</span>	 <span class="token comment">// 终端</span>
    <span class="token keyword">private</span> <span class="token class-name">Socket</span> clientSocket<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> running <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>	<span class="token comment">// 网络服务器运行状态</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> connecting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>	<span class="token comment">// 是否正在连接服务器</span>
    
	<span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Awake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 初始化函数 率先绑定 终端</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> serverIP<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> port<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPEndPoint</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>serverIP<span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 连接服务器函数</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> times <span class="token operator">=</span> DEF_TRY_CONNECT_TIMES<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connecting<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//当前在连接中，直接跳出</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//socket这东西，先关掉，在使用，每次使用前，先关掉，为什么呢？ 如果你不做断线重连就可以忽略</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">==</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token type-expression class-name">IPEndPoint</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"Please Init first."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span>connecting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 正在连接</span>
        <span class="token comment">//真正执行连接</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">DoConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">// 开始连接</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DoConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"NetClient.DoConnect on "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>address<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//解释过</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span>Blocking <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>	<span class="token comment">//开启阻塞</span>
            
            Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"Connect[{0}] to server {1}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retryTimes<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//得到一个异步连接的结果~</span>
            <span class="token class-name">IAsyncResult</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">BeginConnect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">bool</span></span> success <span class="token operator">=</span> result<span class="token punctuation">.</span>AsyncWaitHandle<span class="token punctuation">.</span><span class="token function">WaitOne</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1000 是连接等待结果的时间</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// success 为真，说明连接这档事成了， EndConnect 接收结果后，clientSocket 就可以发送接收消息了</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">EndConnect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">SocketException</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 连接被拒绝 为什么被拒绝，有点数的都知道被拉黑名单了 ( •̀ ω •́ )✧</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>SocketErrorCode <span class="token operator">==</span> SocketError<span class="token punctuation">.</span>ConnectionRefused<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">CloseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Debug<span class="token punctuation">.</span><span class="token function">LogErrorFormat</span><span class="token punctuation">(</span><span class="token string">"DoConnect SocketException Fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"DoConnect Exception:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断是否连接成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span>Connected<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span>Blocking <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>	<span class="token comment">//关掉阻塞</span>
            <span class="token comment">//this.RaiseConnected(0, "Success"); 这条注释，是因为会执行一个事件，重连事件，属于功能性</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 进行重连的事情</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connecting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//连接完毕</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">// 关闭连接 没有参数，因为参数只是打印出关闭的原因</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CloseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connecting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//清空缓冲区</span>
        MessageDistributer<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//因为这个类是公用的，断线就需要清理，此类最下面有客户端专用的方法区域</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sendQueue<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清空发送消息队列</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span>receiveBuffer<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//接收消息的缓存区清0</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sendBuffer<span class="token punctuation">.</span>Position <span class="token operator">=</span> sendOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//发送的缓冲区 和发送索引 清0</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 需要发送的消息队列</span>
    <span class="token keyword">private</span> <span class="token class-name">Queue<span class="token punctuation">&lt;</span>NetMessage<span class="token punctuation">&gt;</span></span> sendQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Queue<span class="token punctuation">&lt;</span>NetMessage<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 发送数据的缓冲区</span>
    <span class="token keyword">private</span> <span class="token class-name">MemoryStream</span> sendBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 接收数据的缓冲区</span>
    <span class="token keyword">private</span> <span class="token class-name">MemoryStream</span> receiveBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 这个类的构造，看此类最下方</span>
    <span class="token keyword">public</span> <span class="token class-name">PackageHandler</span> packageHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PackageHandler</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//发送消息</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SendMessage</span><span class="token punctuation">(</span><span class="token class-name">NetMessage</span> message<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>running<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>Connected<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 这里呢，就是你没了连接服务器 就调用此方法，这里会忽略掉你的请求，先连接服务器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>receiveBuffer<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sendBuffer<span class="token punctuation">.</span>Position <span class="token operator">=</span> sendOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"Connect Server before Send Message!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将消息添加到队列</span>
        sendQueue<span class="token punctuation">.</span><span class="token function">Enqueue</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>running<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 没有连接 跳出~</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">KeepConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ProcessRecv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 保存是连接状态</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Connected<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ProcessSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送过程</span>
                    MessageDistributer<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">Distribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//ProceeMessage()； 方法只有这一条代码 直接写了，处理派发~</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 发送过程</span>
    <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ProcessSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">bool</span></span> ret <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span>Blocking<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                 Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"this.clientSocket.Blocking = truen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name"><span class="token keyword">bool</span></span> error <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">Poll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SelectMode<span class="token punctuation">.</span>SelectError<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"ProcessSend Poll SelectErrorn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">CloseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 检测是否可写，这个只要socket正常，就一定是真</span>
            ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">Poll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SelectMode<span class="token punctuation">.</span>SelectWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 第一次肯定不大于因为都是0，执行完后，这里就大于了</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sendBuffer<span class="token punctuation">.</span>Position <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendOffset<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 得到大小</span>
                    <span class="token class-name"><span class="token keyword">int</span></span> bufsize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sendBuffer<span class="token punctuation">.</span>Position <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 发送</span>
                    <span class="token class-name"><span class="token keyword">int</span></span> n <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sendBuffer<span class="token punctuation">.</span><span class="token function">GetBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendOffset<span class="token punctuation">,</span> bufsize<span class="token punctuation">,</span> SocketFlags<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">CloseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>sendOffset <span class="token operator">+=</span> n<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sendOffset <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendBuffer<span class="token punctuation">.</span>Position<span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//清空一定要做 this.sendOffset += n; if (this.sendOffset &gt;= this.sendBuffer.Position) 其实可以不要</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>sendOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>sendBuffer<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>sendQueue<span class="token punctuation">.</span><span class="token function">Dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sendQueue<span class="token punctuation">.</span>Count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 上面说 可以不要 ，是因为 这里，每次只求一条</span>
                        <span class="token class-name">NetMessage</span> message <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendQueue<span class="token punctuation">.</span><span class="token function">Peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> package <span class="token operator">=</span> PackageHandler<span class="token punctuation">.</span><span class="token function">PackMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 写入数据</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>sendBuffer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>package<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> package<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 接收消息的过程方法</span>
    <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ProcessRecv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">bool</span></span> ret <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span>Blocking<span class="token punctuation">)</span>	<span class="token comment">//如果是阻塞的 就一直卡折，所以抛出个异常 提醒一下</span>
            <span class="token punctuation">{<!-- --></span>
                Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"this.clientSocket.Blocking = truen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name"><span class="token keyword">bool</span></span> error <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">Poll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SelectMode<span class="token punctuation">.</span>SelectError<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 检测到错误 所以关闭</span>
                Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"ProcessRecv Poll SelectErrorn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">CloseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">Poll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SelectMode<span class="token punctuation">.</span>SelectRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 检测到有可读的消息</span>
                <span class="token class-name"><span class="token keyword">int</span></span> n <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientSocket<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>receiveBuffer<span class="token punctuation">.</span><span class="token function">GetBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>receiveBuffer<span class="token punctuation">.</span>Capacity<span class="token punctuation">,</span> SocketFlags<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//接收到的长度为0.所以关闭，有消息过来大小为零的只有 关闭请求/响应 =-=</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">CloseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                <span class="token comment">// 跟服务器端一样，接收数据的处理是一致的</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>packageHandler<span class="token punctuation">.</span><span class="token function">ReceiveData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>receiveBuffer<span class="token punctuation">.</span><span class="token function">GetBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 接收过程异常~</span>
            Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"ProcessReceive exception:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">CloseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 状态判断把，比较Update 一直在执行</span>
    <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">KeepConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connecting<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Connected<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">//if (this.retryTimes &lt; this.retryTimesTotal)	this.Connect(); //这个还是断线重连的处理</span>
        
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<blockquote> 
 <p>???? <strong>粉丝福利来喽</strong> ????</p> 
 <ol>
<li>
<strong>免费领取海量资源</strong> ?<br> 简历自测评分表、Unity职级技能表、面试题库、入行学习路径等</li>
<li>
<strong>《Unity游戏开发五天集训营 》50个名额</strong> ?<br> 我给大家争取到了 50个《游戏开发五天集训营 》名额，原价198，前50个免费<br> <code>扫码加入，暗号小听歌</code><br> 即可参加ARPG狼人战斗系统、饥荒生存类游戏开发、回合制RPG口袋妖怪游戏等游戏开发训练营</li>
<li>
<strong>额外抽奖机会</strong>?<br> 参加游戏训练营、还有机会获得大厂老师在线面试指导、或者有机会获得价值1998元的《Unity极速入门与实战》课程</li>
</ol> 
</blockquote> 

  ???? 
 <font color="red" size="3" face="黑体">扫下方二维码，获取游戏开发福利，暗号小听歌</font> ???? 

                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>