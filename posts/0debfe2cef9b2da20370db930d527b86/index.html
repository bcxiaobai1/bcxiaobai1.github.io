<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>基础的强化学习(RL)算法及代码详细demo - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基础的强化学习(RL)算法及代码详细demo</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <p></p>
<div class="toc">
 <h3>文章目录</h3>
 <ul><li>
<ul><li>
<ul>
<li><a href="#Sarsa__35">一、Sarsa (悬崖问题)</a></li>
<li>
<ul>
<li><a href="#11_CliffWalkingv0_37">1.1 CliffWalking-v0环境介绍</a></li>
<li><a href="#12_Sarsa_61">1.2 Sarsa算法流程</a></li>
<li><a href="#13__83">1.3 具体代码</a></li>
<li><a href="#14__180">1.4 演示效果</a></li>
</ul>
    </li>
<li><a href="#QLearning__187">二、Q-Learning (悬崖问题)</a></li>
<li>
<ul>
<li><a href="#21_CliffWalkingv0_189">2.1 CliffWalking-v0环境介绍</a></li>
<li><a href="#22_QLearning_193">2.2 Q-Learning算法流程</a></li>
<li><a href="#23___214">2.3 具体代码</a></li>
<li><a href="#24__314">2.4 演示效果</a></li>
</ul>
    </li>
<li><a href="#PG___319">三、PG 策略梯度 (倒立摆)</a></li>
<li>
<ul>
<li><a href="#31_CartPolev1_321">3.1 CartPole-v1环境介绍</a></li>
<li><a href="#32_PGREINFORCE_363">3.2 PG算法流程(REINFORCE)</a></li>
<li><a href="#33__381">3.3 具体代码</a></li>
<li><a href="#34__496">3.4 演示效果</a></li>
</ul>
    </li>
<li><a href="#PPO__507">四、PPO (飞船降落)</a></li>
<li>
<ul>
<li><a href="#41_LunarLanderv2_509">4.1 LunarLander-v2环境介绍</a></li>
<li><a href="#42_PPOClip_549">4.2 PPO-Clip算法流程</a></li>
<li><a href="#43__565">4.3 具体代码</a></li>
<li><a href="#44__822">4.4 演示效果</a></li>
</ul>
    </li>
<li><a href="#DQN__830">五、DQN (打砖块)</a></li>
<li>
<ul>
<li><a href="#51_Breakoutv0_832">5.1 Breakout-v0环境介绍</a></li>
<li><a href="#52_DQN_860">5.2 DQN算法流程</a></li>
<li><a href="#53__891">5.3 具体代码</a></li>
<li><a href="#54__1109">5.4 演示效果</a></li>
</ul>
    </li>
<li><a href="#DDPG__1120">六、DDPG (单摆)</a></li>
<li>
<ul>
<li><a href="#61_Pendulumv1_1122">6.1 Pendulum-v1环境介绍</a></li>
<li><a href="#62_DDPG_1147">6.2 DDPG算法流程</a></li>
<li><a href="#63__1179">6.3 具体代码</a></li>
<li><a href="#64__1342">6.4 演示效果</a></li>
</ul>
   </li>
</ul>
  </li></ul>
 </li></ul>
</div>
<p></p> 
<ul>
<li> <p><strong>gym环境: https://www.gymlibrary.dev/</strong></p> </li>
<li> <p>环境安装:</p> 
  <ul>
<li> <p>我的版本:</p> 
    <table>
<thead><tr>
<th>package</th>
<th>module</th>
</tr></thead>
<tbody>
<tr>
<td>gym</td>
<td>0.24.0</td>
</tr>
<tr>
<td>ale-py</td>
<td>0.7.5</td>
</tr>
<tr>
<td>torch</td>
<td>1.11.0</td>
</tr>
<tr>
<td>torchvision</td>
<td>0.12.0</td>
</tr>
<tr>
<td>tensorboard</td>
<td>2.6.0</td>
</tr>
</tbody>
</table>
</li>
<li> <p>安装方法：</p> <pre><code class="prism language-python">pip install <span class="token operator">-</span>i https<span class="token punctuation">:</span><span class="token operator">//</span>pypi<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>simple gym
pip install <span class="token operator">-</span><span class="token operator">-</span>no<span class="token operator">-</span>index <span class="token operator">-</span>f https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Kojoley<span class="token operator">/</span>atari<span class="token operator">-</span>py<span class="token operator">/</span>releases atari_py
pip install gym<span class="token punctuation">[</span>atari<span class="token punctuation">]</span>
pip uninstall ale<span class="token operator">-</span>py
pip install ale<span class="token operator">-</span>py
</code></pre> <p>安装box2d: 可能会遇到building wheel failed for box2d</p> <pre><code class="prism language-python">在 https<span class="token punctuation">:</span><span class="token operator">//</span>www<span class="token punctuation">.</span>lfd<span class="token punctuation">.</span>uci<span class="token punctuation">.</span>edu<span class="token operator">/</span><span class="token operator">~</span>gohlke<span class="token operator">/</span>pythonlibs<span class="token operator">/</span> 下载相应的 PyBox2D的whl文件
然后在命令行<span class="token punctuation">:</span>
pip install D<span class="token punctuation">:</span>FILESPYTHON_PROJECTSBox2D<span class="token operator">-</span><span class="token number">2.3</span><span class="token number">.10</span><span class="token operator">-</span>cp37<span class="token operator">-</span>cp37m<span class="token operator">-</span>win_amd64<span class="token punctuation">.</span>whl
</code></pre> </li>
</ul> </li>
</ul> 
<h3>
<a id="Sarsa__35"></a>一、Sarsa (悬崖问题)</h3> 
<h4>
<a id="11_CliffWalkingv0_37"></a>1.1 CliffWalking-v0环境介绍</h4> 
<p>在一个4x12的网格中，智能体以网格的左下角位置为起点，以网格的下角位置为终点，目标是移动智能体到达终点位置，智能体每次可以在上、下、左、右这4个方向中移动一步，每移动一步会得到 -1 的奖励。</p> 
<p><img src="https://images2.imgbox.com/8c/43/KV8wJHCW_o.png" alt="在这里插入图片描述"></p> 
<ul>
<li> <p>如果智能体“掉入悬崖” ，会立即回到起点位置，并得到-100单位的奖励</p> </li>
<li> <p>当智能体移动到终点时，该回合结束，该回合总奖励为各步奖励之和</p> </li>
</ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> gym

env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">"CliffWalking-v0"</span><span class="token punctuation">)</span>
observation <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span> 
env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/93/83/0NfVuVFi_o.png" alt="在这里插入图片描述"></p> 
<ul><li>从起点到终点最少需要13步，每步得到-1的reward。我们的目标也是要通过RL训练出一个模型，使得该模型能在测试中一个episode的reward能够接近于-13左右。</li></ul> 
<h4>
<a id="12_Sarsa_61"></a>1.2 Sarsa算法流程</h4> 
<blockquote> 
 <p>算法参数: 步长<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         α
        
        
         &lt;
        
        
         1
        
       
       
        alpha&lt;1
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em;vertical-align: -0.0391em"></span><span class="mord mathnormal" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6444em"></span><span class="mord">1</span></span></span></span></span> 极小值<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         ϵ
        
       
       
        epsilon
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em"></span><span class="mord mathnormal">ϵ</span></span></span></span></span> （两个超参数)</p> 
 <p>对于所有<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         Q
        
        
         (
        
        
         s
        
        
         ,
        
        
         a
        
        
         )
        
       
       
        Q(s,a)
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span>随机初始化，终点处$ Q(s_{end},a) = 0$</p> 
</blockquote> 
<blockquote> 
 <p>for (each trajectory):</p> 
 <blockquote> 
  <p>初始化<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          S
         
        
        
         S
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em"></span><span class="mord mathnormal" style="margin-right: 0.0576em">S</span></span></span></span></span></p> 
  <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          
           a
          
          
           t
          
         
         
          =
         
         
          ϵ
         
         
          −
         
         
          g
         
         
          r
         
         
          e
         
         
          e
         
         
          d
         
         
          y
         
         
         
          (
         
         
          
           s
          
          
           t
          
         
         
          )
         
        
        
         a_t = epsilon -greedy quad(s_t)
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6667em;vertical-align: -0.0833em"></span><span class="mord mathnormal">ϵ</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0359em">g</span><span class="mord mathnormal">ree</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right: 0.0359em">y</span><span class="mspace" style="margin-right: 1em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
  <blockquote> 
   <p>for (each step):</p> 
   <blockquote> 
    <p>执行<span class="katex--inline"><span class="katex"><span class="katex-mathml">
        
         
          
           
            
             a
            
            
             t
            
           
          
          
           a_t
          
         
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span>，得到<span class="katex--inline"><span class="katex"><span class="katex-mathml">
        
         
          
           
            (
           
           
            
             r
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            ,
           
           
            
             s
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            )
           
          
          
           (r_{t+1},s_{t+1})
          
         
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
    <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
        
         
          
           
            
             a
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            =
           
           
            ϵ
           
           
            −
           
           
            g
           
           
            r
           
           
            e
           
           
            e
           
           
            d
           
           
            y
           
           
           
            (
           
           
            
             s
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            )
           
          
          
           a_{t+1} = epsilon -greedy quad(s_{t+1})
          
         
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6389em;vertical-align: -0.2083em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6667em;vertical-align: -0.0833em"></span><span class="mord mathnormal">ϵ</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0359em">g</span><span class="mord mathnormal">ree</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right: 0.0359em">y</span><span class="mspace" style="margin-right: 1em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
    <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
        
         
          
           
            Q
           
           
            (
           
           
            
             s
            
            
             t
            
           
           
            ,
           
           
            
             a
            
            
             t
            
           
           
            )
           
           
            =
           
           
            Q
           
           
            (
           
           
            
             s
            
            
             t
            
           
           
            ,
           
           
            
             a
            
            
             t
            
           
           
            )
           
           
            +
           
           
            α
           
           
            [
           
           
            
             r
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            +
           
           
            γ
           
           
            Q
           
           
            (
           
           
            
             s
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            ,
           
           
            
             a
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            )
           
           
            −
           
           
            Q
           
           
            (
           
           
            
             s
            
            
             t
            
           
           
            ,
           
           
            
             a
            
            
             t
            
           
           
            )
           
           
            ]
           
          
          
           Q(s_{t},a_{t})=Q(s_{t},a_{t})+alpha[r_{t+1}+gamma Q(s_{t+1},a_{t+1})-Q(s_{t},a_{t})]
          
         
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0037em">α</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0556em">γ</span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)]</span></span></span></span></span></p> 
    <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
        
         
          
           
            
             s
            
            
             t
            
           
           
            =
           
           
            
             s
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            ,
           
           
            
             a
            
            
             t
            
           
           
            =
           
           
            
             a
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
          
          
           s_t = s_{t+1},a_t = a_{t+1}
          
         
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6389em;vertical-align: -0.2083em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6389em;vertical-align: -0.2083em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
   </blockquote> 
  </blockquote> 
 </blockquote> 
</blockquote> 
<h4>
<a id="13__83"></a>1.3 具体代码</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> gym
<span class="token keyword">import</span> time

<span class="token keyword">class</span> <span class="token class-name">SarsaAgent</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs_n<span class="token punctuation">,</span> act_n<span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> e_greed<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>act_n <span class="token operator">=</span> act_n
        self<span class="token punctuation">.</span>lr <span class="token operator">=</span> learning_rate
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> gamma
        self<span class="token punctuation">.</span>epsilon <span class="token operator">=</span> e_greed
        self<span class="token punctuation">.</span>Q <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>obs_n<span class="token punctuation">,</span> act_n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># e_greed:根据s_t,选择a_t</span>
    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>epsilon<span class="token punctuation">)</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> self<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>self<span class="token punctuation">.</span>act_n<span class="token punctuation">)</span> <span class="token comment"># 0,1,2,3</span>
        <span class="token keyword">return</span> action
    <span class="token comment"># a_t = argmax Q(s)</span>
    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        Q_list <span class="token operator">=</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment">#当前s下所有a对应的Q值</span>
        maxQ <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>Q_list<span class="token punctuation">)</span>
        action_list <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>Q_list <span class="token operator">==</span> maxQ<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment"># action_list=所有=Qmax的索引</span>
        action <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>action_list<span class="token punctuation">)</span>
        <span class="token keyword">return</span> action
    
    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> next_action<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># (S,A,R,S,A)</span>
        <span class="token triple-quoted-string string">'''
        done: episode是否结束
        '''</span>
        predict_Q <span class="token operator">=</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span>action<span class="token punctuation">]</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            target_Q <span class="token operator">=</span> reward
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            target_Q <span class="token operator">=</span> reward <span class="token operator">+</span> self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>next_obs<span class="token punctuation">,</span>next_action<span class="token punctuation">]</span>
        <span class="token comment"># 更新Q表格</span>
        self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span>action<span class="token punctuation">]</span> <span class="token operator">+=</span> self<span class="token punctuation">.</span>lr <span class="token operator">*</span> <span class="token punctuation">(</span>target_Q <span class="token operator">-</span> predict_Q<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        npy_file <span class="token operator">=</span> <span class="token string">'./q-table.npy'</span>
        np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>npy_file<span class="token punctuation">,</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>npy_file <span class="token operator">+</span> <span class="token string">' saved.'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">load</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> npy_file<span class="token operator">=</span><span class="token string">'./q_table.npy'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>Q <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>npy_file<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>npy_file <span class="token operator">+</span> <span class="token string">' loaded.'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">run_episode</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> render<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    total_steps <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment"># 记录当前episode走了多少step</span>
    total_reward <span class="token operator">=</span> <span class="token number">0</span> 
    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    action <span class="token operator">=</span> agent<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        next_obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        next_action <span class="token operator">=</span> agent<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>next_obs<span class="token punctuation">)</span>
        agent<span class="token punctuation">.</span>learn<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> next_action<span class="token punctuation">,</span> done<span class="token punctuation">)</span>
        action <span class="token operator">=</span> next_action
        obs <span class="token operator">=</span> next_obs
        total_reward <span class="token operator">+=</span> reward
        total_steps <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> render<span class="token punctuation">:</span>
            env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> total_reward<span class="token punctuation">,</span> total_steps

<span class="token keyword">def</span> <span class="token function">test_episode</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    total_steps <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment"># 记录当前episode走了多少step</span>
    total_reward <span class="token operator">=</span> <span class="token number">0</span> 
    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        action <span class="token operator">=</span> agent<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        next_obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        total_reward <span class="token operator">+=</span> reward
        total_steps <span class="token operator">+=</span> <span class="token number">1</span>
        obs <span class="token operator">=</span> next_obs
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
        env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> total_reward<span class="token punctuation">,</span> total_steps

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">"CliffWalking-v0"</span><span class="token punctuation">)</span>
    agent <span class="token operator">=</span> SarsaAgent<span class="token punctuation">(</span>obs_n<span class="token operator">=</span>env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>n<span class="token punctuation">,</span> 
                       act_n<span class="token operator">=</span>env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n<span class="token punctuation">,</span>
                       learning_rate<span class="token operator">=</span><span class="token number">0.025</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> e_greed<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> episode <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        total_reward<span class="token punctuation">,</span> total_steps <span class="token operator">=</span> run_episode<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Episode %s: total_steps = %s , total_reward = %.1f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>episode<span class="token punctuation">,</span> total_steps<span class="token punctuation">,</span> total_reward<span class="token punctuation">)</span><span class="token punctuation">)</span>
    test_episode<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span>

main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4>
<a id="14__180"></a>1.4 演示效果</h4> 
<p>训练了1000个episode,<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        r
       
       
        e
       
       
        w
       
       
        a
       
       
        r
       
       
        d
       
       
        =
       
       
        −
       
       
        23
       
      
      
       reward=-23
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em"></span><span class="mord mathnormal">re</span><span class="mord mathnormal" style="margin-right: 0.0269em">w</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.7278em;vertical-align: -0.0833em"></span><span class="mord">−</span><span class="mord">23</span></span></span></span></span></p> 
<p><img src="https://images2.imgbox.com/07/3e/EHVyvFQQ_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="QLearning__187"></a>二、Q-Learning (悬崖问题)</h3> 
<h4>
<a id="21_CliffWalkingv0_189"></a>2.1 CliffWalking-v0环境介绍</h4> 
<p>(介绍见1.1)</p> 
<h4>
<a id="22_QLearning_193"></a>2.2 Q-Learning算法流程</h4> 
<p>(Q-Learning其实真正执行的策略和Sarsa是一样的，只不过学习的策略是保守的最优策略)</p> 
<blockquote> 
 <p>算法参数: 步长<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         α
        
        
         &lt;
        
        
         1
        
       
       
        alpha&lt;1
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em;vertical-align: -0.0391em"></span><span class="mord mathnormal" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6444em"></span><span class="mord">1</span></span></span></span></span> 极小值<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         ϵ
        
       
       
        epsilon
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em"></span><span class="mord mathnormal">ϵ</span></span></span></span></span> （两个超参数)</p> 
 <p>对于所有<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         Q
        
        
         (
        
        
         s
        
        
         ,
        
        
         a
        
        
         )
        
       
       
        Q(s,a)
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span>随机初始化，终点处<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         Q
        
        
         (
        
        
         
          s
         
         
          
           e
          
          
           n
          
          
           d
          
         
        
        
         ,
        
        
         a
        
        
         )
        
        
         =
        
        
         0
        
       
       
        Q(s_{end},a) = 0
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6444em"></span><span class="mord">0</span></span></span></span></span><br> for (each trajectory):</p> 
 <blockquote> 
  <p>初始化<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          S
         
        
        
         S
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em"></span><span class="mord mathnormal" style="margin-right: 0.0576em">S</span></span></span></span></span></p> 
  <blockquote> 
   <p>for (each step):</p> 
   <blockquote> 
    <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
        
         
          
           
            
             a
            
            
             t
            
           
           
            =
           
           
            ϵ
           
           
            −
           
           
            g
           
           
            r
           
           
            e
           
           
            e
           
           
            d
           
           
            y
           
           
           
            (
           
           
            
             s
            
            
             t
            
           
           
            )
           
          
          
           a_{t} = epsilon -greedy quad(s_{t})
          
         
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6667em;vertical-align: -0.0833em"></span><span class="mord mathnormal">ϵ</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0359em">g</span><span class="mord mathnormal">ree</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right: 0.0359em">y</span><span class="mspace" style="margin-right: 1em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>（行为策略）</p> 
    <p>执行<span class="katex--inline"><span class="katex"><span class="katex-mathml">
        
         
          
           
            
             a
            
            
             t
            
           
          
          
           a_t
          
         
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span>，得到<span class="katex--inline"><span class="katex"><span class="katex-mathml">
        
         
          
           
            (
           
           
            
             r
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            ,
           
           
            
             s
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            )
           
          
          
           (r_{t+1},s_{t+1})
          
         
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
    <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
        
         
          
           
            Q
           
           
            (
           
           
            
             s
            
            
             t
            
           
           
            ,
           
           
            
             a
            
            
             t
            
           
           
            )
           
           
            =
           
           
            Q
           
           
            (
           
           
            
             s
            
            
             t
            
           
           
            ,
           
           
            
             a
            
            
             t
            
           
           
            )
           
           
            +
           
           
            α
           
           
            [
           
           
            
             r
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            +
           
           
            γ
           
           
            
             
              
               m
              
              
               a
              
              
               x
              
             
             
              a
             
            
           
           
            Q
           
           
            (
           
           
            
             s
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
           
            ,
           
           
            a
           
           
            )
           
           
            −
           
           
            Q
           
           
            (
           
           
            
             s
            
            
             t
            
           
           
            ,
           
           
            
             a
            
            
             t
            
           
           
            )
           
           
            ]
           
          
          
           Q(s_{t},a_{t})=Q(s_{t},a_{t})+alpha[r_{t+1}+gamma underset{a}{max}Q(s_{t+1},a)-Q(s_{t},a_{t})]
          
         
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0037em">α</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1.45em;vertical-align: -0.7em"></span><span class="mord mathnormal" style="margin-right: 0.0556em">γ</span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.4306em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class=""><span class="mop"><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7em"><span class=""></span></span></span></span></span></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)]</span></span></span></span></span></p> 
    <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
        
         
          
           
            
             s
            
            
             t
            
           
           
            =
           
           
            
             s
            
            
             
              t
             
             
              +
             
             
              1
             
            
           
          
          
           s_t = s_{t+1}
          
         
        </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6389em;vertical-align: -0.2083em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
   </blockquote> 
  </blockquote> 
 </blockquote> 
</blockquote> 
<h4>
<a id="23___214"></a>2.3 具体代码</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> gym
<span class="token keyword">import</span> time

<span class="token keyword">class</span> <span class="token class-name">QLearningAgent</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs_n<span class="token punctuation">,</span> act_n<span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token number">1e-2</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> e_greed<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>act_n <span class="token operator">=</span> act_n  <span class="token comment"># 动作维度，有几个动作可选</span>
        self<span class="token punctuation">.</span>lr <span class="token operator">=</span> learning_rate  <span class="token comment"># 学习率</span>
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> gamma  <span class="token comment"># reward的衰减率</span>
        self<span class="token punctuation">.</span>epsilon <span class="token operator">=</span> e_greed  <span class="token comment"># 按一定概率随机选动作</span>
        self<span class="token punctuation">.</span>Q <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>obs_n<span class="token punctuation">,</span> act_n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>epsilon<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 根据table的Q值选动作</span>
            action <span class="token operator">=</span> self<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>self<span class="token punctuation">.</span>act_n<span class="token punctuation">)</span>  <span class="token comment"># 有一定概率随机探索选取一个动作</span>
        <span class="token keyword">return</span> action
    <span class="token comment"># 根据输入观察值，预测输出的动作值</span>
    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        Q_list <span class="token operator">=</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        maxQ <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>Q_list<span class="token punctuation">)</span>
        action_list <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>Q_list <span class="token operator">==</span> maxQ<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># maxQ可能对应多个action</span>
        action <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>action_list<span class="token punctuation">)</span>
        <span class="token keyword">return</span> action
    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#(S,A,R,S)</span>
        predict_Q <span class="token operator">=</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">]</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            target_Q <span class="token operator">=</span> reward
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            target_Q <span class="token operator">=</span> reward <span class="token operator">+</span> self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>next_obs<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">]</span> <span class="token operator">+=</span> self<span class="token punctuation">.</span>lr <span class="token operator">*</span> <span class="token punctuation">(</span>target_Q <span class="token operator">-</span> predict_Q<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        npy_file <span class="token operator">=</span> <span class="token string">'./q-table.npy'</span>
        np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>npy_file<span class="token punctuation">,</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>npy_file <span class="token operator">+</span> <span class="token string">' saved.'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">load</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> npy_file<span class="token operator">=</span><span class="token string">'./q_table.npy'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>Q <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>npy_file<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>npy_file <span class="token operator">+</span> <span class="token string">' loaded.'</span><span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">run_episode</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> render<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 其实真正执行的策略和Sarsa是一样的，只不过学习的策略是保守的最优策略</span>
    total_steps <span class="token operator">=</span> <span class="token number">0</span>
    total_reward <span class="token operator">=</span> <span class="token number">0</span>
    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        action <span class="token operator">=</span> agent<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        next_obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        agent<span class="token punctuation">.</span>learn<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> done<span class="token punctuation">)</span>
        obs <span class="token operator">=</span> next_obs

        total_reward <span class="token operator">+=</span> reward
        total_steps <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> render<span class="token punctuation">:</span>
            env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> total_reward<span class="token punctuation">,</span> total_steps

<span class="token keyword">def</span> <span class="token function">test_episode</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    total_reward <span class="token operator">=</span> <span class="token number">0</span>
    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        action <span class="token operator">=</span> agent<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>  <span class="token comment"># greedy</span>
        next_obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        total_reward <span class="token operator">+=</span> reward
        obs <span class="token operator">=</span> next_obs
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
        env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> total_reward

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">"CliffWalking-v0"</span><span class="token punctuation">)</span>  <span class="token comment"># 0 up, 1 right, 2 down, 3 left</span>

    <span class="token comment"># 创建一个agent实例，输入超参数</span>
    agent <span class="token operator">=</span> QLearningAgent<span class="token punctuation">(</span>
        obs_n<span class="token operator">=</span>env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>n<span class="token punctuation">,</span>
        act_n<span class="token operator">=</span>env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n<span class="token punctuation">,</span>
        learning_rate<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
        gamma<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span>
        e_greed<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>

    <span class="token comment"># 训练500个episode，打印每个episode的分数</span>
    <span class="token keyword">for</span> episode <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ep_reward<span class="token punctuation">,</span> ep_steps <span class="token operator">=</span> run_episode<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Episode %s: steps = %s , reward = %.1f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>episode<span class="token punctuation">,</span> ep_steps<span class="token punctuation">,</span> ep_reward<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 全部训练结束，查看算法效果</span>
    test_reward <span class="token operator">=</span> test_episode<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'test reward = %.1f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>test_reward<span class="token punctuation">)</span><span class="token punctuation">)</span>

main<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h4>
<a id="24__314"></a>2.4 演示效果</h4> 
<p><img src="https://images2.imgbox.com/f1/64/j8pjzRu3_o.gif" alt="在这里插入图片描述"></p> 
<h3>
<a id="PG___319"></a>三、PG 策略梯度 (倒立摆)</h3> 
<h4>
<a id="31_CartPolev1_321"></a>3.1 CartPole-v1环境介绍</h4> 
<p>(<a href="https://www.gymlibrary.dev/environments/classic_control/cart_pole/?highlight=cartpole">Cart Pole - Gym Documentation (gymlibrary.dev)</a>)</p> 
<p>一根杆通过一个未驱动的关节连接到一辆小车上，小车沿着一条无摩擦的轨道移动。将钟摆垂直放置在推车上，目标是通过在推车上施加左右方向的力来平衡杆。</p> 
<p>倒立摆:<br> <img src="https://images2.imgbox.com/27/22/7h4DsD7z_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/e2/9c/1OqD17dg_o.png" alt="在这里插入图片描述"></p> 
<ul>
<li> <p><strong>obs: (1,4)</strong></p> 
  <table>
<thead><tr>
<th>Num</th>
<th>Observation</th>
<th>Min</th>
<th>Max</th>
</tr></thead>
<tbody>
<tr>
<td>0</td>
<td>Cart Position0</td>
<td>-4.8</td>
<td>4.8</td>
</tr>
<tr>
<td>1</td>
<td>Cart Velocity</td>
<td>-Inf</td>
<td>Inf</td>
</tr>
<tr>
<td>2</td>
<td>Pole Angle</td>
<td>-0.418 rad</td>
<td>0.418 rad</td>
</tr>
<tr>
<td>3</td>
<td>Pole Angular Velocity</td>
<td>-Inf</td>
<td>Inf</td>
</tr>
</tbody>
</table>
</li>
<li> <p><strong>action: (1,2)</strong></p> <p>动作空间是离散的:</p> 
  <table>
<thead><tr>
<th>Num</th>
<th>Action</th>
</tr></thead>
<tbody>
<tr>
<td>0</td>
<td>向左推车</td>
</tr>
<tr>
<td>1</td>
<td>向右推车</td>
</tr>
</tbody>
</table>
</li>
<li> <p><strong>reward</strong></p> <p>每活着经过一个时间步，奖励 + 1。</p> </li>
<li> <p><strong>终止条件:</strong></p> 
  <ul>
<li>① Pole Angle &gt; 12°</li>
<li>② |水平位置|&gt;2.4’</li>
<li>③ 超过500步</li>
</ul> </li>
</ul> 
<h4>
<a id="32_PGREINFORCE_363"></a>3.2 PG算法流程(REINFORCE)</h4> 
<blockquote> 
 <p>输入: 可微调的策略参数<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         π
        
        
         (
        
        
         a
        
        
         ∣
        
        
         s
        
        
         ,
        
        
         θ
        
        
         )
        
       
       
        pi(a|s,theta)
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0359em">π</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mord">∣</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="mclose">)</span></span></span></span></span></p> 
 <p>算法参数: 步长大小<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         α
        
        
         &gt;
        
        
         0
        
       
       
        alpha&gt;0
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em;vertical-align: -0.0391em"></span><span class="mord mathnormal" style="margin-right: 0.0037em">α</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6444em"></span><span class="mord">0</span></span></span></span></span></p> 
 <p>初始化的策略参数<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         θ
        
       
       
        theta
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span></span></span></span></span></p> 
</blockquote> 
<blockquote> 
 <p>循环(each trajectory):</p> 
 <blockquote> 
  <p>根据<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          π
         
         
          (
         
         
          ⋅
         
         
          ∣
         
         
          ⋅
         
         
          ,
         
         
          θ
         
         
          )
         
        
        
         pi(cdot|cdot,theta)
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0359em">π</span><span class="mopen">(</span><span class="mord">⋅</span><span class="mord">∣</span><span class="mord">⋅</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="mclose">)</span></span></span></span></span>，生成<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          
           S
          
          
           0
          
         
         
          ,
         
         
          
           A
          
          
           0
          
         
         
          ,
         
         
          
           R
          
          
           1
          
         
         
          ,
         
         
          .
         
         
          .
         
         
          .
         
         
          
           S
          
          
           
            T
           
           
            −
           
           
            1
           
          
         
         
          ,
         
         
          
           A
          
          
           
            T
           
           
            −
           
           
            1
           
          
         
         
          ,
         
         
          
           R
          
          
           T
          
         
        
        
         S_0,A_0,R_1,...S_{T-1},A_{T-1},R_{T}
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8917em;vertical-align: -0.2083em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: -0.0576em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0077em">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: -0.0077em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord">...</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em"><span class="" style="margin-left: -0.0576em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0077em">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em"><span class="" style="margin-left: -0.0077em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
  <p>对一个回合的每一步进行循环, <span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          t
         
         
          =
         
         
          0
         
         
          ,
         
         
          1
         
         
          ,
         
         
          .
         
         
          .
         
         
          .
         
         
          ,
         
         
          T
         
         
          −
         
         
          1
         
        
        
         t=0,1,...,T-1
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6151em"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.8778em;vertical-align: -0.1944em"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal" style="margin-right: 0.1389em">T</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 0.6444em"></span><span class="mord">1</span></span></span></span></span></p> 
  <blockquote> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           G
          
          
           =
          
          
           
            ∑
           
           
            
             k
            
            
             =
            
            
             t
            
            
             +
            
            
             1
            
           
           
            T
           
          
          
           
            γ
           
           
            
             k
            
            
             −
            
            
             t
            
            
             −
            
            
             1
            
           
          
          
           
            R
           
           
            k
           
          
         
         
          G = sum_{k=t+1}^{T} gamma^{k-t-1} R_k
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1.3393em;vertical-align: -0.358em"></span><span class="mop"><span class="mop op-symbol small-op">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9812em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em">k</span><span class="mrel mtight">=</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.358em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8491em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em">k</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0077em">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em"><span class="" style="margin-left: -0.0077em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           θ
          
          
           =
          
          
           θ
          
          
           +
          
          
           α
          
          
           
            γ
           
           
            t
           
          
          
           G
          
          
           ▽
          
          
           l
          
          
           n
          
          
           [
          
          
           π
          
          
           (
          
          
           
            a
           
           
            t
           
          
          
           ∣
          
          
           
            s
           
           
            t
           
          
          
           ,
          
          
           θ
          
          
           )
          
          
           ]
          
         
         
          theta = theta + alpha gamma^t G bigtriangledown ln[pi(a_t|s_t,theta)]
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.7778em;vertical-align: -0.0833em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 0.988em;vertical-align: -0.1944em"></span><span class="mord mathnormal" style="margin-right: 0.0037em">α</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0556em">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7936em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">▽</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0197em">l</span><span class="mord mathnormal">n</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right: 0.0359em">π</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="mclose">)]</span></span></span></span></span></p> 
  </blockquote> 
 </blockquote> 
</blockquote> 
<h4>
<a id="33__381"></a>3.3 具体代码</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> gym
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> Linear
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>distributions <span class="token keyword">import</span> Categorical
<span class="token keyword">import</span> time

lr <span class="token operator">=</span> <span class="token number">0.002</span>
gamma <span class="token operator">=</span> <span class="token number">0.8</span>

<span class="token keyword">class</span> <span class="token class-name">PGPolicy</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> hidden_size<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> output_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PGPolicy<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> Linear<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> Linear<span class="token punctuation">(</span>hidden_size<span class="token punctuation">,</span> output_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.6</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>saved_log_probs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment"># 记录每一步的动作概率</span>
        self<span class="token punctuation">.</span>rewards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment">#记录每一步的r</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        out <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out

<span class="token keyword">def</span> <span class="token function">choose_action</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> policy<span class="token punctuation">)</span><span class="token punctuation">:</span>
    state <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 在索引0对应位置增加一个维度</span>
    probs <span class="token operator">=</span> policy<span class="token punctuation">(</span>state<span class="token punctuation">)</span> 
    m <span class="token operator">=</span> Categorical<span class="token punctuation">(</span>probs<span class="token punctuation">)</span> <span class="token comment">#创建以参数probs为标准的类别分布,之后的m.sampe就会按此概率选择动作</span>
    action <span class="token operator">=</span> m<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">)</span>
    policy<span class="token punctuation">.</span>saved_log_probs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>m<span class="token punctuation">.</span>log_prob<span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> action<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#返回的就是int</span>

<span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>policy<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    R <span class="token operator">=</span> <span class="token number">0</span>
    policy_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    returns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> r <span class="token keyword">in</span> policy<span class="token punctuation">.</span>rewards<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        R <span class="token operator">=</span> r <span class="token operator">+</span> gamma<span class="token operator">*</span>R
        returns<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>R<span class="token punctuation">)</span><span class="token comment">#从头部插入，即反着插入</span>
    returns <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>returns<span class="token punctuation">)</span>
    <span class="token comment"># 归一化（均值方差），eps是一个非常小的数，避免除数为0</span>
    eps <span class="token operator">=</span> np<span class="token punctuation">.</span>finfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span><span class="token punctuation">.</span>eps<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
    returns <span class="token operator">=</span> <span class="token punctuation">(</span>returns <span class="token operator">-</span> returns<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>returns<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>  
    <span class="token keyword">for</span> log_prob<span class="token punctuation">,</span> R <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>policy<span class="token punctuation">.</span>saved_log_probs<span class="token punctuation">,</span> returns<span class="token punctuation">)</span><span class="token punctuation">:</span>
        policy_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token operator">-</span>log_prob<span class="token operator">*</span>R<span class="token punctuation">)</span>

    optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
    policy_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>policy_loss<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    policy_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">del</span> policy<span class="token punctuation">.</span>rewards<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 清空数据</span>
    <span class="token keyword">del</span> policy<span class="token punctuation">.</span>saved_log_probs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>episode_num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">'CartPole-v1'</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    policy <span class="token operator">=</span> PGPolicy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># policy.load_state_dict(torch.load('save_model.pt'))  # 模型导入</span>
    optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>policy<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token punctuation">)</span>
    average_r <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> episode_num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#采这么多轨迹</span>
        obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ep_r <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> t <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> choose_action<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> policy<span class="token punctuation">)</span>
            obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            policy<span class="token punctuation">.</span>rewards<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reward<span class="token punctuation">)</span>
            ep_r <span class="token operator">+=</span> reward
            <span class="token keyword">if</span> done<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        average_r <span class="token operator">=</span> <span class="token number">0.05</span> <span class="token operator">*</span> ep_r <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">0.05</span><span class="token punctuation">)</span> <span class="token operator">*</span> average_r
        learn<span class="token punctuation">(</span>policy<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Episode {}tLast reward: {:.2f}tAverage reward: {:.2f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ep_r<span class="token punctuation">,</span> average_r<span class="token punctuation">)</span><span class="token punctuation">)</span>

    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>policy<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'PGPolicy.pt'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">'CartPole-v1'</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    policy <span class="token operator">=</span> PGPolicy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    policy<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'PGPolicy.pt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 模型导入</span>
    average_r <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ep_r <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> t <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> choose_action<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> policy<span class="token punctuation">)</span>
            obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            policy<span class="token punctuation">.</span>rewards<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reward<span class="token punctuation">)</span>
            env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
            ep_r <span class="token operator">+=</span> reward
            <span class="token keyword">if</span> done<span class="token punctuation">:</span>
                <span class="token keyword">break</span>

train<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token comment">#  test()</span>
</code></pre> 
<h4>
<a id="34__496"></a>3.4 演示效果</h4> 
<p>训练过程:</p> 
<p><img src="https://images2.imgbox.com/bd/5a/2n4nKQY6_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/47/84/cz3ai5UN_o.gif" alt="在这里插入图片描述"></p> 
<h3>
<a id="PPO__507"></a>四、PPO (飞船降落)</h3> 
<h4>
<a id="41_LunarLanderv2_509"></a>4.1 LunarLander-v2环境介绍</h4> 
<p>（该环境需要安装box2d）</p> 
<p>https://www.gymlibrary.dev/environments/box2d/lunar_lander/?highlight=lunarlander</p> 
<p><img src="https://images2.imgbox.com/29/a6/Y6ua4T8W_o.png" alt="在这里插入图片描述"></p> 
<ul>
<li> <p><strong>observation (1,8)</strong></p> 
  <table>
<thead><tr>
<th>Num</th>
<th>Observation</th>
</tr></thead>
<tbody>
<tr>
<td>0</td>
<td>x</td>
</tr>
<tr>
<td>1</td>
<td>y</td>
</tr>
<tr>
<td>2</td>
<td><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
          
           
            
             
              
               V
              
              
               x
              
             
            
            
             V_x
            
           
          </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.2222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em"><span class="" style="margin-left: -0.2222em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>3</td>
<td><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
          
           
            
             
              
               V
              
              
               y
              
             
            
            
             V_y
            
           
          </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9694em;vertical-align: -0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.2222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em"><span class="" style="margin-left: -0.2222em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>4</td>
<td><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
          
           
            
             
              a
             
             
              n
             
             
              g
             
             
              l
             
             
              e
             
            
            
             angle
            
           
          </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em;vertical-align: -0.1944em"></span><span class="mord mathnormal">an</span><span class="mord mathnormal" style="margin-right: 0.0359em">g</span><span class="mord mathnormal" style="margin-right: 0.0197em">l</span><span class="mord mathnormal">e</span></span></span></span></span></span></td>
</tr>
<tr>
<td>5</td>
<td><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
          
           
            
             
              a
             
             
              n
             
             
              g
             
             
              u
             
             
              l
             
             
              a
             
             
              r
             
             
             
              v
             
             
              e
             
             
              l
             
             
              o
             
             
              c
             
             
              i
             
             
              t
             
             
              y
             
            
            
             angular quad velocity
            
           
          </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em;vertical-align: -0.1944em"></span><span class="mord mathnormal">an</span><span class="mord mathnormal">gu</span><span class="mord mathnormal" style="margin-right: 0.0197em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="mspace" style="margin-right: 1em"></span><span class="mord mathnormal" style="margin-right: 0.0359em">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.0197em">l</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right: 0.0359em">y</span></span></span></span></span></span></td>
</tr>
<tr>
<td>6</td>
<td>左腿是否触地(bool)</td>
</tr>
<tr>
<td>7</td>
<td>右腿是否触地(bool)</td>
</tr>
</tbody>
</table>
</li>
<li> <p><strong>action (1,4)</strong></p> 
  <table>
<thead><tr>
<th>Num</th>
<th>Action</th>
</tr></thead>
<tbody>
<tr>
<td>0</td>
<td>啥也不干</td>
</tr>
<tr>
<td>1</td>
<td>左侧点火</td>
</tr>
<tr>
<td>2</td>
<td>下面(主发动机)点火</td>
</tr>
<tr>
<td>3</td>
<td>右侧点火</td>
</tr>
</tbody>
</table>
</li>
<li> <p><strong>reward</strong></p> <p>从屏幕顶部移动到着陆台的奖励约为100-140分。如果着陆器没降落到陆台，它将失去奖励。如果着陆器坠毁，它将获得额外的-100分。如果它成功降落，它将获得额外的+100分。接地的每个支腿为+10点。每架主机点火-0.3分。侧面发动机每帧点火-0.03分。解决的是200分。</p> </li>
<li> <p><strong>终止条件</strong></p> 
  <ul>
<li>飞船与月球接触</li>
<li>飞船|x|&gt;1</li>
</ul> </li>
</ul> 
<h4>
<a id="42_PPOClip_549"></a>4.2 PPO-Clip算法流程</h4> 
<blockquote> 
 <p>初始化策略函数的参数<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          θ
         
         
          0
         
        
       
       
        theta_0
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8444em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span>, 初始化价值函数的参数<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          ϕ
         
         
          0
         
        
       
       
        phi_0
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em;vertical-align: -0.1944em"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
 <p><em>for k = 0,1,2,…</em></p> 
 <blockquote> 
  <p>基于<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          π
         
         
          (
         
         
          
           θ
          
          
           k
          
         
         
          )
         
        
        
         pi(theta_k)
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0359em">π</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>来采集轨迹组<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          
           D
          
          
           k
          
         
         
          =
         
         
          
           τ
          
          
           k
          
         
        
        
         D_k={tau_k}
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1132em">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em"><span class="" style="margin-left: -0.1132em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
  <p>计算<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          
           R
          
          
           t
          
         
        
        
         R_t
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0077em">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: -0.0077em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
  <p>计算<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          
           A
          
          
           t
          
         
        
        
         A_t
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
  <p>更新策略:<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          
           θ
          
          
           
            k
           
           
            +
           
           
            1
           
          
         
         
          =
         
         
          
           
            
             a
            
            
             r
            
            
             g
            
            
             m
            
            
             a
            
            
             x
            
           
           
            θ
           
          
         
         
          
           1
          
          
           
            ∣
           
           
            
             D
            
            
             k
            
           
           
            ∣
           
           
            T
           
          
         
         
          
           
            
             ∑
            
           
           
            τ
           
          
         
         
          
           
            
             ∑
            
           
           
            t
           
          
         
         
          m
         
         
          i
         
         
          n
         
         
          (
         
         
          
           
            
             π
            
            
             θ
            
           
           
            (
           
           
            
             a
            
            
             t
            
           
           
            ∣
           
           
            
             s
            
            
             t
            
           
           
            )
           
          
          
           
            
             π
            
            
             
              θ
             
             
              
              
               ′
              
             
            
           
           
            (
           
           
            
             a
            
            
             t
            
           
           
            ∣
           
           
            
             s
            
            
             t
            
           
           
            )
           
          
         
         
          A
         
         
          (
         
         
          
           s
          
          
           t
          
         
         
          ,
         
         
          
           a
          
          
           t
          
         
         
          )
         
         
          ,
         
         
         
          g
         
         
          (
         
         
          ϵ
         
         
          ,
         
         
          A
         
         
          (
         
         
          
           s
          
          
           t
          
         
         
          ,
         
         
          
           a
          
          
           t
          
         
         
          )
         
         
          )
         
         
          )
         
        
        
         theta_{k+1}=underset{theta}{argmax}frac{1}{|D_k|T}underset{tau }{sum}underset{t }{sum} min(frac{pi_theta(a_t|s_t)}{pi_{theta^{'}}(a_t|s_t)}A(s_t,a_t),quad g(epsilon,A(s_t,a_t)))
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9028em;vertical-align: -0.2083em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1.96em;vertical-align: -0.95em"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.4306em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em">θ</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class=""><span class="mop"><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="mord mathnormal" style="margin-right: 0.0359em">g</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9465em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: -0.0278em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1512em"><span class=""></span></span></span></span></span></span><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right: 0.1389em">T</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.52em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.75em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1132em">τ</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class=""><span class="mop op-symbol small-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.75em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class=""><span class="mop op-symbol small-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em"><span class=""></span></span></span></span></span></span><span class="mord mathnormal">min</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.01em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: -0.0359em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.8168em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1436em"><span class="" style="margin-right: 0.1em"><span class="pstrut" style="height: 2.8496em"></span><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8496em"><span class="" style="margin-right: 0.1em"><span class="pstrut" style="height: 2.5556em"></span><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.472em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2963em"><span class="" style="margin-left: 0em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mord mtight">∣</span><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2963em"><span class="" style="margin-left: 0em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: -0.0359em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1512em"><span class=""></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2963em"><span class="" style="margin-left: 0em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mord mtight">∣</span><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2963em"><span class="" style="margin-left: 0em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.6754em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 1em"></span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal" style="margin-right: 0.0359em">g</span><span class="mopen">(</span><span class="mord mathnormal">ϵ</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)))</span></span></span></span></span></p> 
  <p>更新价值函数: <span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          
           ϕ
          
          
           
            k
           
           
            +
           
           
            1
           
          
         
         
          =
         
         
          
           
            
             a
            
            
             r
            
            
             g
            
            
             m
            
            
             i
            
            
             n
            
           
           
            ϕ
           
          
         
         
          
           1
          
          
           
            ∣
           
           
            
             D
            
            
             k
            
           
           
            ∣
           
           
            T
           
          
         
         
          
           
            
             ∑
            
           
           
            τ
           
          
         
         
          
           
            
             ∑
            
           
           
            t
           
          
         
         
          (
         
         
          V
         
         
          (
         
         
          
           s
          
          
           t
          
         
         
          )
         
         
          −
         
         
          R
         
         
          
           )
          
          
           2
          
         
        
        
         phi_{k+1}=underset{phi}{argmin}frac{1}{|D_k|T}underset{tau }{sum}underset{t }{sum} (V(s_t)-R)^2
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9028em;vertical-align: -0.2083em"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1.9278em;vertical-align: -1.0827em"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6595em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class=""><span class="mop"><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="mord mathnormal" style="margin-right: 0.0359em">g</span><span class="mord mathnormal">min</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.0827em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: -0.0278em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1512em"><span class=""></span></span></span></span></span></span><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right: 0.1389em">T</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.52em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.75em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1132em">τ</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class=""><span class="mop op-symbol small-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.75em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class=""><span class="mop op-symbol small-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.2222em">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1.0641em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0077em">R</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p> 
 </blockquote> 
</blockquote> 
<h4>
<a id="43__565"></a>4.3 具体代码</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>distributions <span class="token keyword">import</span> Categorical
<span class="token keyword">import</span> gym

device <span class="token operator">=</span> <span class="token string">'cpu'</span>

<span class="token keyword">class</span> <span class="token class-name">Memory</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>actions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>states <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>logprobs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>rewards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>is_terminals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">clear_memory</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">del</span> self<span class="token punctuation">.</span>actions<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> self<span class="token punctuation">.</span>states<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> self<span class="token punctuation">.</span>logprobs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> self<span class="token punctuation">.</span>rewards<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> self<span class="token punctuation">.</span>is_terminals<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">ActorCritic</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> n_latent_var<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ActorCritic<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># actor</span>
        self<span class="token punctuation">.</span>action_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> n_latent_var<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                nn<span class="token punctuation">.</span>Tanh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_latent_var<span class="token punctuation">,</span> n_latent_var<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                nn<span class="token punctuation">.</span>Tanh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_latent_var<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                nn<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                                <span class="token punctuation">)</span>
        <span class="token comment"># critic</span>
        self<span class="token punctuation">.</span>value_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> n_latent_var<span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Tanh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_latent_var<span class="token punctuation">,</span> n_latent_var<span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Tanh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_latent_var<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 如果这个方法没有被子类重写，但是调用了，就会报错</span>
        <span class="token keyword">raise</span> NotImplementedError 
    <span class="token keyword">def</span> <span class="token function">act</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">,</span> memory<span class="token punctuation">)</span><span class="token punctuation">:</span>
        state <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> 
        action_probs <span class="token operator">=</span> self<span class="token punctuation">.</span>action_layer<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        dist <span class="token operator">=</span> Categorical<span class="token punctuation">(</span>action_probs<span class="token punctuation">)</span>
        action <span class="token operator">=</span> dist<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        memory<span class="token punctuation">.</span>states<span class="token punctuation">.</span>append<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        memory<span class="token punctuation">.</span>actions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        memory<span class="token punctuation">.</span>logprobs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dist<span class="token punctuation">.</span>log_prob<span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> action<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">:</span>
        action_probs <span class="token operator">=</span> self<span class="token punctuation">.</span>action_layer<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        dist <span class="token operator">=</span> Categorical<span class="token punctuation">(</span>action_probs<span class="token punctuation">)</span>
        
        action_logprobs <span class="token operator">=</span> dist<span class="token punctuation">.</span>log_prob<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        dist_entropy <span class="token operator">=</span> dist<span class="token punctuation">.</span>entropy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        state_value <span class="token operator">=</span> self<span class="token punctuation">.</span>value_layer<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> action_logprobs<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>state_value<span class="token punctuation">)</span><span class="token punctuation">,</span> dist_entropy

<span class="token keyword">class</span> <span class="token class-name">PPO</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> n_latent_var<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> betas<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> K_epochs<span class="token punctuation">,</span> eps_clip<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>lr <span class="token operator">=</span> lr
        self<span class="token punctuation">.</span>betas <span class="token operator">=</span> betas
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> gamma
        self<span class="token punctuation">.</span>eps_clip <span class="token operator">=</span> eps_clip
        self<span class="token punctuation">.</span>K_epochs <span class="token operator">=</span> K_epochs
        
        self<span class="token punctuation">.</span>policy <span class="token operator">=</span> ActorCritic<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> n_latent_var<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>policy<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">,</span> betas<span class="token operator">=</span>betas<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>policy_old <span class="token operator">=</span> ActorCritic<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> n_latent_var<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>policy_old<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>policy<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>MseLoss <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> memory<span class="token punctuation">)</span><span class="token punctuation">:</span>   
        <span class="token comment"># Monte Carlo estimate of state rewards:</span>
        rewards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        discounted_reward <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> reward<span class="token punctuation">,</span> is_terminal <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token builtin">reversed</span><span class="token punctuation">(</span>memory<span class="token punctuation">.</span>rewards<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>memory<span class="token punctuation">.</span>is_terminals<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> is_terminal<span class="token punctuation">:</span>
                discounted_reward <span class="token operator">=</span> <span class="token number">0</span>
            discounted_reward <span class="token operator">=</span> reward <span class="token operator">+</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> discounted_reward<span class="token punctuation">)</span>
            rewards<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> discounted_reward<span class="token punctuation">)</span>
        
        <span class="token comment"># Normalizing the rewards:</span>
        rewards <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>rewards<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        rewards <span class="token operator">=</span> <span class="token punctuation">(</span>rewards <span class="token operator">-</span> rewards<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>rewards<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1e-5</span><span class="token punctuation">)</span>
        
        <span class="token comment"># convert list to tensor</span>
        old_states <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>memory<span class="token punctuation">.</span>states<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        old_actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>memory<span class="token punctuation">.</span>actions<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        old_logprobs <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>memory<span class="token punctuation">.</span>logprobs<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        
        <span class="token comment"># Optimize policy for K epochs:</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>K_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># Evaluating old actions and values :</span>
            logprobs<span class="token punctuation">,</span> state_values<span class="token punctuation">,</span> dist_entropy <span class="token operator">=</span> self<span class="token punctuation">.</span>policy<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>old_states<span class="token punctuation">,</span> old_actions<span class="token punctuation">)</span>
            <span class="token comment"># Finding the ratio (pi_theta / pi_theta__old):</span>
            ratios <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>logprobs <span class="token operator">-</span> old_logprobs<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                
            <span class="token comment"># Finding Surrogate Loss:</span>
            advantages <span class="token operator">=</span> rewards <span class="token operator">-</span> state_values<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
            surr1 <span class="token operator">=</span> ratios <span class="token operator">*</span> advantages
            surr2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>ratios<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">-</span>self<span class="token punctuation">.</span>eps_clip<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">+</span>self<span class="token punctuation">.</span>eps_clip<span class="token punctuation">)</span> <span class="token operator">*</span> advantages
            loss <span class="token operator">=</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>surr1<span class="token punctuation">,</span> surr2<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">*</span>self<span class="token punctuation">.</span>MseLoss<span class="token punctuation">(</span>state_values<span class="token punctuation">,</span> rewards<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.01</span><span class="token operator">*</span>dist_entropy
            loss <span class="token operator">=</span>loss<span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
            <span class="token comment"># take gradient step</span>
            self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># Copy new weights into old policy:</span>
        self<span class="token punctuation">.</span>policy_old<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>policy<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">############## Hyperparameters ##############</span>
    env_name <span class="token operator">=</span> <span class="token string">'LunarLander-v2'</span><span class="token comment"># "LunarLander-v2"</span>
    <span class="token comment"># creating environment</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span>env_name<span class="token punctuation">)</span>
    env <span class="token operator">=</span> env<span class="token punctuation">.</span>unwrapped
    state_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    action_dim <span class="token operator">=</span>  <span class="token number">4</span>
    render <span class="token operator">=</span> <span class="token boolean">False</span>
    solved_reward <span class="token operator">=</span> <span class="token number">200</span>         <span class="token comment"># stop training if avg_reward &gt; solved_reward</span>
    log_interval <span class="token operator">=</span> <span class="token number">20</span>           <span class="token comment"># print avg reward in the interval</span>
    max_episodes <span class="token operator">=</span> <span class="token number">5000</span>        <span class="token comment"># max training episodes</span>
    max_timesteps <span class="token operator">=</span> <span class="token number">1000</span>         <span class="token comment"># max timesteps in one episode</span>
    n_latent_var <span class="token operator">=</span> <span class="token number">64</span>           <span class="token comment"># number of variables in hidden layer</span>
    update_timestep <span class="token operator">=</span> <span class="token number">2000</span>      <span class="token comment"># update policy every n timesteps</span>
    lr <span class="token operator">=</span> <span class="token number">0.002</span>
    betas <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">0.999</span><span class="token punctuation">)</span>
    gamma <span class="token operator">=</span> <span class="token number">0.99</span>                <span class="token comment"># discount factor</span>
    K_epochs <span class="token operator">=</span> <span class="token number">4</span>                <span class="token comment"># update policy using 1 trajectory for K epochs</span>
    eps_clip <span class="token operator">=</span> <span class="token number">0.2</span>              <span class="token comment"># clip parameter for PPO</span>
    random_seed <span class="token operator">=</span> <span class="token number">123</span>
    <span class="token comment">#############################################</span>
    
    <span class="token keyword">if</span> random_seed<span class="token punctuation">:</span>
        torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span>random_seed<span class="token punctuation">)</span>
        env<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>random_seed<span class="token punctuation">)</span>
    
    memory <span class="token operator">=</span> Memory<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ppo <span class="token operator">=</span> PPO<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> n_latent_var<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> betas<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> K_epochs<span class="token punctuation">,</span> eps_clip<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>lr<span class="token punctuation">,</span>betas<span class="token punctuation">)</span>
    
    <span class="token comment"># logging variables</span>
    running_reward <span class="token operator">=</span> <span class="token number">0</span>
    avg_length <span class="token operator">=</span> <span class="token number">0</span>
    timestep <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token comment"># training loop</span>
    <span class="token keyword">for</span> i_episode <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> max_episodes<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        state <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> t <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_timesteps<span class="token punctuation">)</span><span class="token punctuation">:</span>
            timestep <span class="token operator">+=</span> <span class="token number">1</span>
            
            <span class="token comment"># Running policy_old:</span>
            action <span class="token operator">=</span> ppo<span class="token punctuation">.</span>policy_old<span class="token punctuation">.</span>act<span class="token punctuation">(</span>state<span class="token punctuation">,</span> memory<span class="token punctuation">)</span>
            state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            
            <span class="token comment"># Saving reward and is_terminal:</span>
            memory<span class="token punctuation">.</span>rewards<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reward<span class="token punctuation">)</span>
            memory<span class="token punctuation">.</span>is_terminals<span class="token punctuation">.</span>append<span class="token punctuation">(</span>done<span class="token punctuation">)</span>
            <span class="token comment"># update if its time</span>
            <span class="token keyword">if</span> timestep <span class="token operator">%</span> update_timestep <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                ppo<span class="token punctuation">.</span>update<span class="token punctuation">(</span>memory<span class="token punctuation">)</span>
                memory<span class="token punctuation">.</span>clear_memory<span class="token punctuation">(</span><span class="token punctuation">)</span>
                timestep <span class="token operator">=</span> <span class="token number">0</span>
            
            running_reward <span class="token operator">+=</span> reward
            <span class="token keyword">if</span> render<span class="token punctuation">:</span>
                env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> done<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
                
        avg_length <span class="token operator">+=</span> t
        
        <span class="token comment"># stop training if avg_reward &gt; solved_reward</span>
        <span class="token keyword">if</span> running_reward <span class="token operator">&gt;</span> <span class="token punctuation">(</span>log_interval<span class="token operator">*</span>solved_reward<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"########## Solved! ##########"</span><span class="token punctuation">)</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>ppo<span class="token punctuation">.</span>policy<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'./PPO_{}_{}.pth'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>env_name<span class="token punctuation">,</span>lr<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
            
        <span class="token comment"># logging</span>
        <span class="token keyword">if</span> i_episode <span class="token operator">%</span> log_interval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            avg_length <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>avg_length<span class="token operator">/</span>log_interval<span class="token punctuation">)</span>
            running_reward <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>running_reward<span class="token operator">/</span>log_interval<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Episode {} t avg length: {} t reward: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i_episode<span class="token punctuation">,</span> avg_length<span class="token punctuation">,</span> running_reward<span class="token punctuation">)</span><span class="token punctuation">)</span>
            running_reward <span class="token operator">=</span> <span class="token number">0</span>
            avg_length <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> i_episode <span class="token operator">%</span> <span class="token number">2000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>ppo<span class="token punctuation">.</span>policy<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'./PPO_{}_{}.pth'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>env_name<span class="token punctuation">,</span>lr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">############## Hyperparameters ##############</span>
    env_name <span class="token operator">=</span> <span class="token string">"LunarLander-v2"</span>
    <span class="token comment"># creating environment</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span>env_name<span class="token punctuation">)</span>
    state_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    action_dim <span class="token operator">=</span> <span class="token number">4</span>
    render <span class="token operator">=</span> <span class="token boolean">False</span>
    max_timesteps <span class="token operator">=</span> <span class="token number">500</span>
    n_latent_var <span class="token operator">=</span> <span class="token number">64</span>           <span class="token comment"># number of variables in hidden layer</span>
    lr <span class="token operator">=</span> <span class="token number">0.0002</span>
    betas <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">0.999</span><span class="token punctuation">)</span>
    gamma <span class="token operator">=</span> <span class="token number">0.99</span>                <span class="token comment"># discount factor</span>
    K_epochs <span class="token operator">=</span> <span class="token number">4</span>                <span class="token comment"># update policy for K epochs</span>
    eps_clip <span class="token operator">=</span> <span class="token number">0.2</span>              <span class="token comment"># clip parameter for PPO</span>
    <span class="token comment">#############################################</span>

    n_episodes <span class="token operator">=</span> <span class="token number">3</span>
    max_timesteps <span class="token operator">=</span> <span class="token number">300</span>
    render <span class="token operator">=</span> <span class="token boolean">True</span>
    save_gif <span class="token operator">=</span> <span class="token boolean">False</span>

    filename <span class="token operator">=</span> <span class="token string">"PPO_{}_0.002.pth"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>env_name<span class="token punctuation">)</span>
    directory <span class="token operator">=</span> <span class="token string">"./"</span>
    
    memory <span class="token operator">=</span> Memory<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ppo <span class="token operator">=</span> PPO<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> n_latent_var<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> betas<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> K_epochs<span class="token punctuation">,</span> eps_clip<span class="token punctuation">)</span>
    
    ppo<span class="token punctuation">.</span>policy_old<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>directory<span class="token operator">+</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> ep <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n_episodes<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ep_reward <span class="token operator">=</span> <span class="token number">0</span>
        state <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> t <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_timesteps<span class="token punctuation">)</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> ppo<span class="token punctuation">.</span>policy_old<span class="token punctuation">.</span>act<span class="token punctuation">(</span>state<span class="token punctuation">,</span> memory<span class="token punctuation">)</span>
            state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            ep_reward <span class="token operator">+=</span> reward
            <span class="token keyword">if</span> render<span class="token punctuation">:</span>
                env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> done<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Episode: {}tReward: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ep_reward<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ep_reward <span class="token operator">=</span> <span class="token number">0</span>
        env<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
         
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># test()</span>
</code></pre> 
<h4>
<a id="44__822"></a>4.4 演示效果</h4> 
<p><img src="https://images2.imgbox.com/8b/ec/bOC5GB91_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/31/f2/qSCInCbr_o.gif" alt="在这里插入图片描述"></p> 
<h3>
<a id="DQN__830"></a>五、DQN (打砖块)</h3> 
<h4>
<a id="51_Breakoutv0_832"></a>5.1 Breakout-v0环境介绍</h4> 
<p><a href="https://www.gymlibrary.dev/environments/atari/breakout/?highlight=breakout">Breakout - Gym Documentation (gymlibrary.dev)</a></p> 
<p><img src="https://images2.imgbox.com/56/63/sPoRZDoq_o.png" alt="在这里插入图片描述"></p> 
<ul><li>observation (210,160,3)</li></ul> 
<p><img src="https://images2.imgbox.com/78/d6/EwmmChRT_o.png" alt="在这里插入图片描述"></p> 
<ul>
<li> <p>action (1,4)</p> 
  <table>
<thead><tr>
<th>Num</th>
<th>Action</th>
</tr></thead>
<tbody>
<tr>
<td>0</td>
<td>NOOP</td>
</tr>
<tr>
<td>1</td>
<td>FIRE</td>
</tr>
<tr>
<td>2</td>
<td>RIGHT</td>
</tr>
<tr>
<td>3</td>
<td>LEFT</td>
</tr>
</tbody>
</table>
</li>
<li> <p>reward</p> <p><img src="https://images2.imgbox.com/57/d9/5TUVTE5H_o.png" alt="在这里插入图片描述"></p> </li>
</ul> 
<h4>
<a id="52_DQN_860"></a>5.2 DQN算法流程</h4> 
<p>(带有经验回放池的DQN)</p> 
<blockquote> 
 <p>初始化经验回放池<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         D
        
       
       
        D
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">D</span></span></span></span></span>(容量为<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         N
        
       
       
        N
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em"></span><span class="mord mathnormal" style="margin-right: 0.109em">N</span></span></span></span></span>)</p> 
 <p>随机初始化 动作-价值 函数<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         Q
        
       
       
        Q
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em;vertical-align: -0.1944em"></span><span class="mord mathnormal">Q</span></span></span></span></span></p> 
 <p><em>for (each episode)</em></p> 
 <blockquote> 
  <p>初始化序列<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          
           s
          
          
           1
          
         
         
          =
         
         
          [
         
         
          
           x
          
          
           1
          
         
         
          ]
         
        
        
         s_1=[x_1]
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span>,预处理<span class="katex--inline"><span class="katex"><span class="katex-mathml">
      
       
        
         
          
           ϕ
          
          
           1
          
         
         
          =
         
         
          ϕ
         
         
          (
         
         
          
           s
          
          
           1
          
         
         
          )
         
        
        
         phi_1=phi(s_1)
        
       
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em;vertical-align: -0.1944em"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
  <p><em>for (each step)</em></p> 
  <blockquote> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            a
           
           
            t
           
          
          
           =
          
          
           
            
             
              m
             
             
              a
             
             
              x
             
            
            
             a
            
           
          
          
           
            Q
           
           
            ∗
           
          
          
           (
          
          
           ϕ
          
          
           (
          
          
           
            s
           
           
            t
           
          
          
           )
          
          
           ,
          
          
           a
          
          
           :
          
          
           θ
          
          
           )
          
         
         
          a_t=underset{a}{max}Q^*(phi(s_t),a:theta)
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1.45em;vertical-align: -0.7em"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.4306em"><span class="" style="margin-left: 0em"><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class=""><span class="mop"><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7em"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="mclose">)</span></span></span></span></span> (概率=1-<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           ϵ
          
         
         
          epsilon
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em"></span><span class="mord mathnormal">ϵ</span></span></span></span></span>)</p> 
   <p>执行<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            a
           
           
            t
           
          
         
         
          a_t
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span>，得到<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            r
           
           
            t
           
          
         
         
          r_t
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span></span></span></span></span>和图片<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            x
           
           
            
             t
            
            
             +
            
            
             1
            
           
          
         
         
          x_{t+1}
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6389em;vertical-align: -0.2083em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            s
           
           
            
             t
            
            
             +
            
            
             1
            
           
          
          
           =
          
          
           
            s
           
           
            t
           
          
          
           ,
          
          
           
            ϕ
           
           
            
             t
            
            
             +
            
            
             1
            
           
          
          
           =
          
          
           ϕ
          
          
           (
          
          
           
            s
           
           
            
             t
            
            
             +
            
            
             1
            
           
          
          
           )
          
         
         
          s_{t+1}=s_t,phi_{t+1}=phi(s_{t+1})
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6389em;vertical-align: -0.2083em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.9028em;vertical-align: -0.2083em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
   <p>将<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           (
          
          
           
            ϕ
           
           
            t
           
          
          
           ,
          
          
           
            a
           
           
            t
           
          
          
           ,
          
          
           
            r
           
           
            t
           
          
          
           ,
          
          
           
            ϕ
           
           
            
             t
            
            
             +
            
            
             1
            
           
          
          
           )
          
         
         
          (phi_t,a_t,r_t,phi_{t+1})
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>存储进<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           D
          
         
         
          D
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">D</span></span></span></span></span></p> 
   <p>在<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           D
          
         
         
          D
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">D</span></span></span></span></span>中采样</p> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            y
           
           
            i
           
          
          
           =
          
          
           
            {
           
           
            
             
              
               
                
                 r
                
                
                 j
                
               
              
             
             
              
               
                
                 (
                
                
                 t
                
                
                 e
                
                
                 r
                
                
                 m
                
                
                 i
                
                
                 n
                
                
                 a
                
                
                 l
                
                
                
                 
                  ϕ
                 
                 
                  
                   j
                  
                  
                   +
                  
                  
                   1
                  
                 
                
                
                 )
                
               
              
             
            
            
             
              
               
                
                 
                  r
                 
                 
                  j
                 
                
                
                 +
                
                
                 γ
                
                
                 m
                
                
                 a
                
                
                 x
                
                
                 Q
                
                
                 (
                
                
                 
                  ϕ
                 
                 
                  
                   j
                  
                  
                   +
                  
                  
                   1
                  
                 
                
                
                 ,
                
                
                 
                  a
                 
                 
                  
                  
                   ′
                  
                 
                
                
                 ;
                
                
                 θ
                
                
                 )
                
               
              
             
             
              
               
                
                 (
                
                
                 n
                
                
                 o
                
                
                 n
                
                
                 −
                
                
                 t
                
                
                 e
                
                
                 r
                
                
                 m
                
                
                 i
                
                
                 n
                
                
                 a
                
                
                 l
                
                
                
                 
                  ϕ
                 
                 
                  
                   j
                  
                  
                   +
                  
                  
                   1
                  
                 
                
                
                 )
                
               
              
             
            
           
          
         
         
          y_i = left{begin{matrix} r_j &amp; (terminalquad phi_{j+1})\ r_j +gamma max Q( phi_{j+1},a^{'}; theta) &amp; (non-terminalquad phi_{j+1}) end{matrix}right.
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em;vertical-align: -0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: -0.0359em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 2.5025em;vertical-align: -1.0012em"></span><span class="minner"><span class="mopen delimcenter"><span class="delimsizing size3">{<!-- --></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.5012em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em"><span class=""></span></span></span></span></span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mord mathnormal">γma</span><span class="mord mathnormal">x</span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9425em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.5795em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8278em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.0012em"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em"></span><span class="arraycolsep" style="width: 0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.5012em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right: 0.0278em">er</span><span class="mord mathnormal">mina</span><span class="mord mathnormal" style="margin-right: 0.0197em">l</span><span class="mspace" style="margin-right: 1em"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right: 0.0278em">er</span><span class="mord mathnormal">mina</span><span class="mord mathnormal" style="margin-right: 0.0197em">l</span><span class="mspace" style="margin-right: 1em"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.0012em"><span class=""></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p> 
   <p>根据<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           (
          
          
           
            y
           
           
            i
           
          
          
           −
          
          
           Q
          
          
           (
          
          
           
            ϕ
           
           
            j
           
          
          
           ,
          
          
           
            a
           
           
            j
           
          
          
           :
          
          
           θ
          
          
           )
          
          
           
            )
           
           
            2
           
          
         
         
          (y_i-Q(phi_j,a_j:theta))^2
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: -0.0359em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1.0361em;vertical-align: -0.2861em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1.0641em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>进行梯度下降</p> 
  </blockquote> 
 </blockquote> 
</blockquote> 
<h4>
<a id="53__891"></a>5.3 具体代码</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> gym
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> Linear<span class="token punctuation">,</span> Conv2d<span class="token punctuation">,</span> ReLU
<span class="token keyword">import</span> PIL<span class="token punctuation">.</span>Image <span class="token keyword">as</span> Image

device<span class="token operator">=</span>torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span><span class="token string">"cpu"</span><span class="token punctuation">)</span>

<span class="token comment"># 经验池</span>
<span class="token keyword">class</span> <span class="token class-name">DQBReplayer</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># (S,A,R,S)</span>
        self<span class="token punctuation">.</span>memory <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token builtin">range</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'observation'</span><span class="token punctuation">,</span> <span class="token string">'action'</span><span class="token punctuation">,</span> <span class="token string">'reward'</span><span class="token punctuation">,</span> <span class="token string">'next_observation'</span><span class="token punctuation">,</span> <span class="token string">'done'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity
    <span class="token keyword">def</span> <span class="token function">store</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>self<span class="token punctuation">.</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> args
        self<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>self<span class="token punctuation">.</span>capacity
        self<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>count<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>capacity<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        indics <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>self<span class="token punctuation">.</span>count<span class="token punctuation">,</span> size<span class="token operator">=</span>size<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>self<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>indics<span class="token punctuation">,</span>field<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> field <span class="token keyword">in</span> self<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>

<span class="token comment"># Q-Network</span>
<span class="token keyword">class</span> <span class="token class-name">DQN_net</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DQN_net<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>classifier <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Linear<span class="token punctuation">(</span><span class="token number">3136</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Linear<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> output
    
<span class="token keyword">class</span> <span class="token class-name">DQN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DQN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>replayer_start_size <span class="token operator">=</span> <span class="token number">100000</span>
        self<span class="token punctuation">.</span>upon_times <span class="token operator">=</span> <span class="token number">20</span>
        self<span class="token punctuation">.</span>replayer <span class="token operator">=</span> DQBReplayer<span class="token punctuation">(</span>capacity<span class="token operator">=</span>self<span class="token punctuation">.</span>replayer_start_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>action_n <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n
        self<span class="token punctuation">.</span>image_stack <span class="token operator">=</span> input_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> <span class="token number">0.99</span>
        self<span class="token punctuation">.</span>image_shape <span class="token operator">=</span> <span class="token punctuation">(</span>input_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>e_net <span class="token operator">=</span> DQN_net<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t_net <span class="token operator">=</span> DQN_net<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>learn_step <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>max_learn_step <span class="token operator">=</span> <span class="token number">650000</span>
        self<span class="token punctuation">.</span>epsilon <span class="token operator">=</span> <span class="token number">1.</span>
        self<span class="token punctuation">.</span>start_learn <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">def</span> <span class="token function">get_next_state</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>state<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>observation<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        img<span class="token operator">=</span>Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>observation<span class="token punctuation">,</span><span class="token string">"RGB"</span><span class="token punctuation">)</span>
        img<span class="token operator">=</span>img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>self<span class="token punctuation">.</span>image_shape<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span>
        img<span class="token operator">=</span>np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>img<span class="token punctuation">.</span>getdata<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>img<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>img<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> state <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            next_state <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token operator">*</span>self<span class="token punctuation">.</span>image_stack<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            next_state <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>state<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>img<span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> next_state
    <span class="token keyword">def</span> <span class="token function">decide</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>state<span class="token punctuation">,</span>step<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>start_learn <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span> <span class="token comment">#前50000步随机选择</span>
            action <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> action
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>epsilon <span class="token operator">-=</span> <span class="token number">0.0000053</span>
        <span class="token keyword">if</span> step <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">:</span>
            <span class="token comment">#每局前三十步随机选择，中间30万，</span>
            <span class="token comment">#以一定概率（1-epsilon）通过神经网络选择，</span>
            <span class="token comment"># 最后30万次以0.99概率通过神经网络选择</span>
            action <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token builtin">max</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>epsilon<span class="token punctuation">,</span> <span class="token number">0.0005</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            state <span class="token operator">=</span> state<span class="token operator">/</span><span class="token number">128</span> <span class="token operator">-</span> <span class="token number">1</span>
            y <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            y <span class="token operator">=</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>e_net<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>learn_step<span class="token operator">%</span><span class="token number">2000</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"q value{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
            action <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> action
    
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sum_reward <span class="token operator">=</span> <span class="token number">0</span>
    store_count <span class="token operator">=</span> <span class="token number">0</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">'Breakout-v0'</span><span class="token punctuation">)</span>
    net <span class="token operator">=</span> DQN<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">84</span><span class="token punctuation">,</span><span class="token number">84</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    Load_Net <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">if</span> Load_Net<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
        load_net_path <span class="token operator">=</span> <span class="token string">'./epsiode_2575_reward_10.0.pkl'</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Load old net and the path is:"</span><span class="token punctuation">,</span>load_net_path<span class="token punctuation">)</span>
        net<span class="token punctuation">.</span>e_net <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>load_net_path<span class="token punctuation">)</span>
        net<span class="token punctuation">.</span>t_net <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>load_net_path<span class="token punctuation">)</span>
    max_score <span class="token operator">=</span> <span class="token number">0</span>
    mse <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mse <span class="token operator">=</span> mse<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
    opt <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>RMSprop<span class="token punctuation">(</span>net<span class="token punctuation">.</span>e_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.0015</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        lives <span class="token operator">=</span> <span class="token number">5</span>
        obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        state <span class="token operator">=</span> net<span class="token punctuation">.</span>get_next_state<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span>obs<span class="token punctuation">)</span>
        epoch_reward <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> i<span class="token operator">%</span><span class="token number">100</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{} times_game"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">':'</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'epoch_reward:{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch_reward<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> net<span class="token punctuation">.</span>decide<span class="token punctuation">(</span>state<span class="token punctuation">,</span>step<span class="token operator">=</span>step<span class="token punctuation">)</span>
            obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            next_state <span class="token operator">=</span> net<span class="token punctuation">.</span>get_next_state<span class="token punctuation">(</span>state<span class="token punctuation">,</span> obs<span class="token punctuation">)</span> 
            epoch_reward <span class="token operator">+=</span> reward
            net<span class="token punctuation">.</span>replayer<span class="token punctuation">.</span>store<span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_state<span class="token punctuation">,</span> done<span class="token punctuation">)</span>
            net<span class="token punctuation">.</span>learn_step <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">if</span> net<span class="token punctuation">.</span>learn_step <span class="token operator">&gt;=</span> net<span class="token punctuation">.</span>replayer_start_size <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">and</span> net<span class="token punctuation">.</span>learn_step <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> net<span class="token punctuation">.</span>start_learn <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
                    net<span class="token punctuation">.</span>start_learn <span class="token operator">=</span> <span class="token boolean">True</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Start Learn!'</span><span class="token punctuation">)</span>
                sample_n <span class="token operator">=</span> <span class="token number">32</span>
                states<span class="token punctuation">,</span> actions<span class="token punctuation">,</span> rewards<span class="token punctuation">,</span> next_states<span class="token punctuation">,</span> dones <span class="token operator">=</span> net<span class="token punctuation">.</span>replayer<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>sample_n<span class="token punctuation">)</span>
                states<span class="token punctuation">,</span> next_states <span class="token operator">=</span> states <span class="token operator">/</span> <span class="token number">128</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> next_states <span class="token operator">/</span> <span class="token number">128</span> <span class="token operator">-</span><span class="token number">1</span>
                rewards <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>rewards<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
                states<span class="token punctuation">,</span> next_states <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>next_states<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
                actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>actions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
                dones <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>dones<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
                q <span class="token operator">=</span> net<span class="token punctuation">.</span>e_net<span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> actions<span class="token punctuation">)</span>
                q_next <span class="token operator">=</span> net<span class="token punctuation">.</span>t_net<span class="token punctuation">(</span>next_states<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>sample_n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                tq <span class="token operator">=</span> rewards <span class="token operator">+</span> net<span class="token punctuation">.</span>gamma <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>done<span class="token punctuation">)</span> <span class="token operator">*</span> q_next
                loss <span class="token operator">=</span> mse<span class="token punctuation">(</span>q<span class="token punctuation">,</span> tq<span class="token punctuation">)</span>
                opt<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
                loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
                opt<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> net<span class="token punctuation">.</span>learn_step <span class="token operator">%</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>upon_times <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    net<span class="token punctuation">.</span>t_net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>net<span class="token punctuation">.</span>e_net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> net<span class="token punctuation">.</span>learn_step <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    loss_record <span class="token operator">=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    a_r <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>rewards<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                
            state <span class="token operator">=</span> next_state
            
            <span class="token keyword">if</span> done<span class="token punctuation">:</span>
                save_net_path <span class="token operator">=</span> <span class="token string">'./'</span>
                sum_reward<span class="token operator">+=</span>epoch_reward
                <span class="token keyword">if</span> epoch_reward <span class="token operator">&gt;</span> max_score<span class="token punctuation">:</span>
                    name <span class="token operator">=</span> <span class="token string">"epsiode_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span>learn_step<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_reward_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>epoch_reward<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".pkl"</span>
                    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>net<span class="token punctuation">.</span>e_net<span class="token punctuation">,</span> save_net_path<span class="token operator">+</span>name<span class="token punctuation">)</span>
                    max_score <span class="token operator">=</span> epoch_reward
                <span class="token keyword">elif</span> i <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    name <span class="token operator">=</span><span class="token string">"No."</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".pkl"</span>
                    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>net<span class="token punctuation">.</span>e_net<span class="token punctuation">,</span> save_net_path <span class="token operator">+</span> name<span class="token punctuation">)</span>
                <span class="token keyword">if</span> i<span class="token operator">%</span><span class="token number">10</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
                    sum_reward<span class="token operator">=</span><span class="token number">0</span>
                <span class="token keyword">break</span>
               
<span class="token keyword">import</span> cv2

<span class="token keyword">def</span> <span class="token function">PictureArray2Video</span><span class="token punctuation">(</span>pic_list<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token string">'./test.mp4'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h<span class="token punctuation">,</span>w<span class="token punctuation">,</span>_ <span class="token operator">=</span> pic_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pic_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pic_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>w<span class="token punctuation">)</span>
    writer <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">(</span>path<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>VideoWriter_fourcc<span class="token punctuation">(</span><span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'v'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
    total_frame <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pic_list<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>total_frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
        writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>pic_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    writer<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    sum_reward <span class="token operator">=</span> <span class="token number">0</span>
    store_count <span class="token operator">=</span> <span class="token number">0</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">'Breakout-v0'</span><span class="token punctuation">)</span>
    net <span class="token operator">=</span> DQN<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">84</span><span class="token punctuation">,</span><span class="token number">84</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    Load_Net <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">if</span> Load_Net<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
        load_net_path <span class="token operator">=</span> <span class="token string">'./epsiode_10219_reward_9.0.pkl'</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Load old net and the path is:"</span><span class="token punctuation">,</span>load_net_path<span class="token punctuation">)</span>
        net<span class="token punctuation">.</span>e_net <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>load_net_path<span class="token punctuation">)</span>
        net<span class="token punctuation">.</span>t_net <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>load_net_path<span class="token punctuation">)</span>
    max_score <span class="token operator">=</span> <span class="token number">0</span>
    mse <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mse <span class="token operator">=</span> mse<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
    

    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    state <span class="token operator">=</span> net<span class="token punctuation">.</span>get_next_state<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span>obs<span class="token punctuation">)</span>
    epoch_reward <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        action <span class="token operator">=</span> net<span class="token punctuation">.</span>decide<span class="token punctuation">(</span>state<span class="token punctuation">,</span>step<span class="token operator">=</span>step<span class="token punctuation">)</span>
        obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        pic <span class="token operator">=</span> env<span class="token punctuation">.</span>render<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'rgb_array'</span><span class="token punctuation">)</span>
        pic <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>pic<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
        next_state <span class="token operator">=</span> net<span class="token punctuation">.</span>get_next_state<span class="token punctuation">(</span>state<span class="token punctuation">,</span> obs<span class="token punctuation">)</span> 
        pics<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pic<span class="token punctuation">)</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            PictureArray2Video<span class="token punctuation">(</span>pics<span class="token punctuation">)</span>
            <span class="token keyword">break</span>   
</code></pre> 
<h4>
<a id="54__1109"></a>5.4 演示效果</h4> 
<p>这个我感觉要训练好久，我训练了两个小时，reward=11，然后停下了。</p> 
<p><img src="https://images2.imgbox.com/f5/04/iWfvlWjR_o.gif" alt="在这里插入图片描述"></p> 
<h3>
<a id="DDPG__1120"></a>六、DDPG (单摆)</h3> 
<h4>
<a id="61_Pendulumv1_1122"></a>6.1 Pendulum-v1环境介绍</h4> 
<p>https://www.gymlibrary.dev/environments/classic_control/pendulum/?highlight=pendulum+v1</p> 
<ul>
<li> <p>observation (1,3)</p> 
  <table>
<thead><tr>
<th>Num</th>
<th>Observation</th>
<th>Min</th>
<th>Max</th>
</tr></thead>
<tbody>
<tr>
<td>0</td>
<td>cos(theta)</td>
<td>-1</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>sin(angle)</td>
<td>-1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>角速度</td>
<td>-8.0</td>
<td>8.0</td>
</tr>
</tbody>
</table>
</li>
<li> <p>action （1，）</p> <p>力矩，大小在(-2,2)之前的值</p> </li>
<li> <p>奖励</p> <p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
       
        
         
          
           r
          
          
           =
          
          
           −
          
          
           (
          
          
           
            θ
           
           
            2
           
          
          
           +
          
          
           0.1
          
          
           ×
          
          
           
            ω
           
           
            2
           
          
          
           +
          
          
           0.001
          
          
           ×
          
          
           力
          
          
           
            矩
           
           
            2
           
          
          
           )
          
         
         
           r = -(theta^2 + 0.1×omega^2 + 0.001×力矩^2) 
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em"></span><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1.1141em;vertical-align: -0.25em"></span><span class="mord">−</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 0.7278em;vertical-align: -0.0833em"></span><span class="mord">0.1</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 0.9474em;vertical-align: -0.0833em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em">ω</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 0.7278em;vertical-align: -0.0833em"></span><span class="mord">0.001</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1.1141em;vertical-align: -0.25em"></span><span class="mord cjk_fallback">力</span><span class="mord"><span class="mord cjk_fallback">矩</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p> </li>
</ul> 
<h4>
<a id="62_DDPG_1147"></a>6.2 DDPG算法流程</h4> 
<blockquote> 
 <p>随机初始化 评论员<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         Q
        
        
         (
        
        
         s
        
        
         ,
        
        
         a
        
        
         ∣
        
        
         
          θ
         
         
          Q
         
        
        
         )
        
       
       
        Q(s,a|theta^Q)
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0913em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal">a</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>和 演员<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         μ
        
        
         (
        
        
         s
        
        
         ∣
        
        
         
          θ
         
         
          μ
         
        
        
         )
        
       
       
        mu(s|theta^mu)
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">μ</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6644em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">μ</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
 <p>初始化目标策略价值网络<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         Q
        
        
         
         
          ′
         
        
       
       
        Q{'}
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9463em;vertical-align: -0.1944em"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          θ
         
         
          
          
           ′
          
         
        
       
       
        theta^{'}
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9425em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9425em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.5795em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8278em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>，<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         
          θ
         
         
          
           Q
          
          
           
           
            ′
           
          
         
        
        
         =
        
        
         
          θ
         
         
          Q
         
        
        
         ,
        
        
         
          θ
         
         
          
           μ
          
          
           
           
            ′
           
          
         
        
        
         =
        
        
         
          θ
         
         
          μ
         
        
       
       
        theta^{Q^{'}}=theta^Q,theta^{mu^{'}}=theta^mu
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1445em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1445em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7815em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1164em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.6854em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9596em"><span class="" style="margin-right: 0.1em"><span class="pstrut" style="height: 2.5556em"></span><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1.3389em;vertical-align: -0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1445em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7815em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">μ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1164em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.6854em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9596em"><span class="" style="margin-right: 0.1em"><span class="pstrut" style="height: 2.5556em"></span><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.6944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6644em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">μ</span></span></span></span></span></span></span></span></span></span></span></span><br> 初始化经验回放池R</p> 
 <p><em>for (each episode)</em></p> 
 <blockquote> 
  <p><em>for (each step)</em></p> 
  <blockquote> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            a
           
           
            t
           
          
          
           =
          
          
           μ
          
          
           (
          
          
           
            s
           
           
            t
           
          
          
           ∣
          
          
           
            θ
           
           
            μ
           
          
          
           )
          
         
         
          a_t=mu(s_t|theta^{mu})
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathnormal">μ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6644em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">μ</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            s
           
           
            
             t
            
            
             +
            
            
             1
            
           
          
          
           ,
          
          
           
            r
           
           
            t
           
          
          
           ,
          
          
           d
          
          
           o
          
          
           n
          
          
           e
          
          
           
            ,
           
           
            =
           
          
          
           e
          
          
           n
          
          
           v
          
          
           .
          
          
           s
          
          
           t
          
          
           e
          
          
           p
          
          
           (
          
          
           
            a
           
           
            t
           
          
          
           )
          
         
         
          s_{t+1},r_t,done,_ = env.step(a_t)
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mpunct"><span class="mpunct">,</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1068em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mrel mtight">=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right: 0.0359em">v</span><span class="mord">.</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
   <p>将<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           (
          
          
           
            s
           
           
            t
           
          
          
           ,
          
          
           
            a
           
           
            t
           
          
          
           ,
          
          
           
            r
           
           
            t
           
          
          
           ,
          
          
           
            s
           
           
            
             t
            
            
             +
            
            
             1
            
           
          
          
           )
          
         
         
          (s_t,a_t,r_t,s_{t+1})
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>存储进<em>R</em></p> 
   <p>从R中采样N条轨迹<span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           (
          
          
           
            s
           
           
            i
           
          
          
           ,
          
          
           
            a
           
           
            i
           
          
          
           ,
          
          
           
            r
           
           
            i
           
          
          
           ,
          
          
           
            s
           
           
            
             i
            
            
             +
            
            
             1
            
           
          
          
           )
          
         
         
          (s_i,a_i,r_i,s_{i+1})
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            y
           
           
            i
           
          
          
           =
          
          
           
            r
           
           
            i
           
          
          
           +
          
          
           γ
          
          
           
            Q
           
           
            
            
             ′
            
           
          
          
           (
          
          
           
            s
           
           
            
             i
            
            
             +
            
            
             1
            
           
          
          
           ,
          
          
           
            μ
           
           
            
            
             ′
            
           
          
          
           (
          
          
           
            s
           
           
            
             i
            
            
             +
            
            
             1
            
           
          
          
           ∣
          
          
           
            θ
           
           
            
             Q
            
            
             
             
              ′
             
            
           
          
          
           )
          
          
           ∣
          
          
           
            θ
           
           
            
             Q
            
            
             
             
              ′
             
            
           
          
          
           )
          
         
         
          y_i = r_i + gamma Q^{'}(s_{i+1},mu^{'}(s_{i+1}|theta^{Q^{'}})|theta^{Q^{'}})
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em;vertical-align: -0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: -0.0359em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.7333em;vertical-align: -0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: -0.0278em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1.3945em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.0556em">γ</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9425em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.5795em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8278em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9425em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.5795em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8278em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em"><span class=""></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1445em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7815em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1164em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.6854em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9596em"><span class="" style="margin-right: 0.1em"><span class="pstrut" style="height: 2.5556em"></span><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1445em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7815em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1164em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.6854em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9596em"><span class="" style="margin-right: 0.1em"><span class="pstrut" style="height: 2.5556em"></span><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           L
          
          
           o
          
          
           s
          
          
           s
          
          
           =
          
          
           
            1
           
           
            N
           
          
          
           Σ
          
          
           (
          
          
           
            y
           
           
            i
           
          
          
           −
          
          
           Q
          
          
           (
          
          
           
            s
           
           
            i
           
          
          
           ,
          
          
           
            a
           
           
            i
           
          
          
           ∣
          
          
           
            θ
           
           
            Q
           
          
          
           )
          
          
           
            )
           
           
            2
           
          
         
         
          Loss = frac{1}{N}Sigma(y_i-Q(s_i,a_i|theta^{Q}))^2
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em"></span><span class="mord mathnormal">L</span><span class="mord mathnormal">oss</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1.1901em;vertical-align: -0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em">N</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">Σ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: -0.0359em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1.0913em;vertical-align: -0.25em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>, 更新评论员网络</p> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            ▽
           
           
            
             θ
            
            
             μ
            
           
          
          
           J
          
          
           =
          
          
           
            1
           
           
            N
           
          
          
           Σ
          
          
           
            ▽
           
           
            a
           
          
          
           Q
          
          
           (
          
          
           s
          
          
           ,
          
          
           a
          
          
           ∣
          
          
           
            θ
           
           
            Q
           
          
          
           )
          
          
           
            ∣
           
           
            
             s
            
            
             =
            
            
             
              s
             
             
              i
             
            
            
             ,
            
            
             a
            
            
             =
            
            
             μ
            
            
             (
            
            
             
              s
             
             
              i
             
            
            
             )
            
           
          
          
           
            ▽
           
           
            
             θ
            
            
             μ
            
           
          
          
           μ
          
          
           (
          
          
           s
          
          
           ∣
          
          
           
            θ
           
           
            μ
           
          
          
           )
          
          
           ∣
          
          
           
            )
           
           
            
             s
            
            
             i
            
           
          
         
         
          bigtriangledown _{theta^mu}J = frac{1}{N}Sigma bigtriangledown_a Q(s,a|theta^Q)|_{s=s_i,a=mu(s_i)}bigtriangledown_{theta^mu} mu(s|theta^mu)|)_{s_i}
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em;vertical-align: -0.1944em"></span><span class="mord"><span class="mbin">▽</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.5935em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">μ</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right: 0.0962em">J</span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 1.1901em;vertical-align: -0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em"><span class=""><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em">N</span></span></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="frac-line" style="border-bottom-width: 0.04em"></span></span><span class=""><span class="pstrut" style="height: 3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">Σ</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin"><span class="mbin">▽</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1.1965em;vertical-align: -0.3552em"></span><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em"></span><span class="mord mathnormal">a</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mrel mtight">=</span><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3281em"><span class="" style="margin-left: 0em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">a</span><span class="mrel mtight">=</span><span class="mord mathnormal mtight">μ</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3281em"><span class="" style="margin-left: 0em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin"><span class="mbin">▽</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.5935em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">μ</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1.0001em;vertical-align: -0.2501em"></span><span class="mord mathnormal">μ</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6644em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">μ</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∣</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em"><span class="" style="margin-left: 0em;margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3281em"><span class="" style="margin-left: 0em;margin-right: 0.0714em"><span class="pstrut" style="height: 2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2501em"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
   <p>更新目标网络:</p> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            θ
           
           
            
             Q
            
            
             
             
              ′
             
            
           
          
          
           =
          
          
           τ
          
          
           
            θ
           
           
            Q
           
          
          
           +
          
          
           (
          
          
           1
          
          
           −
          
          
           τ
          
          
           )
          
          
           
            θ
           
           
            
             Q
            
            
             
             
              ′
             
            
           
          
         
         
          theta^{Q^{'}} = tau theta^Q + (1-tau)theta^{Q^{'}}
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1445em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1445em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7815em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1164em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.6854em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9596em"><span class="" style="margin-right: 0.1em"><span class="pstrut" style="height: 2.5556em"></span><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.9247em;vertical-align: -0.0833em"></span><span class="mord mathnormal" style="margin-right: 0.1132em">τ</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1.3945em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1445em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7815em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1164em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.6854em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9596em"><span class="" style="margin-right: 0.1em"><span class="pstrut" style="height: 2.5556em"></span><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
   <p><span class="katex--inline"><span class="katex"><span class="katex-mathml">
       
        
         
          
           
            θ
           
           
            
             μ
            
            
             
             
              ′
             
            
           
          
          
           =
          
          
           τ
          
          
           
            θ
           
           
            μ
           
          
          
           +
          
          
           (
          
          
           1
          
          
           −
          
          
           τ
          
          
           )
          
          
           
            θ
           
           
            
             μ
            
            
             
             
              ′
             
            
           
          
         
         
          theta^{mu^{'}} = tau theta^mu + (1-tau)theta^{mu^{'}}
         
        
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1445em"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1445em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7815em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">μ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1164em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.6854em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9596em"><span class="" style="margin-right: 0.1em"><span class="pstrut" style="height: 2.5556em"></span><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em"></span></span><span class="base"><span class="strut" style="height: 0.7778em;vertical-align: -0.0833em"></span><span class="mord mathnormal" style="margin-right: 0.1132em">τ</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6644em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">μ</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em"></span></span><span class="base"><span class="strut" style="height: 1.3945em;vertical-align: -0.25em"></span><span class="mord mathnormal" style="margin-right: 0.1132em">τ</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1445em"><span class="" style="margin-right: 0.05em"><span class="pstrut" style="height: 2.7815em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">μ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1164em"><span class="" style="margin-right: 0.0714em"><span class="pstrut" style="height: 2.6854em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class=""></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9596em"><span class="" style="margin-right: 0.1em"><span class="pstrut" style="height: 2.5556em"></span><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
  </blockquote> 
 </blockquote> 
</blockquote> 
<h4>
<a id="63__1179"></a>6.3 具体代码</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> gym
<span class="token keyword">import</span> time

<span class="token comment">#####################  hyper parameters  ####################</span>
EPISODES <span class="token operator">=</span> <span class="token number">200</span>
EP_STEPS <span class="token operator">=</span> <span class="token number">200</span>
LR_ACTOR <span class="token operator">=</span> <span class="token number">0.001</span>
LR_CRITIC <span class="token operator">=</span> <span class="token number">0.002</span>
GAMMA <span class="token operator">=</span> <span class="token number">0.9</span>
TAU <span class="token operator">=</span> <span class="token number">0.01</span>
MEMORY_CAPACITY <span class="token operator">=</span> <span class="token number">10000</span>
BATCH_SIZE <span class="token operator">=</span> <span class="token number">32</span>
RENDER <span class="token operator">=</span> <span class="token boolean">False</span>
ENV_NAME <span class="token operator">=</span> <span class="token string">'Pendulum-v1'</span>

<span class="token comment">########################## DDPG Framework ######################</span>
<span class="token keyword">class</span> <span class="token class-name">ActorNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># define the network structure for actor and critic</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s_dim<span class="token punctuation">,</span> a_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ActorNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>s_dim<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token comment"># initialization of FC1</span>
        self<span class="token punctuation">.</span>out <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> a_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>out<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token comment"># initilizaiton of OUT</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>out<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">2</span> <span class="token comment"># for the game "Pendulum-v0", action range is [-2, 2]</span>
        <span class="token keyword">return</span> actions

<span class="token keyword">class</span> <span class="token class-name">CriticNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s_dim<span class="token punctuation">,</span> a_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CriticNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fcs <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>s_dim<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fcs<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fca <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>a_dim<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fca<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>out <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>out<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fcs<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>fca<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
        actions_value <span class="token operator">=</span> self<span class="token punctuation">.</span>out<span class="token punctuation">(</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token operator">+</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> actions_value
    
<span class="token keyword">class</span> <span class="token class-name">DDPG</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a_dim<span class="token punctuation">,</span> s_dim<span class="token punctuation">,</span> a_bound<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>a_dim<span class="token punctuation">,</span> self<span class="token punctuation">.</span>s_dim<span class="token punctuation">,</span> self<span class="token punctuation">.</span>a_bound <span class="token operator">=</span> a_dim<span class="token punctuation">,</span> s_dim<span class="token punctuation">,</span> a_bound
        self<span class="token punctuation">.</span>memory <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>MEMORY_CAPACITY<span class="token punctuation">,</span> s_dim <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> a_dim <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pointer <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment"># serves as updating the memory data </span>
        <span class="token comment"># Create the 4 network objects</span>
        self<span class="token punctuation">.</span>actor_eval <span class="token operator">=</span> ActorNet<span class="token punctuation">(</span>s_dim<span class="token punctuation">,</span> a_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>actor_target <span class="token operator">=</span> ActorNet<span class="token punctuation">(</span>s_dim<span class="token punctuation">,</span> a_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_eval <span class="token operator">=</span> CriticNet<span class="token punctuation">(</span>s_dim<span class="token punctuation">,</span> a_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_target <span class="token operator">=</span> CriticNet<span class="token punctuation">(</span>s_dim<span class="token punctuation">,</span> a_dim<span class="token punctuation">)</span>
        <span class="token comment"># create 2 optimizers for actor and critic</span>
        self<span class="token punctuation">.</span>actor_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>actor_eval<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>LR_ACTOR<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_eval<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>LR_CRITIC<span class="token punctuation">)</span>
        <span class="token comment"># Define the loss function for critic network update</span>
        self<span class="token punctuation">.</span>loss_func <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">store_transition</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">,</span> a<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s_<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># how to store the episodic data to buffer</span>
        transition <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">,</span> s_<span class="token punctuation">)</span><span class="token punctuation">)</span>
        index <span class="token operator">=</span> self<span class="token punctuation">.</span>pointer <span class="token operator">%</span> MEMORY_CAPACITY <span class="token comment"># replace the old data with new data </span>
        self<span class="token punctuation">.</span>memory<span class="token punctuation">[</span>index<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> transition
        self<span class="token punctuation">.</span>pointer <span class="token operator">+=</span> <span class="token number">1</span>
    
    <span class="token keyword">def</span> <span class="token function">choose_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># print(s)</span>
        s <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>actor_eval<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># softly update the target networks</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>actor_target<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">'self.actor_target.'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'.data.mul_((1-TAU))'</span><span class="token punctuation">)</span>
            <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">'self.actor_target.'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'.data.add_(TAU*self.actor_eval.'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'.data)'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>critic_target<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">'self.critic_target.'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'.data.mul_((1-TAU))'</span><span class="token punctuation">)</span>
            <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">'self.critic_target.'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'.data.add_(TAU*self.critic_eval.'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">'.data)'</span><span class="token punctuation">)</span>           
        <span class="token comment"># sample from buffer a mini-batch data</span>
        indices <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>MEMORY_CAPACITY<span class="token punctuation">,</span> size<span class="token operator">=</span>BATCH_SIZE<span class="token punctuation">)</span>
        batch_trans <span class="token operator">=</span> self<span class="token punctuation">.</span>memory<span class="token punctuation">[</span>indices<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token comment"># extract data from mini-batch of transitions including s, a, r, s_</span>
        batch_s <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>batch_trans<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>self<span class="token punctuation">.</span>s_dim<span class="token punctuation">]</span><span class="token punctuation">)</span>
        batch_a <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>batch_trans<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>s_dim<span class="token punctuation">:</span>self<span class="token punctuation">.</span>s_dim <span class="token operator">+</span> self<span class="token punctuation">.</span>a_dim<span class="token punctuation">]</span><span class="token punctuation">)</span>
        batch_r <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>batch_trans<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>s_dim <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>s_dim<span class="token punctuation">]</span><span class="token punctuation">)</span>
        batch_s_ <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>batch_trans<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>s_dim<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># make action and evaluate its action values</span>
        a <span class="token operator">=</span> self<span class="token punctuation">.</span>actor_eval<span class="token punctuation">(</span>batch_s<span class="token punctuation">)</span>
        q <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_eval<span class="token punctuation">(</span>batch_s<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
        actor_loss <span class="token operator">=</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
        <span class="token comment"># optimize the loss of actor network</span>
        self<span class="token punctuation">.</span>actor_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        actor_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>actor_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># compute the target Q value using the information of next state</span>
        a_target <span class="token operator">=</span> self<span class="token punctuation">.</span>actor_target<span class="token punctuation">(</span>batch_s_<span class="token punctuation">)</span>
        q_tmp <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_target<span class="token punctuation">(</span>batch_s_<span class="token punctuation">,</span> a_target<span class="token punctuation">)</span>
        q_target <span class="token operator">=</span> batch_r <span class="token operator">+</span> GAMMA <span class="token operator">*</span> q_tmp
        <span class="token comment"># compute the current q value and the loss</span>
        q_eval <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_eval<span class="token punctuation">(</span>batch_s<span class="token punctuation">,</span> batch_a<span class="token punctuation">)</span>
        td_error <span class="token operator">=</span> self<span class="token punctuation">.</span>loss_func<span class="token punctuation">(</span>q_target<span class="token punctuation">,</span> q_eval<span class="token punctuation">)</span>
        <span class="token comment"># optimize the loss of critic network</span>
        self<span class="token punctuation">.</span>critic_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        td_error<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
<span class="token comment">############################### Training ######################################</span>
<span class="token comment"># Define the env in gym</span>
env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span>ENV_NAME<span class="token punctuation">)</span>
env <span class="token operator">=</span> env<span class="token punctuation">.</span>unwrapped
env<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
s_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
a_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
a_bound <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>high
a_low_bound <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>low

ddpg <span class="token operator">=</span> DDPG<span class="token punctuation">(</span>a_dim<span class="token punctuation">,</span> s_dim<span class="token punctuation">,</span> a_bound<span class="token punctuation">)</span>
var <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment"># the controller of exploration which will decay during training process</span>
t1 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>EPISODES<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ep_r <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>EP_STEPS<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> RENDER<span class="token punctuation">:</span> env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># add explorative noise to action</span>
        a <span class="token operator">=</span> ddpg<span class="token punctuation">.</span>choose_action<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        a <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span>a<span class="token punctuation">,</span> var<span class="token punctuation">)</span><span class="token punctuation">,</span> a_low_bound<span class="token punctuation">,</span> a_bound<span class="token punctuation">)</span>
        s_<span class="token punctuation">,</span> r<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
        ddpg<span class="token punctuation">.</span>store_transition<span class="token punctuation">(</span>s<span class="token punctuation">,</span> a<span class="token punctuation">,</span> r <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">,</span> s_<span class="token punctuation">)</span> <span class="token comment"># store the transition to memory</span>
        
        <span class="token keyword">if</span> ddpg<span class="token punctuation">.</span>pointer <span class="token operator">&gt;</span> MEMORY_CAPACITY<span class="token punctuation">:</span>
            var <span class="token operator">*=</span> <span class="token number">0.9995</span> <span class="token comment"># decay the exploration controller factor</span>
            ddpg<span class="token punctuation">.</span>learn<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
        s <span class="token operator">=</span> s_
        ep_r <span class="token operator">+=</span> r
        <span class="token keyword">if</span> j <span class="token operator">==</span> EP_STEPS <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Episode: '</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">' Reward: %i'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ep_r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Explore: %.2f'</span> <span class="token operator">%</span> var<span class="token punctuation">)</span>
            <span class="token keyword">if</span> ep_r <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">300</span> <span class="token punctuation">:</span> RENDER <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">break</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Running time: '</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t1<span class="token punctuation">)</span>
    
       
            
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    learn<span class="token punctuation">(</span><span class="token punctuation">)</span>    
    env<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    

</code></pre> 
<h4>
<a id="64__1342"></a>6.4 演示效果</h4> 
<p><img src="https://images2.imgbox.com/91/c8/tD7y8o91_o.gif" alt="在这里插入图片描述"></p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>