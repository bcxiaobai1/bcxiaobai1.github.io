<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Android 窗口结构(一) 窗口层级构造 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 窗口结构(一) 窗口层级构造</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <p>  Android窗口是根据显示屏幕来管理，每个显示屏幕的窗口层级分为37层，0-36层。每层可以放置多个窗口，上层窗口覆盖下面的。<br>   要理解窗口的结构，需要学习下WindowContainer、RootWindowContainer、DisplayContent、TaskDisplayArea、Task、ActivityRecord、WindowToken、WindowState<br> WindowContainer等类。</p> 
<h3>
<a id="WindowContainer_3"></a>WindowContainer类</h3> 
<p>  为直接包含窗口或者通过孩子层级形式包含窗口的类，定义了普遍功能。它作为基类被继承，像RootWindowContainer、DisplayContent、TaskDisplayArea、Task、ActivityRecord、WindowToken、WindowState都是直接或间接的继承该类。</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">WindowContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">WindowContainer</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ConfigurationContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WindowContainer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Animatable</span><span class="token punctuation">,</span> <span class="token class-name">SurfaceFreezer<span class="token punctuation">.</span>Freezable</span> <span class="token punctuation">{<!-- --></span>
    ……
    <span class="token comment">// List of children for this window container. List is in z-order as the children appear on</span>
    <span class="token comment">// screen with the top-most window container at the tail of the list.</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">WindowList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> mChildren <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        	
    ……
        <span class="token punctuation">}</span>
</code></pre> 
<p>  简单看一下类的定义，泛型参数E是继承WindowContainer，它是孩子类型。WindowList是继承ArrayList，这样就能通过mChildren ，构建一种树形结构。</p> 
<h3>
<a id="_17"></a>窗口结构层级相关类</h3> 
<p>  先上一张没添加特色模式窗口结构图：<br> <img src="https://images2.imgbox.com/82/ab/ECOFkFht_o.png" alt="窗口结构图"></p> 

  没添加特色模式窗口结构图 
 
<p>  该图是未添加特色模式时的结构图，添加特色模式之后的结构，更复杂。<br>   RootWindowContainer：根窗口容器，树的根是它。通过它遍历寻找，可以找到窗口树上的窗口。它的孩子是DisplayContent。<br>   DisplayContent：该类是对应着显示屏幕的，Android是支持多屏幕的，所以可能存在多个DisplayContent对象。上图只画了一个对象的结构，其他对象的结构也是和画的对象的结构是相似的。<br>   TaskDisplayArea：它为DisplayContent的孩子，对应着窗口层次的第2层。第2层作为应用层，看它的定义：int APPLICATION_LAYER = 2，应用层的窗口是处于第2层。TaskDisplayArea的孩子是Task类，其实它的孩子类型也可以是TaskDisplayArea。而Task的孩子则可以是ActivityRecord，也可以是Task。<br>   Tokens：它为DisplayContent的孩子，它的孩子是WindowToken。而WindowToken的孩子则为WindowState对象。WindowState是对应着一个窗口的。结构图中，DisplayContent不止包含一个Tokens，还有两个。其实ImeContainer也是继承自Tokens。<br>   ImeContainer：它也为DisplayContent的孩子，它是输入法窗口的容器，它的孩子是WindowToken类型。WindowToken的孩子为WindowState类型，而WindowState类型则对应着输入法窗口。<br>   Task：任务，它的孩子可以是Task，也可以是ActivityRecord类型。<br>   ActivityRecord：是对应着应用进程中的Activity的。ActivityRecord是继承WindowToken的，它的孩子类型为WindowState。<br>   WindowState：WindowState是对应着一个窗口的。<br>   结构图中，DisplayContent有5个孩子。图中从上到下，第一个是Tokens，对应着窗口图层0、1。第二个是TaskDisplayArea，对应着窗口图层2。第三个是Tokens，对应着窗口图层3到14。第四个是ImeContainer，对应着窗口图层15到16。第五个是Tokens，对应着窗口图层17到36。</p> 
<h3>
<a id="_32"></a>构建窗口结构</h3> 
<p>  下面结合代码来看下上面的窗口结构的构造。<br>   RootWindowContainer的构造是在WindowManagerService中，</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">WindowManagerService</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">InputManagerService</span> inputManager<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> showBootMsgs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">,</span> <span class="token class-name">WindowManagerPolicy</span> policy<span class="token punctuation">,</span>
            <span class="token class-name">ActivityTaskManagerService</span> atm<span class="token punctuation">,</span> <span class="token class-name">DisplayWindowSettingsProvider</span>
            displayWindowSettingsProvider<span class="token punctuation">,</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SurfaceControl<span class="token punctuation">.</span>Transaction</span><span class="token punctuation">&gt;</span></span> transactionFactory<span class="token punctuation">,</span>
            <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Surface</span><span class="token punctuation">&gt;</span></span> surfaceFactory<span class="token punctuation">,</span>
            <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SurfaceSession</span><span class="token punctuation">,</span> <span class="token class-name">SurfaceControl<span class="token punctuation">.</span>Builder</span><span class="token punctuation">&gt;</span></span> surfaceControlFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ……
            mRoot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootWindowContainer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			……
    <span class="token punctuation">}</span>
</code></pre> 
<p>  可见RootWindowContainer对象作为WindowManagerService的成员变量mRoot 存在。<br>   在ActivityTaskManagerService类中，会调用setWindowManager(WindowManagerService wm)方法，</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWindowManager</span><span class="token punctuation">(</span><span class="token class-name">WindowManagerService</span> wm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mWindowManager <span class="token operator">=</span> wm<span class="token punctuation">;</span>
            mRootWindowContainer <span class="token operator">=</span> wm<span class="token punctuation">.</span>mRoot<span class="token punctuation">;</span>
            mTempConfig<span class="token punctuation">.</span><span class="token function">setToDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mTempConfig<span class="token punctuation">.</span><span class="token function">setLocales</span><span class="token punctuation">(</span><span class="token class-name">LocaleList</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mConfigurationSeq <span class="token operator">=</span> mTempConfig<span class="token punctuation">.</span>seq <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            mRootWindowContainer<span class="token punctuation">.</span><span class="token function">onConfigurationChanged</span><span class="token punctuation">(</span>mTempConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLockTaskController<span class="token punctuation">.</span><span class="token function">setWindowManager</span><span class="token punctuation">(</span>wm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mTaskSupervisor<span class="token punctuation">.</span><span class="token function">setWindowManager</span><span class="token punctuation">(</span>wm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mRootWindowContainer<span class="token punctuation">.</span><span class="token function">setWindowManager</span><span class="token punctuation">(</span>wm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  ActivityTaskManagerService的成员变量mRootWindowContainer 也赋值为RootWindowContainer根对象。最后会调用RootWindowContainer的setWindowManager(wm)方法：</p> 
<pre><code class="prism language-java">    <span class="token keyword">void</span> <span class="token function">setWindowManager</span><span class="token punctuation">(</span><span class="token class-name">WindowManagerService</span> wm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mWindowManager <span class="token operator">=</span> wm<span class="token punctuation">;</span>
        mDisplayManager <span class="token operator">=</span> mService<span class="token punctuation">.</span>mContext<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">DisplayManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDisplayManager<span class="token punctuation">.</span><span class="token function">registerDisplayListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mUiHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDisplayManagerInternal <span class="token operator">=</span> <span class="token class-name">LocalServices</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">DisplayManagerInternal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">Display</span><span class="token punctuation">[</span><span class="token punctuation">]</span> displays <span class="token operator">=</span> mDisplayManager<span class="token punctuation">.</span><span class="token function">getDisplays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> displayNdx <span class="token operator">&lt;</span> displays<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">Display</span> display <span class="token operator">=</span> displays<span class="token punctuation">[</span>displayNdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">DisplayContent</span> displayContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayContent</span><span class="token punctuation">(</span>display<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addChild</span><span class="token punctuation">(</span>displayContent<span class="token punctuation">,</span> <span class="token constant">POSITION_BOTTOM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>displayContent<span class="token punctuation">.</span>mDisplayId <span class="token operator">==</span> <span class="token constant">DEFAULT_DISPLAY</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mDefaultDisplay <span class="token operator">=</span> displayContent<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">calculateDefaultMinimalSizeOfResizeableTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">TaskDisplayArea</span> defaultTaskDisplayArea <span class="token operator">=</span> <span class="token function">getDefaultTaskDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        defaultTaskDisplayArea<span class="token punctuation">.</span><span class="token function">getOrCreateRootHomeTask</span><span class="token punctuation">(</span><span class="token constant">ON_TOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">positionChildAt</span><span class="token punctuation">(</span><span class="token constant">POSITION_TOP</span><span class="token punctuation">,</span> defaultTaskDisplayArea<span class="token punctuation">.</span>mDisplayContent<span class="token punctuation">,</span>
                <span class="token boolean">false</span> <span class="token comment">/* includingParents */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  从上面看出，通过屏幕管理对象mDisplayManager得到所有的显示屏幕，然后构造DisplayContent对象，再通过addChild(displayContent, POSITION_BOTTOM)方法将DisplayContent对象添加到RootWindowContainer根对象的树状结构中。<br>   默认显示屏幕的mDisplayId 是DEFAULT_DISPLAY，看下它的值（Display类 public static final int DEFAULT_DISPLAY = 0），mDisplayId 为0作为基本显示屏幕。<br>   接着通过getDefaultTaskDisplayArea()得到默认屏幕的TaskDisplayArea，在调用它的getOrCreateRootHomeTask(ON_TOP)创建一个根Home任务。最后把默认屏幕放在RootWindowContainer根对象的孩子的最上面。<br>   接下来看看DisplayContent对象的构造函数。</p> 
<h4>
<a id="DisplayContent_96"></a>DisplayContent对象的构造</h4> 
<pre><code class="prism language-java">    <span class="token comment">// Contains all IME window containers. Note that the z-ordering of the IME windows will depend</span>
    <span class="token comment">// on the IME target. We mainly have this container grouping so we can keep track of all the IME</span>
    <span class="token comment">// window containers together and move them in-sync if/when needed. We use a subclass of</span>
    <span class="token comment">// WindowContainer which is omitted from screen magnification, as the IME is never magnified.</span>
    <span class="token comment">// TODO(display-area): is "no magnification" in the comment still true?</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ImeContainer</span> mImeWindowsContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImeContainer</span><span class="token punctuation">(</span>mWmService<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token comment">/**
     * Create new {@link DisplayContent} instance, add itself to the root window container and
     * initialize direct children.
     * @param display May not be null.
     * @param root {@link RootWindowContainer}
     */</span>
    <span class="token class-name">DisplayContent</span><span class="token punctuation">(</span><span class="token class-name">Display</span> display<span class="token punctuation">,</span> <span class="token class-name">RootWindowContainer</span> root<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	……
        <span class="token comment">// Setup the policy and build the display area hierarchy.</span>
        mDisplayAreaPolicy <span class="token operator">=</span> mWmService<span class="token punctuation">.</span><span class="token function">getDisplayAreaPolicyProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>
                mWmService<span class="token punctuation">,</span> <span class="token keyword">this</span> <span class="token comment">/* content */</span><span class="token punctuation">,</span> <span class="token keyword">this</span> <span class="token comment">/* root */</span><span class="token punctuation">,</span> mImeWindowsContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		……
    <span class="token punctuation">}</span>		
</code></pre> 
<p>  这里将窗口构建的相关代码贴出来，<br>   mWmService是WindowManagerService对象，它的getDisplayAreaPolicyProvider()得到</p> 
<pre><code class="prism language-java">    <span class="token class-name">DisplayAreaPolicy<span class="token punctuation">.</span>Provider</span> <span class="token function">getDisplayAreaPolicyProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mDisplayAreaPolicyProvider<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  mDisplayAreaPolicyProvider是WindowManagerService对象的成员变量，它初始化在WindowManagerService对象的初始化方法中：</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">WindowManagerService</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">InputManagerService</span> inputManager<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> showBootMsgs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyCore<span class="token punctuation">,</span> <span class="token class-name">WindowManagerPolicy</span> policy<span class="token punctuation">,</span>
            <span class="token class-name">ActivityTaskManagerService</span> atm<span class="token punctuation">,</span> <span class="token class-name">DisplayWindowSettingsProvider</span>
            displayWindowSettingsProvider<span class="token punctuation">,</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SurfaceControl<span class="token punctuation">.</span>Transaction</span><span class="token punctuation">&gt;</span></span> transactionFactory<span class="token punctuation">,</span>
            <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Surface</span><span class="token punctuation">&gt;</span></span> surfaceFactory<span class="token punctuation">,</span>
            <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SurfaceSession</span><span class="token punctuation">,</span> <span class="token class-name">SurfaceControl<span class="token punctuation">.</span>Builder</span><span class="token punctuation">&gt;</span></span> surfaceControlFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>     
            …………   
        mDisplayAreaPolicyProvider <span class="token operator">=</span> <span class="token class-name">DisplayAreaPolicy<span class="token punctuation">.</span>Provider</span><span class="token punctuation">.</span><span class="token function">fromResources</span><span class="token punctuation">(</span>
                mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           …………
           <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Provider</span> <span class="token punctuation">{<!-- --></span>
    …………
            <span class="token keyword">static</span> <span class="token class-name">Provider</span> <span class="token function">fromResources</span><span class="token punctuation">(</span><span class="token class-name">Resources</span> res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>
                    <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span>R</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>config_deviceSpecificDisplayAreaPolicyProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DisplayAreaPolicy<span class="token punctuation">.</span>DefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Provider</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ReflectiveOperationException</span> <span class="token operator">|</span> <span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Couldn't instantiate class "</span> <span class="token operator">+</span> name
                        <span class="token operator">+</span> <span class="token string">" for config_deviceSpecificDisplayAreaPolicyProvider:"</span>
                        <span class="token operator">+</span> <span class="token string">" make sure it has a public zero-argument constructor"</span>
                        <span class="token operator">+</span> <span class="token string">" and implements DisplayAreaPolicy.Provider"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  可以看到mDisplayAreaPolicyProvider 的具体类型是可以在系统资源文件中配置的，资源字符串属性为config_deviceSpecificDisplayAreaPolicyProvider，如果为空，类型则为DefaultProvider类型。目前查看，资源文件里没有配置字符值。所以mDisplayAreaPolicyProvider类型则为DefaultProvider类型。<br>   接着调用DefaultProvider的instantiate()方法，该方法在文件platformframeworksbaseservicescorejavacomandroidserverwmDisplayAreaPolicy.java中</p> 
<pre><code class="prism language-java">    <span class="token comment">/** Provider for platform-default display area policy. */</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DefaultProvider</span> <span class="token keyword">implements</span> <span class="token class-name">DisplayAreaPolicy<span class="token punctuation">.</span>Provider</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">DisplayAreaPolicy</span> <span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token class-name">WindowManagerService</span> wmService<span class="token punctuation">,</span>
                <span class="token class-name">DisplayContent</span> content<span class="token punctuation">,</span> <span class="token class-name">RootDisplayArea</span> root<span class="token punctuation">,</span>
                <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Tokens</span> imeContainer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">TaskDisplayArea</span> defaultTaskDisplayArea <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskDisplayArea</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> wmService<span class="token punctuation">,</span>
                    <span class="token string">"DefaultTaskDisplayArea"</span><span class="token punctuation">,</span> <span class="token constant">FEATURE_DEFAULT_TASK_CONTAINER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskDisplayArea</span><span class="token punctuation">&gt;</span></span> tdaList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tdaList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>defaultTaskDisplayArea<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Define the features that will be supported under the root of the whole logical</span>
            <span class="token comment">// display. The policy will build the DisplayArea hierarchy based on this.</span>
            <span class="token keyword">final</span> <span class="token class-name">HierarchyBuilder</span> rootHierarchy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HierarchyBuilder</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Set the essential containers (even if the display doesn't support IME).</span>
            rootHierarchy<span class="token punctuation">.</span><span class="token function">setImeContainer</span><span class="token punctuation">(</span>imeContainer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTaskDisplayAreas</span><span class="token punctuation">(</span>tdaList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">isTrusted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Only trusted display can have system decorations.</span>
                <span class="token function">configureTrustedHierarchyBuilder</span><span class="token punctuation">(</span>rootHierarchy<span class="token punctuation">,</span> wmService<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Instantiate the policy with the hierarchy defined above. This will create and attach</span>
            <span class="token comment">// all the necessary DisplayAreas to the root.</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DisplayAreaPolicyBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRootHierarchy</span><span class="token punctuation">(</span>rootHierarchy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>wmService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		…………
    <span class="token punctuation">}</span>
</code></pre> 
<p>  首先新建一个TaskDisplayArea 对象defaultTaskDisplayArea ，看其名字叫默认TaskDisplayArea。接着创建HierarchyBuilder 对象rootHierarchy 。rootHierarchy 将imeContainer（输入法窗口容器）和刚才新建的defaultTaskDisplayArea 都设置到它的成员变量里面。<br>   接着再判断显示屏是否是可信任的content.isTrusted()，一般系统创建的都设置为可信任的，包括默认显示屏幕。会调用configureTrustedHierarchyBuilder(rootHierarchy, wmService, content)方法进行配置，这个方法里面主要是添加一些特色模式。<br>   最后，也是采用建造者模式新建DisplayAreaPolicyBuilder对象，然后将前面设置好的rootHierarchy对象设置到自己成员变量中，最后调用build()方法，进行建造。构造完成之后，返回的是一个Result对象，它继承DisplayAreaPolicy。所以从这里可知，DisplayContent的mDisplayAreaPolicy 是Result对象。</p> 
<h5>
<a id="1HierarchyBuilder__198"></a>1、HierarchyBuilder 对象设置</h5> 
<pre><code class="prism language-java">    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HierarchyBuilder</span> <span class="token punctuation">{<!-- --></span>
    	……
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RootDisplayArea</span> mRoot<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DisplayAreaPolicyBuilder<span class="token punctuation">.</span>Feature</span><span class="token punctuation">&gt;</span></span> mFeatures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskDisplayArea</span><span class="token punctuation">&gt;</span></span> mTaskDisplayAreas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Nullable</span>
        <span class="token keyword">private</span> <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Tokens</span> mImeContainer<span class="token punctuation">;</span>

        <span class="token class-name">HierarchyBuilder</span><span class="token punctuation">(</span><span class="token class-name">RootDisplayArea</span> root<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token comment">/** Adds {@link Feature} that applies to layers under this container. */</span>
        <span class="token class-name">HierarchyBuilder</span> <span class="token function">addFeature</span><span class="token punctuation">(</span><span class="token class-name">DisplayAreaPolicyBuilder<span class="token punctuation">.</span>Feature</span> feature<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mFeatures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         <span class="token comment">/**
         * Sets {@link TaskDisplayArea} that are children of this hierarchy root.
         * {@link DisplayArea} group must have at least one {@link TaskDisplayArea}.
         */</span>
        <span class="token class-name">HierarchyBuilder</span> <span class="token function">setTaskDisplayAreas</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskDisplayArea</span><span class="token punctuation">&gt;</span></span> taskDisplayAreas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mTaskDisplayAreas<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mTaskDisplayAreas<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>taskDisplayAreas<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/** Sets IME container as a child of this hierarchy root. */</span>
        <span class="token class-name">HierarchyBuilder</span> <span class="token function">setImeContainer</span><span class="token punctuation">(</span><span class="token class-name">DisplayArea<span class="token punctuation">.</span>Tokens</span> imeContainer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mImeContainer <span class="token operator">=</span> imeContainer<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ……
<span class="token punctuation">}</span>           	
</code></pre> 
<p>  rootHierarchy.setImeContainer(imeContainer).setTaskDisplayAreas(tdaList)就是将imeContainer设置到rootHierarchy对象的成员变量mImeContainer，将tdaList添加到成员变量mTaskDisplayAreas。</p> 
<h5>
<a id="2_236"></a>2、添加特色模式</h5> 
<pre><code class="prism language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">configureTrustedHierarchyBuilder</span><span class="token punctuation">(</span><span class="token class-name">HierarchyBuilder</span> rootHierarchy<span class="token punctuation">,</span>
                <span class="token class-name">WindowManagerService</span> wmService<span class="token punctuation">,</span> <span class="token class-name">DisplayContent</span> content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// WindowedMagnification should be on the top so that there is only one surface</span>
            <span class="token comment">// to be magnified.</span>
            rootHierarchy<span class="token punctuation">.</span><span class="token function">addFeature</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Feature<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>wmService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">,</span> <span class="token string">"WindowedMagnification"</span><span class="token punctuation">,</span>
                    <span class="token constant">FEATURE_WINDOWED_MAGNIFICATION</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">upTo</span><span class="token punctuation">(</span><span class="token constant">TYPE_ACCESSIBILITY_MAGNIFICATION_OVERLAY</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">except</span><span class="token punctuation">(</span><span class="token constant">TYPE_ACCESSIBILITY_MAGNIFICATION_OVERLAY</span><span class="token punctuation">)</span>
                    <span class="token comment">// Make the DA dimmable so that the magnify window also mirrors the dim layer.</span>
                    <span class="token punctuation">.</span><span class="token function">setNewDisplayAreaSupplier</span><span class="token punctuation">(</span><span class="token class-name">DisplayArea<span class="token punctuation">.</span>Dimmable</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span>isDefaultDisplay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Only default display can have cutout.</span>
                <span class="token comment">// See LocalDisplayAdapter.LocalDisplayDevice#getDisplayDeviceInfoLocked.</span>
                rootHierarchy<span class="token punctuation">.</span><span class="token function">addFeature</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Feature<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>wmService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">,</span> <span class="token string">"HideDisplayCutout"</span><span class="token punctuation">,</span>
                        <span class="token constant">FEATURE_HIDE_DISPLAY_CUTOUT</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">except</span><span class="token punctuation">(</span><span class="token constant">TYPE_NAVIGATION_BAR</span><span class="token punctuation">,</span> <span class="token constant">TYPE_NAVIGATION_BAR_PANEL</span><span class="token punctuation">,</span> <span class="token constant">TYPE_STATUS_BAR</span><span class="token punctuation">,</span>
                                <span class="token constant">TYPE_NOTIFICATION_SHADE</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">addFeature</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Feature<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>wmService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">,</span>
                                <span class="token string">"OneHandedBackgroundPanel"</span><span class="token punctuation">,</span>
                                <span class="token constant">FEATURE_ONE_HANDED_BACKGROUND_PANEL</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">upTo</span><span class="token punctuation">(</span><span class="token constant">TYPE_WALLPAPER</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">addFeature</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Feature<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>wmService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">,</span> <span class="token string">"OneHanded"</span><span class="token punctuation">,</span>
                                <span class="token constant">FEATURE_ONE_HANDED</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">except</span><span class="token punctuation">(</span><span class="token constant">TYPE_NAVIGATION_BAR</span><span class="token punctuation">,</span> <span class="token constant">TYPE_NAVIGATION_BAR_PANEL</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            rootHierarchy
                    <span class="token punctuation">.</span><span class="token function">addFeature</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Feature<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>wmService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">,</span> <span class="token string">"FullscreenMagnification"</span><span class="token punctuation">,</span>
                            <span class="token constant">FEATURE_FULLSCREEN_MAGNIFICATION</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">except</span><span class="token punctuation">(</span><span class="token constant">TYPE_ACCESSIBILITY_MAGNIFICATION_OVERLAY</span><span class="token punctuation">,</span> <span class="token constant">TYPE_INPUT_METHOD</span><span class="token punctuation">,</span>
                                    <span class="token constant">TYPE_INPUT_METHOD_DIALOG</span><span class="token punctuation">,</span> <span class="token constant">TYPE_MAGNIFICATION_OVERLAY</span><span class="token punctuation">,</span>
                                    <span class="token constant">TYPE_NAVIGATION_BAR</span><span class="token punctuation">,</span> <span class="token constant">TYPE_NAVIGATION_BAR_PANEL</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">addFeature</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Feature<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>wmService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">,</span> <span class="token string">"ImePlaceholder"</span><span class="token punctuation">,</span>
                            <span class="token constant">FEATURE_IME_PLACEHOLDER</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token constant">TYPE_INPUT_METHOD</span><span class="token punctuation">,</span> <span class="token constant">TYPE_INPUT_METHOD_DIALOG</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>  可见，主要采用特色模式建造类Feature.Builder，设置属性，设置完成之后，添加到HierarchyBuilder 类对象rootHierarchy中。<br>   添加的特色模式有FEATURE_WINDOWED_MAGNIFICATION、FEATURE_HIDE_DISPLAY_CUTOUT、FEATURE_ONE_HANDED_BACKGROUND_PANEL、FEATURE_ONE_HANDED、FEATURE_FULLSCREEN_MAGNIFICATION、FEATURE_IME_PLACEHOLDER。只有在屏幕是默认基础的屏幕情况下，才会添加FEATURE_HIDE_DISPLAY_CUTOUT、FEATURE_ONE_HANDED_BACKGROUND_PANEL、FEATURE_ONE_HANDED这三种。<br>   在设置特色模式的时候，还会设置对哪些窗口图层产生影响。窗口图层和窗口类型是相关的，可以通过窗口类型得到窗口所在的图层层级。先看看特色模式建造者类：</p> 
<h6>
<a id="_287"></a>特色模式建造者类</h6> 
<div class="mermaid sequence-diagram"> 
  
  #mermaid-svg-vE95wItUr0OOQH5S {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-vE95wItUr0OOQH5S .error-icon{fill:#552222;}#mermaid-svg-vE95wItUr0OOQH5S .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-vE95wItUr0OOQH5S .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-vE95wItUr0OOQH5S .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-vE95wItUr0OOQH5S .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-vE95wItUr0OOQH5S .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-vE95wItUr0OOQH5S .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-vE95wItUr0OOQH5S .marker{fill:#333333;stroke:#333333;}#mermaid-svg-vE95wItUr0OOQH5S .marker.cross{stroke:#333333;}#mermaid-svg-vE95wItUr0OOQH5S svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-vE95wItUr0OOQH5S g.classGroup text{fill:#9370DB;fill:#131300;stroke:none;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:10px;}#mermaid-svg-vE95wItUr0OOQH5S g.classGroup text .title{font-weight:bolder;}#mermaid-svg-vE95wItUr0OOQH5S .nodeLabel,#mermaid-svg-vE95wItUr0OOQH5S .edgeLabel{color:#131300;}#mermaid-svg-vE95wItUr0OOQH5S .edgeLabel .label rect{fill:#ECECFF;}#mermaid-svg-vE95wItUr0OOQH5S .label text{fill:#131300;}#mermaid-svg-vE95wItUr0OOQH5S .edgeLabel .label span{background:#ECECFF;}#mermaid-svg-vE95wItUr0OOQH5S .classTitle{font-weight:bolder;}#mermaid-svg-vE95wItUr0OOQH5S .node rect,#mermaid-svg-vE95wItUr0OOQH5S .node circle,#mermaid-svg-vE95wItUr0OOQH5S .node ellipse,#mermaid-svg-vE95wItUr0OOQH5S .node polygon,#mermaid-svg-vE95wItUr0OOQH5S .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-vE95wItUr0OOQH5S .divider{stroke:#9370DB;stroke:1;}#mermaid-svg-vE95wItUr0OOQH5S g.clickable{cursor:pointer;}#mermaid-svg-vE95wItUr0OOQH5S g.classGroup rect{fill:#ECECFF;stroke:#9370DB;}#mermaid-svg-vE95wItUr0OOQH5S g.classGroup line{stroke:#9370DB;stroke-width:1;}#mermaid-svg-vE95wItUr0OOQH5S .classLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5;}#mermaid-svg-vE95wItUr0OOQH5S .classLabel .label{fill:#9370DB;font-size:10px;}#mermaid-svg-vE95wItUr0OOQH5S .relation{stroke:#333333;stroke-width:1;fill:none;}#mermaid-svg-vE95wItUr0OOQH5S .dashed-line{stroke-dasharray:3;}#mermaid-svg-vE95wItUr0OOQH5S #compositionStart,#mermaid-svg-vE95wItUr0OOQH5S .composition{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-vE95wItUr0OOQH5S #compositionEnd,#mermaid-svg-vE95wItUr0OOQH5S .composition{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-vE95wItUr0OOQH5S #dependencyStart,#mermaid-svg-vE95wItUr0OOQH5S .dependency{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-vE95wItUr0OOQH5S #dependencyStart,#mermaid-svg-vE95wItUr0OOQH5S .dependency{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-vE95wItUr0OOQH5S #extensionStart,#mermaid-svg-vE95wItUr0OOQH5S .extension{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-vE95wItUr0OOQH5S #extensionEnd,#mermaid-svg-vE95wItUr0OOQH5S .extension{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-vE95wItUr0OOQH5S #aggregationStart,#mermaid-svg-vE95wItUr0OOQH5S .aggregation{fill:#ECECFF!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-vE95wItUr0OOQH5S #aggregationEnd,#mermaid-svg-vE95wItUr0OOQH5S .aggregation{fill:#ECECFF!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-vE95wItUr0OOQH5S .edgeTerminals{font-size:11px;}#mermaid-svg-vE95wItUr0OOQH5S :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;} 
   
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
     
     
     
      
       
       
       
       
        
        <div> 
         <span class="nodeLabel"></span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">Builder</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">WindowManagerPolicy mPolicy</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">String mName</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">int mId</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">boolean[] mLayers</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">NewDisplayAreaSupplier mNewDisplayAreaSupplier = DisplayArea::new</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">boolean mExcludeRoundedCorner = true</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">Builder(WindowManagerPolicy policy, String name, int id)</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">all()</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">and(int... types)</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">except(int... types)</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">upTo(int typeInclusive)</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">setNewDisplayAreaSupplier(NewDisplayAreaSupplier newDisplayAreaSupplier)</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">setExcludeRoundedCornerOverlay(boolean excludeRoundedCorner)</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">build()</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">set(int type, boolean value)</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">layerFromType(int type, boolean internalWindows)</span> 
        </div> 
        
       
      
     
    
   
  
</div> 
<p>  mName和mId是特色模式的名字和Id。<br>   mLayers数组大小是37，对应着窗口层级。如果对应的层级设置为true，就是该模式对该窗口层级产生影响。<br>   mNewDisplayAreaSupplier是如何新建DisplayArea，默认是DisplayArea::new。<br>   mPolicy是和窗口类型和图层层级转化有关<br>   mExcludeRoundedCorner是指是否排除圆角层，默认是排除的<br>   set(int type, boolean value)，layerFromType(int type, boolean internalWindows)是通过图层类型得到图层数，然后设置图层数对应的mLayers数组中的值。<br>   特色模型类建造类中的all()、and()、except()、upTo()，他们都是为了设置对应的窗口层级。all()是所有的层级都设置为true。and()是将参数中对应的层级设置为true，except()是将参数中对应的层级设置为false，就是去除掉该层级。upTo()则是将第0层直到参数指定的层级都设置为true。<br>   build()方法就是新建Feature对象，在其中会判断mExcludeRoundedCorner，如果为true，则将mLayers数组中对应的值设为false，目前圆角层是在最上层36层。<br>   窗口类型和层级的转化是通过layerFromType(int type, boolean internalWindows)实现，它则是mPolicy.getWindowLayerFromTypeLw(type, internalWindows)方法实现的，mPolicy是WindowManagerPolicy类型，看下代码：</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Returns the layer assignment for the window type. Allows you to control how different
     * kinds of windows are ordered on-screen.
     *
     * @param type The type of window being assigned.
     * @param canAddInternalSystemWindow If the owner window associated with the type we are
     *        evaluating can add internal system windows. I.e they have
     *        {@link Manifest.permission#INTERNAL_SYSTEM_WINDOW}. If true, alert window
     *        types {@link android.view.WindowManager.LayoutParams#isSystemAlertWindowType(int)}
     *        can be assigned layers greater than the layer for
     *        {@link android.view.WindowManager.LayoutParams#TYPE_APPLICATION_OVERLAY} Else, their
     *        layers would be lesser.
     * @param roundedCornerOverlay {#code true} to indicate that the owner window is rounded corner
     *                             overlay.
     * @return int An arbitrary integer used to order windows, with lower numbers below higher ones.
     */</span>
    <span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">getWindowLayerFromTypeLw</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">boolean</span> canAddInternalSystemWindow<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> roundedCornerOverlay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Always put the rounded corner layer to the top most.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>roundedCornerOverlay <span class="token operator">&amp;&amp;</span> canAddInternalSystemWindow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">getMaxWindowLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">&gt;=</span> <span class="token constant">FIRST_APPLICATION_WINDOW</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">&lt;=</span> <span class="token constant">LAST_APPLICATION_WINDOW</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token constant">APPLICATION_LAYER</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_WALLPAPER</span><span class="token operator">:</span>
                <span class="token comment">// wallpaper is at the bottom, though the window manager may move it.</span>
                <span class="token keyword">return</span>  <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_PRESENTATION</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_PRIVATE_PRESENTATION</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_DOCK_DIVIDER</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_QS_DIALOG</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_PHONE</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_SEARCH_BAR</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_VOICE_INTERACTION_STARTING</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_VOICE_INTERACTION</span><span class="token operator">:</span>
                <span class="token comment">// voice interaction layer is almost immediately above apps.</span>
                <span class="token keyword">return</span>  <span class="token number">5</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_INPUT_CONSUMER</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">6</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_SYSTEM_DIALOG</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">7</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_TOAST</span><span class="token operator">:</span>
                <span class="token comment">// toasts and the plugged-in battery thing</span>
                <span class="token keyword">return</span>  <span class="token number">8</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_PRIORITY_PHONE</span><span class="token operator">:</span>
                <span class="token comment">// SIM errors and unlock.  Not sure if this really should be in a high layer.</span>
                <span class="token keyword">return</span>  <span class="token number">9</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_SYSTEM_ALERT</span><span class="token operator">:</span>
                <span class="token comment">// like the ANR / app crashed dialogs</span>
                <span class="token comment">// Type is deprecated for non-system apps. For system apps, this type should be</span>
                <span class="token comment">// in a higher layer than TYPE_APPLICATION_OVERLAY.</span>
                <span class="token keyword">return</span>  canAddInternalSystemWindow <span class="token operator">?</span> <span class="token number">13</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_APPLICATION_OVERLAY</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">12</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_INPUT_METHOD</span><span class="token operator">:</span>
                <span class="token comment">// on-screen keyboards and other such input method user interfaces go here.</span>
                <span class="token keyword">return</span>  <span class="token number">15</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_INPUT_METHOD_DIALOG</span><span class="token operator">:</span>
                <span class="token comment">// on-screen keyboards and other such input method user interfaces go here.</span>
                <span class="token keyword">return</span>  <span class="token number">16</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_STATUS_BAR</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">17</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_STATUS_BAR_ADDITIONAL</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">18</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_NOTIFICATION_SHADE</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">19</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_STATUS_BAR_SUB_PANEL</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">20</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_KEYGUARD_DIALOG</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">21</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_VOLUME_OVERLAY</span><span class="token operator">:</span>
                <span class="token comment">// the on-screen volume indicator and controller shown when the user</span>
                <span class="token comment">// changes the device volume</span>
                <span class="token keyword">return</span>  <span class="token number">22</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_SYSTEM_OVERLAY</span><span class="token operator">:</span>
                <span class="token comment">// the on-screen volume indicator and controller shown when the user</span>
                <span class="token comment">// changes the device volume</span>
                <span class="token keyword">return</span>  canAddInternalSystemWindow <span class="token operator">?</span> <span class="token number">23</span> <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_NAVIGATION_BAR</span><span class="token operator">:</span>
                <span class="token comment">// the navigation bar, if available, shows atop most things</span>
                <span class="token keyword">return</span>  <span class="token number">24</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_NAVIGATION_BAR_PANEL</span><span class="token operator">:</span>
                <span class="token comment">// some panels (e.g. search) need to show on top of the navigation bar</span>
                <span class="token keyword">return</span>  <span class="token number">25</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_SCREENSHOT</span><span class="token operator">:</span>
                <span class="token comment">// screenshot selection layer shouldn't go above system error, but it should cover</span>
                <span class="token comment">// navigation bars at the very least.</span>
                <span class="token keyword">return</span>  <span class="token number">26</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_SYSTEM_ERROR</span><span class="token operator">:</span>
                <span class="token comment">// system-level error dialogs</span>
                <span class="token keyword">return</span>  canAddInternalSystemWindow <span class="token operator">?</span> <span class="token number">27</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_MAGNIFICATION_OVERLAY</span><span class="token operator">:</span>
                <span class="token comment">// used to highlight the magnified portion of a display</span>
                <span class="token keyword">return</span>  <span class="token number">28</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_DISPLAY_OVERLAY</span><span class="token operator">:</span>
                <span class="token comment">// used to simulate secondary display devices</span>
                <span class="token keyword">return</span>  <span class="token number">29</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_DRAG</span><span class="token operator">:</span>
                <span class="token comment">// the drag layer: input for drag-and-drop is associated with this window,</span>
                <span class="token comment">// which sits above all other focusable windows</span>
                <span class="token keyword">return</span>  <span class="token number">30</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_ACCESSIBILITY_OVERLAY</span><span class="token operator">:</span>
                <span class="token comment">// overlay put by accessibility services to intercept user interaction</span>
                <span class="token keyword">return</span>  <span class="token number">31</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_ACCESSIBILITY_MAGNIFICATION_OVERLAY</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token number">32</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_SECURE_SYSTEM_OVERLAY</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">33</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_BOOT_PROGRESS</span><span class="token operator">:</span>
                <span class="token keyword">return</span>  <span class="token number">34</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TYPE_POINTER</span><span class="token operator">:</span>
                <span class="token comment">// the (mouse) pointer layer</span>
                <span class="token keyword">return</span>  <span class="token number">35</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"WindowManager"</span><span class="token punctuation">,</span> <span class="token string">"Unknown window type: "</span> <span class="token operator">+</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  可以看到，窗口类型与图层层级对应关系。最大是getMaxWindowLayer()，它的值是36。该方法里面并没有提到0层，但是代码构造窗口层级的时候，是从0层开始的。type &gt;= FIRST_APPLICATION_WINDOW &amp;&amp; type &lt;= LAST_APPLICATION_WINDOW，是APPLICATION_LAYER层，也就是第二层。FIRST_APPLICATION_WINDOW 是1，LAST_APPLICATION_WINDOW是99。在这之间的窗口类型都是属于窗口应用层。窗口层级数值越大，它就会在上面，会覆盖下层的窗口。<br>   回到configureTrustedHierarchyBuilder()中，可以看到</p> 
<table>
<thead><tr>
<th>特色模式</th>
<th>影响窗口图层</th>
</tr></thead>
<tbody>
<tr>
<td>FEATURE_WINDOWED_MAGNIFICATION</td>
<td>0-31</td>
</tr>
<tr>
<td>FEATURE_HIDE_DISPLAY_CUTOUT</td>
<td>0-16、18、20-23、26-35</td>
</tr>
<tr>
<td>FEATURE_ONE_HANDED_BACKGROUND_PANEL</td>
<td>0-1</td>
</tr>
<tr>
<td>FEATURE_ONE_HANDED</td>
<td>0-23、26-35</td>
</tr>
<tr>
<td>FEATURE_FULLSCREEN_MAGNIFICATION</td>
<td>0-14、17-23、26-27、29-31、33-35</td>
</tr>
<tr>
<td>FEATURE_IME_PLACEHOLDER</td>
<td>15-16</td>
</tr>
</tbody>
</table> 
<p>  这些影响到的图层数都是根据上面提到的几个方法里面得出来的。并且如果是默认显示屏幕，会将上述6个特色模式都加入到HierarchyBuilder对象中。<br>   其中需要注意一点的是，在添加FEATURE_WINDOWED_MAGNIFICATION时，它是会设置建造者对象的mNewDisplayAreaSupplier 为DisplayArea.Dimmable::new。等到它构造DisplayArea对象的时候，它的实际对象类型是DisplayArea.Dimmable。它可以控制变暗的显示区域。</p> 
<h5>
<a id="3__457"></a>3 构造窗口层级</h5> 
<p>  构造层级的方法在DisplayAreaPolicyBuilder类的build(WindowManagerService wmService)里面：</p> 
<pre><code class="prism language-java">    <span class="token class-name">Result</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">WindowManagerService</span> wmService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Attach DA group roots to screen hierarchy before adding windows to group hierarchies.</span>
        mRootHierarchyBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>mDisplayAreaGroupHierarchyBuilders<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RootDisplayArea</span><span class="token punctuation">&gt;</span></span> displayAreaGroupRoots <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                mDisplayAreaGroupHierarchyBuilders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mDisplayAreaGroupHierarchyBuilders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">HierarchyBuilder</span> hierarchyBuilder <span class="token operator">=</span> mDisplayAreaGroupHierarchyBuilders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            hierarchyBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            displayAreaGroupRoots<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>hierarchyBuilder<span class="token punctuation">.</span>mRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Use the default function if it is not specified otherwise.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSelectRootForWindowFunc <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mSelectRootForWindowFunc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSelectRootForWindowFunction</span><span class="token punctuation">(</span>
                    mRootHierarchyBuilder<span class="token punctuation">.</span>mRoot<span class="token punctuation">,</span> displayAreaGroupRoots<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span>wmService<span class="token punctuation">,</span> mRootHierarchyBuilder<span class="token punctuation">.</span>mRoot<span class="token punctuation">,</span> displayAreaGroupRoots<span class="token punctuation">,</span>
                mSelectRootForWindowFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>  这个方法主要就是调用mRootHierarchyBuilder.build(mDisplayAreaGroupHierarchyBuilders)构造层级。mDisplayAreaGroupHierarchyBuilders的大小为0，如果mSelectRootForWindowFunc 没有设置值的话，设置为DefaultSelectRootForWindowFunction对象。最后新生成一个Result对象返回。</p> 
<h6>
<a id="HierarchyBuilderbuildNullable_ListHierarchyBuilder_displayAreaGroupHierarchyBuilders_483"></a>HierarchyBuilder的build(@Nullable List displayAreaGroupHierarchyBuilders)</h6> 
<p>  这里说一下，是对于默认屏幕来分析，就是设置了上面说的六种特色模式。<br> 该方法代码挺长，分段阅读：</p> 
<pre><code class="prism language-java">        <span class="token comment">/**
         * Builds the {@link DisplayArea} hierarchy below root. And adds the roots of those
         * {@link HierarchyBuilder} as children.
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HierarchyBuilder</span><span class="token punctuation">&gt;</span></span> displayAreaGroupHierarchyBuilders<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">WindowManagerPolicy</span> policy <span class="token operator">=</span> mRoot<span class="token punctuation">.</span>mWmService<span class="token punctuation">.</span>mPolicy<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> maxWindowLayerCount <span class="token operator">=</span> policy<span class="token punctuation">.</span><span class="token function">getMaxWindowLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">[</span><span class="token punctuation">]</span> displayAreaForLayer <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">[</span>maxWindowLayerCount<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Feature</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DisplayArea</span><span class="token punctuation">&lt;</span><span class="token class-name">WindowContainer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> featureAreas <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>mFeatures<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mFeatures<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                featureAreas<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mFeatures<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> 
<p>  maxWindowLayerCount 的值为37，代表图层总数。displayAreaForLayer 数组代表每一层的叶子Tokens对象。等到下面会看到，图层结构是个树结构，它则是存储的是叶子节点的对应内容。featureAreas 里面根据特色模式。存储对应特色模式里面的窗口容器。<br>   第二段代码：</p> 
<pre><code class="prism language-java">            <span class="token class-name">PendingArea</span><span class="token punctuation">[</span><span class="token punctuation">]</span> areaForLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingArea</span><span class="token punctuation">[</span>maxWindowLayerCount<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">PendingArea</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingArea</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>areaForLayer<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Create DisplayAreas to cover all defined features.</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> mFeatures<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Traverse the features with the order they are defined, so that the early defined</span>
                <span class="token comment">// feature will be on the top in the hierarchy.</span>
                <span class="token keyword">final</span> <span class="token class-name">Feature</span> feature <span class="token operator">=</span> mFeatures<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">PendingArea</span> featureArea <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> layer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> layer <span class="token operator">&lt;</span> maxWindowLayerCount<span class="token punctuation">;</span> layer<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>feature<span class="token punctuation">.</span>mWindowLayers<span class="token punctuation">[</span>layer<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// This feature will be applied to this window layer.</span>
                        <span class="token comment">//</span>
                        <span class="token comment">// We need to find a DisplayArea for it:</span>
                        <span class="token comment">// We can reuse the existing one if it was created for this feature for the</span>
                        <span class="token comment">// previous layer AND the last feature that applied to the previous layer is</span>
                        <span class="token comment">// the same as the feature that applied to the current layer (so they are ok</span>
                        <span class="token comment">// to share the same parent DisplayArea).</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>featureArea <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> featureArea<span class="token punctuation">.</span>mParent <span class="token operator">!=</span> areaForLayer<span class="token punctuation">[</span>layer<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// No suitable DisplayArea:</span>
                            <span class="token comment">// Create a new one under the previous area (as parent) for this layer.</span>
                            featureArea <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingArea</span><span class="token punctuation">(</span>feature<span class="token punctuation">,</span> layer<span class="token punctuation">,</span> areaForLayer<span class="token punctuation">[</span>layer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            areaForLayer<span class="token punctuation">[</span>layer<span class="token punctuation">]</span><span class="token punctuation">.</span>mChildren<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>featureArea<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        areaForLayer<span class="token punctuation">[</span>layer<span class="token punctuation">]</span> <span class="token operator">=</span> featureArea<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// This feature won't be applied to this window layer. If it needs to be</span>
                        <span class="token comment">// applied to the next layer, we will need to create a new DisplayArea for</span>
                        <span class="token comment">// that.</span>
                        featureArea <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
</code></pre> 
<p>  这里首先需要介绍下PendingArea类，它是构建窗口树的主要类。</p> 
<div class="mermaid sequence-diagram"> 
  
  #mermaid-svg-Wvy80GZVSO8FhN2B {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-Wvy80GZVSO8FhN2B .error-icon{fill:#552222;}#mermaid-svg-Wvy80GZVSO8FhN2B .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-Wvy80GZVSO8FhN2B .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-Wvy80GZVSO8FhN2B .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-Wvy80GZVSO8FhN2B .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-Wvy80GZVSO8FhN2B .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-Wvy80GZVSO8FhN2B .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-Wvy80GZVSO8FhN2B .marker{fill:#333333;stroke:#333333;}#mermaid-svg-Wvy80GZVSO8FhN2B .marker.cross{stroke:#333333;}#mermaid-svg-Wvy80GZVSO8FhN2B svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-Wvy80GZVSO8FhN2B g.classGroup text{fill:#9370DB;fill:#131300;stroke:none;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:10px;}#mermaid-svg-Wvy80GZVSO8FhN2B g.classGroup text .title{font-weight:bolder;}#mermaid-svg-Wvy80GZVSO8FhN2B .nodeLabel,#mermaid-svg-Wvy80GZVSO8FhN2B .edgeLabel{color:#131300;}#mermaid-svg-Wvy80GZVSO8FhN2B .edgeLabel .label rect{fill:#ECECFF;}#mermaid-svg-Wvy80GZVSO8FhN2B .label text{fill:#131300;}#mermaid-svg-Wvy80GZVSO8FhN2B .edgeLabel .label span{background:#ECECFF;}#mermaid-svg-Wvy80GZVSO8FhN2B .classTitle{font-weight:bolder;}#mermaid-svg-Wvy80GZVSO8FhN2B .node rect,#mermaid-svg-Wvy80GZVSO8FhN2B .node circle,#mermaid-svg-Wvy80GZVSO8FhN2B .node ellipse,#mermaid-svg-Wvy80GZVSO8FhN2B .node polygon,#mermaid-svg-Wvy80GZVSO8FhN2B .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-Wvy80GZVSO8FhN2B .divider{stroke:#9370DB;stroke:1;}#mermaid-svg-Wvy80GZVSO8FhN2B g.clickable{cursor:pointer;}#mermaid-svg-Wvy80GZVSO8FhN2B g.classGroup rect{fill:#ECECFF;stroke:#9370DB;}#mermaid-svg-Wvy80GZVSO8FhN2B g.classGroup line{stroke:#9370DB;stroke-width:1;}#mermaid-svg-Wvy80GZVSO8FhN2B .classLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5;}#mermaid-svg-Wvy80GZVSO8FhN2B .classLabel .label{fill:#9370DB;font-size:10px;}#mermaid-svg-Wvy80GZVSO8FhN2B .relation{stroke:#333333;stroke-width:1;fill:none;}#mermaid-svg-Wvy80GZVSO8FhN2B .dashed-line{stroke-dasharray:3;}#mermaid-svg-Wvy80GZVSO8FhN2B #compositionStart,#mermaid-svg-Wvy80GZVSO8FhN2B .composition{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-Wvy80GZVSO8FhN2B #compositionEnd,#mermaid-svg-Wvy80GZVSO8FhN2B .composition{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-Wvy80GZVSO8FhN2B #dependencyStart,#mermaid-svg-Wvy80GZVSO8FhN2B .dependency{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-Wvy80GZVSO8FhN2B #dependencyStart,#mermaid-svg-Wvy80GZVSO8FhN2B .dependency{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-Wvy80GZVSO8FhN2B #extensionStart,#mermaid-svg-Wvy80GZVSO8FhN2B .extension{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-Wvy80GZVSO8FhN2B #extensionEnd,#mermaid-svg-Wvy80GZVSO8FhN2B .extension{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-Wvy80GZVSO8FhN2B #aggregationStart,#mermaid-svg-Wvy80GZVSO8FhN2B .aggregation{fill:#ECECFF!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-Wvy80GZVSO8FhN2B #aggregationEnd,#mermaid-svg-Wvy80GZVSO8FhN2B .aggregation{fill:#ECECFF!important;stroke:#333333!important;stroke-width:1;}#mermaid-svg-Wvy80GZVSO8FhN2B .edgeTerminals{font-size:11px;}#mermaid-svg-Wvy80GZVSO8FhN2B :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;} 
   
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
      
     
    
    
     
     
     
     
      
       
       
       
       
        
        <div> 
         <span class="nodeLabel"></span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">PendingArea</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">int mMinLayer</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">ArrayList&lt; PendingArea&gt; mChildren</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">Feature mFeature</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">PendingArea mParent</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">int mMaxLayer</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">DisplayArea mExisting</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">boolean mSkipTokens = false</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">instantiateChildren()</span> 
        </div> 
        
        
        <div> 
         <span class="nodeLabel">createArea()</span> 
        </div> 
        
       
      
     
    
   
  
</div> 
<p>  它的mParent指向它的父PendingArea，mChildren里面是它的孩子PendingArea。mMinLayer是对应的窗口图层最小层，mMaxLayer是最大层。mExisting与mSkipTokens和createArea()相关。如果mExisting存在，就直接使用它，如果不存在，会新建DisplayArea；但是mSkipTokens为true，就不新建直接返回null。<br>   构建的树结构是使用mParent和mChildren实现的。<br>   现在就按照第二段代码分析一下，首先新建一个根PendingArea对象root，并且将areaForLayer数组里都填充root，这就是将各个图层的PendingArea对象都指向root。<br>   再接着就是两层循环，第一层循环是遍历特色模式，第二层是遍历窗口图层。可以看到，在第二层循环中，如果特色模式对应的图层受影响（feature.mWindowLayers[layer]=true），并且之前没有PendingArea对象或者之前的PendingArea对象的父PendingArea和当前图层的PendingArea对象不同，会新建一个该特色模式的PendingArea对象，使它的父PendingArea指向当前图层的PendingArea对象，并且将新创建的对象添加到当前图层的PendingArea对象的mChildren里，接着将当前图层的PendingArea对象变成新生成的PendingArea对象。<br>   这两层循环执行完毕之后，PendingArea对象树形结构如下：<br> <img src="https://images2.imgbox.com/53/0e/CIj1EyaX_o.png" alt="PendingArea对象树形结构"></p> 

  PendingArea对象树形结构 
   接着看第三段代码： 
<pre><code class="prism language-java">            <span class="token comment">// Create Tokens as leaf for every layer.</span>
            <span class="token class-name">PendingArea</span> leafArea <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> leafType <span class="token operator">=</span> <span class="token constant">LEAF_TYPE_TOKENS</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> layer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> layer <span class="token operator">&lt;</span> maxWindowLayerCount<span class="token punctuation">;</span> layer<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> type <span class="token operator">=</span> <span class="token function">typeOfLayer</span><span class="token punctuation">(</span>policy<span class="token punctuation">,</span> layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Check whether we can reuse the same Tokens with the previous layer. This happens</span>
                <span class="token comment">// if the previous layer is the same type as the current layer AND there is no</span>
                <span class="token comment">// feature that applies to only one of them.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>leafArea <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> leafArea<span class="token punctuation">.</span>mParent <span class="token operator">!=</span> areaForLayer<span class="token punctuation">[</span>layer<span class="token punctuation">]</span>
                        <span class="token operator">||</span> type <span class="token operator">!=</span> leafType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Create a new Tokens for this layer.</span>
                    leafArea <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingArea</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* feature */</span><span class="token punctuation">,</span> layer<span class="token punctuation">,</span> areaForLayer<span class="token punctuation">[</span>layer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    areaForLayer<span class="token punctuation">[</span>layer<span class="token punctuation">]</span><span class="token punctuation">.</span>mChildren<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leafArea<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    leafType <span class="token operator">=</span> type<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>leafType <span class="token operator">==</span> <span class="token constant">LEAF_TYPE_TASK_CONTAINERS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// We use the passed in TaskDisplayAreas for task container type of layer.</span>
                        <span class="token comment">// Skip creating Tokens even if there is no TDA.</span>
                        <span class="token function">addTaskDisplayAreasToApplicationLayer</span><span class="token punctuation">(</span>areaForLayer<span class="token punctuation">[</span>layer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">addDisplayAreaGroupsToApplicationLayer</span><span class="token punctuation">(</span>areaForLayer<span class="token punctuation">[</span>layer<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                displayAreaGroupHierarchyBuilders<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        leafArea<span class="token punctuation">.</span>mSkipTokens <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>leafType <span class="token operator">==</span> <span class="token constant">LEAF_TYPE_IME_CONTAINERS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// We use the passed in ImeContainer for ime container type of layer.</span>
                        <span class="token comment">// Skip creating Tokens even if there is no ime container.</span>
                        leafArea<span class="token punctuation">.</span>mExisting <span class="token operator">=</span> mImeContainer<span class="token punctuation">;</span>
                        leafArea<span class="token punctuation">.</span>mSkipTokens <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                leafArea<span class="token punctuation">.</span>mMaxLayer <span class="token operator">=</span> layer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            root<span class="token punctuation">.</span><span class="token function">computeMaxLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  这段代码是为窗口图层每层添加叶子PendingArea对象，每层叶子节点对象对应的类型分为三种：LEAF_TYPE_TOKENS、LEAF_TYPE_TASK_CONTAINERS、LEAF_TYPE_IME_CONTAINERS。第2层，也就是APPLICATION_LAYER层，为LEAF_TYPE_TASK_CONTAINERS；第15、16层，也就是TYPE_INPUT_METHOD、TYPE_INPUT_METHOD_DIALOG窗口类型对应的图层，为LEAF_TYPE_IME_CONTAINERS；其他的图层对应的类型为LEAF_TYPE_TOKENS。<br>   在叶子对象为null、或者叶子对象的父PendingArea和当前图层的PendingArea对象不同、或者叶子节点不同于上次叶子的类型的时候，都会创建新的叶子对象。<br>   叶子对象和正常的不同的是它的feature为null，叶子对象也会加入到当前图层的PendingArea对象的孩子节点中。<br>   并且在叶子对应的图层类型为LEAF_TYPE_TASK_CONTAINERS、LEAF_TYPE_IME_CONTAINERS时，会进行特殊处理。<br>   在为LEAF_TYPE_IME_CONTAINERS时，直接将叶子的mExisting设置为mImeContainer。mImeContainer为DisplayContent对象的成员变量mImeWindowsContainer，它是ImeContainer对象，该类继承DisplayArea.Tokens。<br>   在为LEAF_TYPE_TASK_CONTAINERS时，会调用addTaskDisplayAreasToApplicationLayer(areaForLayer[layer])将HierarchyBuilder对象的mTaskDisplayAreas集合里的内容添加到当前图层的PendingArea对象的孩子中。</p> 
<pre><code class="prism language-java">        <span class="token comment">/** Adds all {@link TaskDisplayArea} to the application layer. */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addTaskDisplayAreasToApplicationLayer</span><span class="token punctuation">(</span><span class="token class-name">PendingArea</span> parentPendingArea<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> mTaskDisplayAreas<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">PendingArea</span> leafArea <span class="token operator">=</span>
                        <span class="token keyword">new</span> <span class="token class-name">PendingArea</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* feature */</span><span class="token punctuation">,</span> <span class="token constant">APPLICATION_LAYER</span><span class="token punctuation">,</span> parentPendingArea<span class="token punctuation">)</span><span class="token punctuation">;</span>
                leafArea<span class="token punctuation">.</span>mExisting <span class="token operator">=</span> mTaskDisplayAreas<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                leafArea<span class="token punctuation">.</span>mMaxLayer <span class="token operator">=</span> <span class="token constant">APPLICATION_LAYER</span><span class="token punctuation">;</span>
                parentPendingArea<span class="token punctuation">.</span>mChildren<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leafArea<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>  可见也是将mTaskDisplayAreas中的对象设置为新创建PendingArea 对象的成员变量mExisting 。mTaskDisplayAreas中的对象，是我们前面说的默认TaskDisplayArea对象defaultTaskDisplayArea，最后将该 新创建PendingArea 对象添加到当前图层对应的PendingArea 对象的孩子中。<br>   经过这第三段的代码的循环之后，上面的PendingArea对象树形结构图就编程如下：<br> <img src="https://images2.imgbox.com/37/17/8bEEGulL_o.png" alt="带叶子的PendingArea对象树形结构"></p> 

  带叶子的PendingArea对象树形结构 
   再接下来看看第四段代码： 
<pre><code class="prism language-java"><span class="token comment">// We built a tree of PendingAreas above with all the necessary info to represent the</span>
            <span class="token comment">// hierarchy, now create and attach real DisplayAreas to the root.</span>
            root<span class="token punctuation">.</span><span class="token function">instantiateChildren</span><span class="token punctuation">(</span>mRoot<span class="token punctuation">,</span> displayAreaForLayer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> featureAreas<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  PendingArea对象树形结构构建完成，现在调用树根root的instantiateChildren()方法，来构建窗口层级图，其中mRoot是DisplayContent对象，displayAreaForLayer是每层的DisplayArea对象，featureAreas是每个特色模式里面所有的非叶子节点生成的DisplayArea对象，displayAreaForLayer和featureAreas里的值都是在方法中生成的，继续看PendingArea的instantiateChildren()：</p> 
<pre><code class="prism language-java">        <span class="token keyword">void</span> <span class="token function">instantiateChildren</span><span class="token punctuation">(</span><span class="token class-name">DisplayArea</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DisplayArea</span><span class="token punctuation">&gt;</span></span> parent<span class="token punctuation">,</span> <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">[</span><span class="token punctuation">]</span> areaForLayer<span class="token punctuation">,</span>
                <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Feature</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DisplayArea</span><span class="token punctuation">&lt;</span><span class="token class-name">WindowContainer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> areas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mChildren<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparingInt</span><span class="token punctuation">(</span>pendingArea <span class="token operator">-&gt;</span> pendingArea<span class="token punctuation">.</span>mMinLayer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">PendingArea</span> child <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">DisplayArea</span> area <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">createArea</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> areaForLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>area <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// TaskDisplayArea and ImeContainer can be set at different hierarchy, so it can</span>
                    <span class="token comment">// be null.</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> <span class="token class-name">WindowContainer</span><span class="token punctuation">.</span><span class="token constant">POSITION_TOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>mFeature <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    areas<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>mFeature<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>area<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                child<span class="token punctuation">.</span><span class="token function">instantiateChildren</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> areaForLayer<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> areas<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>  首先会将孩子按照mMinLayer的值进行升序排列。然后调用孩子的createArea()生成DisplayArea对象。如果该节点生成的DisplayArea对象为null，就继续执行下一个孩子节点的循环操作。如果生成了DisplayArea对象，会将该对象加入到parent的孩子中的最上面，我们知道parent目前是DisplayContent对象。接着会判断孩子的mFeature对象不为null，就添加到参数areas中。我们知道，节点是叶子的时候，它的mFeature 才会为null。所以这个是筛掉叶子节点。接着就是递归调用孩子的instantiateChildren()。不过这次传入的parent参数，是孩子刚才生成的DisplayArea对象。<br>   继续看下createArea()方法：</p> 
<pre><code class="prism language-java">        <span class="token annotation punctuation">@Nullable</span>
        <span class="token keyword">private</span> <span class="token class-name">DisplayArea</span> <span class="token function">createArea</span><span class="token punctuation">(</span><span class="token class-name">DisplayArea</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DisplayArea</span><span class="token punctuation">&gt;</span></span> parent<span class="token punctuation">,</span>
                <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">[</span><span class="token punctuation">]</span> areaForLayer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mExisting <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mExisting<span class="token punctuation">.</span><span class="token function">asTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Store the WindowToken container for layers</span>
                    <span class="token function">fillAreaForLayers</span><span class="token punctuation">(</span>mExisting<span class="token punctuation">.</span><span class="token function">asTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> areaForLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> mExisting<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSkipTokens<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Type</span> type<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mMinLayer <span class="token operator">&gt;</span> <span class="token constant">APPLICATION_LAYER</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                type <span class="token operator">=</span> <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">ABOVE_TASKS</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mMaxLayer <span class="token operator">&lt;</span> <span class="token constant">APPLICATION_LAYER</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                type <span class="token operator">=</span> <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">BELOW_TASKS</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                type <span class="token operator">=</span> <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mFeature <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Tokens</span> leaf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisplayArea<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>mWmService<span class="token punctuation">,</span> type<span class="token punctuation">,</span>
                        <span class="token string">"Leaf:"</span> <span class="token operator">+</span> mMinLayer <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> mMaxLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">fillAreaForLayers</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span> areaForLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> leaf<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> mFeature<span class="token punctuation">.</span>mNewDisplayAreaSupplier<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>mWmService<span class="token punctuation">,</span> type<span class="token punctuation">,</span>
                        mFeature<span class="token punctuation">.</span>mName <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> mMinLayer <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> mMaxLayer<span class="token punctuation">,</span> mFeature<span class="token punctuation">.</span>mId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>  在这里，我们能看到PendingArea类的mExisting 和mSkipTokens属性的使用。如果mExisting 存在直接就返回它，不会重新生成新的。<br>   如果mExisting 不存在，并且mSkipTokens= true，这个时候，会返回null。<br>   如果mExisting 不存在，并且mSkipTokens= false，则会新生成DisplayArea对象。新生成的DisplayArea对象，如果mFeature 为null，则为DisplayArea.Tokens对象。不然，则会调用mFeature.mNewDisplayAreaSupplier的create()方法生成具体的对象。我们知道，在前面添加特色模式时，会将mFeature.mNewDisplayAreaSupplier设置为DisplayArea.Dimmable::new。如果不设置mFeature.mNewDisplayAreaSupplier，它默认为DisplayArea::new。<br>   我们还看到，新生成的DisplayArea对象的type，是根据PendingArea类的mMinLayer 和mMaxLayer 来决定。<br>   如果新生成的DisplayArea对象是Tokens 类型，会填充参数areaForLayer数组，将对应层级的Tokens对象放入其中。<br>   这第四段代码执行完毕，之后，窗口层级结构就完成了，如下<br> <img src="https://images2.imgbox.com/45/37/ztFbIzsH_o.png" alt="显示屏幕窗口结构图"></p> 

  默认屏幕窗口结构 
   图片上的小数字对应窗口图层，这样默认屏幕上的窗口层级结构基本构造完成。 
<p>  结合前面说的窗口层级结构的根对象，是RootWindowContainer对象。如果要补全多屏幕的窗口层级结构，还要分析其他屏幕的构造，不过是比默认屏幕少好几个特色模式的，要比默认屏幕的结构要简单一些。<br>   前面在提到RootWindowContainer的setWindowManager(WindowManagerService wm)方法时，是说屏幕构造函数完成之后，会创建HomeTask，创建HomeTask的内容，放到下一篇文章里面介绍。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>