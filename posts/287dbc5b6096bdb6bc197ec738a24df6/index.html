<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Activiti7（图文并茂） - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Activiti7（图文并茂）</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <hr> 
<p></p> 
<div class="toc"> 
 <h3>文章目录</h3> 
 <ul>
<li><a href="#__6">一 介绍</a></li>
<li>
<ul>
<li><a href="#11_Activiti__8">1.1 Activiti 介绍</a></li>
<li><a href="#12__Activiti__18">1.2 Activiti 开发流程</a></li>
<li><a href="#13_BPMN_20__26">1.3 BPMN 2.0 规范是什么</a></li>
<li><a href="#14_BPMN_20__37">1.4 BPMN 2.0 基本流程符号</a></li>
<li>
<ul>
<li><a href="#141__Event_40">1.4.1 事件 Event</a></li>
<li><a href="#142__47">1.4.2 活动</a></li>
<li><a href="#143__Gateway_52">1.4.3 网关 Gateway</a></li>
</ul> 
   </li>
<li><a href="#15_Activiti_API__75">1.5 Activiti API 服务接口</a></li>
<li>
<ul><li><a href="#151_Service_98">1.5.1 核心Service接口及其获取</a></li></ul> 
  </li>
</ul> 
  </li>
<li><a href="#__118">二 表</a></li>
<li>
<ul>
<li><a href="#21__121">2.1 建表</a></li>
<li><a href="#22__145">2.2 表介绍</a></li>
</ul> 
  </li>
<li><a href="#_model_194">三 关于model</a></li>
<li>
<ul>
<li><a href="#31_model_197">3.1 model画图</a></li>
<li><a href="#32_model_271">3.2 操作model</a></li>
<li>
<ul>
<li><a href="#321__274">3.2.1 模型查询对象</a></li>
<li><a href="#322__299">3.2.2 删除模型对象</a></li>
<li><a href="#323_zip_318">3.2.3 导出流程定义模型资源的zip压缩包</a></li>
<li><a href="#324_xml_384">3.2.4 导出流程定义模型资源的.xml文件</a></li>
<li><a href="#325__426">3.2.5 通过流程定义模型数据部署流程定义</a></li>
</ul> 
  </li>
</ul> 
  </li>
<li><a href="#___479">四 操作部署信息</a></li>
<li>
<ul>
<li><a href="#41__482">4.1 部署</a></li>
<li>
<ul>
<li><a href="#411zip_485">4.1.1通过zip压缩包进行部署流程定义</a></li>
<li><a href="#412_xml_512">4.1.2 通过.xml文件部署</a></li>
</ul> 
   </li>
<li><a href="#42__535">4.2 删除部署流程定义</a></li>
<li><a href="#43__571">4.3 启动流程</a></li>
</ul> 
  </li>
<li><a href="#__590">五 操作流程定义</a></li>
<li>
<ul>
<li><a href="#51__593">5.1 分页查询</a></li>
<li><a href="#52__642">5.2 修改流程定义状态</a></li>
<li><a href="#53__676">5.3 导出流程定义文件</a></li>
</ul> 
  </li>
<li><a href="#__708">六 操作流程实例</a></li>
<li>
<ul>
<li><a href="#61__711">6.1 启动流程实例</a></li>
<li><a href="#62__747">6.2 查询流程实例</a></li>
<li>
<ul><li><a href="#621__750">6.2.1 查询正在运行的流程实例</a></li></ul> 
   </li>
<li><a href="#63__775">6.3 激活或挂起流程实例</a></li>
<li><a href="#64___810">6.4 删除流程实例</a></li>
</ul> 
  </li>
<li><a href="#__844">七 操作任务</a></li>
<li>
<ul>
<li><a href="#71__847">7.1 查询指定办理人任务</a></li>
<li><a href="#72__870">7.2 查询指定候选人任务</a></li>
<li><a href="#73__892">7.3 办理个人任务</a></li>
<li><a href="#74__908">7.4 拾取候选人任务</a></li>
<li><a href="#75__935">7.5 归还组任务</a></li>
<li><a href="#76__960">7.6 转办任务</a></li>
<li><a href="#77__987">7.7 办理组任务</a></li>
</ul> 
  </li>
<li><a href="#__992">八 历史数据</a></li>
<li>
<ul>
<li><a href="#81__995">8.1 查询个人已办任务</a></li>
<li><a href="#82__1028">8.2 查询流程实例的办理历史节点信息</a></li>
<li><a href="#83__1052">8.3 查询已经结束的历史流程实例</a></li>
<li><a href="#84__1079">8.4 删除已结束的历史流程实例</a></li>
</ul> 
  </li>
<li><a href="#__1110">九 加流程参数</a></li>
<li>
<ul>
<li><a href="#91__1113">9.1 启动时加入</a></li>
<li><a href="#92__1130">9.2 办理任务时加入流程参数</a></li>
</ul> 
 </li>
</ul> 
</div> 
<p></p> 
<p></p> 
<h1>
<a id="__6"></a>一 介绍</h1> 
<p></p> 
<h2>
<a id="11_Activiti__8"></a>1.1 Activiti 介绍</h2> 
<p>Activiti 是由 jBPM （BPM，Business Process Management 即业务流程管理） 的创建者 Tom Baeyens 离开 JBoss 之后建立的项目，构建在开发 jBPM 版本 1 到 4 时积累的多年经验的基础之上，旨在创建下一代的 BPM 解 决方案。</p> 
<p>Activiti 作为一个开源的工作流引擎，它实现了BPMN 2.0规范，可以发布设计好的流程定义，并通过api进行流程调 度。 Activiti 作为一个遵从 Apache 许可的工作流和业务流程管理开源平台，其核心是基于Java的超快速、超稳定的 BPMN2.0 流程引擎，强调流程服务的可嵌入性和可扩展性，同时更加强调面向业务人员。</p> 
<p>Activiti 流程引擎重点关注在系统开发的易用性和轻量性上。每一项 BPM 业务功能 Activiti 流程引擎都以服务的形 式提供给开发人员。通过使用这些服务，开发人员能够构建出功能丰富、轻便且高效的 BPM 应用程序。 Activiti是一个针对企业用户、开发人员、系统管理员的轻量级工作流业务管理平台，其核心是使用Java开发的快 速、稳定的BPMN 2.0流程引擎。Activiti是在ApacheV2许可下发布的，可以运行在任何类型的Java程序中，例如服 务器、集群、云服务等。</p> 
<p>Activiti可以完美地与Spring集成。同时，基于简约思想的设计使Activiti非常轻量级。 官网：<a href="https://www.activiti.org/">https://www.activiti.org/</a></p> 
<p></p> 
<h2>
<a id="12__Activiti__18"></a>1.2 Activiti 开发流程</h2> 
<ol>
<li>画流程定义模型： 遵守BPMN的流程规范，使用BPMN的流程定义工具，通过 流程符号 把整个业务流程定义出来，可以将流程 定义文件字节流保存到模型数据表中（Model）。</li>
<li>部署流程定义： 加载画好的流程定义文件，将它转换成流程定义数据（ProcessDefinition），保存到流程定义数据表中。</li>
<li>启动流程（提交流程申请）： 生成流程实例数据（ProcessInstance），生成第1节点任务数据(Task)。</li>
<li>处理人审批流程节点任务： 完成任务审批，生成审批结果，生成下一节点任务数据。</li>
</ol> 
<p></p> 
<h2>
<a id="13_BPMN_20__26"></a>1.3 BPMN 2.0 规范是什么</h2> 
<p>业务流程模型注解（Business Process Modeling Notation - BPMN）是业务流程模型的一种标准图形注解。这个 标准是由对象管理组（Object Management Group - OMG）维护的。</p> 
<p>标准的早期版本（1.2版以及之前）仅仅限制在模型上， 目标是在所有的利益相关者之间形成通用的理解， 在文 档，讨论和实现业务流程之上。 BPMN标准证明了它自己，现在市场上许多建模工具都使用了BPMN标准中的元素 和结构。</p> 
<p>BPMN规范的2.0版本，当前已经处于最终阶段了， 允许添加精确的技术细节在BPMN的图形和元素中， 同时制定 BPMN元素的执行语法。 通过使用XML语言来指定业务流程的可执行语法， BPMN规范已经演变为业务流程的语 言， 可以执行在任何兼容BPMN2的流程引擎中， 同时依然可以使用强大的图形注解。</p> 
<p>目前BPMN2.0是最新的版本，它用于在BPM上下文中进行布局和可视化的沟通。BPMN 2.0是使用一些符号来明确 业务流程设计流程图的一整套符号规范，它能增进业务建模时的沟通效率。</p> 
<p></p> 
<h2>
<a id="14_BPMN_20__37"></a>1.4 BPMN 2.0 基本流程符号</h2> 
<p></p> 
<h3>
<a id="141__Event_40"></a>1.4.1 事件 Event</h3> 
<p>开始 中间事件 结束</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/57ce7238f78b6ef01b60d7868d0a8be8.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=720&amp;id=u1d399f07&amp;originHeight=1080&amp;originWidth=2017&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=111651&amp;status=done&amp;style=none&amp;taskId=ucf322f82-dafe-4946-bd91-88d76674e41&amp;title=&amp;width=1344.6666666666667" alt="image-20211215201353917.png"></p> 
<p></p> 
<h3>
<a id="142__47"></a>1.4.2 活动</h3> 
<p>活动是工作或任务的一个通用术语。一个活动可以是一个任务，还可以是一个当前流程的子处理流程；</p> 
<p></p> 
<h3>
<a id="143__Gateway_52"></a>1.4.3 网关 Gateway</h3> 
<p>网关用来处理决策：</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/4b2fdc8eaffca535f5ce8c46a0aef1df.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=164&amp;id=u96ca18ff&amp;originHeight=246&amp;originWidth=291&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=20314&amp;status=done&amp;style=none&amp;taskId=u79be9b25-ee3d-4b6c-be30-ee62556bf82&amp;title=&amp;width=194" alt="image-20211215201600134.png"></p> 
<ul><li>排他网关 (x)</li></ul> 
<p>只有一条路径会被选择。流程执行到该网关时，按照输出流的顺序逐个计算，当条件的计算结果为true时，继 续执行当前网关的输出流； 如果多条线路计算结果都是 true，则会执行第一个值为 true 的线路。如果所有网关计算结果没有true，则引 擎会抛出异常。 排他网关需要和条件顺序流结合使用，default 属性指定默认顺序流，当所有的条件不满足时会执行默认顺序流。</p> 
<ul><li>并行网关 (+)</li></ul> 
<p>所有路径会被同时选择 分支： 并行执行所有输出顺序流，为每一条顺序流创建一个并行执行线路。 汇聚 ：所有从并行网关拆分并执行完成的线路均在此等候，直到所有的线路都执行完成才继续向下执行。</p> 
<ul><li>包含网关 (o)</li></ul> 
<p>可以同时执行多条线路，也可以在网关上设置条件分支：计算每条线路上的表达式，当表达式计算结果为true时，创建一个并行线路并继续执行 汇聚：所有从并行网关拆分并执行完成的线路均在此等候，直到所有的线路都执行完成才继续向下执行。</p> 
<ul><li>事件网关 (o+)</li></ul> 
<p>专门为中间捕获事件设置的，允许设置多个输出流指向多个不同的中间捕获事件。当流程执行到事件网关 后，流程处于等待状态，需要等待抛出事件才能将等待状态转换为活动状态。</p> 
<p></p> 
<h2>
<a id="15_Activiti_API__75"></a>1.5 Activiti API 服务接口</h2> 
<p>Activiti 流程引擎包含了25张表，而且表之间的关系也比较复杂，比如包含各种外键约束。</p> 
<p>按照传统的方式，有了数据库表后，就应该为每张表创建 Entity 实体类，然后为其创建对应的 DAO 接口，然 后再创建对应的 Service来实现对表数据的增删改查；</p> 
<p>但是按照传统方式的，就会有一个很严峻的问题，表的数量太多，并且关系复杂，还要兼顾流程引擎的处理方 式，自己去搞一套，几乎不可能；</p> 
<p>其实不需要我们去创建Entity 、 DAO、Service、Controller，因为Activiti已经把这些东西给搞好了，只需要 调用即可。</p> 
<p><strong>Process Engine API 和服务</strong></p> 
<p>引擎 API 是与 Activiti 交互的最常见方式。</p> 
<p>可以从ProcessEngine中获取包含工作流/ BPM方法的各种服务。</p> 
<p>ProcessEngine和服务对象是线程安全的。因此，可以为整个服务器保留对其中之一的引用。</p> 
<p>Service 是工作流引擎提供用于进行工作流部署、执行、管理的服务接口，我们使用对应Service接口可以操作对应 的数据表。</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/7f44dc96321285dfe2919085a7372a4e.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=435&amp;id=ub397462c&amp;originHeight=653&amp;originWidth=1589&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=88823&amp;status=done&amp;style=none&amp;taskId=u685d7219-0ea2-4325-b3af-64ca4981950&amp;title=&amp;width=1059.3333333333333" alt="image-20211129233459602.png"></p> 
<p></p> 
<h3>
<a id="151_Service_98"></a>1.5.1 核心Service接口及其获取</h3> 
<pre><code class="prism language-java"><span class="token comment">// 会在首次调用时初始化并构建一个流程引擎，此后始终返回相同的流程引擎。</span>
<span class="token class-name">ProcessEngine</span> processEngine <span class="token operator">=</span> <span class="token class-name">ProcessEngines</span><span class="token punctuation">.</span><span class="token function">getDefaultProcessEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 引擎管理类</span>
<span class="token class-name">ManagementService</span> managementService <span class="token operator">=</span> processEngine<span class="token punctuation">.</span><span class="token function">getManagementService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 动态修改流程管理类</span>
<span class="token class-name">DynamicBpmnService</span> dynamicBpmnService <span class="token operator">=</span> processEngine<span class="token punctuation">.</span><span class="token function">getDynamicBpmnService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 流程运行管理类</span>
<span class="token class-name">RuntimeService</span> runtimeService <span class="token operator">=</span> processEngine<span class="token punctuation">.</span><span class="token function">getRuntimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 流程仓库管理类</span>
<span class="token class-name">RepositoryService</span> repositoryService <span class="token operator">=</span> processEngine<span class="token punctuation">.</span><span class="token function">getRepositoryService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 任务管理类</span>
<span class="token class-name">TaskService</span> taskService <span class="token operator">=</span> processEngine<span class="token punctuation">.</span><span class="token function">getTaskService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 历史管理类</span>
<span class="token class-name">HistoryService</span> historyService <span class="token operator">=</span> processEngine<span class="token punctuation">.</span><span class="token function">getHistoryService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p></p> 
<h1>
<a id="__118"></a>二 表</h1> 
<p></p> 
<h2>
<a id="21__121"></a>2.1 建表</h2> 
<p>前提：在数据库中建库 并和配置文件中的连接信息保持一致。</p> 
<p>在test中执行如下语句，即可建表成功：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">ProcessEngine</span> processEngine<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getProcessEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"processEngine: "</span> <span class="token operator">+</span> processEngine<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>建好表后，执行两条语句，使其完整:</p> 
<pre><code class="prism language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> ACT_RE_DEPLOYMENT <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> VERSION_ <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> ACT_RE_DEPLOYMENT <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> PROJECT_RELEASE_VERSION_ <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p></p> 
<h2>
<a id="22__145"></a>2.2 表介绍</h2> 
<p>Acitiviti数据库中表的命名都是以 ACT_ 开头的。第二部分是一个两个字符用例表的标识。此用例大体与服务API是 匹配的。</p> 
<p><strong>ACT_GE_</strong>* ： GE 表示 general 。通用数据，各种情况都使用的数据 ，如存放资源文件（图片，规则等）。</p> 
<p><strong>ACT_HI_xxx</strong> ： HI 表示history。就是这些表包含着历史的相关数据，如结束的流程实例（变量，任务等）。</p> 
<p><strong>ACT_RE_xxx</strong> ： RE 表示repository。带此前缀的表包含的是静态信息，如，流程定义，流程的资源（图片，规则 等）。 Activiti只在流程实例执行过程中保存这些数据， 在流程结束时就会删除这些记录。 这样运行时表可以一直 很小速度很快。</p> 
<p><strong>ACT_RU_xxx</strong> ： RU 表示 runtime。这是运行时的表存储着流程变量，用户任务，变量，职责（job）等运行时的 数据。Activiti只存储实例执行期间的运行时数据，当流程实例结束时，将删除这些记录。这就保证了这些运行时的 表小且快。</p> 
<p><strong>ACT_EVT_</strong>* ：EVT表示EVENT，流程引擎的通用事件日志记录表，方便管理员跟踪处理。</p> 
<table>
<thead><tr>
<th>表分类</th>
<th>表名</th>
<th>说明</th>
</tr></thead>
<tbody>
<tr>
<td>通用数据</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>act_ge_bytearray</td>
<td>二进制数据表（流程图）</td>
</tr>
<tr>
<td></td>
<td>act_ge_property</td>
<td>属性数据表，存储整个流程引擎级别的数据,初始化表结构时，会 插入版本号信息等</td>
</tr>
<tr>
<td>历史数据</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>act_hi_actinst</td>
<td>历史节点表</td>
</tr>
<tr>
<td></td>
<td>act_hi_attachment</td>
<td>历史节点表</td>
</tr>
<tr>
<td></td>
<td>act_hi_comment</td>
<td>历史节点表</td>
</tr>
<tr>
<td></td>
<td>act_hi_detail</td>
<td>历史详情表，提供历史变量的查询</td>
</tr>
<tr>
<td></td>
<td>act_hi_identitylink</td>
<td>历史流程人员表，主要存储任务节点与参与者的相关信息</td>
</tr>
<tr>
<td></td>
<td>act_hi_procinst</td>
<td>历史流程实例表</td>
</tr>
<tr>
<td></td>
<td>act_hi_taskinst</td>
<td>历史任务实例表</td>
</tr>
<tr>
<td></td>
<td>act_hi_varinst</td>
<td>历史变量表</td>
</tr>
<tr>
<td>流程定义表</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>act_re_deployment</td>
<td>部署信息表</td>
</tr>
<tr>
<td></td>
<td>act_re_model</td>
<td>流程设计模型表</td>
</tr>
<tr>
<td></td>
<td>act_re_procdef</td>
<td>流程设计模型表</td>
</tr>
<tr>
<td>流程运行表</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>act_ru_deadletter_job</td>
<td>作业死亡信息表，如果作业失败超过重试次数，则写入到此表</td>
</tr>
<tr>
<td></td>
<td>act_ru_event_subscr</td>
<td>throwEvent、catchEvent时间监听信息表</td>
</tr>
<tr>
<td></td>
<td>act_ru_execution</td>
<td>运行时流程执行实例表</td>
</tr>
<tr>
<td></td>
<td>aact_ru_identitylink</td>
<td>运行时流程人员表，主要存储任务节点与参与者的相关信息</td>
</tr>
<tr>
<td></td>
<td>act_ru_integration</td>
<td>运行时积分表</td>
</tr>
<tr>
<td></td>
<td>act_ru_job</td>
<td>定时异步任务数据表</td>
</tr>
<tr>
<td></td>
<td>act_ru_suspended_job</td>
<td>运行时作业暂停表， 比如流程中有一个定时任务，如果把这个任 务停止工作了，这个任务写入到此表中</td>
</tr>
<tr>
<td></td>
<td>act_ru_task</td>
<td>运行时任务节点表</td>
</tr>
<tr>
<td></td>
<td>act_ru_timer_job</td>
<td>运行时定时器作业表</td>
</tr>
<tr>
<td></td>
<td>act_ru_variable</td>
<td>运行时流程变量数据表</td>
</tr>
<tr>
<td>其他表</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>act_procdef_info</td>
<td>流程定义的动态变更信息</td>
</tr>
<tr>
<td></td>
<td>act_evt_log</td>
<td>流程引擎的通用事件日志记录表</td>
</tr>
</tbody>
</table> 
<p></p> 
<h1>
<a id="_model_194"></a>三 关于model</h1> 
<p></p> 
<h2>
<a id="31_model_197"></a>3.1 model画图</h2> 
<p>画图前，先指定如下三处</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/790ff6add7304031472318e7fc53a21b.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=733&amp;id=u7ace347b&amp;originHeight=1100&amp;originWidth=2133&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=182300&amp;status=done&amp;style=none&amp;taskId=ub320ad3c-8b7f-4a4e-850e-7070d5d6233&amp;title=&amp;width=1422" alt="image-20211215203258049.png"></p> 
<p>必须有个开始 和 结束 ：</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/95f44d2dd5d76e19a21aac6b0866955d.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=641&amp;id=u265f44a4&amp;originHeight=961&amp;originWidth=2073&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=163946&amp;status=done&amp;style=none&amp;taskId=ufeeeee6d-e044-48e4-97cb-b9d15723ccf&amp;title=&amp;width=1382" alt="image-20211215204012091.png"></p> 
<p>加入任务：</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/d648a5144ebf621414e509c6c076af59.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=543&amp;id=ubb088150&amp;originHeight=814&amp;originWidth=2098&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=123208&amp;status=done&amp;style=none&amp;taskId=u16e8cc50-9bbe-4167-9665-698bbdcd330&amp;title=&amp;width=1398.6666666666667" alt="image-20211215204434169.png"></p> 
<p>注意：双击节点可以指定节点名称</p> 
<p>指定任务办理人：</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/3ba12baf77cb1d22905a081285b6eb98.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=599&amp;id=u09480a42&amp;originHeight=898&amp;originWidth=1557&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=101207&amp;status=done&amp;style=none&amp;taskId=u57798922-ce15-47a4-8f3b-cb77ea7197b&amp;title=&amp;width=1038" alt="image-20211215204809122.png"></p> 
<p>然后到下一步（此时是以写死的方式来指定办理人的）</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/93d602dc3ac917e075ecdded23c91fc8.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=523&amp;id=ub2777424&amp;originHeight=785&amp;originWidth=975&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=39525&amp;status=done&amp;style=none&amp;taskId=u243d15c4-612d-4118-9931-827bdccc5ba&amp;title=&amp;width=650" alt="image-20211215204918290.png"></p> 
<p>完成整个流程绘图后，点击左上角保存</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/35b2170740d78a7139939c704f9469a7.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=508&amp;id=uc6f73731&amp;originHeight=762&amp;originWidth=2044&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=121176&amp;status=done&amp;style=none&amp;taskId=u6fa599ea-b059-44cc-8fae-1d7e327fde6&amp;title=&amp;width=1362.6666666666667" alt="image-20211215205055395.png"></p> 
<p>点击保存后出现如下框，填写完 点保存就好</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/cce7a63943dda34ea925717dbf5d8609.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=413&amp;id=ucb581654&amp;originHeight=619&amp;originWidth=955&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=28637&amp;status=done&amp;style=none&amp;taskId=u058bc856-151a-4aae-ace7-bb83b9d21b7&amp;title=&amp;width=636.6666666666666" alt="image-20211215205145615.png"></p> 
<hr> 
<p>动态分配办理人</p> 
<p>方式1：指定变量</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/1af2b0502e9aeba31167b4d087527c02.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=481&amp;id=u2993e03e&amp;originHeight=722&amp;originWidth=1086&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=31343&amp;status=done&amp;style=none&amp;taskId=u4f3c3447-feb5-4c1a-96a7-77294f9f2bd&amp;title=&amp;width=724" alt="image-20211215210306015.png"></p> 
<ul><li> <br> </li></ul> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/6c5fbd0bcc9eab90f8a9a9916642ab74.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=593&amp;id=u3982c54c&amp;originHeight=890&amp;originWidth=1225&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=79567&amp;status=done&amp;style=none&amp;taskId=u0dee1153-fd75-4d75-88cc-e8d6740bd5d&amp;title=&amp;width=816.6666666666666" alt="image-20211215210331194.png"></p> 
<p>此时是指定了一个表达式的样子来指定的动态办理人，为该表达式赋值的时机是流程到达该节点之前，如果该节点之前是 开始 ，那么就在流程启动的时候指定，如果该节点之前是 任务 ，那么就在完成上一步任务的同时指定下一步办理人。</p> 
<p>如何加流程参数在本文档的第九节。</p> 
<p>方式2：指定对象属性名</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/e8823bf592cedc17fbac9249a62d3e04.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=513&amp;id=u0c5418b0&amp;originHeight=769&amp;originWidth=1064&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=37445&amp;status=done&amp;style=none&amp;taskId=u00f0af4f-dfc5-4d75-bc34-4a656642bf1&amp;title=&amp;width=709.3333333333334" alt="image-20211215210738063.png"></p> 
<ul><li> <br> </li></ul> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/61db507c4a7747fc8db618af8ad6d6d1.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=558&amp;id=ueb961003&amp;originHeight=837&amp;originWidth=1202&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=87086&amp;status=done&amp;style=none&amp;taskId=u522a1d58-a595-4c38-ac2c-ec3bf4c449d&amp;title=&amp;width=801.3333333333334" alt="image-20211215210757114.png"></p> 
<p>在启动流程或者完成上一步任务办理的同时，指定一个user对象进去就好了。</p> 
<p>如何加流程参数在本文档的第九节。</p> 
<p>方式3：方法表达式</p> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/78d248ab796c1f02f935aee7413c9316.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=502&amp;id=u040d53cd&amp;originHeight=753&amp;originWidth=983&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=35660&amp;status=done&amp;style=none&amp;taskId=u8df04be2-9431-4830-a7dd-32207a5b385&amp;title=&amp;width=655.3333333333334" alt="image-20211215211141413.png"></p> 
<ul><li> <br> </li></ul> 
<p><img src="https://img-blog.csdnimg.cn/img_convert/0615d9e93e5cd1684a5fd408e2fdbc04.png#clientId=udde6e6c4-ef71-4&amp;from=paste&amp;height=565&amp;id=u751cf7ee&amp;originHeight=847&amp;originWidth=1327&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=86831&amp;status=done&amp;style=none&amp;taskId=u43ddff1e-1aa5-4f47-a362-bd4362ba110&amp;title=&amp;width=884.6666666666666" alt="image-20211215211200717.png"></p> 
<p><strong>注意</strong>：userService是Spring容器中的一个bean实例，对应调用getUsername()方法。</p> 
<p>如何加流程参数在本文档的第九节。</p> 
<p></p> 
<h2>
<a id="32_model_271"></a>3.2 操作model</h2> 
<p></p> 
<h3>
<a id="321__274"></a>3.2.1 模型查询对象</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RepositoryService</span> repositoryService<span class="token punctuation">;</span>
<span class="token comment">/**
* 查询所有流程定义模型
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">modelList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ModelQuery</span> query <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createModelQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Model</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">orderByCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Model</span> model <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"模型id:"</span> <span class="token operator">+</span> model<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">", 模型名称："</span> <span class="token operator">+</span> model<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"，模型描述： "</span> <span class="token operator">+</span> model<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"，模型标识key:"</span> <span class="token operator">+</span> model<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"，模型版本号："</span> <span class="token operator">+</span> model<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h3>
<a id="322__299"></a>3.2.2 删除模型对象</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RepositoryService</span> repositoryService<span class="token punctuation">;</span> 
<span class="token comment">/**
 * 删除流程定义模型
 * 会影响到的表：ACT_RE_MODE 和 ACT_GE_BYTEARRAY
 */</span>
 <span class="token annotation punctuation">@Test</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">//	modelId 为表ACT_RE_MODE 中的ID字段</span>
     <span class="token class-name">String</span> modelId <span class="token operator">=</span> <span class="token string">"0a499790-7c1d-11f6-9001-2c337a6d7e1d"</span><span class="token punctuation">;</span>
     repositoryService<span class="token punctuation">.</span><span class="token function">deleteModel</span><span class="token punctuation">(</span>modelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"删除成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h3>
<a id="323_zip_318"></a>3.2.3 导出流程定义模型资源的zip压缩包</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RepositoryService</span> repositoryService<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exportZip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 查询模型基本信息 （modelId 为表ACT_RE_MODE 中的ID字段）</span>
    <span class="token class-name">String</span> modelId <span class="token operator">=</span> <span class="token string">"da0fbf5c-7c1d-11f6-949f-2c337a6d7e1d"</span><span class="token punctuation">;</span>
    <span class="token class-name">Model</span> model <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span>modelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>model <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 2. 查询流程定义模型的json字节码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bpmnJsonBytes <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getModelEditorSource</span><span class="token punctuation">(</span>modelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.1 将json字节码转换为xml字节码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> xmlBytes <span class="token operator">=</span> <span class="token function">bpmnJsonXmlBytes</span><span class="token punctuation">(</span>bpmnJsonBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xmlBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"模型数据为空-请先设计流程定义模型，再导出"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 压缩包文件名</span>
            <span class="token class-name">String</span> zipName <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> model<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".zip"</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:/"</span> <span class="token operator">+</span> zipName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 实例化zip输出流</span>
            <span class="token class-name">ZipOutputStream</span> zipos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipOutputStream</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将xml添加到压缩包中(指定xml文件名：请假流程.bpmn20.xml ）</span>
            zipos<span class="token punctuation">.</span><span class="token function">putNextEntry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ZipEntry</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".bpmn20.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zipos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>xmlBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 3. 查询流程定义模型的图片字节码</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pngBytes <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getModelEditorSourceExtra</span><span class="token punctuation">(</span>modelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pngBytes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 图片文件名（请假流程.leaveProcess.png)</span>
                zipos<span class="token punctuation">.</span><span class="token function">putNextEntry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ZipEntry</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> model<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                zipos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>pngBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 4. 以压缩包的方式导出流程定义模型文件</span>
            zipos<span class="token punctuation">.</span><span class="token function">closeEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zipos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"导出流程定义模型zip成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"模型不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">bpmnJsonXmlBytes</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> jsonBytes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>jsonBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 1. json字节码转成 BpmnModel 对象</span>
    <span class="token class-name">JsonNode</span> jsonNode <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>jsonBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BpmnModel</span> bpmnModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BpmnJsonConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertToBpmnModel</span><span class="token punctuation">(</span>jsonNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>bpmnModel<span class="token punctuation">.</span><span class="token function">getProcesses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2. BpmnModel 对象转为xml字节码</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> xmlBytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BpmnXMLConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertToXML</span><span class="token punctuation">(</span>bpmnModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xmlBytes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h3>
<a id="324_xml_384"></a>3.2.4 导出流程定义模型资源的.xml文件</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exportXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 查询模型基本信息</span>
    <span class="token class-name">String</span> modelId <span class="token operator">=</span> <span class="token string">"da0fbf5c-7c1d-11f6-949f-2c337a6d7e1d"</span><span class="token punctuation">;</span>
    <span class="token comment">// 查询json字节码</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getModelEditorSource</span><span class="token punctuation">(</span>modelId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> filename <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteArrayInputStream</span> in <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bytes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. json字节码转成 BpmnModel 对象</span>
        <span class="token class-name">JsonNode</span> jsonNode <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BpmnModel</span> bpmnModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BpmnJsonConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertToBpmnModel</span><span class="token punctuation">(</span>jsonNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>bpmnModel<span class="token punctuation">.</span><span class="token function">getProcesses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2. BpmnModel 对象转为xml字节码</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> xmlBytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BpmnXMLConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertToXML</span><span class="token punctuation">(</span>bpmnModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>xmlBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            filename <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>bpmnModel<span class="token punctuation">.</span><span class="token function">getMainProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">?</span> bpmnModel<span class="token punctuation">.</span><span class="token function">getMainProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> bpmnModel<span class="token punctuation">.</span><span class="token function">getMainProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>filename <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        filename <span class="token operator">=</span> <span class="token string">"模型数据为空，请先设计流程，再导出"</span><span class="token punctuation">;</span>
        in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 文件输出流</span>
    <span class="token class-name">FileOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:/"</span> <span class="token operator">+</span> filename <span class="token operator">+</span> <span class="token string">".bpmn20.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>

    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"导出xml成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h3>
<a id="325__426"></a>3.2.5 通过流程定义模型数据部署流程定义</h3> 
<pre><code class="prism language-java"> <span class="token comment">/**
 * 会影响到的表：
 * ACT_RE_PROCDEF
 * ACT_RE_DEPLOYMENT
 * ACT_GE_BYTEARRAY
 * ACT_RE_MODEL 更新流程部署id，将模型与部署的流程定义绑定
 * @throws Exception
 */</span>
 <span class="token annotation punctuation">@Test</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">// 1. 查询流程定义模型json字节码</span>
     <span class="token class-name">String</span> modelId <span class="token operator">=</span> <span class="token string">"b8efa921-da43-11eb-8aa7-2c337a6d7e1d"</span><span class="token punctuation">;</span>
     <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> jsonBytes <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getModelEditorSource</span><span class="token punctuation">(</span>modelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>jsonBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"模型数据为空，请先设计流程定义模型，再进行部署"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token comment">// 将json字节码转为 xml 字节码，因为bpmn2.0规范中关于流程模型的描述是xml格式的，而activiti遵守了这个规范</span>
     <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> xmlBytes <span class="token operator">=</span> <span class="token function">bpmnJsonXmlBytes</span><span class="token punctuation">(</span>jsonBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>xmlBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数据模型不符合要求，请至少设计一条主线流程"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token comment">// 2. 查询流程定义模型的图片</span>
     <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pngBytes <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getModelEditorSourceExtra</span><span class="token punctuation">(</span>modelId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 查询模型的基本信息</span>
    <span class="token class-name">Model</span> model <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span>modelId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// xml资源的名称 ，对应act_ge_bytearray表中的name_字段</span>
    <span class="token class-name">String</span> processName <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".bpmn20.xml"</span><span class="token punctuation">;</span>
    <span class="token comment">// 图片资源名称，对应act_ge_bytearray表中的name_字段</span>
    <span class="token class-name">String</span> pngName <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> model<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".png"</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 调用部署相关的api方法进行部署流程定义</span>
    <span class="token class-name">Deployment</span> deployment <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createDeployment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 部署名称</span>
    <span class="token punctuation">.</span><span class="token function">addString</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>xmlBytes<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// bpmn20.xml资源</span>
    <span class="token punctuation">.</span><span class="token function">addBytes</span><span class="token punctuation">(</span>pngName<span class="token punctuation">,</span> pngBytes<span class="token punctuation">)</span> <span class="token comment">// png资源</span>
    <span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新 部署id 到流程定义模型数据表中</span>
    model<span class="token punctuation">.</span><span class="token function">setDeploymentId</span><span class="token punctuation">(</span>deployment<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    repositoryService<span class="token punctuation">.</span><span class="token function">saveModel</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"部署成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h1>
<a id="___479"></a>四 操作部署信息</h1> 
<p></p> 
<h2>
<a id="41__482"></a>4.1 部署</h2> 
<p></p> 
<h3>
<a id="411zip_485"></a>4.1.1通过zip压缩包进行部署流程定义</h3> 
<pre><code class="prism language-java"> <span class="token comment">/**
 * 通过zip压缩包进行部署流程定义
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deployByZip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:/请假流程模型xx.leaveProcess.zip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建输入流</span>
    <span class="token class-name">FileInputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取zip资源压缩包，转成输入流</span>
    <span class="token class-name">ZipInputStream</span> zipInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Deployment</span> deployment <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createDeployment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addZipInputStream</span><span class="token punctuation">(</span>zipInputStream<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"请假申请流程222-压缩包"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 输出部署结果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"部署ID: "</span> <span class="token operator">+</span> deployment<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"部署名称："</span> <span class="token operator">+</span> deployment<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h3>
<a id="412_xml_512"></a>4.1.2 通过.xml文件部署</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deployByFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">FileNotFoundException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:/请假申请流程.bpmn20.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 文件输入流</span>
    <span class="token class-name">FileInputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 资源名称</span>
    <span class="token class-name">String</span> filename <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 调用相关api方法进行部署</span>
    <span class="token class-name">Deployment</span> deployment <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createDeployment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"请假申请流程"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addInputStream</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> inputStream<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 输出部署结果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"部署ID: "</span> <span class="token operator">+</span> deployment<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"部署名称："</span> <span class="token operator">+</span> deployment<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="42__535"></a>4.2 删除部署流程定义</h2> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 根据部署ID来删除部署的流程定义数据
 * 影响到的表：
 * ACT_GE_BYTEARRAY
 * ACT_RE_DEPLOYMENT
 * ACT_RE_PROCDEF
 * ACT_RU_EVENT_SUBSCR
 * ACT_RU_IDENTITYLINK
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> deploymentId <span class="token operator">=</span> <span class="token string">"f88ccd79-db17-11eb-a1e0-2c337a6d7e1d"</span><span class="token punctuation">;</span>
        <span class="token comment">// 默认不是级联删除操作，如果有正在执行的流程实例，则删除时会抛出异常，并且不会删除历史表数据</span>
        <span class="token comment">//repositoryService.deleteDeployment(deploymentId);</span>

        <span class="token comment">// 如果为true则是级联删除操作(小心使用~)</span>
        <span class="token comment">//	如果流程定义启动了对应的流程实例，也可以进行删除，并且会删除历史数据</span>
        <span class="token comment">//repositoryService.deleteDeployment(deploymentId, true);</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"删除流程定义数据成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"a foreign key constraint fails"</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"有正在执行的流程实例，不允许删除"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"删除失败，原因： "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="43__571"></a>4.3 启动流程</h2> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RuntimeService</span> runtimeService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startProcessInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 启动流程实例(流程定义key processDefinitionKey)</span>
    <span class="token comment">// 通过流程定义key启动的流程实例 ，找的是最新版本的流程定义数据</span>
    <span class="token comment">// 根据key部署 这个案例里"leaveProcess" 为部署的key</span>
    <span class="token class-name">ProcessInstance</span> processInstance <span class="token operator">=</span> runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceByKey</span><span class="token punctuation">(</span><span class="token string">"leaveProcess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程定义id: "</span> <span class="token operator">+</span> processInstance<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程实例id: "</span> <span class="token operator">+</span> processInstance<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h1>
<a id="__590"></a>五 操作流程定义</h1> 
<p></p> 
<h2>
<a id="51__593"></a>5.1 分页查询</h2> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RepositoryService</span> repositoryService<span class="token punctuation">;</span>

<span class="token comment">/**
 * 分页条件查询流程定义列表数据
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getProcDefList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ProcessDefinitionQuery</span> query <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createProcessDefinitionQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">"请假"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 条件查询</span>
        query<span class="token punctuation">.</span><span class="token function">processDefinitionNameLike</span><span class="token punctuation">(</span><span class="token string">"%"</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">"%"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果多个相同key, 只查询最新版本的流程定义，</span>
    query<span class="token punctuation">.</span><span class="token function">latestVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 按key降序</span>
    query<span class="token punctuation">.</span><span class="token function">orderByProcessDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前页码</span>
    <span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 每页显示多少条</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token comment">// 当前页第1条数据的下标</span>
    <span class="token keyword">int</span> firstResult <span class="token operator">=</span> <span class="token punctuation">(</span>current<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">;</span>
    <span class="token comment">// 分页查询</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessDefinition</span><span class="token punctuation">&gt;</span></span> processDefinitionList <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">listPage</span><span class="token punctuation">(</span>firstResult<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProcessDefinition</span> pd <span class="token operator">:</span> processDefinitionList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"流程部署id："</span> <span class="token operator">+</span> pd<span class="token punctuation">.</span><span class="token function">getDeploymentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"，流程定义id："</span> <span class="token operator">+</span> pd<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"，流程定义key: "</span> <span class="token operator">+</span> pd<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"，流程定义名称："</span> <span class="token operator">+</span> pd<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"，版本号："</span> <span class="token operator">+</span> pd<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"，状态："</span> <span class="token operator">+</span> <span class="token punctuation">(</span> pd<span class="token punctuation">.</span><span class="token function">isSuspended</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"挂起（暂停）"</span> <span class="token operator">:</span> <span class="token string">"激活（开启）"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 总记录数</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"满足条件的流程定义总记录："</span> <span class="token operator">+</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="52__642"></a>5.2 修改流程定义状态</h2> 
<pre><code class="prism language-java"><span class="token comment">/**
* 挂起或激活流程定义 ：对应 act_re_procdef 表中的 SUSPENSION_STATE_ 字段，1是激活，2是挂起
* - 流程定义被挂起：此流程定义下的所有流程实例不允许继续往后流转了，就被停止了。
* - 流程定义被激活：此流程定义下的所有流程实例允许继续往后流转。
* - 为什么会被挂起？
*   - 可能当前公司的请假流程发现了一些不合理的地方，然后就把此流程定义挂起。
*   - 流程不合理解决办法：
*     - 方式一：可以先挂起流程定义，然后更新流程定义，然后激活流程定义。
*     - 方式二：挂起了就不激活了，重新创建一个新的请假流程定义。
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateProcDefState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//	processDefinitionId 为 act_re_procdef 表id</span>
    <span class="token class-name">String</span> processDefinitionId <span class="token operator">=</span> <span class="token string">"leaveProcess:2:f6a379a1-7cdb-11f6-8052-2c337a6d7e1d"</span><span class="token punctuation">;</span>
    <span class="token class-name">ProcessDefinition</span> processDefinition <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createProcessDefinitionQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">processDefinitionId</span><span class="token punctuation">(</span>processDefinitionId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断是否挂起，true则挂起，false则激活</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>processDefinition<span class="token punctuation">.</span><span class="token function">isSuspended</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将当前为挂起状态更新为激活状态</span>
        <span class="token comment">// 参数说明：参数1：流程定义id,参数2：是否激活（true是否级联对应流程实例，激活了则对应流程实例都可以审批），参数3：什么时候激活，如果为null则立即激活，如果为具体时间则到达此时间后激活</span>
        repositoryService<span class="token punctuation">.</span><span class="token function">activateProcessDefinitionById</span><span class="token punctuation">(</span>processDefinitionId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将当前为激活状态更新为挂起状态</span>
        <span class="token comment">// 参数说明：参数1：流程定义id,参数2：是否挂起（true是否级联对应流程实例，挂起了则对应流程实例都不可以审批），参数3：什么时候挂起，如果为null则立即挂起，如果为具体时间则到达此时间后挂起</span>
        repositoryService<span class="token punctuation">.</span><span class="token function">suspendProcessDefinitionById</span><span class="token punctuation">(</span>processDefinitionId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="53__676"></a>5.3 导出流程定义文件</h2> 
<pre><code class="prism language-java"> <span class="token comment">/**
 * 导出流程定义文件（xml或png)
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exportProcDefFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> processDefinitionId <span class="token operator">=</span> <span class="token string">"leaveProcess:2:f6a379a1-7cdb-11f6-8052-2c337a6d7e1d"</span><span class="token punctuation">;</span>
    <span class="token class-name">ProcessDefinition</span> processDefinition <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getProcessDefinition</span><span class="token punctuation">(</span>processDefinitionId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取的是 xml 资源名</span>
    <span class="token class-name">String</span> resourceName <span class="token operator">=</span> processDefinition<span class="token punctuation">.</span><span class="token function">getResourceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取 png 图片资源名</span>
    resourceName <span class="token operator">=</span> processDefinition<span class="token punctuation">.</span><span class="token function">getDiagramResourceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查询到相关的资源输入流 （deploymentId, resourceName）</span>
    <span class="token class-name">InputStream</span> input <span class="token operator">=</span>
        repositoryService<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>processDefinition<span class="token punctuation">.</span><span class="token function">getDeploymentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resourceName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建输出流</span>
    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:/"</span> <span class="token operator">+</span> resourceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FileOutputStream</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>

    input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    output<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程定义资源文件导出成功: "</span> <span class="token operator">+</span> resourceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h1>
<a id="__708"></a>六 操作流程实例</h1> 
<p></p> 
<h2>
<a id="61__711"></a>6.1 启动流程实例</h2> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RuntimeService</span> runtimeService<span class="token punctuation">;</span>

<span class="token comment">/**
*  涉及到的数据表：
*  ACT_HI_TASKINST
*  ACT_HI_PROCINST 流程实例
*  ACT_HI_ACTINST 节点实例表
*  ACT_HI_IDENTITYLINK 流程实例相关办理人
*  ACT_RU_EXECUTION
*  ACT_RU_TASK
*  ACT_RU_IDENTITYLINK
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startProcessInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 流程定义唯一标识key</span>
    <span class="token class-name">String</span> processKey <span class="token operator">=</span> <span class="token string">"leaveProcess"</span><span class="token punctuation">;</span>
    <span class="token comment">// 业务id</span>
    <span class="token class-name">String</span> businessKey <span class="token operator">=</span> <span class="token string">"10000"</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动当前流程实例的用户（会保存到 act_hi_procinst 表中 start_user_id 字段中）</span>
    <span class="token class-name">Authentication</span><span class="token punctuation">.</span><span class="token function">setAuthenticatedUserId</span><span class="token punctuation">(</span><span class="token string">"catch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 启动流程实例（流程定义唯一标识key, 业务id),采用流程key对应的最新版本的流程定义数据</span>
    <span class="token class-name">ProcessInstance</span> pi <span class="token operator">=</span> runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceByKey</span><span class="token punctuation">(</span>processKey<span class="token punctuation">,</span> businessKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将流程定义名称 作为 流程实例名称</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">setProcessInstanceName</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pi<span class="token punctuation">.</span><span class="token function">getProcessDefinitionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"启动流程实例成功："</span> <span class="token operator">+</span> pi<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="62__747"></a>6.2 查询流程实例</h2> 
<p></p> 
<h3>
<a id="621__750"></a>6.2.1 查询正在运行的流程实例</h3> 
<pre><code class="prism language-java"><span class="token comment">/**
* 查询正在运行中的流程实例
* 核心表：act_ru_execution ，其中 parent_id 为空，就是正在运行的流程实例
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getProcInstListRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessInstance</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> runtimeService<span class="token punctuation">.</span><span class="token function">createProcessInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">processInstanceNameLike</span><span class="token punctuation">(</span><span class="token string">"%请假%"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProcessInstance</span> pi <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程定义key: "</span> <span class="token operator">+</span> pi<span class="token punctuation">.</span><span class="token function">getProcessDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程定义版本号："</span> <span class="token operator">+</span> pi<span class="token punctuation">.</span><span class="token function">getProcessDefinitionVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程实例Id: "</span> <span class="token operator">+</span> pi<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程实例名称："</span> <span class="token operator">+</span> pi<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"业务key(业务主键id)："</span> <span class="token operator">+</span> pi<span class="token punctuation">.</span><span class="token function">getBusinessKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发起人："</span> <span class="token operator">+</span> pi<span class="token punctuation">.</span><span class="token function">getStartUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程实例状态："</span> <span class="token operator">+</span> <span class="token punctuation">(</span> pi<span class="token punctuation">.</span><span class="token function">isSuspended</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"已挂起（暂停）"</span> <span class="token operator">:</span> <span class="token string">"已激活（启动）"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="63__775"></a>6.3 激活或挂起流程实例</h2> 
<p><strong>注意</strong>：区别于5.2，5.2是修改流程定义的状态，6.3是修改流程实例的状态。</p> 
<pre><code class="prism language-java"> <span class="token comment">/**
 * 激活或挂起流程实例
 * 流程定义：
 *   激活：激活流程定义后，对应所有的流程实例都可以继续向下流转
 *   挂起：挂起流程定义后，对应所有的流程实例都不可以继续向下流转
 * 流程实例：
 *  激活：激活流程实例后，此流程实例可继续向下流转。
 *  挂起：挂起流程实例后，此流程实例不可以向下流转。
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateProcInstState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> procInstId <span class="token operator">=</span> <span class="token string">"c1b97f6f-7d0f-11f6-bc11-2c337a6d7e1d"</span><span class="token punctuation">;</span>
    <span class="token comment">// 1. 查询指定流程实例的数据</span>
    <span class="token class-name">ProcessInstance</span> processInstance <span class="token operator">=</span> runtimeService<span class="token punctuation">.</span><span class="token function">createProcessInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>procInstId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 判断当前流程实例的状态</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>processInstance<span class="token punctuation">.</span><span class="token function">isSuspended</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果是已挂起，则更新为激活状态</span>
        runtimeService<span class="token punctuation">.</span><span class="token function">activateProcessInstanceById</span><span class="token punctuation">(</span>procInstId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"激活流程实例成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果是已激活，则更新为挂起状态</span>
        runtimeService<span class="token punctuation">.</span><span class="token function">suspendProcessInstanceById</span><span class="token punctuation">(</span>procInstId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"挂起流程实例成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="64___810"></a>6.4 删除流程实例</h2> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">HistoryService</span> historyService<span class="token punctuation">;</span>
<span class="token comment">/**
* 删除流程实例:
* 涉及到到的数据表：
* ACT_RU_IDENTITYLINK
* ACT_RU_TASK
* ACT_RU_EXECUTION
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteProcInst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> procInstId <span class="token operator">=</span> <span class="token string">"11d21740-7f7d-11f6-9f0c-2c337a6d7e1d"</span><span class="token punctuation">;</span>

    <span class="token comment">// 1. 查询指定流程实例的数据</span>
    <span class="token class-name">ProcessInstance</span> processInstance <span class="token operator">=</span> runtimeService<span class="token punctuation">.</span><span class="token function">createProcessInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>procInstId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>processInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程实例不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
        
    <span class="token comment">// 删除流程实例（流程实例id,删除原因）, 不会删除流程实例相关历史数据</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">deleteProcessInstance</span><span class="token punctuation">(</span>procInstId<span class="token punctuation">,</span> <span class="token string">"xxx作废了当前流程申请"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 删除流程实例历史数据</span>
    <span class="token comment">//historyService.deleteHistoricProcessInstance(procInstId);</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h1>
<a id="__844"></a>七 操作任务</h1> 
<p></p> 
<h2>
<a id="71__847"></a>7.1 查询指定办理人任务</h2> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findWaitTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 办理人</span>
    <span class="token class-name">String</span> assignee <span class="token operator">=</span> <span class="token string">"snow"</span><span class="token punctuation">;</span>
    <span class="token comment">// 查询个人待办任务</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span>assignee<span class="token punctuation">)</span> <span class="token comment">// 具体办理人</span>
        <span class="token punctuation">.</span><span class="token function">orderByTaskCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Task</span> task <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程实例ID: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"任务id: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"任务名称："</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"任务办理人："</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getAssignee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="72__870"></a>7.2 查询指定候选人任务</h2> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findWaitTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 办理人</span>
    <span class="token class-name">String</span> assignee <span class="token operator">=</span> <span class="token string">"catch"</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">taskCandidateOrAssigned</span><span class="token punctuation">(</span>assignee<span class="token punctuation">)</span> <span class="token comment">// 作为候选人或者是办理人</span>
        <span class="token punctuation">.</span><span class="token function">orderByTaskCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Task</span> task <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程实例ID: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"任务id: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"任务名称："</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"任务办理人："</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getAssignee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="73__892"></a>7.3 办理个人任务</h2> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 完成任务
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">completeTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> taskId <span class="token operator">=</span> <span class="token string">"cdbdce28-7e6e-11f6-9939-2c337a6d7e1d"</span><span class="token punctuation">;</span>
    <span class="token comment">//	办理前 获取到当前登录人 进行判断 不能办理别人的任务</span>
    <span class="token comment">//	判断完成后，办理</span>
    taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="74__908"></a>7.4 拾取候选人任务</h2> 
<p>候选人 是 出现在组任务中的概念，个人任务不存在候选人的说法；</p> 
<p>在组任务中，可以指定多个办理人，多个办理人就是该组任务的候选人。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
* 拾取候选任务
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">claimTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> taskId <span class="token operator">=</span> <span class="token string">"6903fa10-7e79-11f6-8210-2c337a6d7e1d"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> userId <span class="token operator">=</span> <span class="token string">"catch"</span><span class="token punctuation">;</span>
    <span class="token comment">// 注意：即使拾取任务的办理人，不在候选人中，也可以进行拾取成功。</span>
    <span class="token comment">// 所以最好在拾取之前判断是否为当前任务的候选人</span>
    <span class="token comment">/*List&lt;IdentityLink&gt; identityLinkList = taskService.getIdentityLinksForTask(taskId);
        for (IdentityLink identityLink : identityLinkList) {
            System.out.println(identityLink.getUserId());
        }*/</span>

    <span class="token comment">// 拾取候选任务，将 catch 作为该组任务的办理人</span>
    taskService<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span>taskId<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="75__935"></a>7.5 归还组任务</h2> 
<pre><code class="prism language-java"> <span class="token comment">/**
 * 任务办理人归还组任务中
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">assigneeToGroupTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> taskId <span class="token operator">=</span> <span class="token string">"6903fa10-7e79-11f6-8210-2c337a6d7e1d"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> assignee <span class="token operator">=</span> <span class="token string">"catch"</span><span class="token punctuation">;</span>  <span class="token comment">//办理人</span>

    <span class="token comment">// 1. 查询办理人任务</span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//.processDefinitionKey("此处是key")</span>
        <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span>assignee<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 归还组任务中</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 直接将办理人设置为null，即归还到了组任务中</span>
        taskService<span class="token punctuation">.</span><span class="token function">setAssignee</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="76__960"></a>7.6 转办任务</h2> 
<pre><code class="prism language-java"> <span class="token comment">/**
 * 转办任务
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">turnTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> taskId <span class="token operator">=</span> <span class="token string">"6903fa10-7e79-11f6-8210-2c337a6d7e1d"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> assignee <span class="token operator">=</span> <span class="token string">"catch"</span><span class="token punctuation">;</span>  <span class="token comment">//办理人</span>
    <span class="token class-name">String</span> candidateuser <span class="token operator">=</span> <span class="token string">"jones"</span><span class="token punctuation">;</span> <span class="token comment">// 转办的目标办理人</span>

    <span class="token comment">// 1. 查询办理人任务</span>
    <span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//.processDefinitionKey("此处写key")</span>
        <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span>assignee<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">taskId</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将任务转办给 jones 用户</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        taskService<span class="token punctuation">.</span><span class="token function">setAssignee</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> candidateuser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="77__987"></a>7.7 办理组任务</h2> 
<p>将组任务拾取后，就成为了个人任务。办理同7.3。</p> 
<p></p> 
<h1>
<a id="__992"></a>八 历史数据</h1> 
<p></p> 
<h2>
<a id="81__995"></a>8.1 查询个人已办任务</h2> 
<p>表 ACT_HI_TASKINST</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">HistoryService</span> historyService<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findCompleteTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 查询</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HistoricTaskInstance</span><span class="token punctuation">&gt;</span></span> taskList <span class="token operator">=</span> historyService<span class="token punctuation">.</span><span class="token function">createHistoricTaskInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span><span class="token string">"catch"</span><span class="token punctuation">)</span> <span class="token comment">// 办理人</span>
        <span class="token punctuation">.</span><span class="token function">includeProcessVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">orderByTaskCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 任务创建时间降序排列</span>
        <span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HistoricTaskInstance</span> task <span class="token operator">:</span> taskList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" 任务ID: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" ,任务名称: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" ,任务开始时间: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" ,任务结束时间: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" ,办理人: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getAssignee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" ,流程定义id: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" ,流程实例id: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" ,业务id: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getBusinessKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"，流程变量："</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getProcessVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="82__1028"></a>8.2 查询流程实例的办理历史节点信息</h2> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">historyInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 获取查询对象</span>
    <span class="token class-name">HistoricActivityInstanceQuery</span> query <span class="token operator">=</span> historyService<span class="token punctuation">.</span><span class="token function">createHistoricActivityInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 开始查询</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HistoricActivityInstance</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span><span class="token string">"流程实例id"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">orderByHistoricActivityInstanceStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HistoricActivityInstance</span> hi <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"流程定义id："</span> <span class="token operator">+</span> hi<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"，流程实例Id: "</span> <span class="token operator">+</span> hi<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"，节点id: "</span> <span class="token operator">+</span> hi<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"，节点名称："</span> <span class="token operator">+</span> hi<span class="token punctuation">.</span><span class="token function">getActivityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"，任务办理人："</span> <span class="token operator">+</span> hi<span class="token punctuation">.</span><span class="token function">getAssignee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="83__1052"></a>8.3 查询已经结束的历史流程实例</h2> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getProcInstListFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HistoricProcessInstance</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> historyService<span class="token punctuation">.</span><span class="token function">createHistoricProcessInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">orderByProcessInstanceEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HistoricProcessInstance</span> hpi <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"流程实例id: "</span> <span class="token operator">+</span> hpi<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"，流程实例名称："</span> <span class="token operator">+</span> hpi<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">", 流程标识key:"</span> <span class="token operator">+</span> hpi<span class="token punctuation">.</span><span class="token function">getProcessDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">", 流程定义版本号:"</span> <span class="token operator">+</span> hpi<span class="token punctuation">.</span><span class="token function">getProcessDefinitionVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">", 业务id:"</span> <span class="token operator">+</span> hpi<span class="token punctuation">.</span><span class="token function">getBusinessKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">", 流程发起人:"</span> <span class="token operator">+</span> hpi<span class="token punctuation">.</span><span class="token function">getStartUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">", 开始时间:"</span> <span class="token operator">+</span> hpi<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">", 结束时间:"</span> <span class="token operator">+</span> hpi<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">", 删除原因详情:"</span> <span class="token operator">+</span> hpi<span class="token punctuation">.</span><span class="token function">getDeleteReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="84__1079"></a>8.4 删除已结束的历史流程实例</h2> 
<pre><code class="prism language-java"><span class="token comment">/**
* 删除已结束的流程实例
* ACT_HI_DETAIL
* ACT_HI_VARINST
* ACT_HI_TASKINST
* ACT_HI_PROCINST
* ACT_HI_ACTINST
* ACT_HI_IDENTITYLINK
* ACT_HI_COMMENT
*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteFinishProcInst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> procInstId <span class="token operator">=</span> <span class="token string">"流程实例id"</span><span class="token punctuation">;</span>
    <span class="token comment">// 1. 查询流程实例是否已结束</span>
    <span class="token class-name">HistoricProcessInstance</span> instance <span class="token operator">=</span> historyService<span class="token punctuation">.</span><span class="token function">createHistoricProcessInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>procInstId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"流程实例未结束或不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2. 删除已结束流程实例(如果实例未结束，会抛出异常，如果需要删除</span>
    historyService<span class="token punctuation">.</span><span class="token function">deleteHistoricProcessInstance</span><span class="token punctuation">(</span>procInstId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h1>
<a id="__1110"></a>九 加流程参数</h1> 
<p></p> 
<h2>
<a id="91__1113"></a>9.1 启动时加入</h2> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RuntimeService</span> runtimeService<span class="token punctuation">;</span>
<span class="token comment">// 启动流程实例</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 流程变量</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加入参数</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"duration"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceByKey</span><span class="token punctuation">(</span><span class="token string">"testInclusiveGateway"</span><span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h2>
<a id="92__1130"></a>9.2 办理任务时加入流程参数</h2> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">TaskService</span> taskService<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> taskId <span class="token operator">=</span> <span class="token string">"5a17a43e-8010-11f6-9aa6-2c337a6d7e1d"</span><span class="token punctuation">;</span>
  
    <span class="token comment">// 流程变量</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 请假天数，</span>
    variables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"duration"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>taskId<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>