<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>yolov3-tiny原理解析及代码分析 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">yolov3-tiny原理解析及代码分析</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <h1>
<a id="_0"></a>前言</h1> 
<p>从去年十一月份开始学习yolo神经网络用于目标识别的硬件实现，到现在已经六个月了。一个硬件工程师，C/C++基础都差劲的很，对照着darknet作者的源码和网上东拼西凑的原理讲解，一点一点地摸索。刚开始进度很慢，每天都感觉学习不了几行代码，到后来慢慢的入了门，每周都有不菲的收获和重大的进展。总结一下自己这大半年的学习，记录一下心路历程，也为躬耕于此的有缘人提供哪怕一点点的帮助吧。</p> 
<h1>
<a id="_3"></a>相关推荐</h1> 
<p>网上的资源很多，也有很多博主的原理讲解。在这里推荐几个资源：<br> darknet官网：https://pjreddie.com/darknet/yolo/ linux系统<br> github上基于VS的工程：<a href="https://github.com/AlexeyAB/darknet">https://github.com/AlexeyAB/darknet</a><br> github上带有注释的工程：<a href="https://github.com/hgpvision/darknet">https://github.com/hgpvision/darknet</a></p> 
<h1>
<a id="yolov3tiny__9"></a>yolov3-tiny 原理</h1> 
<p>Yolo算法采用一个单独的CNN模型实现end-to-end的目标检测，首先将输入图片resize到448x448，然后送入CNN网络，最后处理网络预测结果得到检测的目标。<br> YOLO 的核心思想就是利用整张图作为网络的输入，直接在输出层回归 bounding box（边界框） 的位置及其所属的类别。将一幅图像分成 SxS 个网格（grid cell），如果某个 object 的中心落在这个网格中，则这个网格就负责预测这个 object。<br> <img src="https://images2.imgbox.com/2a/3d/mgfaGkxu_o.png" alt="在这里插入图片描述"><br> 每个 bounding box 要预测 (x, y, w, h) 和 confidence 共5个值，每个网格还要预测一个类别信息，记为 C 类。则 SxS个 网格，每个网格要预测 B 个 bounding box， 每个box中都有 C 个 classes对应的概率值。输出就是 S x S x B x(5+C) 的一个 tensor。</p> 
<p><strong>注意：</strong> class 信息是针对每个网格的，confidence 信息是针对每个 bounding box 的。</p> 
<p>yolov3-tiny中，共有两个输出层（yolo层），分别为13x13和26x26，每个网格可以预测3个bounding box，共有80个分类数。所以最后的yolo层的尺寸为：13x13x255和26x26x255。<br> yolov3-tiny网络层结构如下：<br> <img src="https://images2.imgbox.com/ee/72/tATlMBbo_o.png" alt="在这里插入图片描述">更直观的一个模型图:<br> <img src="https://images2.imgbox.com/04/8f/g8Mlzxbd_o.png" alt="在这里插入图片描述">可以看出，yolov3-tiny共有23层网络，其中包含五种不同的网络层：卷积层convolutional(13个)，池化层maxpool(6个)，路由层route(2个)，上采样层upsample(1个)，输出层yolo(2个)。Yolov3-tiny中，除了Yolo层之前的那个卷积层，每个卷积层之后都有BN层,且每个卷积层之后都有激活函数LEAKY（yolo层之前是linear）。</p> 
<h1>
<a id="yolov3tiny__23"></a>yolov3-tiny 源码分析</h1> 
<h2>
<a id="1__24"></a>1. 配置网络结构</h2> 
<p>yolov3-tiny前向传播主要在detector.c中的test_detector函数中完成：</p> 
<pre><code class="prism language-python"><span class="token operator">/</span><span class="token operator">**</span> 本函数是检测模型的一个前向推理测试函数<span class="token punctuation">.</span>
<span class="token operator">*</span> @param datacfg       数据集信息文件路径（也即cfg<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>data文件），文件中包含有关数据集的信息，比如cfg<span class="token operator">/</span>coco<span class="token punctuation">.</span>data
<span class="token operator">*</span> @param cfgfile       网络配置文件路径（也即cfg<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>cfg文件），包含一个网络所有的结构参数，比如cfg<span class="token operator">/</span>yolo<span class="token punctuation">.</span>cfg
<span class="token operator">*</span> @param weightfile    已经训练好的网络权重文件路径，比如darknet网站上下载的yolo<span class="token punctuation">.</span>weights文件
<span class="token operator">*</span> @param filename      待进行检测的图片路径（单张图片）
<span class="token operator">*</span> @param thresh        阈值，类别检测概率大于该阈值才认为其检测结果有效
<span class="token operator">*</span> @param hier_thresh
<span class="token operator">*</span> @param outfile
<span class="token operator">*</span> @param fullscreen
<span class="token operator">*</span> @details 该函数为一个前向推理测试函数，不包括训练过程，因此如果要使用该函数，必须提前训练好网络，并加载训练好的网络参数文件，
<span class="token operator">*</span>          这些文件可以在作者网站上根据作者的提示下载到。本函数由darknet<span class="token punctuation">.</span>c中的主函数调用，严格来说，本文件不应纳入darknet网络结构文件夹中，
<span class="token operator">*</span>          其只是一个测试文件，或者说是一个example，应该放入到example文件夹中（新版的darknet已经这样做了，可以在github上查看）。
<span class="token operator">*</span>          本函数的流程为：<span class="token punctuation">.</span>
<span class="token operator">*</span><span class="token operator">/</span>
void test_detector<span class="token punctuation">(</span>char <span class="token operator">*</span>datacfg<span class="token punctuation">,</span> char <span class="token operator">*</span>cfgfile<span class="token punctuation">,</span> char <span class="token operator">*</span>weightfile<span class="token punctuation">,</span> char <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token builtin">float</span> thresh<span class="token punctuation">,</span>
    <span class="token builtin">float</span> hier_thresh<span class="token punctuation">,</span> <span class="token builtin">int</span> dont_show<span class="token punctuation">,</span> <span class="token builtin">int</span> ext_output<span class="token punctuation">,</span> <span class="token builtin">int</span> save_labels<span class="token punctuation">,</span> char <span class="token operator">*</span>outfile<span class="token punctuation">,</span> <span class="token builtin">int</span> letter_box<span class="token punctuation">,</span> <span class="token builtin">int</span> benchmark_layers<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">//</span> 从指定数据文件datacfg（<span class="token punctuation">.</span>data文件）中读入数据信息（测试、训练数据信息）到options中
	<span class="token operator">//</span> options是<span class="token builtin">list</span>类型数据，其中的node包含的void指针具体是kvp数据类型，具有键值和值（类似C<span class="token operator">+</span><span class="token operator">+</span>中的Map）
    <span class="token builtin">list</span> <span class="token operator">*</span>options <span class="token operator">=</span> read_data_cfg<span class="token punctuation">(</span>datacfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">//</span> 获取数据集的名称（包括路径），第二个参数<span class="token string">"names"</span>表明要从options中获取所用数据集的名称信息（如names <span class="token operator">=</span> data<span class="token operator">/</span>coco<span class="token punctuation">.</span>names）
    char <span class="token operator">*</span>name_list <span class="token operator">=</span> option_find_str<span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token string">"names"</span><span class="token punctuation">,</span> <span class="token string">"data/names.list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> names_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token operator">//</span> 从data<span class="token operator">/</span><span class="token operator">**</span><span class="token punctuation">.</span>names中读取物体名称<span class="token operator">/</span>标签信息
    char <span class="token operator">**</span>names <span class="token operator">=</span> get_labels_custom<span class="token punctuation">(</span>name_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>names_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">//</span>get_labels<span class="token punctuation">(</span>name_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token operator">//</span> 加载data<span class="token operator">/</span>labels<span class="token operator">/</span>文件夹中所有的字符标签图片
    image <span class="token operator">**</span>alphabet <span class="token operator">=</span> load_alphabet<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    network net <span class="token operator">=</span> parse_network_cfg_custom<span class="token punctuation">(</span>cfgfile<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token builtin">set</span> batch<span class="token operator">=</span><span class="token number">1</span>  配置各网络层参数，重要

</code></pre> 
<p>在parser.c中的parse_network_cfg_custom函数中，根据yolov3-tiny.cfg文件对网络结构进行配置，明确各层网络的类型、输入输出通道数、图像尺寸、卷积核大小等。</p> 
<pre><code class="prism language-python"><span class="token operator">//</span>配置各网络层参数
network parse_network_cfg_custom<span class="token punctuation">(</span>char <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token builtin">int</span> batch<span class="token punctuation">,</span> <span class="token builtin">int</span> time_steps<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">//</span> 从神经网络结构参数文件中读入所有神经网络层的结构参数，存储到sections中，
	<span class="token operator">//</span> sections的每个node包含一层神经网络的所有结构参数
    <span class="token builtin">list</span> <span class="token operator">*</span>sections <span class="token operator">=</span> read_cfg<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">//</span> 获取sections的第一个节点，可以查看一下cfg<span class="token operator">/</span><span class="token operator">**</span><span class="token operator">*</span><span class="token punctuation">.</span>cfg文件，其实第一块参数（以<span class="token punctuation">[</span>net<span class="token punctuation">]</span>开头）不是某层神经网络的参数，
	<span class="token operator">//</span> 而是关于整个网络的一些通用参数，比如学习率，衰减率，输入图像宽高，batch大小等，
	<span class="token operator">//</span> 具体的关于某个网络层的参数是从第二块开始的，如<span class="token punctuation">[</span>convolutional<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>maxpool<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>，
	<span class="token operator">//</span> 这些层并没有编号，只说明了层的属性，但层的参数都是按顺序在文件中排好的，读入时，
	<span class="token operator">//</span> sections链表上的顺序就是文件中的排列顺序。
    node <span class="token operator">*</span>n <span class="token operator">=</span> sections<span class="token operator">-</span><span class="token operator">&gt;</span>front<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>!n<span class="token punctuation">)</span> error<span class="token punctuation">(</span><span class="token string">"Config file has no sections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">//</span> 创建网络结构并动态分配内存：输入网络层数为sections<span class="token operator">-</span><span class="token operator">&gt;</span>size <span class="token operator">-</span> <span class="token number">1</span>，sections的第一段不是网络层，而是通用网络参数
    network net <span class="token operator">=</span> make_network<span class="token punctuation">(</span>sections<span class="token operator">-</span><span class="token operator">&gt;</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">//</span> 所用显卡的卡号（gpu_index在cuda<span class="token punctuation">.</span>c中用extern关键字声明）
	<span class="token operator">//</span> 在调用parse_network_cfg<span class="token punctuation">(</span><span class="token punctuation">)</span>之前，使用了cuda_set_device<span class="token punctuation">(</span><span class="token punctuation">)</span>设置了gpu_index的值号为当前活跃GPU卡号
    net<span class="token punctuation">.</span>gpu_index <span class="token operator">=</span> gpu_index<span class="token punctuation">;</span>
	<span class="token operator">//</span> size_params结构体元素不含指针变量
    size_params params<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>batch <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> params<span class="token punctuation">.</span>train <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token operator">//</span> allocates memory <span class="token keyword">for</span> Detection only
    <span class="token keyword">else</span> params<span class="token punctuation">.</span>train <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>              <span class="token operator">//</span> allocates memory <span class="token keyword">for</span> Detection <span class="token operator">&amp;</span> Training

    section <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token punctuation">(</span>section <span class="token operator">*</span><span class="token punctuation">)</span>n<span class="token operator">-</span><span class="token operator">&gt;</span>val<span class="token punctuation">;</span>
    <span class="token builtin">list</span> <span class="token operator">*</span>options <span class="token operator">=</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>options<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>!is_network<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> error<span class="token punctuation">(</span><span class="token string">"First section must be [net] or [network]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parse_net_options<span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token operator">&amp;</span>net<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">#ifdef GPU</span>
    printf<span class="token punctuation">(</span><span class="token string">"net.optimized_memory = %d n"</span><span class="token punctuation">,</span> net<span class="token punctuation">.</span>optimized_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>optimized_memory <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> params<span class="token punctuation">.</span>train<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pre_allocate_pinned_memory<span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token operator">//</span> pre<span class="token operator">-</span>allocate <span class="token number">8</span> GB CPU<span class="token operator">-</span>RAM <span class="token keyword">for</span> pinned memory
    <span class="token punctuation">}</span>
<span class="token comment">#endif  // GPU</span>

    params<span class="token punctuation">.</span>h <span class="token operator">=</span> net<span class="token punctuation">.</span>h<span class="token punctuation">;</span>
    params<span class="token punctuation">.</span>w <span class="token operator">=</span> net<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
    params<span class="token punctuation">.</span>c <span class="token operator">=</span> net<span class="token punctuation">.</span>c<span class="token punctuation">;</span>
    params<span class="token punctuation">.</span>inputs <span class="token operator">=</span> net<span class="token punctuation">.</span>inputs<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>batch <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> net<span class="token punctuation">.</span>batch <span class="token operator">=</span> batch<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>time_steps <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> net<span class="token punctuation">.</span>time_steps <span class="token operator">=</span> time_steps<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>batch <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> net<span class="token punctuation">.</span>batch <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>time_steps <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> net<span class="token punctuation">.</span>time_steps <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>batch <span class="token operator">&lt;</span> net<span class="token punctuation">.</span>time_steps<span class="token punctuation">)</span> net<span class="token punctuation">.</span>batch <span class="token operator">=</span> net<span class="token punctuation">.</span>time_steps<span class="token punctuation">;</span>
    params<span class="token punctuation">.</span>batch <span class="token operator">=</span> net<span class="token punctuation">.</span>batch<span class="token punctuation">;</span>
    params<span class="token punctuation">.</span>time_steps <span class="token operator">=</span> net<span class="token punctuation">.</span>time_steps<span class="token punctuation">;</span>
    params<span class="token punctuation">.</span>net <span class="token operator">=</span> net<span class="token punctuation">;</span>
    printf<span class="token punctuation">(</span><span class="token string">"mini_batch = %d, batch = %d, time_steps = %d, train = %d n"</span><span class="token punctuation">,</span> net<span class="token punctuation">.</span>batch<span class="token punctuation">,</span> net<span class="token punctuation">.</span>batch <span class="token operator">*</span> net<span class="token punctuation">.</span>subdivisions<span class="token punctuation">,</span> net<span class="token punctuation">.</span>time_steps<span class="token punctuation">,</span> params<span class="token punctuation">.</span>train<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">int</span> avg_outputs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token builtin">float</span> bflops <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    size_t workspace_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    size_t max_inputs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    size_t max_outputs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    n <span class="token operator">=</span> n<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token builtin">next</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    free_section<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token operator">//</span> 此处stderr不是错误提示，而是输出结果提示，提示网络结构
    fprintf<span class="token punctuation">(</span>stderr<span class="token punctuation">,</span> <span class="token string">"   layer   filters  size/strd(dil)      input                outputn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        params<span class="token punctuation">.</span>index <span class="token operator">=</span> count<span class="token punctuation">;</span>
        fprintf<span class="token punctuation">(</span>stderr<span class="token punctuation">,</span> <span class="token string">"%4d "</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        s <span class="token operator">=</span> <span class="token punctuation">(</span>section <span class="token operator">*</span><span class="token punctuation">)</span>n<span class="token operator">-</span><span class="token operator">&gt;</span>val<span class="token punctuation">;</span>
        options <span class="token operator">=</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>options<span class="token punctuation">;</span>
		<span class="token operator">//</span> 定义网络层
        layer l <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">(</span>LAYER_TYPE<span class="token punctuation">)</span><span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token operator">//</span> 获取网络层的类别

        LAYER_TYPE lt <span class="token operator">=</span> string_to_layer_type<span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token operator">//</span>通过读取网络类型，从而配置各网络层的参数
        <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> CONVOLUTIONAL<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token operator">//</span>yolov3<span class="token operator">-</span>tiny  卷积层  <span class="token number">13</span>层
            l <span class="token operator">=</span> parse_convolutional<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> LOCAL<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_local<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> ACTIVE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_activation<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> RNN<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_rnn<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> GRU<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_gru<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> LSTM<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_lstm<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lt <span class="token operator">==</span> CONV_LSTM<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_conv_lstm<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> CRNN<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_crnn<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> CONNECTED<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_connected<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> CROP<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_crop<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> COST<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_cost<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            l<span class="token punctuation">.</span>keep_delta_gpu <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> REGION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_region<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            l<span class="token punctuation">.</span>keep_delta_gpu <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lt <span class="token operator">==</span> YOLO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>yolov3<span class="token operator">-</span>tiny YOLO层  两层
            l <span class="token operator">=</span> parse_yolo<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            l<span class="token punctuation">.</span>keep_delta_gpu <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lt <span class="token operator">==</span> GAUSSIAN_YOLO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_gaussian_yolo<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            l<span class="token punctuation">.</span>keep_delta_gpu <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> DETECTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_detection<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> SOFTMAX<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_softmax<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            net<span class="token punctuation">.</span>hierarchy <span class="token operator">=</span> l<span class="token punctuation">.</span>softmax_tree<span class="token punctuation">;</span>
            l<span class="token punctuation">.</span>keep_delta_gpu <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> NORMALIZATION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_normalization<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> BATCHNORM<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_batchnorm<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> MAXPOOL<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token operator">//</span>yolov3<span class="token operator">-</span>tiny 池化层 maxpool  <span class="token number">6</span>层
            l <span class="token operator">=</span> parse_maxpool<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lt <span class="token operator">==</span> LOCAL_AVGPOOL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_local_avgpool<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> REORG<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_reorg<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lt <span class="token operator">==</span> REORG_OLD<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_reorg_old<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> AVGPOOL<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_avgpool<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> ROUTE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token operator">//</span>yolov3<span class="token operator">-</span>tiny 路由层 <span class="token number">2</span>层
            l <span class="token operator">=</span> parse_route<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token builtin">int</span> k<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>l<span class="token punctuation">.</span>input_layers<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>use_bin_output <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>l<span class="token punctuation">.</span>input_layers<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>keep_delta_gpu <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lt <span class="token operator">==</span> UPSAMPLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>yolov3<span class="token operator">-</span>tiny 上采样层 <span class="token number">1</span>层
            l <span class="token operator">=</span> parse_upsample<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">,</span> net<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> SHORTCUT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_shortcut<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">,</span> net<span class="token punctuation">)</span><span class="token punctuation">;</span>
            net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>use_bin_output <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>l<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>use_bin_output <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>l<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>keep_delta_gpu <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lt <span class="token operator">==</span> SCALE_CHANNELS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_scale_channels<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">,</span> net<span class="token punctuation">)</span><span class="token punctuation">;</span>
            net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>use_bin_output <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>l<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>use_bin_output <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>l<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>keep_delta_gpu <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lt <span class="token operator">==</span> SAM<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_sam<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">,</span> net<span class="token punctuation">)</span><span class="token punctuation">;</span>
            net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>use_bin_output <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>l<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>use_bin_output <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>l<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>keep_delta_gpu <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lt <span class="token operator">==</span> DROPOUT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            l <span class="token operator">=</span> parse_dropout<span class="token punctuation">(</span>options<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            l<span class="token punctuation">.</span>output <span class="token operator">=</span> net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>output<span class="token punctuation">;</span>
            l<span class="token punctuation">.</span>delta <span class="token operator">=</span> net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre> 
<h2>
<a id="2__224"></a>2. 下载权重文件</h2> 
<p>在parser.c的load_weights_upto中，根据卷积层的网络配置，开始下载读取各层的权重文件。</p> 
<pre><code class="prism language-python"><span class="token operator">//</span>读取权重文件函数
void load_weights_upto<span class="token punctuation">(</span>network <span class="token operator">*</span>net<span class="token punctuation">,</span> char <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token builtin">int</span> cutoff<span class="token punctuation">)</span><span class="token operator">//</span>cutoff <span class="token operator">=</span> net<span class="token operator">-</span><span class="token operator">&gt;</span>n
<span class="token punctuation">{<!-- --></span>
<span class="token comment">#ifdef GPU</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>net<span class="token operator">-</span><span class="token operator">&gt;</span>gpu_index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        cuda_set_device<span class="token punctuation">(</span>net<span class="token operator">-</span><span class="token operator">&gt;</span>gpu_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">#endif</span>
    fprintf<span class="token punctuation">(</span>stderr<span class="token punctuation">,</span> <span class="token string">"Loading weights from %s...n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    FILE <span class="token operator">*</span>fp <span class="token operator">=</span> fopen<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>!fp<span class="token punctuation">)</span> file_error<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">int</span> major<span class="token punctuation">;</span>
    <span class="token builtin">int</span> minor<span class="token punctuation">;</span>
    <span class="token builtin">int</span> revision<span class="token punctuation">;</span>
    fread<span class="token punctuation">(</span><span class="token operator">&amp;</span>major<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>读取一个<span class="token number">4</span>字节的数据
    fread<span class="token punctuation">(</span><span class="token operator">&amp;</span>minor<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>读取一个<span class="token number">4</span>字节的数据
    fread<span class="token punctuation">(</span><span class="token operator">&amp;</span>revision<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>读取一个<span class="token number">4</span>字节的数据
	printf<span class="token punctuation">(</span><span class="token string">"the size of int in x64 is %d bytes,attention!!!n"</span><span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>x86 x64<span class="token punctuation">:</span> <span class="token number">4</span>
	printf<span class="token punctuation">(</span><span class="token string">"major ,minor,revision of weight is %d, %d ,%dn"</span><span class="token punctuation">,</span> major<span class="token punctuation">,</span> minor<span class="token punctuation">,</span> revision<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span><span class="token number">0.2</span><span class="token number">.0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>major <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> minor<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>运行这一部分
        printf<span class="token punctuation">(</span><span class="token string">"n seen 64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uint64_t iseen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        fread<span class="token punctuation">(</span><span class="token operator">&amp;</span>iseen<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span>uint64_t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>读取一个<span class="token number">8</span>字节的数据
		printf<span class="token punctuation">(</span><span class="token string">"the size of uint64_t is %dn"</span><span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span>uint64_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>net<span class="token operator">-</span><span class="token operator">&gt;</span>seen <span class="token operator">=</span> iseen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        printf<span class="token punctuation">(</span><span class="token string">"n seen 32"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uint32_t iseen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        fread<span class="token punctuation">(</span><span class="token operator">&amp;</span>iseen<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>net<span class="token operator">-</span><span class="token operator">&gt;</span>seen <span class="token operator">=</span> iseen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>net<span class="token operator">-</span><span class="token operator">&gt;</span>cur_iteration <span class="token operator">=</span> get_current_batch<span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">)</span><span class="token punctuation">;</span>
    printf<span class="token punctuation">(</span><span class="token string">", trained: %.0f K-images (%.0f Kilo-batches_64) n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token operator">-</span><span class="token operator">&gt;</span>seen <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token operator">-</span><span class="token operator">&gt;</span>seen <span class="token operator">/</span> <span class="token number">64000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> transpose <span class="token operator">=</span> <span class="token punctuation">(</span>major <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token punctuation">(</span>minor <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> net<span class="token operator">-</span><span class="token operator">&gt;</span>n <span class="token operator">&amp;</span><span class="token operator">&amp;</span> i <span class="token operator">&lt;</span> cutoff<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token operator">//</span>cutoff <span class="token operator">=</span> net<span class="token operator">-</span><span class="token operator">&gt;</span>n
        layer l <span class="token operator">=</span> net<span class="token operator">-</span><span class="token operator">&gt;</span>layers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>dontload<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token operator">//</span>always <span class="token number">0</span>		跳过之后的循环体，直接运行<span class="token operator">+</span><span class="token operator">+</span>i
        <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> CONVOLUTIONAL <span class="token operator">&amp;</span><span class="token operator">&amp;</span> l<span class="token punctuation">.</span>share_layer <span class="token operator">==</span> NULL<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token operator">//</span>只运行这一个分支的代码
            load_convolutional_weights<span class="token punctuation">(</span>l<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token operator">//</span>printf<span class="token punctuation">(</span><span class="token string">"network layer [%d] is CONVOLUTIONAL n"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre> 
<p>在读取yolov3-tiny各层权重文件前，先读取4个和训练有关的参数：major，minor, revision和iseen。在前向传播的工程当中，并没有实际的应用。</p> 
<p>parser.c中的load_convolutional_weights函数，具体执行对yolov3-tiny权重文件的下载，包括节点参数weight，偏置参数bias和批量归一化参数BN。</p> 
<pre><code class="prism language-python">void load_convolutional_weights<span class="token punctuation">(</span>layer l<span class="token punctuation">,</span> FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	static <span class="token builtin">int</span> flipped_num<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>binary<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token operator">//</span>load_convolutional_weights_binary<span class="token punctuation">(</span>l<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">//</span><span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token builtin">int</span> num <span class="token operator">=</span> l<span class="token punctuation">.</span>nweights<span class="token punctuation">;</span>
	<span class="token operator">//</span><span class="token builtin">int</span> num <span class="token operator">=</span> l<span class="token punctuation">.</span>n<span class="token operator">*</span>l<span class="token punctuation">.</span>c<span class="token operator">*</span>l<span class="token punctuation">.</span>size<span class="token operator">*</span>l<span class="token punctuation">.</span>size<span class="token punctuation">;</span><span class="token operator">//</span>l<span class="token punctuation">.</span>n 输出的层数 l<span class="token punctuation">.</span>c输入的层数 
    <span class="token builtin">int</span> read_bytes<span class="token punctuation">;</span>
    read_bytes <span class="token operator">=</span> fread<span class="token punctuation">(</span>l<span class="token punctuation">.</span>biases<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>n<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>读取偏置参数 l<span class="token punctuation">.</span>n个<span class="token builtin">float</span>数据
    <span class="token keyword">if</span> <span class="token punctuation">(</span>read_bytes <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> read_bytes <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>n<span class="token punctuation">)</span> printf<span class="token punctuation">(</span><span class="token string">"n Warning: Unexpected end of wights-file! l.biases - l.index = %d n"</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">//</span>fread<span class="token punctuation">(</span>l<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token keyword">as</span> <span class="token keyword">in</span> connected layer
    <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>batch_normalize <span class="token operator">&amp;</span><span class="token operator">&amp;</span> <span class="token punctuation">(</span>!l<span class="token punctuation">.</span>dontloadscales<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        read_bytes <span class="token operator">=</span> fread<span class="token punctuation">(</span>l<span class="token punctuation">.</span>scales<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>n<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>读取batch normalize 参数  l<span class="token punctuation">.</span>n个<span class="token builtin">float</span>数据
        <span class="token keyword">if</span> <span class="token punctuation">(</span>read_bytes <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> read_bytes <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>n<span class="token punctuation">)</span> printf<span class="token punctuation">(</span><span class="token string">"n Warning: Unexpected end of wights-file! l.scales - l.index = %d n"</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        read_bytes <span class="token operator">=</span> fread<span class="token punctuation">(</span>l<span class="token punctuation">.</span>rolling_mean<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>n<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>读取batch normalize 参数  l<span class="token punctuation">.</span>n个<span class="token builtin">float</span>数据
        <span class="token keyword">if</span> <span class="token punctuation">(</span>read_bytes <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> read_bytes <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>n<span class="token punctuation">)</span> printf<span class="token punctuation">(</span><span class="token string">"n Warning: Unexpected end of wights-file! l.rolling_mean - l.index = %d n"</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        read_bytes <span class="token operator">=</span> fread<span class="token punctuation">(</span>l<span class="token punctuation">.</span>rolling_variance<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>n<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>读取batch normalize 参数  l<span class="token punctuation">.</span>n个<span class="token builtin">float</span>数据
        <span class="token keyword">if</span> <span class="token punctuation">(</span>read_bytes <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> read_bytes <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>n<span class="token punctuation">)</span> printf<span class="token punctuation">(</span><span class="token string">"n Warning: Unexpected end of wights-file! l.rolling_variance - l.index = %d n"</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p><strong>将权重参数批量归一化</strong></p> 
<p>yolov3-tiny每个卷积层之后，激活函数之前，都要对结果进行Batch Normalization：<br> <img src="https://images2.imgbox.com/ed/31/BaUTj1jQ_o.png" alt="在这里插入图片描述"><br> 由于BN层和卷积操作都是线性的，将权重文件进行批量归一化，可以代替卷积层之后的BN层：<br> <img src="https://images2.imgbox.com/e6/27/iazbdPdC_o.png" alt="在这里插入图片描述">在network.c的fuse_conv_batchnorm函数中实现权重文件和BN层的合并。</p> 
<pre><code class="prism language-python">void fuse_conv_batchnorm<span class="token punctuation">(</span>network net<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token builtin">int</span> j<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> net<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        layer <span class="token operator">*</span>l <span class="token operator">=</span> <span class="token operator">&amp;</span>net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
		    <span class="token operator">//</span> printf<span class="token punctuation">(</span><span class="token string">"the %d layer batch_normalize is %d,   groups is %d n"</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> l<span class="token operator">-</span><span class="token operator">&gt;</span>batch_normalize<span class="token punctuation">,</span> l<span class="token operator">-</span><span class="token operator">&gt;</span>groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token builtin">type</span> <span class="token operator">==</span> CONVOLUTIONAL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">//</span>只运行这一分支   合并卷积层和batch_normal
             <span class="token operator">//</span>printf<span class="token punctuation">(</span><span class="token string">" Merges Convolutional-%d and batch_norm n"</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-</span><span class="token operator">&gt;</span>share_layer <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>l<span class="token operator">-</span><span class="token operator">&gt;</span>share_layer always <span class="token keyword">is</span> <span class="token number">0</span><span class="token punctuation">,</span>不运行这个分支
                l<span class="token operator">-</span><span class="token operator">&gt;</span>batch_normalize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token operator">-</span><span class="token operator">&gt;</span>batch_normalize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span><span class="token comment">#15,22层卷积，卷积之后没有batch normalize，其他都要运行这一分支</span>
                <span class="token builtin">int</span> f<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> f <span class="token operator">&lt;</span> l<span class="token operator">-</span><span class="token operator">&gt;</span>n<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>f<span class="token punctuation">)</span><span class="token operator">//</span>该层神经网络 <span class="token number">1</span><span class="token operator">-</span><span class="token operator">&gt;</span>n 个输出层权重
                <span class="token punctuation">{<!-- --></span>
                    l<span class="token operator">-</span><span class="token operator">&gt;</span>biases<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">=</span> l<span class="token operator">-</span><span class="token operator">&gt;</span>biases<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">(</span>double<span class="token punctuation">)</span>l<span class="token operator">-</span><span class="token operator">&gt;</span>scales<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">*</span> l<span class="token operator">-</span><span class="token operator">&gt;</span>rolling_mean<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span>l<span class="token operator">-</span><span class="token operator">&gt;</span>rolling_variance<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">.00001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    const size_t filter_size <span class="token operator">=</span> l<span class="token operator">-</span><span class="token operator">&gt;</span>size<span class="token operator">*</span>l<span class="token operator">-</span><span class="token operator">&gt;</span>size<span class="token operator">*</span>l<span class="token operator">-</span><span class="token operator">&gt;</span>c <span class="token operator">/</span> l<span class="token operator">-</span><span class="token operator">&gt;</span>groups<span class="token punctuation">;</span><span class="token operator">//</span>kernel_size <span class="token operator">*</span> kernel_size <span class="token operator">*</span> c<span class="token operator">/</span>分组  l<span class="token operator">-</span><span class="token operator">&gt;</span>groups存在于卷积层always <span class="token keyword">is</span> <span class="token number">1</span>
                    <span class="token builtin">int</span> i<span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> filter_size<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token builtin">int</span> w_index <span class="token operator">=</span> f<span class="token operator">*</span>filter_size <span class="token operator">+</span> i<span class="token punctuation">;</span>

                        l<span class="token operator">-</span><span class="token operator">&gt;</span>weights<span class="token punctuation">[</span>w_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>double<span class="token punctuation">)</span>l<span class="token operator">-</span><span class="token operator">&gt;</span>weights<span class="token punctuation">[</span>w_index<span class="token punctuation">]</span> <span class="token operator">*</span> l<span class="token operator">-</span><span class="token operator">&gt;</span>scales<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span>l<span class="token operator">-</span><span class="token operator">&gt;</span>rolling_variance<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">.00001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                free_convolutional_batchnorm<span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>no use
                l<span class="token operator">-</span><span class="token operator">&gt;</span>batch_normalize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre> 
<h2>
<a id="3__350"></a>3. 输入图像</h2> 
<p>yolov3-tiny输入神经网络的图像尺寸为416x416，对不符合该尺寸的图像，要进行裁剪。在image.c的resize_image函数中完成。这个可以说是整个yolo算法对输入图像唯一进行预处理的地方了。这也是yolo算法在工程应用中极好的地方，没有那么多类似于降噪、滤波之类的预处理，直接送到网络里就完事了。</p> 
<pre><code class="prism language-python"><span class="token operator">//</span>im：输入图片  w<span class="token punctuation">:</span><span class="token number">416</span> h<span class="token punctuation">:</span><span class="token number">416</span>
<span class="token operator">//</span>函数作用：将输入图片热size到416x416的尺寸，基本按照缩放<span class="token operator">/</span>扩大的策略
image resize_image<span class="token punctuation">(</span>image im<span class="token punctuation">,</span> <span class="token builtin">int</span> w<span class="token punctuation">,</span> <span class="token builtin">int</span> h<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>im<span class="token punctuation">.</span>w <span class="token operator">==</span> w <span class="token operator">&amp;</span><span class="token operator">&amp;</span> im<span class="token punctuation">.</span>h <span class="token operator">==</span> h<span class="token punctuation">)</span> <span class="token keyword">return</span> copy_image<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">;</span>

    image resized <span class="token operator">=</span> make_image<span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> im<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span><span class="token number">416</span> x <span class="token number">416</span> x <span class="token number">3</span>空的地址空间
    image part <span class="token operator">=</span> make_image<span class="token punctuation">(</span>w<span class="token punctuation">,</span> im<span class="token punctuation">.</span>h<span class="token punctuation">,</span> im<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span><span class="token number">416</span> x im<span class="token punctuation">.</span>h x im<span class="token punctuation">.</span>c空的地址空间
    <span class="token builtin">int</span> r<span class="token punctuation">,</span> c<span class="token punctuation">,</span> k<span class="token punctuation">;</span>
    <span class="token builtin">float</span> w_scale <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>im<span class="token punctuation">.</span>w <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>w <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>宽度缩放因子
    <span class="token builtin">float</span> h_scale <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>im<span class="token punctuation">.</span>h <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>h <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>高度缩放因子
    <span class="token keyword">for</span><span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> im<span class="token punctuation">.</span>c<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>k<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> im<span class="token punctuation">.</span>h<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>c<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token operator">//</span><span class="token number">416</span>
                <span class="token builtin">float</span> val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>c <span class="token operator">==</span> w<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span> im<span class="token punctuation">.</span>w <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token operator">//</span>c <span class="token operator">=</span><span class="token number">415</span> 最后一列
                    val <span class="token operator">=</span> get_pixel<span class="token punctuation">(</span>im<span class="token punctuation">,</span> im<span class="token punctuation">.</span>w<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>取原图片最后一列的像素
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token builtin">float</span> sx <span class="token operator">=</span> c<span class="token operator">*</span>w_scale<span class="token punctuation">;</span>
                    <span class="token builtin">int</span> ix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> sx<span class="token punctuation">;</span>
                    <span class="token builtin">float</span> dx <span class="token operator">=</span> sx <span class="token operator">-</span> ix<span class="token punctuation">;</span>
                    val <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> dx<span class="token punctuation">)</span> <span class="token operator">*</span> get_pixel<span class="token punctuation">(</span>im<span class="token punctuation">,</span> ix<span class="token punctuation">,</span> r<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+</span> dx <span class="token operator">*</span> get_pixel<span class="token punctuation">(</span>im<span class="token punctuation">,</span> ix<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                set_pixel<span class="token punctuation">(</span>part<span class="token punctuation">,</span> c<span class="token punctuation">,</span> r<span class="token punctuation">,</span> k<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> im<span class="token punctuation">.</span>c<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>k<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> h<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token builtin">float</span> sy <span class="token operator">=</span> r<span class="token operator">*</span>h_scale<span class="token punctuation">;</span>
            <span class="token builtin">int</span> iy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> sy<span class="token punctuation">;</span>
            <span class="token builtin">float</span> dy <span class="token operator">=</span> sy <span class="token operator">-</span> iy<span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>c<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token builtin">float</span> val <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>dy<span class="token punctuation">)</span> <span class="token operator">*</span> get_pixel<span class="token punctuation">(</span>part<span class="token punctuation">,</span> c<span class="token punctuation">,</span> iy<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                set_pixel<span class="token punctuation">(</span>resized<span class="token punctuation">,</span> c<span class="token punctuation">,</span> r<span class="token punctuation">,</span> k<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">==</span> h<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span> im<span class="token punctuation">.</span>h <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>c<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token builtin">float</span> val <span class="token operator">=</span> dy <span class="token operator">*</span> get_pixel<span class="token punctuation">(</span>part<span class="token punctuation">,</span> c<span class="token punctuation">,</span> iy<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                add_pixel<span class="token punctuation">(</span>resized<span class="token punctuation">,</span> c<span class="token punctuation">,</span> r<span class="token punctuation">,</span> k<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    free_image<span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resized<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2>
<a id="4__404"></a>4. 前向传播网络</h2> 
<p>network.c中的forward_network函数是整个神经网络的核心部分，各层的网络都在函数指针l.forward(l, state)中完成。</p> 
<pre><code class="prism language-python">void forward_network<span class="token punctuation">(</span>network net<span class="token punctuation">,</span> network_state state<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    state<span class="token punctuation">.</span>workspace <span class="token operator">=</span> net<span class="token punctuation">.</span>workspace<span class="token punctuation">;</span>
    <span class="token builtin">int</span> i<span class="token punctuation">;</span>
	   <span class="token operator">//</span><span class="token operator">/</span> 遍历所有层，从第一层到最后一层，逐层进行前向传播（网络总共有net<span class="token punctuation">.</span>n层）
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> net<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>		  
        state<span class="token punctuation">.</span>index <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token operator">//</span><span class="token operator">/</span> 置网络当前活跃层为当前层，即第i层		  
        layer l <span class="token operator">=</span> net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">//</span><span class="token operator">/</span> 获取当前层		  
        <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>delta <span class="token operator">&amp;</span><span class="token operator">&amp;</span> state<span class="token punctuation">.</span>train<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token operator">//</span>不执行此分支的代码
			<span class="token operator">//</span><span class="token operator">/</span> 如果当前层的l<span class="token punctuation">.</span>delta已经动态分配了内存，则调用fill_cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>函数，将其所有元素的值初始化为<span class="token number">0</span>			   
            scal_cpu<span class="token punctuation">(</span>l<span class="token punctuation">.</span>outputs <span class="token operator">*</span> l<span class="token punctuation">.</span>batch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>delta<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span><span class="token operator">/</span> 第一个参数为l<span class="token punctuation">.</span>delta的元素个数，第二个参数为初始化值，为<span class="token number">0</span>
			printf<span class="token punctuation">(</span><span class="token string">"forward_network scal_cpu of %d layer done!n "</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
           <span class="token operator">//</span>double time <span class="token operator">=</span> get_time_point<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		l<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>l<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>进行卷积运算，激活函数，池化运算<span class="token operator">/</span>
		   <span class="token operator">//</span><span class="token keyword">if</span> layer_type <span class="token operator">=</span> convolutional <span class="token punctuation">;</span>   l<span class="token punctuation">.</span>forward <span class="token operator">=</span> forward_convolutional_layer<span class="token punctuation">;</span>
		   <span class="token operator">//</span><span class="token keyword">if</span> layer_type <span class="token operator">=</span> maxpool           l<span class="token punctuation">.</span>forward <span class="token operator">=</span> forward_maxpool_layer<span class="token punctuation">;</span>
		   <span class="token operator">//</span><span class="token keyword">if</span> layer_type <span class="token operator">=</span> yolo              l<span class="token punctuation">.</span>forward <span class="token operator">=</span> forward_yolo_layer<span class="token punctuation">;</span>
		   <span class="token operator">//</span><span class="token keyword">if</span> layer_type <span class="token operator">=</span> ROUTE             l<span class="token punctuation">.</span>forward <span class="token operator">=</span> forward_route_layer<span class="token punctuation">;</span>其实就是数据的复制和搬移
		   <span class="token operator">//</span><span class="token keyword">if</span> layer_type <span class="token operator">=</span> upsample          l<span class="token punctuation">.</span>forward <span class="token operator">=</span> forward_upsample_layer<span class="token punctuation">;</span><span class="token punctuation">;</span>		  
           <span class="token operator">//</span>printf<span class="token punctuation">(</span><span class="token string">"%d - Predicted in %lf milli-seconds.n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span>get_time_point<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		   <span class="token operator">//</span><span class="token operator">/</span> 完成某一层的推理时，置网络的输入为当前层的输出（这将成为下一层网络的输入），要注意的是，此处是直接更改指针变量net<span class="token punctuation">.</span><span class="token builtin">input</span>本身的值，
		   <span class="token operator">//</span><span class="token operator">/</span> 也就是此处是通过改变指针net<span class="token punctuation">.</span><span class="token builtin">input</span>所指的地址来改变其中所存内容的值，并不是直接改变其所指的内容而指针所指的地址没变，
		   <span class="token operator">//</span><span class="token operator">/</span> 所以在退出forward_network<span class="token punctuation">(</span><span class="token punctuation">)</span>函数后，其对net<span class="token punctuation">.</span><span class="token builtin">input</span>的改变都将失效，net<span class="token punctuation">.</span><span class="token builtin">input</span>将回到进入forward_network<span class="token punctuation">(</span><span class="token punctuation">)</span>之前时的值。	
		   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre> 
<h2>
<a id="5_convolution_437"></a>5. 卷积层[convolution]</h2> 
<p>卷积层在convolutional_layer.c中的forward_convolutional_layer函数实现。</p> 
<pre><code class="prism language-python">void forward_convolutional_layer<span class="token punctuation">(</span>convolutional_layer l<span class="token punctuation">,</span> network_state state<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    
	<span class="token builtin">int</span> out_h <span class="token operator">=</span> convolutional_out_height<span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>获得本层卷积层输出特征图的高、宽
    <span class="token builtin">int</span> out_w <span class="token operator">=</span> convolutional_out_width<span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	
	<span class="token operator">//</span> l<span class="token punctuation">.</span>outputs <span class="token operator">=</span> l<span class="token punctuation">.</span>out_h <span class="token operator">*</span> l<span class="token punctuation">.</span>out_w <span class="token operator">*</span> l<span class="token punctuation">.</span>out_c在make各网络层函数中赋值（比如make_convolutional_layer<span class="token punctuation">(</span><span class="token punctuation">)</span>），
	<span class="token operator">//</span> 对应每张输入图片的所有输出特征图的总元素个数（每张输入图片会得到n也即l<span class="token punctuation">.</span>out_c张特征图）
	<span class="token operator">//</span> 初始化输出l<span class="token punctuation">.</span>output全为<span class="token number">0.0</span>；输入l<span class="token punctuation">.</span>outputs<span class="token operator">*</span>l<span class="token punctuation">.</span>batch为输出的总元素个数，其中l<span class="token punctuation">.</span>outputs为batch
	<span class="token operator">//</span> 中一个输入对应的输出的所有元素的个数，l<span class="token punctuation">.</span>batch为一个batch输入包含的图片张数；<span class="token number">0</span>表示初始化所有输出为<span class="token number">0</span>；
    fill_cpu<span class="token punctuation">(</span>l<span class="token punctuation">.</span>outputs<span class="token operator">*</span>l<span class="token punctuation">.</span>batch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>output<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>将地址l<span class="token punctuation">.</span>output，l<span class="token punctuation">.</span>outputs<span class="token operator">*</span>l<span class="token punctuation">.</span>batch个<span class="token builtin">float</span>地址空间的数据初始化<span class="token number">0</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre> 
<p>作者在进行卷积运算前，将输入特征图进行重新排序：</p> 
<pre><code class="prism language-python">
```c
void im2col_cpu<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token operator">*</span> data_im<span class="token punctuation">,</span>
     <span class="token builtin">int</span> channels<span class="token punctuation">,</span>  <span class="token builtin">int</span> height<span class="token punctuation">,</span>  <span class="token builtin">int</span> width<span class="token punctuation">,</span>
     <span class="token builtin">int</span> ksize<span class="token punctuation">,</span>  <span class="token builtin">int</span> stride<span class="token punctuation">,</span> <span class="token builtin">int</span> pad<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token operator">*</span> data_col<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token builtin">int</span> c<span class="token punctuation">,</span>h<span class="token punctuation">,</span>w<span class="token punctuation">;</span>
	<span class="token operator">//</span> 计算该层神经网络的输出图像尺寸（其实没有必要再次计算的，因为在构建卷积层时，make_convolutional_layer<span class="token punctuation">(</span><span class="token punctuation">)</span>函数
	<span class="token operator">//</span> 已经调用convolutional_out_width<span class="token punctuation">(</span><span class="token punctuation">)</span>，convolutional_out_height<span class="token punctuation">(</span><span class="token punctuation">)</span>函数求取了这两个参数，
	<span class="token operator">//</span> 此处直接使用l<span class="token punctuation">.</span>out_h<span class="token punctuation">,</span>l<span class="token punctuation">.</span>out_w即可，函数参数只要传入该层网络指针就可了，没必要弄这么多参数）
    <span class="token builtin">int</span> height_col <span class="token operator">=</span> <span class="token punctuation">(</span>height <span class="token operator">+</span> <span class="token number">2</span><span class="token operator">*</span>pad <span class="token operator">-</span> ksize<span class="token punctuation">)</span> <span class="token operator">/</span> stride <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> width_col <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">+</span> <span class="token number">2</span><span class="token operator">*</span>pad <span class="token operator">-</span> ksize<span class="token punctuation">)</span> <span class="token operator">/</span> stride <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	
	<span class="token operator">//</span><span class="token operator">/</span> 卷积核大小：ksize<span class="token operator">*</span>ksize是一个卷积核的大小，之所以乘以通道数channels，是因为输入图像有多通道，每个卷积核在做卷积时，
	<span class="token operator">//</span><span class="token operator">/</span> 是同时对同一位置处多通道的图像进行卷积运算，这里为了实现这一目的，将三通道上的卷积核并在一起以便进行计算，因此卷积核
	<span class="token operator">//</span><span class="token operator">/</span> 实际上并不是二维的，而是三维的，比如对于<span class="token number">3</span>通道图像，卷积核尺寸为<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>，该卷积核将同时作用于三通道图像上，这样并起来就得
	<span class="token operator">//</span><span class="token operator">/</span> 到含有<span class="token number">27</span>个元素的卷积核，且这<span class="token number">27</span>个元素都是独立的需要训练的参数。所以在计算训练参数个数时，一定要注意每一个卷积核的实际
	<span class="token operator">//</span><span class="token operator">/</span> 训练参数需要乘以输入通道数。
    <span class="token builtin">int</span> channels_col <span class="token operator">=</span> channels <span class="token operator">*</span> ksize <span class="token operator">*</span> ksize<span class="token punctuation">;</span><span class="token operator">//</span>输入通道
	<span class="token operator">//</span> 外循环次数为一个卷积核的尺寸数，循环次数即为最终得到的data_col的总行数
    <span class="token keyword">for</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> channels_col<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token operator">//</span>行，列偏置都是对应着本次循环要操作的输出位置的像素而言的，通道偏置，是该位置像素所在的输出通道的绝对位置（通道数）

		<span class="token operator">//</span> 列偏移，卷积核是一个二维矩阵，并按行存储在一维数组中，利用求余运算获取对应在卷积核中的列数，比如对于
		<span class="token operator">//</span> <span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>的卷积核（<span class="token number">3</span>通道），当c<span class="token operator">=</span><span class="token number">0</span>时，显然在第一列，当c<span class="token operator">=</span><span class="token number">5</span>时，显然在第<span class="token number">2</span>列，当c<span class="token operator">=</span><span class="token number">9</span>时，在第二通道上的卷积核的第一列，
		<span class="token operator">//</span> 当c<span class="token operator">=</span><span class="token number">26</span>时，在第三列（第三输入通道上）
        <span class="token builtin">int</span> w_offset <span class="token operator">=</span> c <span class="token operator">%</span> ksize<span class="token punctuation">;</span><span class="token operator">//</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>
		<span class="token operator">//</span> 行偏移，卷积核是一个二维的矩阵，且是按行（卷积核所有行并成一行）存储在一维数组中的，
		<span class="token operator">//</span> 比如对于<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>的卷积核，处理<span class="token number">3</span>通道的图像，那么一个卷积核具有<span class="token number">27</span>个元素，每<span class="token number">9</span>个元素对应一个通道上的卷积核（互为一样），
		<span class="token operator">//</span> 每当c为<span class="token number">3</span>的倍数，就意味着卷积核换了一行，h_offset取值为<span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>，对应<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>卷积核中的第<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span>行
        <span class="token builtin">int</span> h_offset <span class="token operator">=</span> <span class="token punctuation">(</span>c <span class="token operator">/</span> ksize<span class="token punctuation">)</span> <span class="token operator">%</span> ksize<span class="token punctuation">;</span><span class="token operator">//</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>
		<span class="token operator">//</span> 通道偏移，channels_col是多通道的卷积核并在一起的，比如对于<span class="token number">3</span>通道，<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>卷积核，每过<span class="token number">9</span>个元素就要换一通道数，
		<span class="token operator">//</span> 当c<span class="token operator">=</span><span class="token number">0</span><span class="token operator">~</span><span class="token number">8</span>时，c_im<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>c<span class="token operator">=</span><span class="token number">9</span><span class="token operator">~</span><span class="token number">17</span>时，c_im<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>c<span class="token operator">=</span><span class="token number">18</span><span class="token operator">~</span><span class="token number">26</span>时，c_im<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>操作对象是排序后的像素位置
        <span class="token builtin">int</span> c_im <span class="token operator">=</span> c <span class="token operator">/</span> ksize <span class="token operator">/</span> ksize<span class="token punctuation">;</span>
		<span class="token operator">//</span> 中循环次数等于该层输出图像行数height_col，说明data_col中的每一行存储了一张特征图，这张特征图又是按行存储在data_col中的某行中
        <span class="token keyword">for</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> h <span class="token operator">&lt;</span> height_col<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>h<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token operator">//</span> 内循环等于该层输出图像列数width_col，说明最终得到的data_col总有channels_col行，height_col<span class="token operator">*</span>width_col列
            <span class="token keyword">for</span> <span class="token punctuation">(</span>w <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> w <span class="token operator">&lt;</span> width_col<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>w<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token operator">//</span> 由上面可知，对于<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>的卷积核，行偏置h_offset取值为<span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>当h_offset<span class="token operator">=</span><span class="token number">0</span>时，会提取出所有与卷积核第一行元素进行运算的像素，
				<span class="token operator">//</span> 依次类推；加上h<span class="token operator">*</span>stride是对卷积核进行行移位操作，比如卷积核从图像<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>位置开始做卷积，那么最先开始涉及<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
				<span class="token operator">//</span> 之间的像素值，若stride<span class="token operator">=</span><span class="token number">2</span>，那么卷积核进行一次行移位时，下一行的卷积操作是从元素<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>（<span class="token number">2</span>为图像行号，<span class="token number">0</span>为列号）开始
                <span class="token builtin">int</span> im_row <span class="token operator">=</span> h_offset <span class="token operator">+</span> h <span class="token operator">*</span> stride<span class="token punctuation">;</span><span class="token operator">//</span>yolov3<span class="token operator">-</span>tiny stride <span class="token operator">=</span> <span class="token number">1</span>
				<span class="token operator">//</span> 对于<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>的卷积核，w_offset取值也为<span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>，当w_offset取<span class="token number">1</span>时，会提取出所有与卷积核中第<span class="token number">2</span>列元素进行运算的像素，
				<span class="token operator">//</span> 实际在做卷积操作时，卷积核对图像逐行扫描做卷积，加上w<span class="token operator">*</span>stride就是为了做列移位，
				<span class="token operator">//</span> 比如前一次卷积其实像素元素为<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>，若stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>那么下次卷积元素起始像素位置为<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>（<span class="token number">0</span>为行号，<span class="token number">2</span>为列号）
                <span class="token builtin">int</span> im_col <span class="token operator">=</span> w_offset <span class="token operator">+</span> w <span class="token operator">*</span> stride<span class="token punctuation">;</span>
				<span class="token operator">//</span> col_index为重排后图像中的像素索引，等于c <span class="token operator">*</span> height_col <span class="token operator">*</span> width_col <span class="token operator">+</span> h <span class="token operator">*</span> width_col <span class="token operator">+</span>w（还是按行存储，所有通道再并成一行），
				<span class="token operator">//</span> 对应第c通道，h行，w列的元素
                <span class="token builtin">int</span> col_index <span class="token operator">=</span> <span class="token punctuation">(</span>c <span class="token operator">*</span> height_col <span class="token operator">+</span> h<span class="token punctuation">)</span> <span class="token operator">*</span> width_col <span class="token operator">+</span> w<span class="token punctuation">;</span><span class="token operator">//</span>将重排后的图片像素，按照左上<span class="token operator">-</span><span class="token operator">&gt;</span>右下的顺序，计算一维索引

				<span class="token operator">//</span>im_col <span class="token operator">+</span> width<span class="token operator">*</span>im_row <span class="token operator">+</span>  width<span class="token operator">*</span>height<span class="token operator">*</span>channel 重排前的特征图在内存中的位置索引
				<span class="token operator">//</span> im2col_get_pixel函数获取输入图像data_im中第c_im通道，im_row<span class="token punctuation">,</span>im_col的像素值并赋值给重排后的图像，
				<span class="token operator">//</span> height和width为输入图像data_im的真实高、宽，pad为四周补<span class="token number">0</span>的长度（注意im_row<span class="token punctuation">,</span>im_col是补<span class="token number">0</span>之后的行列号，
				<span class="token operator">//</span> 不是真实输入图像中的行列号，因此需要减去pad获取真实的行列号）
                data_col<span class="token punctuation">[</span>col_index<span class="token punctuation">]</span> <span class="token operator">=</span> im2col_get_pixel<span class="token punctuation">(</span>data_im<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> channels<span class="token punctuation">,</span>
                        im_row<span class="token punctuation">,</span> im_col<span class="token punctuation">,</span> c_im<span class="token punctuation">,</span> pad<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token operator">//</span> <span class="token keyword">return</span> data_im<span class="token punctuation">[</span>im_col <span class="token operator">+</span> width<span class="token operator">*</span>im_row <span class="token operator">+</span>  width<span class="token operator">*</span>height<span class="token operator">*</span>channel<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>通过gemm进行卷积乘加操作，通过add_bias添加偏置。</p> 
<pre><code class="prism language-python"><span class="token operator">//</span>进行卷积的乘加运算，没有bias偏置参数参与运算；
gemm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> k<span class="token punctuation">,</span> b<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>

add_bias<span class="token punctuation">(</span>l<span class="token punctuation">.</span>output<span class="token punctuation">,</span> l<span class="token punctuation">.</span>biases<span class="token punctuation">,</span> l<span class="token punctuation">.</span>batch<span class="token punctuation">,</span> l<span class="token punctuation">.</span>n<span class="token punctuation">,</span> out_h<span class="token operator">*</span>out_w<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>每个输出特征图的元素都加上对应通道的偏置参数

</code></pre> 
<h2>
<a id="6_maxpool_537"></a>6. 池化层[maxpool]</h2> 
<p>maxpool_layer.c中的forward_maxpool_layer函数完成池化操作。yolov3-tiny保留了池化层，并使用最大值池化，将尺寸为2x2的核中最大值保留下来。</p> 
<pre><code class="prism language-python">void forward_maxpool_layer_avx<span class="token punctuation">(</span><span class="token builtin">float</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token builtin">float</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token builtin">int</span> <span class="token operator">*</span>indexes<span class="token punctuation">,</span> <span class="token builtin">int</span> size<span class="token punctuation">,</span> <span class="token builtin">int</span> w<span class="token punctuation">,</span> <span class="token builtin">int</span> h<span class="token punctuation">,</span> <span class="token builtin">int</span> out_w<span class="token punctuation">,</span> <span class="token builtin">int</span> out_h<span class="token punctuation">,</span> <span class="token builtin">int</span> c<span class="token punctuation">,</span>
    <span class="token builtin">int</span> pad<span class="token punctuation">,</span> <span class="token builtin">int</span> stride<span class="token punctuation">,</span> <span class="token builtin">int</span> batch<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    const <span class="token builtin">int</span> w_offset <span class="token operator">=</span> <span class="token operator">-</span>pad <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    const <span class="token builtin">int</span> h_offset <span class="token operator">=</span> <span class="token operator">-</span>pad <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> b<span class="token punctuation">,</span> k<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b <span class="token operator">&lt;</span> batch<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token operator">//</span> 对于每张输入图片，将得到通道数一样的输出图，以输出图为基准，按输出图通道，行，列依次遍历
		<span class="token operator">//</span> （这对应图像在l<span class="token punctuation">.</span>output的存储方式，每张图片按行铺排成一大行，然后图片与图片之间再并成一行）。
		<span class="token operator">//</span> 以输出图为基准进行遍历，最终循环的总次数刚好覆盖池化核在输入图片不同位置进行池化操作。
        <span class="token comment">#pragma omp parallel for</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> c<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token builtin">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> m<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> out_h<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">//</span><span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> out_w<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> out_w<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token operator">//</span> out_index为输出图中的索引
                    <span class="token builtin">int</span> out_index <span class="token operator">=</span> j <span class="token operator">+</span> out_w<span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> out_h<span class="token operator">*</span><span class="token punctuation">(</span>k <span class="token operator">+</span> c<span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>j <span class="token operator">+</span> out_w <span class="token operator">*</span> i <span class="token operator">+</span> out_w <span class="token operator">*</span> iout_h <span class="token operator">*</span> k
                    <span class="token builtin">float</span> <span class="token builtin">max</span> <span class="token operator">=</span> <span class="token operator">-</span>FLT_MAX<span class="token punctuation">;</span><span class="token operator">//</span> FLT_MAX为c语言中<span class="token builtin">float</span><span class="token punctuation">.</span>h定义的对大浮点数，此处初始化最大元素值为最小浮点数
                    <span class="token builtin">int</span> max_i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">//</span> 最大元素值的索引初始化为<span class="token operator">-</span><span class="token number">1</span>
                    <span class="token operator">//</span> 下面两个循环回到了输入图片，计算得到的cur_h以及cur_w都是在当前层所有输入元素的索引，内外循环的目的是找寻输入图像中，
                    <span class="token operator">//</span> 以<span class="token punctuation">(</span>h_offset <span class="token operator">+</span> i<span class="token operator">*</span>l<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> w_offset <span class="token operator">+</span> j<span class="token operator">*</span>l<span class="token punctuation">.</span>stride<span class="token punctuation">)</span>为左上起点，尺寸为l<span class="token punctuation">.</span>size池化区域中的最大元素值<span class="token builtin">max</span>及其在所有输入元素中的索引max_i
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span><span class="token number">2</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> m <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>m<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span><span class="token number">2</span>
                            <span class="token operator">//</span> cur_h，cur_w是在所有输入图像中第k通道中的cur_h行与cur_w列，index是在所有输入图像元素中的总索引。
                            <span class="token operator">//</span> 为什么这里少一层对输入通道数的遍历循环呢？因为对于最大池化层来说输入与输出通道数是一样的，并在上面的通道数循环了！
                            <span class="token builtin">int</span> cur_h <span class="token operator">=</span> h_offset <span class="token operator">+</span> i<span class="token operator">*</span>stride <span class="token operator">+</span> n<span class="token punctuation">;</span>
                            <span class="token builtin">int</span> cur_w <span class="token operator">=</span> w_offset <span class="token operator">+</span> j<span class="token operator">*</span>stride <span class="token operator">+</span> m<span class="token punctuation">;</span>
                            <span class="token builtin">int</span> index <span class="token operator">=</span> cur_w <span class="token operator">+</span> w<span class="token operator">*</span><span class="token punctuation">(</span>cur_h <span class="token operator">+</span> h<span class="token operator">*</span><span class="token punctuation">(</span>k <span class="token operator">+</span> b<span class="token operator">*</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token operator">//</span> 边界检查：正常情况下，是不会越界的，但是如果有补<span class="token number">0</span>操作，就会越界了，这里的处理方式是直接让这些元素值为<span class="token operator">-</span>FLT_MAX
							<span class="token operator">//</span> （注意虽然称之为补<span class="token number">0</span>操作，但实际不是补<span class="token number">0</span>），总之，这些补的元素永远不会充当最大元素值。
                            <span class="token builtin">int</span> valid <span class="token operator">=</span> <span class="token punctuation">(</span>cur_h <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> cur_h <span class="token operator">&lt;</span> h <span class="token operator">&amp;</span><span class="token operator">&amp;</span>
                                cur_w <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> cur_w <span class="token operator">&lt;</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token builtin">float</span> val <span class="token operator">=</span> <span class="token punctuation">(</span>valid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> ? src<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token operator">-</span>FLT_MAX<span class="token punctuation">;</span>
							<span class="token operator">//</span> 记录这个池化区域中的最大的元素值及其在所有输入元素中的总索引
                            max_i <span class="token operator">=</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;</span> <span class="token builtin">max</span><span class="token punctuation">)</span> ? index <span class="token punctuation">:</span> max_i<span class="token punctuation">;</span>
                            <span class="token builtin">max</span> <span class="token operator">=</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;</span> <span class="token builtin">max</span><span class="token punctuation">)</span> ? val <span class="token punctuation">:</span> <span class="token builtin">max</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
					<span class="token operator">//</span> 由此得到最大池化层每一个输出元素值及其在所有输入元素中的总索引。
					<span class="token operator">//</span> 为什么需要记录每个输出元素值对应在输入元素中的总索引呢？因为在下面的反向过程中需要用到，在计算当前最大池化层上一层网络的敏感度时，
					<span class="token operator">//</span> 需要该索引明确当前层的每个元素究竟是取上一层输出（也即上前层输入）的哪一个元素的值，具体见下面backward_maxpool_layer<span class="token punctuation">(</span><span class="token punctuation">)</span>函数的注释。
                    dst<span class="token punctuation">[</span>out_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>indexes<span class="token punctuation">)</span> indexes<span class="token punctuation">[</span>out_index<span class="token punctuation">]</span> <span class="token operator">=</span> max_i<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2>
<a id="7_route_598"></a>7. 路由层[route]</h2> 
<p>yolov3-tiny中共有两层路由层。第17层路由层（从0层开始），其实直接将第13层网络的输出结果输入。第20层路由层，将第19层和第8层网络结果合并在一起，19层在前，8层在后。在route_layer.c中的forward_route_layer函数中实现。</p> 
<pre><code class="prism language-python">void forward_route_layer<span class="token punctuation">(</span>const route_layer l<span class="token punctuation">,</span> network_state state<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token builtin">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token builtin">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token operator">//</span>l<span class="token punctuation">.</span>n：  卷积层：输出特征图通道数 路由层：有几层网络层输入本层  <span class="token number">17</span>层：<span class="token number">1</span>（路由第<span class="token number">13</span>层）   <span class="token number">20</span>：<span class="token number">2</span>（路由第<span class="token number">19</span>、<span class="token number">8</span>层）
        <span class="token builtin">int</span> index <span class="token operator">=</span> l<span class="token punctuation">.</span>input_layers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">//</span>输入本网络层的网络层的索引：如<span class="token number">13</span>，<span class="token number">19</span>，<span class="token number">8</span>
        <span class="token builtin">float</span> <span class="token operator">*</span><span class="token builtin">input</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>net<span class="token punctuation">.</span>layers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>output<span class="token punctuation">;</span><span class="token operator">//</span>输入等于 之前网络层索引值得输出（<span class="token punctuation">.</span>output）
        <span class="token builtin">int</span> input_size <span class="token operator">=</span> l<span class="token punctuation">.</span>input_sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">//</span>输入的网络层的数据量
        <span class="token builtin">int</span> part_input_size <span class="token operator">=</span> input_size <span class="token operator">/</span> l<span class="token punctuation">.</span>groups<span class="token punctuation">;</span><span class="token operator">//</span>未分组
        <span class="token keyword">for</span><span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>batch<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>j<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token operator">//</span>copy_cpu<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> <span class="token builtin">input</span> <span class="token operator">+</span> j<span class="token operator">*</span>input_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>output <span class="token operator">+</span> offset <span class="token operator">+</span> j<span class="token operator">*</span>l<span class="token punctuation">.</span>outputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token operator">//</span>从首地址<span class="token builtin">input</span>处复制input_size 个数据到 l<span class="token punctuation">.</span>output中
            copy_cpu<span class="token punctuation">(</span>part_input_size<span class="token punctuation">,</span> <span class="token builtin">input</span> <span class="token operator">+</span> j<span class="token operator">*</span>input_size <span class="token operator">+</span> part_input_size<span class="token operator">*</span>l<span class="token punctuation">.</span>group_id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>output <span class="token operator">+</span> offset <span class="token operator">+</span> j<span class="token operator">*</span>l<span class="token punctuation">.</span>outputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>l<span class="token punctuation">.</span>group_id <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token operator">//</span>其实就是copy_cpu<span class="token punctuation">(</span>part_input_size<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>output <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">//</span>offset <span class="token operator">+=</span> input_size<span class="token punctuation">;</span>
        offset <span class="token operator">+=</span> part_input_size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2>
<a id="8_upsample_627"></a>8. 上采样层[upsample]</h2> 
<p>yolov3-tiny中第19层是上采样层，将18层13x13x128的输入特征图转变为26x26x128的输出特征图。在upsample_layer.c中的forward_upsample_layer函数中完成。</p> 
<pre><code class="prism language-python">void upsample_cpu<span class="token punctuation">(</span><span class="token builtin">float</span> <span class="token operator">*</span><span class="token keyword">in</span><span class="token punctuation">,</span> <span class="token builtin">int</span> w<span class="token punctuation">,</span> <span class="token builtin">int</span> h<span class="token punctuation">,</span> <span class="token builtin">int</span> c<span class="token punctuation">,</span> <span class="token builtin">int</span> batch<span class="token punctuation">,</span> <span class="token builtin">int</span> stride<span class="token punctuation">,</span> <span class="token builtin">int</span> forward<span class="token punctuation">,</span> <span class="token builtin">float</span> scale<span class="token punctuation">,</span> <span class="token builtin">float</span> <span class="token operator">*</span>out<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
    <span class="token builtin">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> b<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b <span class="token operator">&lt;</span> batch<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> c<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> h<span class="token operator">*</span>stride<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> w<span class="token operator">*</span>stride<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token builtin">int</span> in_index <span class="token operator">=</span> b<span class="token operator">*</span>w<span class="token operator">*</span>h<span class="token operator">*</span>c <span class="token operator">+</span> k<span class="token operator">*</span>w<span class="token operator">*</span>h <span class="token operator">+</span> <span class="token punctuation">(</span>j <span class="token operator">/</span> stride<span class="token punctuation">)</span><span class="token operator">*</span>w <span class="token operator">+</span> i <span class="token operator">/</span> stride<span class="token punctuation">;</span>
                    <span class="token builtin">int</span> out_index <span class="token operator">=</span> b<span class="token operator">*</span>w<span class="token operator">*</span>h<span class="token operator">*</span>c<span class="token operator">*</span>stride<span class="token operator">*</span>stride <span class="token operator">+</span> k<span class="token operator">*</span>w<span class="token operator">*</span>h<span class="token operator">*</span>stride<span class="token operator">*</span>stride <span class="token operator">+</span> j<span class="token operator">*</span>w<span class="token operator">*</span>stride <span class="token operator">+</span> i<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>forward<span class="token punctuation">)</span> out<span class="token punctuation">[</span>out_index<span class="token punctuation">]</span> <span class="token operator">=</span> scale<span class="token operator">*</span><span class="token keyword">in</span><span class="token punctuation">[</span>in_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">in</span><span class="token punctuation">[</span>in_index<span class="token punctuation">]</span> <span class="token operator">+=</span> scale<span class="token operator">*</span>out<span class="token punctuation">[</span>out_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>效果：<br> <img src="https://images2.imgbox.com/47/93/c7yptoz7_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="9_yolo_655"></a>9. 输出层[yolo]</h2> 
<p>yolo层完成了对13x13x255和26x26x255输入特诊图的logistic逻辑回归计算。每个box的预测宽度和高度不参与逻辑回归，在yolo_layer.c中的forward_yolo_layer函数中完成。</p> 
<pre><code class="prism language-python"><span class="token operator">//</span>两个yolo层 只对数据进行了logistic处理，并没有预测box的位置
<span class="token operator">//</span>将<span class="token number">0</span><span class="token operator">-</span><span class="token number">1</span>通道（x<span class="token punctuation">,</span>y） <span class="token number">4</span><span class="token operator">-</span><span class="token number">84</span><span class="token punctuation">(</span>confidence<span class="token operator">+</span><span class="token keyword">class</span><span class="token punctuation">)</span>计算logistic，三个prior<span class="token punctuation">(</span>预测框都是这样<span class="token punctuation">)</span>
void forward_yolo_layer<span class="token punctuation">(</span>const layer l<span class="token punctuation">,</span> network_state state<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token builtin">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> b<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
	<span class="token operator">//</span>从state<span class="token punctuation">.</span><span class="token builtin">input</span>复制数据到l<span class="token punctuation">.</span>output
    memcpy<span class="token punctuation">(</span>l<span class="token punctuation">.</span>output<span class="token punctuation">,</span> state<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>outputs<span class="token operator">*</span>l<span class="token punctuation">.</span>batch <span class="token operator">*</span> sizeof<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">#ifndef GPU</span>
	printf<span class="token punctuation">(</span><span class="token string">"yolo v3 tiny l.n and l.batch of yolo layer is %d and %d  n "</span><span class="token punctuation">,</span>l<span class="token punctuation">.</span>n<span class="token punctuation">,</span>l<span class="token punctuation">.</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>batch<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>l<span class="token punctuation">.</span>batch <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>l<span class="token punctuation">.</span>n：<span class="token number">3</span>（yolo层）mask <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>  表示每个网络单元预测三个box?
			
			<span class="token operator">//</span>printf<span class="token punctuation">(</span><span class="token string">"l.coords is %d in yolov3 tiny yolo layer ,l.scale_x_y is %f n"</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>coords<span class="token punctuation">,</span> l<span class="token punctuation">.</span>scale_x_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">//</span> l<span class="token punctuation">.</span>coords 坐标：<span class="token number">0</span>  l<span class="token punctuation">.</span>classes分类数量：<span class="token number">80</span>   l<span class="token punctuation">.</span>scale_x_y<span class="token punctuation">:</span><span class="token number">1</span>
			<span class="token operator">//</span>l<span class="token punctuation">.</span>w<span class="token punctuation">:</span>输入特征图宽度 l<span class="token punctuation">.</span>h输出特征图高度  
			<span class="token builtin">int</span> index <span class="token operator">=</span> entry_index<span class="token punctuation">(</span>l<span class="token punctuation">,</span> b<span class="token punctuation">,</span> n<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>index <span class="token operator">=</span> n<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">+</span> l<span class="token punctuation">.</span>classes <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
			
		   <span class="token operator">//</span>起始地址为：l<span class="token punctuation">.</span>output <span class="token operator">+</span> index 个数为：<span class="token number">2</span> <span class="token operator">*</span> l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h  计算逻辑回归值，并保存
            activate_array<span class="token punctuation">(</span>l<span class="token punctuation">.</span>output <span class="token operator">+</span> index<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token punctuation">,</span> LOGISTIC<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">//</span> x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>

			<span class="token operator">//</span>起始地址为：l<span class="token punctuation">.</span>output <span class="token operator">+</span> index 个数为：<span class="token number">2</span> <span class="token operator">*</span> l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h  计算方式为：x <span class="token operator">=</span> x<span class="token operator">*</span>l<span class="token punctuation">.</span>scale_x_y <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>scale_x_y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> 简化后：x <span class="token operator">=</span> x
			<span class="token operator">//</span>yolov3<span class="token operator">-</span>tiny l<span class="token punctuation">.</span>scale_x_y <span class="token operator">=</span> <span class="token number">1</span>  实际上该函数没有参与任何的运算   scal_add_cpu
            scal_add_cpu<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token punctuation">,</span> l<span class="token punctuation">.</span>scale_x_y<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>scale_x_y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>output <span class="token operator">+</span> index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">//</span> scale x<span class="token punctuation">,</span>y
            
			<span class="token operator">//</span>
			index <span class="token operator">=</span> entry_index<span class="token punctuation">(</span>l<span class="token punctuation">,</span> b<span class="token punctuation">,</span> n<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>index <span class="token operator">=</span> n<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">+</span> l<span class="token punctuation">.</span>classes <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token number">4</span><span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h
            
			<span class="token operator">//</span>起始地址为：l<span class="token punctuation">.</span>output <span class="token operator">+</span> index<span class="token punctuation">,</span>个数为：（<span class="token number">1</span><span class="token operator">+</span><span class="token number">80</span>）<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h   计算器其逻辑回归值
			activate_array<span class="token punctuation">(</span>l<span class="token punctuation">.</span>output <span class="token operator">+</span> index<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> l<span class="token punctuation">.</span>classes<span class="token punctuation">)</span><span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token punctuation">,</span> LOGISTIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<h2>
<a id="10_detection__695"></a>10. 预测结果统计[detection ]</h2> 
<pre><code class="prism language-python">
<span class="token operator">//</span>w<span class="token punctuation">:</span>输入图像宽度<span class="token number">640</span><span class="token punctuation">,</span>不一定是<span class="token number">416</span> h<span class="token punctuation">:</span>输入图像高度<span class="token number">424</span><span class="token punctuation">,</span>不一定是<span class="token number">416</span>  thresh<span class="token punctuation">:</span>图像置信度阈值<span class="token number">0.25</span>   hier<span class="token punctuation">:</span><span class="token number">0.5</span>
<span class="token operator">//</span><span class="token builtin">map</span><span class="token punctuation">:</span><span class="token number">0</span>   relative<span class="token punctuation">:</span><span class="token number">1</span>  num<span class="token punctuation">:</span><span class="token number">0</span>   letter<span class="token punctuation">:</span><span class="token number">0</span>
<span class="token operator">//</span>函数作用：统计两个yolo层中 置信度大于阈值的box个数，并对这个box初始化一段地址空间 dets
<span class="token operator">//</span>根据网络来填充该地址空间dets：
<span class="token operator">//</span>根据yolo层 计算满足置信度阈值要求的box相对的预测坐标、宽度和高度，并将结果保存在dets<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>bbox结构体中
<span class="token operator">//</span>每个box有<span class="token number">80</span>个类别，有一个置信度，该类别对应的可能性prob：<span class="token keyword">class</span>概率<span class="token operator">*</span>置信度
<span class="token operator">//</span><span class="token operator">/</span>舍弃prob小于阈值<span class="token number">0.25</span>的box
<span class="token operator">//</span>将满足阈值的box个数保存到num中
detection <span class="token operator">*</span>get_network_boxes<span class="token punctuation">(</span>network <span class="token operator">*</span>net<span class="token punctuation">,</span> <span class="token builtin">int</span> w<span class="token punctuation">,</span> <span class="token builtin">int</span> h<span class="token punctuation">,</span> <span class="token builtin">float</span> thresh<span class="token punctuation">,</span> <span class="token builtin">float</span> hier<span class="token punctuation">,</span> <span class="token builtin">int</span> <span class="token operator">*</span><span class="token builtin">map</span><span class="token punctuation">,</span> <span class="token builtin">int</span> relative<span class="token punctuation">,</span> <span class="token builtin">int</span> <span class="token operator">*</span>num<span class="token punctuation">,</span> <span class="token builtin">int</span> letter<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token operator">//</span>printf<span class="token punctuation">(</span><span class="token string">"w、h、thresh、hier and letter is %d 、%d 、%f 、%f and %dn"</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> thresh<span class="token punctuation">,</span> hier<span class="token punctuation">,</span> letter<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token operator">//</span>函数作用：统计两个yolo层中 置信度大于阈值的box个数，并对这个box初始化一段地址空间 dets
	<span class="token operator">//</span>将满足阈值的box个数保存到num中
    detection <span class="token operator">*</span>dets <span class="token operator">=</span> make_network_boxes<span class="token punctuation">(</span>net<span class="token punctuation">,</span> thresh<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token operator">//</span>根据网络来填充该地址空间dets：
	<span class="token operator">//</span>根据yolo层 计算满足置信度阈值要求的box相对的预测坐标、宽度和高度，并将结果保存在dets<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>bbox结构体中
	<span class="token operator">//</span>每个box有<span class="token number">80</span>个类别，有一个置信度，该类别对应的可能性prob：<span class="token keyword">class</span>概率<span class="token operator">*</span>置信度
	<span class="token operator">//</span><span class="token operator">/</span>舍弃prob小于阈值<span class="token number">0.25</span>的box
    fill_network_boxes<span class="token punctuation">(</span>net<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> thresh<span class="token punctuation">,</span> hier<span class="token punctuation">,</span> <span class="token builtin">map</span><span class="token punctuation">,</span> relative<span class="token punctuation">,</span> dets<span class="token punctuation">,</span> letter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dets<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>使用make_network_boxes来创建预测信息的指针变量：</p> 
<pre><code class="prism language-python"><span class="token operator">//</span> thresh<span class="token punctuation">:</span>  置信度阈值
<span class="token operator">//</span>num<span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token operator">//</span>函数作用：统计置信度大于阈值的box个数，并对这个box初始化一段地址空间
detection <span class="token operator">*</span>make_network_boxes<span class="token punctuation">(</span>network <span class="token operator">*</span>net<span class="token punctuation">,</span> <span class="token builtin">float</span> thresh<span class="token punctuation">,</span> <span class="token builtin">int</span> <span class="token operator">*</span>num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    layer l <span class="token operator">=</span> net<span class="token operator">-</span><span class="token operator">&gt;</span>layers<span class="token punctuation">[</span>net<span class="token operator">-</span><span class="token operator">&gt;</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">//</span>应该是神经网络最后一层 net<span class="token operator">-</span><span class="token operator">&gt;</span>n<span class="token punctuation">:</span><span class="token number">24</span> 最后一层yolo层
	<span class="token operator">//</span>printf<span class="token punctuation">(</span><span class="token string">" net-&gt;n  of network is %dn "</span> <span class="token punctuation">,</span><span class="token punctuation">(</span>net<span class="token operator">-</span><span class="token operator">&gt;</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> i<span class="token punctuation">;</span>
	<span class="token operator">//</span> <span class="token operator">-</span>thresh <span class="token number">0.25</span>
	<span class="token operator">//</span>yolo层：yolov3<span class="token operator">-</span>tiny中共有两层
	<span class="token operator">//</span>三个prior预测框，对每个预测框中，置信度大于thresh <span class="token number">0.25</span>，记为一次，将次数进行累加，并输出
	<span class="token operator">//</span>nboxes<span class="token punctuation">:</span>即为要保留的box的个数 两个yolo层中的置信度个数一起累加
    <span class="token builtin">int</span> nboxes <span class="token operator">=</span> num_detections<span class="token punctuation">(</span>net<span class="token punctuation">,</span> thresh<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span><span class="token operator">-</span>thresh <span class="token number">0.25</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		printf<span class="token punctuation">(</span><span class="token string">"nbox = %d n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span>num <span class="token operator">=</span> nboxes<span class="token punctuation">;</span><span class="token operator">//</span>不执行该语句
	<span class="token punctuation">}</span>
    <span class="token operator">//</span>申请内存，个数为nboxes，每个内存大小为：sizeof<span class="token punctuation">(</span>detection<span class="token punctuation">)</span>
    detection<span class="token operator">*</span> dets <span class="token operator">=</span> <span class="token punctuation">(</span>detection<span class="token operator">*</span><span class="token punctuation">)</span>xcalloc<span class="token punctuation">(</span>nboxes<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span>detection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token operator">//</span>遍历每个box<span class="token punctuation">,</span>每个dets<span class="token punctuation">.</span>prob申请<span class="token number">80</span>个<span class="token builtin">float</span>类型的内存：
	<span class="token operator">//</span>dets<span class="token punctuation">.</span>uc，申请<span class="token number">4</span>个<span class="token builtin">float</span>类型的空间：位置信息
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nboxes<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        dets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prob <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token operator">*</span><span class="token punctuation">)</span>xcalloc<span class="token punctuation">(</span>l<span class="token punctuation">.</span>classes<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">//</span> tx<span class="token punctuation">,</span>ty<span class="token punctuation">,</span>tw<span class="token punctuation">,</span>th uncertainty
        dets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>uc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token operator">*</span><span class="token punctuation">)</span>xcalloc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">//</span> Gaussian_YOLOv3
        
		<span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>coords <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>不执行这个分支 l<span class="token punctuation">.</span>coords：<span class="token number">0</span>
            dets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mask <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">float</span><span class="token operator">*</span><span class="token punctuation">)</span>xcalloc<span class="token punctuation">(</span>l<span class="token punctuation">.</span>coords <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> dets<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>使用get_yolo_detections来统计两层yolo层的预测信息：</p> 
<pre><code class="prism language-python"><span class="token operator">//</span>w<span class="token punctuation">,</span>h<span class="token punctuation">:</span><span class="token number">640</span><span class="token punctuation">,</span><span class="token number">424</span>    netw<span class="token punctuation">,</span> neth<span class="token punctuation">:</span><span class="token number">416</span><span class="token punctuation">,</span><span class="token number">416</span> thresh<span class="token punctuation">:</span>图像置信度阈值<span class="token number">0.25</span>   hier<span class="token punctuation">:</span><span class="token number">0.5</span>
<span class="token operator">//</span><span class="token builtin">map</span><span class="token punctuation">:</span><span class="token number">0</span>   relative<span class="token punctuation">:</span><span class="token number">1</span>    letter<span class="token punctuation">:</span><span class="token number">0</span>
<span class="token operator">//</span>根据yolo层 计算满足置信度阈值要求的box相对的预测坐标、宽度和高度，并将结果保存在dets<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>bbox结构体中
<span class="token operator">//</span>每个box有<span class="token number">80</span>个类别，有一个置信度，该类别对应的可能性prob：<span class="token keyword">class</span>概率<span class="token operator">*</span>置信度
<span class="token operator">//</span><span class="token operator">/</span>舍弃prob小于阈值<span class="token number">0.25</span>的box
<span class="token builtin">int</span> get_yolo_detections<span class="token punctuation">(</span>layer l<span class="token punctuation">,</span> <span class="token builtin">int</span> w<span class="token punctuation">,</span> <span class="token builtin">int</span> h<span class="token punctuation">,</span> <span class="token builtin">int</span> netw<span class="token punctuation">,</span> <span class="token builtin">int</span> neth<span class="token punctuation">,</span> <span class="token builtin">float</span> thresh<span class="token punctuation">,</span> <span class="token builtin">int</span> <span class="token operator">*</span><span class="token builtin">map</span><span class="token punctuation">,</span> <span class="token builtin">int</span> relative<span class="token punctuation">,</span> detection <span class="token operator">*</span>dets<span class="token punctuation">,</span> <span class="token builtin">int</span> letter<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    printf<span class="token punctuation">(</span><span class="token string">"n l.batch = %d, l.w = %d, l.h = %d, l.n = %d ,netw = %d, neth = %d n"</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>batch<span class="token punctuation">,</span> l<span class="token punctuation">.</span>w<span class="token punctuation">,</span> l<span class="token punctuation">.</span>h<span class="token punctuation">,</span> l<span class="token punctuation">.</span>n<span class="token punctuation">,</span> netw<span class="token punctuation">,</span> neth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>n<span class="token punctuation">;</span>
    <span class="token builtin">float</span> <span class="token operator">*</span>predictions <span class="token operator">=</span> l<span class="token punctuation">.</span>output<span class="token punctuation">;</span><span class="token operator">//</span>yolo层的输出
    <span class="token operator">//</span> This snippet below <span class="token keyword">is</span> <span class="token keyword">not</span> necessary
    <span class="token operator">//</span> Need to comment it <span class="token keyword">in</span> order to batch processing <span class="token operator">&gt;=</span> <span class="token number">2</span> images
    <span class="token operator">//</span><span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>batch <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> avg_flipped_yolo<span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token operator">//</span>printf<span class="token punctuation">(</span><span class="token string">"yolo layer l.mask[0] is %d, l.mask[1] is %d, l.mask[2] is %dn"</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>mask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">//</span>printf<span class="token punctuation">(</span><span class="token string">"yolo layer l.biases[l.mask[0]*2] is %f, l.biases[l.mask[1]*2] is %f, l.biases[l.mask[2]*2] is %fn"</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>biases<span class="token punctuation">[</span>l<span class="token punctuation">.</span>mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>biases<span class="token punctuation">[</span>l<span class="token punctuation">.</span>mask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>biases<span class="token punctuation">[</span>l<span class="token punctuation">.</span>mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">//</span>遍历yolo层
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token operator">//</span>该yolo层输出特征图的宽度、高度：13x13 26x26
        <span class="token builtin">int</span> row <span class="token operator">=</span> i <span class="token operator">/</span> l<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
        <span class="token builtin">int</span> col <span class="token operator">=</span> i <span class="token operator">%</span> l<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>n<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>n<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token operator">//</span>yolo层，l<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token number">3</span>
			
            <span class="token operator">//</span>obj_index<span class="token punctuation">:</span>置信度层索引
            <span class="token builtin">int</span> obj_index  <span class="token operator">=</span> entry_index<span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>obj_index  <span class="token operator">=</span> n<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">+</span>l<span class="token punctuation">.</span>classes<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h <span class="token operator">+</span> i<span class="token punctuation">;</span>
            <span class="token builtin">float</span> objectness <span class="token operator">=</span> predictions<span class="token punctuation">[</span>obj_index<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">//</span>获得对应的置信度
            <span class="token operator">//</span><span class="token keyword">if</span><span class="token punctuation">(</span>objectness <span class="token operator">&lt;=</span> thresh<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token operator">//</span> incorrect behavior <span class="token keyword">for</span> Nan values
            
			<span class="token keyword">if</span> <span class="token punctuation">(</span>objectness <span class="token operator">&gt;</span> thresh<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>只有置信度大于阈值才开始执行该分支
                <span class="token operator">//</span>printf<span class="token punctuation">(</span><span class="token string">"n objectness = %f, thresh = %f, i = %d, n = %d n"</span><span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> thresh<span class="token punctuation">,</span> i<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
				<span class="token operator">//</span>box_index<span class="token punctuation">:</span>yolo层每个像素点有三个box<span class="token punctuation">,</span>表示每个box的索引值
				<span class="token builtin">int</span> box_index <span class="token operator">=</span> entry_index<span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>box_index <span class="token operator">=</span> n<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">+</span>l<span class="token punctuation">.</span>classes<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span> i<span class="token punctuation">;</span>

				<span class="token operator">//</span>l<span class="token punctuation">.</span>biases<span class="token operator">-</span><span class="token operator">&gt;</span>偏置参数起始地址    l<span class="token punctuation">.</span>mask<span class="token punctuation">[</span>n<span class="token punctuation">]</span>：分别为<span class="token number">3</span>，<span class="token number">4</span>，<span class="token number">5</span>，<span class="token number">0</span>，<span class="token number">1</span>，<span class="token number">2</span>，biases偏置参数偏移量
				<span class="token operator">//</span>根据yolo层 计算满足置信度阈值要求的box相对的预测坐标、宽度和高度，并将结果保存在dets<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>bbox结构体中
                dets<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>bbox <span class="token operator">=</span> get_yolo_box<span class="token punctuation">(</span>predictions<span class="token punctuation">,</span> l<span class="token punctuation">.</span>biases<span class="token punctuation">,</span> l<span class="token punctuation">.</span>mask<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> box_index<span class="token punctuation">,</span> col<span class="token punctuation">,</span> row<span class="token punctuation">,</span> l<span class="token punctuation">.</span>w<span class="token punctuation">,</span> l<span class="token punctuation">.</span>h<span class="token punctuation">,</span> netw<span class="token punctuation">,</span> neth<span class="token punctuation">,</span> l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token operator">//</span>获取对应的置信度，该置信度经过了logistic
                dets<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>objectness <span class="token operator">=</span> objectness<span class="token punctuation">;</span>

				<span class="token operator">//</span>获得分类数：<span class="token number">80</span>（<span class="token builtin">int</span>类型）
                dets<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>classes <span class="token operator">=</span> l<span class="token punctuation">.</span>classes<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> l<span class="token punctuation">.</span>classes<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token operator">//</span><span class="token number">80</span>个类别，每个类别对应的概率，class_index为其所在层的索引
                    <span class="token builtin">int</span> class_index <span class="token operator">=</span> entry_index<span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">//</span>class_index  <span class="token operator">=</span> n<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">+</span>l<span class="token punctuation">.</span>classes<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> （<span class="token number">4</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">+</span>j）<span class="token operator">*</span>l<span class="token punctuation">.</span>w<span class="token operator">*</span>l<span class="token punctuation">.</span>h <span class="token operator">+</span> i<span class="token punctuation">;</span>
                    <span class="token operator">//</span>每个box有<span class="token number">80</span>个类别，有一个置信度，该类别对应的可能性prob：<span class="token keyword">class</span>概率<span class="token operator">*</span>置信度
					<span class="token builtin">float</span> prob <span class="token operator">=</span> objectness<span class="token operator">*</span>predictions<span class="token punctuation">[</span>class_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
					
					<span class="token operator">//</span>舍弃prob小于阈值<span class="token number">0.25</span>的box
                    dets<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>prob<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>prob <span class="token operator">&gt;</span> thresh<span class="token punctuation">)</span> ? prob <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token operator">+</span><span class="token operator">+</span>count<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    correct_yolo_boxes<span class="token punctuation">(</span>dets<span class="token punctuation">,</span> count<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> netw<span class="token punctuation">,</span> neth<span class="token punctuation">,</span> relative<span class="token punctuation">,</span> letter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2>
<a id="11_NMS_830"></a>11. 非极大值抑制[NMS]</h2> 
<pre><code class="prism language-python"><span class="token operator">//</span>dets<span class="token punctuation">:</span>box结构体 nboxes<span class="token punctuation">:</span>满足阈值的box个数   l<span class="token punctuation">.</span>classe<span class="token punctuation">:</span><span class="token number">80</span>    thresh<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>45f
<span class="token operator">//</span>两个box<span class="token punctuation">,</span>同一类别进行非极大值抑制，遍历
void do_nms_sort<span class="token punctuation">(</span>detection <span class="token operator">*</span>dets<span class="token punctuation">,</span> <span class="token builtin">int</span> total<span class="token punctuation">,</span> <span class="token builtin">int</span> classes<span class="token punctuation">,</span> <span class="token builtin">float</span> thresh<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token builtin">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span>
    k <span class="token operator">=</span> total <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> k<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>box个数
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>objectness <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>置信度<span class="token operator">==</span><span class="token number">0</span>  不执行该分支，理论上没有objectness <span class="token operator">=</span> <span class="token number">0</span>
			printf<span class="token punctuation">(</span><span class="token string">"there is no objectness == 0 !!! n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            detection swap <span class="token operator">=</span> dets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            dets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> dets<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
            dets<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> swap<span class="token punctuation">;</span>
            <span class="token operator">-</span><span class="token operator">-</span>k<span class="token punctuation">;</span>
            <span class="token operator">-</span><span class="token operator">-</span>i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    total <span class="token operator">=</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token operator">//</span>同一类别进行比较
    <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> classes<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span><span class="token number">80</span>个        
        <span class="token operator">//</span>box预测的类别
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> total<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>box个数
            dets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sort_class <span class="token operator">=</span> k<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token operator">//</span>函数作用：将prob较大的box排列到前面
        qsort<span class="token punctuation">(</span>dets<span class="token punctuation">,</span> total<span class="token punctuation">,</span> sizeof<span class="token punctuation">(</span>detection<span class="token punctuation">)</span><span class="token punctuation">,</span> nms_comparator_v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> total<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token operator">//</span>两个box<span class="token punctuation">,</span>同一类别进行非极大值抑制
            <span class="token operator">//</span>printf<span class="token punctuation">(</span><span class="token string">"  k = %d, t i = %d n"</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prob<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            box a <span class="token operator">=</span> dets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bbox<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> total<span class="token punctuation">;</span><span class="token operator">+</span><span class="token operator">+</span>j<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				box b <span class="token operator">=</span> dets<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>bbox<span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> box_iou<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">&gt;</span> thresh<span class="token punctuation">)</span> dets<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>prob<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h1>
<a id="Bonus_875"></a>Bonus：有用的参考</h1> 
<p><a href="https://github.com/bobo0810/PytorchNetHub/tree/master/Yolov3_pytorch">https://github.com/bobo0810/PytorchNetHub/tree/master/Yolov3_pytorch</a></p> 
<p><a href="https://github.com/HulkMaker/pytorch-yolov3">https://github.com/HulkMaker/pytorch-yolov3</a></p> 
<p><a href="https://github.com/Peterisfar/YOLOV3">https://github.com/Peterisfar/YOLOV3</a></p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>