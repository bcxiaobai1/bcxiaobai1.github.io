<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>深度学习从入门到精通——基于深度学习的地震数据去噪处理 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深度学习从入门到精通——基于深度学习的地震数据去噪处理</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <p><img src="https://images2.imgbox.com/0a/c9/Gq4rZiFb_o.png" alt="在这里插入图片描述"></p> 
<ul>
<li>传统机器学习 
  <ul><li>SVM,boosting,bagging,knn</li></ul> </li>
<li>深度学习 
  <ul><li>CNN（典型）,GAN</li></ul> </li>
</ul> 
<h3>
<a id="_5"></a>地震应用方向</h3> 
<ul>
<li>叠前地震数据随机噪声去除，实现噪声分离<br> <img src="https://images2.imgbox.com/9d/59/5XruKm96_o.png" alt="didi">
</li>
<li>面波去噪<br> 面波作为很强的干扰波出现在地震勘探中，大大降低了地震记录的分 辨率和信噪比。深度学习作为一种数据驱动类方法, 能够从大量数据样本中 学习得到有效信号与噪声的区别, 自适应建立深度神经网络来压制噪声。<br> <img src="https://images2.imgbox.com/98/b1/liF4cSjx_o.png" alt="在这里插入图片描述">
</li>
<li>地震数据去噪与重建<br> <img src="https://images2.imgbox.com/92/d8/c3cXhEng_o.png" alt="在这里插入图片描述">
</li>
</ul> 
<h3>
<a id="_13"></a>去噪流程、</h3> 
<ul><li>去噪流程 - 深度学习常规流程<br> <img src="https://images2.imgbox.com/57/42/SFFgPvXp_o.png" alt="在这里插入图片描述">
</li></ul> 
<h3>
<a id="_17"></a>数据增强</h3> 
<ul>
<li>利用数据增强方面，把地震波面波数据当作二维图像数据使用</li>
<li>那么可采用数据增强方式，</li>
<li>噪声类型添加</li>
<li>仿射变换与透视变换，裁剪</li>
<li>高级一点的：mixup，dropoutblock，mosaic,mask等等</li>
</ul> 
<h3>
<a id="_24"></a>模型设计</h3> 
<ul>
<li>模型设计首先清晰自己需要什么，如果我们做的是噪声去除，那么针对性的模型如下：<br> ①目标检测类CNN模型<br> 首先清楚，地震波数据，无非是噪声数据与我想要的真实地震数据。<br> 含有噪声的数据 = 真实地震波 + 噪声<br> 那么模型的任务定义为目标侦测性，寻找里面的地震波或者是噪声。</li>
<li>相对来说，真实地震波数据无论是在求取还是在标注性上，都更容易求取。因此让模型找出噪声数据，利用原始数据-噪声数据 = 真实地震波数据。<br> 这里的标签设置方法： 含噪数据，真实地震波数据<br> ②图像分割类<br> <img src="https://images2.imgbox.com/91/44/8bJLdd4A_o.png" alt="在这里插入图片描述">
</li>
</ul> 
<p>将地震波去噪任务分解为地震波+噪声，对含有噪声的地震波进行分类，对地震波数据进行提取，进而获取真实地震波。<br> ③超分技术（GAN）<br> <img src="https://images2.imgbox.com/c9/ab/oi2tsU0J_o.png" alt="在这里插入图片描述"></p> 
<p>标签设置方法： 含噪数据，真实地震波数据<br> 利用超分的思想来做去噪任务，针对性的求取去噪后的图像。利用生成器直接对图像进行去噪，比较典型的油SRGAN。<br> 如果对地震波的噪声类型有判断，可以采用CGAN的思想，对噪声类型可控化。通过已知噪声类型的方式对地震波进行针对性的去噪。<br> ③无监督去噪（VAE系类）<br> 利用编解码模型，对原始数据进行压缩成向量，再通过向量解码成真实地震波。<br> 以前常用，实际应用性还可以，但是可解释性需要进一步探讨。</p> 
<h3>
<a id="_47"></a>编程实战</h3> 
<p>这里采用下面博主教程里面的进行解释。<br> <a href="https://b23.tv/q0GnaQb?share_medium=android&amp;share_source=qq&amp;bbid=XX5195956A7C799D3133624B4E9935214F261&amp;ts=1651584307708">bilibili参考</a></p> 
<ul>
<li>对地震波数据的处理注意使用道的数据就好，其他的按照数据增强的方式走</li>
<li>数据采样原则 
  <ul>
<li>满足独立同分布的原理，可以的相同区块，但是不能的不同地方的数据。</li>
<li>数据质量&gt; 数据数量，采样质量一定要保证，数量不是最重要的。</li>
<li>采样的标签制作，可以是（含噪数据，真实地震波），也可以是（含噪数据，噪声）</li>
<li>分布均匀，不同情况下的噪声尽可能的考虑齐全，这样模型的鲁棒性才会比较好。针对区块，地质概况，可以针对性的制作一下。</li>
</ul> </li>
</ul> 
<h3>
<a id="_56"></a>数据展示如下</h3> 
<p><img src="https://images2.imgbox.com/96/81/rwZBFfdk_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="_58"></a>干净数据与含噪数据的展示</h3> 
<p><img src="https://images2.imgbox.com/72/ea/JzxpPRPv_o.png" alt="在这里插入图片描述"></p> 
<ul><li>模型的输入与输出<br> 地震波数据，可以定义成单通道图像，图像格式为NCHW(pytorch，paddle),NHWC(tensorflow)<br> 输出，如果是去噪任务，理论上输出与输入应该同型号，这里利用u2net修改了一下原up主的代码进行去噪任务。<br> <img src="https://images2.imgbox.com/26/a2/hQgzWYaK_o.png" alt="在这里插入图片描述"><br> mutiunet.py</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> models
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token keyword">class</span> <span class="token class-name">REBNCONV</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>out_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>REBNCONV<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv_s1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_ch<span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token operator">*</span>dirate<span class="token punctuation">,</span>dilation<span class="token operator">=</span><span class="token number">1</span><span class="token operator">*</span>dirate<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn_s1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_ch<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu_s1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>

        hx <span class="token operator">=</span> x
        xout <span class="token operator">=</span> self<span class="token punctuation">.</span>relu_s1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn_s1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv_s1<span class="token punctuation">(</span>hx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> xout

<span class="token comment">## upsample tensor 'src' to have the same spatial size with tensor 'tar'</span>
<span class="token keyword">def</span> <span class="token function">_upsample_like</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span>tar<span class="token punctuation">)</span><span class="token punctuation">:</span>

    src <span class="token operator">=</span> F<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>src<span class="token punctuation">,</span>size<span class="token operator">=</span>tar<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> src


<span class="token comment">### RSU-7 ###</span>
<span class="token keyword">class</span> <span class="token class-name">RSU7</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#UNet07DRES(nn.Module):</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> mid_ch<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> out_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RSU7<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconvin <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>in_ch<span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv1 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>out_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv2 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv3 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv4 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv5 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv6 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv7 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv6d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv5d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv4d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv3d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv2d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv1d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>

        hx <span class="token operator">=</span> x
        hxin <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconvin<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>

        hx1 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv1<span class="token punctuation">(</span>hxin<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool1<span class="token punctuation">(</span>hx1<span class="token punctuation">)</span>

        hx2 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv2<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool2<span class="token punctuation">(</span>hx2<span class="token punctuation">)</span>

        hx3 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv3<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool3<span class="token punctuation">(</span>hx3<span class="token punctuation">)</span>

        hx4 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv4<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool4<span class="token punctuation">(</span>hx4<span class="token punctuation">)</span>

        hx5 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv5<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool5<span class="token punctuation">(</span>hx5<span class="token punctuation">)</span>

        hx6 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv6<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>

        hx7 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv7<span class="token punctuation">(</span>hx6<span class="token punctuation">)</span>

        hx6d <span class="token operator">=</span>  self<span class="token punctuation">.</span>rebnconv6d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx7<span class="token punctuation">,</span>hx6<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx6dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx6d<span class="token punctuation">,</span>hx5<span class="token punctuation">)</span>

        hx5d <span class="token operator">=</span>  self<span class="token punctuation">.</span>rebnconv5d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx6dup<span class="token punctuation">,</span>hx5<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx5dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx5d<span class="token punctuation">,</span>hx4<span class="token punctuation">)</span>

        hx4d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv4d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx5dup<span class="token punctuation">,</span>hx4<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx4dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx4d<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span>

        hx3d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv3d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx4dup<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx3dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx3d<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span>

        hx2d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv2d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx3dup<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx2dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx2d<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span>

        hx1d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv1d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx2dup<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> hx1d <span class="token operator">+</span> hxin

<span class="token comment">### RSU-6 ###</span>
<span class="token keyword">class</span> <span class="token class-name">RSU6</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#UNet06DRES(nn.Module):</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> mid_ch<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> out_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RSU6<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconvin <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>in_ch<span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv1 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>out_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv2 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv3 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv4 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv5 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv6 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv5d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv4d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv3d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv2d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv1d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>

        hx <span class="token operator">=</span> x

        hxin <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconvin<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>

        hx1 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv1<span class="token punctuation">(</span>hxin<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool1<span class="token punctuation">(</span>hx1<span class="token punctuation">)</span>

        hx2 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv2<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool2<span class="token punctuation">(</span>hx2<span class="token punctuation">)</span>

        hx3 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv3<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool3<span class="token punctuation">(</span>hx3<span class="token punctuation">)</span>

        hx4 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv4<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool4<span class="token punctuation">(</span>hx4<span class="token punctuation">)</span>

        hx5 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv5<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>

        hx6 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv6<span class="token punctuation">(</span>hx5<span class="token punctuation">)</span>


        hx5d <span class="token operator">=</span>  self<span class="token punctuation">.</span>rebnconv5d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx6<span class="token punctuation">,</span>hx5<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx5dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx5d<span class="token punctuation">,</span>hx4<span class="token punctuation">)</span>

        hx4d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv4d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx5dup<span class="token punctuation">,</span>hx4<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx4dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx4d<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span>

        hx3d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv3d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx4dup<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx3dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx3d<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span>

        hx2d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv2d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx3dup<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx2dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx2d<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span>

        hx1d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv1d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx2dup<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> hx1d <span class="token operator">+</span> hxin

<span class="token comment">### RSU-5 ###</span>
<span class="token keyword">class</span> <span class="token class-name">RSU5</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#UNet05DRES(nn.Module):</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> mid_ch<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> out_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RSU5<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconvin <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>in_ch<span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv1 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>out_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv2 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv3 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv4 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv5 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv4d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv3d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv2d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv1d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>

        hx <span class="token operator">=</span> x

        hxin <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconvin<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>

        hx1 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv1<span class="token punctuation">(</span>hxin<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool1<span class="token punctuation">(</span>hx1<span class="token punctuation">)</span>

        hx2 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv2<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool2<span class="token punctuation">(</span>hx2<span class="token punctuation">)</span>

        hx3 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv3<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool3<span class="token punctuation">(</span>hx3<span class="token punctuation">)</span>

        hx4 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv4<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>

        hx5 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv5<span class="token punctuation">(</span>hx4<span class="token punctuation">)</span>

        hx4d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv4d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx5<span class="token punctuation">,</span>hx4<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx4dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx4d<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span>

        hx3d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv3d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx4dup<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx3dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx3d<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span>

        hx2d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv2d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx3dup<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx2dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx2d<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span>

        hx1d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv1d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx2dup<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> hx1d <span class="token operator">+</span> hxin

<span class="token comment">### RSU-4 ###</span>
<span class="token keyword">class</span> <span class="token class-name">RSU4</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#UNet04DRES(nn.Module):</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> mid_ch<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> out_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RSU4<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconvin <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>in_ch<span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv1 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>out_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv2 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv3 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv4 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv3d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv2d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv1d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>

        hx <span class="token operator">=</span> x

        hxin <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconvin<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>

        hx1 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv1<span class="token punctuation">(</span>hxin<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool1<span class="token punctuation">(</span>hx1<span class="token punctuation">)</span>

        hx2 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv2<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool2<span class="token punctuation">(</span>hx2<span class="token punctuation">)</span>

        hx3 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv3<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>

        hx4 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv4<span class="token punctuation">(</span>hx3<span class="token punctuation">)</span>

        hx3d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv3d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx4<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx3dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx3d<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span>

        hx2d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv2d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx3dup<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx2dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx2d<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span>

        hx1d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv1d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx2dup<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> hx1d <span class="token operator">+</span> hxin

<span class="token comment">### RSU-4F ###</span>
<span class="token keyword">class</span> <span class="token class-name">RSU4F</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#UNet04FRES(nn.Module):</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> mid_ch<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> out_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RSU4F<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconvin <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>in_ch<span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv1 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>out_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv2 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv3 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv4 <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>rebnconv3d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv2d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>mid_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rebnconv1d <span class="token operator">=</span> REBNCONV<span class="token punctuation">(</span>mid_ch<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span>dirate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>

        hx <span class="token operator">=</span> x

        hxin <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconvin<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>

        hx1 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv1<span class="token punctuation">(</span>hxin<span class="token punctuation">)</span>
        hx2 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv2<span class="token punctuation">(</span>hx1<span class="token punctuation">)</span>
        hx3 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv3<span class="token punctuation">(</span>hx2<span class="token punctuation">)</span>

        hx4 <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv4<span class="token punctuation">(</span>hx3<span class="token punctuation">)</span>

        hx3d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv3d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx4<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx2d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv2d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx3d<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx1d <span class="token operator">=</span> self<span class="token punctuation">.</span>rebnconv1d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx2d<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> hx1d <span class="token operator">+</span> hxin


<span class="token comment">##### U^2-Net ####</span>
<span class="token keyword">class</span> <span class="token class-name">U2NET</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>out_ch<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>U2NET<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage1 <span class="token operator">=</span> RSU7<span class="token punctuation">(</span>in_ch<span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool12 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage2 <span class="token operator">=</span> RSU6<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool23 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage3 <span class="token operator">=</span> RSU5<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool34 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage4 <span class="token operator">=</span> RSU4<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool45 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage5 <span class="token operator">=</span> RSU4F<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool56 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage6 <span class="token operator">=</span> RSU4F<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span>

        <span class="token comment"># decoder</span>
        self<span class="token punctuation">.</span>stage5d <span class="token operator">=</span> RSU4F<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>stage4d <span class="token operator">=</span> RSU4<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>stage3d <span class="token operator">=</span> RSU5<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>stage2d <span class="token operator">=</span> RSU6<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>stage1d <span class="token operator">=</span> RSU7<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>side1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side6 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>outconv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>

        hx <span class="token operator">=</span> x

        <span class="token comment">#stage 1</span>
        hx1 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage1<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool12<span class="token punctuation">(</span>hx1<span class="token punctuation">)</span>

        <span class="token comment">#stage 2</span>
        hx2 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage2<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool23<span class="token punctuation">(</span>hx2<span class="token punctuation">)</span>

        <span class="token comment">#stage 3</span>
        hx3 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage3<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool34<span class="token punctuation">(</span>hx3<span class="token punctuation">)</span>

        <span class="token comment">#stage 4</span>
        hx4 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage4<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool45<span class="token punctuation">(</span>hx4<span class="token punctuation">)</span>

        <span class="token comment">#stage 5</span>
        hx5 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage5<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool56<span class="token punctuation">(</span>hx5<span class="token punctuation">)</span>

        <span class="token comment">#stage 6</span>
        hx6 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage6<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx6up <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx6<span class="token punctuation">,</span>hx5<span class="token punctuation">)</span>

        <span class="token comment">#-------------------- decoder --------------------</span>
        hx5d <span class="token operator">=</span> self<span class="token punctuation">.</span>stage5d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx6up<span class="token punctuation">,</span>hx5<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx5dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx5d<span class="token punctuation">,</span>hx4<span class="token punctuation">)</span>

        hx4d <span class="token operator">=</span> self<span class="token punctuation">.</span>stage4d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx5dup<span class="token punctuation">,</span>hx4<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx4dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx4d<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span>

        hx3d <span class="token operator">=</span> self<span class="token punctuation">.</span>stage3d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx4dup<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx3dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx3d<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span>

        hx2d <span class="token operator">=</span> self<span class="token punctuation">.</span>stage2d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx3dup<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx2dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx2d<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span>

        hx1d <span class="token operator">=</span> self<span class="token punctuation">.</span>stage1d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx2dup<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


        <span class="token comment">#side output</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>side1<span class="token punctuation">(</span>hx1d<span class="token punctuation">)</span>

        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>side2<span class="token punctuation">(</span>hx2d<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>d2<span class="token punctuation">,</span>d1<span class="token punctuation">)</span>

        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>side3<span class="token punctuation">(</span>hx3d<span class="token punctuation">)</span>
        d3 <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>d3<span class="token punctuation">,</span>d1<span class="token punctuation">)</span>

        d4 <span class="token operator">=</span> self<span class="token punctuation">.</span>side4<span class="token punctuation">(</span>hx4d<span class="token punctuation">)</span>
        d4 <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>d4<span class="token punctuation">,</span>d1<span class="token punctuation">)</span>

        d5 <span class="token operator">=</span> self<span class="token punctuation">.</span>side5<span class="token punctuation">(</span>hx5d<span class="token punctuation">)</span>
        d5 <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>d5<span class="token punctuation">,</span>d1<span class="token punctuation">)</span>

        d6 <span class="token operator">=</span> self<span class="token punctuation">.</span>side6<span class="token punctuation">(</span>hx6<span class="token punctuation">)</span>
        d6 <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>d6<span class="token punctuation">,</span>d1<span class="token punctuation">)</span>

        d0 <span class="token operator">=</span> self<span class="token punctuation">.</span>outconv<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>d1<span class="token punctuation">,</span>d2<span class="token punctuation">,</span>d3<span class="token punctuation">,</span>d4<span class="token punctuation">,</span>d5<span class="token punctuation">,</span>d6<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>d0<span class="token punctuation">)</span><span class="token punctuation">,</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>d1<span class="token punctuation">)</span><span class="token punctuation">,</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>d2<span class="token punctuation">)</span><span class="token punctuation">,</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>d3<span class="token punctuation">)</span><span class="token punctuation">,</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>d4<span class="token punctuation">)</span><span class="token punctuation">,</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>d5<span class="token punctuation">)</span><span class="token punctuation">,</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>d6<span class="token punctuation">)</span>

<span class="token comment">### U^2-Net small ###</span>
<span class="token keyword">class</span> <span class="token class-name">U2NETP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>out_ch<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>U2NETP<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage1 <span class="token operator">=</span> RSU7<span class="token punctuation">(</span>in_ch<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool12 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage2 <span class="token operator">=</span> RSU6<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool23 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage3 <span class="token operator">=</span> RSU5<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool34 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage4 <span class="token operator">=</span> RSU4<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool45 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage5 <span class="token operator">=</span> RSU4F<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool56 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>stage6 <span class="token operator">=</span> RSU4F<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>

        <span class="token comment"># decoder</span>
        self<span class="token punctuation">.</span>stage5d <span class="token operator">=</span> RSU4F<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>stage4d <span class="token operator">=</span> RSU4<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>stage3d <span class="token operator">=</span> RSU5<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>stage2d <span class="token operator">=</span> RSU6<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>stage1d <span class="token operator">=</span> RSU7<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>side1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side5 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>side6 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>outconv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span>out_ch<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>

        hx <span class="token operator">=</span> x

        <span class="token comment">#stage 1</span>
        hx1 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage1<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool12<span class="token punctuation">(</span>hx1<span class="token punctuation">)</span>

        <span class="token comment">#stage 2</span>
        hx2 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage2<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool23<span class="token punctuation">(</span>hx2<span class="token punctuation">)</span>

        <span class="token comment">#stage 3</span>
        hx3 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage3<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool34<span class="token punctuation">(</span>hx3<span class="token punctuation">)</span>

        <span class="token comment">#stage 4</span>
        hx4 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage4<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool45<span class="token punctuation">(</span>hx4<span class="token punctuation">)</span>

        <span class="token comment">#stage 5</span>
        hx5 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage5<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx <span class="token operator">=</span> self<span class="token punctuation">.</span>pool56<span class="token punctuation">(</span>hx5<span class="token punctuation">)</span>

        <span class="token comment">#stage 6</span>
        hx6 <span class="token operator">=</span> self<span class="token punctuation">.</span>stage6<span class="token punctuation">(</span>hx<span class="token punctuation">)</span>
        hx6up <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx6<span class="token punctuation">,</span>hx5<span class="token punctuation">)</span>

        <span class="token comment">#decoder</span>
        hx5d <span class="token operator">=</span> self<span class="token punctuation">.</span>stage5d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx6up<span class="token punctuation">,</span>hx5<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx5dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx5d<span class="token punctuation">,</span>hx4<span class="token punctuation">)</span>

        hx4d <span class="token operator">=</span> self<span class="token punctuation">.</span>stage4d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx5dup<span class="token punctuation">,</span>hx4<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx4dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx4d<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span>

        hx3d <span class="token operator">=</span> self<span class="token punctuation">.</span>stage3d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx4dup<span class="token punctuation">,</span>hx3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx3dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx3d<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span>

        hx2d <span class="token operator">=</span> self<span class="token punctuation">.</span>stage2d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx3dup<span class="token punctuation">,</span>hx2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hx2dup <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>hx2d<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span>

        hx1d <span class="token operator">=</span> self<span class="token punctuation">.</span>stage1d<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>hx2dup<span class="token punctuation">,</span>hx1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


        <span class="token comment">#side output</span>
        d1 <span class="token operator">=</span> self<span class="token punctuation">.</span>side1<span class="token punctuation">(</span>hx1d<span class="token punctuation">)</span>

        d2 <span class="token operator">=</span> self<span class="token punctuation">.</span>side2<span class="token punctuation">(</span>hx2d<span class="token punctuation">)</span>
        d2 <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>d2<span class="token punctuation">,</span>d1<span class="token punctuation">)</span>

        d3 <span class="token operator">=</span> self<span class="token punctuation">.</span>side3<span class="token punctuation">(</span>hx3d<span class="token punctuation">)</span>
        d3 <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>d3<span class="token punctuation">,</span>d1<span class="token punctuation">)</span>

        d4 <span class="token operator">=</span> self<span class="token punctuation">.</span>side4<span class="token punctuation">(</span>hx4d<span class="token punctuation">)</span>
        d4 <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>d4<span class="token punctuation">,</span>d1<span class="token punctuation">)</span>

        d5 <span class="token operator">=</span> self<span class="token punctuation">.</span>side5<span class="token punctuation">(</span>hx5d<span class="token punctuation">)</span>
        d5 <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>d5<span class="token punctuation">,</span>d1<span class="token punctuation">)</span>

        d6 <span class="token operator">=</span> self<span class="token punctuation">.</span>side6<span class="token punctuation">(</span>hx6<span class="token punctuation">)</span>
        d6 <span class="token operator">=</span> _upsample_like<span class="token punctuation">(</span>d6<span class="token punctuation">,</span>d1<span class="token punctuation">)</span>

        d0 <span class="token operator">=</span> self<span class="token punctuation">.</span>outconv<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>d1<span class="token punctuation">,</span>d2<span class="token punctuation">,</span>d3<span class="token punctuation">,</span>d4<span class="token punctuation">,</span>d5<span class="token punctuation">,</span>d6<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> d0<span class="token punctuation">,</span>d1<span class="token punctuation">,</span>d2<span class="token punctuation">,</span>d3<span class="token punctuation">,</span>d4<span class="token punctuation">,</span>d5<span class="token punctuation">,</span>d6
</code></pre> 
<p>训练网络如下：<br> mutiunet_train.py</p> 
<pre><code class="prism language-python"><span class="token comment"># -*-coding:utf-8-*-</span>
<span class="token triple-quoted-string string">"""
Created on 2022.3.31
programing language:python
@author:夜剑听雨
"""</span>
<span class="token comment"># from model.dncnn import DnCNN</span>
<span class="token keyword">from</span> model<span class="token punctuation">.</span>mutiunet <span class="token keyword">import</span> U2NET
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>dataset <span class="token keyword">import</span> MyDataset
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>SignalProcessing <span class="token keyword">import</span> batch_snr
<span class="token keyword">from</span> torch <span class="token keyword">import</span> optim
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> time
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> os

<span class="token comment"># 选择设备，有cuda用cuda，没有就用cpu</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
<span class="token comment"># 加载网络，图片单通道1，分类为1。</span>
my_net <span class="token operator">=</span> U2NET<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># 将网络拷贝到设备中</span>
my_net<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>device<span class="token punctuation">)</span>
<span class="token comment"># 指定特征和标签数据地址，加载数据集</span>
train_path_x <span class="token operator">=</span> <span class="token string">"..\data\feature\"</span>
train_path_y <span class="token operator">=</span> <span class="token string">"..\data\label\"</span>
<span class="token comment"># 划分数据集，训练集：验证集：测试集 = 8:1:1</span>
full_dataset <span class="token operator">=</span> MyDataset<span class="token punctuation">(</span>train_path_x<span class="token punctuation">,</span> train_path_y<span class="token punctuation">)</span>
valida_size <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>full_dataset<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
train_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>full_dataset<span class="token punctuation">)</span> <span class="token operator">-</span> valida_size <span class="token operator">*</span> <span class="token number">2</span>
<span class="token comment"># 指定加载数据的batch_size</span>
batch_size <span class="token operator">=</span> <span class="token number">32</span>
<span class="token comment"># 划分数据集</span>
train_dataset<span class="token punctuation">,</span> test_dataset<span class="token punctuation">,</span> valida_dataset <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>random_split<span class="token punctuation">(</span>full_dataset<span class="token punctuation">,</span>
                                                                            <span class="token punctuation">[</span>train_size<span class="token punctuation">,</span> valida_size<span class="token punctuation">,</span> valida_size<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 加载并且乱序训练数据集</span>
train_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>train_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># 加载并且乱序验证数据集</span>
valida_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>valida_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># 加载测试数据集,测试数据不需要乱序</span>
test_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>test_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token comment"># 定义优化方法</span>
epochs <span class="token operator">=</span> <span class="token number">20</span>  <span class="token comment"># 设置训练次数</span>
LR <span class="token operator">=</span> <span class="token number">0.001</span>  <span class="token comment"># 设置学习率</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>my_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>LR<span class="token punctuation">)</span>
<span class="token comment"># 定义损失函数</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">)</span>  <span class="token comment"># reduction='sum'表示不除以batch_size</span>

temp_sets1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于记录训练，验证集的loss,每一个epoch都做一次训练，验证</span>
temp_sets2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># # 用于记录测试集的SNR,去噪前和去噪后都要记录</span>

start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"1. %Y-%m-%d %H:%M:%S"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 开始时间</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">r"./save_dir/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">r"./save_dir/"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">muti_bce_loss_fusion</span><span class="token punctuation">(</span>d0<span class="token punctuation">,</span> d1<span class="token punctuation">,</span> d2<span class="token punctuation">,</span> d3<span class="token punctuation">,</span> d4<span class="token punctuation">,</span> d5<span class="token punctuation">,</span> d6<span class="token punctuation">,</span> labels_v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    loss0 <span class="token operator">=</span> criterion<span class="token punctuation">(</span>d0<span class="token punctuation">,</span> labels_v<span class="token punctuation">)</span>
    loss1 <span class="token operator">=</span> criterion<span class="token punctuation">(</span>d1<span class="token punctuation">,</span> labels_v<span class="token punctuation">)</span>
    loss2 <span class="token operator">=</span> criterion<span class="token punctuation">(</span>d2<span class="token punctuation">,</span> labels_v<span class="token punctuation">)</span>
    loss3 <span class="token operator">=</span> criterion<span class="token punctuation">(</span>d3<span class="token punctuation">,</span> labels_v<span class="token punctuation">)</span>
    loss4 <span class="token operator">=</span> criterion<span class="token punctuation">(</span>d4<span class="token punctuation">,</span> labels_v<span class="token punctuation">)</span>
    loss5 <span class="token operator">=</span> criterion<span class="token punctuation">(</span>d5<span class="token punctuation">,</span> labels_v<span class="token punctuation">)</span>
    loss6 <span class="token operator">=</span> criterion<span class="token punctuation">(</span>d6<span class="token punctuation">,</span> labels_v<span class="token punctuation">)</span>

    loss <span class="token operator">=</span> loss0 <span class="token operator">+</span> loss1 <span class="token operator">+</span> loss2 <span class="token operator">+</span> loss3 <span class="token operator">+</span> loss4 <span class="token operator">+</span> loss5 <span class="token operator">+</span> loss6
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"l0: %3f, l1: %3f, l2: %3f, l3: %3f, l4: %3f, l5: %3f, l6: %3fn"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
    loss0<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loss1<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loss2<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loss3<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loss4<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loss5<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loss6<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> loss0<span class="token punctuation">,</span> loss


<span class="token comment"># 每一个epoch都做一次训练，验证，测试</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 训练集训练网络</span>
    train_loss <span class="token operator">=</span> <span class="token number">0.0</span>
    my_net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 开启训练模式</span>
    <span class="token keyword">for</span> batch_idx1<span class="token punctuation">,</span> <span class="token punctuation">(</span>batch_x<span class="token punctuation">,</span> batch_y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 0开始计数</span>
        <span class="token comment"># 加载数据至GPU</span>
        batch_x <span class="token operator">=</span> batch_x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        batch_y <span class="token operator">=</span> batch_y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        d0<span class="token punctuation">,</span> d1<span class="token punctuation">,</span> d2<span class="token punctuation">,</span> d3<span class="token punctuation">,</span> d4<span class="token punctuation">,</span> d5<span class="token punctuation">,</span> d6 <span class="token operator">=</span> my_net<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>  <span class="token comment"># 使用网络参数，输出预测结果</span>
        <span class="token comment"># 计算loss</span>
        _<span class="token punctuation">,</span> loss1 <span class="token operator">=</span> muti_bce_loss_fusion<span class="token punctuation">(</span>d0<span class="token punctuation">,</span> d1<span class="token punctuation">,</span> d2<span class="token punctuation">,</span> d3<span class="token punctuation">,</span> d4<span class="token punctuation">,</span> d5<span class="token punctuation">,</span> d6<span class="token punctuation">,</span> <span class="token punctuation">(</span>batch_x <span class="token operator">-</span> batch_y<span class="token punctuation">)</span><span class="token punctuation">)</span>
        train_loss <span class="token operator">+=</span> loss1<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 累加计算本次epoch的loss，最后还需要除以每个epoch可以抽取多少个batch数，即最后的n_count值</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 先将梯度归零,等价于net.zero_grad(0</span>
        loss1<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 反向传播计算得到每个参数的梯度值</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 通过梯度下降执行一步参数更新</span>
    train_loss <span class="token operator">=</span> train_loss <span class="token operator">/</span> <span class="token punctuation">(</span>batch_idx1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 本次epoch的平均loss</span>

    <span class="token comment"># 验证集验证网络</span>
    my_net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 开启评估/测试模式</span>
    val_loss <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">for</span> batch_idx2<span class="token punctuation">,</span> <span class="token punctuation">(</span>val_x<span class="token punctuation">,</span> val_y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>valida_loader<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 加载数据至GPU</span>
        val_x <span class="token operator">=</span> val_x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        val_y <span class="token operator">=</span> val_y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 不需要做梯度更新，所以要关闭求梯度</span>
            d0<span class="token punctuation">,</span> d1<span class="token punctuation">,</span> d2<span class="token punctuation">,</span> d3<span class="token punctuation">,</span> d4<span class="token punctuation">,</span> d5<span class="token punctuation">,</span> d6 <span class="token operator">=</span> my_net<span class="token punctuation">(</span>val_x<span class="token punctuation">)</span>  <span class="token comment"># 使用网络参数，输出预测结果</span>
            <span class="token comment"># 计算loss</span>
            _<span class="token punctuation">,</span> loss2 <span class="token operator">=</span> muti_bce_loss_fusion<span class="token punctuation">(</span>d0<span class="token punctuation">,</span> d1<span class="token punctuation">,</span> d2<span class="token punctuation">,</span> d3<span class="token punctuation">,</span> d4<span class="token punctuation">,</span> d5<span class="token punctuation">,</span> d6<span class="token punctuation">,</span> <span class="token punctuation">(</span>val_x <span class="token operator">-</span> val_y<span class="token punctuation">)</span><span class="token punctuation">)</span>
            val_loss <span class="token operator">+=</span> loss2<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 累加计算本次epoch的loss，最后还需要除以每个epoch可以抽取多少个batch数，即最后的count值</span>
    val_loss <span class="token operator">=</span> val_loss <span class="token operator">/</span> <span class="token punctuation">(</span>batch_idx2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练，验证，测试的loss保存至loss_sets中</span>
    loss_set <span class="token operator">=</span> <span class="token punctuation">[</span>train_loss<span class="token punctuation">,</span> val_loss<span class="token punctuation">]</span>
    temp_sets1<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss_set<span class="token punctuation">)</span>
    <span class="token comment"># {:.4f}值用format格式化输出，保留小数点后四位</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch={}，训练集loss：{:.4f}，验证集loss：{:.4f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> train_loss<span class="token punctuation">,</span> val_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 测试集测试网络，采用计算一个batch数据的信噪比(snr)作为评估指标</span>
    snr_set1 <span class="token operator">=</span> <span class="token number">0.0</span>
    snr_set2 <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">for</span> batch_idx3<span class="token punctuation">,</span> <span class="token punctuation">(</span>test_x<span class="token punctuation">,</span> test_y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 加载数据至GPU</span>
        test_x <span class="token operator">=</span> test_x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        test_y <span class="token operator">=</span> test_y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 不需要做梯度更新，所以要关闭求梯度</span>
            d0<span class="token punctuation">,</span> d1<span class="token punctuation">,</span> d2<span class="token punctuation">,</span> d3<span class="token punctuation">,</span> d4<span class="token punctuation">,</span> d5<span class="token punctuation">,</span> d6 <span class="token operator">=</span> my_net<span class="token punctuation">(</span>test_x<span class="token punctuation">)</span>  <span class="token comment"># 使用网络参数，输出预测结果(训练的是噪声)</span>
            <span class="token comment"># 含噪数据减去噪声得到的才是去噪后的数据</span>
            clean_out <span class="token operator">=</span> test_x <span class="token operator">-</span> d0
            <span class="token comment"># 计算网络去噪后的数据和干净数据的信噪比(此处是计算了所有的数据，除以了batch_size求均值)</span>
            SNR1 <span class="token operator">=</span> batch_snr<span class="token punctuation">(</span>test_x<span class="token punctuation">,</span> test_y<span class="token punctuation">)</span>  <span class="token comment"># 去噪前的信噪比</span>
            SNR2 <span class="token operator">=</span> batch_snr<span class="token punctuation">(</span>clean_out<span class="token punctuation">,</span> test_y<span class="token punctuation">)</span>  <span class="token comment"># 去噪后的信噪比</span>
        snr_set1 <span class="token operator">+=</span> SNR1
        snr_set2 <span class="token operator">+=</span> SNR2
        <span class="token comment"># 累加计算本次epoch的loss，最后还需要除以每个epoch可以抽取多少个batch数，即最后的count值</span>
    snr_set1 <span class="token operator">=</span> snr_set1 <span class="token operator">/</span> <span class="token punctuation">(</span>batch_idx3 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    snr_set2 <span class="token operator">=</span> snr_set2 <span class="token operator">/</span> <span class="token punctuation">(</span>batch_idx3 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># 训练，验证，测试的loss保存至loss_sets中</span>
    snr_set <span class="token operator">=</span> <span class="token punctuation">[</span>snr_set1<span class="token punctuation">,</span> snr_set2<span class="token punctuation">]</span>
    temp_sets2<span class="token punctuation">.</span>append<span class="token punctuation">(</span>snr_set<span class="token punctuation">)</span>

    <span class="token comment"># {:.4f}值用format格式化输出，保留小数点后四位</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch={}，去噪前的平均信噪比(SNR)：{:.4f} dB，去噪后的平均信噪比(SNR)：{:.4f} dB"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> snr_set1<span class="token punctuation">,</span> snr_set2<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 保存网络模型</span>
    model_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'model_epoch</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>  <span class="token comment"># 模型命名</span>
    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>my_net<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'./save_dir'</span><span class="token punctuation">,</span> model_name <span class="token operator">+</span> <span class="token string">'.pth'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 保存整个神经网络的模型结构以及参数</span>

end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"1. %Y-%m-%d %H:%M:%S"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 结束时间</span>
<span class="token comment"># 将训练花费的时间写成一个txt文档，保存到当前文件夹下</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'训练时间.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>start_time<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>end_time<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"训练开始时间{}&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;训练结束时间{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>start_time<span class="token punctuation">,</span> end_time<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 打印所用时间</span>

<span class="token comment"># temp_sets1是三维张量无法保存，需要变成2维数组才能存为txt文件</span>
loss_sets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> sets <span class="token keyword">in</span> temp_sets1<span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        loss_sets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>sets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
loss_sets <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>loss_sets<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 重塑形状10*2，-1表示自动推导</span>
<span class="token comment"># fmt参数，指定保存的文件格式。将loss_sets存为txt文件</span>
np<span class="token punctuation">.</span>savetxt<span class="token punctuation">(</span><span class="token string">'loss_sets.txt'</span><span class="token punctuation">,</span> loss_sets<span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">'%.4f'</span><span class="token punctuation">)</span>

<span class="token comment"># temp_sets2是三维张量无法保存，需要变成2维数组才能存为txt文件</span>
snr_sets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> sets <span class="token keyword">in</span> temp_sets2<span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        snr_sets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>sets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
snr_sets <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>snr_sets<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 重塑形状10*2，-1表示自动推导</span>
<span class="token comment"># fmt参数，指定保存的文件格式。将loss_sets存为txt文件</span>
np<span class="token punctuation">.</span>savetxt<span class="token punctuation">(</span><span class="token string">'snr_sets.txt'</span><span class="token punctuation">,</span> snr_sets<span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">'%.4f'</span><span class="token punctuation">)</span>

<span class="token comment"># 显示loss曲线</span>
loss_lines <span class="token operator">=</span> np<span class="token punctuation">.</span>loadtxt<span class="token punctuation">(</span><span class="token string">'./loss_sets.txt'</span><span class="token punctuation">)</span>
<span class="token comment"># 前面除以batch_size会导致数值太小了不易观察</span>
train_line <span class="token operator">=</span> loss_lines<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> batch_size
valida_line <span class="token operator">=</span> loss_lines<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> batch_size
x1 <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train_line<span class="token punctuation">)</span><span class="token punctuation">)</span>
fig1 <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x1<span class="token punctuation">,</span> train_line<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> valida_line<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'epoch'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'valida'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'loss_plot.png'</span><span class="token punctuation">,</span> bbox_inches<span class="token operator">=</span><span class="token string">'tight'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 显示snr曲线</span>
snr_lines <span class="token operator">=</span> np<span class="token punctuation">.</span>loadtxt<span class="token punctuation">(</span><span class="token string">'./snr_sets.txt'</span><span class="token punctuation">)</span>
De_before <span class="token operator">=</span> snr_lines<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
De_after <span class="token operator">=</span> snr_lines<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
x2 <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>De_before<span class="token punctuation">)</span><span class="token punctuation">)</span>
fig2 <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x2<span class="token punctuation">,</span> De_before<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> De_after<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'epoch'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'SNR'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'noise'</span><span class="token punctuation">,</span> <span class="token string">'denoise'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'snr_plot.png'</span><span class="token punctuation">,</span> bbox_inches<span class="token operator">=</span><span class="token string">'tight'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>训练图像<br> <img src="https://images2.imgbox.com/ea/fa/JkNJyhWj_o.png" alt="在这里插入图片描述"></p> 
<h3>
<a id="_797"></a>模型优化方向</h3> 
<ul>
<li>注意力以及编解码模型的运用，针对局部噪声，如果与其他空间位置有关系，可以采用注意力或者增大感受野的方式进行解决。更多偏向于模型对整体地震波的感知。</li>
<li>针对复杂噪声，模型可以多尺度化，不止是针对模型出现的噪声，更针对地震波在语义上的特征也可以进行去噪化。真实的地震波不止出现在最后，也可以在多个尺度内对地震波进行去噪。<br> <img src="https://images2.imgbox.com/37/9f/HmrRguI4_o.png" alt="在这里插入图片描述">
</li>
<li>优化函数多样化<br> 针对的目标一致的情况下， 可以添加相对应的代价评估函数，损失函数设计等等，模型欠拟合可以采用非线性更为强悍的激活函数，模型过拟合时，常常要通过正则化、提前终止、学习率衰减等方式进行解决。视具体任务而言</li>
<li>预处理多样化<br> 相对复杂的任务，可能模型的鲁棒性达不到要求，一般可以通过一些常规的算法进行数据的预处理工作，包括无监督，傅里叶去噪等等，模型学习通过预处理 的数据的时候加快收敛速度</li>
</ul> 
<p><a href="https://b23.tv/q0GnaQb?share_medium=android&amp;share_source=qq&amp;bbid=XX5195956A7C799D3133624B4E9935214F261&amp;ts=1651584307708">参考bilibili 基于深度学习的地震数据去噪处理</a><br> 有兴趣的小伙欢迎一起探讨技术，附个人微信<br> 本人测井方向、数字岩心导电性的数值模拟。<br> <img src="https://images2.imgbox.com/72/df/LRt4OBZq_o.jpg" alt="在这里插入图片描述"></p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>