<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>yoloV5_6.1代码逐行解释__train.py - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">yoloV5_6.1代码逐行解释__train.py</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-github-gist">
                    
                        
                    
                    <p>因为自己经常要使用yolov5,所以就用了一些时间研究了一下,也是收获颇丰,就放上来,一是方便自己以后查阅,二是希望能帮到需要的朋友.</p> 
<p>我写的注释比较详细，主要是针对刚会python和了解深度学习的小白，有错误的和不懂的地方可以联系我,大家相互交流学习哦VX:Y1685637070</p> 
<p>之前一篇文章注释的detet.py，时隔很久终于注释完了train.py(关于创建数据集和调用其他接口的函数正字注释中),后续会继续注释yolo.py和comon.py，卷起来！</p> 
<pre><code class="prism language-python"><span class="token comment"># YOLOv5 ? by Ultralytics, GPL-3.0 license</span>
<span class="token triple-quoted-string string">"""
Train a YOLOv5 model on a custom dataset.

Models and datasets download automatically from the latest YOLOv5 release.
Models: https://github.com/ultralytics/yolov5/tree/master/models
Datasets: https://github.com/ultralytics/yolov5/tree/master/data
Tutorial: https://github.com/ultralytics/yolov5/wiki/Train-Custom-Data

Usage:
    $ python path/to/train.py --data coco128.yaml --weights yolov5s.pt --img 640  # from pretrained (RECOMMENDED)
    $ python path/to/train.py --data coco128.yaml --weights '' --cfg yolov5s.yaml --img 640  # from scratch
"""</span>

<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> math
<span class="token keyword">import</span> random
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> time
<span class="token keyword">from</span> copy <span class="token keyword">import</span> deepcopy
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>distributed <span class="token keyword">as</span> dist
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> yaml
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>cuda <span class="token keyword">import</span> amp
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>parallel <span class="token keyword">import</span> DistributedDataParallel <span class="token keyword">as</span> DDP
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">import</span> SGD<span class="token punctuation">,</span> Adam<span class="token punctuation">,</span> AdamW<span class="token punctuation">,</span> lr_scheduler
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> os

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"KMP_DUPLICATE_LIB_OK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"TRUE"</span>
FILE <span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取绝对路径</span>
ROOT <span class="token operator">=</span> FILE<span class="token punctuation">.</span>parents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 获取上一级目录</span>
<span class="token keyword">if</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ROOT<span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">:</span>
    sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 将路径添加至环境变量中方便后续导入各种包</span>
ROOT <span class="token operator">=</span> Path<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span>ROOT<span class="token punctuation">,</span> Path<span class="token punctuation">.</span>cwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># relative</span>

<span class="token keyword">import</span> val  <span class="token comment"># for end-of-epoch mAP</span>
<span class="token keyword">from</span> models<span class="token punctuation">.</span>experimental <span class="token keyword">import</span> attempt_load
<span class="token keyword">from</span> models<span class="token punctuation">.</span>yolo <span class="token keyword">import</span> Model
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>autoanchor <span class="token keyword">import</span> check_anchors
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>autobatch <span class="token keyword">import</span> check_train_batch_size
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>callbacks <span class="token keyword">import</span> Callbacks
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> create_dataloader
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>downloads <span class="token keyword">import</span> attempt_download
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>general <span class="token keyword">import</span> <span class="token punctuation">(</span>LOGGER<span class="token punctuation">,</span> check_dataset<span class="token punctuation">,</span> check_file<span class="token punctuation">,</span> check_git_status<span class="token punctuation">,</span> check_img_size<span class="token punctuation">,</span> check_requirements<span class="token punctuation">,</span>
                           check_suffix<span class="token punctuation">,</span> check_yaml<span class="token punctuation">,</span> colorstr<span class="token punctuation">,</span> get_latest_run<span class="token punctuation">,</span> increment_path<span class="token punctuation">,</span> init_seeds<span class="token punctuation">,</span>
                           intersect_dicts<span class="token punctuation">,</span> labels_to_class_weights<span class="token punctuation">,</span> labels_to_image_weights<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> one_cycle<span class="token punctuation">,</span>
                           print_args<span class="token punctuation">,</span> print_mutation<span class="token punctuation">,</span> strip_optimizer<span class="token punctuation">)</span>
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>loggers <span class="token keyword">import</span> Loggers
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>loggers<span class="token punctuation">.</span>wandb<span class="token punctuation">.</span>wandb_utils <span class="token keyword">import</span> check_wandb_resume
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>loss <span class="token keyword">import</span> ComputeLoss
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> fitness
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>plots <span class="token keyword">import</span> plot_evolve<span class="token punctuation">,</span> plot_labels
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>torch_utils <span class="token keyword">import</span> EarlyStopping<span class="token punctuation">,</span> ModelEMA<span class="token punctuation">,</span> de_parallel<span class="token punctuation">,</span> select_device<span class="token punctuation">,</span> torch_distributed_zero_first

LOCAL_RANK <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'LOCAL_RANK'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 'LOCAL_RANK'分布式训练中的序号，如没有就返回-1</span>
<span class="token comment"># https://pytorch.org/docs/stable/elastic/run.html</span>
RANK <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'RANK'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 在整个分布式中的序号，每个进程都有一个rank和一个local_rank，</span>
<span class="token comment"># rank是相对整个分布式而言（就是序号从0开始一直到整个分布式中最后一个GPU的数，</span>
<span class="token comment"># 类似于range(0,整个分布式GPU数量），这里不是相对于一个node而言，</span>
<span class="token comment"># 是所有node的GPU总和），local_rank是每个进程或者GPU相对属于哪个node而言的编号。</span>
<span class="token comment"># 另外，rank=0代表master进程</span>

WORLD_SIZE <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'WORLD_SIZE'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># WORLD_SIZEGPU数量</span>


<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>hyp<span class="token punctuation">,</span>  <span class="token comment"># path/to/hyp.yaml or hyp dictionary</span>
          opt<span class="token punctuation">,</span>
          device<span class="token punctuation">,</span>
          callbacks
          <span class="token punctuation">)</span><span class="token punctuation">:</span>
    save_dir<span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> single_cls<span class="token punctuation">,</span> evolve<span class="token punctuation">,</span> data<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> resume<span class="token punctuation">,</span> noval<span class="token punctuation">,</span> nosave<span class="token punctuation">,</span> workers<span class="token punctuation">,</span> freeze <span class="token operator">=</span> 
        Path<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>save_dir<span class="token punctuation">)</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span>epochs<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>single_cls<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>evolve<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>data<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>cfg<span class="token punctuation">,</span> 
        opt<span class="token punctuation">.</span>resume<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>noval<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>nosave<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>workers<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>freeze <span class="token comment"># 参数赋值</span>

    <span class="token comment"># Directories</span>
    w <span class="token operator">=</span> save_dir <span class="token operator">/</span> <span class="token string">'weights'</span>  <span class="token comment"># weights dir 权重保存位子</span>
    <span class="token punctuation">(</span>w<span class="token punctuation">.</span>parent <span class="token keyword">if</span> evolve <span class="token keyword">else</span> w<span class="token punctuation">)</span><span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># make dir 如果文件夹不存在就创建</span>
    last<span class="token punctuation">,</span> best <span class="token operator">=</span> w <span class="token operator">/</span> <span class="token string">'last.pt'</span><span class="token punctuation">,</span> w <span class="token operator">/</span> <span class="token string">'best.pt'</span> <span class="token comment"># 两个权重文件的地址</span>

    <span class="token comment"># Hyperparameters</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>hyp<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 判断hyp是否未字符串</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>hyp<span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            hyp <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>  <span class="token comment"># load hyps dict 打开hyp读取超参数</span>
    LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span>colorstr<span class="token punctuation">(</span><span class="token string">'hyperparameters: '</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>k<span class="token punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>v<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> hyp<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#将超参数输出</span>

    <span class="token comment"># Save run settings</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> evolve<span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'hyp.yaml'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            yaml<span class="token punctuation">.</span>safe_dump<span class="token punctuation">(</span>hyp<span class="token punctuation">,</span> f<span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 将超参数写入yaml文件中并保存</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'opt.yaml'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            yaml<span class="token punctuation">.</span>safe_dump<span class="token punctuation">(</span><span class="token builtin">vars</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token comment"># 传入yaml文件中并保存</span>

    <span class="token comment"># Loggers</span>
    data_dict <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">if</span> RANK <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token comment">#还是判断分布式训练</span>
        loggers <span class="token operator">=</span> Loggers<span class="token punctuation">(</span>save_dir<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> hyp<span class="token punctuation">,</span> LOGGER<span class="token punctuation">)</span>  <span class="token comment"># 日志记录</span>
        <span class="token keyword">if</span> loggers<span class="token punctuation">.</span>wandb<span class="token punctuation">:</span> <span class="token comment">#使用wandb记录过程</span>
            data_dict <span class="token operator">=</span> loggers<span class="token punctuation">.</span>wandb<span class="token punctuation">.</span>data_dict
            <span class="token keyword">if</span> resume<span class="token punctuation">:</span>
                weights<span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> hyp<span class="token punctuation">,</span> batch_size <span class="token operator">=</span> opt<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>epochs<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>hyp<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>batch_size

        <span class="token comment"># Register actions</span>
        <span class="token keyword">for</span> k <span class="token keyword">in</span> methods<span class="token punctuation">(</span>loggers<span class="token punctuation">)</span><span class="token punctuation">:</span>
            callbacks<span class="token punctuation">.</span>register_action<span class="token punctuation">(</span>k<span class="token punctuation">,</span> callback<span class="token operator">=</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>loggers<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">#运行callbacks中的每个函数</span>

    <span class="token comment"># Config</span>
    plots <span class="token operator">=</span> <span class="token keyword">not</span> evolve  <span class="token comment"># create plots</span>
    cuda <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">!=</span> <span class="token string">'cpu'</span> <span class="token comment"># 使用什么卡</span>
    init_seeds<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> RANK<span class="token punctuation">)</span> <span class="token comment">#随机种子初始化</span>
    <span class="token keyword">with</span> torch_distributed_zero_first<span class="token punctuation">(</span>LOCAL_RANK<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_dict <span class="token operator">=</span> data_dict <span class="token keyword">or</span> check_dataset<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># 检查数据是否存在</span>
    train_path<span class="token punctuation">,</span> val_path <span class="token operator">=</span> data_dict<span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data_dict<span class="token punctuation">[</span><span class="token string">'val'</span><span class="token punctuation">]</span> <span class="token comment"># 训练集路径和测试集路径</span>
    nc <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">if</span> single_cls <span class="token keyword">else</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data_dict<span class="token punctuation">[</span><span class="token string">'nc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># class</span>
    names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'item'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> single_cls <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_dict<span class="token punctuation">[</span><span class="token string">'names'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token keyword">else</span> data_dict<span class="token punctuation">[</span><span class="token string">'names'</span><span class="token punctuation">]</span>  <span class="token comment"># 单个类别时使用class names</span>
    <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span> <span class="token operator">==</span> nc<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> names found for nc=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>nc<span class="token punctuation">}</span></span><span class="token string"> dataset in </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data<span class="token punctuation">}</span></span><span class="token string">'</span></span>  <span class="token comment"># 检查类别数目是统一</span>
    is_coco <span class="token operator">=</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>val_path<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword">and</span> val_path<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'coco/val2017.txt'</span><span class="token punctuation">)</span>  <span class="token comment"># COCO dataset 检查是否未coco数据集</span>

    <span class="token comment"># Model</span>
    check_suffix<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> <span class="token string">'.pt'</span><span class="token punctuation">)</span>  <span class="token comment"># check weights 检查权重文件按是否未pt结尾</span>
    pretrained <span class="token operator">=</span> weights<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.pt'</span><span class="token punctuation">)</span> <span class="token comment">#判断加载的预训练模型是否为pt文件</span>
    <span class="token keyword">if</span> pretrained<span class="token punctuation">:</span> <span class="token comment"># 判断是否有预训练模型</span>
        <span class="token keyword">with</span> torch_distributed_zero_first<span class="token punctuation">(</span>LOCAL_RANK<span class="token punctuation">)</span><span class="token punctuation">:</span>
            weights <span class="token operator">=</span> attempt_download<span class="token punctuation">(</span>weights<span class="token punctuation">)</span>  <span class="token comment"># download if not found locally如果权重不存在就下载</span>
        ckpt <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>  <span class="token comment"># 通过torch加载豫训练模型 load checkpoint to CPU to avoid CUDA memory leak</span>
        model <span class="token operator">=</span> Model<span class="token punctuation">(</span>cfg <span class="token keyword">or</span> ckpt<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>yaml<span class="token punctuation">,</span> ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> nc<span class="token operator">=</span>nc<span class="token punctuation">,</span> anchors<span class="token operator">=</span>hyp<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'anchors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># create创建网络，优先cfg</span>
        exclude <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'anchor'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cfg <span class="token keyword">or</span> hyp<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'anchors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> resume <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># exclude keys从cfg或者hyo中得到anchors，优先cfg，也就是说如果需要改anchoes改yaml文件里的就行了</span>
        csd <span class="token operator">=</span> ckpt<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># checkpoint state_dict as FP32 取出豫训练模型的参数</span>
        csd <span class="token operator">=</span> intersect_dicts<span class="token punctuation">(</span>csd<span class="token punctuation">,</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exclude<span class="token operator">=</span>exclude<span class="token punctuation">)</span>  <span class="token comment"># intersect提取预训练模型与新模型相同的部分</span>
        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>csd<span class="token punctuation">,</span> strict<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># load加载相同的部分</span>
        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Transferred </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>csd<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> items from </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>weights<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>  <span class="token comment"># report</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> Model<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> nc<span class="token operator">=</span>nc<span class="token punctuation">,</span> anchors<span class="token operator">=</span>hyp<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'anchors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># create 开始根据yml文件构建网络</span>

    <span class="token comment"># Freeze</span>
    freeze <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'model.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">}</span></span><span class="token string">.'</span></span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">(</span>freeze <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>freeze<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token builtin">range</span><span class="token punctuation">(</span>freeze<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># layers to freeze</span>
    <span class="token comment"># 做迁移学习时冻结某些层</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> model<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 遍历每个层</span>
        v<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># train all layers</span>
        <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>x <span class="token keyword">in</span> k <span class="token keyword">for</span> x <span class="token keyword">in</span> freeze<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 如果层在freeze中就冻结</span>
            LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'freezing </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>k<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span> <span class="token comment"># 打印</span>
            v<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span> <span class="token comment"># 不更新对应膜层的梯度</span>

    <span class="token comment"># Image size</span>
    gs <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>stride<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>  <span class="token comment"># grid size (max stride) 在三个下采样的stride取最大值</span>
    imgsz <span class="token operator">=</span> check_img_size<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>imgsz<span class="token punctuation">,</span> gs<span class="token punctuation">,</span> floor<span class="token operator">=</span>gs <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># verify imgsz is gs-multiple 确认图片尺寸可以整除32</span>

    <span class="token comment"># Batch size</span>
    <span class="token keyword">if</span> RANK <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> batch_size <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># single-GPU only, estimate best batch size，仅仅单个GPU，自动挑选最佳batchsize</span>
        batch_size <span class="token operator">=</span> check_train_batch_size<span class="token punctuation">(</span>model<span class="token punctuation">,</span> imgsz<span class="token punctuation">)</span> <span class="token comment"># 计算batch_size</span>
        loggers<span class="token punctuation">.</span>on_params_update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"batch_size"</span><span class="token punctuation">:</span> batch_size<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment"># Optimizer</span>
    nbs <span class="token operator">=</span> <span class="token number">64</span>  <span class="token comment"># 每64张图片更新一次权重，为了让权重稳定的更新 nominal batch size</span>
    accumulate <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>nbs <span class="token operator">/</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 计算累计几次到64accumulate loss before optimizing</span>
    hyp<span class="token punctuation">[</span><span class="token string">'weight_decay'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> batch_size <span class="token operator">*</span> accumulate <span class="token operator">/</span> nbs  <span class="token comment">#根据batchsize更新 weight_decay  cale weight_decay</span>
    LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Scaled weight_decay = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>hyp<span class="token punctuation">[</span><span class="token string">'weight_decay'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    g0<span class="token punctuation">,</span> g1<span class="token punctuation">,</span> g2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># optimizer parameter groups 各层权重</span>
    <span class="token keyword">for</span> v <span class="token keyword">in</span> model<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#遍历网络</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token string">'bias'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># bias</span>
            g2<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">.</span>bias<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># weight (no decay)</span>
            g0<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">.</span>weight<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token string">'weight'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># weight (with decay)</span>
            g1<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">.</span>weight<span class="token punctuation">)</span>

    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>optimizer <span class="token operator">==</span> <span class="token string">'Adam'</span><span class="token punctuation">:</span> <span class="token comment">#损失函数</span>
        optimizer <span class="token operator">=</span> Adam<span class="token punctuation">(</span>g0<span class="token punctuation">,</span> lr<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token string">'lr0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> betas<span class="token operator">=</span><span class="token punctuation">(</span>hyp<span class="token punctuation">[</span><span class="token string">'momentum'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># adjust beta1 to momentum</span>
    <span class="token keyword">elif</span> opt<span class="token punctuation">.</span>optimizer <span class="token operator">==</span> <span class="token string">'AdamW'</span><span class="token punctuation">:</span>
        optimizer <span class="token operator">=</span> AdamW<span class="token punctuation">(</span>g0<span class="token punctuation">,</span> lr<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token string">'lr0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> betas<span class="token operator">=</span><span class="token punctuation">(</span>hyp<span class="token punctuation">[</span><span class="token string">'momentum'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># adjust beta1 to momentum</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        optimizer <span class="token operator">=</span> SGD<span class="token punctuation">(</span>g0<span class="token punctuation">,</span> lr<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token string">'lr0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token string">'momentum'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nesterov<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    optimizer<span class="token punctuation">.</span>add_param_group<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'params'</span><span class="token punctuation">:</span> g1<span class="token punctuation">,</span> <span class="token string">'weight_decay'</span><span class="token punctuation">:</span> hyp<span class="token punctuation">[</span><span class="token string">'weight_decay'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># 防止过拟合 add g1 with weight_decay</span>
    optimizer<span class="token punctuation">.</span>add_param_group<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'params'</span><span class="token punctuation">:</span> g2<span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># add g2 (biases)</span>
    LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>colorstr<span class="token punctuation">(</span><span class="token string">'optimizer:'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>optimizer<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string"> with parameter groups "</span></span>
                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>g0<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> weight (no decay), </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>g1<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> weight, </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>g2<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> bias"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">del</span> g0<span class="token punctuation">,</span> g1<span class="token punctuation">,</span> g2

    <span class="token comment"># Scheduler 两个学习率下降方式</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>cos_lr<span class="token punctuation">:</span> <span class="token comment"># 用cos函数下将</span>
        lf <span class="token operator">=</span> one_cycle<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> hyp<span class="token punctuation">[</span><span class="token string">'lrf'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> epochs<span class="token punctuation">)</span>  <span class="token comment"># cosine 1-&gt;hyp['lrf']</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        lf <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> x <span class="token operator">/</span> epochs<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> hyp<span class="token punctuation">[</span><span class="token string">'lrf'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> hyp<span class="token punctuation">[</span><span class="token string">'lrf'</span><span class="token punctuation">]</span>  <span class="token comment"># linear 直线下降</span>
    scheduler <span class="token operator">=</span> lr_scheduler<span class="token punctuation">.</span>LambdaLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> lr_lambda<span class="token operator">=</span>lf<span class="token punctuation">)</span>  <span class="token comment"># plot_lr_scheduler(optimizer, scheduler, epochs)</span>


    <span class="token comment"># EMA 指数滑窗平均，目的是让weight变化更加平滑</span>
    ema <span class="token operator">=</span> ModelEMA<span class="token punctuation">(</span>model<span class="token punctuation">)</span> <span class="token keyword">if</span> RANK <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token boolean">None</span>

    <span class="token comment"># Resume</span>
    start_epoch<span class="token punctuation">,</span> best_fitness <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.0</span> <span class="token comment">#开始轮数，最好的结果轮数</span>
    <span class="token keyword">if</span> pretrained<span class="token punctuation">:</span> <span class="token comment"># 判断是否为继续训练</span>
        <span class="token comment"># Optimizer</span>
        <span class="token keyword">if</span> ckpt<span class="token punctuation">[</span><span class="token string">'optimizer'</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            optimizer<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>ckpt<span class="token punctuation">[</span><span class="token string">'optimizer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            best_fitness <span class="token operator">=</span> ckpt<span class="token punctuation">[</span><span class="token string">'best_fitness'</span><span class="token punctuation">]</span>

        <span class="token comment"># EMA</span>
        <span class="token keyword">if</span> ema <span class="token keyword">and</span> ckpt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'ema'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            ema<span class="token punctuation">.</span>ema<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>ckpt<span class="token punctuation">[</span><span class="token string">'ema'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            ema<span class="token punctuation">.</span>updates <span class="token operator">=</span> ckpt<span class="token punctuation">[</span><span class="token string">'updates'</span><span class="token punctuation">]</span>

        <span class="token comment"># Epochs</span>
        start_epoch <span class="token operator">=</span> ckpt<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment">#从上次的epoch接着训练</span>
        <span class="token keyword">if</span> resume<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> start_epoch <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>weights<span class="token punctuation">}</span></span><span class="token string"> training to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epochs<span class="token punctuation">}</span></span><span class="token string"> epochs is finished, nothing to resume.'</span></span>
        <span class="token keyword">if</span> epochs <span class="token operator">&lt;</span> start_epoch<span class="token punctuation">:</span>
            LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>weights<span class="token punctuation">}</span></span><span class="token string"> has been trained for </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ckpt<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> epochs. Fine-tuning for </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epochs<span class="token punctuation">}</span></span><span class="token string"> more epochs."</span></span><span class="token punctuation">)</span>
            epochs <span class="token operator">+=</span> ckpt<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span>  <span class="token comment"># finetune additional epochs</span>

        <span class="token keyword">del</span> ckpt<span class="token punctuation">,</span> csd

    <span class="token comment"># DP mode 使用dpMode 训练，目前一般不使用</span>
    <span class="token keyword">if</span> cuda <span class="token keyword">and</span> RANK <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        LOGGER<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'WARNING: DP not recommended, use torch.distributed.run for best DDP Multi-GPU results.n'</span>
                       <span class="token string">'See Multi-GPU Tutorial at https://github.com/ultralytics/yolov5/issues/475 to get started.'</span><span class="token punctuation">)</span>
        model <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>model<span class="token punctuation">)</span>

    <span class="token comment"># SyncBatchNorm</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>sync_bn <span class="token keyword">and</span> cuda <span class="token keyword">and</span> RANK <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token comment"># 多卡训练，把不同卡的数据做个同步</span>
        model <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>SyncBatchNorm<span class="token punctuation">.</span>convert_sync_batchnorm<span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Using SyncBatchNorm()'</span><span class="token punctuation">)</span>

    <span class="token comment"># Trainloader 训练集</span>
    train_loader<span class="token punctuation">,</span> dataset <span class="token operator">=</span> create_dataloader<span class="token punctuation">(</span>train_path<span class="token punctuation">,</span> imgsz<span class="token punctuation">,</span> batch_size <span class="token operator">//</span> WORLD_SIZE<span class="token punctuation">,</span> gs<span class="token punctuation">,</span> single_cls<span class="token punctuation">,</span>
                                              hyp<span class="token operator">=</span>hyp<span class="token punctuation">,</span> augment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> cache<span class="token operator">=</span><span class="token boolean">None</span> <span class="token keyword">if</span> opt<span class="token punctuation">.</span>cache <span class="token operator">==</span> <span class="token string">'val'</span> <span class="token keyword">else</span> opt<span class="token punctuation">.</span>cache<span class="token punctuation">,</span>
                                              rect<span class="token operator">=</span>opt<span class="token punctuation">.</span>rect<span class="token punctuation">,</span> rank<span class="token operator">=</span>LOCAL_RANK<span class="token punctuation">,</span> workers<span class="token operator">=</span>workers<span class="token punctuation">,</span>
                                              image_weights<span class="token operator">=</span>opt<span class="token punctuation">.</span>image_weights<span class="token punctuation">,</span> quad<span class="token operator">=</span>opt<span class="token punctuation">.</span>quad<span class="token punctuation">,</span>
                                              prefix<span class="token operator">=</span>colorstr<span class="token punctuation">(</span><span class="token string">'train: '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment">#</span>
    mlc <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>labels<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># max label class 也就是class数目</span>
    nb <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span>  <span class="token comment"># number of batches 一共有多少个batch，也就是图片数量/batchsize</span>
    <span class="token keyword">assert</span> mlc <span class="token operator">&lt;</span> nc<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'Label class </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>mlc<span class="token punctuation">}</span></span><span class="token string"> exceeds nc=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>nc<span class="token punctuation">}</span></span><span class="token string"> in </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data<span class="token punctuation">}</span></span><span class="token string">. Possible class labels are 0-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>nc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
    <span class="token comment"># 从数据中获得的classs 不能比yaml中给的多</span>
    <span class="token comment"># Process 0 训练集</span>
    <span class="token keyword">if</span> RANK <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token comment">#创建验证集</span>
        val_loader <span class="token operator">=</span> create_dataloader<span class="token punctuation">(</span>val_path<span class="token punctuation">,</span> imgsz<span class="token punctuation">,</span> batch_size <span class="token operator">//</span> WORLD_SIZE <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> gs<span class="token punctuation">,</span> single_cls<span class="token punctuation">,</span>
                                       hyp<span class="token operator">=</span>hyp<span class="token punctuation">,</span> cache<span class="token operator">=</span><span class="token boolean">None</span> <span class="token keyword">if</span> noval <span class="token keyword">else</span> opt<span class="token punctuation">.</span>cache<span class="token punctuation">,</span>
                                       rect<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> rank<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> workers<span class="token operator">=</span>workers <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> pad<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                                       prefix<span class="token operator">=</span>colorstr<span class="token punctuation">(</span><span class="token string">'val: '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> resume<span class="token punctuation">:</span>
            labels <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>labels<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 所有的图片上的框和类别放到一个nmpy里</span>
            <span class="token comment"># c = torch.tensor(labels[:, 0])  # classes</span>
            <span class="token comment"># cf = torch.bincount(c.long(), minlength=nc) + 1.  # frequency</span>
            <span class="token comment"># model._initialize_biases(cf.to(device))</span>
            <span class="token keyword">if</span> plots<span class="token punctuation">:</span> <span class="token comment"># 画出数据分布图</span>
                plot_labels<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> names<span class="token punctuation">,</span> save_dir<span class="token punctuation">)</span>

            <span class="token comment"># Anchors</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> opt<span class="token punctuation">.</span>noautoanchor<span class="token punctuation">:</span> <span class="token comment"># 判断是否计算锚框</span>
                check_anchors<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> model<span class="token operator">=</span>model<span class="token punctuation">,</span> thr<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token string">'anchor_t'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> imgsz<span class="token operator">=</span>imgsz<span class="token punctuation">)</span> <span class="token comment"># 检查anchors设置是否合理</span>
            model<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># pre-reduce anchor precision 半精度训练具体含义不知</span>

        callbacks<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'on_pretrain_routine_end'</span><span class="token punctuation">)</span>

    <span class="token comment"># DDP mode</span>
    <span class="token keyword">if</span> cuda <span class="token keyword">and</span> RANK <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token comment">#多卡时转换为ddpmodel</span>
        model <span class="token operator">=</span> DDP<span class="token punctuation">(</span>model<span class="token punctuation">,</span> device_ids<span class="token operator">=</span><span class="token punctuation">[</span>LOCAL_RANK<span class="token punctuation">]</span><span class="token punctuation">,</span> output_device<span class="token operator">=</span>LOCAL_RANK<span class="token punctuation">)</span>

    <span class="token comment"># Model attributes</span>
    nl <span class="token operator">=</span> de_parallel<span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">.</span>model<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>nl  <span class="token comment"># 构建网路时有几层检测层 number of detection layers (to scale hyps)</span>
    hyp<span class="token punctuation">[</span><span class="token string">'box'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">3</span> <span class="token operator">/</span> nl  <span class="token comment"># scale to layers 原始的hyp是有三个检测层，如果设置了多层，会将权重scale</span>
    hyp<span class="token punctuation">[</span><span class="token string">'cls'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> nc <span class="token operator">/</span> <span class="token number">80</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> nl  <span class="token comment"># scale to classes and layers 同上</span>
    hyp<span class="token punctuation">[</span><span class="token string">'obj'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token punctuation">(</span>imgsz <span class="token operator">/</span> <span class="token number">640</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> nl  <span class="token comment"># scale to image size and layers 置信度权重</span>
    hyp<span class="token punctuation">[</span><span class="token string">'label_smoothing'</span><span class="token punctuation">]</span> <span class="token operator">=</span> opt<span class="token punctuation">.</span>label_smoothing
    model<span class="token punctuation">.</span>nc <span class="token operator">=</span> nc  <span class="token comment"># attach number of classes to model 权重变换后更新到model中</span>
    model<span class="token punctuation">.</span>hyp <span class="token operator">=</span> hyp  <span class="token comment"># attach hyperparameters to model</span>
    model<span class="token punctuation">.</span>class_weights <span class="token operator">=</span> labels_to_class_weights<span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>labels<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token operator">*</span> nc  <span class="token comment"># attach class weights 均衡各个类别的权重</span>
    model<span class="token punctuation">.</span>names <span class="token operator">=</span> names <span class="token comment"># 每个class对应的名字</span>

    <span class="token comment"># Start training</span>
    t0 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    nw <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>hyp<span class="token punctuation">[</span><span class="token string">'warmup_epochs'</span><span class="token punctuation">]</span> <span class="token operator">*</span> nb<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>  <span class="token comment">#热身训练的batch数，也就是需要多少张图片热身 number of warmup iterations, max(3 epochs, 1k iterations)</span>
    <span class="token comment"># nw = min(nw, (epochs - start_epoch) /  2 * nb)  # limit warmup to &lt; 1/2 of training</span>
    last_opt_step <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    maps <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>nc<span class="token punctuation">)</span>  <span class="token comment"># mAP per class 每个class的map值</span>
    results <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># P, R, mAP@.5, mAP@.5-.95, val_loss(box, obj, cls) 保存各种结果</span>
    scheduler<span class="token punctuation">.</span>last_epoch <span class="token operator">=</span> start_epoch <span class="token operator">-</span> <span class="token number">1</span>  <span class="token comment"># do not move</span>
    scaler <span class="token operator">=</span> amp<span class="token punctuation">.</span>GradScaler<span class="token punctuation">(</span>enabled<span class="token operator">=</span>cuda<span class="token punctuation">)</span> <span class="token comment"># amp</span>
    stopper <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>patience<span class="token operator">=</span>opt<span class="token punctuation">.</span>patience<span class="token punctuation">)</span> <span class="token comment"># 连续训练几轮 loss没有下降就会停止</span>
    compute_loss <span class="token operator">=</span> ComputeLoss<span class="token punctuation">(</span>model<span class="token punctuation">)</span>  <span class="token comment"># init loss class</span>
    LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Image sizes </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>imgsz<span class="token punctuation">}</span></span><span class="token string"> train, </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>imgsz<span class="token punctuation">}</span></span><span class="token string"> valn'</span></span>
                <span class="token string-interpolation"><span class="token string">f'Using </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>train_loader<span class="token punctuation">.</span>num_workers <span class="token operator">*</span> WORLD_SIZE<span class="token punctuation">}</span></span><span class="token string"> dataloader workersn'</span></span>
                <span class="token string-interpolation"><span class="token string">f"Logging results to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>colorstr<span class="token punctuation">(</span><span class="token string">'bold'</span><span class="token punctuation">,</span> save_dir<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">n"</span></span>
                <span class="token string-interpolation"><span class="token string">f'Starting training for </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epochs<span class="token punctuation">}</span></span><span class="token string"> epochs...'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start_epoch<span class="token punctuation">,</span> epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 开始训练epoch ------------------------------------------------------------------</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Update image weights (optional, single-GPU only)</span>
        <span class="token keyword">if</span> opt<span class="token punctuation">.</span>image_weights<span class="token punctuation">:</span> <span class="token comment"># 参考opt注释</span>
            cw <span class="token operator">=</span> model<span class="token punctuation">.</span>class_weights<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> maps<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">/</span> nc  <span class="token comment"># 根据每个class的map值更新class weights</span>
            iw <span class="token operator">=</span> labels_to_image_weights<span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>labels<span class="token punctuation">,</span> nc<span class="token operator">=</span>nc<span class="token punctuation">,</span> class_weights<span class="token operator">=</span>cw<span class="token punctuation">)</span>  <span class="token comment"># 根据class计算的weight更新image weights</span>
            dataset<span class="token punctuation">.</span>indices <span class="token operator">=</span> random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> weights<span class="token operator">=</span>iw<span class="token punctuation">,</span> k<span class="token operator">=</span>dataset<span class="token punctuation">.</span>n<span class="token punctuation">)</span>  <span class="token comment"># 下次训练时根据权重挑选数据 rand weighted idx</span>

        <span class="token comment"># Update mosaic border (optional)</span>
        <span class="token comment"># b = int(random.uniform(0.25 * imgsz, 0.75 * imgsz + gs) // gs * gs)</span>
        <span class="token comment"># dataset.mosaic_border = [b - imgsz, -b]  # height, width borders</span>

        mloss <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>  <span class="token comment"># mean losses 平均loss</span>
        <span class="token keyword">if</span> RANK <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            train_loader<span class="token punctuation">.</span>sampler<span class="token punctuation">.</span>set_epoch<span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
        pbar <span class="token operator">=</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span> <span class="token comment">#进度条</span>
        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'n'</span> <span class="token operator">+</span> <span class="token string">'%10s'</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token string">'Epoch'</span><span class="token punctuation">,</span> <span class="token string">'gpu_mem'</span><span class="token punctuation">,</span> <span class="token string">'box'</span><span class="token punctuation">,</span> <span class="token string">'obj'</span><span class="token punctuation">,</span> <span class="token string">'cls'</span><span class="token punctuation">,</span> <span class="token string">'labels'</span><span class="token punctuation">,</span> <span class="token string">'img_size'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> RANK <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            pbar <span class="token operator">=</span> tqdm<span class="token punctuation">(</span>pbar<span class="token punctuation">,</span> total<span class="token operator">=</span>nb<span class="token punctuation">,</span> bar_format<span class="token operator">=</span><span class="token string">'{l_bar}{bar:10}{r_bar}{bar:-10b}'</span><span class="token punctuation">)</span>  <span class="token comment">#pbar初始化，参考tqdm的使用 progress bar</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 清空梯度</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> paths<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token keyword">in</span> pbar<span class="token punctuation">:</span>  <span class="token comment"># batch -------------------------------------------------------------</span>
            ni <span class="token operator">=</span> i <span class="token operator">+</span> nb <span class="token operator">*</span> epoch  <span class="token comment">#指历时以来训练了多少battch number integrated batches (since train start)</span>
            imgs <span class="token operator">=</span> imgs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">,</span> non_blocking<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255</span>  <span class="token comment">#  将图像进行一个 255的归一化 uint8 to float32, 0-255 to 0.0-1.0</span>

            <span class="token comment"># Warmup</span>
            <span class="token keyword">if</span> ni <span class="token operator">&lt;=</span> nw<span class="token punctuation">:</span> <span class="token comment">#热身过程</span>
                xi <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> nw<span class="token punctuation">]</span>  <span class="token comment"># x interp wram up的过程</span>
                <span class="token comment"># compute_loss.gr = np.interp(ni, xi, [0.0, 1.0])  # iou loss ratio (obj_loss = 1.0 or iou)</span>
                accumulate <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>interp<span class="token punctuation">(</span>ni<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> nbs <span class="token operator">/</span> batch_size<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#计算累计多少个batch计算迭代，因为是热身，可在第一次就迭代</span>
                <span class="token keyword">for</span> j<span class="token punctuation">,</span> x <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 遍历param_groups</span>
                    <span class="token comment"># bias lr falls from 0.1 to lr0, all other lrs rise from 0.0 to lr0</span>
                    x<span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>interp <span class="token punctuation">(</span>ni<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> <span class="token punctuation">[</span>hyp<span class="token punctuation">[</span><span class="token string">'warmup_bias_lr'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> j <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">else</span> <span class="token number">0.0</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token string">'initial_lr'</span><span class="token punctuation">]</span> <span class="token operator">*</span> lf<span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 更新学习率，在param_groups里的缓慢更新，不在的快速更新，具体可了解yolov5学习率更新策略</span>
                    <span class="token keyword">if</span> <span class="token string">'momentum'</span> <span class="token keyword">in</span> x<span class="token punctuation">:</span>
                        x<span class="token punctuation">[</span><span class="token string">'momentum'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>interp<span class="token punctuation">(</span>ni<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> <span class="token punctuation">[</span>hyp<span class="token punctuation">[</span><span class="token string">'warmup_momentum'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hyp<span class="token punctuation">[</span><span class="token string">'momentum'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 同上</span>

            <span class="token comment"># Multi-scale</span>
            <span class="token keyword">if</span> opt<span class="token punctuation">.</span>multi_scale<span class="token punctuation">:</span> <span class="token comment"># 多尺度训练</span>
                sz <span class="token operator">=</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span>imgsz <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> imgsz <span class="token operator">*</span> <span class="token number">1.5</span> <span class="token operator">+</span> gs<span class="token punctuation">)</span> <span class="token operator">//</span> gs <span class="token operator">*</span> gs  <span class="token comment"># 在0.5到1.5的倍率之间随机取imgsize</span>
                sf <span class="token operator">=</span> sz <span class="token operator">/</span> <span class="token builtin">max</span><span class="token punctuation">(</span>imgs<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># scale factor</span>
                <span class="token keyword">if</span> sf <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token comment"># 如果不等于1 就resize</span>
                    ns <span class="token operator">=</span> <span class="token punctuation">[</span>math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>x <span class="token operator">*</span> sf <span class="token operator">/</span> gs<span class="token punctuation">)</span> <span class="token operator">*</span> gs <span class="token keyword">for</span> x <span class="token keyword">in</span> imgs<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># new shape (stretched to gs-multiple)</span>
                    imgs <span class="token operator">=</span> nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> size<span class="token operator">=</span>ns<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'bilinear'</span><span class="token punctuation">,</span> align_corners<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

            <span class="token comment"># Forward</span>
            <span class="token keyword">with</span> amp<span class="token punctuation">.</span>autocast<span class="token punctuation">(</span>enabled<span class="token operator">=</span>cuda<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#混合精度训练</span>
                pred <span class="token operator">=</span> model<span class="token punctuation">(</span>imgs<span class="token punctuation">)</span>  <span class="token comment"># forward 前向传播，返回预测值</span>
                loss<span class="token punctuation">,</span> loss_items <span class="token operator">=</span> compute_loss<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> targets<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 计算loss值，loss为总的loss，items为box，conf，class的loss，class loss scaled by batch_size</span>
                <span class="token keyword">if</span> RANK <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
                    loss <span class="token operator">*=</span> WORLD_SIZE  <span class="token comment"># gradient averaged between devices in DDP mode</span>
                <span class="token keyword">if</span> opt<span class="token punctuation">.</span>quad<span class="token punctuation">:</span>
                    loss <span class="token operator">*=</span> <span class="token number">4.</span>

            <span class="token comment"># Backward</span>
            scaler<span class="token punctuation">.</span>scale<span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># Optimize</span>
            <span class="token keyword">if</span> ni <span class="token operator">-</span> last_opt_step <span class="token operator">&gt;=</span> accumulate<span class="token punctuation">:</span> <span class="token comment"># 优化迭代，如果现在的epoch和上一次的epoch的差值大于accumulate就会更新权重</span>
                scaler<span class="token punctuation">.</span>step<span class="token punctuation">(</span>optimizer<span class="token punctuation">)</span>  <span class="token comment"># optimizer.step，step更细</span>
                scaler<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>
                optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 清零梯度</span>
                <span class="token keyword">if</span> ema<span class="token punctuation">:</span>
                    ema<span class="token punctuation">.</span>update<span class="token punctuation">(</span>model<span class="token punctuation">)</span> <span class="token comment">#将计算出来的weight加到model中</span>
                last_opt_step <span class="token operator">=</span> ni <span class="token comment">#更新轮数</span>

            <span class="token comment"># Log</span>
            <span class="token keyword">if</span> RANK <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                mloss <span class="token operator">=</span> <span class="token punctuation">(</span>mloss <span class="token operator">*</span> i <span class="token operator">+</span> loss_items<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># update mean losses 平均loss</span>
                mem <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>memory_reserved<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1E9</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token format-spec">.3g</span><span class="token punctuation">}</span></span><span class="token string">G'</span></span>  <span class="token comment"># (GB) 计算需要多少内存</span>
                pbar<span class="token punctuation">.</span>set_description<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'%10s'</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">'%10.4g'</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
                    <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epochs <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> mem<span class="token punctuation">,</span> <span class="token operator">*</span>mloss<span class="token punctuation">,</span> targets<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> imgs<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#打印</span>
                callbacks<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'on_train_batch_end'</span><span class="token punctuation">,</span> ni<span class="token punctuation">,</span> model<span class="token punctuation">,</span> imgs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> paths<span class="token punctuation">,</span> plots<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>sync_bn<span class="token punctuation">)</span>
                <span class="token keyword">if</span> callbacks<span class="token punctuation">.</span>stop_training<span class="token punctuation">:</span>
                    <span class="token keyword">return</span>
            <span class="token comment"># end batch ------------------------------------------------------------------------------------------------</span>

        <span class="token comment"># Scheduler</span>
        lr <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">]</span>  <span class="token comment"># for loggers 将学习率取出方便计算打印log</span>
        scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> RANK <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment"># mAP</span>
            callbacks<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'on_train_epoch_end'</span><span class="token punctuation">,</span> epoch<span class="token operator">=</span>epoch<span class="token punctuation">)</span>
            ema<span class="token punctuation">.</span>update_attr<span class="token punctuation">(</span>model<span class="token punctuation">,</span> include<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'yaml'</span><span class="token punctuation">,</span> <span class="token string">'nc'</span><span class="token punctuation">,</span> <span class="token string">'hyp'</span><span class="token punctuation">,</span> <span class="token string">'names'</span><span class="token punctuation">,</span> <span class="token string">'stride'</span><span class="token punctuation">,</span> <span class="token string">'class_weights'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            final_epoch <span class="token operator">=</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> epochs<span class="token punctuation">)</span> <span class="token keyword">or</span> stopper<span class="token punctuation">.</span>possible_stop <span class="token comment">#检查是否为最后一个epoch</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> noval <span class="token keyword">or</span> final_epoch<span class="token punctuation">:</span>  <span class="token comment"># Calculate mAP 计算结果，得到results和map</span>
                results<span class="token punctuation">,</span> maps<span class="token punctuation">,</span> _ <span class="token operator">=</span> val<span class="token punctuation">.</span>run<span class="token punctuation">(</span>data_dict<span class="token punctuation">,</span>
                                           batch_size<span class="token operator">=</span>batch_size <span class="token operator">//</span> WORLD_SIZE <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
                                           imgsz<span class="token operator">=</span>imgsz<span class="token punctuation">,</span>
                                           model<span class="token operator">=</span>ema<span class="token punctuation">.</span>ema<span class="token punctuation">,</span>
                                           single_cls<span class="token operator">=</span>single_cls<span class="token punctuation">,</span>
                                           dataloader<span class="token operator">=</span>val_loader<span class="token punctuation">,</span>
                                           save_dir<span class="token operator">=</span>save_dir<span class="token punctuation">,</span>
                                           plots<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                                           callbacks<span class="token operator">=</span>callbacks<span class="token punctuation">,</span>
                                           compute_loss<span class="token operator">=</span>compute_loss<span class="token punctuation">)</span>

            <span class="token comment"># Update best mAP</span>
            fi <span class="token operator">=</span> fitness<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 从 [P, R, mAP@.5, mAP@.5-.95] 中得到fi，用于比较，得出最好的epochweighted combination of [P, R, mAP@.5, mAP@.5-.95]</span>
            <span class="token keyword">if</span> fi <span class="token operator">&gt;</span> best_fitness<span class="token punctuation">:</span> <span class="token comment">#如果fi大于目前最佳值，就赋值</span>
                best_fitness <span class="token operator">=</span> fi
            log_vals <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>mloss<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">list</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token operator">+</span> lr <span class="token comment"># 得到结果</span>
            callbacks<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'on_fit_epoch_end'</span><span class="token punctuation">,</span> log_vals<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> best_fitness<span class="token punctuation">,</span> fi<span class="token punctuation">)</span> <span class="token comment">#打印</span>

            <span class="token comment"># Save model</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> nosave<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>final_epoch <span class="token keyword">and</span> <span class="token keyword">not</span> evolve<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># if save 保存model，每一次结果后均保存</span>
                <span class="token comment"># 将各种信息保存</span>
                ckpt <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'epoch'</span><span class="token punctuation">:</span> epoch<span class="token punctuation">,</span> <span class="token comment">#</span>
                        <span class="token string">'best_fitness'</span><span class="token punctuation">:</span> best_fitness<span class="token punctuation">,</span>
                        <span class="token string">'model'</span><span class="token punctuation">:</span> deepcopy<span class="token punctuation">(</span>de_parallel<span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">'ema'</span><span class="token punctuation">:</span> deepcopy<span class="token punctuation">(</span>ema<span class="token punctuation">.</span>ema<span class="token punctuation">)</span><span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">'updates'</span><span class="token punctuation">:</span> ema<span class="token punctuation">.</span>updates<span class="token punctuation">,</span>
                        <span class="token string">'optimizer'</span><span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">'wandb_id'</span><span class="token punctuation">:</span> loggers<span class="token punctuation">.</span>wandb<span class="token punctuation">.</span>wandb_run<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">if</span> loggers<span class="token punctuation">.</span>wandb <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
                        <span class="token string">'date'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

                <span class="token comment"># Save last, best and delete</span>
                torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>ckpt<span class="token punctuation">,</span> last<span class="token punctuation">)</span> <span class="token comment"># 将ckpt保存到last.pt</span>
                <span class="token keyword">if</span> best_fitness <span class="token operator">==</span> fi<span class="token punctuation">:</span> <span class="token comment"># 判断是否和最好的相等，如果和最好的相等就保存的best.pt</span>
                    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>ckpt<span class="token punctuation">,</span> best<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>save_period <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>epoch <span class="token operator">%</span> opt<span class="token punctuation">.</span>save_period <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>ckpt<span class="token punctuation">,</span> w <span class="token operator">/</span> <span class="token string-interpolation"><span class="token string">f'epoch</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token punctuation">}</span></span><span class="token string">.pt'</span></span><span class="token punctuation">)</span>
                <span class="token keyword">del</span> ckpt <span class="token comment"># 保存完毕删掉ckpt</span>
                callbacks<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'on_model_save'</span><span class="token punctuation">,</span> last<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> final_epoch<span class="token punctuation">,</span> best_fitness<span class="token punctuation">,</span> fi<span class="token punctuation">)</span>

            <span class="token comment"># Stop Single-GPU</span>
            <span class="token keyword">if</span> RANK <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> stopper<span class="token punctuation">(</span>epoch<span class="token operator">=</span>epoch<span class="token punctuation">,</span> fitness<span class="token operator">=</span>fi<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#判断是否停止</span>
                <span class="token keyword">break</span>

            <span class="token comment"># Stop DDP TODO: known issues shttps://github.com/ultralytics/yolov5/pull/4576</span>
            <span class="token comment"># stop = stopper(epoch=epoch, fitness=fi)</span>
            <span class="token comment"># if RANK == 0:</span>
            <span class="token comment">#    dist.broadcast_object_list([stop], 0)  # broadcast 'stop' to all ranks</span>

        <span class="token comment"># Stop DPP</span>
        <span class="token comment"># with torch_distributed_zero_first(RANK):</span>
        <span class="token comment"># if stop:</span>
        <span class="token comment">#    break  # must break all DDP ranks</span>

        <span class="token comment"># end epoch ----------------------------------------------------------------------------------------------------</span>
    <span class="token comment"># end training -----------------------------------------------------------------------------------------------------</span>
   <span class="token comment">#结束训练</span>
    <span class="token keyword">if</span> RANK <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch <span class="token operator">-</span> start_epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string"> epochs completed in </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t0<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> hours.'</span></span><span class="token punctuation">)</span> <span class="token comment"># 记录时间</span>
        <span class="token keyword">for</span> f <span class="token keyword">in</span> last<span class="token punctuation">,</span> best<span class="token punctuation">:</span> <span class="token comment">#遍历last，best</span>
            <span class="token keyword">if</span> f<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                strip_optimizer<span class="token punctuation">(</span>f<span class="token punctuation">)</span>  <span class="token comment"># 如果文件存在，就删除其中某些元素，精简模型strip optimizers</span>
                <span class="token keyword">if</span> f <span class="token keyword">is</span> best<span class="token punctuation">:</span> <span class="token comment">#如果是best，得到最佳的结果</span>
                    LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'nValidating </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>f<span class="token punctuation">}</span></span><span class="token string">...'</span></span><span class="token punctuation">)</span>
                    results<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> val<span class="token punctuation">.</span>run<span class="token punctuation">(</span>data_dict<span class="token punctuation">,</span>
                                            batch_size<span class="token operator">=</span>batch_size <span class="token operator">//</span> WORLD_SIZE <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
                                            imgsz<span class="token operator">=</span>imgsz<span class="token punctuation">,</span>
                                            model<span class="token operator">=</span>attempt_load<span class="token punctuation">(</span>f<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            iou_thres<span class="token operator">=</span><span class="token number">0.65</span> <span class="token keyword">if</span> is_coco <span class="token keyword">else</span> <span class="token number">0.60</span><span class="token punctuation">,</span>  <span class="token comment"># best pycocotools results at 0.65</span>
                                            single_cls<span class="token operator">=</span>single_cls<span class="token punctuation">,</span>
                                            dataloader<span class="token operator">=</span>val_loader<span class="token punctuation">,</span>
                                            save_dir<span class="token operator">=</span>save_dir<span class="token punctuation">,</span>
                                            save_json<span class="token operator">=</span>is_coco<span class="token punctuation">,</span>
                                            verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                            plots<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                            callbacks<span class="token operator">=</span>callbacks<span class="token punctuation">,</span>
                                            compute_loss<span class="token operator">=</span>compute_loss<span class="token punctuation">)</span>  <span class="token comment"># val best model with plots</span>
                    <span class="token keyword">if</span> is_coco<span class="token punctuation">:</span>
                        callbacks<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'on_fit_epoch_end'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>mloss<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">list</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token operator">+</span> lr<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> best_fitness<span class="token punctuation">,</span> fi<span class="token punctuation">)</span>
        callbacks<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'on_train_end'</span><span class="token punctuation">,</span> last<span class="token punctuation">,</span> best<span class="token punctuation">,</span> plots<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> results<span class="token punctuation">)</span>
        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Results saved to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>colorstr<span class="token punctuation">(</span><span class="token string">'bold'</span><span class="token punctuation">,</span> save_dir<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>empty_cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> results<span class="token comment"># 返回结果</span>


<span class="token keyword">def</span> <span class="token function">parse_opt</span><span class="token punctuation">(</span>known<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--weights'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'initial weights path'</span><span class="token punctuation">)</span>
    <span class="token comment"># 预训练模型</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--cfg'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'models/my_test.yaml'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'model.yaml path'</span><span class="token punctuation">)</span>
    <span class="token comment"># 模型配置文件，修改网络的话修改这个文件就可以了</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--data'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'data/coco128.yaml'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'dataset.yaml path'</span><span class="token punctuation">)</span>
    <span class="token comment"># 自己的数据集位置及类别</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--hyp'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'data/hyps/hyp.scratch-low.yaml'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'hyperparameters path'</span><span class="token punctuation">)</span>
    <span class="token comment"># 超参数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--epochs'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练轮数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--batch-size'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'total batch size for all GPUs, -1 for autobatch'</span><span class="token punctuation">)</span>
    <span class="token comment"># 每批次的输入数据量；default=-1将时自动调节batchsize大小</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--imgsz'</span><span class="token punctuation">,</span> <span class="token string">'--img'</span><span class="token punctuation">,</span> <span class="token string">'--img-size'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'train, val image size (pixels)'</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练集和测试集图片的像素大小；输入默认640*640，这个参数在你选择yolov5l那些大一点的权重的时候，要进行适当的调整，这样才能达到好的效果</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--rect'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'rectangular training'</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否采用矩形阵训练，就是一个加速训练的方法，所谓矩阵推理就是不再要求你训练的图片是正方形了；矩阵推理会加速模型的推理过程，减少一些冗余信息</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--resume'</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'?'</span><span class="token punctuation">,</span> const<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'resume most recent training'</span><span class="token punctuation">)</span>
    <span class="token comment"># 如果训练因为某些问题终端可以启用这个参数继续训练</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--nosave'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'only save final checkpoint'</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否只保存最后一轮的pt文件；我们默认是保存best.pt和last.pt两个的</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--noval'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'only validate final epoch'</span><span class="token punctuation">)</span>
    <span class="token comment"># 只在最后一轮测试；正常情况下每个epoch都会计算mAP，但如果开启了这个参数，那么就只在最后一轮上进行测试，不建议开启</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--noautoanchor'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'disable AutoAnchor'</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否禁用自动锚框；默认是开启的，自动锚点的好处是可以简化训练过程</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--evolve'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'?'</span><span class="token punctuation">,</span> const<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'evolve hyperparameters for x generations'</span><span class="token punctuation">)</span>
    <span class="token comment"># 超参数进化，就是说训练完后会根据结果自动调整超参数，启用后会大大增加训练时间，建议不使用</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--bucket'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'gsutil bucket'</span><span class="token punctuation">)</span>
    <span class="token comment"># 谷歌云盘的相关项，一般不会用到</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--cache'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'?'</span><span class="token punctuation">,</span> const<span class="token operator">=</span><span class="token string">'ram'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'--cache images in "ram" (default) or "disk"'</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否提前缓存图片到内存，以加快训练速度，默认False；开启这个参数就会对图片进行缓存，从而更好的训练模型。</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--image-weights'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'use weighted image selection for training'</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否启用加权图像策略，默认是不开启的；主要是为了解决样本不平衡问题；开启后会对于上一轮训练效果不好的图片，在下一轮中增加一些权重</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--device'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'cuda device, i.e. 0 or 0,1,2,3 or cpu'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--multi-scale'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'vary img-size +/- 50%%'</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否启用多尺度训练，默认是不开启的；多尺度训练是指设置几种不同的图片输入尺度，训练时每隔一定iterations随机选取一种尺度训练，这样训练出来的模型鲁棒性更强</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--single-cls'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'train multi-class data as single-class'</span><span class="token punctuation">)</span>
    <span class="token comment"># 设定训练数据集是单类别还是多类别；默认为 false多类别</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--optimizer'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'SGD'</span><span class="token punctuation">,</span> <span class="token string">'Adam'</span><span class="token punctuation">,</span> <span class="token string">'AdamW'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'SGD'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'optimizer'</span><span class="token punctuation">)</span>
    <span class="token comment"># 选择优化器；默认为SGD，可选SGD，Adam，AdamW</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--sync-bn'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'use SyncBatchNorm, only available in DDP mode'</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否开启跨卡同步BN；开启参数后即可使用 SyncBatchNorm多 GPU 进行分布式训练，仅在DDP（分布式训练）模式下有效</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--workers'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'max dataloader workers (per RANK in DDP mode)'</span><span class="token punctuation">)</span>
    <span class="token comment"># 最大worker数量；这里经常出问题，建议设置成0</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--project'</span><span class="token punctuation">,</span> default<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'runs/train'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'save to project/name'</span><span class="token punctuation">)</span>
    <span class="token comment"># 指定训练好的模型的保存路径；默认在runs / train</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--name'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'expCTR3'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'save to project/name'</span><span class="token punctuation">)</span>
    <span class="token comment"># 保存文件夹的名字</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--exist-ok'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'existing project/name ok, do not increment'</span><span class="token punctuation">)</span>
    <span class="token comment"># 每次预测模型的结果是否保存在原来的文件夹；如果指定了这个参数的话，那么本次预测的结果还是保存在上一次保存的文件夹里；如果不指定就是每次预测结果保存一个新的文件夹下。</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--quad'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'quad dataloader'</span><span class="token punctuation">)</span>
    <span class="token comment"># 好处是在比默认 640 大的数据集上训练效果更好</span>
    <span class="token comment"># 副作用是在 640 大小的数据集上训练效果可能会差一些</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--cos-lr'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'cosine LR scheduler'</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否开启余弦学习率 使学习率的变化更为平滑，有助于模型训练</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--label-smoothing'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Label smoothing epsilon'</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否对标签进行平滑处理，默认是不启用的</span>
    <span class="token triple-quoted-string string">"""在训练样本中，我们并不能保证所有sample都标注正确，
    如果某个样本标注错误，就可能产生负面印象，
    如果我们有办法“告诉”模型，样本的标签不一定正确，
    那么训练出来的模型对于少量的样本错误就会有“免疫力”采用随机化的标签作为训练数据时，
    损失函数有1-ε的概率与上面的式子相同，比如说告诉模型只有0.95概率是那个标签。"""</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--patience'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'EarlyStopping patience (epochs without improvement)'</span><span class="token punctuation">)</span>
    <span class="token comment"># 早停；如果模型在default值轮数里没有提升，则停止训练模型</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--freeze'</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Freeze layers: backbone=10, first3=0 1 2'</span><span class="token punctuation">)</span>
    <span class="token comment"># 指定冻结层数量；可以在yolov5s.yaml中查看主干网络层数</span>
    <span class="token triple-quoted-string string">"""冻结训练是迁移学习常用的方法，当我们在使用数据量不足的情况下，
    通常我们会选择公共数据集提供权重作为预训练权重，
    我们知道网络的backbone主要是用来提取特征用的，
    一般大型数据集训练好的权重主干特征提取能力是比较强的，
    这个时候我们只需要冻结主干网络，fine - tune后面层就可以了，
    不需要从头开始训练，大大减少了实践而且还提高了性能。"""</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--save-period'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Save checkpoint every x epochs (disabled if &lt; 1)'</span><span class="token punctuation">)</span>
    <span class="token comment"># 用于设置多少个epoch保存一下checkpoint</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--local_rank'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'DDP parameter, do not modify'</span><span class="token punctuation">)</span>
    <span class="token comment"># DistributedDataParallel 单机多卡训练，单GPU设备不需要设置</span>
    <span class="token comment"># Weights &amp; Biases arguments</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--entity'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'W&amp;B: Entity'</span><span class="token punctuation">)</span>
    <span class="token comment"># 在线可视化工具，类似于tensorboard</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--upload_dataset'</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'?'</span><span class="token punctuation">,</span> const<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'W&amp;B: Upload data, "val" option'</span><span class="token punctuation">)</span>
    <span class="token comment"># 是否上传dataset到wandb tabel(将数据集作为交互式 dsviz表 在浏览器中查看、查询、筛选和分析数据集) 默认False</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--bbox_interval'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'W&amp;B: Set bounding-box image logging interval'</span><span class="token punctuation">)</span>
    <span class="token comment"># 设置界框图像记录间隔 Set bounding-box image logging interval for W&amp;B 默认-1</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--artifact_alias'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'latest'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'W&amp;B: Version of dataset artifact to use'</span><span class="token punctuation">)</span>
    <span class="token comment"># 暂未实现</span>
    opt <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_known_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">if</span> known <span class="token keyword">else</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> opt


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> callbacks<span class="token operator">=</span>Callbacks<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Checks</span>
    <span class="token keyword">if</span> RANK <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        print_args<span class="token punctuation">(</span>FILE<span class="token punctuation">.</span>stem<span class="token punctuation">,</span> opt<span class="token punctuation">)</span> <span class="token comment">#打印各个参数</span>
        check_git_status<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 检查是否有新版模型</span>
        check_requirements<span class="token punctuation">(</span>exclude<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'thop'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#检查环境</span>

    <span class="token comment"># Resume</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>resume <span class="token keyword">and</span> <span class="token keyword">not</span> check_wandb_resume<span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> opt<span class="token punctuation">.</span>evolve<span class="token punctuation">:</span>  <span class="token comment"># 检查是否继续训练</span>
        ckpt <span class="token operator">=</span> opt<span class="token punctuation">.</span>resume <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>resume<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword">else</span> get_latest_run<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 如果给定就参数就接着参数训练，如果没给定就获取最后一次训练结果</span>
        <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>ckpt<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'ERROR: --resume checkpoint does not exist'</span> <span class="token comment"># 文件不存在就报错</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>Path<span class="token punctuation">(</span>ckpt<span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent <span class="token operator">/</span> <span class="token string">'opt.yaml'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            opt <span class="token operator">=</span> argparse<span class="token punctuation">.</span>Namespace<span class="token punctuation">(</span><span class="token operator">**</span>yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># replace 读取之前训练结果里的yaml文件</span>
        opt<span class="token punctuation">.</span>cfg<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>resume <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> ckpt<span class="token punctuation">,</span> <span class="token boolean">True</span>  <span class="token comment"># reinstate</span>
        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Resuming training from </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ckpt<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        opt<span class="token punctuation">.</span>data<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>cfg<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>hyp<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>project <span class="token operator">=</span> 
            check_file<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> check_yaml<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>cfg<span class="token punctuation">)</span><span class="token punctuation">,</span> check_yaml<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>hyp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>weights<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>project<span class="token punctuation">)</span>  <span class="token comment"># 导入参数</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>cfg<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>weights<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'either --cfg or --weights must be specified'</span>
        <span class="token comment"># 两个构建模型的参数必须有一个，不然无法构建模型</span>
        <span class="token keyword">if</span> opt<span class="token punctuation">.</span>evolve<span class="token punctuation">:</span> <span class="token comment"># 判断是否开始超参数遗传</span>
            <span class="token keyword">if</span> opt<span class="token punctuation">.</span>project <span class="token operator">==</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ROOT <span class="token operator">/</span> <span class="token string">'runs/train'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># if default project name, rename to runs/evolve</span>
                opt<span class="token punctuation">.</span>project <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ROOT <span class="token operator">/</span> <span class="token string">'runs/evolve'</span><span class="token punctuation">)</span>
            opt<span class="token punctuation">.</span>exist_ok<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>resume <span class="token operator">=</span> opt<span class="token punctuation">.</span>resume<span class="token punctuation">,</span> <span class="token boolean">False</span>  <span class="token comment"># pass resume to exist_ok and disable resume</span>
        opt<span class="token punctuation">.</span>save_dir <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>increment_path<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>project<span class="token punctuation">)</span> <span class="token operator">/</span> opt<span class="token punctuation">.</span>name<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span>opt<span class="token punctuation">.</span>exist_ok<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#参数保存地址，递增</span>

    <span class="token comment"># DDP mode</span>
    device <span class="token operator">=</span> select_device<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>device<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>  <span class="token comment">#选择GPU，如果不给值会自动挑选</span>
    <span class="token keyword">if</span> LOCAL_RANK <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token comment"># 分布式训练</span>
        msg <span class="token operator">=</span> <span class="token string">'is not compatible with YOLOv5 Multi-GPU DDP training'</span>
        <span class="token keyword">assert</span> <span class="token keyword">not</span> opt<span class="token punctuation">.</span>image_weights<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'--image-weights </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>msg<span class="token punctuation">}</span></span><span class="token string">'</span></span>
        <span class="token keyword">assert</span> <span class="token keyword">not</span> opt<span class="token punctuation">.</span>evolve<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'--evolve </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>msg<span class="token punctuation">}</span></span><span class="token string">'</span></span>
        <span class="token keyword">assert</span> opt<span class="token punctuation">.</span>batch_size <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'AutoBatch with --batch-size -1 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>msg<span class="token punctuation">}</span></span><span class="token string">, please pass a valid --batch-size'</span></span>
        <span class="token keyword">assert</span> opt<span class="token punctuation">.</span>batch_size <span class="token operator">%</span> WORLD_SIZE <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'--batch-size </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">}</span></span><span class="token string"> must be multiple of WORLD_SIZE'</span></span>
        <span class="token keyword">assert</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> LOCAL_RANK<span class="token punctuation">,</span> <span class="token string">'insufficient CUDA devices for DDP command'</span>
        torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>set_device<span class="token punctuation">(</span>LOCAL_RANK<span class="token punctuation">)</span>
        device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">,</span> LOCAL_RANK<span class="token punctuation">)</span>
        dist<span class="token punctuation">.</span>init_process_group<span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">"nccl"</span> <span class="token keyword">if</span> dist<span class="token punctuation">.</span>is_nccl_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"gloo"</span><span class="token punctuation">)</span>

    <span class="token comment"># Train</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> opt<span class="token punctuation">.</span>evolve<span class="token punctuation">:</span>
        train<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>hyp<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> device<span class="token punctuation">,</span> callbacks<span class="token punctuation">)</span>
        <span class="token keyword">if</span> WORLD_SIZE <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">and</span> RANK <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Destroying process group... '</span><span class="token punctuation">)</span>
            dist<span class="token punctuation">.</span>destroy_process_group<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Evolve hyperparameters (optional)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># Hyperparameter evolution metadata (mutation scale 0-1, lower_limit, upper_limit)</span>
        meta <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'lr0'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">,</span> <span class="token number">1e-1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># initial learning rate (SGD=1E-2, Adam=1E-3)</span>
                <span class="token string">'lrf'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># final OneCycleLR learning rate (lr0 * lrf)</span>
                <span class="token string">'momentum'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.98</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># SGD momentum/Adam beta1</span>
                <span class="token string">'weight_decay'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># optimizer weight decay</span>
                <span class="token string">'warmup_epochs'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># warmup epochs (fractions ok)</span>
                <span class="token string">'warmup_momentum'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># warmup initial momentum</span>
                <span class="token string">'warmup_bias_lr'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># warmup initial bias lr</span>
                <span class="token string">'box'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># box loss gain</span>
                <span class="token string">'cls'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># cls loss gain</span>
                <span class="token string">'cls_pw'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># cls BCELoss positive_weight</span>
                <span class="token string">'obj'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># obj loss gain (scale with pixels)</span>
                <span class="token string">'obj_pw'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># obj BCELoss positive_weight</span>
                <span class="token string">'iou_t'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># IoU training threshold</span>
                <span class="token string">'anchor_t'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">8.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># anchor-multiple threshold</span>
                <span class="token string">'anchors'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># anchors per output grid (0 to ignore)</span>
                <span class="token string">'fl_gamma'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># focal loss gamma (efficientDet default gamma=1.5)</span>
                <span class="token string">'hsv_h'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image HSV-Hue augmentation (fraction)</span>
                <span class="token string">'hsv_s'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image HSV-Saturation augmentation (fraction)</span>
                <span class="token string">'hsv_v'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image HSV-Value augmentation (fraction)</span>
                <span class="token string">'degrees'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">45.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image rotation (+/- deg)</span>
                <span class="token string">'translate'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image translation (+/- fraction)</span>
                <span class="token string">'scale'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image scale (+/- gain)</span>
                <span class="token string">'shear'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image shear (+/- deg)</span>
                <span class="token string">'perspective'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image perspective (+/- fraction), range 0-0.001</span>
                <span class="token string">'flipud'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image flip up-down (probability)</span>
                <span class="token string">'fliplr'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image flip left-right (probability)</span>
                <span class="token string">'mosaic'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image mixup (probability)</span>
                <span class="token string">'mixup'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># image mixup (probability)</span>
                <span class="token string">'copy_paste'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">}</span>  <span class="token comment"># segment copy-paste (probability)</span>

        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>hyp<span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            hyp <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>  <span class="token comment"># load hyps dict</span>
            <span class="token keyword">if</span> <span class="token string">'anchors'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> hyp<span class="token punctuation">:</span>  <span class="token comment"># anchors commented in hyp.yaml</span>
                hyp<span class="token punctuation">[</span><span class="token string">'anchors'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span>
        opt<span class="token punctuation">.</span>noval<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>nosave<span class="token punctuation">,</span> save_dir <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> Path<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>save_dir<span class="token punctuation">)</span>  <span class="token comment"># only val/save final epoch</span>
        <span class="token comment"># ei = [isinstance(x, (int, float)) for x in hyp.values()]  # evolvable indices</span>
        evolve_yaml<span class="token punctuation">,</span> evolve_csv <span class="token operator">=</span> save_dir <span class="token operator">/</span> <span class="token string">'hyp_evolve.yaml'</span><span class="token punctuation">,</span> save_dir <span class="token operator">/</span> <span class="token string">'evolve.csv'</span>
        <span class="token keyword">if</span> opt<span class="token punctuation">.</span>bucket<span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'gsutil cp gs://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>opt<span class="token punctuation">.</span>bucket<span class="token punctuation">}</span></span><span class="token string">/evolve.csv </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>evolve_csv<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>  <span class="token comment"># download evolve.csv if exists</span>

        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>evolve<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># generations to evolve</span>
            <span class="token keyword">if</span> evolve_csv<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># if evolve.csv exists: select best hyps and mutate</span>
                <span class="token comment"># Select parent(s)</span>
                parent <span class="token operator">=</span> <span class="token string">'single'</span>  <span class="token comment"># parent selection method: 'single' or 'weighted'</span>
                x <span class="token operator">=</span> np<span class="token punctuation">.</span>loadtxt<span class="token punctuation">(</span>evolve_csv<span class="token punctuation">,</span> ndmin<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> delimiter<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">,</span> skiprows<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                n <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># number of previous results to consider</span>
                x <span class="token operator">=</span> x<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token operator">-</span>fitness<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span>  <span class="token comment"># top n mutations</span>
                w <span class="token operator">=</span> fitness<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> fitness<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1E-6</span>  <span class="token comment"># weights (sum &gt; 0)</span>
                <span class="token keyword">if</span> parent <span class="token operator">==</span> <span class="token string">'single'</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    <span class="token comment"># x = x[random.randint(0, n - 1)]  # random selection</span>
                    x <span class="token operator">=</span> x<span class="token punctuation">[</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> weights<span class="token operator">=</span>w<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># weighted selection</span>
                <span class="token keyword">elif</span> parent <span class="token operator">==</span> <span class="token string">'weighted'</span><span class="token punctuation">:</span>
                    x <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> w<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> w<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># weighted combination</span>

                <span class="token comment"># Mutate</span>
                mp<span class="token punctuation">,</span> s <span class="token operator">=</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">0.2</span>  <span class="token comment"># mutation probability, sigma</span>
                npr <span class="token operator">=</span> np<span class="token punctuation">.</span>random
                npr<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                g <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>meta<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> hyp<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># gains 0-1</span>
                ng <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>meta<span class="token punctuation">)</span>
                v <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>ng<span class="token punctuation">)</span>
                <span class="token keyword">while</span> <span class="token builtin">all</span><span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># mutate until a change occurs (prevent duplicates)</span>
                    v <span class="token operator">=</span> <span class="token punctuation">(</span>g <span class="token operator">*</span> <span class="token punctuation">(</span>npr<span class="token punctuation">.</span>random<span class="token punctuation">(</span>ng<span class="token punctuation">)</span> <span class="token operator">&lt;</span> mp<span class="token punctuation">)</span> <span class="token operator">*</span> npr<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>ng<span class="token punctuation">)</span> <span class="token operator">*</span> npr<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> i<span class="token punctuation">,</span> k <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>hyp<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># plt.hist(v.ravel(), 300)</span>
                    hyp<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">*</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># mutate</span>

            <span class="token comment"># Constrain to limits</span>
            <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> meta<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                hyp<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>hyp<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># lower limit</span>
                hyp<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>hyp<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># upper limit</span>
                hyp<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>hyp<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># significant digits</span>

            <span class="token comment"># Train mutation</span>
            results <span class="token operator">=</span> train<span class="token punctuation">(</span>hyp<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> opt<span class="token punctuation">,</span> device<span class="token punctuation">,</span> callbacks<span class="token punctuation">)</span>
            callbacks <span class="token operator">=</span> Callbacks<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># Write mutation results</span>
            print_mutation<span class="token punctuation">(</span>results<span class="token punctuation">,</span> hyp<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> save_dir<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>bucket<span class="token punctuation">)</span>

        <span class="token comment"># Plot results</span>
        plot_evolve<span class="token punctuation">(</span>evolve_csv<span class="token punctuation">)</span>
        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Hyperparameter evolution finished </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>opt<span class="token punctuation">.</span>evolve<span class="token punctuation">}</span></span><span class="token string"> generationsn'</span></span>
                    <span class="token string-interpolation"><span class="token string">f"Results saved to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>colorstr<span class="token punctuation">(</span><span class="token string">'bold'</span><span class="token punctuation">,</span> save_dir<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">n"</span></span>
                    <span class="token string-interpolation"><span class="token string">f'Usage example: $ python train.py --hyp </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>evolve_yaml<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Usage: import train; train.run(data='coco128.yaml', imgsz=320, weights='yolov5m.pt')</span>
    opt <span class="token operator">=</span> parse_opt<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">setattr</span><span class="token punctuation">(</span>opt<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
    main<span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
    <span class="token keyword">return</span> opt


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    opt <span class="token operator">=</span> parse_opt<span class="token punctuation">(</span><span class="token punctuation">)</span>
    main<span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
</code></pre>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>