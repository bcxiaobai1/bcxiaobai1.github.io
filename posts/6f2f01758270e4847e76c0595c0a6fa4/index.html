<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Hyperledger Fabric 智能合约开发及 fabric-sdk-go/fabric-gateway 使用示例 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Hyperledger Fabric 智能合约开发及 fabric-sdk-go/fabric-gateway 使用示例</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-github-gist">
                    
                        
                    
                    <h2>
<a id="_1"></a>前言</h2> 
<p>在上个实验 <a href="https://ifantasy.net/2022/04/13/hyperledger_fabric_7_run_network_on_multi_host/">Hyperledger Fabric 多组织多排序节点部署在多个主机上</a> 中，我们已经实现了多组织多排序节点部署在多个主机上，但到目前为止，我们所有的实验都只是研究了联盟链的网络配置方法（尽管这确实是重难点），而没有考虑具体的应用开发。本文将在前面实验的基础上，首先尝试使用 Go 语言开发了一个工作室联盟链的项目信息智能合约，并成功将其部署至联盟链上；然后依据官方示例，使用 fabric-gateway 模块实现了一个能够管理项目信息智能合约的客户端；之后对比了 fabric-gateway 模块和 fabric-sdk-* 模块各自的优缺点，分析官方示例源码实现了通过 fabric-sdk-* 模块管理整个联盟链网络。一般语境下，本文默认智能合约等于链码。</p> 
<h2>
<a id="_4"></a>工作准备</h2> 
<h3>
<a id="_5"></a>本文工作</h3> 
<p>以三组织三排序节点的方式启动 Hyperledger Fabric 网络，实验共包含四个组织—— council 、 soft 、 web 、 hard ， 其中 council 组织为网络提供 TLS-CA 服务，并且运行维护着三个 orderer 服务；其余每个组织都运行维护着一个 peer 节点、一个 admin 用户和一个 user 用户。网络结构为（实验代码已上传至：<a href="https://github.com/wefantasy/FabricLearn">https://github.com/wefantasy/FabricLearn</a> 的 <code>6_ContractGatewayAndSDK</code> 下）：</p> 
<table>
<thead><tr>
<th align="center">项</th>
<th align="center">运行端口</th>
<th align="center">说明</th>
</tr></thead>
<tbody>
<tr>
<td align="center"><code>council.ifantasy.net</code></td>
<td align="center">7050</td>
<td align="center">council 组织的 CA 服务， 为联盟链网络提供 TLS-CA 服务</td>
</tr>
<tr>
<td align="center"><code>orderer1.council.ifantasy.net</code></td>
<td align="center">7051</td>
<td align="center">council 组织的 orderer1 服务</td>
</tr>
<tr>
<td align="center"><code>orderer1.council.ifantasy.net</code></td>
<td align="center">7052</td>
<td align="center">council 组织的 orderer1 服务的 admin 服务</td>
</tr>
<tr>
<td align="center"><code>orderer2.council.ifantasy.net</code></td>
<td align="center">7054</td>
<td align="center">council 组织的 orderer2 服务</td>
</tr>
<tr>
<td align="center"><code>orderer2.council.ifantasy.net</code></td>
<td align="center">7055</td>
<td align="center">council 组织的 orderer2 服务的 admin 服务</td>
</tr>
<tr>
<td align="center"><code>orderer3.council.ifantasy.net</code></td>
<td align="center">7057</td>
<td align="center">council 组织的 orderer3 服务</td>
</tr>
<tr>
<td align="center"><code>orderer3.council.ifantasy.net</code></td>
<td align="center">7058</td>
<td align="center">council 组织的 orderer3 服务的 admin 服务</td>
</tr>
<tr>
<td align="center"><code>soft.ifantasy.net</code></td>
<td align="center">7250</td>
<td align="center">soft 组织的 CA 服务， 包含成员： peer1 、 admin1 、user1</td>
</tr>
<tr>
<td align="center"><code>peer1.soft.ifantasy.net</code></td>
<td align="center">7251</td>
<td align="center">soft 组织的 peer1 成员节点</td>
</tr>
<tr>
<td align="center"><code>web.ifantasy.net</code></td>
<td align="center">7350</td>
<td align="center">web 组织的 CA 服务， 包含成员： peer1 、 admin1 、user1</td>
</tr>
<tr>
<td align="center"><code>peer1.web.ifantasy.net</code></td>
<td align="center">7351</td>
<td align="center">web 组织的 peer1 成员节点</td>
</tr>
<tr>
<td align="center"><code>hard.ifantasy.net</code></td>
<td align="center">7450</td>
<td align="center">hard 组织的 CA 服务， 包含成员： peer1 、 admin1 、user1</td>
</tr>
<tr>
<td align="center"><code>peer1.hard.ifantasy.net</code></td>
<td align="center">7451</td>
<td align="center">hard 组织的 peer1 成员节点</td>
</tr>
</tbody>
</table> 
<h3>
<a id="_24"></a>实验准备</h3> 
<p>本文网络结构直接将 <a href="https://ifantasy.net/2022/04/11/hyperledger_fabric_6_run_multi_orderer_by_council/">Hyperledger Fabric无排序组织以Raft协议启动多个Orderer服务、TLS组织运行维护Orderer服务</a> 中创建的 <code>4-2_RunOrdererByCouncil</code> 复制为 <code>6_ContractGatewayAndSDK</code> 并修改（建议直接将本案例仓库 <a href="https://github.com/wefantasy/FabricLearn">FabricLearn</a> 下的 <code>6_ContractGatewayAndSDK</code> 目录拷贝到本地运行），文中大部分命令在 <a href="https://ifantasy.net/2022/04/01/hyperledger_fabric_1_custom_our_network/">Hyperledger Fabric定制联盟链网络工程实践</a> 中已有介绍因此不会详细说明。默认情况下，所有命令皆在 <code>6_ContractGatewayAndSDK</code> 根目录下执行，在开始后面的实验前按照以下命令启动基础实验网络：</p> 
<ol>
<li>设置DNS（如果未设置）： <code>./setDNS.sh</code>
</li>
<li>设置环境变量： <code>source envpeer1soft</code>
</li>
<li>启动CA网络： <code>./0_Restart.sh</code>
</li>
</ol> 
<p>本实验初始 docker 网络为：<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-SSmqbTxa-1654947331595)(https://cdn.jsdelivr.net/gh/wefantasy/FileCloud/img/hyperledger_fabric_5_run_orderer_by_oneself-2022-04-12-09-24-43.png “初始 docker 网络”)]</p> 
<h2>
<a id="_33"></a>基础环境</h2> 
<h3>
<a id="_34"></a>注册用户</h3> 
<p>直接运行根目录下的 <code>1_RegisterUser.sh</code> 即可完成本实验所需用户的注册。以往我们每个组织只有一个 peer 节点和一个 admin 节点，但这些节点都不适合为客户端所用，因此基础环境的改变主要包含了为每个组织新增一个 client 类型的用户。以 soft 组织为例，其注册用户命令为：</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"Working on soft"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_TLS_CERTFILES</span><span class="token operator">=</span><span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/ca/crypto/ca-cert.pem
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_HOME</span><span class="token operator">=</span><span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/ca/admin
fabric-ca-client enroll -d -u https://ca-admin:ca-adminpw@soft.ifantasy.net:7250
<span class="token comment"># client 类型用户注册</span>
fabric-ca-client register -d --id.name user1 --id.secret user1 --id.type client -u https://soft.ifantasy.net:7250
fabric-ca-client register -d --id.name peer1 --id.secret peer1 --id.type peer -u https://soft.ifantasy.net:7250
fabric-ca-client register -d --id.name admin1 --id.secret admin1 --id.type admin -u https://soft.ifantasy.net:7250
</code></pre> 
<h3>
<a id="_47"></a>组织证书构建</h3> 
<p>直接运行根目录下的 <code>2_EnrollUser.sh</code> 即可完成本实验所需证书的构建，每个组织主要增加了 <strong>client 类型用户的证书构建</strong> 和 <strong>每个注册用户单元配置文件 config.yaml</strong> ，以 soft 组织为例，其生成组织证书的命令为：</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"Start Soft============================="</span>
<span class="token comment"># 新增</span>
<span class="token builtin class-name">echo</span> <span class="token string">"Enroll User1"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_HOME</span><span class="token operator">=</span><span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/user1
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_TLS_CERTFILES</span><span class="token operator">=</span><span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/assets/ca-cert.pem
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_MSPDIR</span><span class="token operator">=</span>msp
fabric-ca-client enroll -d -u https://user1:user1@soft.ifantasy.net:7250

<span class="token builtin class-name">echo</span> <span class="token string">"Enroll Admin1"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_HOME</span><span class="token operator">=</span><span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/admin1
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_TLS_CERTFILES</span><span class="token operator">=</span><span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/assets/ca-cert.pem
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_MSPDIR</span><span class="token operator">=</span>msp
fabric-ca-client enroll -d -u https://admin1:admin1@soft.ifantasy.net:7250
<span class="token function">mkdir</span> -p <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/admin1/msp/admincerts
<span class="token function">cp</span> <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/admin1/msp/signcerts/cert.pem <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/admin1/msp/admincerts/cert.pem

<span class="token builtin class-name">echo</span> <span class="token string">"Enroll Peer1"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_HOME</span><span class="token operator">=</span><span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/peer1
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_TLS_CERTFILES</span><span class="token operator">=</span><span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/assets/ca-cert.pem
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_MSPDIR</span><span class="token operator">=</span>msp
fabric-ca-client enroll -d -u https://peer1:peer1@soft.ifantasy.net:7250
<span class="token comment"># for TLS</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_MSPDIR</span><span class="token operator">=</span>tls-msp
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_TLS_CERTFILES</span><span class="token operator">=</span><span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/assets/tls-ca-cert.pem
fabric-ca-client enroll -d -u https://peer1soft:peer1soft@council.ifantasy.net:7050 --enrollment.profile tls --csr.hosts peer1.soft.ifantasy.net
<span class="token function">cp</span> <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/peer1/tls-msp/keystore/*_sk <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/peer1/tls-msp/keystore/key.pem
<span class="token function">mkdir</span> -p <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/peer1/msp/admincerts
<span class="token function">cp</span> <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/admin1/msp/signcerts/cert.pem <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/peer1/msp/admincerts/cert.pem

<span class="token function">mkdir</span> -p <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/msp/admincerts
<span class="token function">mkdir</span> -p <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/msp/cacerts
<span class="token function">mkdir</span> -p <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/msp/tlscacerts
<span class="token function">mkdir</span> -p <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/msp/users
<span class="token function">cp</span> <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/assets/ca-cert.pem <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/msp/cacerts/
<span class="token function">cp</span> <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/assets/tls-ca-cert.pem <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/msp/tlscacerts/
<span class="token function">cp</span> <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/admin1/msp/signcerts/cert.pem <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/msp/admincerts/cert.pem

<span class="token function">cp</span> <span class="token variable">$LOCAL_ROOT_PATH</span>/config/config-msp.yaml <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/msp/config.yaml
<span class="token comment"># 新增</span>
<span class="token function">cp</span> <span class="token variable">$LOCAL_ROOT_PATH</span>/config/config-msp.yaml <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/user1/msp/config.yaml
<span class="token function">cp</span> <span class="token variable">$LOCAL_ROOT_PATH</span>/config/config-msp.yaml <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/admin1/msp/config.yaml
<span class="token function">cp</span> <span class="token variable">$LOCAL_ROOT_PATH</span>/config/config-msp.yaml <span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net/registers/peer1/msp/config.yaml
<span class="token builtin class-name">echo</span> <span class="token string">"End Soft============================="</span>
</code></pre> 
<p>为了配合使用每个用户的单元配置文件，需要将所有用户 <code>msp</code> 目录下的 <code>cacerts/council-ifantasy-net-7050.pem</code> 文件名修改为 <code>cacerts/ca-cert.pem</code> ，因此在 <code>2_EnrollUser.sh</code> 的末尾追加一行批量修改文件名的命令来实现此目的：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 按正则匹配并批量修改符合要求的文件</span>
<span class="token function">find</span> orgs/ -regex <span class="token string">".+cacerts.+.pem"</span> -not -regex <span class="token string">".+tlscacerts.+"</span> <span class="token operator">|</span> <span class="token function">rename</span> <span class="token string">'s/cacerts/.+.pem/cacerts/ca-cert.pem/'</span>
</code></pre> 
<h3>
<a id="_100"></a>配置通道</h3> 
<p>直接运行根目录下的 <code>3_Configtxgen.sh</code> 即可完成本实验所需通道配置，需要注意的是，为了使通道组织架构更加清晰，将通道配置文件 <code>configtx.yaml</code> 中各组织名称从 <code>orgnameMSP</code> 改为了 <code>orgname</code> ，以 soft 组织为例，其组织通道配置如下：</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">-</span> <span class="token important">&amp;soft</span>
    <span class="token key atrule">Name</span><span class="token punctuation">:</span> softMSP
    <span class="token key atrule">ID</span><span class="token punctuation">:</span> softMSP
    <span class="token key atrule">MSPDir</span><span class="token punctuation">:</span> ../orgs/soft.ifantasy.net/msp
    <span class="token key atrule">Policies</span><span class="token punctuation">:</span>
        <span class="token key atrule">Readers</span><span class="token punctuation">:</span>
            <span class="token key atrule">Type</span><span class="token punctuation">:</span> Signature
            <span class="token key atrule">Rule</span><span class="token punctuation">:</span> <span class="token string">"OR('softMSP.admin', 'softMSP.peer', 'softMSP.client')"</span>
        <span class="token key atrule">Writers</span><span class="token punctuation">:</span>
            <span class="token key atrule">Type</span><span class="token punctuation">:</span> Signature
            <span class="token key atrule">Rule</span><span class="token punctuation">:</span> <span class="token string">"OR('softMSP.admin', 'softMSP.client')"</span>
        <span class="token key atrule">Admins</span><span class="token punctuation">:</span>
            <span class="token key atrule">Type</span><span class="token punctuation">:</span> Signature
            <span class="token key atrule">Rule</span><span class="token punctuation">:</span> <span class="token string">"OR('softMSP.admin')"</span>
        <span class="token key atrule">Endorsement</span><span class="token punctuation">:</span>
            <span class="token key atrule">Type</span><span class="token punctuation">:</span> Signature
            <span class="token key atrule">Rule</span><span class="token punctuation">:</span> <span class="token string">"OR('softMSP.peer')"</span>
    <span class="token key atrule">AnchorPeers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">Host</span><span class="token punctuation">:</span> peer1.soft.ifantasy.net
            <span class="token key atrule">Port</span><span class="token punctuation">:</span> <span class="token number">7251</span>
</code></pre> 
<h2>
<a id="_125"></a>智能合约开发</h2> 
<p>本节将参考官方示例智能合约 <a href="https://github.com/hyperledger/fabric-samples/tree/main/asset-transfer-basic">asset-transfer-basic</a> 开发工作室联盟链的 <strong>项目资源管理智能合约</strong> ，其在官方示例的基础上进行了依赖和结构上的简化。本示例是基于 Go 语言的智能合约，因此建议先学习 Go 语言基础概念和规范，不然自行定制可能会有一些 Bug 。</p> 
<h3>
<a id="_128"></a>合约代码</h3> 
<ol>
<li>初始化目录/文件<br> 在实验根目录 <code>6_ContractGatewayAndSDK</code> 下创建目录 <code>contract</code> 作为智能合约根目录，并在其下创建智能合约文件 <code>project_contract.go</code> ，后续代码皆在 <code>project_contract.go</code> 中。</li>
<li>智能合约结构体<pre><code class="prism language-Go">type ProjectContract struct {
    contractapi.Contract
}
</code></pre> 智能合约结构体一般是固定写法，创建任意一个结构体然后继承 <code>contractapi.Contract</code> 即可，当部署至链上后利用其继承的 <code>contractapi.Contract</code> 的接口实现对合约操作。</li>
<li>项目信息结构体<pre><code class="prism language-Go">type Project struct {
    ID           string `json:"ID"`             // 项目唯一ID
    Name         string `json:"Name"`           // 项目名称
    Developer    string `json:"Developer"`      // 项目主要负责人
    Organization string `json:"Organization"`   // 项目所属组织
    Category     string `json:"Category"`       // 项目所属类别 
    Url          string `json:"Url"`            // 项目介绍地址
    Describes    string `json:"Describes"`      // 项目描述
}
</code></pre> 项目信息结构体主要定义了单个项目的基本信息，类似于 Java 的 Entity 类、数据库的单个表。</li>
<li>初始化智能合约数据<pre><code class="prism language-Go">func (s *ProjectContract) InitLedger(ctx contractapi.TransactionContextInterface) error {
    projects := []Project{
        {ID: "FA8B31A55CD59DB352BCBF4D2AE791AD", Name: "工作室联盟链管理系统", Developer: "Fantasy", Organization: "Web", Category: "blockchain", Url: "https://github.com/wefantasy/FabricLearn", Describes: "本项目虚拟了一个工作室联盟链需求并将逐步实现，致力于提供一个易理解、可复现的Fabric学习项目，其中项目部署步骤的各个环节都清晰可见，并且将所有实验打包为脚本使之能够被快速复现在任何一台主机上"},
    }
    for _, project := range projects {
        projectJSON, err := json.Marshal(project)
        if err != nil {
            return err
        }
        err = ctx.GetStub().PutState(project.ID, projectJSON)
        if err != nil {
            return fmt.Errorf("failed to put to world state. %v", err)
        }
    }
    return nil
}
</code></pre> 在 Fabric 某个旧版本之前必须提供智能合约初始化函数，但在本实验所用的 Fabric 2.4 则是可选项，在此仅仅是为了写入预设实验数据。Fabric 底层使用默认键值对（key-value）状态数据库 LevelDB 储存数据，在操作体验上十分像 redis 数据库。</li>
<li>判断项目信息是否已存在<pre><code class="prism language-Go">func (s *ProjectContract) ProjectExists(ctx contractapi.TransactionContextInterface, id string) (bool, error) {
    projectJSON, err := ctx.GetStub().GetState(id)
    if err != nil {
        return false, fmt.Errorf("failed to read from world state: %v", err)
    }

    return projectJSON != nil, nil
}
</code></pre> </li>
<li>写入新项目信息<pre><code class="prism language-Go">func (s *ProjectContract) CreateProject(ctx contractapi.TransactionContextInterface, id string, name string, developer string, organization string, category string, url string, describes string) error {
    exists, err := s.ProjectExists(ctx, id)
    if err != nil {
        return err
    }
    if exists {
        return fmt.Errorf("the project %s already exists", id)
    }
    project := Project{
        ID:           id,
        Name:         name,
        Developer:    developer,
        Organization: organization,
        Category:     category,
        Url:          url,
        Describes:    describes,
    }
    projectJSON, err := json.Marshal(project)
    if err != nil {
        return err
    }
    return ctx.GetStub().PutState(id, projectJSON)
}
</code></pre> </li>
<li>删除指定项目信息<pre><code class="prism language-Go">func (s *ProjectContract) DeleteProject(ctx contractapi.TransactionContextInterface, id string) error {
    exists, err := s.ProjectExists(ctx, id)
    if err != nil {
        return err
    }
    if !exists {
        return fmt.Errorf("the project %s does not exist", id)
    }

    return ctx.GetStub().DelState(id)
}
</code></pre> Fabric 联盟链作为区块链的一种特殊形式，同样具有可追溯特性，因此任何对数据的增删改操作都是软操作——留下操作记录。</li>
<li>修改项目信息<pre><code class="prism language-Go">func (s *ProjectContract) UpdateProject(ctx contractapi.TransactionContextInterface, id string, name string, developer string, organization string, category string, url string, describes string) error {
    exists, err := s.ProjectExists(ctx, id)
    if err != nil {
        return err
    }
    if !exists {
        return fmt.Errorf("the project %s does not exist", id)
    }
    project := Project{
        ID:           id,
        Name:         name,
        Developer:    developer,
        Organization: organization,
        Category:     category,
        Url:          url,
        Describes:    describes,
    }
    projectJSON, err := json.Marshal(project)
    if err != nil {
        return err
    }
    return ctx.GetStub().PutState(id, projectJSON)
}
</code></pre> </li>
<li>查询项目信息<pre><code class="prism language-Go">func (s *ProjectContract) ReadProject(ctx contractapi.TransactionContextInterface, id string) (*Project, error) {
    projectJSON, err := ctx.GetStub().GetState(id)
    if err != nil {
        return nil, fmt.Errorf("failed to read from world state: %v", err)
    }
    if projectJSON == nil {
        return nil, fmt.Errorf("the project %s does not exist", id)
    }

    var project Project
    err = json.Unmarshal(projectJSON, &amp;project)
    if err != nil {
        return nil, err
    }

    return &amp;project, nil
}
</code></pre> </li>
<li>查询链上所有项目信息<pre><code class="prism language-Go">func (s *ProjectContract) GetAllProjects(ctx contractapi.TransactionContextInterface) ([]*Project, error) {
    // GetStateByRange 查询参数为两个空字符串时即查询所有数据
    resultsIterator, err := ctx.GetStub().GetStateByRange("", "")
    if err != nil {
        return nil, err
    }
    defer resultsIterator.Close()

    var projects []*Project
    for resultsIterator.HasNext() {
        queryResponse, err := resultsIterator.Next()
        if err != nil {
            return nil, err
        }

        var project Project
        err = json.Unmarshal(queryResponse.Value, &amp;project)
        if err != nil {
            return nil, err
        }
        projects = append(projects, &amp;project)
    }

    return projects, nil
}
</code></pre> </li>
<li>智能合约入口函数/主函数<pre><code class="prism language-bash">func <span class="token function-name function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    chaincode, err :<span class="token operator">=</span> contractapi.NewChaincode<span class="token punctuation">(</span><span class="token operator">&amp;</span>ProjectContract<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
        log.Panicf<span class="token punctuation">(</span><span class="token string">"Error creating project-manage chaincode: %v"</span>, err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> err :<span class="token operator">=</span> chaincode.Start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
        log.Panicf<span class="token punctuation">(</span><span class="token string">"Error starting project-manage chaincode: %v"</span>, err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li>
</ol> 
<p>至此，项目信息管理智能合约核心代码以编写完毕，完整 <code>project_contract.go</code> 文件内容如下(需要注意的是<strong>合约入口必须属于 main 包</strong>)：</p> 
<pre><code class="prism language-Go">package main

import (
	"encoding/json"
	"fmt"
	"github.com/hyperledger/fabric-contract-api-go/contractapi"
	"log"
)

type ProjectContract struct {
	contractapi.Contract
}

type Project struct {
	ID           string `json:"ID"`             // 项目唯一ID
	Name         string `json:"Name"`           // 项目名称
	Developer    string `json:"Developer"`      // 项目主要负责人
	Organization string `json:"Organization"`   // 项目所属组织
	Category     string `json:"Category"`       // 项目所属类别 
	Url          string `json:"Url"`            // 项目介绍地址
	Describes    string `json:"Describes"`      // 项目描述
}

// 初始化智能合约数据
func (s *ProjectContract) InitLedger(ctx contractapi.TransactionContextInterface) error {
	projects := []Project{
		{ID: "FA8B31A55CD59DB352BCBF4D2AE791AD", Name: "工作室联盟链管理系统", Developer: "Fantasy", Organization: "Web", Category: "blockchain", Url: "https://github.com/wefantasy/FabricLearn", Describes: "本项目虚拟了一个工作室联盟链需求并将逐步实现，致力于提供一个易理解、可复现的Fabric学习项目，其中项目部署步骤的各个环节都清晰可见，并且将所有实验打包为脚本使之能够被快速复现在任何一台主机上"},
	}
	for _, project := range projects {
		projectJSON, err := json.Marshal(project)
		if err != nil {
			return err
		}
		err = ctx.GetStub().PutState(project.ID, projectJSON)
		if err != nil {
			return fmt.Errorf("failed to put to world state. %v", err)
		}
	}
	return nil
}

// 写入新项目
func (s *ProjectContract) CreateProject(ctx contractapi.TransactionContextInterface, id string, name string, developer string, organization string, category string, url string, describes string) error {
	exists, err := s.ProjectExists(ctx, id)
	if err != nil {
		return err
	}
	if exists {
		return fmt.Errorf("the project %s already exists", id)
	}

	project := Project{
		ID:           id,
		Name:         name,
		Developer:    developer,
		Organization: organization,
		Category:     category,
		Url:          url,
		Describes:    describes,
	}
	projectJSON, err := json.Marshal(project)
	if err != nil {
		return err
	}
	return ctx.GetStub().PutState(id, projectJSON)
}

// 读取指定ID的项目信息
func (s *ProjectContract) ReadProject(ctx contractapi.TransactionContextInterface, id string) (*Project, error) {
	projectJSON, err := ctx.GetStub().GetState(id)
	if err != nil {
		return nil, fmt.Errorf("failed to read from world state: %v", err)
	}
	if projectJSON == nil {
		return nil, fmt.Errorf("the project %s does not exist", id)
	}

	var project Project
	err = json.Unmarshal(projectJSON, &amp;project)
	if err != nil {
		return nil, err
	}

	return &amp;project, nil
}

// 更新项目信息.
func (s *ProjectContract) UpdateProject(ctx contractapi.TransactionContextInterface, id string, name string, developer string, organization string, category string, url string, describes string) error {
	exists, err := s.ProjectExists(ctx, id)
	if err != nil {
		return err
	}
	if !exists {
		return fmt.Errorf("the project %s does not exist", id)
	}

	project := Project{
		ID:           id,
		Name:         name,
		Developer:    developer,
		Organization: organization,
		Category:     category,
		Url:          url,
		Describes:    describes,
	}
	projectJSON, err := json.Marshal(project)
	if err != nil {
		return err
	}

	return ctx.GetStub().PutState(id, projectJSON)
}

// 删除指定ID的项目信息
func (s *ProjectContract) DeleteProject(ctx contractapi.TransactionContextInterface, id string) error {
	exists, err := s.ProjectExists(ctx, id)
	if err != nil {
		return err
	}
	if !exists {
		return fmt.Errorf("the project %s does not exist", id)
	}

	return ctx.GetStub().DelState(id)
}

// 判断某项目是否存在
func (s *ProjectContract) ProjectExists(ctx contractapi.TransactionContextInterface, id string) (bool, error) {
	projectJSON, err := ctx.GetStub().GetState(id)
	if err != nil {
		return false, fmt.Errorf("failed to read from world state: %v", err)
	}

	return projectJSON != nil, nil
}

// 读取所有项目信息
func (s *ProjectContract) GetAllProjects(ctx contractapi.TransactionContextInterface) ([]*Project, error) {
	// GetStateByRange 查询参数为两个空字符串时即查询所有数据
	resultsIterator, err := ctx.GetStub().GetStateByRange("", "")
	if err != nil {
		return nil, err
	}
	defer resultsIterator.Close()

	var projects []*Project
	for resultsIterator.HasNext() {
		queryResponse, err := resultsIterator.Next()
		if err != nil {
			return nil, err
		}

		var project Project
		err = json.Unmarshal(queryResponse.Value, &amp;project)
		if err != nil {
			return nil, err
		}
		projects = append(projects, &amp;project)
	}

	return projects, nil
}

func main() {
	chaincode, err := contractapi.NewChaincode(&amp;ProjectContract{})
	if err != nil {
		log.Panicf("Error creating project-manage chaincode: %v", err)
	}

	if err := chaincode.Start(); err != nil {
		log.Panicf("Error starting project-manage chaincode: %v", err)
	}
}
</code></pre> 
<h3>
<a id="_489"></a>依赖下载</h3> 
<p>合约代码编写完成后并不能直接部署到联盟链上，需要将合约中 <code>import</code> 导入的包下载到本地以供后面一起打包，本小节所有命令默认运行于 <code>6_ContractGatewayAndSDK/contract</code> 下。</p> 
<ol>
<li>初始化模块<pre><code class="prism language-base">go mod init github.com/wefantasy/FabricLearn/6_ContractGatewayAndSDK/contract
</code></pre> </li>
<li>将所有依赖下载到本地<pre><code class="prism language-base">go mod vendor
</code></pre> </li>
</ol> 
<p>以上命令运行成功后，智能合约开发工作基本结束，此时 <code>contract</code> 目录结构如下：</p> 
<pre><code class="prism language-bash">6_ContractGatewayAndSDK/contract
├── go.mod
├── go.sum
├── project_contract.go
└── vendor
    ├── github.com
    ├── golang.org
    ├── google.golang.org
    ├── gopkg.in
    └── modules.tx
</code></pre> 
<h3>
<a id="_514"></a>合约部署测试</h3> 
<p>如无特殊说明，以下命令默认运行于实验根目录 <code>6_ContractGatewayAndSDK</code> 下：</p> 
<ol>
<li>合约打包<pre><code class="prism language-bash"> <span class="token builtin class-name">source</span> envpeer1soft
 peer lifecycle chaincode package basic.tar.gz --path contract --lang golang --label basic_1
</code></pre> </li>
<li>三组织安装<pre><code class="prism language-bash"> <span class="token builtin class-name">source</span> envpeer1soft
 peer lifecycle chaincode <span class="token function">install</span> basic.tar.gz
 peer lifecycle chaincode queryinstalled
 <span class="token builtin class-name">source</span> envpeer1web
 peer lifecycle chaincode <span class="token function">install</span> basic.tar.gz
 peer lifecycle chaincode queryinstalled
 <span class="token builtin class-name">source</span> envpeer1hard
 peer lifecycle chaincode <span class="token function">install</span> basic.tar.gz
 peer lifecycle chaincode queryinstalled
</code></pre> </li>
<li>三组织批准<pre><code class="prism language-bash"> <span class="token builtin class-name">export</span> <span class="token assign-left variable">CHAINCODE_ID</span><span class="token operator">=</span>basic_1:0f1f1ffc8e3865a9179e70a3c56237482b3eb4dcecd30ab51ab01a6f5d3daeff
 <span class="token builtin class-name">source</span> envpeer1soft
 peer lifecycle chaincode approveformyorg -o orderer1.council.ifantasy.net:7051 --tls --cafile <span class="token variable">$ORDERER_CA</span>  --channelID testchannel --name basic --version <span class="token number">1.0</span> --sequence <span class="token number">1</span> --waitForEvent --init-required --package-id <span class="token variable">$CHAINCODE_ID</span>
 peer lifecycle chaincode queryapproved -C testchannel -n basic --sequence <span class="token number">1</span>
 <span class="token builtin class-name">source</span> envpeer1web
 peer lifecycle chaincode approveformyorg -o orderer3.council.ifantasy.net:7057 --tls --cafile <span class="token variable">$ORDERER_CA</span>  --channelID testchannel --name basic --version <span class="token number">1.0</span> --sequence <span class="token number">1</span> --waitForEvent --init-required --package-id <span class="token variable">$CHAINCODE_ID</span>
 peer lifecycle chaincode queryapproved -C testchannel -n basic --sequence <span class="token number">1</span>
 <span class="token builtin class-name">source</span> envpeer1hard
 peer lifecycle chaincode approveformyorg -o orderer2.council.ifantasy.net:7054 --tls --cafile <span class="token variable">$ORDERER_CA</span>  --channelID testchannel --name basic --version <span class="token number">1.0</span> --sequence <span class="token number">1</span> --waitForEvent --init-required --package-id <span class="token variable">$CHAINCODE_ID</span>
 peer lifecycle chaincode queryapproved -C testchannel -n basic --sequence <span class="token number">1</span>
</code></pre> 注意要将 <code>CHAINCODE_ID</code> 的值改为三组织安装时输出的连码包 <code>ID</code> 。</li>
<li>提交并测试<pre><code class="prism language-bash"> <span class="token builtin class-name">source</span> envpeer1soft
 peer lifecycle chaincode commit -o orderer2.council.ifantasy.net:7054 --tls --cafile <span class="token variable">$ORDERER_CA</span> --channelID testchannel --name basic --init-required --version <span class="token number">1.0</span> --sequence <span class="token number">1</span> --peerAddresses peer1.soft.ifantasy.net:7251 --tlsRootCertFiles <span class="token variable">$CORE_PEER_TLS_ROOTCERT_FILE</span> --peerAddresses peer1.web.ifantasy.net:7351 --tlsRootCertFiles <span class="token variable">$CORE_PEER_TLS_ROOTCERT_FILE</span>
 peer chaincode invoke --isInit -o orderer1.council.ifantasy.net:7051 --tls --cafile <span class="token variable">$ORDERER_CA</span> --channelID testchannel --name basic --peerAddresses peer1.soft.ifantasy.net:7251 --tlsRootCertFiles <span class="token variable">$CORE_PEER_TLS_ROOTCERT_FILE</span> --peerAddresses peer1.web.ifantasy.net:7351 --tlsRootCertFiles <span class="token variable">$CORE_PEER_TLS_ROOTCERT_FILE</span> -c <span class="token string">'{"Args":["InitLedger"]}'</span>
 <span class="token function">sleep</span> <span class="token number">5</span>
 peer chaincode invoke -o orderer1.council.ifantasy.net:7051 --tls --cafile <span class="token variable">$ORDERER_CA</span> --channelID testchannel --name basic --peerAddresses peer1.soft.ifantasy.net:7251 --tlsRootCertFiles <span class="token variable">$CORE_PEER_TLS_ROOTCERT_FILE</span> --peerAddresses peer1.web.ifantasy.net:7351 --tlsRootCertFiles <span class="token variable">$CORE_PEER_TLS_ROOTCERT_FILE</span> -c <span class="token string">'{"Args":["GetAllProjects"]}'</span>
</code></pre> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-DQmaKEPb-1654947331596)(https://cdn.jsdelivr.net/gh/wefantasy/FileCloud/img/hyperledger_fabric_9_contract_and_sdk_application_example-2022-06-11-14-09-35.png “提交并测试”)]</li>
</ol> 
<h2>
<a id="fabricgateway__558"></a>fabric-gateway 客户端示例</h2> 
<h3>
<a id="_559"></a>客户端代码</h3> 
<ol>
<li>初始化目录/文件<br> 在实验根目录 <code>6_ContractGatewayAndSDK</code> 下创建目录 <code>contract-gateway</code> 作为 fabric-gateway 客户端的根目录，并在其下创建联盟链网络连接文件 <code>connect.go</code> 和 客户端主程序 <code>app.go</code> 。实验最终目录结构为：<pre><code class="prism language-bash">contract-gateway
├── app.go
├── connect.go
├── go.mod
└── go.sum
</code></pre> </li>
<li>向 <code>connect.go</code> 写入以下内容<pre><code class="prism language-Go">package main

import (
    "crypto/x509"
    "fmt"
    "io/ioutil"
    "path"
    "github.com/hyperledger/fabric-gateway/pkg/identity"
    "google.golang.org/grpc"
    "google.golang.org/grpc/credentials"
)

const (
    mspID         = "softMSP"				// 所属组织的MSPID
    cryptoPath    = "/root/FabricLearn/6_ContractGatewayAndSDK/orgs/soft.ifantasy.net"	// 中间变量
    certPath      = cryptoPath + "/registers/user1/msp/signcerts/cert.pem"		// client 用户的签名证书
    keyPath       = cryptoPath + "/registers/user1/msp/keystore/"		// client 用户的私钥路径
    tlsCertPath   = cryptoPath + "/assets/tls-ca-cert.pem"			// client 用户的 tls 通信证书
    peerEndpoint  = "peer1.soft.ifantasy.net:7251"			// 所连 peer 节点的地址
    gatewayPeer   = "peer1.soft.ifantasy.net"		// 网关 peer 节点名称
)

// 创建指向联盟链网络的 gRPC 连接.
func newGrpcConnection() *grpc.ClientConn {
    certificate, err := loadCertificate(tlsCertPath)
    if err != nil {
        panic(err)
    }

    certPool := x509.NewCertPool()
    certPool.AddCert(certificate)
    transportCredentials := credentials.NewClientTLSFromCert(certPool, gatewayPeer)

    connection, err := grpc.Dial(peerEndpoint, grpc.WithTransportCredentials(transportCredentials))
    if err != nil {
        panic(fmt.Errorf("failed to create gRPC connection: %w", err))
    }

    return connection
}

// 根据用户指定的X.509证书为这个网关连接创建一个客户端标识。
func newIdentity() *identity.X509Identity {
    certificate, err := loadCertificate(certPath)
    if err != nil {
        panic(err)
    }

    id, err := identity.NewX509Identity(mspID, certificate)
    if err != nil {
        panic(err)
    }
    return id
}

// 加载证书文件
func loadCertificate(filename string) (*x509.Certificate, error) {
    certificatePEM, err := ioutil.ReadFile(filename)
    if err != nil {
        return nil, fmt.Errorf("failed to read certificate file: %w", err)
    }
    return identity.CertificateFromPEM(certificatePEM)
}

// 使用私钥从消息摘要生成数字签名
func newSign() identity.Sign {
    files, err := ioutil.ReadDir(keyPath)
    if err != nil {
        panic(fmt.Errorf("failed to read private key directory: %w", err))
    }
    privateKeyPEM, err := ioutil.ReadFile(path.Join(keyPath, files[0].Name()))

    if err != nil {
        panic(fmt.Errorf("failed to read private key file: %w", err))
    }

    privateKey, err := identity.PrivateKeyFromPEM(privateKeyPEM)
    if err != nil {
        panic(err)
    }

    sign, err := identity.NewPrivateKeySign(privateKey)
    if err != nil {
        panic(err)
    }

    return sign
}
</code></pre> 
  <blockquote> 
   <p>值得说明的是，不论是 gateway 客户端还是 fabric-sdk 客户端，一般都可以通过 client 、 admin 类型的用户连接联盟链网络，只是创建单独的 client 类型的专用用户连接网络更符合开发理念。</p> 
  </blockquote> </li>
<li>向 <code>app.go</code> 写入以下内容<pre><code class="prism language-Go">package main

import (
    "bytes"
    "encoding/json"
    "fmt"
    "time"
    "github.com/hyperledger/fabric-gateway/pkg/client"
)

const (
    channelName   = "testchannel"	// 连接的通道
    chaincodeName = "basic"			// 连接的链码
)

func main() {
    clientConnection := newGrpcConnection()
    defer clientConnection.Close()

    id := newIdentity()
    sign := newSign()

    gateway, err := client.Connect(
        id,
        client.WithSign(sign),
        client.WithClientConnection(clientConnection),
        client.WithEvaluateTimeout(5*time.Second),
        client.WithEndorseTimeout(15*time.Second),
        client.WithSubmitTimeout(5*time.Second),
        client.WithCommitStatusTimeout(1*time.Minute),
    )
    if err != nil {
        panic(err)
    }
    defer gateway.Close()

    network := gateway.GetNetwork(channelName)
    contract := network.GetContract(chaincodeName)

    fmt.Println("getAllAssets:")
    getAllAssets(contract)
}
func getAllAssets(contract *client.Contract) {
    fmt.Println("Evaluate Transaction: GetAllAssets, function returns all the current assets on the ledger")

    evaluateResult, err := contract.EvaluateTransaction("GetAllProjects")
    if err != nil {
        panic(fmt.Errorf("failed to evaluate transaction: %w", err))
    }
    result := formatJSON(evaluateResult)

    fmt.Printf("*** Result:%sn", result)
}

func formatJSON(data []byte) string {
    var prettyJSON bytes.Buffer
    if err := json.Indent(&amp;prettyJSON, data, " ", ""); err != nil {
        panic(fmt.Errorf("failed to parse JSON: %w", err))
    }
    return prettyJSON.String()
}
</code></pre> </li>
</ol> 
<h3>
<a id="_725"></a>客户端演示</h3> 
<p>如无特殊说明，以下命令默认运行于实验根目录 <code>contract-gateway</code> 下：</p> 
<ol>
<li>初始化模块<pre><code class="prism language-bash">go mod init github.com/wefantasy/FabricLearn/6_ContractGatewayAndSDK/contract-gateway
</code></pre> </li>
<li>下载依赖<pre><code class="prism language-bash">go get
</code></pre> 此时实验目录结构为</li>
<li>运行客户端<pre><code class="prism language-bash">go run <span class="token builtin class-name">.</span>
</code></pre> 因为本目录下同时有两个 <code>package</code> 为 <code>main</code> 的 go 文件，所以要用 . 的方式运行，运行结果如下：<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-I7NdXRB5-1654947331597)(https://cdn.jsdelivr.net/gh/wefantasy/FileCloud/img/hyperledger_fabric_9_contract_and_sdk_application_example-2022-06-11-14-44-26.png “运行gateway客户端”)]</li>
</ol> 
<h2>
<a id="fabricsdkgo__743"></a>fabric-sdk-go 客户端示例</h2> 
<p>刚接触 Fabric 你可能会很疑惑，有些案例使用 fabric-gateway 连接联盟链、另一些案例通过 fabric-sdk-* 连接联盟链，并且似乎都可以操纵网络，那么有什么区别呢？ fabric-sdk-* 被定义为 Fabric 的低级 SDK ，主要为开发者提供账本管理、通道管理、用户管理等联盟链管理的 API ，它的开发成本更高但功能丰富；而 fabric-gateway 被定义为 Fabric 的高级 SDK ，这里的高级主要体现在其抽象程度更高，主要为开发者提供账本管理的 API ，它的开发成本更低但功能较少。因此建议优先学习 fabric-sdk-* 的使用。</p> 
<h3>
<a id="_745"></a>连接配置文件</h3> 
<p>就像刚才说的， fabric-sdk-* 开发成本比较高，我觉得高出来的开发成本有一半都在<em>连接配置文件</em>的配置上，它让我花费了至少半天的时间来排错，而网上几乎没有能把连接配置文件讲清楚的文章（也许是我没有找到），只能通过官方示例代码慢慢推导出正确的配置方法。<br> 从 fabric-sdk-* 官方示例 <a href="https://github.com/hyperledger/fabric-samples/blob/main/asset-transfer-basic/application-go/assetTransfer.go">assetTransfer.go</a> 中引用的 <code>connection-org1.yaml</code> 连接配置文件出发，可以定位到生成它的相关文件为 <a href="https://github.com/hyperledger/fabric-samples/blob/main/test-network/organizations/ccp-generate.sh">ccp-generate.sh</a> 和 <a href="https://github.com/hyperledger/fabric-samples/blob/main/test-network/organizations/ccp-template.yaml">ccp-template.yaml</a> ，后者为连接配置文件的基准模板，前者使用 bash 命令将基准模板替换为具体连接配置文件。连接配置文件有 json 和 yaml 两种格式，我觉得 yaml 语法更为简洁，后续实验以此为例。将 <code>ccp-generate.sh</code> 文件中的函数展开后，可以很容易的得生成连接配置文件的过程，本节所有命令默认运行于 <code>6_ContractGatewayAndSDK</code> 目录下，通过如下命令生成 soft 组织的连接配置文件：</p> 
<ol>
<li>创建模板文件<br> 将官方模板 <a href="https://github.com/hyperledger/fabric-samples/blob/main/test-network/organizations/ccp-template.yaml">ccp-template.yaml</a> 复制一份至我们项目的 <code>6_ContractGatewayAndSDK/config/ccp-template.yaml </code>中，由于我们的命名规范与官方不同，且该模板通用性不高，因此将其内容改为如下：<pre><code class="prism language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>network<span class="token punctuation">-</span>$<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0
<span class="token key atrule">client</span><span class="token punctuation">:</span>
<span class="token key atrule">organization</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>
<span class="token key atrule">connection</span><span class="token punctuation">:</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
    <span class="token key atrule">peer</span><span class="token punctuation">:</span>
        <span class="token key atrule">endorser</span><span class="token punctuation">:</span> <span class="token string">'300'</span>
<span class="token key atrule">organizations</span><span class="token punctuation">:</span>
$<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span><span class="token punctuation">:</span>
    <span class="token key atrule">mspid</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>MSP
    <span class="token key atrule">peers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> peer1.$<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>.ifantasy.net
    <span class="token key atrule">certificateAuthorities</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> $<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>.ifantasy.net
<span class="token key atrule">peers</span><span class="token punctuation">:</span>
peer1.$<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>.ifantasy.net<span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> grpcs<span class="token punctuation">:</span>//peer1.$<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>.ifantasy.net<span class="token punctuation">:</span>$<span class="token punctuation">{<!-- --></span>P0PORT<span class="token punctuation">}</span>
    <span class="token key atrule">tlsCACerts</span><span class="token punctuation">:</span>
    <span class="token key atrule">pem</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        ${PEERPEM}</span>
    <span class="token key atrule">grpcOptions</span><span class="token punctuation">:</span>
    <span class="token key atrule">ssl-target-name-override</span><span class="token punctuation">:</span> peer1.$<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>.ifantasy.net
    <span class="token key atrule">hostnameOverride</span><span class="token punctuation">:</span> peer1.$<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>.ifantasy.net
<span class="token key atrule">certificateAuthorities</span><span class="token punctuation">:</span>
$<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>.ifantasy.net<span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>.ifantasy.net<span class="token punctuation">:</span>$<span class="token punctuation">{<!-- --></span>CAPORT<span class="token punctuation">}</span>
    <span class="token key atrule">caName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>ORG<span class="token punctuation">}</span>.ifantasy.net
    <span class="token key atrule">tlsCACerts</span><span class="token punctuation">:</span>
    <span class="token key atrule">pem</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
        ${CAPEM}</span>
    <span class="token key atrule">httpOptions</span><span class="token punctuation">:</span>
    <span class="token key atrule">verify</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> 
  <blockquote> 
   <p>这个模板可以跟我们项目很好的契合，需要特别注意的是其中组织名和组织ID必须与 <code>configtx.yaml</code> 文件中相匹配，这是前面修改 <code>configtx.yaml</code> 的原因，不然很容易出错，其中各个参数的含义可以对照下面的模板参数理解。</p> 
  </blockquote> </li>
<li>设置模板参数<pre><code class="prism language-bash"><span class="token assign-left variable">ORG</span><span class="token operator">=</span>soft
<span class="token assign-left variable">P0PORT</span><span class="token operator">=</span><span class="token number">7251</span>
<span class="token assign-left variable">CAPORT</span><span class="token operator">=</span><span class="token number">7250</span>
<span class="token assign-left variable">cryptoPath</span><span class="token operator">=</span><span class="token variable">$LOCAL_CA_PATH</span>/soft.ifantasy.net
<span class="token assign-left variable">PEERPEM</span><span class="token operator">=</span><span class="token variable">$cryptoPath</span>/assets/tls-ca-cert.pem
<span class="token assign-left variable">CAPEM</span><span class="token operator">=</span><span class="token variable">$cryptoPath</span>/assets/ca-cert.pem
</code></pre> </li>
<li>获取 tls 证书和 ca 证书<pre><code class="prism language-bash"><span class="token assign-left variable">PP</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">`</span><span class="token function">awk</span> <span class="token string">'NF {sub(/\n/, ""); printf "%s\\\n",$0;}'</span> $PEERPEM<span class="token variable">`</span></span>"</span>
<span class="token assign-left variable">CP</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">`</span><span class="token function">awk</span> <span class="token string">'NF {sub(/\n/, ""); printf "%s\\\n",$0;}'</span> $CAPEM<span class="token variable">`</span></span>"</span>
</code></pre> </li>
<li>生成模板文件<pre><code class="prism language-bash"><span class="token function">sed</span> -e <span class="token string">"s/<span class="token variable">${ORG}</span>/<span class="token variable">$ORG</span>/"</span> <span class="token punctuation"></span>
        -e <span class="token string">"s/<span class="token variable">${P0PORT}</span>/<span class="token variable">$P0PORT</span>/"</span> <span class="token punctuation"></span>
        -e <span class="token string">"s/<span class="token variable">${CAPORT}</span>/<span class="token variable">$CAPORT</span>/"</span> <span class="token punctuation"></span>
        -e <span class="token string">"s#<span class="token variable">${PEERPEM}</span>#<span class="token variable">$PP</span>#"</span> <span class="token punctuation"></span>
        -e <span class="token string">"s#<span class="token variable">${CAPEM}</span>#<span class="token variable">$CP</span>#"</span> <span class="token punctuation"></span>
        config/ccp-template.yaml <span class="token operator">|</span> <span class="token function">sed</span> -e <span class="token string">$'s/<span class="token entity" title="">\</span><span class="token entity" title="">\</span>n/<span class="token entity" title="">\</span><span class="token entity" title="n">n</span>          /g'</span>  <span class="token operator">&gt;</span> connection-soft.yaml
</code></pre> </li>
</ol> 
<p>依次执行上述命令，最后会将连接配置文件 <code>connection-soft.yaml</code> 输出到实验根目录中，本例中其内容如下：</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>network<span class="token punctuation">-</span>soft
<span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0
<span class="token key atrule">client</span><span class="token punctuation">:</span>
  <span class="token key atrule">organization</span><span class="token punctuation">:</span> soft
  <span class="token key atrule">connection</span><span class="token punctuation">:</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
      <span class="token key atrule">peer</span><span class="token punctuation">:</span>
        <span class="token key atrule">endorser</span><span class="token punctuation">:</span> <span class="token string">'300'</span>
<span class="token key atrule">organizations</span><span class="token punctuation">:</span>
  <span class="token key atrule">soft</span><span class="token punctuation">:</span>
    <span class="token key atrule">mspid</span><span class="token punctuation">:</span> softMSP
    <span class="token key atrule">peers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> peer1.soft.ifantasy.net
    <span class="token key atrule">certificateAuthorities</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> soft.ifantasy.net
<span class="token key atrule">peers</span><span class="token punctuation">:</span>
  <span class="token key atrule">peer1.soft.ifantasy.net</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> grpcs<span class="token punctuation">:</span>//peer1.soft.ifantasy.net<span class="token punctuation">:</span><span class="token number">7251</span>
    <span class="token key atrule">tlsCACerts</span><span class="token punctuation">:</span>
      <span class="token key atrule">pem</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          -----BEGIN CERTIFICATE-----
          MIICHzCCAcWgAwIBAgIUbO4XSCy2KbQQN/E63zvkhUJfMzwwCgYIKoZIzj0EAwIw
          bDELMAkGA1UEBhMCVVMxFzAVBgNVBAgTDk5vcnRoIENhcm9saW5hMRQwEgYDVQQK
          EwtIeXBlcmxlZGdlcjEPMA0GA1UECxMGRmFicmljMR0wGwYDVQQDExRjb3VuY2ls
          LmlmYW50YXN5Lm5ldDAeFw0yMjA2MTEwNTU3MDBaFw0zNzA2MDcwNTU3MDBaMGwx
          CzAJBgNVBAYTAlVTMRcwFQYDVQQIEw5Ob3J0aCBDYXJvbGluYTEUMBIGA1UEChML
          SHlwZXJsZWRnZXIxDzANBgNVBAsTBkZhYnJpYzEdMBsGA1UEAxMUY291bmNpbC5p
          ZmFudGFzeS5uZXQwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAAQecDRTwml7bcaD
          nZdPiEYiTxFwHa+g2nw+mq+6KeMPW98WT3BPNErb1gw9BQa6GRcTypJ7Ga1lSqLS
          IFD+aypYo0UwQzAOBgNVHQ8BAf8EBAMCAQYwEgYDVR0TAQH/BAgwBgEB/wIBATAd
          BgNVHQ4EFgQUq3Q80AlYM9lGKHWVupCEjpyBb1kwCgYIKoZIzj0EAwIDSAAwRQIh
          AJashZ+Sob7DoOpYII22wDOPSV8updo1W9LNEAaxzMyTAiAokfgCVjtlX3EJnV+m
          qc5EBQCjA0AaX1HPNBTUII7T+Q==
          -----END CERTIFICATE-----</span>
          
    <span class="token key atrule">grpcOptions</span><span class="token punctuation">:</span>
      <span class="token key atrule">ssl-target-name-override</span><span class="token punctuation">:</span> peer1.soft.ifantasy.net
      <span class="token key atrule">hostnameOverride</span><span class="token punctuation">:</span> peer1.soft.ifantasy.net
<span class="token key atrule">certificateAuthorities</span><span class="token punctuation">:</span>
  <span class="token key atrule">soft.ifantasy.net</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//soft.ifantasy.net<span class="token punctuation">:</span><span class="token number">7250</span>
    <span class="token key atrule">caName</span><span class="token punctuation">:</span> soft.ifantasy.net
    <span class="token key atrule">tlsCACerts</span><span class="token punctuation">:</span>
      <span class="token key atrule">pem</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
          -----BEGIN CERTIFICATE-----
          MIICGDCCAb+gAwIBAgIUXF3f1cgHiAMO03c/61iyFWAD/0AwCgYIKoZIzj0EAwIw
          aTELMAkGA1UEBhMCVVMxFzAVBgNVBAgTDk5vcnRoIENhcm9saW5hMRQwEgYDVQQK
          EwtIeXBlcmxlZGdlcjEPMA0GA1UECxMGRmFicmljMRowGAYDVQQDExFzb2Z0Lmlm
          YW50YXN5Lm5ldDAeFw0yMjA2MTEwNTU3MDBaFw0zNzA2MDcwNTU3MDBaMGkxCzAJ
          BgNVBAYTAlVTMRcwFQYDVQQIEw5Ob3J0aCBDYXJvbGluYTEUMBIGA1UEChMLSHlw
          ZXJsZWRnZXIxDzANBgNVBAsTBkZhYnJpYzEaMBgGA1UEAxMRc29mdC5pZmFudGFz
          eS5uZXQwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAASP0Vs5wUaRzIyiXx2ygH6A
          IQyCLe6VhTxnNPmJhMUVOmO+iyLJqMUuQRRHIcCgiNGPR9cqd4ygcRJBvsG+sooY
          o0UwQzAOBgNVHQ8BAf8EBAMCAQYwEgYDVR0TAQH/BAgwBgEB/wIBATAdBgNVHQ4E
          FgQUkPhZPSjyHVdL5NkQED1Rdif7GdowCgYIKoZIzj0EAwIDRwAwRAIgfOt69wD8
          HEqroGm/zVFf/NiqivluaK5Yf3Ryn0C7p5ECID/KNGjbt5b53ivuL5slK5B+8eA2
          KGUN7ysBzX8hTzPj
          -----END CERTIFICATE-----</span>
          
    <span class="token key atrule">httpOptions</span><span class="token punctuation">:</span>
      <span class="token key atrule">verify</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> 
<p>上述操作已打包至 <code>5_GenConnectYaml.sh</code> 中，也可以直接在根目录下运行 <code>5_GenConnectYaml.sh</code> 来了生成连接配置文件。</p> 
<h3>
<a id="_879"></a>客户端代码</h3> 
<ol>
<li>初始化目录/文件<br> 在实验根目录 <code>6_ContractGatewayAndSDK</code> 下创建目录 <code>contract-sdk</code> 作为 fabric-sdk 客户端的根目录，并在其下创建主程序 <code>app.go</code> 。将上节生成的 <code>connection-soft.yaml</code> 复制到该目录下，最终目录结构为：<pre><code class="prism language-bash"> contract-sdk
 ├── app.go
 ├── connection-soft.yaml
 ├── go.mod
 ├── go.sum
 ├── keystore
 └── wallet
     └── appUser.id
</code></pre> </li>
<li>向 app.go 写入以下内容<pre><code class="prism language-Go"> package main

 import (
     "fmt"
     "io/ioutil"
     "log"
     "os"
     "path/filepath"

     "github.com/hyperledger/fabric-sdk-go/pkg/core/config"
     "github.com/hyperledger/fabric-sdk-go/pkg/gateway"
 )

 func main() {
     log.Println("============ application-golang starts ============")

     err := os.Setenv("DISCOVERY_AS_LOCALHOST", "true")
     if err != nil {
         log.Fatalf("Error setting DISCOVERY_AS_LOCALHOST environemnt variable: %v", err)
     }

     wallet, err := gateway.NewFileSystemWallet("wallet")
     if err != nil {
         log.Fatalf("Failed to create wallet: %v", err)
     }

     err = populateWallet(wallet)
     // 调试建议注释这里
     // if !wallet.Exists("appUser") {
     // 	err = populateWallet(wallet)
     // 	if err != nil {
     // 		log.Fatalf("Failed to populate wallet contents: %v", err)
     // 	}
     // }

     ccpPath := filepath.Join(
         "connection-soft.yaml",
     )

     gw, err := gateway.Connect(
         gateway.WithConfig(config.FromFile(filepath.Clean(ccpPath))),
         gateway.WithIdentity(wallet, "appUser"),
     )
     if err != nil {
         log.Fatalf("Failed to connect to gateway: %v", err)
     }
     defer gw.Close()
     
     network, err := gw.GetNetwork("testchannel")
     if err != nil {
         log.Fatalf("Failed to get network: %v", err)
     }
     
     contract := network.GetContract("basic")

     log.Println("--&gt; Evaluate Transaction: GetAllAssets, function returns all the current assets on the ledger")
     result, err := contract.EvaluateTransaction("GetAllProjects")
     if err != nil {
         log.Fatalf("Failed to evaluate transaction: %v", err)
     }
     log.Println(string(result))

     log.Println("--&gt; Submit Transaction: DeleteProject, delete new project info with ID arguments")
     result, err = contract.SubmitTransaction("DeleteProject", "FA8B31A55CD59DB352BCBF4D2AE791AD")
     if err != nil {
         log.Fatalf("Failed to Submit transaction: %v", err)
     }
     log.Println(string(result))
 }

 func populateWallet(wallet *gateway.Wallet) error {
     log.Println("============ Populating wallet ============")
     credPath := filepath.Join(
         "..",
         "orgs",
         "soft.ifantasy.net",
         "registers",
         "user1",
         "msp",
     )

     certPath := filepath.Join(credPath, "signcerts", "cert.pem")
     // read the certificate pem
     cert, err := ioutil.ReadFile(filepath.Clean(certPath))
     if err != nil {
         return err
     }

     keyDir := filepath.Join(credPath, "keystore")
     // there's a single file in this dir containing the private key
     files, err := ioutil.ReadDir(keyDir)
     if err != nil {
         return err
     }
     if len(files) != 1 {
         return fmt.Errorf("keystore folder should have contain one file")
     }
     keyPath := filepath.Join(keyDir, files[0].Name())
     key, err := ioutil.ReadFile(filepath.Clean(keyPath))
     if err != nil {
         return err
     }

     identity := gateway.NewX509Identity("softMSP", string(cert), string(key))

     return wallet.Put("appUser", identity)
 }
</code></pre> </li>
</ol> 
<h3>
<a id="_1004"></a>客户端演示</h3> 
<p>如无特殊说明，以下命令默认运行于实验根目录 <code>contract-sdk</code> 下：</p> 
<ol>
<li>初始化模块<pre><code class="prism language-bash">go mod init github.com/wefantasy/FabricLearn/6_ContractGatewayAndSDK/contract-gateway
</code></pre> </li>
<li>下载依赖<pre><code class="prism language-bash">go get
</code></pre> </li>
<li>运行客户端<pre><code class="prism language-bash">go run <span class="token builtin class-name">.</span>
</code></pre> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-AZKjNmKr-1654947331597)(https://cdn.jsdelivr.net/gh/wefantasy/FileCloud/img/hyperledger_fabric_9_contract_and_sdk_application_example-2022-06-11-15-44-08.png “运行SDK客户端”)]</li>
</ol> 
<h3>
<a id="QA_1020"></a>Q&amp;A</h3> 
<p>遇到错误：</p> 
<pre><code class="prism language-bash">QueryBlockConfig failed: no channel peers configured <span class="token keyword">for</span> channel <span class="token punctuation">[</span>testchannel<span class="token punctuation">]</span>
</code></pre> 
<p>解决方法： 大概率是连接配置文件组织名称啥的写错了，再次检查组织配置文件与configtx.yaml中声明的是否匹配。</p> 
<p>遇到错误：</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>/06/10 <span class="token number">15</span>:55:44 Failed to get network: Failed to create new channel client: event <span class="token function">service</span> creation failed: could not get chConfig cache reference: QueryBlockConfig failed: QueryBlockConfig failed: target<span class="token punctuation">(</span>s<span class="token punctuation">)</span> required
</code></pre> 
<p>解决方法： 可能是因为 wallet 目录下的身份与所申明的身份不匹配，建议每次启动前删除 wallet 目录让它重新生成。</p> 
<p>遇到错误：</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>/06/10 <span class="token number">16</span>:08:13 Failed to Submit transaction: Failed to submit: error getting channel response <span class="token keyword">for</span> channel <span class="token punctuation">[</span>testchannel<span class="token punctuation">]</span>: no successful response received from any peer: access denied
</code></pre> 
<p>解决方法： 此时检查对应的 peer 节点容器日志若有 implicit policy evaluation failed 错误，则说明当前使用的身份权限不足。在实验中使用 peer 类型的用户身份则会导致此问题，建议使用 client 身份的用户（admin 身份也行）。</p> 
<p>遇到错误：</p> 
<pre><code class="prism language-bash"><span class="token number">2022</span>/06/10 <span class="token number">16</span>:08:13 Failed to Submit transaction: Failed to submit: error getting channel response <span class="token keyword">for</span> channel <span class="token punctuation">[</span>testchannel<span class="token punctuation">]</span>: no successful response received from any peer: access denied
</code></pre> 
<p>解决方法： 此时检查对应的 peer 节点容器日志若有 implicit policy evaluation failed 错误，则说明当前使用的身份权限不足。在实验中使用 peer 类型的用户身份则会导致此问题，建议使用 client 身份的用户（admin 身份也行）。</p> 
<h2>
<a id="_1045"></a>参考</h2> 
 
<p>[1]: hyperledger-fabric. <a href="https://hyperledger-fabric.readthedocs.io/en/latest/sdk_chaincode.html">Fabric Contract APIs and Application APIs</a>. readthedocs.io. [-]<br> [2]: barney2k7. <a href="https://stackoverflow.com/questions/60900762/what-is-the-difference-between-fabric-chaincode-go-and-fabric-contract-api-go">What is the difference between fabric-chaincode-go and fabric-contract-api-go?</a>. stackoverflow.com. [2020-05-08]<br> [3]: Nikos Karamolegkos. <a href="https://lists.hyperledger.org/g/fabric/topic/87538164">fabric-sdk-go vs fabric-gateway. When to use each one?</a>. hyperledger.org. [2021-12-07]<br> [4]: kid1999 Karamolegkos. <a href="https://kid1999.github.io/2021/06/26/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6Go%E5%BC%80%E5%8F%91%E5%8C%85%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3/">Fabric智能合约Go开发包简单理解</a>. github.io. [2021-06-26]</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>