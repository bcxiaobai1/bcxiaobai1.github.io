<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>【云原生】第十篇--Docker主机集群化方案 Docker Swarm - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【云原生】第十篇--Docker主机集群化方案 Docker Swarm</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <p></p>
<div class="toc">
 <h3>Docker主机集群化方案 Docker Swarm</h3>
 <ul>
<li><a href="#docker_swarm_1">一、docker swarm介绍</a></li>
<li><a href="#docker_swarm_16">二、docker swarm概念与架构</a></li>
<li>
<ul>
<li><a href="#21__20">2.1 架构</a></li>
<li><a href="#22__23">2.2 概念</a></li>
</ul>
  </li>
<li><a href="#docker_swarm_42">三、docker swarm集群部署</a></li>
<li>
<ul>
<li><a href="#31__Harbor_44">3.1 容器镜像仓库 Harbor准备</a></li>
<li><a href="#32__46">3.2 主机准备</a></li>
<li>
<ul>
<li><a href="#321__47">3.2.1 主机名</a></li>
<li><a href="#322_IP_61">3.2.2 IP地址</a></li>
<li><a href="#323_IP_99">3.2.3 主机名与IP地址解析</a></li>
<li><a href="#334__113">3.3.4 主机时间同步</a></li>
<li><a href="#325__125">3.2.5 主机安全设置</a></li>
</ul>
   </li>
<li><a href="#33_docker_145">3.3 docker安装</a></li>
<li>
<ul>
<li><a href="#331_docker_146">3.3.1 docker安装</a></li>
<li><a href="#332_docker_daemonharbor_162">3.3.2 配置docker daemon使用harbor</a></li>
</ul>
   </li>
<li><a href="#34_docker_swarm_189">3.4 docker swarm集群初始化</a></li>
<li>
<ul>
<li><a href="#341_docker_swarm_190">3.4.1 获取docker swarm命令帮助</a></li>
<li><a href="#342__210">3.4.2 在管理节点初始化</a></li>
<li><a href="#343__230">3.4.3 添加工作节点到集群</a></li>
<li><a href="#344__270">3.4.4 添加管理节点到集群</a></li>
<li><a href="#345__302">3.4.5 模拟管理节点出现故障</a></li>
<li>
<ul>
<li><a href="#3451_docker_303">3.4.5.1 停止docker服务并查看结果</a></li>
<li><a href="#3452_docker_320">3.4.5.2 启动docker服务并查看结果</a></li>
</ul>
   </li>
</ul>
  </li>
</ul>
  </li>
<li><a href="#docker_swarm_337">四、docker swarm集群应用</a></li>
<li>
<ul>
<li><a href="#41__338">4.1 容器镜像准备</a></li>
<li>
<ul>
<li><a href="#411_v1_340">4.1.1 v1版本</a></li>
<li><a href="#412_v2_382">4.1.2 v2版本</a></li>
</ul>
   </li>
<li><a href="#42__418">4.2 发布服务</a></li>
<li>
<ul>
<li><a href="#421_docker_service_ls_423">4.2.1 使用`docker service ls`查看服务</a></li>
<li><a href="#422__431">4.2.2 发布服务</a></li>
<li><a href="#423__448">4.2.3 查看已发布服务</a></li>
<li><a href="#424__455">4.2.4 查看已发布服务容器</a></li>
<li><a href="#425__469">4.2.5 访问已发布的服务</a></li>
</ul>
   </li>
<li><a href="#43__485">4.3 服务扩展</a></li>
<li><a href="#44__546">4.4 服务裁减</a></li>
<li><a href="#45__569">4.5 负载均衡</a></li>
<li><a href="#46___602">4.6 删除服务</a></li>
<li><a href="#47__619">4.7 服务版本更新</a></li>
<li><a href="#48__646">4.8 服务版本回退</a></li>
<li><a href="#49__655">4.9 服务版本滚动间隔更新</a></li>
<li><a href="#410__687">4.10 副本控制器</a></li>
<li><a href="#411__730">4.11 在指定网络中发布服务</a></li>
<li><a href="#412__808">4.12 服务网络模式</a></li>
<li><a href="#413__920">4.13 服务数据持久化存储</a></li>
<li>
<ul>
<li><a href="#4131__921">4.13.1 本地存储</a></li>
<li>
<ul>
<li><a href="#41311__922">4.13.1.1 在集群所有主机上创建本地目录</a></li>
<li><a href="#41312__927">4.13.1.2 发布服务时挂载本地目录到容器中</a></li>
<li><a href="#41313__939">4.13.1.3 验证是否使用本地目录</a></li>
</ul>
    </li>
<li><a href="#4132__980">4.13.2 网络存储</a></li>
<li>
<ul>
<li><a href="#41321_NFS_984">4.13.2.1 部署NFS存储</a></li>
<li><a href="#41322_nfsutils_1016">4.13.2.2 为集群所有主机安装nfs-utils软件</a></li>
<li><a href="#41323__1027">4.13.2.3 创建存储卷</a></li>
<li><a href="#41324__1060">4.13.2.4 发布服务</a></li>
<li><a href="#41325__1071">4.13.2.5 验证</a></li>
</ul>
   </li>
</ul>
   </li>
<li><a href="#414__1116">4.14 服务互联与服务发现</a></li>
<li><a href="#415_docker_swarm_1267">4.15 docker swarm网络</a></li>
</ul>
  </li>
<li><a href="#docker_stack_1291">五、docker stack</a></li>
<li>
<ul>
<li><a href="#51_docker_stack_1292">5.1 docker stack介绍</a></li>
<li><a href="#52_docker_stackdocker_compose_1299">5.2 docker stack与docker compose区别</a></li>
<li><a href="#53_docker_stack_1306">5.3 docker stack常用命令</a></li>
<li><a href="#54_wordpress_1317">5.4 部署wordpress案例</a></li>
<li><a href="#55__nginxweb_1383">5.5 部署nginx与web管理服务案例</a></li>
<li><a href="#56_nginxhaproxynfs_1453">5.6 nginx+haproxy+nfs案例</a></li>
</ul>
 </li>
</ul>
</div>
<p></p> 
<h1>
<a id="docker_swarm_1"></a>一、docker swarm介绍</h1> 
<p>Docker Swarm是Docker官方提供的一款集群管理工具，其主要作用是把若干台Docker主机抽象为一个整体，并且通过一个入口统一管理这些Docker主机上的各种Docker资源。Swarm和Kubernetes比较类似，但是更加轻，具有的功能也较kubernetes更少一些。</p> 
<ul>
<li>是docker host集群管理工具</li>
<li>docker官方提供的</li>
<li>docker 1.12版本以后</li>
<li>用来统一集群管理的，把整个集群资源做统一调度</li>
<li>比kubernetes要轻量化</li>
<li>实现scaling 规模扩大或缩小</li>
<li>实现rolling update 滚动更新或版本回退</li>
<li>实现service discovery 服务发现</li>
<li>实现load balance 负载均衡</li>
<li>实现route mesh 路由网格，服务治理<br> <img src="https://images2.imgbox.com/e8/18/Di6IRVrh_o.png" alt="在这里插入图片描述">
</li>
</ul> 
<h1>
<a id="docker_swarm_16"></a>二、docker swarm概念与架构</h1> 
<blockquote> 
 <p>参考网址：<a href="https://docs.docker.com/swarm/overview/">https://docs.docker.com/swarm/overview/</a></p> 
</blockquote> 
<h2>
<a id="21__20"></a>2.1 架构</h2> 
<p><img src="https://images2.imgbox.com/e7/a6/WhC7zgyn_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/07/b2/Dl81ZR15_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="22__23"></a>2.2 概念</h2> 
<p><strong>节点 (node):</strong> 就是一台docker host上面运行了docker engine.节点分为两类:</p> 
<ul>
<li>管理节点(manager node) 负责管理集群中的节点并向工作节点分配任务</li>
<li>工作节点(worker node) 接收管理节点分配的任务，运行任务</li>
</ul> 
<pre><code class="prism language-powershell"><span class="token comment"># docker node ls</span>
</code></pre> 
<p><strong>服务(services):</strong> 在工作节点运行的，由多个任务共同组成</p> 
<pre><code class="prism language-powershell"><span class="token comment"># docker service ls</span>
</code></pre> 
<p><strong>任务(task):</strong> 运行在工作节点上容器或容器中包含应用，是集群中调度最小管理单元<br> <img src="https://images2.imgbox.com/1b/ab/HAt22RTj_o.png" alt="在这里插入图片描述"></p> 
<h1>
<a id="docker_swarm_42"></a>三、docker swarm集群部署</h1> 
<blockquote> 
 <p>部署3主2从节点集群，另需提前准备1台本地容器镜像仓库服务器(Harbor)</p> 
</blockquote> 
<h2>
<a id="31__Harbor_44"></a>3.1 容器镜像仓库 Harbor准备</h2> 
<p><img src="https://images2.imgbox.com/bf/f4/Enq8YbTH_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="32__46"></a>3.2 主机准备</h2> 
<h3>
<a id="321__47"></a>3.2.1 主机名</h3> 
<pre><code class="prism language-powershell"><span class="token comment"># hostnamectl set-hostname xxx</span>
</code></pre> 
<pre><code class="prism language-powershell">说明：
sm1 管理节点1
sm2 管理节点2
sm3 管理节点3
sw1 工作节点1
sw2 工作节点2
</code></pre> 
<h3>
<a id="322_IP_61"></a>3.2.2 IP地址</h3> 
<pre><code class="prism language-powershell">编辑网卡配置文件
<span class="token comment"># vim /etc/sysconfig/network-scripts/ifcfg-ens33</span>
<span class="token comment"># cat /etc/sysconfig/network-scripts/ifcfg-ens33</span>
<span class="token function">TYPE</span>=<span class="token string">"Ethernet"</span>
PROXY_METHOD=<span class="token string">"none"</span>
BROWSER_ONLY=<span class="token string">"no"</span>
BOOTPROTO=<span class="token string">"none"</span> 修改为静态
DEFROUTE=<span class="token string">"yes"</span>
IPV4_FAILURE_FATAL=<span class="token string">"no"</span>
IPV6INIT=<span class="token string">"yes"</span>
IPV6_AUTOCONF=<span class="token string">"yes"</span>
IPV6_DEFROUTE=<span class="token string">"yes"</span>
IPV6_FAILURE_FATAL=<span class="token string">"no"</span>
IPV6_ADDR_GEN_MODE=<span class="token string">"stable-privacy"</span>
NAME=<span class="token string">"ens33"</span>

DEVICE=<span class="token string">"ens33"</span>
ONBOOT=<span class="token string">"yes"</span>

添加如下内容：
IPADDR=<span class="token string">"192.168.10.xxx"</span>
PREFIX=<span class="token string">"24"</span>
GATEWAY=<span class="token string">"192.168.10.2"</span>
DNS1=<span class="token string">"119.29.29.29"</span>

</code></pre> 
<pre><code class="prism language-powershell">说明：
sm1 管理节点1 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10
sm2 管理节点2 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11
sm3 管理节点3 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
sw1 工作节点1 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13
sw2 工作节点2 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14
</code></pre> 
<h3>
<a id="323_IP_99"></a>3.2.3 主机名与IP地址解析</h3> 
<pre><code class="prism language-powershell">编辑主机<span class="token operator">/</span>etc/hosts文件，添加主机名解析
<span class="token comment"># vim /etc/hosts</span>
<span class="token comment"># cat /etc/hosts</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1   localhost localhost<span class="token punctuation">.</span>localdomain localhost4 localhost4<span class="token punctuation">.</span>localdomain4
::1         localhost localhost<span class="token punctuation">.</span>localdomain localhost6 localhost6<span class="token punctuation">.</span>localdomain6
192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10 sm1
192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11 sm2
192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12 sm3
192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13 sw1
192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14 sw2
</code></pre> 
<h3>
<a id="334__113"></a>3.3.4 主机时间同步</h3> 
<pre><code class="prism language-powershell">添加计划任务，实现时间同步，同步服务器为time1<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com
<span class="token comment"># crontab -e</span>
no crontab <span class="token keyword">for</span> root <span class="token operator">-</span> <span class="token keyword">using</span> an empty one
crontab: installing new crontab

查看添加后计划任务
<span class="token comment"># crontab -l</span>
0 <span class="token operator">*</span><span class="token operator">/</span>1 <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> ntpdate time1<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com
</code></pre> 
<h3>
<a id="325__125"></a>3.2.5 主机安全设置</h3> 
<pre><code class="prism language-powershell">关闭防火墙并查看其运行状态
<span class="token comment"># systemctl stop firewalld;systemctl disable firewalld</span>
<span class="token comment"># firewall-cmd --state</span>
not running
</code></pre> 
<pre><code class="prism language-powershell">使用非交互式修改selinux配置文件
<span class="token comment"># sed -ri 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config</span>

重启所有的主机系统
<span class="token comment"># reboot</span>

重启后验证selinux是否关闭
<span class="token comment"># sestatus</span>
SELinux status:                 disabled
</code></pre> 
<h2>
<a id="33_docker_145"></a>3.3 docker安装</h2> 
<h3>
<a id="331_docker_146"></a>3.3.1 docker安装</h3> 
<pre><code class="prism language-powershell">下载YUM源
<span class="token comment"># wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
</code></pre> 
<pre><code class="prism language-powershell">安装docker-ce
<span class="token comment"># yum -y install docker-ce</span>
</code></pre> 
<pre><code class="prism language-powershell">启动docker服务并设置为开机自启动
<span class="token comment"># systemctl enable docker;systemctl start docker</span>
</code></pre> 
<h3>
<a id="332_docker_daemonharbor_162"></a>3.3.2 配置docker daemon使用harbor</h3> 
<pre><code class="prism language-powershell">添加daemon<span class="token punctuation">.</span>json文件，配置docker daemon使用harbor
<span class="token comment"># vim /etc/docker/daemon.json</span>
<span class="token comment"># cat /etc/docker/daemon.json</span>
<span class="token punctuation">{<!-- --></span>
        <span class="token string">"insecure-registries"</span>: <span class="token punctuation">[</span><span class="token string">"http://192.168.10.15"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">重启docker服务
<span class="token comment"># ystemctl restart docker</span>
</code></pre> 
<pre><code class="prism language-powershell">深度登录harbor
<span class="token comment"># docker login 192.168.10.15</span>
Username: admin
Password: 12345
WARNING! Your password will be stored unencrypted in <span class="token operator">/</span>root/<span class="token punctuation">.</span>docker/config<span class="token punctuation">.</span>json<span class="token punctuation">.</span>
Configure a credential helper to remove this warning<span class="token punctuation">.</span> See
https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com/engine/reference/commandline/login/<span class="token comment">#credentials-store</span>

Login Succeeded
</code></pre> 
<h2>
<a id="34_docker_swarm_189"></a>3.4 docker swarm集群初始化</h2> 
<h3>
<a id="341_docker_swarm_190"></a>3.4.1 获取docker swarm命令帮助</h3> 
<pre><code class="prism language-powershell">获取docker swarm命令使用帮助
<span class="token comment"># docker swarm --help</span>

Usage:  docker swarm COMMAND

Manage Swarm

Commands:
  ca          Display and rotate the root CA
  init        Initialize a swarm                    初始化
  join        Join a swarm as a node and/or manager 加入集群
  <span class="token function">join-token</span>  Manage join tokens                    集群加入时token管理
  leave       Leave the swarm                       离开集群
  unlock      Unlock swarm
  <span class="token function">unlock-key</span>  Manage the unlock key
  update      Update the swarm                      更新集群
</code></pre> 
<h3>
<a id="342__210"></a>3.4.2 在管理节点初始化</h3> 
<blockquote> 
 <p>本次在sm1上初始化</p> 
</blockquote> 
<pre><code class="prism language-powershell">初始化集群
<span class="token comment"># docker swarm init --advertise-addr 192.168.10.10 --listen-addr 192.168.10.10:2377</span>
Swarm initialized: current node <span class="token punctuation">(</span>j42cwubrr70pwxdpmesn1cuo6<span class="token punctuation">)</span> is now a manager<span class="token punctuation">.</span>

To add a worker to this swarm<span class="token punctuation">,</span> run the following command:

    docker swarm join <span class="token operator">--</span>token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-6pddlyiq5f1i35w8d7q4bl1co 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10:2377

To add a manager to this swarm<span class="token punctuation">,</span> run <span class="token string">'docker swarm join-token manager'</span> and follow the instructions<span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">说明：
<span class="token operator">--</span>advertise-addr 当主机有多块网卡时使用其选择其中一块用于广播<span class="token punctuation">,</span>用于其它节点连接管理节点使用
<span class="token operator">--</span>listen-addr    监听地址，用于承载集群流量使用
</code></pre> 
<h3>
<a id="343__230"></a>3.4.3 添加工作节点到集群</h3> 
<pre><code class="prism language-powershell">使用初始化过程中生成的token加入集群
<span class="token namespace">[root@sw1 ~]</span><span class="token comment"># docker swarm join --token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-6pddlyiq5f1i35w8d7q4bl1co 192.168.10.10:2377</span>
This node joined a swarm as a worker<span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">查看已加入的集群
<span class="token comment"># docker node ls</span>
ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
j42cwubrr70pwxdpmesn1cuo6 <span class="token operator">*</span>   sm1        Ready     Active         Leader           20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
4yb34kuma6i9g5hf30vkxm9yc     sw1        Ready     Active                          20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
</code></pre> 
<blockquote> 
 <p>如果使用的token已过期，可以再次生成新的加入集群的方法，如下命令所示。</p> 
</blockquote> 
<pre><code class="prism language-powershell">重新生成用于添加工作点的token
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker swarm join-token worker</span>
To add a worker to this swarm<span class="token punctuation">,</span> run the following command:

    docker swarm join <span class="token operator">--</span>token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-6pddlyiq5f1i35w8d7q4bl1co 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10:2377
</code></pre> 
<pre><code class="prism language-powershell">加入至集群
<span class="token namespace">[root@sw2 ~]</span><span class="token comment"># docker swarm join --token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-6pddlyiq5f1i35w8d7q4bl1co 192.168.10.10:2377</span>
This node joined a swarm as a worker<span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">查看node状态
<span class="token comment"># docker node ls</span>
ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
j42cwubrr70pwxdpmesn1cuo6 <span class="token operator">*</span>   sm1        Ready     Active         Leader           20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
4yb34kuma6i9g5hf30vkxm9yc     sw1        Ready     Active                          20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
mekitdu1xbpcttgupwuoiwg91     sw2        Ready     Active                          20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
</code></pre> 
<h3>
<a id="344__270"></a>3.4.4 添加管理节点到集群</h3> 
<pre><code class="prism language-powershell">生成用于添加管理节点加入集群所使用的token
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker swarm join-token manager</span>
To add a manager to this swarm<span class="token punctuation">,</span> run the following command:

    docker swarm join <span class="token operator">--</span>token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-7g85apo82mwz8ttmgdr7onfhu 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10:2377
</code></pre> 
<pre><code class="prism language-powershell">加入集群
<span class="token namespace">[root@sm2 ~]</span><span class="token comment"># docker swarm join --token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-7g85apo82mwz8ttmgdr7onfhu 192.168.10.10:2377</span>
This node joined a swarm as a manager<span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">加入集群
<span class="token namespace">[root@sm3 ~]</span><span class="token comment"># docker swarm join --token SWMTKN-1-297iry1n2jeh30oopsjecvsco1uuvl15t2jz6jxabdpf0xkry4-7g85apo82mwz8ttmgdr7onfhu 192.168.10.10:2377</span>
This node joined a swarm as a manager<span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">查看节点状态
<span class="token comment"># docker node ls</span>
ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
j42cwubrr70pwxdpmesn1cuo6 <span class="token operator">*</span>   sm1        Ready     Active         Leader           20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
nzpmehm8n87b9a17or2el10lc     sm2        Ready     Active         Reachable        20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
xc2x9z1b33rwdfxc5sdpobf0i     sm3        Ready     Active         Reachable        20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
4yb34kuma6i9g5hf30vkxm9yc     sw1        Ready     Active                          20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
mekitdu1xbpcttgupwuoiwg91     sw2        Ready     Active                          20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
</code></pre> 
<h3>
<a id="345__302"></a>3.4.5 模拟管理节点出现故障</h3> 
<h4>
<a id="3451_docker_303"></a>3.4.5.1 停止docker服务并查看结果</h4> 
<pre><code class="prism language-powershell">停止docker服务
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># systemctl stop docker</span>
</code></pre> 
<pre><code class="prism language-powershell">查看node状态，发现sm1不可达，状态为未知，并重启选择出leader
<span class="token namespace">[root@sm2 ~]</span><span class="token comment"># docker node ls</span>
ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
j42cwubrr70pwxdpmesn1cuo6     sm1        Unknown   Active         Unreachable      20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
nzpmehm8n87b9a17or2el10lc <span class="token operator">*</span>   sm2        Ready     Active         Leader           20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
xc2x9z1b33rwdfxc5sdpobf0i     sm3        Ready     Active         Reachable        20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
4yb34kuma6i9g5hf30vkxm9yc     sw1        Ready     Active                          20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
mekitdu1xbpcttgupwuoiwg91     sw2        Ready     Active                          20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
</code></pre> 
<h4>
<a id="3452_docker_320"></a>3.4.5.2 启动docker服务并查看结果</h4> 
<pre><code class="prism language-powershell">再次重动docker
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># systemctl start docker</span>
</code></pre> 
<pre><code class="prism language-powershell">观察可以得知sm1是可达状态，但并不是Leader
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker node ls</span>
ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
j42cwubrr70pwxdpmesn1cuo6 <span class="token operator">*</span>   sm1        Ready     Active         Reachable        20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
nzpmehm8n87b9a17or2el10lc     sm2        Ready     Active         Leader           20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
xc2x9z1b33rwdfxc5sdpobf0i     sm3        Ready     Active         Reachable        20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
4yb34kuma6i9g5hf30vkxm9yc     sw1        Ready     Active                          20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
mekitdu1xbpcttgupwuoiwg91     sw2        Ready     Active                          20<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12
</code></pre> 
<h1>
<a id="docker_swarm_337"></a>四、docker swarm集群应用</h1> 
<h2>
<a id="41__338"></a>4.1 容器镜像准备</h2> 
<blockquote> 
 <p>准备多个版本的容器镜像，以便于后期使用测试。</p> 
</blockquote> 
<h3>
<a id="411_v1_340"></a>4.1.1 v1版本</h3> 
<pre><code class="prism language-powershell">生成网站文件v1版
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># vim index.html</span>
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># cat index.html</span>
v1
</code></pre> 
<pre><code class="prism language-powershell">编写Dockerfile文件，用于构建容器镜像
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># vim Dockerfile</span>
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># cat Dockerfile</span>
<span class="token keyword">FROM</span> nginx:latest

MAINTAINER  <span class="token string">'tom&lt;tom@kubemsb.com&gt;'</span>

ADD index<span class="token punctuation">.</span>html <span class="token operator">/</span>usr/share/nginx/html

RUN <span class="token function">echo</span> <span class="token string">"daemon off;"</span> &gt;&gt; <span class="token operator">/</span>etc/nginx/nginx<span class="token punctuation">.</span>conf

EXPOSE 80

CMD <span class="token operator">/</span>usr/sbin/nginx
</code></pre> 
<pre><code class="prism language-powershell">使用docker build构建容器镜像
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># docker build -t 192.168.10.15/library/nginx:v1 .</span>
</code></pre> 
<pre><code class="prism language-powershell">登录harbor
<span class="token comment"># docker login 192.168.10.15</span>
Username: admin
Password: 12345
</code></pre> 
<pre><code class="prism language-powershell">推送容器镜像至harbor
<span class="token comment"># docker push 192.168.10.15/library/nginx:v1</span>
</code></pre> 
<h3>
<a id="412_v2_382"></a>4.1.2 v2版本</h3> 
<pre><code class="prism language-powershell">生成网站文件v2版
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># vim index.html</span>
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># cat index.html</span>
v2
</code></pre> 
<pre><code class="prism language-powershell">编写Dockerfile文件，用于构建容器镜像
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># vim Dockerfile</span>
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># cat Dockerfile</span>
<span class="token keyword">FROM</span> nginx:latest

MAINTAINER  <span class="token string">'tom&lt;tom@kubemsb.com&gt;'</span>

ADD index<span class="token punctuation">.</span>html <span class="token operator">/</span>usr/share/nginx/html

RUN <span class="token function">echo</span> <span class="token string">"daemon off;"</span> &gt;&gt; <span class="token operator">/</span>etc/nginx/nginx<span class="token punctuation">.</span>conf

EXPOSE 80

CMD <span class="token operator">/</span>usr/sbin/nginx
</code></pre> 
<pre><code class="prism language-powershell">使用docker build构建容器镜像
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># docker build -t 192.168.10.15/library/nginx:v2 .</span>
</code></pre> 
<pre><code class="prism language-powershell">推送镜像至Harbor
<span class="token namespace">[root@harbor nginximg]</span><span class="token comment"># docker push 192.168.10.15/library/nginx:v2</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/be/a3/i0zkfVDF_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="42__418"></a>4.2 发布服务</h2> 
<p>在docker swarm中,对外暴露的是服务（service)，而不是容器。</p> 
<p>为了保持高可用架构，它准许同时启动多个容器共同支撑一个服务，如果一个容器挂了，它会自动使用另一个容器</p> 
<h3>
<a id="421_docker_service_ls_423"></a>4.2.1 使用<code>docker service ls</code>查看服务</h3> 
<blockquote> 
 <p>在管理节点（manager node）上操作</p> 
</blockquote> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID        NAME      MODE      REPLICAS   IMAGE     PORTS
</code></pre> 
<h3>
<a id="422__431"></a>4.2.2 发布服务</h3> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service create --name nginx-svc-1 --replicas 1 --publish 80:80  192.168.10.15/library/nginx:v1</span>
ucif0ibkjqrd7meal6vqwnduz
overall progress: 1 out of 1 tasks
1/1: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<pre><code class="prism language-powershell">说明
<span class="token operator">*</span> 创建一个服务<span class="token punctuation">,</span>名为nginx_svc-1
<span class="token operator">*</span> replicas 1指定1个副本
<span class="token operator">*</span> <span class="token operator">--</span>publish 80:80  将服务内部的80端口发布到外部网络的80端口
<span class="token operator">*</span> 使用的镜像为`192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1`
</code></pre> 
<h3>
<a id="423__448"></a>4.2.3 查看已发布服务</h3> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID             NAME          MODE         REPLICAS   IMAGE                            PORTS
ucif0ibkjqrd   nginx-svc-1   replicated   1/1        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token operator">*</span>:80-&gt;80/tcp
</code></pre> 
<h3>
<a id="424__455"></a>4.2.4 查看已发布服务容器</h3> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps  nginx-svc-1</span>
ID             NAME            IMAGE                            NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS
47t0s0egf6xf   nginx-svc-1<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sw1       Running         Running 48 minutes ago

</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw1 ~]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                            COMMAND                  CREATED          STATUS          PORTS     NAMES
1bdf8981f511   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token string">"/docker-entrypoint.…"</span>   53 minutes ago   Up 53 minutes   80/tcp    nginx-svc-1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>47t0s0egf6xf1n8m0c0jez3q0
</code></pre> 
<h3>
<a id="425__469"></a>4.2.5 访问已发布的服务</h3> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
v1
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.11</span>
v1
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.12</span>
v1
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.13</span>
v1
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.14</span>
v1
</code></pre> 
<p><strong>在集群之外的主机访问</strong><br> <img src="https://images2.imgbox.com/52/25/8N5d4OCN_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="43__485"></a>4.3 服务扩展</h2> 
<p>使用scale指定副本数来扩展</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service scale nginx-svc-1=2</span>
nginx-svc-1 scaled to 2
overall progress: 2 out of 2 tasks
1/2: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
2/2: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID             NAME          MODE         REPLICAS   IMAGE                            PORTS
ucif0ibkjqrd   nginx-svc-1   replicated   2/2        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token operator">*</span>:80-&gt;80/tcp
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps nginx-svc-1</span>
ID             NAME            IMAGE                            NODE      DESIRED STATE   CURRENT STATE               ERROR     PORTS
47t0s0egf6xf   nginx-svc-1<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sw1       Running         Running about an hour ago
oy16nuh5udn0   nginx-svc-1<span class="token punctuation">.</span>2   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sw2       Running         Running 57 seconds ago

</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw1 ~]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                            COMMAND                  CREATED             STATUS             PORTS     NAMES
1bdf8981f511   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token string">"/docker-entrypoint.…"</span>   About an hour ago   Up About an hour   80/tcp    nginx-svc-1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>47t0s0egf6xf1n8m0c0jez3q0
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw2 ~]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                            COMMAND                  CREATED              STATUS              PORTS     NAMES
0923c0d10223   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token string">"/docker-entrypoint.…"</span>   About a minute ago   Up About a minute   80/tcp    nginx-svc-1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>oy16nuh5udn0s1hda5bcpr9hd
</code></pre> 
<p><strong>问题：现在仅扩展为2个副本，如果把服务扩展到3个副本，集群会如何分配主机呢？</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service scale nginx-svc-1=3</span>
nginx-svc-1 scaled to 3
overall progress: 3 out of 3 tasks
1/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
2/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
3/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps nginx-svc-1</span>
ID             NAME            IMAGE                            NODE      DESIRED STATE   CURRENT STATE               ERROR     PORTS
47t0s0egf6xf   nginx-svc-1<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sw1       Running         Running about an hour ago
oy16nuh5udn0   nginx-svc-1<span class="token punctuation">.</span>2   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sw2       Running         Running 12 minutes ago
mn9fwxqbc9d1   nginx-svc-1<span class="token punctuation">.</span>3   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sm1       Running         Running 9 minutes ago
</code></pre> 
<pre><code class="prism language-powershell">说明：
当把服务扩展到一定数量时，管理节点也会参与到负载运行中来。
</code></pre> 
<h2>
<a id="44__546"></a>4.4 服务裁减</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service scale nginx-svc-1=2</span>
nginx-svc-1 scaled to 2
overall progress: 2 out of 2 tasks
1/2: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
2/2: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID             NAME          MODE         REPLICAS   IMAGE                            PORTS
ucif0ibkjqrd   nginx-svc-1   replicated   2/2        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token operator">*</span>:80-&gt;80/tcp
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps nginx-svc-1</span>
ID             NAME            IMAGE                            NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS
47t0s0egf6xf   nginx-svc-1<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sw1       Running         Running 2 hours ago
oy16nuh5udn0   nginx-svc-1<span class="token punctuation">.</span>2   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sw2       Running         Running 29 minutes ago
</code></pre> 
<h2>
<a id="45__569"></a>4.5 负载均衡</h2> 
<blockquote> 
 <p>服务中包含多个容器时，每次访问将以轮询的方式访问到每个容器</p> 
</blockquote> 
<pre><code class="prism language-powershell">修改sw1主机中容器网页文件
<span class="token namespace">[root@sw1 ~]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                            COMMAND                  CREATED             STATUS             PORTS     NAMES
1bdf8981f511   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token string">"/docker-entrypoint.…"</span>   About an hour ago   Up About an hour   80/tcp    nginx-svc-1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>47t0s0egf6xf1n8m0c0jez3q0
<span class="token namespace">[root@sw1 ~]</span><span class="token comment"># docker exec -it 1bdf bash</span>
root@1bdf8981f511:<span class="token operator">/</span><span class="token comment"># echo "sw1 web" &gt; /usr/share/nginx/html/index.html</span>
root@1bdf8981f511:<span class="token operator">/</span><span class="token comment"># exit</span>
</code></pre> 
<pre><code class="prism language-powershell">修改sw2主机中容器网页文件
<span class="token namespace">[root@sw2 ~]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                            COMMAND                  CREATED          STATUS          PORTS     NAMES
0923c0d10223   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token string">"/docker-entrypoint.…"</span>   42 minutes ago   Up 42 minutes   80/tcp    nginx-svc-1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>oy16nuh5udn0s1hda5bcpr9hd
<span class="token namespace">[root@sw2 ~]</span><span class="token comment"># docker exec -it 0923 bash</span>
root@0923c0d10223:<span class="token operator">/</span><span class="token comment"># echo "sw2 web" &gt; /usr/share/nginx/html/index.html</span>
root@0923c0d10223:<span class="token operator">/</span><span class="token comment"># exit</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
sw1 web
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
sw2 web
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
sw1 web
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
sw2 web
</code></pre> 
<h2>
<a id="46___602"></a>4.6 删除服务</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID             NAME          MODE         REPLICAS   IMAGE                            PORTS
ucif0ibkjqrd   nginx-svc-1   replicated   2/2        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token operator">*</span>:80-&gt;80/tcp
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service rm nginx-svc-1</span>
nginx-svc-1
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID        NAME      MODE      REPLICAS   IMAGE     PORTS
</code></pre> 
<h2>
<a id="47__619"></a>4.7 服务版本更新</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service create --name nginx-svc --replicas=1 --publish 80:80 192.168.10.15/library/nginx:v1</span>
yz3wq6f1cgf10vtq5ne4qfwjz
overall progress: 1 out of 1 tasks
1/1: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
v1
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service update nginx-svc --image 192.168.10.15/library/nginx:v2</span>
nginx-svc
overall progress: 1 out of 1 tasks
1/1: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
v2
</code></pre> 
<h2>
<a id="48__646"></a>4.8 服务版本回退</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service update nginx-svc --image 192.168.10.15/library/nginx:v1</span>
nginx-svc
overall progress: 1 out of 1 tasks
1/1: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<h2>
<a id="49__655"></a>4.9 服务版本滚动间隔更新</h2> 
<pre><code class="prism language-powershell"><span class="token comment"># docker service create --name nginx-svc --replicas 60 --publish 80:80 192.168.10.15/library/nginx:v1</span>
pqrt561dckg2wfpect3vf9ll0
overall progress: 60 out of 60 tasks
verify: Service converged
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service update --replicas 60 --image 192.168.10.15/library/nginx:v2 --update-parallelism 5 --update-delay 30s nginx-svc</span>
nginx-svc
overall progress: 3 out of 3 tasks
1/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
2/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
3/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<pre><code class="prism language-powershell">说明
<span class="token operator">*</span> <span class="token operator">--</span><span class="token function">update-parallelism</span> 5 指定并行更新数量
<span class="token operator">*</span> <span class="token operator">--</span><span class="token function">update-delay</span> 30s 指定更新间隔时间
</code></pre> 
<pre><code class="prism language-powershell">docker swarm滚动更新会造成节点上有<span class="token keyword">exit</span>状态的容器<span class="token punctuation">,</span>可以考虑清除
命令如下：
<span class="token namespace">[root@sw1 ~]</span><span class="token comment"># docker container prune</span>
WARNING! This will remove all stopped containers<span class="token punctuation">.</span>
Are you sure you want to <span class="token keyword">continue</span>? <span class="token namespace">[y/N]</span> y
</code></pre> 
<h2>
<a id="410__687"></a>4.10 副本控制器</h2> 
<blockquote> 
 <p>副本控制器</p> 
</blockquote> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID             NAME        MODE         REPLICAS   IMAGE                            PORTS
yz3wq6f1cgf1   nginx-svc   replicated   3/3        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   <span class="token operator">*</span>:80-&gt;80/tcp
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps nginx-svc</span>
ID             NAME              IMAGE                            NODE      DESIRED STATE   CURRENT STATE          ERROR     PORTS
x78l0santsbb   nginx-svc<span class="token punctuation">.</span>1       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   sw2       Running         Running 3 hours ago
ura9isskfxku    _ nginx-svc<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sm1       Shutdown        Shutdown 3 hours ago
z738gvgazish    _ nginx-svc<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   sw1       Shutdown        Shutdown 3 hours ago
3qsrkkxn32bl    _ nginx-svc<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sm3       Shutdown        Shutdown 3 hours ago
psbi0mxu3amy   nginx-svc<span class="token punctuation">.</span>2       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   sw1       Running         Running 3 hours ago
zpjw39bwhd78   nginx-svc<span class="token punctuation">.</span>3       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   sm1       Running         Running 3 hours ago
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                            COMMAND                  CREATED       STATUS       PORTS     NAMES
81fffd9132d8   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   <span class="token string">"/docker-entrypoint.…"</span>   3 hours ago   Up 3 hours   80/tcp    nginx-svc<span class="token punctuation">.</span>3<span class="token punctuation">.</span>zpjw39bwhd78pw49svpy4q8zd
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker stop 81fffd9132d8;docker rm 81fffd9132d8</span>
81fffd9132d8
81fffd9132d8
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID             NAME        MODE         REPLICAS   IMAGE                            PORTS
yz3wq6f1cgf1   nginx-svc   replicated   3/3        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   <span class="token operator">*</span>:80-&gt;80/tcp
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps nginx-svc</span>
ID             NAME              IMAGE                            NODE      DESIRED STATE   CURRENT STATE            ERROR                         PORTS
x78l0santsbb   nginx-svc<span class="token punctuation">.</span>1       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   sw2       Running         Running 3 hours ago
ura9isskfxku    _ nginx-svc<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sm1       Shutdown        Shutdown 3 hours ago
z738gvgazish    _ nginx-svc<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   sw1       Shutdown        Shutdown 3 hours ago
3qsrkkxn32bl    _ nginx-svc<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sm3       Shutdown        Shutdown 3 hours ago
psbi0mxu3amy   nginx-svc<span class="token punctuation">.</span>2       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   sw1       Running         Running 3 hours ago
qv6ya3crz1fj   nginx-svc<span class="token punctuation">.</span>3       192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   sm1       Running         Running 13 seconds ago
zpjw39bwhd78    _ nginx-svc<span class="token punctuation">.</span>3   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v2   sm1       Shutdown        Failed 19 seconds ago    <span class="token string">"task: non-zero exit (137)"</span>
</code></pre> 
<h2>
<a id="411__730"></a>4.11 在指定网络中发布服务</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker network create -d overlay tomcat-net</span>
mrkgccdfddy8zg92ja6fpox7p
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker network ls</span>
NETWORK ID     NAME              DRIVER    SCOPE
5ba369c13795   bridge            bridge    local
54568abb541a   docker_gwbridge   bridge    local
4edcb5c4a324   host              host      local
l6xmfxiiseqk   ingress           overlay   swarm
5d06d748c9c7   none              null      local
mrkgccdfddy8   tomcat-net        overlay   swarm
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker network inspect tomcat-net</span>
<span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"Name"</span>: <span class="token string">"tomcat-net"</span><span class="token punctuation">,</span>
        <span class="token string">"Id"</span>: <span class="token string">"mrkgccdfddy8zg92ja6fpox7p"</span><span class="token punctuation">,</span>
        <span class="token string">"Created"</span>: <span class="token string">"2022-02-16T13:56:52.338589006Z"</span><span class="token punctuation">,</span>
        <span class="token string">"Scope"</span>: <span class="token string">"swarm"</span><span class="token punctuation">,</span>
        <span class="token string">"Driver"</span>: <span class="token string">"overlay"</span><span class="token punctuation">,</span>
        <span class="token string">"EnableIPv6"</span>: false<span class="token punctuation">,</span>
        <span class="token string">"IPAM"</span>: <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Driver"</span>: <span class="token string">"default"</span><span class="token punctuation">,</span>
            <span class="token string">"Options"</span>: null<span class="token punctuation">,</span>
            <span class="token string">"Config"</span>: <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"Subnet"</span>: <span class="token string">"10.0.1.0/24"</span><span class="token punctuation">,</span>
                    <span class="token string">"Gateway"</span>: <span class="token string">"10.0.1.1"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"Internal"</span>: false<span class="token punctuation">,</span>
        <span class="token string">"Attachable"</span>: false<span class="token punctuation">,</span>
        <span class="token string">"Ingress"</span>: false<span class="token punctuation">,</span>
        <span class="token string">"ConfigFrom"</span>: <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Network"</span>: <span class="token string">""</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"ConfigOnly"</span>: false<span class="token punctuation">,</span>
        <span class="token string">"Containers"</span>: null<span class="token punctuation">,</span>
        <span class="token string">"Options"</span>: <span class="token punctuation">{<!-- --></span>
            <span class="token string">"com.docker.network.driver.overlay.vxlanid_list"</span>: <span class="token string">"4097"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"Labels"</span>: null
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-powershell">说明：
创建名为tomcat-net的覆盖网络<span class="token punctuation">(</span>Overlay Netowork<span class="token punctuation">)</span>，这是个二层网络，处于该网络下的docker容器，即使宿主机不一样，也能相互访问
</code></pre> 
<pre><code class="prism language-powershell"><span class="token comment"># docker service create --name tomcat </span>
<span class="token operator">--</span>network tomcat-net 
<span class="token operator">-</span>p 8080:8080 
<span class="token operator">--</span>replicas 2 
tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk
</code></pre> 
<pre><code class="prism language-powershell">说明：
创建名为tomcat的服务，使用了刚才创建的覆盖网络
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID             NAME      MODE         REPLICAS   IMAGE                        PORTS
wgqkz8vymxkr   tomcat    replicated   2/2        tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk   <span class="token operator">*</span>:8080-&gt;8080/tcp
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps tomcat</span>
ID             NAME       IMAGE                        NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS
fsx1fnssbmtg   tomcat<span class="token punctuation">.</span>1   tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk   sm3       Running         Running 49 seconds ago
gq0ogycj7orb   tomcat<span class="token punctuation">.</span>2   tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk   sm2       Running         Running 58 seconds ago
</code></pre> 
<p><img src="https://images2.imgbox.com/15/b6/4dAZLMtV_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="412__808"></a>4.12 服务网络模式</h2> 
<ul><li>服务模式一共有两种：Ingress和Host，如果不指定，则默认的是Ingress； 
  <ul><li>Ingress模式下，到达Swarm任何节点的8080端口的流量，都会映射到任何服务副本的内部80端口，就算该节点上没有tomcat服务副本也会映射；</li></ul> </li></ul> 
<pre><code class="prism language-powershell"><span class="token comment"># docker service create --name tomcat </span>
<span class="token operator">--</span>network tomcat-net 
<span class="token operator">-</span>p 8080:8080 
<span class="token operator">--</span>replicas 2 
tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps tomcat</span>
ID             NAME       IMAGE                        NODE      DESIRED STATE   CURRENT STATE           ERROR     PORTS
fsx1fnssbmtg   tomcat<span class="token punctuation">.</span>1   tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk   sm3       Running         Running 8 minutes ago
gq0ogycj7orb   tomcat<span class="token punctuation">.</span>2   tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk   sm2       Running         Running 8 minutes ago
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm2 ~]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                        COMMAND             CREATED         STATUS         PORTS      NAMES
f650498c8e71   tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk   <span class="token string">"catalina.sh run"</span>   9 minutes ago   Up 9 minutes   8080/tcp   tomcat<span class="token punctuation">.</span>2<span class="token punctuation">.</span>gq0ogycj7orbu4ua1dwk140as

<span class="token namespace">[root@sm2 ~]</span><span class="token comment"># docker inspect f650498c8e71 | grep IPAddress</span>
            <span class="token string">"SecondaryIPAddresses"</span>: null<span class="token punctuation">,</span>
            <span class="token string">"IPAddress"</span>: <span class="token string">""</span><span class="token punctuation">,</span>
                    <span class="token string">"IPAddress"</span>: <span class="token string">"10.0.0.24"</span><span class="token punctuation">,</span> ingress IP地址
                    <span class="token string">"IPAddress"</span>: <span class="token string">"10.0.1.9"</span><span class="token punctuation">,</span>  容器IP地址

</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm3 ~]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                        COMMAND             CREATED         STATUS         PORTS      NAMES
9d0c412717d7   tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk   <span class="token string">"catalina.sh run"</span>   9 minutes ago   Up 9 minutes   8080/tcp   tomcat<span class="token punctuation">.</span>1<span class="token punctuation">.</span>fsx1fnssbmtgv3qh84fgqknlh

<span class="token namespace">[root@sm3 ~]</span><span class="token comment"># docker inspect 9d0c412717d7 | grep IPAddress</span>
            <span class="token string">"SecondaryIPAddresses"</span>: null<span class="token punctuation">,</span>
            <span class="token string">"IPAddress"</span>: <span class="token string">""</span><span class="token punctuation">,</span>
                    <span class="token string">"IPAddress"</span>: <span class="token string">"10.0.0.23"</span><span class="token punctuation">,</span>
                    <span class="token string">"IPAddress"</span>: <span class="token string">"10.0.1.8"</span><span class="token punctuation">,</span>

</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># ss -anput | grep ":8080"</span>
tcp    LISTEN     0      128    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8080               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"dockerd"</span><span class="token punctuation">,</span>pid=2727<span class="token punctuation">,</span>fd=54<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm2 ~]</span><span class="token comment"># ss -anput | grep ":8080"</span>
tcp    LISTEN     0      128    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8080               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"dockerd"</span><span class="token punctuation">,</span>pid=1229<span class="token punctuation">,</span>fd=26<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm3 ~]</span><span class="token comment"># ss -anput | grep ":8080"</span>
tcp    LISTEN     0      128    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8080               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"dockerd"</span><span class="token punctuation">,</span>pid=1226<span class="token punctuation">,</span>fd=22<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw1 ~]</span><span class="token comment"># ss -anput | grep ":8080"</span>
tcp    LISTEN     0      128    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8080               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"dockerd"</span><span class="token punctuation">,</span>pid=1229<span class="token punctuation">,</span>fd=39<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw2 ~]</span><span class="token comment"># ss -anput | grep ":8080"</span>
tcp    LISTEN     0      128    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8080               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"dockerd"</span><span class="token punctuation">,</span>pid=1229<span class="token punctuation">,</span>fd=22<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>Host模式下，仅在运行有容器副本的机器上开放端口，使用Host模式的命令如下：</li></ul> 
<pre><code class="prism language-powershell"><span class="token comment"># docker service create --name tomcat </span>
<span class="token operator">--</span>network tomcat-net 
<span class="token operator">--</span>publish published=8080<span class="token punctuation">,</span>target=8080<span class="token punctuation">,</span>mode=host 
<span class="token operator">--</span>replicas 3 
tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps tomcat</span>
ID             NAME       IMAGE                        NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS
x6022h0oungs   tomcat<span class="token punctuation">.</span>1   tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk   sw1       Running         Running 19 seconds ago             <span class="token operator">*</span>:8080-&gt;8080/tcp<span class="token punctuation">,</span><span class="token operator">*</span>:8080-&gt;8080/tcp
jmnthwqi6ubf   tomcat<span class="token punctuation">.</span>2   tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk   sm1       Running         Running 18 seconds ago             <span class="token operator">*</span>:8080-&gt;8080/tcp<span class="token punctuation">,</span><span class="token operator">*</span>:8080-&gt;8080/tcp
nvcbijnfy2es   tomcat<span class="token punctuation">.</span>3   tomcat:7<span class="token punctuation">.</span>0<span class="token punctuation">.</span>96-jdk8-openjdk   sw2       Running         Running 19 seconds ago             <span class="token operator">*</span>:8080-&gt;8080/tcp<span class="token punctuation">,</span><span class="token operator">*</span>:8080-&gt;8080/tcp

</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># ss -anput | grep ":8080"</span>
tcp    LISTEN     0      128       <span class="token operator">*</span>:8080                  <span class="token operator">*</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"docker-proxy"</span><span class="token punctuation">,</span>pid=20963<span class="token punctuation">,</span>fd=4<span class="token punctuation">)</span><span class="token punctuation">)</span>
tcp    LISTEN     0      128    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8080               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"docker-proxy"</span><span class="token punctuation">,</span>pid=20967<span class="token punctuation">,</span>fd=4<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw1 ~]</span><span class="token comment"># ss -anput | grep ":8080"</span>
tcp    LISTEN     0      128       <span class="token operator">*</span>:8080                  <span class="token operator">*</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"docker-proxy"</span><span class="token punctuation">,</span>pid=20459<span class="token punctuation">,</span>fd=4<span class="token punctuation">)</span><span class="token punctuation">)</span>
tcp    LISTEN     0      128    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8080               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"docker-proxy"</span><span class="token punctuation">,</span>pid=20463<span class="token punctuation">,</span>fd=4<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw2 ~]</span><span class="token comment"># ss -anput | grep ":8080"</span>
tcp    LISTEN     0      128       <span class="token operator">*</span>:8080                  <span class="token operator">*</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"docker-proxy"</span><span class="token punctuation">,</span>pid=19938<span class="token punctuation">,</span>fd=4<span class="token punctuation">)</span><span class="token punctuation">)</span>
tcp    LISTEN     0      128    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8080               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"docker-proxy"</span><span class="token punctuation">,</span>pid=19942<span class="token punctuation">,</span>fd=4<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell">没有被映射端口
<span class="token namespace">[root@sm2 ~]</span><span class="token comment"># ss -anput | grep ":8080"</span>

<span class="token namespace">[root@sm3 ~]</span><span class="token comment"># ss -anput | grep ":8080"</span>
</code></pre> 
<h2>
<a id="413__920"></a>4.13 服务数据持久化存储</h2> 
<h3>
<a id="4131__921"></a>4.13.1 本地存储</h3> 
<h4>
<a id="41311__922"></a>4.13.1.1 在集群所有主机上创建本地目录</h4> 
<pre><code class="prism language-powershell"><span class="token comment"># mkdir -p /data/nginxdata</span>
</code></pre> 
<h4>
<a id="41312__927"></a>4.13.1.2 发布服务时挂载本地目录到容器中</h4> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service create --name nginx-svc --replicas 3 --mount "type=bind,source=/data/nginxdata,target=/usr/share/nginx/html" --publish 80:80  192.168.10.15/library/nginx:v1</span>

s31z75rniv4p53ycbqch3xbqm
overall progress: 3 out of 3 tasks
1/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
2/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
3/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<h4>
<a id="41313__939"></a>4.13.1.3 验证是否使用本地目录</h4> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID             NAME        MODE         REPLICAS   IMAGE                            PORTS
s31z75rniv4p   nginx-svc   replicated   3/3        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token operator">*</span>:80-&gt;80/tcp

</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps nginx-svc</span>
ID             NAME          IMAGE                            NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS
vgfhk4lksbtp   nginx-svc<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sm2       Running         Running 54 seconds ago
v2bs9araxeuc   nginx-svc<span class="token punctuation">.</span>2   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sw2       Running         Running 59 seconds ago
1m7fobr3cscz   nginx-svc<span class="token punctuation">.</span>3   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sm3       Running         Running 59 seconds ago
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm2 ~]</span><span class="token comment"># ls /data/nginxdata/</span>
<span class="token namespace">[root@sm2 ~]</span><span class="token comment"># echo "sm2 web" &gt; /data/nginxdata/index.html</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm3 ~]</span><span class="token comment"># ls /data/nginxdata/</span>
<span class="token namespace">[root@sm3 ~]</span><span class="token comment"># echo "sm3 web" &gt; /data/nginxdata/index.html</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw2 ~]</span><span class="token comment"># ls /data/nginxdata</span>
<span class="token namespace">[root@sw2 ~]</span><span class="token comment"># echo "sw2 web" &gt; /data/nginxdata/index.html</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
sm2 web
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
sm3 web
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
sw2 web
</code></pre> 
<blockquote> 
 <p>存在数据一致性问题</p> 
</blockquote> 
<h3>
<a id="4132__980"></a>4.13.2 网络存储</h3> 
<ul>
<li>网络存储卷可以实现跨docker宿主机的数据共享,数据持久保存到网络存储卷中</li>
<li>在创建service时添加卷的挂载参数,网络存储卷可以帮助自动挂载(<strong>但需要集群节点都创建该网络存储卷</strong>)</li>
</ul> 
<h4>
<a id="41321_NFS_984"></a>4.13.2.1 部署NFS存储</h4> 
<blockquote> 
 <p>本案例以NFS提供远程存储为例</p> 
</blockquote> 
<blockquote> 
 <p>在192.168.10.15服务器上部署NFS服务，共享目录为docker swarm集群主机使用。</p> 
</blockquote> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@harbor ~]</span><span class="token comment"># mkdir /opt/dockervolume</span>

</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@harbor ~]</span><span class="token comment"># yum -y install nfs-utils</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@harbor ~]</span><span class="token comment"># vim /etc/exports</span>
<span class="token namespace">[root@harbor ~]</span><span class="token comment"># cat /etc/exports</span>
<span class="token operator">/</span>opt/dockervolume       <span class="token operator">*</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span>sync<span class="token punctuation">,</span>no_root_squash<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@harbor ~]</span><span class="token comment"># systemctl enable nfs-server</span>

<span class="token namespace">[root@harbor ~]</span><span class="token comment"># systemctl start nfs-server</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@harbor ~]</span><span class="token comment"># showmount -e</span>
Export list <span class="token keyword">for</span> harbor:
<span class="token operator">/</span>opt/dockervolume <span class="token operator">*</span>
</code></pre> 
<h4>
<a id="41322_nfsutils_1016"></a>4.13.2.2 为集群所有主机安装nfs-utils软件</h4> 
<pre><code class="prism language-powershell"><span class="token comment"># yum -y install nfs-utils</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token comment"># showmount -e 192.168.10.15</span>
Export list <span class="token keyword">for</span> 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15:
<span class="token operator">/</span>opt/dockervolume <span class="token operator">*</span>
</code></pre> 
<h4>
<a id="41323__1027"></a>4.13.2.3 创建存储卷</h4> 
<blockquote> 
 <p>集群中所有节点</p> 
</blockquote> 
<pre><code class="prism language-powershell"><span class="token comment"># docker volume create  --driver local --opt type=nfs --opt o=addr=192.168.10.15,rw --opt device=:/opt/dockervolume nginx_volume</span>
nginx_volume

</code></pre> 
<pre><code class="prism language-powershell"><span class="token comment"># docker volume ls</span>
DRIVER    VOLUME NAME
local     nginx_volume
</code></pre> 
<pre><code class="prism language-powershell"><span class="token comment"># docker volume inspect nginx_volume</span>
<span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"CreatedAt"</span>: <span class="token string">"2022-02-16T23:29:11+08:00"</span><span class="token punctuation">,</span>
        <span class="token string">"Driver"</span>: <span class="token string">"local"</span><span class="token punctuation">,</span>
        <span class="token string">"Labels"</span>: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"Mountpoint"</span>: <span class="token string">"/var/lib/docker/volumes/nginx_volume/_data"</span><span class="token punctuation">,</span>
        <span class="token string">"Name"</span>: <span class="token string">"nginx_volume"</span><span class="token punctuation">,</span>
        <span class="token string">"Options"</span>: <span class="token punctuation">{<!-- --></span>
            <span class="token string">"device"</span>: <span class="token string">":/opt/dockervolume"</span><span class="token punctuation">,</span>
            <span class="token string">"o"</span>: <span class="token string">"addr=192.168.10.15,rw"</span><span class="token punctuation">,</span>
            <span class="token string">"type"</span>: <span class="token string">"nfs"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"Scope"</span>: <span class="token string">"local"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4>
<a id="41324__1060"></a>4.13.2.4 发布服务</h4> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service create  --name nginx-svc --replicas 3 --publish 80:80 --mount "type=volume,source=nginx_volume,target=/usr/share/nginx/html"  192.168.10.15/library/nginx:v1</span>
uh6k84b87n8vciuirln4zqb4v
overall progress: 3 out of 3 tasks
1/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
2/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
3/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<h4>
<a id="41325__1071"></a>4.13.2.5 验证</h4> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID             NAME        MODE         REPLICAS   IMAGE                            PORTS
uh6k84b87n8v   nginx-svc   replicated   3/3        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   <span class="token operator">*</span>:80-&gt;80/tcp
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps nginx-svc</span>
ID             NAME          IMAGE                            NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS
k2vxpav5oadf   nginx-svc<span class="token punctuation">.</span>1   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sw2       Running         Running 43 seconds ago
v8fh0r89wt5i   nginx-svc<span class="token punctuation">.</span>2   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sw1       Running         Running 43 seconds ago
xb0nyft8ou4d   nginx-svc<span class="token punctuation">.</span>3   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1   sm1       Running         Running 43 seconds ago
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># df -Th | grep nfs</span>
:<span class="token operator">/</span>opt/dockervolume      nfs        50G  8<span class="token punctuation">.</span>9G   42G   18% <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/docker/volumes/nginx_volume/_data
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw1 ~]</span><span class="token comment"># df -Th | grep nfs</span>
:<span class="token operator">/</span>opt/dockervolume      nfs        50G  8<span class="token punctuation">.</span>9G   42G   18% <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/docker/volumes/nginx_volume/_data
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw2 ~]</span><span class="token comment"># df -Th | grep nfs</span>
:<span class="token operator">/</span>opt/dockervolume      nfs        50G  8<span class="token punctuation">.</span>9G   42G   18% <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/docker/volumes/nginx_volume/_data
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@harbor ~]</span><span class="token comment"># echo "nfs test" &gt; /opt/dockervolume/index.html</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.10</span>
nfs test
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.11</span>
nfs test
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.12</span>
nfs test
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.13</span>
nfs test
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># curl http://192.168.10.14</span>
nfs test

</code></pre> 
<h2>
<a id="414__1116"></a>4.14 服务互联与服务发现</h2> 
<p>如果一个nginx服务与一个mysql服务之间需要连接,在docker swarm如何实现呢?</p> 
<p><strong>方法1:</strong></p> 
<p>把mysql服务也使用 <code>--publish</code>参数发布到外网,但这样做的缺点是:mysql这种服务发布到外网不安全</p> 
<p><strong>方法2:</strong></p> 
<p>将mysql服务等运行在内部网络,只需要nginx服务能够连接mysql就可以了,在docker swarm中可以使用==<strong>overlay</strong>==网络来实现。</p> 
<p>但现在还有个问题,服务副本数发生变化时,容器内部的IP发生变化时,我们希望仍然能够访问到这个服务, 这就是**<mark>服务发现（service discovery)</mark>**.</p> 
<p><strong>通过服务发现, service的使用者都不需要知道service运行在哪里,IP是多少,有多少个副本,就能让service通信</strong></p> 
<p>下面使用<code>docker network ls</code>查看到的ingress网络就是一个overlay类型的网络,但它不支持服务发现</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker network ls</span>
NETWORK ID     NAME              DRIVER    SCOPE
5ba369c13795   bridge            bridge    local
54568abb541a   docker_gwbridge   bridge    local
4edcb5c4a324   host              host      local
l6xmfxiiseqk   ingress           overlay   swarm 此处
5d06d748c9c7   none              null      local
mrkgccdfddy8   tomcat-net        overlay   swarm
</code></pre> 
<p>我们<strong>需要自建一个overlay网络来实现服务发现, 需要相互通信的service也必须属于同一个overlay网络</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker network create --driver overlay --subnet 192.168.100.0/24 self-network</span>
ejpf8zzig5rjsgefqucopcsdt
</code></pre> 
<p>说明:</p> 
<ul>
<li>–driver overlay指定为overlay类型</li>
<li>–subnet 分配网段</li>
<li>self-network 为自定义的网络名称</li>
</ul> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker network ls</span>
NETWORK ID     NAME              DRIVER    SCOPE
5ba369c13795   bridge            bridge    local
54568abb541a   docker_gwbridge   bridge    local
4edcb5c4a324   host              host      local
l6xmfxiiseqk   ingress           overlay   swarm
5d06d748c9c7   none              null      local
ejpf8zzig5rj   self-network      overlay   swarm 此处
mrkgccdfddy8   tomcat-net        overlay   swarm
</code></pre> 
<p><strong>验证自动发现</strong><br> 1, 发布nignx-svc服务,指定在自建的overlay网络</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service create --name nginx-svc --replicas 3 --network self-network --publish 80:80  192.168.10.15/library/nginx:v1</span>
rr21tvm1xpi6vk3ic83tfy9e5
overall progress: 3 out of 3 tasks
1/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
2/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
3/3: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<p>2, 发布一个busybox服务,也指定在自建的overlay网络</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service create --name test --network self-network  busybox sleep 100000</span>
w14lzhhzdyqwt18lrby4euw98
overall progress: 1 out of 1 tasks
1/1: running   <span class="token punctuation">[</span>==================================================&gt;<span class="token punctuation">]</span>
verify: Service converged
</code></pre> 
<p>说明:</p> 
<ul>
<li>服务名为test</li>
<li>busybox是一个集成了linux常用命令的软件,这里使用它可以比较方便的测试与nginx_service的连通性</li>
<li>没有指定副本,默认1个副本</li>
<li>因为它并不是长时间运行的daemon守护进程,所以运行一下就会退出.sleep 100000是指定一个长的运行时间,让它有足够的时间给我们测试</li>
</ul> 
<p>3, 查出test服务在哪个节点运行的容器</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ps test</span>
ID             NAME      IMAGE            NODE      DESIRED STATE   CURRENT STATE                ERROR     PORTS
x8nkifpdtyw5   test<span class="token punctuation">.</span>1    busybox:latest   sm2       Running         Running about a minute ago
</code></pre> 
<p>4, 去运行test服务的容器节点查找容器的名称</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm2 ~]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE            COMMAND          CREATED              STATUS              PORTS     NAMES
8df13819bd5c   busybox:latest   <span class="token string">"sleep 100000"</span>   About a minute ago   Up About a minute             test<span class="token punctuation">.</span>1<span class="token punctuation">.</span>x8nkifpdtyw5177zhr0r1lxad
</code></pre> 
<p>5, 使用查找出来的容器名称,执行命令测试</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm2 ~]</span><span class="token comment"># docker exec -it test.1.x8nkifpdtyw5177zhr0r1lxad ping -c 2 nginx-svc</span>
PING nginx-svc <span class="token punctuation">(</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>100<span class="token punctuation">.</span>2<span class="token punctuation">)</span>: 56 <span class="token keyword">data</span> bytes
64 bytes <span class="token keyword">from</span> 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>100<span class="token punctuation">.</span>2: seq=0 ttl=64 time=0<span class="token punctuation">.</span>093 ms
64 bytes <span class="token keyword">from</span> 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>100<span class="token punctuation">.</span>2: seq=1 ttl=64 time=0<span class="token punctuation">.</span>162 ms

<span class="token operator">--</span><span class="token operator">-</span> nginx-svc ping statistics <span class="token operator">--</span><span class="token operator">-</span>
2 packets transmitted<span class="token punctuation">,</span> 2 packets received<span class="token punctuation">,</span> 0% packet loss
round-trip min/avg/max = 0<span class="token punctuation">.</span>093/0<span class="token punctuation">.</span>127/0<span class="token punctuation">.</span>162 ms
</code></pre> 
<p><strong>测试的结果为: test服务可以ping通nginx_service服务,并且返回的IP为自建网络的一个IP(192.168.100.2)</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service inspect nginx-svc</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token string">"VirtualIPs"</span>: <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"NetworkID"</span>: <span class="token string">"l6xmfxiiseqkl57wnsm4cykps"</span><span class="token punctuation">,</span>
                    <span class="token string">"Addr"</span>: <span class="token string">"10.0.0.36/24"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"NetworkID"</span>: <span class="token string">"ejpf8zzig5rjsgefqucopcsdt"</span><span class="token punctuation">,</span>
                    <span class="token string">"Addr"</span>: <span class="token string">"192.168.100.2/24"</span> 与此处IP地址保持一致。
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>6, 分别去各个节点查找nginx_service服务的各个容器(3个副本),发现它们的IP与上面ping的IP都不同</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker inspect nginx-svc.1.6nxixaw3tn2ld3vklfjldnpl5 | grep IPAddress</span>
            <span class="token string">"SecondaryIPAddresses"</span>: null<span class="token punctuation">,</span>
            <span class="token string">"IPAddress"</span>: <span class="token string">""</span><span class="token punctuation">,</span>
                    <span class="token string">"IPAddress"</span>: <span class="token string">"10.0.0.37"</span><span class="token punctuation">,</span>
                    <span class="token string">"IPAddress"</span>: <span class="token string">"192.168.100.3"</span><span class="token punctuation">,</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw1 ~]</span><span class="token comment"># docker inspect nginx-svc.3.steywkaxfboynglx4bsji6jd1 | grep -i ipaddress</span>
            <span class="token string">"SecondaryIPAddresses"</span>: null<span class="token punctuation">,</span>
            <span class="token string">"IPAddress"</span>: <span class="token string">""</span><span class="token punctuation">,</span>
                    <span class="token string">"IPAddress"</span>: <span class="token string">"10.0.0.39"</span><span class="token punctuation">,</span>
                    <span class="token string">"IPAddress"</span>: <span class="token string">"192.168.100.5"</span><span class="token punctuation">,</span>
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sw2 ~]</span><span class="token comment"># docker inspect nginx-svc.2.rz1iifb9eg0tos7r59cbesucd | grep -i ipaddress</span>
            <span class="token string">"SecondaryIPAddresses"</span>: null<span class="token punctuation">,</span>
            <span class="token string">"IPAddress"</span>: <span class="token string">""</span><span class="token punctuation">,</span>
                    <span class="token string">"IPAddress"</span>: <span class="token string">"10.0.0.38"</span><span class="token punctuation">,</span>
                    <span class="token string">"IPAddress"</span>: <span class="token string">"192.168.100.4"</span><span class="token punctuation">,</span>
</code></pre> 
<p>7, 后续测试, 将nginx_service服务扩展,裁减,更新,回退.都不影响test服务访问nginx-svc。<br> <strong>结论: 在自建的overlay网络内,通过服务发现可以实现服务之间通过服务名(不用知道对方的IP)互联,而且不会受服务内副本个数和容器内IP变化等的影响。</strong></p> 
<h2>
<a id="415_docker_swarm_1267"></a>4.15 docker swarm网络</h2> 
<p>在 Swarm Service 中有三个重要的网络概念：</p> 
<ul>
<li>
<strong>Overlay networks</strong> 管理 Swarm 中 Docker 守护进程间的通信。你可以将服务附加到一个或多个已存在的 <code>overlay</code> 网络上，使得服务与服务之间能够通信。</li>
<li>
<strong>ingress network</strong> 是一个特殊的 <code>overlay</code> 网络，用于服务节点间的负载均衡。当任何 Swarm 节点在发布的端口上接收到请求时，它将该请求交给一个名为 <code>IPVS</code> 的模块。<code>IPVS</code> 跟踪参与该服务的所有IP地址，选择其中的一个，并通过 <code>ingress</code> 网络将请求路由到它。<br> 初始化或加入 Swarm 集群时会自动创建 <code>ingress</code> 网络，大多数情况下，用户不需要自定义配置，但是 docker 17.05 和更高版本允许你自定义。</li>
<li>
<strong>docker_gwbridge</strong>是一种桥接网络，将 <code>overlay</code> 网络（包括 <code>ingress</code> 网络）连接到一个单独的 Docker 守护进程的物理网络。默认情况下，服务正在运行的每个容器都连接到本地 Docker 守护进程主机的 <code>docker_gwbridge</code> 网络。<br> <code>docker_gwbridge</code> 网络在初始化或加入 Swarm 时自动创建。大多数情况下，用户不需要自定义配置，但是 Docker 允许自定义。</li>
</ul> 
<table>
<thead><tr>
<th>名称</th>
<th>类型</th>
<th>注释</th>
</tr></thead>
<tbody>
<tr>
<td>docker_gwbridge</td>
<td>bridge</td>
<td>none</td>
</tr>
<tr>
<td>ingress</td>
<td>overlay</td>
<td>none</td>
</tr>
<tr>
<td>custom-network</td>
<td>overlay</td>
<td>none</td>
</tr>
</tbody>
</table>
<ul>
<li> <p>docker_gwbridge和ingress是swarm自动创建的，当用户执行了docker swarm init/connect之后。</p> </li>
<li> <p>docker_gwbridge是bridge类型的负责本机container和主机直接的连接</p> </li>
<li> <p>ingress负责service在多个主机container之间的路由。</p> </li>
<li> <p>custom-network是用户自己创建的overlay网络，通常我们都需要创建自己的network并把service挂在上面。</p> </li>
</ul> 
<p><img src="https://images2.imgbox.com/f0/03/WdsQBx9L_o.png" alt="在这里插入图片描述"></p> 
<h1>
<a id="docker_stack_1291"></a>五、docker stack</h1> 
<h2>
<a id="51_docker_stack_1292"></a>5.1 docker stack介绍</h2> 
<p>早期使用service发布，每次只能发布一个service。</p> 
<p>yaml可以发布多个服务，但是使用docker-compose只能在一台主机发布。</p> 
<p>一个stack就是一组有关联的服务的组合，可以一起编排，一起发布, 一起管理</p> 
<h2>
<a id="52_docker_stackdocker_compose_1299"></a>5.2 docker stack与docker compose区别</h2> 
<ul>
<li>Docker stack会忽略了“构建”指令，无法使用stack命令构建新镜像，它是需要镜像是预先已经构建好的。 所以docker-compose更适合于开发场景；</li>
<li>Docker Compose是一个Python项目，在内部，它使用Docker API规范来操作容器。所以需要安装Docker -compose，以便与Docker一起在您的计算机上使用；</li>
<li>Docker Stack功能包含在Docker引擎中。你不需要安装额外的包来使用它，docker stacks 只是swarm mode的一部分。</li>
<li>Docker stack不支持基于第2版写的docker-compose.yml ，也就是version版本至少为3。然而Docker Compose对版本为2和3的 文件仍然可以处理；</li>
<li>docker stack把docker compose的所有工作都做完了，因此docker stack将占主导地位。同时，对于大多数用户来说，切换到使用docker stack既不困难，也不需要太多的开销。如果您是Docker新手，或正在选择用于新项目的技术，请使用docker stack。</li>
</ul> 
<h2>
<a id="53_docker_stack_1306"></a>5.3 docker stack常用命令</h2> 
<table>
<thead><tr>
<th>命令</th>
<th>描述</th>
</tr></thead>
<tbody>
<tr>
<td>docker stack deploy</td>
<td>部署新的堆栈或更新现有堆栈</td>
</tr>
<tr>
<td>docker stack ls</td>
<td>列出现有堆栈</td>
</tr>
<tr>
<td>docker stack ps</td>
<td>列出堆栈中的任务</td>
</tr>
<tr>
<td>docker stack rm</td>
<td>删除一个或多个堆栈</td>
</tr>
<tr>
<td>docker stack services</td>
<td>列出堆栈中的服务</td>
</tr>
</tbody>
</table>
<h2>
<a id="54_wordpress_1317"></a>5.4 部署wordpress案例</h2> 
<p>1, 编写YAML文件</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># vim stack1.yaml</span>
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># cat stack1.yaml</span>
version: <span class="token string">'3'</span>
services:
  db:
    image: mysql:5<span class="token punctuation">.</span>7
    environment:
      MYSQL_ROOT_PASSWORD: somewordpress
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress
    deploy:
      replicas: 1

  wordpress:
    depends_on:
      <span class="token operator">-</span> db
    image: wordpress:latest
    ports:
      <span class="token operator">-</span> <span class="token string">"8010:80"</span>
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
    deploy:
      replicas: 1
      placement:
        constraints: <span class="token namespace">[node.role == manager]</span>
</code></pre> 
<p>说明:</p> 
<ul><li>placement的constraints限制此容器在manager节点</li></ul> 
<p>2, 使用docker stack发布</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker stack deploy -c stack1.yaml stack1</span>
Creating network stack1_default						创建自建的overlay网络
Creating service stack1_db							创建stack1_db服务
Creating service stack1_wordpress					创建stack1_wordpress服务
</code></pre> 
<p><strong>如果报错,使用<code>docker stack rm stack1</code>删除.排完错再启动</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker stack ls</span>
NAME      SERVICES   ORCHESTRATOR
stack1    2          Swarm
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker service ls</span>
ID             NAME               MODE         REPLICAS   IMAGE              PORTS
tw1a8rnde2yr   stack1_db          replicated   1/1        mysql:5<span class="token punctuation">.</span>7
zf1h2r4m12li   stack1_wordpress   replicated   1/1        wordpress:latest   <span class="token operator">*</span>:8010-&gt;80/tcp
</code></pre> 
<p>3, 验证</p> 
<p><img src="https://images2.imgbox.com/58/08/RpfYJv1I_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="55__nginxweb_1383"></a>5.5 部署nginx与web管理服务案例</h2> 
<p>1, 编写YAML文件</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># vim stack2.yaml</span>
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># cat stack2.yaml</span>
version: <span class="token string">"3"</span>
services:
  nginx:
    image: 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1
    ports:
      <span class="token operator">-</span> 80:80
    deploy:
      mode: replicated
      replicas: 3

  visualizer:
    image: dockersamples/visualizer
    ports:
      <span class="token operator">-</span> <span class="token string">"9001:8080"</span>
    volumes:
      <span class="token operator">-</span> <span class="token string">"/var/run/docker.sock:/var/run/docker.sock"</span>
    deploy:
      replicas: 1
      placement:
        constraints: <span class="token namespace">[node.role == manager]</span>

  portainer:
    image: portainer/portainer
    ports:
      <span class="token operator">-</span> <span class="token string">"9000:9000"</span>
    volumes:
      <span class="token operator">-</span> <span class="token string">"/var/run/docker.sock:/var/run/docker.sock"</span>
    deploy:
      replicas: 1
      placement:
        constraints: <span class="token namespace">[node.role == manager]</span>
</code></pre> 
<p>说明: stack中共有3个service</p> 
<ul>
<li>nginx服务,3个副本</li>
<li>visualizer服务: 图形查看docker swarm集群</li>
<li>portainer服务: 图形管理docker swarm集群</li>
</ul> 
<p>2,使用docker stack发布</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker stack deploy -c stack2.yaml stack2</span>
Creating network stack2_default
Creating service stack2_portainer
Creating service stack2_nginx
Creating service stack2_visualizer

如果报错<span class="token punctuation">,</span>使用docker stack <span class="token function">rm</span> stack2删除<span class="token punctuation">.</span>排完错再启动
</code></pre> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># docker stack ps stack2</span>
ID             NAME                  IMAGE                             NODE      DESIRED STATE   CURRENT STATE             ERROR     PORTS
zpkt1780g2nr   stack2_nginx<span class="token punctuation">.</span>1        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1    sm2       Running         Running 54 seconds ago
9iqdgw2fxk0s   stack2_nginx<span class="token punctuation">.</span>2        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1    sm3       Running         Running 54 seconds ago
4h0ob7b4ho2a   stack2_nginx<span class="token punctuation">.</span>3        192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1    sw2       Running         Running 54 seconds ago
jpp7h6qheh4j   stack2_portainer<span class="token punctuation">.</span>1    portainer/portainer:latest        sm1       Running         Running 21 seconds ago
ty0mktx60typ   stack2_visualizer<span class="token punctuation">.</span>1   dockersamples/visualizer:latest   sm1       Running         Starting 22 seconds ago
</code></pre> 
<p>3,验证<br> <img src="https://images2.imgbox.com/63/0d/txl65lVU_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/39/98/amBoL9SB_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="56_nginxhaproxynfs_1453"></a>5.6 nginx+haproxy+nfs案例</h2> 
<p>1,在docker swarm管理节点上准备配置文件</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 ~]</span><span class="token comment"># mkdir -p /docker-stack/haproxy</span>
<span class="token namespace">[root@sm1 ~]</span><span class="token comment"># cd /docker-stack/haproxy/</span>

<span class="token namespace">[root@sm1 haproxy]</span><span class="token comment"># vim haproxy.cfg</span>
global
  log 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1 local0
  log 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1 local1 notice

defaults
  log global
  mode http
  option httplog
  option dontlognull
  timeout connect 5000ms
  timeout client 50000ms
  timeout server 50000ms
  stats uri <span class="token operator">/</span>status

frontend balancer
    bind <span class="token operator">*</span>:8080
    mode http
    default_backend web_backends

backend web_backends
    mode http
    option forwardfor
    balance roundrobin
    server web1 nginx1:80 check
    server web2 nginx2:80 check
    server web3 nginx3:80 check
    option httpchk GET <span class="token operator">/</span>
    http-check expect status 200

</code></pre> 
<p>2, 编写YAML编排文件</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 haproxy]</span><span class="token comment"># vim stack3.yml</span>
<span class="token namespace">[root@sm1 haproxy]</span><span class="token comment"># vim stack3.yaml</span>
<span class="token namespace">[root@sm1 haproxy]</span><span class="token comment"># cat stack3.yaml</span>
version: <span class="token string">"3"</span>
services:
  nginx1:
    image: 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
    volumes:
    <span class="token operator">-</span> <span class="token string">"nginx_vol:/usr/share/nginx/html"</span>

  nginx2:
    image: 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
    volumes:
    <span class="token operator">-</span> <span class="token string">"nginx_vol:/usr/share/nginx/html"</span>

  nginx3:
    image: 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15/library/nginx:v1
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
    volumes:
    <span class="token operator">-</span> <span class="token string">"nginx_vol:/usr/share/nginx/html"</span>

  haproxy:
    image: haproxy:latest
    volumes:
      <span class="token operator">-</span> <span class="token string">"./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro"</span>
    ports:
      <span class="token operator">-</span> <span class="token string">"8080:8080"</span>
    deploy:
      replicas: 1
      placement:
        constraints: <span class="token namespace">[node.role == manager]</span>

volumes:
  nginx_vol:
    driver: local
    driver_opts:
      <span class="token function">type</span>: <span class="token string">"nfs"</span>
      o: <span class="token string">"addr=192.168.10.15,rw"</span>
      device: <span class="token string">":/opt/dockervolume"</span>
</code></pre> 
<p>3, 发布</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@sm1 haproxy]</span><span class="token comment"># docker stack deploy -c stack3.yml stack3</span>
Creating network stack3_default
Creating service stack3_nginx3
Creating service stack3_haproxy
Creating service stack3_nginx1
Creating service stack3_nginx2
</code></pre> 
<p>4, 验证<br> <img src="https://images2.imgbox.com/c3/3b/pgHaHQBr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a7/a2/AAXXxjON_o.png" alt="在这里插入图片描述"></p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>