<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Android事件分发机制 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android事件分发机制</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <h2>
<a id="Android_0"></a>Android事件分发机制</h2> 
<h2>
<a id="_2"></a>一.初识</h2> 
<p><strong>1.1 用户对屏幕的操作的事件可以划分为3种最基础的事件：</strong><br> 1.ACTION_DOWN：手指刚接触屏幕，按下去的那一瞬间产生该事件<br> 2.ACTION_MOVE：手指在屏幕上移动时候产生该事件<br> 3.ACTION_UP：手指从屏幕上松开的瞬间产生该事件<br> <strong>1.2 用户对屏幕的操作最终可以划分为这三种事件，用户的ACTION_DOWN到ACTION_UP的操作可以称为一个事件序列</strong><br> <strong>一个事件序列主要有以下两种组成：</strong><br> <strong>一：</strong> ACTION_DOWN-&gt;ACTION_UP</p> 
<p>二 ：ACTION_DOWN-&gt;许多个ACTION_MOVE&gt;ACTION_UP<br> <img src="https://images2.imgbox.com/59/8c/iEhvEvhA_o.png" alt="图片来自网络"></p> 
<p><strong>1.3 Android 的事件分发机制大体可以分为三部分 事件生产 事件分发 事件消费 事件的生产是由用户点击屏幕产生，这篇文章着重分析事件的分发和消费，因为事件分发和处理联系的过于紧密，这篇文章将把事件的分发和消费放在一起分析</strong></p> 
<p>在Activity上的事件分发和Activity PhoneView DecorView ViewGroup view 密不可分， 其中 Activity PhoneView DecorView ViewGroup view的关系可以用如下图来描述：</p> 
<p><img src="https://images2.imgbox.com/e8/3f/PWzjViXQ_o.png" alt="在这里插入图片描述"><br> 若干GroupView和若干View组成的控件树可以用下午来概括：<br> <img src="https://images2.imgbox.com/68/a1/YEeEgfaR_o.png" alt="在这里插入图片描述"></p> 
<p><strong>1.4 事件分发的大概流程可以这样来描述：Activity -&gt; PhoneWindow -&gt;DecorView(DecorView其实就是一种ViewGroup) -&gt;View</strong></p> 
<p><strong>1.5 事件分发需要的三个重要方法来共同完成</strong>：<br> public boolean dispatchTouchEvent（event）：用于进行点击事件的分发<br> public boolean onInterceptTouchEvent（event）：用于进行点击事件的拦截<br> public boolean onTouchEvent（event）：用于处理点击事件<br> 三个函数的参数均为even，即上面所说的3种类型的输入事件，返回值均为boolean 类型<br> <strong>上面的三种方法的调用关系大致可以用下面的伪代码来描述</strong></p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> ev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">boolean</span> consume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//事件是否被消费</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">onInterceptTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//调用onInterceptTouchEvent判断是否拦截事件</span>
            consume <span class="token operator">=</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果拦截则调用自身的onTouchEvent方法</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            consume <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//不拦截调用子View的dispatchTouchEvent方法</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> consume<span class="token punctuation">;</span><span class="token comment">//返回值表示事件是否被消费，true事件终止，false调用父View的onTouchEvent方法</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>事件的分发到处理的过程大致可以用一个U形图来描述：</strong><br> <img src="https://images2.imgbox.com/b7/df/XFlY9kZ7_o.png" alt="在这里插入图片描述"></p> 
<ul>
<li>首先是要说明的是，上图的分析仅仅只限于对ACTION_DOWN的分析</li>
<li>U形图从上到下可以分为三层，分别是Activity层，ViewGroup层，和View层</li>
<li>事件的开始分发是从右上角的大红色的箭头开始传输的</li>
<li>线上的false/ture/super 分别表示的是箭头起点函数的返回值：return false/return ture/return supperxxx(调用父类的返回)</li>
<li>箭头指向消费，表示该事件就到此为止，不会再往下传或往上一级传</li>
<li>如果事件在分发的过程中一直不被消费，那么整个分发的过程看起来就是一个U形的结构</li>
<li>图中只是说明了activity中只有一个ViewGroup的情况，实际操作中可能会有View ViewGroup多层嵌套的情况，原理也是这个原理，大同小异。<br> <strong>总结一下同种分发的几条规律：</strong>
</li>
<li>对于activity来说dispatchTouchEvent中无论是返回ture/false都会将事件消费，即不会再往下面传播，只有return super的时候才会传到 ViewGroup()</li>
<li>对于dispatchTouchEvent和onTouchEvent来说return false会把该事件交给父容器来处理</li>
<li>对于onInterceptTouchEvent来说返回false，顾名思义，该viewGroup将不会拦截该事件，这个事件就可以继续向下传播了，如果onInterceptTouchEvent返回ture就表明该ViewGroup将会拦截该事件，事件将会交给该组件的onTouchEvent来处理，事件也就不会再往下面的组件分发了</li>
<li>对于onTouchEvent来说对于传入他的事件，如果返回ture就代表该事件已经被消费，则流程就终止，如果返回false，那么就代表该事件将不会由他处理，将会将给父容器的onTouchEvent来处理。</li>
<li>每个ViewGroup每次在做分发的时候，问一问拦截器要不要拦截（也就是问问自己这个事件要不要自己来处理）如果要自己处理那就在onInterceptTouchEvent方法中 return true就会交给自己的onTouchEvent的处理，如果不拦截就是继续往子控件往下传。默认是不会去拦截的，因为子View也需要这个事件，所以onInterceptTouchEvent拦截器<strong>return super.onInterceptTouchEvent()和return false是一样的，是不会拦截的</strong>，事件会继续往子View的dispatchTouchEvent传递。</li>
<li>看下ViewGroup 的dispatchTouchEvent，之前说的return true是终结传递。return false 是回溯到父View的onTouchEvent，然后ViewGroup怎样通过dispatchTouchEvent方法能把事件分发到自己的onTouchEvent处理呢，return true和false 都不行，那么只能通过Interceptor把事件拦截下来给自己的onTouchEvent，<strong>所以ViewGroup dispatchTouchEvent方法的super默认实现就是去调用onInterceptTouchEvent</strong>
</li>
<li>那么对于View的dispatchTouchEvent return super.dispatchTouchEvent()的时候呢事件会传到哪里呢，很遗憾<strong>View没有拦截器</strong>。但是同样的道理return true是终结。return false 是回溯会父类的onTouchEvent，怎样把事件分发给自己的onTouchEvent处理呢，<strong>那只能return<br> super.dispatchTouchEvent,View类的dispatchTouchEvent（）方法默认实现就是能帮你调用View自己的onTouchEvent方法的。</strong>
</li>
</ul> 
<p><strong>1.6 对ACTION_MOVE 和ACTION_UP事件的处理</strong></p> 
<ul>
<li>对这两种事件的处理可以总结为下面这些内容ACTION_DOWN事件在哪个控件消费了（return true）， 那么ACTION_MOVE和ACTION_UP就会从上往下（通过dispatchTouchEvent）做事件分发往下传，就只会传到这个控件，不会继续往下传，如果ACTION_DOWN事件是在dispatchTouchEvent消费，那么事件到此为止停止传递，如果ACTION_DOWN事件是在onTouchEvent消费的，那么会把ACTION_MOVE或ACTION_UP事件传给该控件的onTouchEvent处理并结束传递。（下面的三张图均来自<a href="https://www.jianshu.com/p/e99b5e8bd67b">图解 Android 事件分发机制</a> 红色的箭头代表ACTION_DOWN 事件的流向蓝色的箭头代表ACTION_MOVE 和 ACTION_UP 事件的流向）</li>
<li>
<img src="https://images2.imgbox.com/85/d8/KlutuujR_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/71/8d/Ybx3RGAh_o.png" alt="在这里插入图片描述">
</li>
</ul> 
<p><img src="https://images2.imgbox.com/70/44/xCpO7jGk_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="_72"></a>二.源码分析</h2> 
<p><strong>1. 从Activity到ViewGroup</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">Activity</span><span class="token punctuation">.</span>java
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> ev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// -&gt;&gt;分析1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//getWindow返回的是一个PhoneWindow			  		  </span>
    												<span class="token comment">//对象 ，即这里调用的是PhoneWindow		  </span>
    												<span class="token comment">// 的superDispatchTouchEvent，也就</span>
    												<span class="token comment">//说在这里Activity把时间传给了</span>
    												<span class="token comment">//PhoneWindow</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 若getWindow().superDispatchTouchEvent(ev)的返回true</span>
        <span class="token comment">// 则Activity.dispatchTouchEvent（）就返回true，则方法结束。即 ：该点击事件停止往下传递 &amp; 事件传递过程结束</span>
        <span class="token comment">// 否则：继续调用Activity.onTouchEvent</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
	<span class="token comment">// ：当一个点击事件未被Activity下任何一个View接收/处理时，就会调用该方法</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mWindow<span class="token punctuation">.</span><span class="token function">shouldCloseOnTouch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token class-name">PhoneWindow</span><span class="token punctuation">.</span>java
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> mDecor<span class="token punctuation">.</span><span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// mDecor的类型是DecorView，DecorView是PhoneWindow的内部类，继承自FrameLayout，而FrameLayout是ViewGroup的子类，</span>
      <span class="token comment">// 所以mDecor是一个顶级的ViewGroup，在这里就实现了事件从PhoneWindow到顶级</span>
      <span class="token comment">//ViewGroup的传递</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/96/f1/hjTTPJrX_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token class-name">DecorView</span>：

  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">superDispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 在这里它调用了父类的dispatchTouchEvent，而DecorView的父类是FrameLayout，而</span>
      <span class="token comment">// FrameLayout的父类是ViewGroup，到这里就是我们熟悉的ViewGroup 的dispatchTouchEvent</span>

  <span class="token punctuation">}</span>
</code></pre> 
<p><strong>总结</strong><br> 当一个点击事件发生时，从Activity的事件分发开始（Activity.dispatchTouchEvent()），流程总结如下：<br> <img src="https://images2.imgbox.com/90/41/JmKxEtU5_o.png" alt="在这里插入图片描述"><br> <strong>1. ViewGroup中的分发</strong><br> <em><strong>1.1</strong></em></p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ViewGroup</span><span class="token operator">:</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> ev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> action <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> actionMasked <span class="token operator">=</span> action <span class="token operator">&amp;</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_MASK<span class="token punctuation">;</span>
        <span class="token comment">// Handle an initial down.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_DOWN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">cancelAndClearTouchTargets</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//清除FLAG_DISALLOW_INTERCEPT设置并且mFirstTouchTarget 设置为null</span>
            <span class="token function">resetTouchState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Check for interception.</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> intercepted<span class="token punctuation">;</span><span class="token comment">//是否拦截事件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_DOWN
                <span class="token operator">||</span> mFirstTouchTarget <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">// 注意这里 -&gt; 分析一</span>
            <span class="token comment">//FLAG_DISALLOW_INTERCEPT是子View通过</span>
            <span class="token comment">//requestDisallowInterceptTouchEvent方法进行设置的</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> disallowIntercept <span class="token operator">=</span> <span class="token punctuation">(</span>mGroupFlags <span class="token operator">&amp;</span> FLAG_DISALLOW_INTERCEPT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                      <span class="token comment">// 分析二</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disallowIntercept<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//调用onInterceptTouchEvent方法判断是否需要拦截</span>
                intercepted <span class="token operator">=</span> <span class="token function">onInterceptTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ev<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// restore action in case it was changed</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                intercepted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// There are no touch targets and this action is not an initial down</span>
            <span class="token comment">// so this view group continues to intercept touches.</span>
            intercepted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>分析一</p> 
<blockquote> 
 <p>这里首先判断事件是否为DOWN事件，如果是，则进行初始化，resetTouchState方法中会把 mFirstTouchTarget的值置为null。这里为什么要进行初始化呢？原因就是一个完整的事件序列是以 DOWN开始，以UP结束的。所以如果是DOWN事件，那么说明这是一个新的事件序列，故而需要初 始化之前的状态。接着往下看，上面代码注释1处的条件如果满足，则执行下面的句子，mFirstTouchTarget 的意义是：当 前ViewGroup 是否拦截了事件，如果拦截了， mFirstTouchTarget=null；如果没有拦截并交由子View来处 理，mFirstTouchTarget！=null 从上面代码我们可以看出，ViewGroup在如下两种情况下会判断是否要拦截当前事件:事件类型为ACTION DOWN或者mFirstTouchTarget != null。ACTION_ DOWN事件好理解,那么mFirstTouchTarget!=null是什么意思呢?这个从后面的代码逻辑可以看出来，当事件由ViewGroup的子元素成功处理时，mFirstTouchTarget 会被赋值并指向子<br> 元素，换种方式来说，当ViewGroup 不拦截事件并将事件交由子元素处理时<br> mFirstTouchTarget != null。 反过来，一旦事件由当前ViewGroup 拦截时，mFirstTouchTarget != null就不成立。那么当ACTION_ MOVE和ACTION <em>UP事件到来<br> 时，由于(actionMasked == MotionEvent. ACTION</em> DOWN II mFirstTouchTarget != null)这<br> 个条件为false, 将导致ViewGroup的onInterceptTouchEvent 不会再被调用，并且同一序列中的其他事件都会默认交给它处理。</p> 
</blockquote> 
<p>分析二</p> 
<blockquote> 
 <p>当然，这里有一种特殊情况，那就是FLAG_ DISALLOW_ INTERCEPT 标记位，这个<br> 标记位是通过requestDisallowInterceptTouchEvent 方法来设置的，一般用于子 View中。 FLAG_ DISALLOW_ INTERCEPT 一旦设置后，ViewGroup 将无法拦截除了 ACTION_ DOWN以外的其他点击事件。为什么说是除了ACTION_ <em>DOWN以外的其他事 件呢?这是因为ViewGroup在分发事件时，如果是ACTION</em> DOWN就会重置 FLAG_ DISALLOW_ INTERCEPT这个标记位，将导致子View中设置的这个标记位无效。 因此，当面对ACTION_DOWN事件时，ViewGroup总是会调用自己的onInterceptTouchEvent方法来询问自己是否要拦截事件，这一点从源码中也可以看出来。</p> 
</blockquote> 
<p>分析三</p> 
<blockquote> 
 <p>如果ViewGroup在这里对事件进行了ACTION_DOWN拦截，则会调用 super.dispatchTouchEvent(event)对事 件进行处理，因为ViewGroup的父类为View，在View的dispatchTouchEvent（）中会调用onTouchEvent（），即ViewGroup在选择对事件进行拦截后会交给ViewGroup的onTouchEvent去处理。</p> 
</blockquote> 
<p>分析四</p> 
<blockquote> 
 <p><strong>ViewGroup消费了ACTION_DOWN后，对后续事件的处理</strong><br> 分析过ViewGroup的dispatchTouchEvent（）发现，当ViewGroup对ACTION_DOWN事件拦截后， mFirstTouchTarget 的值应该还是空的，这就使得ViewGroup的（dispatchTouchEventactionMasked == MotionEvent.ACTION_DOWN|| mFirstTouchTarget != null）不成立 走else，使得intercepted = false;这样的话 ，ViewGroup在这里对事件进行了ACTION_DOWN拦截之后的，对后续的ACTION_MOVE 和ACTION_UP都进行拦截，流程与ViewGroup对事件ACTION_DOWN处理的流程一致。</p> 
</blockquote> 
<p><em><strong>1.2</strong></em></p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ViewGroup</span><span class="token operator">:</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> ev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	
        <span class="token keyword">final</span> <span class="token class-name">View</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children <span class="token operator">=</span> mChildren<span class="token punctuation">;</span>
        <span class="token comment">//对子View进行遍历</span>
        <span class="token comment">//我们看到了for循环。首先遍历ViewGroup的子元素，判断子元素是否能够接收到点</span>
		<span class="token comment">//击事件，如果子元素能够接收到点击事件，则交由子元素来处理。需要注意这个for循环				  		 //是倒序遍历的，即从最上层的子View开始往内层遍历。</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> childrenCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> childIndex <span class="token operator">=</span> <span class="token function">getAndVerifyPreorderedIndex</span><span class="token punctuation">(</span>
                    childrenCount<span class="token punctuation">,</span> i<span class="token punctuation">,</span> customOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">View</span> child <span class="token operator">=</span> <span class="token function">getAndVerifyPreorderedView</span><span class="token punctuation">(</span>
                    preorderedList<span class="token punctuation">,</span> children<span class="token punctuation">,</span> childIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// If there is a view that has accessibility focus we want it</span>
            <span class="token comment">// to get the event first and if not handled we will perform a</span>
            <span class="token comment">// normal dispatch. We may do a double iteration but this is</span>
            <span class="token comment">// safer given the timeframe.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>childWithAccessibilityFocus <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>childWithAccessibilityFocus <span class="token operator">!=</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                childWithAccessibilityFocus <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                i <span class="token operator">=</span> childrenCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 注释1 具体分析在下文</span>
            <span class="token comment">//判断1，View可见并且没有播放动画。2，点击事件的坐标落在View的范围内</span>
            <span class="token comment">//如果上述两个条件有一项不满足则continue继续循环下一个View</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canViewReceivePointerEvents</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isTransformedTouchPointInView</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> child<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ev<span class="token punctuation">.</span><span class="token function">setTargetAccessibilityFocus</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 注释 2  具体分析见下文</span>
            newTouchTarget <span class="token operator">=</span> <span class="token function">getTouchTarget</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果有子View处理即newTouchTarget 不为null则跳出循环。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newTouchTarget <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Child is already receiving touch within its bounds.</span>
                <span class="token comment">// Give it the new pointer in addition to the ones it is handling.</span>
                newTouchTarget<span class="token punctuation">.</span>pointerIdBits <span class="token operator">|=</span> idBitsToAssign<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">resetCancelNextUpFlag</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//dispatchTransformedTouchEvent第三个参数child这里不为null</span>
            <span class="token comment">//实际调用的是child的dispatchTouchEvent方法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dispatchTransformedTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> idBitsToAssign<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Child wants to receive touch within its bounds.</span>
                mLastTouchDownTime <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getDownTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>preorderedList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// childIndex points into presorted list, find original index</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> childrenCount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">[</span>childIndex<span class="token punctuation">]</span> <span class="token operator">==</span> mChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            mLastTouchDownIndex <span class="token operator">=</span> j<span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    mLastTouchDownIndex <span class="token operator">=</span> childIndex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mLastTouchDownX <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mLastTouchDownY <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//当child处理了点击事件，那么会设置mFirstTouchTarget 在addTouchTarget被赋值</span>
                newTouchTarget <span class="token operator">=</span> <span class="token function">addTouchTarget</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> idBitsToAssign<span class="token punctuation">)</span><span class="token punctuation">;</span>
                alreadyDispatchedToNewTouchTarget <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">//子View处理了事件，然后就跳出了for循环</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>分析1</p> 
<blockquote> 
 <p>在注释1处，有这样的判断 if (!canViewReceivePointerEvents(child)<br> || !isTransformedTouchPointInView(x, y, child, null))<br> 判断1，View可见并且没有播放动画。2，点击事件的坐标落在View的范围内<br> 若该判断不生效即 不可见 没播放动画， 或者 坐标点不在该View里面，则执行continue跳过这次循环。</p> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Returns true if a child view can receive pointer events.
     * @hide
     */</span>
     <span class="token comment">// 判断有没有可见并且没有播放动画的函数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">canViewReceivePointerEvents</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">View</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>mViewFlags <span class="token operator">&amp;</span> VISIBILITY_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> VISIBLE
                <span class="token operator">||</span> child<span class="token punctuation">.</span><span class="token function">getAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Returns true if a child view contains the specified point when transformed
     * into its coordinate space.
     * Child must not be null.
     * @hide
     */</span>
     <span class="token comment">// 判断坐标是否落在了 该View里面</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isTransformedTouchPointInView</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token class-name">View</span> child<span class="token punctuation">,</span>
            <span class="token class-name">PointF</span> outLocalPoint<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> point <span class="token operator">=</span> <span class="token function">getTempPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        point<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
        point<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">;</span>
        <span class="token function">transformPointToViewLocal</span><span class="token punctuation">(</span>point<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用View的pointInView方法进行判断坐标点是否在View内</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isInView <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">pointInView</span><span class="token punctuation">(</span>point<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> point<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isInView <span class="token operator">&amp;&amp;</span> outLocalPoint <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            outLocalPoint<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>point<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> point<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> isInView<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>分析2</p> 
<blockquote> 
 <p>在1.2代码里 对view可见性 坐标是否落在该View等条件判断完后，会有这样的步骤<br> newTouchTarget = getTouchTarget(child)，此时由于ACTION_DOWN事件还未被该ViewGroup的任何一个子View处理，结合上面的分析此时mFirstTouchTarget为null，所以此时getTouchTarget的返回值为null</p> 
</blockquote> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">TouchTarget</span> <span class="token function">getTouchTarget</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">View</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TouchTarget</span> target <span class="token operator">=</span> mFirstTouchTarget<span class="token punctuation">;</span> target <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> target <span class="token operator">=</span> target<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>child <span class="token operator">==</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> target<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>分析3</p> 
<blockquote> 
 <p>因为getTouchTarget（）在ViewGroup的返回值为null，最有接下来进入到 if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) ，把之前的代码copy下来方便分析，dispatchTransformedTouchEvent这和函数将会调用ViewGroup中子View的dispatchTouchEvent，并把结果返回回来，如果子View的onTouchEven()消费了事件，那么<br> dispatchTransformedTouchEvent的返回值为Ture，先回在注释1处调用newTouchTarget = addTouchTarget(child, idBitsToAssign)，这一步会把消费掉ACTION_DOWN的子View记录下来，同时使得mFirstTouchTarget 不再为null，然后在注释2处break ，结束ViewGroup中对子View的遍历</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ViewGroup</span><span class="token operator">:</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> ev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dispatchTransformedTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> idBitsToAssign<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Child wants to receive touch within its bounds.</span>
            mLastTouchDownTime <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getDownTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>preorderedList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// childIndex points into presorted list, find original index</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> childrenCount<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">[</span>childIndex<span class="token punctuation">]</span> <span class="token operator">==</span> mChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        mLastTouchDownIndex <span class="token operator">=</span> j<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                mLastTouchDownIndex <span class="token operator">=</span> childIndex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mLastTouchDownX <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mLastTouchDownY <span class="token operator">=</span> ev<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//当child处理了点击事件，那么会设置mFirstTouchTarget 在addTouchTarget被赋值</span>
            newTouchTarget <span class="token operator">=</span> <span class="token function">addTouchTarget</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> idBitsToAssign<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 注释1</span>
            alreadyDispatchedToNewTouchTarget <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">//子View处理了事件，然后就跳出了for循环</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>   <span class="token comment">// 注释2</span>
        <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// 通过这函数可以看出，这里采用了头插法把target 插入到一个单向链表中，</span>
<span class="token comment">//其中TouchTarget.obtain是产生一个TouchTarget 对象，TouchTarget存有消费事件的View</span>
   <span class="token keyword">private</span> <span class="token class-name">TouchTarget</span> <span class="token function">addTouchTarget</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">View</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> pointerIdBits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">TouchTarget</span> target <span class="token operator">=</span> <span class="token class-name">TouchTarget</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> pointerIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        target<span class="token punctuation">.</span>next <span class="token operator">=</span> mFirstTouchTarget<span class="token punctuation">;</span>
        mFirstTouchTarget <span class="token operator">=</span> target<span class="token punctuation">;</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-java"><span class="token class-name">TouchTarget</span><span class="token punctuation">.</span>java
<span class="token comment">// 观察TouchTarget的字段可以发现吗，TouchTarget里面存有消费事件的View，</span>
<span class="token comment">//pointerIdBits（和多点触碰有关），还有指向下一个节点的引用</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TouchTarget</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_RECYCLED <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> sRecycleLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">TouchTarget</span> sRecycleBin<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> sRecycledCount<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ALL_POINTER_IDS <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// all ones</span>

        <span class="token comment">// The touched child view.</span>
        <span class="token annotation punctuation">@UnsupportedAppUsage</span>
        <span class="token keyword">public</span> <span class="token class-name">View</span> child<span class="token punctuation">;</span>

        <span class="token comment">// The combined bit mask of pointer ids for all pointers captured by the target.</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> pointerIdBits<span class="token punctuation">;</span>

        <span class="token comment">// The next target in the target list.</span>
        <span class="token keyword">public</span> <span class="token class-name">TouchTarget</span> next<span class="token punctuation">;</span>

</code></pre> 
<p>分析4</p> 
<blockquote> 
 <p><strong>ViewGroup的子View消费了ACTION_DOWN事件后，ViewGroup对后续事件的处理</strong><br> 这里的处理逻辑在代码里的注释了做了详细的说明，这里就不再赘述了。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ViewGroup</span><span class="token operator">:</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> ev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// Dispatch to touch targets.</span>
 			<span class="token comment">// 由之前的分析可知，当ViewGroup中的一子View消费了事件后，mFirstTouchTarget </span>
 			<span class="token comment">//不在为空，故将执行else</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mFirstTouchTarget <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// No touch targets so treat this as an ordinary view.</span>
                handled <span class="token operator">=</span> <span class="token function">dispatchTransformedTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> canceled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                        <span class="token class-name">TouchTarget</span><span class="token punctuation">.</span>ALL_POINTER_IDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//  mFirstTouchTarget != null会走到这里</span>
                <span class="token comment">// Dispatch to touch targets, excluding the new touch target if we already</span>
                <span class="token comment">// dispatched to it.  Cancel touch targets if necessary.</span>
                <span class="token class-name">TouchTarget</span> predecessor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">TouchTarget</span> target <span class="token operator">=</span> mFirstTouchTarget<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//注释1 在这里会不断从target链表里在取出target对象，（在单点触摸的时候</span>
                <span class="token comment">//只有一个对象）,</span>
                    <span class="token keyword">final</span> <span class="token class-name">TouchTarget</span> next <span class="token operator">=</span> target<span class="token punctuation">.</span>next<span class="token punctuation">;</span>  
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>alreadyDispatchedToNewTouchTarget <span class="token operator">&amp;&amp;</span> target <span class="token operator">==</span> newTouchTarget<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        handled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">final</span> <span class="token keyword">boolean</span> cancelChild <span class="token operator">=</span> <span class="token function">resetCancelNextUpFlag</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
                                <span class="token operator">||</span> intercepted<span class="token punctuation">;</span>
                         <span class="token comment">// 注释2 在这里调用了dispatchTransformedTouchEvent 参数中</span>
                         <span class="token comment">// target.child传了进去，target.child是消费ACTION_DOWN事件</span>
                         <span class="token comment">// 的View ，dispatchTransformedTouchEvent 将会调用该View的</span>
                         <span class="token comment">// dispatchTouchEvent去处理事件。</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dispatchTransformedTouchEvent</span><span class="token punctuation">(</span>ev<span class="token punctuation">,</span> cancelChild<span class="token punctuation">,</span>
                                target<span class="token punctuation">.</span>child<span class="token punctuation">,</span> target<span class="token punctuation">.</span>pointerIdBits<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            handled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>cancelChild<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>predecessor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                mFirstTouchTarget <span class="token operator">=</span> next<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                predecessor<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">// 对target做回收，实现复用</span>
                            target<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            target <span class="token operator">=</span> next<span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    predecessor <span class="token operator">=</span> target<span class="token punctuation">;</span>
                    target <span class="token operator">=</span> next<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span>
        
        <span class="token keyword">return</span> handled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre> 
<p><strong>2. View中的分发</strong><br> <strong>2.1</strong><br> 在View的dispatchTouchEvent有以下流程：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">View</span><span class="token operator">:</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> ev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If the event should be handled by accessibility focus first.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">isTargetAccessibilityFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// We don't have focus or no virtual descendant has it, do not handle the event.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAccessibilityFocusedViewOrHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// We have focus and got the event, then use normal event dispatch.</span>
            event<span class="token punctuation">.</span><span class="token function">setTargetAccessibilityFocus</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInputEventConsistencyVerifier <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mInputEventConsistencyVerifier<span class="token punctuation">.</span><span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> actionMasked <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getActionMasked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_DOWN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Defensive cleanup for new gesture</span>
            <span class="token function">stopNestedScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// //如果窗口没有被遮盖  注释1 具体分析见下文</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">onFilterTouchEventForSecurity</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> ENABLED_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> ENABLED <span class="token operator">&amp;&amp;</span> <span class="token function">handleScrollBarDragging</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//noinspection SimplifiableIfStatement</span>
            <span class="token class-name">ListenerInfo</span> li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnTouchListener <span class="token operator">!=</span> <span class="token keyword">null</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> ENABLED_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> ENABLED
                    <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnTouchListener<span class="token punctuation">.</span><span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result <span class="token operator">&amp;&amp;</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result <span class="token operator">&amp;&amp;</span> mInputEventConsistencyVerifier <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mInputEventConsistencyVerifier<span class="token punctuation">.</span><span class="token function">onUnhandledEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Clean up after nested scrolls if this is the end of a gesture;</span>
        <span class="token comment">// also cancel it if we tried an ACTION_DOWN but we didn't want the rest</span>
        <span class="token comment">// of the gesture.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_UP <span class="token operator">||</span>
                actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_CANCEL <span class="token operator">||</span>
                <span class="token punctuation">(</span>actionMasked <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_DOWN <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">stopNestedScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>下面的代码是对上文代码注释1处的截取</p> 
<blockquote> 
 <p>从下下面代码的注释1可以看得出上面代码我们可以看到View会先判断是否设置了OnTouchListener，如果设置了OnTouchListener并且onTouch方法返回了true，那么onTouchEvent不会被调用。当没有设置OnTouchListener或者设置了OnTouchListener但是onTouch方法返回false则会调用View自己的onTouchEvent方法。</p> 
</blockquote> 
<pre><code class="prism language-java">        <span class="token comment">//如果窗口没有被遮盖</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">onFilterTouchEventForSecurity</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> ENABLED_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> ENABLED <span class="token operator">&amp;&amp;</span> <span class="token function">handleScrollBarDragging</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//noinspection SimplifiableIfStatement</span>
            <span class="token comment">//当前监听事件</span>
            <span class="token class-name">ListenerInfo</span> li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>
            <span class="token comment">//需要特别注意这个判断当中的li.mOnTouchListener.onTouch(this, event)条件 //注释1</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnTouchListener <span class="token operator">!=</span> <span class="token keyword">null</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> ENABLED_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> ENABLED
                    <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnTouchListener<span class="token punctuation">.</span><span class="token function">onTouch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//result为false调用自己的onTouchEvent方法处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result <span class="token operator">&amp;&amp;</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p><strong>2.2</strong><br> 接下来看onTouchEvent方法。</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">View</span><span class="token operator">:</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">float</span> x <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">float</span> y <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> viewFlags <span class="token operator">=</span> mViewFlags<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> action <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//1.如果View是设置成不可用的（DISABLED）仍然会消费点击事件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> ENABLED_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> DISABLED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_UP <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_PRESSED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">setPressed</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// A disabled view that is clickable still consumes the touch</span>
            <span class="token comment">// events, it just doesn't respond to them.</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> CLICKABLE<span class="token punctuation">)</span> <span class="token operator">==</span> CLICKABLE
                    <span class="token operator">||</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> LONG_CLICKABLE<span class="token punctuation">)</span> <span class="token operator">==</span> LONG_CLICKABLE<span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> CONTEXT_CLICKABLE<span class="token punctuation">)</span> <span class="token operator">==</span> CONTEXT_CLICKABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//2.CLICKABLE 和LONG_CLICKABLE只要有一个为true就消费这个事件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> CLICKABLE<span class="token punctuation">)</span> <span class="token operator">==</span> CLICKABLE <span class="token operator">||</span>
                <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> LONG_CLICKABLE<span class="token punctuation">)</span> <span class="token operator">==</span> LONG_CLICKABLE<span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token punctuation">(</span>viewFlags <span class="token operator">&amp;</span> CONTEXT_CLICKABLE<span class="token punctuation">)</span> <span class="token operator">==</span> CONTEXT_CLICKABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_UP<span class="token operator">:</span>
                    <span class="token keyword">boolean</span> prepressed <span class="token operator">=</span> <span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_PREPRESSED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_PRESSED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> prepressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// take focus if we don't have it already and we should in</span>
                        <span class="token comment">// touch mode.</span>
                        <span class="token keyword">boolean</span> focusTaken <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFocusableInTouchMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFocused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            focusTaken <span class="token operator">=</span> <span class="token function">requestFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prepressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// The button is being released before we actually</span>
                            <span class="token comment">// showed it as pressed.  Make it show the pressed</span>
                            <span class="token comment">// state now (before scheduling the click) to ensure</span>
                            <span class="token comment">// the user sees it.</span>
                            <span class="token function">setPressed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHasPerformedLongPress <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mIgnoreNextUpEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// This is a tap, so remove the longpress check</span>
                            <span class="token function">removeLongPressCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token comment">// Only perform take click actions if we were in the pressed state</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>focusTaken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// Use a Runnable and post this rather than calling</span>
                                <span class="token comment">// performClick directly. This lets other visual state</span>
                                <span class="token comment">// of the view update before click actions start.</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPerformClick <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    mPerformClick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">post</span><span class="token punctuation">(</span>mPerformClick<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//3.在ACTION_UP方法发生时会触发performClick()方法</span>
                                    <span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>2.3</strong><br> <strong>View事件方法执行顺序</strong><br> <strong>onTouchListener &gt; onTouchEvent &gt; onLongClickListener &gt; onClickListener</strong><br> 上文对onTouchListener 和onTouchEvent 的处理做了简单的分析，接下来分析 onLongClickListener 和 onClickListener</p> 
<p><strong>onLongClickListener</strong></p> 
<blockquote> 
 <p>长按事件可以分解为 按下 和 抬起 两个步骤，先在ACTION_DOWN事件里找找。具体分析见注释。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">case</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_DOWN<span class="token operator">:</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token comment">//mHasPerformedLongPress用于标记是否已经长按</span>
		mHasPerformedLongPress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clickable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token function">checkForLongClick</span><span class="token punctuation">(</span>
           		<span class="token comment">// ViewConfiguration.getLongPressTimeout 方法可以获取到长按触发所需的时间，默认是500ms。</span>
                <span class="token class-name">ViewConfiguration</span><span class="token punctuation">.</span><span class="token function">getLongPressTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                x<span class="token punctuation">,</span>
                y<span class="token punctuation">,</span>
                TOUCH_GESTURE_CLASSIFIED__CLASSIFICATION__LONG_PRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>接下来分析checkForLongClick方法<br> 完成了相关的设置后把 mPendingCheckForLongPress延迟一段时间（delay）再发送出去，这里使用了Handel（改日写一篇handler的文章）， postDelayed(mPendingCheckForLongPress, delay)的第一个参数是一定延时后执行的任务，第二个参数是延时。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkForLongClick</span><span class="token punctuation">(</span><span class="token keyword">long</span> delay<span class="token punctuation">,</span> <span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> classification<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> LONG_CLICKABLE<span class="token punctuation">)</span> <span class="token operator">==</span> LONG_CLICKABLE <span class="token operator">||</span> <span class="token punctuation">(</span>mViewFlags <span class="token operator">&amp;</span> TOOLTIP<span class="token punctuation">)</span> <span class="token operator">==</span> TOOLTIP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mHasPerformedLongPress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingCheckForLongPress <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mPendingCheckForLongPress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckForLongPress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mPendingCheckForLongPress<span class="token punctuation">.</span><span class="token function">setAnchor</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPendingCheckForLongPress<span class="token punctuation">.</span><span class="token function">rememberWindowAttachCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPendingCheckForLongPress<span class="token punctuation">.</span><span class="token function">rememberPressedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPendingCheckForLongPress<span class="token punctuation">.</span><span class="token function">setClassification</span><span class="token punctuation">(</span>classification<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//1</span>
            <span class="token function">postDelayed</span><span class="token punctuation">(</span>mPendingCheckForLongPress<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>CheckForLongPress 类实现了run方法，那么在消息发出的500毫秒后将会执行run该run方法</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CheckForLongPress</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mOriginalPressedState <span class="token operator">==</span> <span class="token function">isPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mParent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> mOriginalWindowAttachCount <span class="token operator">==</span> mWindowAttachCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">recordGestureClassification</span><span class="token punctuation">(</span>mClassification<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//1</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">performLongClick</span><span class="token punctuation">(</span>mX<span class="token punctuation">,</span> mY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//注意这里</span>
                	<span class="token comment">//2</span>
                    mHasPerformedLongPress <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>观察代码发现，在onLongClickListener 发送的延时消息中，在回调onLongClick()方法之前的一系列调用中都没有进行判断，也就是说只要这个callback没有被移除，在指定时间之后肯定要回调onLongClick()方法,所以说有这种状况当我么长按了490ms时还未达到500ms，这时候手指抬分发ACTION_UP事件，同时移除hander机制中消息队列中onLongClickListener 发送的延时消息，那么当时间到达500ms时onLongClickListener 并不会得到执行。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">performLongClick</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mLongClickX <span class="token operator">=</span> x<span class="token punctuation">;</span>
        mLongClickY <span class="token operator">=</span> y<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> handled <span class="token operator">=</span> <span class="token function">performLongClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLongClickX <span class="token operator">=</span> <span class="token class-name">Float<span class="token punctuation">.</span>NaN</span><span class="token punctuation">;</span>
        mLongClickY <span class="token operator">=</span> <span class="token class-name">Float<span class="token punctuation">.</span>NaN</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> handled<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">performLongClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">performLongClickInternal</span><span class="token punctuation">(</span>mLongClickX<span class="token punctuation">,</span> mLongClickY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">performLongClickInternal</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">sendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>TYPE_VIEW_LONG_CLICKED<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> handled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ListenerInfo</span> li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnLongClickListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//1</span>
            handled <span class="token operator">=</span> li<span class="token punctuation">.</span>mOnLongClickListener<span class="token punctuation">.</span><span class="token function">onLongClick</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> handled<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<blockquote> 
 <p>查看View 的onTouchEvent方法中case ： ACTION_UP的情况： 确实有点击时发送的延时消息进行了移除。<br> 若没有进行移除，表明点击的时间大于了500ms则会先检查有没有长按事件的监听，再执行onLongClick。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHasPerformedLongPress <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mIgnoreNextUpEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// This is a tap, so remove the longpress check</span>
    <span class="token function">removeLongPressCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//移除长按的callback</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>focusTaken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPerformClick <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mPerformClick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">post</span><span class="token punctuation">(</span>mPerformClick<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>onClickListener</strong></p> 
<blockquote> 
 <p>在View的onTouchEvent中的case ACTION_UP中有对onClickListener的处理，具体分析见源码中的注释</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token class-name">View</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	
 	<span class="token keyword">case</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_UP<span class="token operator">:</span>
                    <span class="token keyword">boolean</span> prepressed <span class="token operator">=</span> <span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_PREPRESSED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_PRESSED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> prepressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// take focus if we don't have it already and we should in</span>
                        <span class="token comment">// touch mode.</span>
                        <span class="token keyword">boolean</span> focusTaken <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFocusableInTouchMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFocused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            focusTaken <span class="token operator">=</span> <span class="token function">requestFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prepressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// The button is being released before we actually</span>
                            <span class="token comment">// showed it as pressed.  Make it show the pressed</span>
                            <span class="token comment">// state now (before scheduling the click) to ensure</span>
                            <span class="token comment">// the user sees it.</span>
                            <span class="token function">setPressed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHasPerformedLongPress <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mIgnoreNextUpEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// This is a tap, so remove the longpress check</span>
                            <span class="token function">removeLongPressCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token comment">// Only perform take click actions if we were in the pressed state</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>focusTaken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// Use a Runnable and post this rather than calling</span>
                                <span class="token comment">// performClick directly. This lets other visual state</span>
                                <span class="token comment">// of the view update before click actions start.</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPerformClick <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   
                              <span class="token comment">//在这里可以看到new 出了一个PerformClick，在后面的中又通过post将他post到handler</span>
                              <span class="token comment">//中，所以想都不用想 PerformClick继承自Runable 实现了run方法</span>
                                    mPerformClick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment">// 在这里通过无延迟的post的方法将PerformClick psot到主线程处理</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">post</span><span class="token punctuation">(</span>mPerformClick<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                              
                                    <span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<blockquote> 
 <p>进入到 PerformClick类中瞧瞧</p> 
</blockquote> 
<pre><code class="prism language-java">   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PerformClick</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">recordGestureClassification</span><span class="token punctuation">(</span>TOUCH_GESTURE_CLASSIFIED__CLASSIFICATION__SINGLE_TAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">performClickInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//在run方法里面执行了 performClickInternal</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">performClickInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Must notify autofill manager before performing the click actions to avoid scenarios where</span>
        <span class="token comment">// the app has a click listener that changes the state of views the autofill service might</span>
        <span class="token comment">// be interested on.</span>
        <span class="token function">notifyAutofillManagerOnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//performClickInternal中又调用了 performClick </span>
        <span class="token keyword">return</span> <span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<blockquote> 
 <p>在performClick中我们可以清晰的看到对OnClickListener 进行了处理</p> 
</blockquote> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// We still need to call this method to handle the cases where performClick() was called</span>
        <span class="token comment">// externally, instead of through performClickInternal()</span>
        <span class="token function">notifyAutofillManagerOnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> result<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ListenerInfo</span> li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnClickListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">playSoundEffect</span><span class="token punctuation">(</span><span class="token class-name">SoundEffectConstants</span><span class="token punctuation">.</span>CLICK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 在这里调用了onClick事件</span>
            li<span class="token punctuation">.</span>mOnClickListener<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">sendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>TYPE_VIEW_CLICKED<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">notifyEnterOrExitForAutoFillIfNeeded</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>回到在View的onTouchEvent中的case ACTION_UP的源码（如下）：细心的人可能已经发现了，通过上面的 在 注意这里 1 post消息 中最后还是调用 performClick来调用onClick的处理，在 注意这里 2 中当 post不成功时，直接调用performClick 对消进行处理，那么为什不能在上面直接调用performClick进行处理，非要大费周章的使用handler机制来处理呢？？哈哈在上面的英文注释中已经说明了很清楚了：Use a Runnable and post this rather than calling<br> performClick directly. This lets other visual stateof the view update before click actions start.说白了 就是怕这个performClick处理的 太久影响了view视图的更新。</p> 
<pre><code class="prism language-java"><span class="token class-name">View</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	
 	<span class="token keyword">case</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span>ACTION_UP<span class="token operator">:</span>
                    <span class="token keyword">boolean</span> prepressed <span class="token operator">=</span> <span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_PREPRESSED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mPrivateFlags <span class="token operator">&amp;</span> PFLAG_PRESSED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> prepressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// take focus if we don't have it already and we should in</span>
                        <span class="token comment">// touch mode.</span>
                        <span class="token keyword">boolean</span> focusTaken <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFocusableInTouchMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFocused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            focusTaken <span class="token operator">=</span> <span class="token function">requestFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prepressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// The button is being released before we actually</span>
                            <span class="token comment">// showed it as pressed.  Make it show the pressed</span>
                            <span class="token comment">// state now (before scheduling the click) to ensure</span>
                            <span class="token comment">// the user sees it.</span>
                            <span class="token function">setPressed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHasPerformedLongPress <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mIgnoreNextUpEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// This is a tap, so remove the longpress check</span>
                            <span class="token function">removeLongPressCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token comment">// Only perform take click actions if we were in the pressed state</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>focusTaken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token comment">// Use a Runnable and post this rather than calling</span>
                                <span class="token comment">// performClick directly. This lets other visual state</span>
                                <span class="token comment">// of the view update before click actions start.</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPerformClick <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   
                              <span class="token comment">//在这里可以看到new 出了一个PerformClick，在后面的中又通过post将他post到handler</span>
                              <span class="token comment">//中，所以想都不用想 PerformClick继承自Runable 实现了run方法</span>
                                    mPerformClick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment">// 在这里通过无延迟的post的方法将PerformClick psot到主线程处理</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">post</span><span class="token punctuation">(</span>mPerformClick<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  注意这里 <span class="token number">1</span>
                              
                                    <span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     注意这里 <span class="token number">2</span> 
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<blockquote> 
 <p>简单总结一下 onLongClickListener 和 onClickListener的处理过程：当ACTION_DOWN到达一个view后，他会想通过handler post一个500ms消息（我称之为长按消息）给主线程，这个消息里面封装着LongClickListener的处理任务，如果在500ms之内收到了ACTION_UP事件，则首先会移除掉主线程消息队列中的长按消息，然后去执行onClickListener对Click的执行逻辑，因为主线程中长按消息已经被移除，所以500ms后不会执行LongClick的任务。</p> 
</blockquote> 
<h2>
<a id="_909"></a>结语</h2> 
<p>android的事件分发流程分析到这里就结束了，因为时间和我自己技术还是很浅薄的原因，这篇文章里难免会有些错误的地方，我欢迎大家给我指出来，我们共同进步</p> 
<p>同时写这个博客的时候参考很多优秀的博客和书籍，在这里向各位作者表示感谢，我也只是站在前人的肩膀上。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>