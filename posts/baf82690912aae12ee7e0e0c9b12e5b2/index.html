<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>kafka整理 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">kafka整理</h1>
			
		</header>
		<div class="content post__content clearfix">
			


        
                <div id="content_views" class="markdown_views prism-atom-one-dark">
                    
                        
                    
                    <h2>
<a id="kafka_0"></a><strong>kafka整理</strong>
</h2> 
<h4>
<a id="kafka_2"></a>一、kafka概述</h4> 
<p>kafka是apache旗下一款开源的顶级的消息队列的系统, 最早是来源于领英, 后期将其贡献给apache, 采用语言是scala.基于zookeeper, 启动kafka集群需要先启动zookeeper集群, 同时在zookeeper记录kafka相关的元数据</p> 
<p>kafka本质上就是消息队列的中间件产品 ,kafka中消息数据是直接存储在磁盘上</p> 
<p>kafka的特点:</p> 
<ol>
<li>可靠性</li>
<li>可扩展性</li>
<li>耐用性</li>
<li>高性能</li>
</ol> 
<h2>
<a id="kafka_15"></a>二、kafka的架构图</h2> 
<p><img src="https://images2.imgbox.com/78/f8/kYWpk7cu_o.png" alt="在这里插入图片描述"></p> 
<p>kafka cluster ：kafka的集群<br> broker：kafka的节点<br> producer：生产者<br> consumer：消费者<br> topic：主题，一个逻辑容器<br> shard：分片，分片的数量<br> replicas：副本，受节点的限制，副本&lt;=节点数<br> zookeeper:对kafka集群进行管理，保存kafka的元数据信息</p> 
<h2>
<a id="_27"></a>三、安装</h2> 
<h2>
<a id="31_29"></a>3.1解压</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/software]</span><span class="token variable">$tar</span> <span class="token operator">-</span>zxvf kafka_2<span class="token punctuation">.</span>12-2<span class="token punctuation">.</span>4<span class="token punctuation">.</span>1<span class="token punctuation">.</span>tgz  <span class="token operator">-</span>C <span class="token operator">/</span>opt/app/
</code></pre> 
<h2>
<a id="32_35"></a>3.2建软连接</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app]</span><span class="token variable">$ln</span> <span class="token operator">-</span>s kafka_2<span class="token punctuation">.</span>12-2<span class="token punctuation">.</span>4<span class="token punctuation">.</span>1 kafka
</code></pre> 
<h2>
<a id="33_serverproperties_41"></a>3.3修改 server.properties</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app/kafka/config]</span><span class="token variable">$vim</span> server<span class="token punctuation">.</span>properties 
</code></pre> 
<h2>
<a id="34_47"></a>3.4启动与停止</h2> 
<pre><code class="prism language-powershell">前台启动: 
    <span class="token punctuation">.</span><span class="token operator">/</span>kafka-server-<span class="token function">start</span><span class="token punctuation">.</span>sh <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>config/server<span class="token punctuation">.</span>properties
后台启动: 
    nohup  <span class="token punctuation">.</span><span class="token operator">/</span>kafka-server-<span class="token function">start</span><span class="token punctuation">.</span>sh <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>config/server<span class="token punctuation">.</span>properties 2&gt;&amp;1 &amp;
注意: 第一次启动<span class="token punctuation">,</span> 建议先前台启动<span class="token punctuation">,</span> 观察是否可以正常启动<span class="token punctuation">,</span> 如果OK<span class="token punctuation">,</span> ctrl <span class="token operator">+</span>C 退出<span class="token punctuation">,</span> 然后挂载到后台
启动: <span class="token punctuation">.</span><span class="token operator">/</span><span class="token function">start-kafka</span><span class="token punctuation">.</span>sh 
</code></pre> 
<h2>
<a id="shell_58"></a>四、shell命令操作</h2> 
<h2>
<a id="41top_60"></a>4.1创建top</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh  <span class="token operator">--</span>create <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181 <span class="token operator">--</span>topic test01 <span class="token operator">--</span>partitions 3  <span class="token operator">--</span>replication-factor 2
Created topic test01<span class="token punctuation">.</span>
<span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh  <span class="token operator">--</span>create <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181 <span class="token operator">--</span>topic test02 <span class="token operator">--</span>partitions 3  <span class="token operator">--</span>replication-factor 3
Created topic test02<span class="token punctuation">.</span>
</code></pre> 
<h2>
<a id="42_topic_69"></a>4.2 查看当前有那些topic</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh <span class="token operator">--</span>list <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181
test01
test02
</code></pre> 
<h2>
<a id="43_topic_77"></a>4.3 如何查看某一个topic的详细信息</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh  <span class="token operator">--</span>describe <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181 <span class="token operator">--</span>topic test01
Topic: test01	PartitionCount: 3	ReplicationFactor: 2	Configs: 
	Topic: test01	Partition: 0	Leader: 2	Replicas: 2<span class="token punctuation">,</span>0	Isr: 2<span class="token punctuation">,</span>0
	Topic: test01	Partition: 1	Leader: 0	Replicas: 0<span class="token punctuation">,</span>1	Isr: 0<span class="token punctuation">,</span>1
	Topic: test01	Partition: 2	Leader: 1	Replicas: 1<span class="token punctuation">,</span>2	Isr: 1<span class="token punctuation">,</span>2
<span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh  <span class="token operator">--</span>describe <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181 <span class="token operator">--</span>topic test02
Topic: test02	PartitionCount: 3	ReplicationFactor: 3	Configs: 
	Topic: test02	Partition: 0	Leader: 2	Replicas: 2<span class="token punctuation">,</span>1<span class="token punctuation">,</span>0	Isr: 2<span class="token punctuation">,</span>1<span class="token punctuation">,</span>0
	Topic: test02	Partition: 1	Leader: 0	Replicas: 0<span class="token punctuation">,</span>2<span class="token punctuation">,</span>1	Isr: 0<span class="token punctuation">,</span>2<span class="token punctuation">,</span>1
	Topic: test02	Partition: 2	Leader: 1	Replicas: 1<span class="token punctuation">,</span>0<span class="token punctuation">,</span>2	Isr: 1<span class="token punctuation">,</span>0<span class="token punctuation">,</span>2
<span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh  <span class="token operator">--</span>create <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181 <span class="token operator">--</span>topic test03 <span class="token operator">--</span>partitions 3  <span class="token operator">--</span>replication-factor 1
Created topic test03<span class="token punctuation">.</span>
<span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh  <span class="token operator">--</span>describe <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181 <span class="token operator">--</span>topic test03
Topic: test03	PartitionCount: 3	ReplicationFactor: 1	Configs: 
	Topic: test03	Partition: 0	Leader: 1	Replicas: 1	Isr: 1
	Topic: test03	Partition: 1	Leader: 2	Replicas: 2	Isr: 2
	Topic: test03	Partition: 2	Leader: 0	Replicas: 0	Isr: 0
</code></pre> 
<h2>
<a id="44topic_99"></a>4.4修改topic</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh  <span class="token operator">--</span>alter <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181 <span class="token operator">--</span>topic test01 <span class="token operator">--</span>partitions 5
WARNING: <span class="token keyword">If</span> partitions are increased <span class="token keyword">for</span> a topic that has a key<span class="token punctuation">,</span> the partition logic or ordering of the messages will be affected
Adding partitions succeeded!
<span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh  <span class="token operator">--</span>describe <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181 <span class="token operator">--</span>topic test01
Topic: test01	PartitionCount: 5	ReplicationFactor: 2	Configs: 
	Topic: test01	Partition: 0	Leader: 2	Replicas: 2<span class="token punctuation">,</span>0	Isr: 2<span class="token punctuation">,</span>0
	Topic: test01	Partition: 1	Leader: 0	Replicas: 0<span class="token punctuation">,</span>1	Isr: 0<span class="token punctuation">,</span>1
	Topic: test01	Partition: 2	Leader: 1	Replicas: 1<span class="token punctuation">,</span>2	Isr: 2<span class="token punctuation">,</span>1
	Topic: test01	Partition: 3	Leader: 2	Replicas: 2<span class="token punctuation">,</span>1	Isr: 2<span class="token punctuation">,</span>1
	Topic: test01	Partition: 4	Leader: 0	Replicas: 0<span class="token punctuation">,</span>2	Isr: 0<span class="token punctuation">,</span>2
<span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$
注意：只能调大分片的数量<span class="token punctuation">,</span> 无法调小以及无法调整副本数量
</code></pre> 
<h2>
<a id="45topic_116"></a>4.5删除topic</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh <span class="token operator">--</span>delete <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181 <span class="token operator">--</span>topic test01
Topic test01 is marked <span class="token keyword">for</span> deletion<span class="token punctuation">.</span>
Note: This will have no impact <span class="token keyword">if</span> delete<span class="token punctuation">.</span>topic<span class="token punctuation">.</span>enable is not <span class="token function">set</span> to true<span class="token punctuation">.</span>
<span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-topics<span class="token punctuation">.</span>sh  <span class="token operator">--</span>describe <span class="token operator">--</span>zookeeper pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181 <span class="token operator">--</span>topic test01
Error <span class="token keyword">while</span> executing topic command : Topic <span class="token string">'test01'</span> does not exist as expected
<span class="token punctuation">[</span>2023-04-09 22:36:54<span class="token punctuation">,</span>129<span class="token punctuation">]</span> ERROR java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IllegalArgumentException: Topic <span class="token string">'test01'</span> does not exist as expected
	at kafka<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>TopicCommand$<span class="token punctuation">.</span>kafka<span class="token variable">$admin</span><span class="token variable">$TopicCommand</span>$<span class="token variable">$ensureTopicExists</span><span class="token punctuation">(</span>TopicCommand<span class="token punctuation">.</span>scala:484<span class="token punctuation">)</span>
	at kafka<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>TopicCommand<span class="token variable">$ZookeeperTopicService</span><span class="token punctuation">.</span>describeTopic<span class="token punctuation">(</span>TopicCommand<span class="token punctuation">.</span>scala:390<span class="token punctuation">)</span>
	at kafka<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>TopicCommand$<span class="token punctuation">.</span>main<span class="token punctuation">(</span>TopicCommand<span class="token punctuation">.</span>scala:67<span class="token punctuation">)</span>
	at kafka<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>TopicCommand<span class="token punctuation">.</span>main<span class="token punctuation">(</span>TopicCommand<span class="token punctuation">.</span>scala<span class="token punctuation">)</span>
 <span class="token punctuation">(</span>kafka<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>TopicCommand$<span class="token punctuation">)</span>
<span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$

</code></pre> 
<h2>
<a id="46_topic_134"></a>4.6模拟一个生产者. 用于生产数据到topic中</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-console-producer<span class="token punctuation">.</span>sh  <span class="token operator">--</span>broker-list pxj62:9092<span class="token punctuation">,</span>pxj63:9092<span class="token punctuation">,</span>pxj64:9092 <span class="token operator">--</span>topic test02
&gt;pxj
&gt;pxj
&gt;jps
&gt;ll
</code></pre> 
<h2>
<a id="47_144"></a>4.7消费者接收</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj63 /opt/app/kafka/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>kafka-console-consumer<span class="token punctuation">.</span>sh <span class="token operator">--</span>bootstrap-server pxj62:9092<span class="token punctuation">,</span>pxj63:9092<span class="token punctuation">,</span>pxj64:9092 <span class="token operator">--</span>topic test02 <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>beginning  
pxj
pxj
jps
ll
</code></pre> 
<h2>
<a id="kafkaAPI_154"></a>五、kafkaAPI</h2> 
<h2>
<a id="51_156"></a>5.1生产者</h2> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ccj<span class="token punctuation">.</span>pxj<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">Producer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerTest</span> <span class="token punctuation">{<!-- --></span>


        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1- 创建  生产者对象</span>
            <span class="token comment">// 1.1 设置生产者相关的配置</span>
            <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>"bootstrap<span class="token punctuation">.</span>servpackage com<span class="token punctuation">.</span>ccj<span class="token punctuation">.</span>pxj<span class="token punctuation">.</span>kafka<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 创建 kafka的消费者对象</span>
        <span class="token comment">//1.1: 设置消费者的配置信息</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"pxj62:9092,pxj63:9092,pxj64:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定 kafka地址</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定消费组 id</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"enable.auto.commit"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 是否开启自动提交数据的偏移量</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"auto.commit.interval.ms"</span><span class="token punctuation">,</span> <span class="token string">"1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自动提交的间隔时间</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置key反序列类</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置value反序列化类</span>

        <span class="token comment">//1.2: 创建kafka消费者对象</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.设置消费者监听那些Topic</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"test02"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3. 消费数据:  一直在消费, 只要有数据,立马进行处理操作</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//3.1: 获取消息数据, 参数表示等待(超时)的时间</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 偏移量信息</span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取key</span>
                <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取value</span>
                <span class="token keyword">int</span> partition <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从哪个分区读取的数据</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"偏移量:"</span><span class="token operator">+</span> offset <span class="token operator">+</span><span class="token string">"; key值:"</span><span class="token operator">+</span>key <span class="token operator">+</span><span class="token string">";value值:"</span><span class="token operator">+</span> value <span class="token operator">+</span><span class="token string">"; 分区:"</span><span class="token operator">+</span>partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
ers<span class="token string">", "</span>pxj62<span class="token operator">:</span><span class="token number">9092</span><span class="token punctuation">,</span>pxj63<span class="token operator">:</span><span class="token number">9092</span><span class="token punctuation">,</span>pxj64<span class="token operator">:</span><span class="token number">9092</span>"<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 指定kafka的地址</span>
            props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"acks"</span><span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定消息确认方案</span>
            props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// key序列化类</span>
            props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// value序列化类</span>

            <span class="token comment">//1.2: 构建生产者</span>
            <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//2. 发送数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//2.1 构建 数据的承载对象</span>
                <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producerRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"test02"</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>producerRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//3. 释放资源</span>
            producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="52__243"></a>5.2 消费者</h2> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ccj<span class="token punctuation">.</span>pxj<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 创建 kafka的消费者对象</span>
        <span class="token comment">//1.1: 设置消费者的配置信息</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"pxj62:9092,pxj63:9092,pxj64:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定 kafka地址</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定消费组 id</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"enable.auto.commit"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 是否开启自动提交数据的偏移量</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"auto.commit.interval.ms"</span><span class="token punctuation">,</span> <span class="token string">"1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自动提交的间隔时间</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置key反序列类</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置value反序列化类</span>

        <span class="token comment">//1.2: 创建kafka消费者对象</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.设置消费者监听那些Topic</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"test02"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3. 消费数据:  一直在消费, 只要有数据,立马进行处理操作</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//3.1: 获取消息数据, 参数表示等待(超时)的时间</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 偏移量信息</span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取key</span>
                <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取value</span>
                <span class="token keyword">int</span> partition <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从哪个分区读取的数据</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"偏移量:"</span><span class="token operator">+</span> offset <span class="token operator">+</span><span class="token string">"; key值:"</span><span class="token operator">+</span>key <span class="token operator">+</span><span class="token string">";value值:"</span><span class="token operator">+</span> value <span class="token operator">+</span><span class="token string">"; 分区:"</span><span class="token operator">+</span>partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
SLF4J<span class="token operator">:</span> <span class="token class-name">Failed</span> <span class="token keyword">to</span> <span class="token namespace">load</span> <span class="token keyword">class</span> <span class="token string">"org.slf4j.impl.StaticLoggerBinder"</span><span class="token punctuation">.</span>
SLF4J<span class="token operator">:</span> <span class="token class-name">Defaulting</span> <span class="token keyword">to</span> <span class="token namespace">no</span><span class="token operator">-</span>operation <span class="token punctuation">(</span>NOP<span class="token punctuation">)</span> logger implementation
SLF4J<span class="token operator">:</span> <span class="token class-name">See</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>org<span class="token operator">/</span>codes<span class="token punctuation">.</span>html#<span class="token class-name">StaticLoggerBinder</span> <span class="token keyword">for</span> further details<span class="token punctuation">.</span>
偏移量<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span> key值<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>value值<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> 分区<span class="token operator">:</span><span class="token number">1</span>
偏移量<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span> key值<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>value值<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span> 分区<span class="token operator">:</span><span class="token number">1</span>
偏移量<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">;</span> key值<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>value值<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span> 分区<span class="token operator">:</span><span class="token number">1</span>
偏移量<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span> key值<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>value值<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">;</span> 分区<span class="token operator">:</span><span class="token number">1</span>
偏移量<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">;</span> key值<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>value值<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span> 分区<span class="token operator">:</span><span class="token number">1</span>
偏移量<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">;</span> key值<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>value值<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">;</span> 分区<span class="token operator">:</span><span class="token number">1</span>
偏移量<span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">;</span> key值<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>value值<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">;</span> 分区<span class="token operator">:</span><span class="token number">1</span>
偏移量<span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">;</span> key值<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>value值<span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">;</span> 分区<span class="token operator">:</span><span class="token number">1</span>
偏移量<span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">;</span> key值<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>value值<span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">;</span> 分区<span class="token operator">:</span><span class="token number">1</span>
偏移量<span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">;</span> key值<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>value值<span class="token operator">:</span><span class="token number">9</span><span class="token punctuation">;</span> 分区<span class="token operator">:</span><span class="token number">1</span>

</code></pre> 
<h2>
<a id="kafka_304"></a>六、kafka的核心原理</h2> 
<h2>
<a id="61kafka_306"></a>6.1kafka的分区和副本</h2> 
<p>分区：</p> 
<pre><code class="prism language-powershell">	topic可以理解为是一个大的容器<span class="token punctuation">(</span>逻辑<span class="token punctuation">)</span><span class="token punctuation">,</span> 分片相当于将topic划分为多个小容器<span class="token punctuation">,</span> 将这些小容器分布在不同的broker上<span class="token punctuation">,</span> 进行分布式存储<span class="token punctuation">,</span> 分片的数量不受节点数量限制

作用:
	1- 提升吞吐量<span class="token punctuation">,</span> 前提 kafka节点充足下
	2- 解决单台节点存储有限的问题<span class="token punctuation">,</span> 可以通过分片实现分布式存储
	3- 提高并发能力
</code></pre> 
<p>副本：</p> 
<pre><code class="prism language-powershell">对topic中每一个分片构建多个副本<span class="token punctuation">,</span> 从而保证数据不能丢失<span class="token punctuation">,</span> 副本的数量最多与节点数量是相等<span class="token punctuation">,</span> 一般来说副本为 1~3个
作用:
	提升数据可靠性<span class="token punctuation">,</span> 防止数据丢失
</code></pre> 
<h2>
<a id="62kafka_326"></a>6.2kafka数据传输过程</h2> 
<pre><code class="prism language-powershell">三阶段：
第一阶段：生产者将数据生产到集群的broket端
第二阶段：broker将数据存储
第三阶段：消费者从broker端消费数据
6<span class="token punctuation">.</span>3生产者如何保证数据不丢失
对于kafka，主要采用ack认证机制处理的
0：生产者只管发送到broket端，不管broker的响应
1：生产者只管发送到broket端，需要等待对应接受分片的主副本接收到数据后，给予响应，认为数据发送成功
<span class="token operator">-</span>1:ALL；生产者只管发送到broket端，需要等待对应接受分片所有的 副本接收到数据后，给予响应认为数据发送成功
效率：0&gt;1&gt;<span class="token operator">-</span>1
安全：<span class="token operator">-</span>1&gt;1&gt;0
ack模式的选择：根据生产需求确定，
props<span class="token punctuation">.</span>put<span class="token punctuation">(</span>“acks”<span class="token punctuation">,</span><span class="token string">''</span>all<span class="token string">''</span><span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="63broker_344"></a>6.3如果broker端迟迟没有给予响应，如何解决</h2> 
<pre><code class="prism language-powershell">采用先等待（超时时间）再重试的策略，一般重试3次，如果重试后依然没有给予响应，此时让程序直接报错。通知相关人员处理即可
6<span class="token punctuation">.</span>4宽带占用如何解决
可以引入缓存池，采用异步发送方案，生产者将数据在发送数据时候，底层会将这个数据保存到缓存池中，当池子中数据达到一批数据大小后，将达一批数据直接发送到broker，此时broker针对这一批数据给予一次性响应即可（批量发送数据）
</code></pre> 
<h2>
<a id="65_brokerbroker_352"></a>6.5 采用批量发送数据，如果发送一批数据到broker端，broker端又没有给予响应，此时缓存池中数据满了，如何解决呢？</h2> 
<pre><code class="prism language-powershell">解决方案：
1<span class="token punctuation">.</span>丢弃缓存池中数据，报异常（适用于数据不重要，或者可以重读的消息总数据）
2<span class="token punctuation">.</span>在写入缓冲池的时候，需要将数据在其他的地方也持久存储一份，发送成功一批数据，将持久化地方数据删除一部分，以保证在出现此问题后，数据依然存在，下次启动的时候，优先从持久化容器中读取即可
</code></pre> 
<p><img src="https://images2.imgbox.com/2c/b3/tkXYFXtB_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="_kafkaeagle_361"></a>七、安装 kafka-eagle</h2> 
<h2>
<a id="71_363"></a>7.1.解压</h2> 
<h2>
<a id="72_364"></a>7.2环境变量</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /home/pxj]</span><span class="token variable">$vim</span> <span class="token punctuation">.</span>bashrc 
export PS1=<span class="token string">'[u@h `pwd`]$'</span>
export JAVA_HOME=<span class="token operator">/</span>usr/java/jdk1<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0_141
export PATH=<span class="token variable">$JAVA_HOME</span><span class="token operator">/</span>bin:<span class="token variable">$PATH</span>
export HADOOP_HOME=<span class="token operator">/</span>opt/app/hadoop
export ZOOKEEPER_HOME=<span class="token operator">/</span>opt/app/zookeeper
export KAFKA_HOME=<span class="token operator">/</span>opt/app/kafka
export KE_HOME=<span class="token operator">/</span>opt/app/kafka-eagle
export PATH=$<span class="token punctuation">{<!-- --></span>HADOOP_HOME<span class="token punctuation">}</span><span class="token operator">/</span>bin:$<span class="token punctuation">{<!-- --></span>HADOOP_HOME<span class="token punctuation">}</span><span class="token operator">/</span>sbin:$<span class="token punctuation">{<!-- --></span>ZOOKEEPER_HOME<span class="token punctuation">}</span><span class="token operator">/</span>bin:$<span class="token punctuation">{<!-- --></span>KAFKA_HOME<span class="token punctuation">}</span><span class="token operator">/</span>bin:$<span class="token punctuation">{<!-- --></span>KE_HOME<span class="token punctuation">}</span><span class="token operator">/</span>bin:<span class="token variable">$PATH</span>


<span class="token namespace">[pxj@pxj62 /home/pxj]</span><span class="token variable">$source</span> <span class="token punctuation">.</span>bashrc
</code></pre> 
<h2>
<a id="73_kafka_eagle_381"></a>7.3配置 kafka_eagle。</h2> 
<p>使用vi打开conf目录下的system-config.propertie</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app/kafka-eagle/conf]</span><span class="token variable">$vim</span> system-config<span class="token punctuation">.</span>properties
kafka<span class="token punctuation">.</span>eagle<span class="token punctuation">.</span>zk<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>alias=cluster1
cluster1<span class="token punctuation">.</span>zk<span class="token punctuation">.</span>list=pxj62:2181<span class="token punctuation">,</span>pxj63:2181<span class="token punctuation">,</span>pxj64:2181
<span class="token comment">#cluster2.zk.list=xdn10:2181,xdn11:2181,xdn12:2181</span>
<span class="token comment"># kafka metrics, 30 days by default</span>
<span class="token comment">######################################</span>
kafka<span class="token punctuation">.</span>eagle<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>charts=true
kafka<span class="token punctuation">.</span>eagle<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>retain=30

<span class="token comment"># kafka sqlite jdbc driver address</span>
<span class="token comment">######################################</span>
<span class="token comment">#kafka.eagle.driver=org.sqlite.JDBC</span>
<span class="token comment">#kafka.eagle.url=jdbc:sqlite:/hadoop/kafka-eagle/db/ke.db</span>
<span class="token comment">#kafka.eagle.username=root</span>
<span class="token comment">#kafka.eagle.password=www.kafka-eagle.org</span>

<span class="token comment">######################################</span>
<span class="token comment"># kafka mysql jdbc driver address</span>
<span class="token comment">######################################</span>
kafka<span class="token punctuation">.</span>eagle<span class="token punctuation">.</span>driver=com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>Driver
kafka<span class="token punctuation">.</span>eagle<span class="token punctuation">.</span>url=jdbc:mysql:<span class="token operator">/</span><span class="token operator">/</span>pxj63:3306/ke?useUnicode=true&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull
kafka<span class="token punctuation">.</span>eagle<span class="token punctuation">.</span>username=root
kafka<span class="token punctuation">.</span>eagle<span class="token punctuation">.</span>password=I LOVE PXJ
</code></pre> 
<h2>
<a id="74JAVA_HOME_411"></a>7.4配置JAVA_HOME</h2> 
<pre><code class="prism language-powershell">在24行加入
export JAVA_HOME=<span class="token operator">/</span>usr/java/jdk1<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0_141
</code></pre> 
<h2>
<a id="75_418"></a>7.5授权运行</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app/kafka-eagle/bin]</span><span class="token variable">$chmod</span> <span class="token operator">+</span>x ke<span class="token punctuation">.</span>sh 
</code></pre> 
<h2>
<a id="76_424"></a>7.6启动</h2> 
<pre><code class="prism language-powershell"><span class="token namespace">[pxj@pxj62 /opt/app/kafka-eagle/bin]</span>$<span class="token punctuation">.</span><span class="token operator">/</span>ke<span class="token punctuation">.</span>sh <span class="token function">start</span>
</code></pre> 
<h2>
<a id="77web_430"></a>7.7访问web</h2> 
<pre><code class="prism language-powershell">http:<span class="token operator">/</span><span class="token operator">/</span>pxj62:8048/ke
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/39/YP9V3uK2_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="_438"></a>八、同步发送</h2> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ccj<span class="token punctuation">.</span>pxj<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerSyncTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> props<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"pxj62:9092,pxj63:9092,pxj64:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 指定kafka的地址</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"acks"</span><span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定消息确认方案</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// key序列化类</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// value序列化类</span>
    <span class="token comment">//构造生产者</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.发送数据</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span><span class="token number">10</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//            构建 数据承载对象</span>
            <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producerRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"test01"</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token string">"_02"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 使用get  其实就是同步方式, 会当发送后, 会一直等待响应, 如果长时间没有响应, 就会重试, 如果依然没有, 直接报错</span>
            <span class="token comment">// get支持自定义超时的时间</span>
            <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>producerRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token punctuation">}</span>
     producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2>
<a id="_477"></a>九、异步发送</h2> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ccj<span class="token punctuation">.</span>pxj<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerAsyncTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1- 创建  生产者对象</span>
        <span class="token comment">// 1.1 设置生产者相关的配置</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"pxj62:9092,pxj63:9092,pxj64:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 指定kafka的地址</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"acks"</span><span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定消息确认方案</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// key序列化类</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// value序列化类</span>

        <span class="token comment">//1.2: 构建生产者</span>
        <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.发送数据</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producerRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"test01"</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token string">"_22"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>producerRecord<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 此方法为回调函数的方式, 当进行异步发送的时候, 不管最终是成功了还是失败了, 都会回调此函数</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 说明有异常, 发送失败了</span>
                    <span class="token comment">// 在此处, 编写发送失败的处理业务逻辑代码</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送消息失败："</span> <span class="token operator">+</span>
                            e<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>metadata<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"异步方式发送消息结果："</span> <span class="token operator">+</span> <span class="token string">"topic-"</span> <span class="token operator">+</span>metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"|partition-"</span><span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"|offset-"</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//3. 释放资源</span>
        producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="_526"></a>十、消费者异步</h2> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ccj<span class="token punctuation">.</span>pxj<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerTest02</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> props<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 创建 kafka的消费者对象</span>
        <span class="token comment">//1.1: 设置消费者的配置信息</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"pxj62:9092,pxj63:9092,pxj64:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定 kafka地址</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定消费组 id</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"enable.auto.commit"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 是否开启自动提交数据的偏移量</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置key反序列类</span>
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置value反序列化类</span>
<span class="token comment">//创建消费者对象</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"test01"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records<span class="token operator">=</span>consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">record</span> <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 偏移量信息</span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取key</span>
                <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取value</span>
                <span class="token keyword">int</span> partition <span class="token operator">=</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从哪个分区读取的数据</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"偏移量:"</span><span class="token operator">+</span> offset <span class="token operator">+</span><span class="token string">"; key值:"</span><span class="token operator">+</span>key <span class="token operator">+</span><span class="token string">";value值:"</span><span class="token operator">+</span> value <span class="token operator">+</span><span class="token string">"; 分区:"</span><span class="token operator">+</span>partition<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 当消息消费完成后, 提交偏移量信息 : 一定不要丢失提交偏移量的代码. 否则 会造成大量的重复消费问题</span>
                consumer<span class="token punctuation">.</span><span class="token function">commitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 同步提交</span>
                consumer<span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步提交</span>
            <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2>
<a id="broker_573"></a>十一、broker端如何保证数据不丢失</h2> 
<p>broker主要将消息数据存储下来, 那么如何保证数据不丢失呢?</p> 
<pre><code class="prism language-java">多副本机制  <span class="token operator">+</span>  生产者的ack为 <span class="token operator">-</span><span class="token number">1</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/05/cc/4xSSzyd0_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">消费偏移量数据是存储在哪里呢? 
	在kafka的老版本<span class="token punctuation">(</span>kafka 0<span class="token punctuation">.</span>8x下<span class="token punctuation">)</span>是存储在zookeeper中<span class="token punctuation">,</span> 在新版本中消费者消息偏移量信息是存储在broker端<span class="token punctuation">,</span> 通过一个topic来存储的: __consumer_offset
	此topic具有50个分区<span class="token punctuation">,</span> 1个副本
</code></pre> 
<p><img src="https://images2.imgbox.com/c9/33/0w4LB2Qi_o.png" alt="在这里插入图片描述"><br> 如何修改默认的过期时间呢?</p> 
<pre><code class="prism language-powershell"><span class="token comment"># server.properties的103行位置:  默认值为 168小时</span>
log<span class="token punctuation">.</span>retention<span class="token punctuation">.</span>hours=168

<span class="token comment"># 设置一个log文件的大小, 默认为: 1073741824 (1GB)</span>
log<span class="token punctuation">.</span>segment<span class="token punctuation">.</span>bytes=1073741824
</code></pre> 
<h2>
<a id="kafka_598"></a>十二、kafka的数据查询机制</h2> 
<p><img src="https://images2.imgbox.com/f0/a0/06NFcM12_o.png" alt="在这里插入图片描述"><br> 查询过程</p> 
<ol>
<li>先确定这条消息在那个segment片段中</li>
<li>到对应片段中找index文件, 根据offset查询消息数据在log文件的那个物理偏移量位置</li>
<li>根据从index查询到的偏移量信息, 到 log文件顺序查询(磁盘查询方式)到对应范围下数据即可</li>
</ol> 
<h2>
<a id="____605"></a>磁盘的读写分为两种读写方式: 顺序读写 和 随机读写</h2> 
<pre><code class="prism language-properties">顺序读写效率远远高于随机读写
</code></pre> 
<h2>
<a id="kafka_612"></a>十三、kafka中生产者的数据分发策略</h2> 
<p>kafka生产者数据分发策略: 指的生产者在生产数据到达broker指定topic中, 最终这条数据被topic中哪一个分片接收到了, 这就是生产者分发机制</p> 
<pre><code class="prism language-java">思考<span class="token operator">:</span> 常见的分发策略
<span class="token number">1</span><span class="token punctuation">)</span> hash策略
<span class="token number">2</span><span class="token punctuation">)</span> 轮询策略
<span class="token number">3</span><span class="token punctuation">)</span> 指定分区策略
<span class="token number">4</span><span class="token punctuation">)</span> 确定每个分区范围分发

那么kafka支持那些分发策略呢<span class="token operator">?</span> 
<span class="token number">1</span><span class="token punctuation">)</span> 粘性分区策略<span class="token punctuation">(</span>老版本<span class="token punctuation">(</span><span class="token number">2.4</span>以前<span class="token punctuation">)</span><span class="token operator">:</span> 轮询<span class="token punctuation">)</span>
<span class="token number">2</span><span class="token punctuation">)</span> hash取模策略
<span class="token number">3</span><span class="token punctuation">)</span> 指定分区策略
<span class="token number">4</span><span class="token punctuation">)</span> 自定义分区


如何设置分发策略呢<span class="token operator">?</span>  与 <span class="token class-name">ProducerRecord</span> 和 <span class="token class-name">DefaultPartitioner</span>关系很大

<span class="token number">1</span><span class="token punctuation">)</span> 粘性分区策略<span class="token punctuation">(</span>老版本<span class="token punctuation">(</span><span class="token number">2.4</span>以前<span class="token punctuation">)</span><span class="token operator">:</span> 轮询<span class="token punctuation">)</span>
	# 当生成数据时候<span class="token punctuation">,</span> 使用这个只需要传递value发送方案<span class="token punctuation">,</span> 底层走的 粘性分区策略<span class="token punctuation">(</span>老版本<span class="token punctuation">(</span><span class="token number">2.4</span>以前<span class="token punctuation">)</span><span class="token operator">:</span> 轮询<span class="token punctuation">)</span>
 	<span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	# 为什么这么说呢<span class="token operator">?</span> 原因是 <span class="token class-name">DefaultPartitioner</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		# 当 key为<span class="token keyword">null</span>的时候<span class="token punctuation">,</span> 执行  stickyPartitionCache <span class="token punctuation">(</span>粘性分区<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> stickyPartitionCache<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// hash the keyBytes to choose a partition</span>
        <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token number">2</span><span class="token punctuation">)</span> hash取模策略
	# 当发送数据的时候<span class="token punctuation">,</span> 如果传递 k 和 v <span class="token punctuation">,</span> 默认使用 hash取模分区方案<span class="token punctuation">,</span> 根据key进行hash取模
	<span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    # 为什么这么说呢<span class="token operator">?</span> 原因是 <span class="token class-name">DefaultPartitioner</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		# 当 key为<span class="token keyword">null</span>的时候<span class="token punctuation">,</span> 执行  stickyPartitionCache <span class="token punctuation">(</span>粘性分区<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> stickyPartitionCache<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        # 当key不为<span class="token keyword">null</span>的时候<span class="token punctuation">,</span> 获取topic的所有分区<span class="token punctuation">,</span> 然后根据key进行hash取模
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// hash the keyBytes to choose a partition</span>
        <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token number">3</span><span class="token punctuation">)</span> 指定分区策略
	# 当发送数据的时候<span class="token punctuation">,</span> 需要明确指出给那个partition发送数据 <span class="token operator">:</span> <span class="token class-name">ProducerRecord</span>构造
	# 分片是从<span class="token number">0</span>开始的<span class="token punctuation">,</span> 如果是三个分片<span class="token operator">:</span> <span class="token number">0</span> <span class="token number">1</span>  <span class="token number">2</span>
	<span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> partition<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    此时这种分发策略 与 defaultPartitions 没有关系了

<span class="token number">4</span><span class="token punctuation">)</span> 自定义分区策略<span class="token operator">:</span> <span class="token punctuation">(</span>抄<span class="token punctuation">.</span> 官方源码<span class="token class-name">DefaultPartitioner</span><span class="token punctuation">)</span>
	<span class="token number">4.1</span><span class="token punctuation">)</span> 创建一个类<span class="token punctuation">,</span> 实现<span class="token class-name">Partitioner</span> 接口
	<span class="token number">4.2</span><span class="token punctuation">)</span> 重写接口中的partition方法<span class="token punctuation">,</span> 返回值表示分区的编号
	<span class="token number">4.3</span><span class="token punctuation">)</span> 按照业务逻辑实现方法中分区方案
	<span class="token number">4.4</span><span class="token punctuation">)</span> 告知给kafka<span class="token punctuation">,</span> 使用新的分区方案当生产者开始发送数据<span class="token punctuation">,</span> 如果只传递了value的数据<span class="token punctuation">,</span> 此时kafka会采用粘性分区策略<span class="token punctuation">,</span> 首先会先随机的选择一个分区<span class="token punctuation">,</span> 然后尽可能的黏上这个分区<span class="token punctuation">,</span> 将这一批数据全部写入到这一个分区中<span class="token punctuation">,</span> 当下次请求再来的时候<span class="token punctuation">,</span> 重新在随机选择一个分区<span class="token punctuation">(</span>如果间隔时间比较短<span class="token punctuation">,</span> 大概率会黏住上一个分区<span class="token punctuation">)</span><span class="token punctuation">,</span> 再黏住这个分区<span class="token punctuation">,</span> 将数据写入到这个分区下<span class="token punctuation">,</span> 这种分区方案称为粘性分区策略

粘性分区是kafka2<span class="token punctuation">.</span><span class="token number">4.</span>x及以上版本支持的一种全新的分区策略 在<span class="token number">2.4</span>以下的版本中<span class="token punctuation">,</span> 采用的轮询方案

老版本轮询<span class="token operator">:</span>
	当生产者准备好一批数据后<span class="token punctuation">,</span> 将这一批数据写入到某一个topic中<span class="token punctuation">,</span> 如果采用轮询方案<span class="token punctuation">,</span> 需要将这一批数据分为多个小批次<span class="token punctuation">,</span> 分别对应不同的分片<span class="token punctuation">,</span>将各个小批次的数据发送给对应的分片下即可<span class="token punctuation">,</span> 而这种操作需要额外在一批数据上再次进行分批处理<span class="token punctuation">,</span> 导致生产效率下降<span class="token punctuation">,</span> 所以说在新版本中<span class="token punctuation">,</span> 将其替换为粘性分区
		参数<span class="token operator">:</span>	partitioner<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">:</span>
				默认值<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>internals<span class="token punctuation">.</span></span>DefaultPartitioner</span>
		通过生产者的properties对象<span class="token punctuation">,</span> 重新设置一下partitioner<span class="token punctuation">.</span><span class="token keyword">class</span> 参数即可
</code></pre> 
<p>什么是粘性分区策略:</p> 
<pre><code class="prism language-powershell">当生产者开始发送数据<span class="token punctuation">,</span> 如果只传递了value的数据<span class="token punctuation">,</span> 此时kafka会采用粘性分区策略<span class="token punctuation">,</span> 首先会先随机的选择一个分区<span class="token punctuation">,</span> 然后尽可能的黏上这个分区<span class="token punctuation">,</span> 将这一批数据全部写入到这一个分区中<span class="token punctuation">,</span> 当下次请求再来的时候<span class="token punctuation">,</span> 重新在随机选择一个分区<span class="token punctuation">(</span>如果间隔时间比较短<span class="token punctuation">,</span> 大概率会黏住上一个分区<span class="token punctuation">)</span><span class="token punctuation">,</span> 再黏住这个分区<span class="token punctuation">,</span> 将数据写入到这个分区下<span class="token punctuation">,</span> 这种分区方案称为粘性分区策略

粘性分区是kafka2<span class="token punctuation">.</span>4<span class="token punctuation">.</span>x及以上版本支持的一种全新的分区策略 在2<span class="token punctuation">.</span>4以下的版本中<span class="token punctuation">,</span> 采用的轮询方案

老版本轮询:
	当生产者准备好一批数据后<span class="token punctuation">,</span> 将这一批数据写入到某一个topic中<span class="token punctuation">,</span> 如果采用轮询方案<span class="token punctuation">,</span> 需要将这一批数据分为多个小批次<span class="token punctuation">,</span> 分别对应不同的分片<span class="token punctuation">,</span>将各个小批次的数据发送给对应的分片下即可<span class="token punctuation">,</span> 而这种操作需要额外在一批数据上再次进行分批处理<span class="token punctuation">,</span> 导致生产效率下降<span class="token punctuation">,</span> 所以说在新版本中<span class="token punctuation">,</span> 将其替换为粘性分区
</code></pre> 
<h2>
<a id="kafka_701"></a>十四、kafka的负载均衡机制</h2> 
<p><img src="https://images2.imgbox.com/50/34/uN25xBwI_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell"> 如果使用kafka模拟点对点 和 发布订阅 方式

点对点:   一个消费只能被一个消费者所接收
	让所有监听这个topic的消费者都属于同一个消费者组内即可

发布订阅:  一个消息可以被多个消费者所接收
	让所有监听这个topic的消费者都属于不同的消费者组内即可
</code></pre> 
<p><strong>作者：潘陈（pxj）</strong><br> <strong>日期：2023-04-30</strong></p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>