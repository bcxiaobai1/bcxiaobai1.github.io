<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>睿智的目标检测57——Tensorflow2 搭建YoloV5目标检测平台 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">睿智的目标检测57——Tensorflow2 搭建YoloV5目标检测平台</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    
                        
                    
                    <p></p>
<div class="toc">
 <h3>睿智的目标检测57——Tensorflow2 搭建YoloV5目标检测平台</h3>
 <ul>
<li><a href="#_2">学习前言</a></li>
<li><a href="#_5">源码下载</a></li>
<li><a href="#YoloV5_8">YoloV5改进的部分（不完全）</a></li>
<li><a href="#YoloV5_16">YoloV5实现思路</a></li>
<li>
<ul>
<li><a href="#_17">一、整体结构解析</a></li>
<li><a href="#_32">二、网络结构解析</a></li>
<li>
<ul>
<li><a href="#1Backbone_33">1、主干网络Backbone介绍</a></li>
<li><a href="#2FPN_279">2、构建FPN特征金字塔进行加强特征提取</a></li>
<li><a href="#3Yolo_Head_342">3、利用Yolo Head获得预测结果</a></li>
</ul>
   </li>
<li><a href="#_368">三、预测结果的解码</a></li>
<li>
<ul>
<li><a href="#1_369">1、获得预测框与得分</a></li>
<li><a href="#2_438">2、得分筛选与非极大抑制</a></li>
</ul>
   </li>
<li><a href="#_496">四、训练部分</a></li>
<li>
<ul>
<li><a href="#1loss_497">1、计算loss所需内容</a></li>
<li><a href="#2_500">2、正样本的匹配过程</a></li>
<li>
<ul>
<li><a href="#a_506">a、匹配先验框</a></li>
<li><a href="#b_540">b、匹配特征点</a></li>
</ul>
    </li>
<li><a href="#3Loss_550">3、计算Loss</a></li>
</ul>
  </li>
</ul>
  </li>
<li><a href="#YoloV5_661">训练自己的YoloV5模型</a></li>
<li>
<ul>
<li><a href="#_666">一、数据集的准备</a></li>
<li><a href="#_673">二、数据集的处理</a></li>
<li><a href="#_710">三、开始网络训练</a></li>
<li><a href="#_874">四、训练结果预测</a></li>
</ul>
 </li>
</ul>
</div>
<p></p> 
<h1>
<a id="_2"></a>学习前言</h1> 
<p>这个很久都没有学，最终还是决定看看，复现的是YoloV5的第5版，V5有好多版本在，作者也一直在更新，我选了这个时间的倒数第二个版本。<br> <img src="https://images2.imgbox.com/4b/fd/blWt3Qjz_o.jpg" alt="在这里插入图片描述"></p> 
<h1>
<a id="_5"></a>源码下载</h1> 
<p>https://github.com/bubbliiiing/yolov5-tf2<br> 喜欢的可以点个star噢。</p> 
<h1>
<a id="YoloV5_8"></a>YoloV5改进的部分（不完全）</h1> 
<p><strong>1、主干部分：使用了Focus网络结构，具体操作是在一张图片中每隔一个像素拿到一个值，这个时候获得了四个独立的特征层，然后将四个独立的特征层进行堆叠，此时宽高信息就集中到了通道信息，输入通道扩充了四倍</strong>。<strong>该结构在YoloV5第5版之前有所应用，最新版本中未使用。</strong></p> 
<p><strong>2、数据增强：Mosaic数据增强、Mosaic利用了四张图片进行拼接实现数据中增强，根据论文所说其拥有一个巨大的优点是丰富检测物体的背景！且在BN计算的时候一下子会计算四张图片的数据！</strong></p> 
<p><strong>3、多正样本匹配：在之前的Yolo系列里面，在训练时每一个真实框对应一个正样本，即在训练时，每一个真实框仅由一个先验框负责预测。YoloV5中为了加快模型的训练效率，增加了正样本的数量，在训练时，每一个真实框可以由多个先验框负责预测。</strong></p> 
<p><strong>以上并非全部的改进部分，还存在一些其它的改进，这里只列出来了一些我比较感兴趣，而且非常有效的改进。</strong></p> 
<h1>
<a id="YoloV5_16"></a>YoloV5实现思路</h1> 
<h2>
<a id="_17"></a>一、整体结构解析</h2> 
<p><img src="https://images2.imgbox.com/af/d0/8iTGMROC_o.png" alt="在这里插入图片描述"></p> 
<p>在学习YoloV5之前，我们需要对YoloV5所作的工作有一定的了解，这有助于我们后面去了解网络的细节。</p> 
<p><strong>和之前版本的Yolo类似，整个YoloV5可以依然可以分为三个部分，分别是Backbone，FPN以及Yolo Head</strong>。</p> 
<p><strong>Backbone可以被称作YoloV5的主干特征提取网络</strong>，<strong>根据它的结构以及之前Yolo主干的叫法，我一般叫它CSPDarknet</strong>，输入的图片首先会在CSPDarknet里面进行<strong>特征提取</strong>，提取到的特征可以被称作特征层，<strong>是输入图片的特征集合</strong>。在主干部分，我们<strong>获取了三个特征层</strong>进行下一步网络的构建，这三个特征层我称它为<strong>有效特征层</strong>。</p> 
<p><strong>FPN可以被称作YoloV5的加强特征提取网络</strong>，在主干部分获得的三个<strong>有效特征层</strong>会在这一部分进行特征融合，特征融合的目的是结合不同尺度的特征信息。在FPN部分，已经获得的<strong>有效特征层</strong>被用于继续提取特征。<strong>在YoloV5里依然使用到了Panet的结构，我们不仅会对特征进行上采样实现特征融合，还会对特征再次进行下采样实现特征融合。</strong></p> 
<p><strong>Yolo Head是YoloV5的分类器与回归器</strong>，通过CSPDarknet和FPN，我们已经可以获得三个加强过的有效特征层。每一个特征层都有宽、高和通道数，此时我们可以将<strong>特征图看作一个又一个特征点的集合</strong>，<strong>每一个特征点都有通道数个特征</strong>。Yolo Head实际上所做的工作就是<strong>对特征点进行判断</strong>，判断<strong>特征点是否有物体与其对应</strong>。与以前版本的Yolo一样，YoloV5所用的解耦头是一起的，也就是分类和回归在一个1X1卷积里实现。</p> 
<p>因此，整个YoloV5网络所作的工作就是 <strong>特征提取-特征加强-预测特征点对应的物体情况</strong>。</p> 
<h2>
<a id="_32"></a>二、网络结构解析</h2> 
<h3>
<a id="1Backbone_33"></a>1、主干网络Backbone介绍</h3> 
<p><img src="https://images2.imgbox.com/af/d0/8iTGMROC_o.png" alt="在这里插入图片描述"><br> YoloV5所使用的主干特征提取网络为CSPDarknet，它具有五个重要特点：<br> 1、使用了<strong>残差网络Residual</strong>，CSPDarknet中的残差卷积可以分为两个部分，主干部分是一次1X1的卷积和一次3X3的卷积；残差边部分不做任何处理，直接将主干的输入与输出结合。<strong>整个YoloV5的主干部分都由残差卷积构成</strong>：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">Bottleneck</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    y <span class="token operator">=</span> compose<span class="token punctuation">(</span>
            DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">if</span> shortcut<span class="token punctuation">:</span>
        y <span class="token operator">=</span> Add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> y
</code></pre> 
<p><img src="https://images2.imgbox.com/92/85/fmheFsr3_o.png" alt="在这里插入图片描述"><br> 残差网络的特点是<strong>容易优化</strong>，并且能够通过增加相当的<strong>深度来提高准确率</strong>。其内部的<strong>残差块使用了跳跃连接，缓解了在深度神经网络中增加深度带来的梯度消失问题。</strong></p> 
<p>2、使用<strong>CSPnet</strong>网络结构，CSPnet结构并不算复杂，就是将原来的残差块的堆叠进行了一个拆分，拆成左右两部分：<strong>主干部分继续进行原来的残差块的堆叠</strong>；<strong>另一部分则像一个残差边一样，经过少量处理直接连接到最后。<strong>因此可以认为</strong>CSP中存在一个大的残差边。</strong><img src="https://images2.imgbox.com/bc/d0/59WZ9PHS_o.png" alt="在这里插入图片描述" width="500"></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">C3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> num_filters<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> expansion<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    hidden_channels <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>num_filters <span class="token operator">*</span> expansion<span class="token punctuation">)</span>  <span class="token comment"># hidden channels</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    <span class="token comment">#   主干部分会对num_blocks进行循环，循环内部是残差结构。</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    x_1 <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>hidden_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv1'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    <span class="token comment">#   然后建立一个大的残差边shortconv、这个大残差边绕过了很多的残差结构</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    x_2 <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>hidden_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_blocks<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_1 <span class="token operator">=</span> Bottleneck<span class="token punctuation">(</span>x_1<span class="token punctuation">,</span> hidden_channels<span class="token punctuation">,</span> shortcut<span class="token operator">=</span>shortcut<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.m.'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    <span class="token comment">#   将大残差边再堆叠回来</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    route <span class="token operator">=</span> Concatenate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x_1<span class="token punctuation">,</span> x_2<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">#----------------------------------------------------------------#</span>
    <span class="token comment">#   最后对通道数进行整合</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    <span class="token keyword">return</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>num_filters<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv3'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
</code></pre> 
<p>3、使用了Focus网络结构，这个网络结构是在YoloV5里面使用到比较有趣的网络结构，具体操作是在一张图片中每隔一个像素拿到一个值，这个时候获得了四个独立的特征层，然后将四个独立的特征层进行堆叠，此时宽高信息就集中到了通道信息，输入通道扩充了四倍。拼接起来的特征层相对于原先的三通道变成了十二个通道，下图很好的展示了Focus结构，一看就能明白。<br> <img src="https://images2.imgbox.com/e7/80/HnQKA7eu_o.png" alt="在这里插入图片描述" width="300"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Focus</span><span class="token punctuation">(</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Focus<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">compute_output_shape</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>input_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">if</span> input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">else</span> input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">if</span> input_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">else</span> input_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">)</span>
</code></pre> 
<p>4、使用了SiLU激活函数，SiLU是Sigmoid和ReLU的改进版。SiLU具备无上界有下界、平滑、非单调的特性。SiLU在深层模型上的效果优于 ReLU。可以看做是平滑的ReLU激活函数。<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml">
     
      
       
        
         f
        
        
         (
        
        
         x
        
        
         )
        
        
         =
        
        
         x
        
        
         ⋅
        
        
         sigmoid
        
        
         (
        
        
         x
        
        
         )
        
       
       
         f(x) = x · text{sigmoid}(x) 
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault" style="margin-right: 0.10764em">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em"></span></span><span class="base"><span class="strut" style="height: 1em;vertical-align: -0.25em"></span><span class="mord mathdefault">x</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right: 0.166667em"></span><span class="mord text"><span class="mord">sigmoid</span></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span></span></span><br> <img src="https://images2.imgbox.com/8c/b4/iBub44aN_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SiLU</span><span class="token punctuation">(</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SiLU<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>supports_masking <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> inputs <span class="token operator">*</span> K<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_config</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        config <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>SiLU<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_config<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> config

    <span class="token keyword">def</span> <span class="token function">compute_output_shape</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> input_shape
</code></pre> 
<p>5、使用了SPP结构，通过不同池化核大小的最大池化进行特征提取，提高网络的感受野。在YoloV4中，SPP是用在FPN里面的，在YoloV5中，SPP模块被用在了主干特征提取网络中。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">SPPBottleneck</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#---------------------------------------------------#</span>
    <span class="token comment">#   使用了SPP结构，即不同尺度的最大池化后堆叠。</span>
    <span class="token comment">#---------------------------------------------------#</span>
    x <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>out_channels <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv1'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    maxpool1 <span class="token operator">=</span> MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    maxpool2 <span class="token operator">=</span> MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    maxpool3 <span class="token operator">=</span> MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Concatenate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> maxpool1<span class="token punctuation">,</span> maxpool2<span class="token punctuation">,</span> maxpool3<span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> x
</code></pre> 
<p>整个主干实现代码为：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps

<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras <span class="token keyword">import</span> backend <span class="token keyword">as</span> K
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>initializers <span class="token keyword">import</span> RandomNormal
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> <span class="token punctuation">(</span>Add<span class="token punctuation">,</span> BatchNormalization<span class="token punctuation">,</span> Concatenate<span class="token punctuation">,</span>
                                     Conv2D<span class="token punctuation">,</span> Layer<span class="token punctuation">,</span> MaxPooling2D<span class="token punctuation">,</span>
                                     ZeroPadding2D<span class="token punctuation">)</span>
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>regularizers <span class="token keyword">import</span> l2
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>utils <span class="token keyword">import</span> compose


<span class="token keyword">class</span> <span class="token class-name">SiLU</span><span class="token punctuation">(</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SiLU<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>supports_masking <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> inputs <span class="token operator">*</span> K<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_config</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        config <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>SiLU<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>get_config<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> config

    <span class="token keyword">def</span> <span class="token function">compute_output_shape</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> input_shape

<span class="token keyword">class</span> <span class="token class-name">Focus</span><span class="token punctuation">(</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Focus<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">compute_output_shape</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>input_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">if</span> input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">else</span> input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">if</span> input_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">else</span> input_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">)</span>

<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   单次卷积DarknetConv2D</span>
<span class="token comment">#   如果步长为2则自己设定padding方式。</span>
<span class="token comment">#------------------------------------------------------#</span>
<span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>Conv2D<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">DarknetConv2D</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    darknet_conv_kwargs <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'kernel_initializer'</span> <span class="token punctuation">:</span> RandomNormal<span class="token punctuation">(</span>stddev<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'kernel_regularizer'</span> <span class="token punctuation">:</span> l2<span class="token punctuation">(</span>kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'weight_decay'</span><span class="token punctuation">,</span> <span class="token number">5e-4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    darknet_conv_kwargs<span class="token punctuation">[</span><span class="token string">'padding'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'valid'</span> <span class="token keyword">if</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'strides'</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'same'</span>   
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">del</span> kwargs<span class="token punctuation">[</span><span class="token string">'weight_decay'</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    darknet_conv_kwargs<span class="token punctuation">.</span>update<span class="token punctuation">(</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> Conv2D<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>darknet_conv_kwargs<span class="token punctuation">)</span>

<span class="token comment">#---------------------------------------------------#</span>
<span class="token comment">#   卷积块 -&gt; 卷积 + 标准化 + 激活函数</span>
<span class="token comment">#   DarknetConv2D + BatchNormalization + SiLU</span>
<span class="token comment">#---------------------------------------------------#</span>
<span class="token keyword">def</span> <span class="token function">DarknetConv2D_BN_SiLU</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    no_bias_kwargs <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'use_bias'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
    no_bias_kwargs<span class="token punctuation">.</span>update<span class="token punctuation">(</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"name"</span> <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        no_bias_kwargs<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.conv'</span>
    <span class="token keyword">return</span> compose<span class="token punctuation">(</span>
        DarknetConv2D<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>no_bias_kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
        BatchNormalization<span class="token punctuation">(</span>momentum <span class="token operator">=</span> <span class="token number">0.97</span><span class="token punctuation">,</span> epsilon <span class="token operator">=</span> <span class="token number">0.001</span><span class="token punctuation">,</span> name <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.bn'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        SiLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">Bottleneck</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">5e-4</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    y <span class="token operator">=</span> compose<span class="token punctuation">(</span>
            DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">if</span> shortcut<span class="token punctuation">:</span>
        y <span class="token operator">=</span> Add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> y

<span class="token keyword">def</span> <span class="token function">C3</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> num_filters<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> expansion<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">5e-4</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    hidden_channels <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>num_filters <span class="token operator">*</span> expansion<span class="token punctuation">)</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    <span class="token comment">#   主干部分会对num_blocks进行循环，循环内部是残差结构。</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    x_1 <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>hidden_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv1'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    <span class="token comment">#   然后建立一个大的残差边shortconv、这个大残差边绕过了很多的残差结构</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    x_2 <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>hidden_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_blocks<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_1 <span class="token operator">=</span> Bottleneck<span class="token punctuation">(</span>x_1<span class="token punctuation">,</span> hidden_channels<span class="token punctuation">,</span> shortcut<span class="token operator">=</span>shortcut<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.m.'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    <span class="token comment">#   将大残差边再堆叠回来</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    route <span class="token operator">=</span> Concatenate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x_1<span class="token punctuation">,</span> x_2<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">#----------------------------------------------------------------#</span>
    <span class="token comment">#   最后对通道数进行整合</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    <span class="token keyword">return</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>num_filters<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv3'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">SPPBottleneck</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">5e-4</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#---------------------------------------------------#</span>
    <span class="token comment">#   使用了SPP结构，即不同尺度的最大池化后堆叠。</span>
    <span class="token comment">#---------------------------------------------------#</span>
    x <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>out_channels <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv1'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    maxpool1 <span class="token operator">=</span> MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    maxpool2 <span class="token operator">=</span> MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    maxpool3 <span class="token operator">=</span> MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'same'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Concatenate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> maxpool1<span class="token punctuation">,</span> maxpool2<span class="token punctuation">,</span> maxpool3<span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.cv2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> x
    
<span class="token keyword">def</span> <span class="token function">resblock_body</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> num_filters<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> expansion<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> last<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">5e-4</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#----------------------------------------------------------------#</span>
    <span class="token comment">#   利用ZeroPadding2D和一个步长为2x2的卷积块进行高和宽的压缩</span>
    <span class="token comment">#----------------------------------------------------------------#</span>

    <span class="token comment"># 320, 320, 64 =&gt; 160, 160, 128</span>
    x <span class="token operator">=</span> ZeroPadding2D<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>num_filters<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.0'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">if</span> last<span class="token punctuation">:</span>
        x <span class="token operator">=</span> SPPBottleneck<span class="token punctuation">(</span>x<span class="token punctuation">,</span> num_filters<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.1'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> C3<span class="token punctuation">(</span>x<span class="token punctuation">,</span> num_filters<span class="token punctuation">,</span> num_blocks<span class="token punctuation">,</span> shortcut<span class="token operator">=</span>shortcut<span class="token punctuation">,</span> expansion<span class="token operator">=</span>expansion<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">'.1'</span> <span class="token keyword">if</span> <span class="token keyword">not</span> last <span class="token keyword">else</span> name <span class="token operator">+</span> <span class="token string">'.2'</span><span class="token punctuation">)</span>

<span class="token comment">#---------------------------------------------------#</span>
<span class="token comment">#   CSPdarknet的主体部分</span>
<span class="token comment">#   输入为一张640x640x3的图片</span>
<span class="token comment">#   输出为三个有效特征层</span>
<span class="token comment">#---------------------------------------------------#</span>
<span class="token keyword">def</span> <span class="token function">darknet_body</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> base_channels<span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">5e-4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 640, 640, 3 =&gt; 320, 320, 12</span>
    x <span class="token operator">=</span> Focus<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment"># 320, 320, 12 =&gt; 320, 320, 64</span>
    x <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span>base_channels<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'backbone.stem.conv'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment"># 320, 320, 64 =&gt; 160, 160, 128</span>
    x <span class="token operator">=</span> resblock_body<span class="token punctuation">(</span>x<span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'backbone.dark2'</span><span class="token punctuation">)</span>
    <span class="token comment"># 160, 160, 128 =&gt; 80, 80, 256</span>
    x <span class="token operator">=</span> resblock_body<span class="token punctuation">(</span>x<span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> base_depth <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'backbone.dark3'</span><span class="token punctuation">)</span>
    feat1 <span class="token operator">=</span> x
    <span class="token comment"># 80, 80, 256 =&gt; 40, 40, 512</span>
    x <span class="token operator">=</span> resblock_body<span class="token punctuation">(</span>x<span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> base_depth <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'backbone.dark4'</span><span class="token punctuation">)</span>
    feat2 <span class="token operator">=</span> x
    <span class="token comment"># 40, 40, 512 =&gt; 20, 20, 1024</span>
    x <span class="token operator">=</span> resblock_body<span class="token punctuation">(</span>x<span class="token punctuation">,</span> base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'backbone.dark5'</span><span class="token punctuation">)</span>
    feat3 <span class="token operator">=</span> x
    <span class="token keyword">return</span> feat1<span class="token punctuation">,</span>feat2<span class="token punctuation">,</span>feat3
</code></pre> 
<h3>
<a id="2FPN_279"></a>2、构建FPN特征金字塔进行加强特征提取</h3> 
<p><img src="https://images2.imgbox.com/af/d0/8iTGMROC_o.png" alt="在这里插入图片描述"><br> 在特征利用部分，YoloV5提取<strong>多特征层进行目标检测</strong>，一共<strong>提取三个特征层</strong>。<br> 三个特征层位于主干部分CSPdarknet的不同位置，分别位于<strong>中间层，中下层，底层</strong>，当输入为(640,640,3)的时候，三个特征层的<strong>shape分别为feat1=(80,80,256)、feat2=(40,40,512)、feat3=(20,20,1024)。</strong></p> 
<p>在获得三个有效特征层后，我们利用这三个有效特征层进行FPN层的构建，构建方式为：</p> 
<ol>
<li>feat3=(20,20,1024)的特征层进行1次1X1卷积调整通道后获得P5，<strong>P5进行上采样UmSampling2d后与feat2=(40,40,512)特征层进行结合</strong>，然后使用CSPLayer进行特征提取获得P5_upsample，此时获得的特征层为(40,40,512)。</li>
<li>P5_upsample=(40,40,512)的特征层进行1次1X1卷积调整通道后获得P4，<strong>P4进行上采样UmSampling2d后与feat1=(80,80,256)特征层进行结合</strong>，然后使用CSPLayer进行特征提取P3_out，此时获得的特征层为(80,80,256)。</li>
<li>P3_out=(80,80,256)的特征层进行一次3x3卷积进行下采样，<strong>下采样后与P4堆叠</strong>，然后使用CSPLayer进行特征提取P4_out，此时获得的特征层为(40,40,512)。</li>
<li>P4_out=(40,40,512)的特征层进行一次3x3卷积进行下采样，<strong>下采样后与P5堆叠</strong>，然后使用CSPLayer进行特征提取P5_out，此时获得的特征层为(20,20,1024)。</li>
</ol> 
<p>特征金字塔可以将<strong>不同shape的特征层进行特征融合</strong>，有利于<strong>提取出更好的特征</strong>。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> <span class="token punctuation">(</span>Concatenate<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> Lambda<span class="token punctuation">,</span> UpSampling2D<span class="token punctuation">,</span>
                                     ZeroPadding2D<span class="token punctuation">)</span>
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Model

<span class="token keyword">from</span> nets<span class="token punctuation">.</span>CSPdarknet <span class="token keyword">import</span> <span class="token punctuation">(</span>C3<span class="token punctuation">,</span> DarknetConv2D<span class="token punctuation">,</span> DarknetConv2D_BN_SiLU<span class="token punctuation">,</span>
                             darknet_body<span class="token punctuation">)</span>
<span class="token keyword">from</span> nets<span class="token punctuation">.</span>yolo_training <span class="token keyword">import</span> yolo_loss


<span class="token comment">#---------------------------------------------------#</span>
<span class="token comment">#   Panet网络的构建，并且获得预测结果</span>
<span class="token comment">#---------------------------------------------------#</span>
<span class="token keyword">def</span> <span class="token function">yolo_body</span><span class="token punctuation">(</span>input_shape<span class="token punctuation">,</span> anchors_mask<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> phi<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">5e-4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    depth_dict          <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'s'</span> <span class="token punctuation">:</span> <span class="token number">0.33</span><span class="token punctuation">,</span> <span class="token string">'m'</span> <span class="token punctuation">:</span> <span class="token number">0.67</span><span class="token punctuation">,</span> <span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">1.00</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">1.33</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
    width_dict          <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'s'</span> <span class="token punctuation">:</span> <span class="token number">0.50</span><span class="token punctuation">,</span> <span class="token string">'m'</span> <span class="token punctuation">:</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token string">'l'</span> <span class="token punctuation">:</span> <span class="token number">1.00</span><span class="token punctuation">,</span> <span class="token string">'x'</span> <span class="token punctuation">:</span> <span class="token number">1.25</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
    dep_mul<span class="token punctuation">,</span> wid_mul    <span class="token operator">=</span> depth_dict<span class="token punctuation">[</span>phi<span class="token punctuation">]</span><span class="token punctuation">,</span> width_dict<span class="token punctuation">[</span>phi<span class="token punctuation">]</span>

    base_channels       <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>wid_mul <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>  <span class="token comment"># 64</span>
    base_depth          <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>dep_mul <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 3</span>

    inputs      <span class="token operator">=</span> Input<span class="token punctuation">(</span>input_shape<span class="token punctuation">)</span>
    <span class="token comment">#---------------------------------------------------#   </span>
    <span class="token comment">#   生成主干模型，获得三个有效特征层，他们的shape分别是：</span>
    <span class="token comment">#   80, 80, 256</span>
    <span class="token comment">#   40, 40, 512</span>
    <span class="token comment">#   20, 20, 1024</span>
    <span class="token comment">#---------------------------------------------------#</span>
    feat1<span class="token punctuation">,</span> feat2<span class="token punctuation">,</span> feat3 <span class="token operator">=</span> darknet_body<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> base_channels<span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> weight_decay<span class="token punctuation">)</span>

    P5          <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'conv_for_feat3'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>feat3<span class="token punctuation">)</span>  
    P5_upsample <span class="token operator">=</span> UpSampling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P5<span class="token punctuation">)</span> 
    P5_upsample <span class="token operator">=</span> Concatenate<span class="token punctuation">(</span>axis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>P5_upsample<span class="token punctuation">,</span> feat2<span class="token punctuation">]</span><span class="token punctuation">)</span>
    P5_upsample <span class="token operator">=</span> C3<span class="token punctuation">(</span>P5_upsample<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'conv3_for_upsample1'</span><span class="token punctuation">)</span>

    P4          <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'conv_for_feat2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P5_upsample<span class="token punctuation">)</span>
    P4_upsample <span class="token operator">=</span> UpSampling2D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P4<span class="token punctuation">)</span>
    P4_upsample <span class="token operator">=</span> Concatenate<span class="token punctuation">(</span>axis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>P4_upsample<span class="token punctuation">,</span> feat1<span class="token punctuation">]</span><span class="token punctuation">)</span>
    P3_out      <span class="token operator">=</span> C3<span class="token punctuation">(</span>P4_upsample<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'conv3_for_upsample2'</span><span class="token punctuation">)</span>

    P3_downsample   <span class="token operator">=</span> ZeroPadding2D<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P3_out<span class="token punctuation">)</span>
    P3_downsample   <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'down_sample1'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P3_downsample<span class="token punctuation">)</span>
    P3_downsample   <span class="token operator">=</span> Concatenate<span class="token punctuation">(</span>axis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>P3_downsample<span class="token punctuation">,</span> P4<span class="token punctuation">]</span><span class="token punctuation">)</span>
    P4_out          <span class="token operator">=</span> C3<span class="token punctuation">(</span>P3_downsample<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'conv3_for_downsample1'</span><span class="token punctuation">)</span> 

    P4_downsample   <span class="token operator">=</span> ZeroPadding2D<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P4_out<span class="token punctuation">)</span>
    P4_downsample   <span class="token operator">=</span> DarknetConv2D_BN_SiLU<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'down_sample2'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P4_downsample<span class="token punctuation">)</span>
    P4_downsample   <span class="token operator">=</span> Concatenate<span class="token punctuation">(</span>axis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>P4_downsample<span class="token punctuation">,</span> P5<span class="token punctuation">]</span><span class="token punctuation">)</span>
    P5_out          <span class="token operator">=</span> C3<span class="token punctuation">(</span>P4_downsample<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>base_channels <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> base_depth<span class="token punctuation">,</span> shortcut <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>weight_decay<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'conv3_for_downsample2'</span><span class="token punctuation">)</span>
</code></pre> 
<h3>
<a id="3Yolo_Head_342"></a>3、利用Yolo Head获得预测结果</h3> 
<p><img src="https://images2.imgbox.com/af/d0/8iTGMROC_o.png" alt="在这里插入图片描述"><br> 利用FPN特征金字塔，<strong>我们可以获得三个加强特征，这三个加强特征的shape分别为(20,20,1024)、(40,40,512)、(80,80,256)，然后我们利用这三个shape的特征层传入Yolo Head获得预测结果。</strong></p> 
<p>对于每一个特征层，我们可以获得利用一个卷积调整通道数，最终的通道数和需要区分的种类个数相关，在YoloV5里，每一个特征层上每一个特征点存在3个先验框。</p> 
<p><strong>如果使用的是voc训练集，类则为20种，最后的维度应该为75 = 3x25</strong>，三个特征层的shape为(<strong>20,20,75</strong>)，(<strong>40,40,75</strong>)，(<strong>80,80,75</strong>)。<br> 最后的75可以拆分成3个25，对应3个先验框的25个参数，25可以拆分成4+1+20。<br> 前4个参数用于判断每一个特征点的回归参数，回归参数调整后可以获得预测框；<br> 第5个参数用于判断每一个特征点是否包含物体；<br> 最后20个参数用于判断每一个特征点所包含的物体种类。</p> 
<p><strong>如果使用的是coco训练集，类则为80种，最后的维度应该为255 = 3x85</strong>，三个特征层的shape为(<strong>13,13,255</strong>)，(<strong>26,26,255</strong>)，(<strong>52,52,255</strong>)<br> 最后的255可以拆分成3个85，对应3个先验框的85个参数，85可以拆分成4+1+80。<br> 前4个参数用于判断每一个特征点的回归参数，回归参数调整后可以获得预测框；<br> 第5个参数用于判断每一个特征点是否包含物体；<br> 最后80个参数用于判断每一个特征点所包含的物体种类。</p> 
<p>实现代码如下：</p> 
<pre><code class="prism language-python">out2 <span class="token operator">=</span> DarknetConv2D<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'yolo_head_P3'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P3_out<span class="token punctuation">)</span>
out1 <span class="token operator">=</span> DarknetConv2D<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'yolo_head_P4'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P4_out<span class="token punctuation">)</span>
out0 <span class="token operator">=</span> DarknetConv2D<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'yolo_head_P5'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>P5_out<span class="token punctuation">)</span>
<span class="token keyword">return</span> Model<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> <span class="token punctuation">[</span>out0<span class="token punctuation">,</span> out1<span class="token punctuation">,</span> out2<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="_368"></a>三、预测结果的解码</h2> 
<h3>
<a id="1_369"></a>1、获得预测框与得分</h3> 
<p>由第二步我们可以获得三个特征层的预测结果，shape分别为(<strong>N,20,20,255</strong>)，(<strong>N,40,40,255</strong>)，(<strong>N,80,80,255</strong>)的数据。</p> 
<p>但是这个预测结果并不对应着最终的预测框在图片上的位置，还需要解码才可以完成。在YoloV5里，每一个特征层上每一个特征点存在3个先验框。</p> 
<p><strong>每个特征层最后的255可以拆分成3个85，对应3个先验框的85个参数</strong>，我们先将其reshape一下，其结果为(<strong>N,20,20,3,85</strong>)，(<strong>N,40.40,3,85</strong>)，(<strong>N,80,80,3,85</strong>)。</p> 
<p><strong>其中的85可以拆分成4+1+80。</strong><br> <strong>前4个参数用于判断每一个特征点的回归参数，回归参数调整后可以获得预测框；<br> 第5个参数用于判断每一个特征点是否包含物体；<br> 最后80个参数用于判断每一个特征点所包含的物体种类。</strong></p> 
<p>以(<strong>N,20,20,3,85</strong>)这个特征层为例，<strong>该特征层相当于将图像划分成20x20个特征点，如果某个特征点落在物体的对应框内，就用于预测该物体。</strong></p> 
<p>如图所示，蓝色的点为20x20的特征点，此时我们对左图黑色点的三个先验框进行解码操作演示：<br> 1、进行中心预测点的计算，<strong>利用Regression预测结果前两个序号的内容对特征点的三个先验框中心坐标进行偏移，偏移后是右图红色的三个点；</strong><br> 2、进行预测框宽高的计算，<strong>利用Regression预测结果后两个序号的内容求指数后获得预测框的宽高；</strong><br> 3、此时获得的预测框就可以绘制在图片上了。<br> <img src="https://images2.imgbox.com/91/bf/eV8x86IW_o.png" alt="在这里插入图片描述"><br> 除去这样的解码操作，还有非极大抑制的操作需要进行，防止同一种类的框的堆积。</p> 
<pre><code class="prism language-python"><span class="token comment">#---------------------------------------------------#</span>
<span class="token comment">#   将预测值的每个特征层调成真实值</span>
<span class="token comment">#---------------------------------------------------#</span>
<span class="token keyword">def</span> <span class="token function">get_anchors_and_decode</span><span class="token punctuation">(</span>feats<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span> calc_loss<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    num_anchors <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors<span class="token punctuation">)</span>
    <span class="token comment">#------------------------------------------#</span>
    <span class="token comment">#   grid_shape指的是特征层的高和宽</span>
    <span class="token comment">#------------------------------------------#</span>
    grid_shape <span class="token operator">=</span> K<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>feats<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    <span class="token comment">#   获得各个特征点的坐标信息。生成的shape为(20, 20, num_anchors, 2)</span>
    <span class="token comment">#--------------------------------------------------------------------#</span>
    grid_x  <span class="token operator">=</span> K<span class="token punctuation">.</span>tile<span class="token punctuation">(</span>K<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>K<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> stop<span class="token operator">=</span>grid_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>grid_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> num_anchors<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    grid_y  <span class="token operator">=</span> K<span class="token punctuation">.</span>tile<span class="token punctuation">(</span>K<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>K<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> stop<span class="token operator">=</span>grid_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> grid_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_anchors<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    grid    <span class="token operator">=</span> K<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>K<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>grid_x<span class="token punctuation">,</span> grid_y<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> K<span class="token punctuation">.</span>dtype<span class="token punctuation">(</span>feats<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#---------------------------------------------------------------#</span>
    <span class="token comment">#   将先验框进行拓展，生成的shape为(20, 20, num_anchors, 2)</span>
    <span class="token comment">#---------------------------------------------------------------#</span>
    anchors_tensor <span class="token operator">=</span> K<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>K<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>anchors<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> num_anchors<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    anchors_tensor <span class="token operator">=</span> K<span class="token punctuation">.</span>tile<span class="token punctuation">(</span>anchors_tensor<span class="token punctuation">,</span> <span class="token punctuation">[</span>grid_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> grid_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">#---------------------------------------------------#</span>
    <span class="token comment">#   将预测结果调整成(batch_size,13,13,3,85)</span>
    <span class="token comment">#   85可拆分成4 + 1 + 80</span>
    <span class="token comment">#   4代表的是中心宽高的调整参数</span>
    <span class="token comment">#   1代表的是框的置信度</span>
    <span class="token comment">#   80代表的是种类的置信度</span>
    <span class="token comment">#---------------------------------------------------#</span>
    feats           <span class="token operator">=</span> K<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>feats<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> grid_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> grid_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_anchors<span class="token punctuation">,</span> num_classes <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">#------------------------------------------#</span>
    <span class="token comment">#   对先验框进行解码，并进行归一化</span>
    <span class="token comment">#------------------------------------------#</span>
    box_xy          <span class="token operator">=</span> <span class="token punctuation">(</span>K<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>feats<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">+</span> grid<span class="token punctuation">)</span> <span class="token operator">/</span> K<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>grid_shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> K<span class="token punctuation">.</span>dtype<span class="token punctuation">(</span>feats<span class="token punctuation">)</span><span class="token punctuation">)</span>
    box_wh          <span class="token operator">=</span> <span class="token punctuation">(</span>K<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>feats<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchors_tensor <span class="token operator">/</span> K<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>input_shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> K<span class="token punctuation">.</span>dtype<span class="token punctuation">(</span>feats<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#------------------------------------------#</span>
    <span class="token comment">#   获得预测框的置信度</span>
    <span class="token comment">#------------------------------------------#</span>
    box_confidence  <span class="token operator">=</span> K<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>feats<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    box_class_probs <span class="token operator">=</span> K<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>feats<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment">#---------------------------------------------------------------------#</span>
    <span class="token comment">#   在计算loss的时候返回grid, feats, box_xy, box_wh</span>
    <span class="token comment">#   在预测的时候返回box_xy, box_wh, box_confidence, box_class_probs</span>
    <span class="token comment">#---------------------------------------------------------------------#</span>
    <span class="token keyword">if</span> calc_loss <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> grid<span class="token punctuation">,</span> feats<span class="token punctuation">,</span> box_xy<span class="token punctuation">,</span> box_wh
    <span class="token keyword">return</span> box_xy<span class="token punctuation">,</span> box_wh<span class="token punctuation">,</span> box_confidence<span class="token punctuation">,</span> box_class_probs
</code></pre> 
<h3>
<a id="2_438"></a>2、得分筛选与非极大抑制</h3> 
<p>得到最终的预测结果后还要进行<strong>得分排序与非极大抑制筛选</strong>。</p> 
<p><strong>得分筛选</strong>就是<strong>筛选出得分满足confidence置信度的预测框。</strong><br> <strong>非极大抑制</strong>就是<strong>筛选出一定区域内属于同一种类得分最大的框。</strong></p> 
<p>得分筛选与非极大抑制的过程可以概括如下：<br> 1、找出该图片中<strong>得分大于门限函数的框</strong>。在进行<strong>重合框筛选前就进行得分的筛选可以大幅度减少框的数量。</strong><br> 2、对<strong>种类进行循环</strong>，非极大抑制的作用是<strong>筛选出一定区域内属于同一种类得分最大的框</strong>，对种类进行循环可以<strong>帮助我们对每一个类分别进行非极大抑制。</strong><br> 3、根据得分对该种类进行从大到小排序。<br> 4、每次取出得分最大的框，计算<strong>其与其它所有预测框的重合程度，重合程度过大的则剔除。</strong></p> 
<p>得分筛选与非极大抑制后的结果就可以用于绘制预测框了。</p> 
<p>下图是经过非极大抑制的。<br> <img src="https://images2.imgbox.com/db/f7/ANDA5PsG_o.png" alt="在这里插入图片描述" width="400"><br> 下图是未经过非极大抑制的。<br> <img src="https://images2.imgbox.com/01/77/DuLmpemL_o.png" alt="在这里插入图片描述" width="400"><br> 实现代码为：</p> 
<pre><code class="prism language-python">box_scores  <span class="token operator">=</span> box_confidence <span class="token operator">*</span> box_class_probs

<span class="token comment">#-----------------------------------------------------------#</span>
<span class="token comment">#   判断得分是否大于score_threshold</span>
<span class="token comment">#-----------------------------------------------------------#</span>
mask             <span class="token operator">=</span> box_scores <span class="token operator">&gt;=</span> confidence
max_boxes_tensor <span class="token operator">=</span> K<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>max_boxes<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'int32'</span><span class="token punctuation">)</span>
boxes_out   <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
scores_out  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
classes_out <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#-----------------------------------------------------------#</span>
    <span class="token comment">#   取出所有box_scores &gt;= score_threshold的框，和成绩</span>
    <span class="token comment">#-----------------------------------------------------------#</span>
    class_boxes      <span class="token operator">=</span> tf<span class="token punctuation">.</span>boolean_mask<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> c<span class="token punctuation">]</span><span class="token punctuation">)</span>
    class_box_scores <span class="token operator">=</span> tf<span class="token punctuation">.</span>boolean_mask<span class="token punctuation">(</span>box_scores<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> c<span class="token punctuation">]</span><span class="token punctuation">,</span> mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> c<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">#-----------------------------------------------------------#</span>
    <span class="token comment">#   非极大抑制</span>
    <span class="token comment">#   保留一定区域内得分最大的框</span>
    <span class="token comment">#-----------------------------------------------------------#</span>
    nms_index <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>non_max_suppression<span class="token punctuation">(</span>class_boxes<span class="token punctuation">,</span> class_box_scores<span class="token punctuation">,</span> max_boxes_tensor<span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span>nms_iou<span class="token punctuation">)</span>

    <span class="token comment">#-----------------------------------------------------------#</span>
    <span class="token comment">#   获取非极大抑制后的结果</span>
    <span class="token comment">#   下列三个分别是：框的位置，得分与种类</span>
    <span class="token comment">#-----------------------------------------------------------#</span>
    class_boxes         <span class="token operator">=</span> K<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>class_boxes<span class="token punctuation">,</span> nms_index<span class="token punctuation">)</span>
    class_box_scores    <span class="token operator">=</span> K<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>class_box_scores<span class="token punctuation">,</span> nms_index<span class="token punctuation">)</span>
    classes             <span class="token operator">=</span> K<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>class_box_scores<span class="token punctuation">,</span> <span class="token string">'int32'</span><span class="token punctuation">)</span> <span class="token operator">*</span> c

    boxes_out<span class="token punctuation">.</span>append<span class="token punctuation">(</span>class_boxes<span class="token punctuation">)</span>
    scores_out<span class="token punctuation">.</span>append<span class="token punctuation">(</span>class_box_scores<span class="token punctuation">)</span>
    classes_out<span class="token punctuation">.</span>append<span class="token punctuation">(</span>classes<span class="token punctuation">)</span>
boxes_out      <span class="token operator">=</span> K<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>boxes_out<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
scores_out     <span class="token operator">=</span> K<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>scores_out<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
classes_out    <span class="token operator">=</span> K<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>classes_out<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<h2>
<a id="_496"></a>四、训练部分</h2> 
<h3>
<a id="1loss_497"></a>1、计算loss所需内容</h3> 
<p>计算loss实际上是网络的预测结果和网络的真实结果的对比。<br> 和网络的预测结果一样，网络的损失也由三个部分组成，分别是Reg部分、Obj部分、Cls部分。Reg部分是特征点的回归参数判断、Obj部分是特征点是否包含物体判断、Cls部分是特征点包含的物体的种类。</p> 
<h3>
<a id="2_500"></a>2、正样本的匹配过程</h3> 
<p>在YoloV5中，训练时正样本的匹配过程可以分为两部分。<br> a、匹配先验框。<br> b、匹配特征点。</p> 
<p>所谓<strong>正样本匹配</strong>，就是<strong>寻找哪些先验框被认为有对应的真实框，并且负责这个真实框的预测</strong>。</p> 
<h4>
<a id="a_506"></a>a、匹配先验框</h4> 
<p>在YoloV5网络中，一共设计了9个不同大小的先验框。每个输出的特征层对应3个先验框。</p> 
<p><strong>对于任何一个真实框gt，YoloV5不再使用iou进行正样本的匹配，而是直接采用高宽比进行匹配，即使用真实框和9个不同大小的先验框计算宽高比。</strong></p> 
<p><strong>如果真实框与某个先验框的宽高比例大于设定阈值，则说明该真实框和该先验框匹配度不够，将该先验框认为是负样本。</strong></p> 
<p>比如<strong>此时有一个真实框，它的宽高为[200, 200]，是一个正方形</strong>。YoloV5默认设置的<strong>9个先验框为[10,13], [16,30], [33,23], [30,61], [62,45], [59,119], [116,90], [156,198], [373,326]</strong>。设定<strong>阈值门限为4</strong>。</p> 
<p><strong>此时我们需要计算该真实框和9个先验框的宽高比例</strong>。比较宽高时存在两个情况，<strong>一个是真实框的宽高比先验框大，一个是先验框的宽高比真实框大</strong>。因此我们需要同时计算：真实框的宽高/先验框的宽高；先验框的宽高/真实框的宽高。然后在这其中选取最大值。</p> 
<p>下个列表就是比较结果，这是一个shape为[9, 4]的矩阵，9代表9个先验框，4代表真实框的宽高/先验框的宽高；先验框的宽高/真实框的宽高。</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">20.</span>         <span class="token number">15.38461538</span>  <span class="token number">0.05</span>        <span class="token number">0.065</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">12.5</span>         <span class="token number">6.66666667</span>  <span class="token number">0.08</span>        <span class="token number">0.15</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">6.06060606</span>  <span class="token number">8.69565217</span>  <span class="token number">0.165</span>       <span class="token number">0.115</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">6.66666667</span>  <span class="token number">3.27868852</span>  <span class="token number">0.15</span>        <span class="token number">0.305</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">3.22580645</span>  <span class="token number">4.44444444</span>  <span class="token number">0.31</span>        <span class="token number">0.225</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">3.38983051</span>  <span class="token number">1.68067227</span>  <span class="token number">0.295</span>       <span class="token number">0.595</span>     <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">1.72413793</span>  <span class="token number">2.22222222</span>  <span class="token number">0.58</span>        <span class="token number">0.45</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">1.28205128</span>  <span class="token number">1.01010101</span>  <span class="token number">0.78</span>        <span class="token number">0.99</span>      <span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">0.53619303</span>  <span class="token number">0.61349693</span>  <span class="token number">1.865</span>       <span class="token number">1.63</span>      <span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>然后对每个先验框的比较结果取最大值。获得下述矩阵：</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token number">20.</span>         <span class="token number">12.5</span>         <span class="token number">8.69565217</span>  <span class="token number">6.66666667</span>  <span class="token number">4.44444444</span>  <span class="token number">3.38983051</span>
   <span class="token number">2.22222222</span>  <span class="token number">1.28205128</span>  <span class="token number">1.865</span>     <span class="token punctuation">]</span>
</code></pre> 
<p><strong>之后我们判断，哪些先验框的比较结果的值小于门限</strong>。可以知道[59,119], [116,90], [156,198], [373,326]四个先验框均满足需求。</p> 
<p><strong>[116,90], [156,198], [373,326]属于20,20的特征层。<br> [59,119]属于40,40的特征层。</strong></p> 
<p><strong>此时我们已经可以判断哪些大小的先验框可用于该真实框的预测。</strong></p> 
<h4>
<a id="b_540"></a>b、匹配特征点</h4> 
<p>在过去的Yolo系列中，每个真实框由其中心点所在的网格内的左上角特征点来负责预测。</p> 
<p>对于被选中的特征层，首先计算真实框落在哪个网格内，此时<strong>该网格左上角特征点便是一个负责预测的特征点。</strong></p> 
<p><strong>同时利用四舍五入规则，找出最近的两个网格，将这三个网格</strong>都认为是负责预测该真实框的。<br> <img src="https://images2.imgbox.com/4d/c4/yafWGbEj_o.png" alt="在这里插入图片描述"><br> <strong>红色点表示该真实框的中心</strong>，除了当前所处的网格外，其2个最近的邻域网格也被选中。从这里就可以发现预测框的XY轴偏移部分的取值范围不再是0-1，而是0.5-1.5。</p> 
<p><strong>找到对应特征点后，对应特征点在a中被选中的先验框负责该真实框的预测。</strong></p> 
<h3>
<a id="3Loss_550"></a>3、计算Loss</h3> 
<p>由第一部分可知，YoloV5的损失由三个部分组成：<br> <strong>1、Reg部分，由第2部分可知道每个真实框对应的先验框，获取到每个框对应的先验框后，取出该先验框对应的预测框，利用真实框和预测框计算CIOU损失，作为Reg部分的Loss组成。<br> 2、Obj部分，由第2部分可知道每个真实框对应的先验框，所有真实框对应的先验框都是正样本，剩余的先验框均为负样本，根据正负样本和特征点的是否包含物体的预测结果计算交叉熵损失，作为Obj部分的Loss组成。<br> 3、Cls部分，由第三部分可知道每个真实框对应的先验框，获取到每个框对应的先验框后，取出该先验框的种类预测结果，根据真实框的种类和先验框的种类预测结果计算交叉熵损失，作为Cls部分的Loss组成。</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#---------------------------------------------------#</span>
<span class="token comment">#   loss值计算</span>
<span class="token comment">#---------------------------------------------------#</span>
<span class="token keyword">def</span> <span class="token function">yolo_loss</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> anchors_mask<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> balance <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label_smoothing <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span> box_ratio <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> obj_ratio <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> cls_ratio <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    num_layers <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors_mask<span class="token punctuation">)</span>
    <span class="token comment">#---------------------------------------------------------------------------------------------------#</span>
    <span class="token comment">#   将预测结果和实际ground truth分开，args是[*model_body.output, *y_true]</span>
    <span class="token comment">#   y_true是一个列表，包含三个特征层，shape分别为:</span>
    <span class="token comment">#   (m,20,20,3,85)</span>
    <span class="token comment">#   (m,40,40,3,85)</span>
    <span class="token comment">#   (m,80,80,3,85)</span>
    <span class="token comment">#   yolo_outputs是一个列表，包含三个特征层，shape分别为:</span>
    <span class="token comment">#   (m,20,20,3,85)</span>
    <span class="token comment">#   (m,40,40,3,85)</span>
    <span class="token comment">#   (m,80,80,3,85)</span>
    <span class="token comment">#---------------------------------------------------------------------------------------------------#</span>
    y_true          <span class="token operator">=</span> args<span class="token punctuation">[</span>num_layers<span class="token punctuation">:</span><span class="token punctuation">]</span>
    yolo_outputs    <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token punctuation">:</span>num_layers<span class="token punctuation">]</span>

    <span class="token comment">#-----------------------------------------------------------#</span>
    <span class="token comment">#   得到input_shpae为416,416 </span>
    <span class="token comment">#-----------------------------------------------------------#</span>
    input_shape <span class="token operator">=</span> K<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>input_shape<span class="token punctuation">,</span> K<span class="token punctuation">.</span>dtype<span class="token punctuation">(</span>y_true<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">#-----------------------------------------------------------#</span>
    <span class="token comment">#   取出每一张图片</span>
    <span class="token comment">#   m的值就是batch_size</span>
    <span class="token comment">#-----------------------------------------------------------#</span>
    m <span class="token operator">=</span> K<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>yolo_outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    loss    <span class="token operator">=</span> <span class="token number">0</span>
    num_pos <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">#---------------------------------------------------------------------------------------------------#</span>
    <span class="token comment">#   y_true是一个列表，包含三个特征层，shape分别为(m,20,20,3,85),(m,40,40,3,85),(m,80,80,3,85)。</span>
    <span class="token comment">#   yolo_outputs是一个列表，包含三个特征层，shape分别为(m,20,20,3,85),(m,40,40,3,85),(m,80,80,3,85)。</span>
    <span class="token comment">#---------------------------------------------------------------------------------------------------#</span>
    <span class="token keyword">for</span> l <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_layers<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   以第一个特征层(m,20,20,3,85)为例子</span>
        <span class="token comment">#   取出该特征层中存在目标的点的位置。(m,20,20,3,1)</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        object_mask <span class="token operator">=</span> y_true<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   取出其对应的种类(m,20,20,3,80)</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        true_class_probs <span class="token operator">=</span> y_true<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> label_smoothing<span class="token punctuation">:</span>
            true_class_probs <span class="token operator">=</span> _smooth_labels<span class="token punctuation">(</span>true_class_probs<span class="token punctuation">,</span> label_smoothing<span class="token punctuation">)</span>

        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   将yolo_outputs的特征层输出进行处理、获得四个返回值</span>
        <span class="token comment">#   其中：</span>
        <span class="token comment">#   grid        (20,20,1,2) 网格坐标</span>
        <span class="token comment">#   raw_pred    (m,20,20,3,85) 尚未处理的预测结果</span>
        <span class="token comment">#   pred_xy     (m,20,20,3,2) 解码后的中心坐标</span>
        <span class="token comment">#   pred_wh     (m,20,20,3,2) 解码后的宽高坐标</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        grid<span class="token punctuation">,</span> raw_pred<span class="token punctuation">,</span> pred_xy<span class="token punctuation">,</span> pred_wh <span class="token operator">=</span> get_anchors_and_decode<span class="token punctuation">(</span>yolo_outputs<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">,</span>
             anchors<span class="token punctuation">[</span>anchors_mask<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span> calc_loss<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   pred_box是解码后的预测的box的位置</span>
        <span class="token comment">#   (m,20,20,3,4)</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        pred_box <span class="token operator">=</span> K<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>pred_xy<span class="token punctuation">,</span> pred_wh<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   真实框越大，比重越小，小框的比重更大。</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        box_loss_scale <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">-</span> y_true<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">*</span>y_true<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>

        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   计算Ciou loss</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        raw_true_box    <span class="token operator">=</span> y_true<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        ciou            <span class="token operator">=</span> box_ciou<span class="token punctuation">(</span>pred_box<span class="token punctuation">,</span> raw_true_box<span class="token punctuation">)</span>
        ciou_loss       <span class="token operator">=</span> object_mask <span class="token operator">*</span> box_loss_scale <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> ciou<span class="token punctuation">)</span>
        
        <span class="token comment">#------------------------------------------------------------------------------#</span>
        <span class="token comment">#   如果该位置本来有框，那么计算1与置信度的交叉熵</span>
        <span class="token comment">#   如果该位置本来没有框，那么计算0与置信度的交叉熵</span>
        <span class="token comment">#   在这其中会忽略一部分样本，这些被忽略的样本满足条件best_iou&lt;ignore_thresh</span>
        <span class="token comment">#   该操作的目的是：</span>
        <span class="token comment">#   忽略预测结果与真实框非常对应特征点，因为这些框已经比较准了</span>
        <span class="token comment">#   不适合当作负样本，所以忽略掉。</span>
        <span class="token comment">#------------------------------------------------------------------------------#</span>
        confidence_loss <span class="token operator">=</span> object_mask <span class="token operator">*</span> K<span class="token punctuation">.</span>binary_crossentropy<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>ciou<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>ciou<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> raw_pred<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> from_logits<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token operator">+</span> 
                        <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> object_mask<span class="token punctuation">)</span> <span class="token operator">*</span> K<span class="token punctuation">.</span>binary_crossentropy<span class="token punctuation">(</span>object_mask<span class="token punctuation">,</span> raw_pred<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> from_logits<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        class_loss <span class="token operator">=</span> object_mask <span class="token operator">*</span> K<span class="token punctuation">.</span>binary_crossentropy<span class="token punctuation">(</span>true_class_probs<span class="token punctuation">,</span> raw_pred<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> from_logits<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        location_loss   <span class="token operator">=</span> K<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>ciou_loss<span class="token punctuation">)</span> <span class="token operator">*</span> box_ratio
        confidence_loss <span class="token operator">=</span> K<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>confidence_loss<span class="token punctuation">)</span> <span class="token operator">*</span> balance<span class="token punctuation">[</span>l<span class="token punctuation">]</span> <span class="token operator">*</span> obj_ratio
        class_loss      <span class="token operator">=</span> K<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>class_loss<span class="token punctuation">)</span> <span class="token operator">*</span> cls_ratio
        <span class="token comment">#-----------------------------------------------------------#</span>
        <span class="token comment">#   计算正样本数量</span>
        <span class="token comment">#-----------------------------------------------------------#</span>
        num_pos <span class="token operator">+=</span> tf<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>K<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>K<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>object_mask<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        loss    <span class="token operator">+=</span> location_loss <span class="token operator">+</span> confidence_loss <span class="token operator">+</span> class_loss
        <span class="token comment"># if print_loss:</span>
        <span class="token comment"># loss = tf.Print(loss, [loss, location_loss, confidence_loss, class_loss], message='loss: ')</span>
        
    loss <span class="token operator">=</span> loss <span class="token operator">/</span> num_pos
    <span class="token keyword">return</span> loss
</code></pre> 
<h1>
<a id="YoloV5_661"></a>训练自己的YoloV5模型</h1> 
<p><strong>首先前往Github下载对应的仓库，下载完后利用解压软件解压，之后用编程软件打开文件夹。<br> 注意打开的根目录必须正确，否则相对目录不正确的情况下，代码将无法运行。</strong><br> 一定要注意打开后的根目录是文件存放的目录。<br> <img src="https://images2.imgbox.com/e2/9a/vWa3ke2s_o.png" alt="在这里插入图片描述"></p> 
<h2>
<a id="_666"></a>一、数据集的准备</h2> 
<p><strong>本文使用VOC格式进行训练，训练前需要自己制作好数据集，如果没有自己的数据集，可以通过Github连接下载VOC12+07的数据集尝试下。</strong><br> 训练前将标签文件放在VOCdevkit文件夹下的VOC2007文件夹下的Annotation中。<br> <img src="https://images2.imgbox.com/d5/24/3IfPmdkf_o.png" alt="在这里插入图片描述"><br> 训练前将图片文件放在VOCdevkit文件夹下的VOC2007文件夹下的JPEGImages中。<br> <img src="https://images2.imgbox.com/d7/dc/1TcNMCqQ_o.png" alt="在这里插入图片描述"><br> 此时数据集的摆放已经结束。</p> 
<h2>
<a id="_673"></a>二、数据集的处理</h2> 
<p>在完成数据集的摆放之后，我们需要对数据集进行下一步的处理，目的是获得训练用的2007_train.txt以及2007_val.txt，需要用到根目录下的voc_annotation.py。</p> 
<p>voc_annotation.py里面有一些参数需要设置。<br> 分别是annotation_mode、classes_path、trainval_percent、train_percent、VOCdevkit_path，第一次训练可以仅修改classes_path</p> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''
annotation_mode用于指定该文件运行时计算的内容
annotation_mode为0代表整个标签处理过程，包括获得VOCdevkit/VOC2007/ImageSets里面的txt以及训练用的2007_train.txt、2007_val.txt
annotation_mode为1代表获得VOCdevkit/VOC2007/ImageSets里面的txt
annotation_mode为2代表获得训练用的2007_train.txt、2007_val.txt
'''</span>
annotation_mode     <span class="token operator">=</span> <span class="token number">0</span>
<span class="token triple-quoted-string string">'''
必须要修改，用于生成2007_train.txt、2007_val.txt的目标信息
与训练和预测所用的classes_path一致即可
如果生成的2007_train.txt里面没有目标信息
那么就是因为classes没有设定正确
仅在annotation_mode为0和2的时候有效
'''</span>
classes_path        <span class="token operator">=</span> <span class="token string">'model_data/voc_classes.txt'</span>
<span class="token triple-quoted-string string">'''
trainval_percent用于指定(训练集+验证集)与测试集的比例，默认情况下 (训练集+验证集):测试集 = 9:1
train_percent用于指定(训练集+验证集)中训练集与验证集的比例，默认情况下 训练集:验证集 = 9:1
仅在annotation_mode为0和1的时候有效
'''</span>
trainval_percent    <span class="token operator">=</span> <span class="token number">0.9</span>
train_percent       <span class="token operator">=</span> <span class="token number">0.9</span>
<span class="token triple-quoted-string string">'''
指向VOC数据集所在的文件夹
默认指向根目录下的VOC数据集
'''</span>
VOCdevkit_path  <span class="token operator">=</span> <span class="token string">'VOCdevkit'</span>
</code></pre> 
<p>classes_path用于指向检测类别所对应的txt，以voc数据集为例，我们用的txt为：<br> <img src="https://images2.imgbox.com/60/c5/f49AFUTt_o.png" alt="在这里插入图片描述"><br> 训练自己的数据集时，可以自己建立一个cls_classes.txt，里面写自己所需要区分的类别。</p> 
<h2>
<a id="_710"></a>三、开始网络训练</h2> 
<p><strong>通过voc_annotation.py我们已经生成了2007_train.txt以及2007_val.txt，此时我们可以开始训练了。<br> 训练的参数较多，大家可以在下载库后仔细看注释，其中最重要的部分依然是train.py里的classes_path。</strong></p> 
<p><strong>classes_path用于指向检测类别所对应的txt，这个txt和voc_annotation.py里面的txt一样！训练自己的数据集必须要修改！</strong><br> <img src="https://images2.imgbox.com/4b/74/WnVgDze7_o.png" alt="在这里插入图片描述"><br> 修改完classes_path后就可以运行train.py开始训练了，在训练多个epoch后，权值会生成在logs文件夹中。<br> 其它参数的作用如下：</p> 
<pre><code class="prism language-python"><span class="token comment">#----------------------------------------------------#</span>
<span class="token comment">#   是否使用eager模式训练</span>
<span class="token comment">#----------------------------------------------------#</span>
eager           <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
<span class="token comment">#   classes_path    指向model_data下的txt，与自己训练的数据集相关 </span>
<span class="token comment">#                   训练前一定要修改classes_path，使其对应自己的数据集</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
classes_path    <span class="token operator">=</span> <span class="token string">'model_data/voc_classes.txt'</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
<span class="token comment">#   anchors_path    代表先验框对应的txt文件，一般不修改。</span>
<span class="token comment">#   anchors_mask    用于帮助代码找到对应的先验框，一般不修改。</span>
<span class="token comment">#---------------------------------------------------------------------#</span>
anchors_path    <span class="token operator">=</span> <span class="token string">'model_data/yolo_anchors.txt'</span>
anchors_mask    <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
<span class="token comment">#   权值文件的下载请看README，可以通过网盘下载。模型的 预训练权重 对不同数据集是通用的，因为特征是通用的。</span>
<span class="token comment">#   模型的 预训练权重 比较重要的部分是 主干特征提取网络的权值部分，用于进行特征提取。</span>
<span class="token comment">#   预训练权重对于99%的情况都必须要用，不用的话主干部分的权值太过随机，特征提取效果不明显，网络训练的结果也不会好</span>
<span class="token comment">#</span>
<span class="token comment">#   如果训练过程中存在中断训练的操作，可以将model_path设置成logs文件夹下的权值文件，将已经训练了一部分的权值再次载入。</span>
<span class="token comment">#   同时修改下方的 冻结阶段 或者 解冻阶段 的参数，来保证模型epoch的连续性。</span>
<span class="token comment">#   </span>
<span class="token comment">#   当model_path = ''的时候不加载整个模型的权值。</span>
<span class="token comment">#</span>
<span class="token comment">#   此处使用的是整个模型的权重，因此是在train.py进行加载的。</span>
<span class="token comment">#   如果想要让模型从0开始训练，则设置model_path = ''，下面的Freeze_Train = Fasle，此时从0开始训练，且没有冻结主干的过程。</span>
<span class="token comment">#   </span>
<span class="token comment">#   一般来讲，网络从0开始的训练效果会很差，因为权值太过随机，特征提取效果不明显，因此非常、非常、非常不建议大家从0开始训练！</span>
<span class="token comment">#   从0开始训练有两个方案：</span>
<span class="token comment">#   1、得益于Mosaic数据增强方法强大的数据增强能力，将UnFreeze_Epoch设置的较大（300及以上）、batch较大（16及以上）、数据较多（万以上）的情况下，</span>
<span class="token comment">#      可以设置mosaic=True，直接随机初始化参数开始训练，但得到的效果仍然不如有预训练的情况。（像COCO这样的大数据集可以这样做）</span>
<span class="token comment">#   2、了解imagenet数据集，首先训练分类模型，获得网络的主干部分权值，分类模型的 主干部分 和该模型通用，基于此进行训练。</span>
<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
model_path      <span class="token operator">=</span> <span class="token string">'model_data/yolov5_s.h5'</span>
<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   input_shape     输入的shape大小，一定要是32的倍数</span>
<span class="token comment">#------------------------------------------------------#</span>
input_shape     <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">]</span>
<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   phi             所使用的YoloV5的版本。s、m、l、x</span>
<span class="token comment">#------------------------------------------------------#</span>
phi             <span class="token operator">=</span> <span class="token string">'s'</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   mosaic          马赛克数据增强</span>
<span class="token comment">#                   参考YoloX，由于Mosaic生成的训练图片，</span>
<span class="token comment">#                   远远脱离自然图片的真实分布。</span>
<span class="token comment">#                   本代码会在训练结束前的N个epoch自动关掉Mosaic</span>
<span class="token comment">#                   100个世代会关闭30个世代（比例可在dataloader.py调整）</span>
<span class="token comment">#   label_smoothing 标签平滑。一般0.01以下。如0.01、0.005</span>
<span class="token comment">#------------------------------------------------------------------#</span>
mosaic              <span class="token operator">=</span> <span class="token boolean">True</span>
label_smoothing     <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
<span class="token comment">#   训练分为两个阶段，分别是冻结阶段和解冻阶段。设置冻结阶段是为了满足机器性能不足的同学的训练需求。</span>
<span class="token comment">#   冻结训练需要的显存较小，显卡非常差的情况下，可设置Freeze_Epoch等于UnFreeze_Epoch，Freeze_Train = True，此时仅仅进行冻结训练。</span>
<span class="token comment">#      </span>
<span class="token comment">#   在此提供若干参数设置建议，各位训练者根据自己的需求进行灵活调整：</span>
<span class="token comment">#   （一）从整个模型的预训练权重开始训练： </span>
<span class="token comment">#       Adam：</span>
<span class="token comment">#           Init_Epoch = 0，Freeze_Epoch = 50，UnFreeze_Epoch = 100，Freeze_Train = True，optimizer_type = 'adam'，Init_lr = 1e-3，weight_decay = 0。（冻结）</span>
<span class="token comment">#           Init_Epoch = 0，UnFreeze_Epoch = 100，Freeze_Train = False，optimizer_type = 'adam'，Init_lr = 1e-3，weight_decay = 0。（不冻结）</span>
<span class="token comment">#       SGD：</span>
<span class="token comment">#           Init_Epoch = 0，Freeze_Epoch = 50，UnFreeze_Epoch = 100，Freeze_Train = True，optimizer_type = 'sgd'，Init_lr = 1e-2，weight_decay = 5e-4。（冻结）</span>
<span class="token comment">#           Init_Epoch = 0，UnFreeze_Epoch = 100，Freeze_Train = False，optimizer_type = 'sgd'，Init_lr = 1e-2，weight_decay = 5e-4。（不冻结）</span>
<span class="token comment">#       其中：UnFreeze_Epoch可以在100-300之间调整。</span>
<span class="token comment">#   （二）从0开始训练：</span>
<span class="token comment">#       Init_Epoch = 0，UnFreeze_Epoch &gt;= 300，Unfreeze_batch_size &gt;= 16，Freeze_Train = False（不冻结训练）</span>
<span class="token comment">#       其中：UnFreeze_Epoch尽量不小于300。optimizer_type = 'sgd'，Init_lr = 1e-2，mosaic = True。</span>
<span class="token comment">#   （三）batch_size的设置：</span>
<span class="token comment">#       在显卡能够接受的范围内，以大为好。显存不足与数据集大小无关，提示显存不足（OOM或者CUDA out of memory）请调小batch_size。</span>
<span class="token comment">#       受到BatchNorm层影响，batch_size最小为2，不能为1。</span>
<span class="token comment">#       正常情况下Freeze_batch_size建议为Unfreeze_batch_size的1-2倍。不建议设置的差距过大，因为关系到学习率的自动调整。</span>
<span class="token comment">#----------------------------------------------------------------------------------------------------------------------------#</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   冻结阶段训练参数</span>
<span class="token comment">#   此时模型的主干被冻结了，特征提取网络不发生改变</span>
<span class="token comment">#   占用的显存较小，仅对网络进行微调</span>
<span class="token comment">#   Init_Epoch          模型当前开始的训练世代，其值可以大于Freeze_Epoch，如设置：</span>
<span class="token comment">#                       Init_Epoch = 60、Freeze_Epoch = 50、UnFreeze_Epoch = 100</span>
<span class="token comment">#                       会跳过冻结阶段，直接从60代开始，并调整对应的学习率。</span>
<span class="token comment">#                       （断点续练时使用）</span>
<span class="token comment">#   Freeze_Epoch        模型冻结训练的Freeze_Epoch</span>
<span class="token comment">#                       (当Freeze_Train=False时失效)</span>
<span class="token comment">#   Freeze_batch_size   模型冻结训练的batch_size</span>
<span class="token comment">#                       (当Freeze_Train=False时失效)</span>
<span class="token comment">#------------------------------------------------------------------#</span>
Init_Epoch          <span class="token operator">=</span> <span class="token number">0</span>
Freeze_Epoch        <span class="token operator">=</span> <span class="token number">50</span>
Freeze_batch_size   <span class="token operator">=</span> <span class="token number">16</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   解冻阶段训练参数</span>
<span class="token comment">#   此时模型的主干不被冻结了，特征提取网络会发生改变</span>
<span class="token comment">#   占用的显存较大，网络所有的参数都会发生改变</span>
<span class="token comment">#   UnFreeze_Epoch          模型总共训练的epoch</span>
<span class="token comment">#   Unfreeze_batch_size     模型在解冻后的batch_size</span>
<span class="token comment">#------------------------------------------------------------------#</span>
UnFreeze_Epoch      <span class="token operator">=</span> <span class="token number">100</span>
Unfreeze_batch_size <span class="token operator">=</span> <span class="token number">8</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   Freeze_Train    是否进行冻结训练</span>
<span class="token comment">#                   默认先冻结主干训练后解冻训练。</span>
<span class="token comment">#------------------------------------------------------------------#</span>
Freeze_Train        <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   其它训练参数：学习率、优化器、学习率下降有关</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   Init_lr         模型的最大学习率</span>
<span class="token comment">#                   当使用Adam优化器时建议设置  Init_lr=1e-3</span>
<span class="token comment">#                   当使用SGD优化器时建议设置   Init_lr=1e-2</span>
<span class="token comment">#   Min_lr          模型的最小学习率，默认为最大学习率的0.01</span>
<span class="token comment">#------------------------------------------------------------------#</span>
Init_lr             <span class="token operator">=</span> <span class="token number">1e-2</span>
Min_lr              <span class="token operator">=</span> Init_lr <span class="token operator">*</span> <span class="token number">0.01</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   optimizer_type  使用到的优化器种类，可选的有adam、sgd</span>
<span class="token comment">#                   当使用Adam优化器时建议设置  Init_lr=1e-3</span>
<span class="token comment">#                   当使用SGD优化器时建议设置   Init_lr=1e-2</span>
<span class="token comment">#   momentum        优化器内部使用到的momentum参数</span>
<span class="token comment">#   weight_decay    权值衰减，可防止过拟合</span>
<span class="token comment">#                   adam会导致weight_decay错误，使用adam时建议设置为0。</span>
<span class="token comment">#------------------------------------------------------------------#</span>
optimizer_type      <span class="token operator">=</span> <span class="token string">"sgd"</span>
momentum            <span class="token operator">=</span> <span class="token number">0.937</span>
weight_decay        <span class="token operator">=</span> <span class="token number">5e-4</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   lr_decay_type   使用到的学习率下降方式，可选的有'step'、'cos'</span>
<span class="token comment">#------------------------------------------------------------------#</span>
lr_decay_type       <span class="token operator">=</span> <span class="token string">'cos'</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   save_period     多少个epoch保存一次权值，默认每个世代都保存</span>
<span class="token comment">#------------------------------------------------------------------#</span>
save_period         <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   save_dir        权值与日志文件保存的文件夹</span>
<span class="token comment">#------------------------------------------------------------------#</span>
save_dir            <span class="token operator">=</span> <span class="token string">'logs'</span>
<span class="token comment">#------------------------------------------------------------------#</span>
<span class="token comment">#   num_workers     用于设置是否使用多线程读取数据，1代表关闭多线程</span>
<span class="token comment">#                   开启后会加快数据读取速度，但是会占用更多内存</span>
<span class="token comment">#                   keras里开启多线程有些时候速度反而慢了许多</span>
<span class="token comment">#                   在IO为瓶颈的时候再开启多线程，即GPU运算速度远大于读取图片的速度。</span>
<span class="token comment">#------------------------------------------------------------------#</span>
num_workers         <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">#------------------------------------------------------#</span>
<span class="token comment">#   train_annotation_path   训练图片路径和标签</span>
<span class="token comment">#   val_annotation_path     验证图片路径和标签</span>
<span class="token comment">#------------------------------------------------------#</span>
train_annotation_path   <span class="token operator">=</span> <span class="token string">'2007_train.txt'</span>
val_annotation_path     <span class="token operator">=</span> <span class="token string">'2007_val.txt'</span>
</code></pre> 
<h2>
<a id="_874"></a>四、训练结果预测</h2> 
<p>训练结果预测需要用到两个文件，分别是yolo.py和predict.py。<br> 我们首先需要去yolo.py里面修改model_path以及classes_path，这两个参数必须要修改。</p> 
<p><strong>model_path指向训练好的权值文件，在logs文件夹里。<br> classes_path指向检测类别所对应的txt。</strong><br> <img src="https://images2.imgbox.com/3f/e7/zQLmz94f_o.png" alt="在这里插入图片描述"><br> 完成修改后就可以运行predict.py进行检测了。运行后输入图片路径即可检测。</p>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>